import{b as Rl,c as Il,d as Tl}from"./chunk-DZEIK4SW.js";import{b as yl,c as Qn,d as xl,e as bl,h as wl,i as Cl,j as _l,k as El,l as kl,m as Dl,o as Sl,p as Al,q as Fl}from"./chunk-PWFUI76Y.js";import{a as Nl,b as Pl}from"./chunk-2BE5DFES.js";import"./chunk-WPHHPEL3.js";import{$ as Dr,Aa as hl,Ca as pl,Ea as dl,F as Ha,G as ll,M as ue,Ma as ml,Na as vl,O as Wn,P as fl,Qa as gl,U as Kt,X as nt,Z as ge,_ as pe,a as ve,b as wn,ba as Ka,c as Ua,ca as Sr,d as Q,e as ja,ea as Ie,f as K,fa as un,ga as Ot,h as Ga,ha as zn,na as pi,ra as be,sa as we,x as uo}from"./chunk-7K72UJZH.js";var Ol=Q((aE,Ml)=>{"use strict";var Xa=class{constructor(t,e,n,r,o){this.s_size=t.length,this.s=t,this.substring_i=e,this.result=n,this.method=r,this.instance=o}};Ml.exports=Xa});var co=Q((sE,Xl)=>{"use strict";var Ya="\\ud800-\\udfff",M0="\\u0300-\\u036f",O0="\\ufe20-\\ufe2f",B0="\\u20d0-\\u20ff",L0="\\u1ab0-\\u1aff",W0="\\u1dc0-\\u1dff",Bl=M0+O0+B0+L0+W0,Ll="\\ufe0e\\ufe0f",z0=`[${Ya}]`,Ja=`[${Bl}]`,$a="\\ud83c[\\udffb-\\udfff]",q0=`(?:${Ja}|${$a})`,Wl=`[^${Ya}]`,zl="(?:\\ud83c[\\udde6-\\uddff]){2}",ql="[\\ud800-\\udbff][\\udc00-\\udfff]",Vl="\\u200d",Ul=`${q0}?`,jl=`[${Ll}]?`,V0=`(?:${Vl}(?:${[Wl,zl,ql].join("|")})${jl+Ul})*`,U0=jl+Ul+V0,j0=`${Wl}${Ja}?`,G0=`(?:${[j0,Ja,zl,ql,z0].join("|")})`,H0=RegExp(`[${Vl+Ya+Bl+Ll}]`),K0=RegExp(`${$a}(?=${$a})|${G0+U0}`,"g"),Gl=i=>H0.test(i),Hl=i=>i.match(K0)||[],Kl=i=>i.split(""),X0=i=>Gl(i)?Hl(i):Kl(i);function $0(i,t){let e=r=>r.replace(/([.*+^=!:${}()|[\]/\\])/g,"\\$1"),n=`^${t.split("*").map(e).join(".*")}$`.replace(/\?/g,".");return new RegExp(n).test(i)}function Y0(i,t={}){let e=Object.keys(t);i=i?`${i}_`:"";for(let n=0;n<e.length;n+=1){let r=`${i}${e[n]}`;process.env[r]=t[e[n]]}}Xl.exports={hasUnicode:Gl,unicodeToArray:Hl,asciiToArray:Kl,stringToArray:X0,compareWildcars:$0,loadEnvFromJson:Y0}});var Yl=Q((uE,$l)=>{"use strict";var Qa=class{constructor(t){this.container=t.container||t,this.name="default"}getTokenFromWord(t){return t.startsWith("//")?{type:"comment",value:t}:["set","delete","get","inc","dec","eq","neq","gt","ge","lt","le","label","goto","jne","je"].includes(t)?{type:t,arguments:[]}:t.startsWith("$")?{type:"call",value:t.slice(1)}:{type:"reference",value:t}}compile(t){let e=[];for(let n=0;n<t.length;n+=1){let o=t[n].trim().split(" "),a=[],s="",u;for(let c=0;c<o.length;c+=1){let l=o[c],f=!1;u?(s=`${s} ${l}`,f=!0,l.endsWith(u)&&(u=void 0,a.push(this.getTokenFromWord(s)))):l.startsWith('"')?(s=l,f=!0,u='"',l.endsWith('"')&&(u=void 0,a.push(this.getTokenFromWord(s)))):l.startsWith("'")&&(s=l,f=!0,u="'",l.endsWith("'")&&(u=void 0,a.push(this.getTokenFromWord(s)))),f||a.push(this.getTokenFromWord(l))}e.push(a)}return e}executeCall(t,e,n,r,o){let a=this.container.getPipeline(t.value);if(!a)throw new Error(`Pipeline $${t.value} not found.`);return this.container.runPipeline(a,n,r,o+1)}executeReference(t,e,n,r,o){let a=this.container.resolvePath(e.value,n,r,o),s=[];for(let c=1;c<t.length;c+=1)s.push(this.container.resolvePathWithType(t[c].value,n,r,o));if(!a)throw new Error(`Method not found for step ${JSON.stringify(t)}`);let u=a.run||a;return typeof u=="function"?typeof a=="function"?u(r,...s):u.bind(a)(r,...s):u}doGoto(t,e){let n=e,r=n.labels[t];n.cursor=r}executeAction(t,e,n,r,o){return K(this,null,function*(){let a=t[0];if(a&&a.value&&a.value.startsWith("->")){if(o>0)return n;a=ve({},a),a.value=a.value.slice(2)}switch(a.type){case"set":this.container.setValue(t[1].value,t[2]?t[2].value:void 0,e,n,r);break;case"delete":this.container.deleteValue(t[1].value,e,n,r);break;case"get":return this.container.getValue(t[1]?t[1].value:void 0,e,n,r);case"inc":this.container.incValue(t[1]?t[1].value:void 0,t[2]?t[2].value:"1",e,n,r);break;case"dec":this.container.decValue(t[1]?t[1].value:void 0,t[2]?t[2].value:"1",e,n,r);break;case"eq":this.container.eqValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"neq":this.container.neqValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"gt":this.container.gtValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"ge":this.container.geValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"lt":this.container.ltValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"le":this.container.leValue(t[1]?t[1].value:void 0,t[2]?t[2].value:void 0,e,n,r);break;case"goto":this.doGoto(t[1].value,e);break;case"jne":e.floating||this.doGoto(t[1].value,e);break;case"je":e.floating&&this.doGoto(t[1].value,e);break;case"call":return this.executeCall(a,e,n,r,o);case"reference":return this.executeReference(t,a,e,n,r);default:break}return n})}findLabels(t,e){let n=e;for(let r=0;r<t.length;r+=1){let o=t[r];o[0].type==="label"&&(n[o[1].value]=r)}}execute(t,e,n,r){return K(this,null,function*(){let o=e,a={cursor:0,labels:{}};for(this.findLabels(t,a.labels);a.cursor<t.length;)o=yield this.executeAction(t[a.cursor],a,o,n,r),a.cursor+=1;return o})}};$l.exports=Qa});var lo=Q((lE,Jl)=>{"use strict";var Za=class{constructor(){this.name="logger"}debug(...t){console.debug(...t)}info(...t){console.info(...t)}warn(...t){console.warn(...t)}error(...t){console.error(...t)}log(...t){console.log(...t)}trace(...t){console.trace(...t)}fatal(...t){console.error(...t)}},J0=new Za;Jl.exports=J0});var Ft=Q((fE,Ql)=>{"use strict";var{compareWildcars:es}=co(),Q0=Yl(),Z0=lo(),fo=class{constructor(t=!1){this.classes={},this.factory={},this.pipelines={},this.configurations={},this.compilers={},this.cache={bestKeys:{},pipelines:{}},this.registerCompiler(Q0),t||this.use(Z0)}registerCompiler(t,e){let n=new t(this);this.compilers[e||n.name]=n}addClass(t,e){this.classes[e||t.name]=t}toJSON(t){let e=t.toJSON?t.toJSON():ve({},t);return e.className=t.constructor.name,e}fromJSON(t,e){let n=this.classes[t.className],r;return n?(r=new n(e),r.fromJSON?r.fromJSON(t):Object.assign(r,t)):r=ve({},t),delete r.className,r}register(t,e,n=!0){this.cache.bestKeys={};let r=typeof e=="function",o={name:t,isSingleton:n};n?o.instance=r?new e:e:o.instance=r?e:e.constructor,this.factory[t]=o}getBestKey(t){if(this.cache.bestKeys[t]!==void 0)return this.cache.bestKeys[t];let e=Object.keys(this.factory);for(let n=0;n<e.length;n+=1)if(es(t,e[n]))return this.cache.bestKeys[t]=e[n],e[n];this.cache.bestKeys[t]=null}get(t,e){let n=this.factory[t];if(!n){if(this.parent)return this.parent.get(t,e);let o=this.getBestKey(t);if(o&&(n=this.factory[o]),!n)return}if(n.isSingleton)return n.instance&&n.instance.applySettings&&n.instance.applySettings(n.instance.settings,e),n.instance;let r=n.instance;return new r(e,this)}buildLiteral(t,e,n,r){return{type:"literal",subtype:t,src:e,value:n,context:r,container:this}}resolvePathWithType(t,e,n,r){let o=t.split("."),a=o[0].trim();if(a||(a=t.startsWith(".")?"this":"context"),/^\d+$/.test(a))return this.buildLiteral("number",t,parseFloat(a),e);if(a.startsWith('"'))return this.buildLiteral("string",t,a.replace(/^"(.+(?="$))"$/,"$1"),e);if(a.startsWith("'"))return this.buildLiteral("string",t,a.replace(/^'(.+(?='$))'$/,"$1"),e);if(a==="true")return this.buildLiteral("boolean",t,!0,e);if(a==="false")return this.buildLiteral("boolean",t,!1,e);let u=e;a==="input"||a==="output"?u=n:a&&a!=="context"&&a!=="this"?u=this.get(a)||u[a]:a==="this"&&(u=r);for(let c=1;c<o.length;c+=1){let l=o[c];if((!u||!u[l])&&c<o.length-1)throw Error(`Path not found in pipeline "${t}"`);let f=u;u=u[l],typeof u=="function"&&(u=u.bind(f))}return typeof u=="function"?{type:"function",src:t,value:u,context:e,container:this}:{type:"reference",src:t,value:u,context:e,container:this}}resolvePath(t,e,n,r){let o=this.resolvePathWithType(t,e,n,r);return o&&o.value}setValue(t,e,n,r,o){let a=this.resolvePath(e,n,r,o),s=t.split("."),u=s.slice(0,-1).join("."),c=this.resolvePath(u,n,r,o);c[s[s.length-1]]=a}incValue(t,e,n,r,o){let a=this.resolvePath(e,n,r,o),s=t.split(".");t.startsWith(".")&&s.push("this");let u=s.slice(0,-1).join("."),c=this.resolvePath(u,n,r,o);c[s[s.length-1]]+=a}decValue(t,e,n,r,o){let a=this.resolvePath(e,n,r,o),s=t.split("."),u=s.slice(0,-1).join("."),c=this.resolvePath(u,n,r,o);c[s[s.length-1]]-=a}eqValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s===u}neqValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s!==u}gtValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s>u}geValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s>=u}ltValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s<u}leValue(t,e,n,r,o){let a=n,s=this.resolvePath(t,a,r,o),u=this.resolvePath(e,a,r,o);a.floating=s<=u}deleteValue(t,e,n,r){let o=t.split("."),a=o.slice(0,-1).join("."),s=this.resolvePath(a,e,n,r);delete s[o[o.length-1]]}getValue(t,e,n,r){let a=(t||"floating").split("."),s=a.slice(0,-1).join(".");return this.resolvePath(s,e,n,r)[a[a.length-1]]}runPipeline(t,e,n,r=0){return K(this,null,function*(){if(r>10)throw new Error("Pipeline depth is too high: perhaps you are using recursive pipelines?");let o=typeof t=="string"?this.getPipeline(t):t;if(!o)throw new Error(`Pipeline not found ${t}`);if(!o.compiler){let a=JSON.stringify(o);this.registerPipeline(a,o,!1);let s=this.getPipeline(a);return s.compiler.execute(s.compiled,e,n,r)}return o.compiler.execute(o.compiled,e,n,r)})}use(t,e,n,r=!1){let o;if(typeof t=="function"){if(t.name.endsWith("Compiler"))return this.registerCompiler(t),t.name;let u=t;o=new u({container:this})}else o=t;o.register&&o.register(this);let a=o.settings?o.settings.tag:void 0,s=e||o.name||a||t.name||o.constructor.name;return(!r||!this.get(s))&&this.register(s,o,n),s}getCompiler(t){let e=this.compilers[t];return e||(this.parent?this.parent.getCompiler(t):this.compilers.default)}buildPipeline(t,e=[]){let n=[];if(t&&t.length>0)for(let s=0;s<t.length;s+=1){let u=t[s];if(u.trim()==="$super")for(let c=0;c<e.length;c+=1)e[c].trim().startsWith("->")||n.push(e[c]);else n.push(u)}let r=!n.length||!n[0].startsWith("// compiler=")?"default":n[0].slice(12),o=this.getCompiler(r),a=o.compile(n);return{pipeline:n,compiler:o,compiled:a}}registerPipeline(t,e,n=!0){if(n||!this.pipelines[t]){this.cache.pipelines={};let r=this.getPipeline(t);this.pipelines[t]=this.buildPipeline(e,r?r.pipeline:[])}}registerPipelineForChilds(t,e,n,r=!0){this.childPipelines||(this.childPipelines={}),this.childPipelines[t]||(this.childPipelines[t]=[]),this.childPipelines[t].push({tag:e,pipeline:n,overwrite:r})}getPipeline(t){if(this.pipelines[t])return this.pipelines[t];if(this.cache.pipelines[t]!==void 0)return this.cache.pipelines[t]||void 0;let e=Object.keys(this.pipelines);for(let n=0;n<e.length;n+=1)if(es(t,e[n]))return this.cache.pipelines[t]=this.pipelines[e[n]],this.pipelines[e[n]];this.cache.pipelines[t]=null}registerConfiguration(t,e,n=!0){(n||!this.configurations[t])&&(this.configurations[t]=e)}getConfiguration(t){if(this.configurations[t])return this.configurations[t];let e=Object.keys(this.configurations);for(let n=0;n<e.length;n+=1)if(es(t,e[n]))return this.configurations[e[n]]}loadPipelinesFromString(t=""){let e=t.split(/\n|\r|\r\n/),n="",r=[],o="";for(let a=0;a<e.length;a+=1){let s=e[a];s!==""&&(s.startsWith("# ")?(n&&(o&&!["default","pipelines"].includes(o.toLowerCase())?this.registerPipelineForChilds(o,n,r):this.registerPipeline(n,r)),o=s.slice(1).trim(),n="",r=[]):s.startsWith("## ")?(n&&(o&&!["default","pipelines"].includes(o.toLowerCase())?this.registerPipelineForChilds(o,n,r):this.registerPipeline(n,r)),n=s.slice(2).trim(),r=[]):n&&r.push(s))}n&&(o&&!["default","pipelines"].includes(o.toLowerCase())?this.registerPipelineForChilds(o,n,r):this.registerPipeline(n,r))}start(t="main"){return K(this,null,function*(){let e=Object.keys(this.factory);for(let n=0;n<e.length;n+=1){let r=this.factory[e[n]];r.isSingleton&&r.instance&&r.instance.start&&(yield r.instance.start())}this.getPipeline(t)&&(yield this.runPipeline(t,{},this))})}},eg=new fo;Ql.exports={Container:fo,defaultContainer:eg}});var ns=Q((pE,Zl)=>{"use strict";var{defaultContainer:tg}=Ft(),ts=class i{constructor(t=tg){this.container=t.container||t,this.name="arrToObj"}static arrToObj(t){let e={};for(let n=0;n<t.length;n+=1)e[t[n]]=1;return e}run(t){return Array.isArray(t)?i.arrToObj(t):(t.tokens=i.arrToObj(t.tokens),t)}};Zl.exports=ts});var ho=Q((dE,ef)=>{"use strict";var{defaultContainer:ng}=Ft(),rs=class{constructor(t=ng){this.container=t.container||t,this.name="normalize"}normalize(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}run(t){let e=t,n=e.locale||"en",r=this.container.get(`normalizer-${n}`)||this;return e.text=r.normalize(e.text,e),e}};ef.exports=rs});var po=Q((mE,tf)=>{"use strict";var{defaultContainer:rg}=Ft(),ig=ho(),is=class{constructor(t=rg,e=!1){this.container=t.container||t,this.name="tokenize",this.shouldNormalize=e}getNormalizer(){return this.normalizer||(this.normalizer=this.container.get(`normalizer-${this.name.slice(-2)}`)||new ig),this.normalizer}normalize(t,e){return e===void 0&&this.shouldNormalize||e===!0?this.getNormalizer().normalize(t):t}innerTokenize(t){return t.split(/[\s,.!?;:([\]'"¡¿)/]+/).filter(e=>e)}tokenize(t,e){let n;if(this.cache&&Math.abs(new Date().getTime()-this.cache.created)/36e5>1&&(this.cache=void 0),!this.cache)this.cache={created:new Date().getTime(),normalized:{},nonNormalized:{}};else if(e?Object.prototype.hasOwnProperty.call(this.cache.normalized,t)&&(n=this.cache.normalized[t]):Object.prototype.hasOwnProperty.call(this.cache.nonNormalized,t)&&(n=this.cache.nonNormalized[t]),n)return n;return n=this.innerTokenize(this.normalize(t,e),e),e?this.cache.normalized[t]=n:this.cache.nonNormalized[t]=n,n}run(t){return K(this,null,function*(){let e=t,n=e.locale||"en",r=this.container.get(`tokenizer-${n}`);if(!r){let a=this.container.get("tokenizer-bert");a&&a.activeFor(n)?r=a:r=this}let o=yield r.tokenize(e.text,e);return e.tokens=o.filter(a=>a),e})}};tf.exports=is});var rf=Q((gE,nf)=>{"use strict";var{defaultContainer:og}=Ft(),ag=po(),os=class{constructor(t=og,e){this.container=t.container||t,this.cache={},this.setCurrent(""),this.dictionary=e||{before:{},after:{}}}setCurrent(t){this.current=t,this.cursor=0,this.limit=this.current.length,this.limit_backward=0,this.bra=this.cursor,this.ket=this.limit}getCurrent(){return this.current}bc(t,e){return(t[e>>>3]&1<<(e&7))==0}in_grouping(t,e,n){if(this.cursor>=this.limit)return!1;let r=this.current.charCodeAt(this.cursor);return r>n||r<e||(r-=e,this.bc(t,r))?!1:(this.cursor++,!0)}in_grouping_b(t,e,n){if(this.cursor<=this.limit_backward)return!1;let r=this.current.charCodeAt(this.cursor-1);return r>n||r<e||(r-=e,this.bc(t,r))?!1:(this.cursor--,!0)}out_grouping(t,e,n){if(this.cursor>=this.limit)return!1;let r=this.current.charCodeAt(this.cursor);return r>n||r<e?(this.cursor++,!0):(r-=e,this.bc(t,r)?(this.cursor++,!0):!1)}out_grouping_b(t,e,n){if(this.cursor<=this.limit_backward)return!1;let r=this.current.charCodeAt(this.cursor-1);return r>n||r<e?(this.cursor--,!0):(r-=e,this.bc(t,r)?(this.cursor--,!0):!1)}eq_s(t,e){return typeof t=="string"&&(e=t,t=e.length),this.limit-this.cursor<t||this.current.slice(this.cursor,this.cursor+t)!=e?!1:(this.cursor+=t,!0)}eq_s_b(t,e){return typeof t=="string"&&(e=t,t=e.length),this.cursor-this.limit_backward<t||this.current.slice(this.cursor-t,this.cursor)!=e?!1:(this.cursor-=t,!0)}find_among(t,e){let n=0,r=e||t.length,o=this.cursor,a=this.limit,s=0,u=0,c=!1;for(;;){let h=n+(r-n>>>1),p=0,d=s<u?s:u;var l=t[h],f;for(f=d;f<l.s_size;f++){if(o+d==a){p=-1;break}if(p=this.current.charCodeAt(o+d)-l.s.charCodeAt(f),p!=0)break;d++}if(p<0?(r=h,u=d):(n=h,s=d),r-n<=1){if(n>0||r==n||c)break;c=!0}}for(;;){var l=t[n];if(s>=l.s_size){if(this.cursor=o+l.s_size,l.method==null)return l.result;let p=l.method(l.instance);if(this.cursor=o+l.s_size,p)return l.result}if(n=l.substring_i,n<0)return 0}return-1}find_among_b(t,e){let n=0,r=e||t.length,o=this.cursor,a=this.limit_backward,s=0,u=0,c=!1;for(;;){let h=n+(r-n>>1),p=0,d=s<u?s:u;var l=t[h],f;for(f=l.s_size-1-d;f>=0;f--){if(o-d==a){p=-1;break}if(p=this.current.charCodeAt(o-1-d)-l.s.charCodeAt(f),p!=0)break;d++}if(p<0?(r=h,u=d):(n=h,s=d),r-n<=1){if(n>0||r==n||c)break;c=!0}}for(;;){var l=t[n];if(s>=l.s_size){if(this.cursor=o-l.s_size,l.method==null)return l.result;let p=l.method(this);if(this.cursor=o-l.s_size,p)return l.result}if(n=l.substring_i,n<0)return 0}return-1}replace_s(t,e,n){let r=n.length-(e-t);return this.current=this.current.slice(0,t)+n+this.current.slice(e),this.limit+=r,this.cursor>=e?this.cursor+=r:this.cursor>t&&(this.cursor=t),r}slice_check(){return!(this.bra<0||this.bra>this.ket||this.ket>this.limit||this.limit>this.current.length)}slice_from(t){return this.slice_check()?(this.replace_s(this.bra,this.ket,t),!0):!1}slice_del(){return this.slice_from("")}insert(t,e,n){let r=this.replace_s(t,e,n);t<=this.bra&&(this.bra+=r),t<=this.ket&&(this.ket+=r)}slice_to(t){let e="";return this.slice_check()&&(e=this.current.slice(this.bra,this.ket)),e}stemWord(t){let e=this.cache[`.${t}`];return e==null&&(this.dictionary.before.hasOwnProperty(t)?e=this.dictionary.before[t]:(this.setCurrent(t),this.innerStem(),e=this.getCurrent(),this.dictionary.after.hasOwnProperty(e)&&(e=this.dictionary.after[e])),this.cache[`.${t}`]=e),e}stemWords(t){let e=[];for(let n=0;n<t.length;n++){let r=this.stemWord(t[n]);r&&e.push(r.trim())}return e}stem(t){return t==null?t:Array.isArray(t)?this.stemWords(t):this.stemWords([t])[0]}getTokenizer(){return this.tokenizer||(this.tokenizer=this.container.get(`tokenizer-${this.name.slice(-2)}`)||new ag),this.tokenizer}getStopwords(){return this.stopwords||(this.stopwords=this.container.get(`tokenizer-${this.name.slice(-2)}`)),this.stopwords}tokenizeAndStem(t,e=!0){let r=this.getTokenizer().tokenize(t,!0);if(!e){let o=this.getStopwords();o&&(r=o.removeStopwords(r))}return this.stemWords(r)}};nf.exports=os});var ss=Q((yE,of)=>{"use strict";var{defaultContainer:sg}=Ft(),as=class i{constructor(t=sg){this.container=t.container||t,this.name="objToArr"}static objToArr(t){return Object.keys(t)}run(t){return t.tokens?(t.tokens=i.objToArr(t.tokens),t):i.objToArr(t)}};of.exports=as});var cs=Q((xE,af)=>{"use strict";var{defaultContainer:ug}=Ft(),us=class{constructor(t=ug){this.container=t.container||t,this.name="stem"}stem(t){return t}getStemmer(t){let e=t,n=e.locale||e.settings&&e.settings.locale||"en",r=this.container.get(`stemmer-${n}`);if(!r){let o=this.container.get("stemmer-bert");o&&o.activeFor(n)?r=o:r=this}return r}addForTraining(t){return K(this,null,function*(){let e=this.getStemmer(t);return e.addUtterance&&(yield e.addUtterance(t.utterance,t.intent)),t})}train(t){return K(this,null,function*(){let e=this.getStemmer(t);return e.innerTrain&&(yield e.innerTrain()),t})}run(t){return K(this,null,function*(){let e=t,n=this.getStemmer(e);return e.tokens=yield n.stem(e.tokens,e),e})}};af.exports=us});var fs=Q((wE,sf)=>{"use strict";var{defaultContainer:cg}=Ft(),ls=class{constructor(t=cg){this.container=t.container||t,this.name="removeStopwords",this.dictionary={}}build(t){for(let e=0;e<t.length;e+=1)this.dictionary[t[e]]=!0}isNotStopword(t){return!this.dictionary[t]}isStopword(t){return!!this.dictionary[t]}removeStopwords(t){return t.filter(e=>this.isNotStopword(e))}run(t){if(t.settings&&t.settings.keepStopwords===!1){let e=t,n=e.locale||"en",r=this.container.get(`stopwords-${n}`)||this;return e.tokens=r.removeStopwords(e.tokens,e).filter(o=>o),e}return t}};sf.exports=ls});var ps=Q((CE,uf)=>{"use strict";var{defaultContainer:lg}=Ft(),hs=class{constructor(t=lg){this.container=t.container||t,this.name="timer"}start(t){return t&&(t.hrstart=new Date),t}stop(t){let e=t;if(e&&e.hrstart){let n=new Date;e.elapsed=n.getTime()-e.hrstart.getTime(),delete e.hrstart}return e}run(t){this.start(t)}};uf.exports=hs});var mo=Q((_E,cf)=>{"use strict";var{defaultContainer:fg}=Ft(),ds=class{constructor(t={},e=fg){this.container=t.container||e,this.applySettings(this,t)}get logger(){return this.container.get("logger")}applySettings(t,e={}){let n=t||{};return Object.keys(e).forEach(r=>{n[r]===void 0&&(n[r]=e[r])}),n}toJSON(){let t=this.jsonExport||{},e={},n=Object.keys(this);for(let r=0;r<n.length;r+=1){let o=n[r];if(o!=="jsonExport"&&o!=="jsonImport"&&o!=="container"&&!o.startsWith("pipeline")){let a=t[o]===void 0?!0:t[o];if(typeof a=="function"){let s=a.bind(this)(e,this,o,this[o]);s&&(e[o]=s)}else typeof a=="boolean"?a&&(e[o]=this[o],o==="settings"&&delete e[o].container):typeof a=="string"&&(e[a]=this[o])}}return e}fromJSON(t){let e=this.jsonImport||{},n=Object.keys(t);for(let r=0;r<n.length;r+=1){let o=n[r],a=e[o]===void 0?!0:e[o];if(typeof a=="function"){let s=a.bind(this)(this,t,o,t[o]);s&&(this[o]=s)}else typeof a=="boolean"?a&&(this[o]=t[o]):typeof a=="string"&&(this[a]=t[o])}}objToValues(t,e){let n=e||Object.keys(t),r=[];for(let o=0;o<n.length;o+=1)r.push(t[n[o]]);return r}valuesToObj(t,e){let n={};for(let r=0;r<t.length;r+=1)n[e[r]]=t[r];return n}getPipeline(t){return this.container.getPipeline(t)}runPipeline(t,e){return K(this,null,function*(){return this.container.runPipeline(e||this.pipeline,t,this)})}use(t){this.container.use(t)}};cf.exports=ds});var vs=Q((kE,lf)=>{"use strict";var{defaultContainer:hg}=Ft(),pg=mo(),ms=class extends pg{constructor(t={},e=void 0){super({settings:{},container:t.container||e||hg},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{etag:1,memory:{}}),this.settings.tag||(this.settings.tag="storage"),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag))}read(t){return new Promise(e=>{let n={};Array.isArray(t)||(t=[t]),t.forEach(r=>{let o=this.settings.memory[r];o&&(n[r]=JSON.parse(o))}),e(n)})}saveItem(t,e){let n=ve({},e);return n.eTag=this.settings.etag.toString(),this.settings.etag+=1,this.settings.memory[t]=JSON.stringify(n),n}write(t){return new Promise((e,n)=>{Object.keys(t).forEach(r=>{let o=t[r],a=this.settings.memory[r];if(!a||o.eTag==="*")return e(this.saveItem(r,o));let s=JSON.parse(a);return o.eTag!==s.eTag?n(new Error(`Error writing "${r}" due to eTag conflict.`)):e(this.saveItem(r,o))})})}delete(t){return new Promise(e=>{t.forEach(n=>delete this.settings.memory[n]),e()})}};lf.exports=ms});var hf=Q((SE,ff)=>{"use strict";function dg(){return new Promise(i=>{i(void 0)})}function mg(){return new Promise((i,t)=>{t(new Error("File cannot be written in web"))})}function vg(){return!1}function gg(){}function yg(){}ff.exports={readFile:dg,writeFile:mg,existsSync:vg,lstatSync:gg,readFileSync:yg,name:"fs"}});var ys=Q((AE,pf)=>{"use strict";var xg=ns(),{Container:bg}=Ft(),wg=ho(),Cg=ss(),{loadEnvFromJson:_g}=co(),Eg=cs(),kg=fs(),Dg=po(),Sg=ps(),Ag=lo(),Fg=vs(),Rg=hf();function Ig(i,t){i.loadPipelinesFromString(t)}function gs(i,t){if(typeof i=="string")return i.startsWith("$")?process.env[`${t}${i.slice(1)}`]||process.env[i.slice(1)]:i;if(Array.isArray(i))return i.map(e=>gs(e,t));if(typeof i=="object"){let e=Object.keys(i),n={};for(let r=0;r<e.length;r+=1)n[e[r]]=gs(i[e[r]],t);return n}return i}function Tg(i,t,e,n,r,o){let a=i||{},s=e||new bg(n);s.parent=o,n||(s.register("fs",Rg),s.use(xg),s.use(wg),s.use(Cg),s.use(Eg),s.use(kg),s.use(Dg),s.use(Sg),s.use(Ag),s.use(Fg));let u=a;a.env&&_g(n,a.env);let c;if(c=u,c=gs(c,n?`${n}_`:""),c.settings){let l=Object.keys(c.settings);for(let f=0;f<l.length;f+=1)s.registerConfiguration(l[f],c.settings[l[f]],!0)}if(c.use)for(let l=0;l<c.use.length;l+=1){let f=c.use[l];Array.isArray(f)?s.register(f[0],f[1]):s.use(f)}if(c.terraform)for(let l=0;l<c.terraform.length;l+=1){let f=c.terraform[l],h=s.get(f.className);s.register(f.name,h,!0)}if(c.childs&&(s.childs=c.childs),r)for(let l=0;l<r.length;l+=1){let f=r[l];s.registerPipeline(f.tag,f.pipeline,f.overwrite)}return c.pipelines&&Ig(s,c.pipelines),s}pf.exports=Tg});var mf=Q((FE,df)=>{"use strict";function Ng(){function i(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return`${i()+i()}-${i()}-${i()}-${i()}-${i()}${i()}${i()}`}df.exports=Ng});var gf=Q((RE,vf)=>{"use strict";var Pg=ys(),xs=class{constructor(){this.containers={}}getContainer(t){return this.containers[t||"default"]}createContainer(t,e,n,r,o,a){return K(this,null,function*(){let s=n===void 0?!0:n;if(typeof t!="string"&&(e=t,t=""),e||(t==="default"||t==="")&&(e="conf.json"),!this.containers[t]){let u=Pg(e,s,void 0,r,a);u.name=t,this.containers[t]=u,u.dock=this,u.parent=o,yield u.start(),u.childs&&(yield this.buildChilds(u))}return this.containers[t]})}buildChilds(t){return K(this,null,function*(){if(t&&t.childs){let e=Object.keys(t.childs),n={};for(let r=0;r<e.length;r+=1){let o=t.childs[e[r]];o.isChild=!0,o.pathPipeline||(o.pathPipeline=`${e[r]}_pipeline.md`),n[e[r]]=yield this.createContainer(e[r],o,!1,e[r],t,t.childPipelines?t.childPipelines[e[r]]:void 0)}t.childs=n}})}terraform(t,e=!0){return K(this,null,function*(){return yield this.createContainer("default",t,e,"")})}start(t,e=!0){return this.terraform(t,e)}},Mg=new xs;vf.exports=Mg});var xf=Q((TE,yf)=>{"use strict";var{defaultContainer:Og}=Ft(),Bg=mo(),bs=class extends Bg{constructor(t={},e=void 0){super({settings:{},container:t.container||e||Og},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="context"),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag))}getStorage(){let t=this.container.get(this.settings.storageName||"storage");if(!t)throw new Error("Storage not found");return t}getContext(t){return this.getStorage().read(`${this.settings.tag}-${t}`)}setContext(t,e){let n=this.getStorage(),r={[t]:e};return n.write(r)}getContextValue(t,e){return K(this,null,function*(){let n=yield this.getContext(t);return n?n[e]:void 0})}setContextValue(t,e,n){return K(this,null,function*(){let r=yield this.getContext(t);return r||(r={}),r[e]=n,this.setContext(t,r)})}};yf.exports=bs});var rt=Q((PE,bf)=>{"use strict";var Lg=Ol(),Wg=ns(),zg=rf(),qg=ys(),Vg=mo(),{Container:Ug,defaultContainer:jg}=Ft(),Gg=ho(),Hg=ss(),Kg=cs(),Xg=fs(),$g=po(),Yg=ps(),Jg=lo(),{hasUnicode:Qg,unicodeToArray:Zg,asciiToArray:e1,stringToArray:t1,compareWildcars:n1,loadEnv:r1}=co(),i1=vs(),o1=mf(),ws=gf(),a1=xf();function s1(i,t){return K(this,null,function*(){return yield ws.start(i,t),ws})}bf.exports={Among:Lg,ArrToObj:Wg,BaseStemmer:zg,containerBootstrap:qg,Clonable:Vg,Container:Ug,defaultContainer:jg,hasUnicode:Qg,unicodeToArray:Zg,asciiToArray:e1,stringToArray:t1,compareWildcars:n1,loadEnv:r1,Normalizer:Gg,ObjToArr:Hg,Stemmer:Kg,Stopwords:Xg,Tokenizer:$g,Timer:Yg,logger:Jg,MemoryStorage:i1,uuid:o1,dock:ws,Context:a1,dockStart:s1}});var Cs=Q((OE,Cf)=>{"use strict";var di=[],wf=[];function u1(i,t){i.length>t.length&&([i,t]=[t,i]);let e=i.length-1,n=t.length-1;for(;e>0&&i.charCodeAt(e)===t.charCodeAt(n);)e-=1,n-=1;e+=1,n+=1;let r=0;for(;r<e&&i.charCodeAt(r)===t.charCodeAt(r);)r+=1;if(e-=r,n-=r,e===0)return n;for(let l=0;l<e;l+=1)wf[l]=i.charCodeAt(r+l),di[l]=l+1;let o,a,s,u,c=0;for(;c<n;){o=t.charCodeAt(r+c),s=c,c+=1,a=c;for(let l=0;l<e;l+=1)u=s+(o!==wf[l])|0,s=di[l],s>a?di[l]=u>a?a+1:u:di[l]=u>s?s+1:u,a=di[l]}return a}Cf.exports=u1});var _s=Q((BE,_f)=>{"use strict";var c1=Cs();function l1(i,t,e=!1){return e&&(i=i.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(),t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()),i===t?0:c1(i,t)}_f.exports=l1});var kf=Q((LE,Ef)=>{"use strict";var Es=class{constructor(t){this.container=t}getTokens(t,e="en"){if(typeof t=="string"){let n=this.container&&this.container.get(`tokenizer-${e}`);return n?n.tokenize(t,!0):t.split(" ")}return t}termFreqMap(t,e){let n=this.getTokens(t,e),r={};return n.forEach(o=>{r[o]=(r[o]||0)+1}),r}addKeysToDict(t,e){Object.keys(t).forEach(n=>{e[n]=!0})}termFreqMapToVector(t,e){let n=[];return Object.keys(e).forEach(r=>{n.push(t[r]||0)}),n}vecDotProduct(t,e){let n=0;for(let r=0;r<t.length;r+=1)n+=t[r]*e[r];return n}vecMagnitude(t){let e=0;for(let n=0;n<t.length;n+=1)e+=t[n]*t[n];return Math.sqrt(e)}cosineSimilarity(t,e){return this.vecDotProduct(t,e)/(this.vecMagnitude(t)*this.vecMagnitude(e))}getTermFreqVectors(t,e,n){let r=this.termFreqMap(t,n),o=this.termFreqMap(e,n);if(!Object.keys(r).length||!Object.keys(o).length)return 0;let a={};return this.addKeysToDict(r,a),this.addKeysToDict(o,a),[this.termFreqMapToVector(r,a),this.termFreqMapToVector(o,a)]}similarity(t,e,n){if(t===e)return 1;let[r,o]=this.getTermFreqVectors(t,e,n);return this.cosineSimilarity(r,o)}};Ef.exports=Es});var Sf=Q((WE,Df)=>{"use strict";var f1=_s(),ks=class{constructor(t){this.settings=t||{},this.minLength=this.settings.minLength||4,this.settings.features?this.setFeatures(this.settings.features):(this.features={},this.featuresByLength={})}setFeatures(t){this.features=t,this.featuresByLength={},this.featuresList=Object.keys(this.features);for(let e=0;e<this.featuresList.length;e+=1){let n=this.featuresList[e],{length:r}=n;this.featuresByLength[r]||(this.featuresByLength[r]=[]),this.featuresByLength[r].push(n)}}checkToken(t,e){if(this.features[t]||t.length<this.minLength)return t;let n,r=1/0;for(let o=t.length-e-1;o<t.length+e;o+=1){let a=this.featuresByLength[o+1];if(a)for(let s=0;s<a.length;s+=1){let u=a[s],c=f1(t,u);if(c<=e){if(c<r)n=u,r=c;else if(c===r&&n){let l=Math.abs(n.length-t.length),f=Math.abs(u.length-t.length);(l>f||l===f&&this.features[u]>this.features[n])&&(n=u,r=c)}}}}return n||t}check(t,e=1){if(!Array.isArray(t)){let r=Object.keys(t),o=this.check(r,e),a={};for(let s=0;s<o.length;s+=1)a[o[s]]=t[r[s]];return a}let n=[];for(let r=0;r<t.length;r+=1)n.push(this.checkToken(t[r],e));return n}};Df.exports=ks});var Ds=Q((zE,Af)=>{"use strict";var h1=Cs(),p1=_s(),d1=kf(),m1=Sf();Af.exports={leven:h1,CosineSimilarity:d1,similarity:p1,SpellCheck:m1}});var As=Q((qE,Ff)=>{"use strict";var{Clonable:v1,compareWildcars:g1}=rt(),{SpellCheck:y1}=Ds(),Ss=class extends v1{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{locale:"en"}),this.settings.tag||(this.settings.tag=`nlu-${this.settings.locale}`),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.applySettings(this,{pipelinePrepare:this.getPipeline(`${this.settings.tag}-prepare`),pipelineTrain:this.getPipeline(`${this.settings.tag}-train`),pipelineProcess:this.getPipeline(`${this.settings.tag}-process`)}),this.spellCheck=new y1(this.settings)}registerDefault(){this.container.registerConfiguration("nlu-??",{keepStopwords:!0,nonefeatureValue:1,nonedeltaMultiplier:1.2,spellCheck:!1,spellCheckDistance:1,filterZeros:!0,log:!0},!1),this.container.registerPipeline("nlu-??-train",[".prepareCorpus",".addNoneFeature",".innerTrain"],!1)}defaultPipelinePrepare(t){return K(this,null,function*(){let e;if(this.cache&&Math.abs(new Date().getTime()-this.cache.created)/36e5>1&&(this.cache.results={},this.cache.created=new Date().getTime()),!this.cache)this.cache={created:new Date().getTime(),results:{},normalize:this.container.get("normalize"),tokenize:this.container.get("tokenize"),removeStopwords:this.container.get("removeStopwords"),stem:this.container.get("stem"),arrToObj:this.container.get("arrToObj")};else if(this.cache.results[t.settings.locale]&&(e=this.cache.results[t.settings.locale][t.text||t.utterance],e))return e;let n=t;return n=this.cache.normalize.run(n),n=yield this.cache.tokenize.run(n),n=this.cache.removeStopwords.run(n),n=yield this.cache.stem.run(n),n=this.cache.arrToObj.run(n),e=n.tokens,this.cache.results[t.settings.locale]||(this.cache.results[t.settings.locale]={}),this.cache.results[t.settings.locale][t.text||t.utterance]=e,e})}defaultPipelineProcess(t){return K(this,null,function*(){let e=yield this.prepare(t);return e=yield this.doSpellCheck(e),e=yield this.textToFeatures(e),e=yield this.innerProcess(e),e=yield this.filterNonActivated(e),e=yield this.normalizeClassifications(e),e})}prepare(t,e){return K(this,null,function*(){let n=e||this.settings;if(typeof t=="string"){let r={locale:this.settings.locale,text:t,settings:n};return this.pipelinePrepare?this.runPipeline(r,this.pipelinePrepare):this.defaultPipelinePrepare(r)}if(typeof t=="object"){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a+=1)o.push(yield this.prepare(t[a],n));return o}let r=n.fieldNameSrc?t[n.fieldNameSrc]:t.texts||t.utterances;if(!r&&typeof r!="string"&&(typeof t.text=="string"?r=t.text:typeof t.utterance=="string"&&(r=t.utterance)),r||typeof r=="string"){let o=yield this.prepare(r,n),a=n.fieldNameTgt||"tokens";return ve({[a]:o},t)}}throw new Error(`Error at nlu.prepare: expected a text but received ${t}`)})}doSpellCheck(t,e){return K(this,null,function*(){let n=this.applySettings(e||{},this.settings),r=t.settings.spellCheck===void 0?void 0:t.settings.spellCheck,o=t.settings.spellCheckDistance===void 0?void 0:t.settings.spellCheckDistance;if(r===void 0&&(r=n.spellCheck===void 0?void 0:n.spellCheck),o===void 0&&(o=n.spellCheckDistance===void 0?1:n.spellCheckDistance),r){let a=this.spellCheck.check(t.tokens,o);t.tokens=a}return t})}prepareCorpus(t){return K(this,null,function*(){this.features={},this.intents={},this.intentFeatures={};let e=t,{corpus:n}=e,r=[];for(let a=0;a<n.length;a+=1){let{intent:s}=n[a],u={input:yield this.prepare(n[a].utterance,e.settings),output:{[s]:1}},c=Object.keys(u.input);Object.prototype.hasOwnProperty.call(this.intentFeatures,s)||(this.intentFeatures[s]={});for(let l=0;l<c.length;l+=1)this.features[c[l]]=1,this.intentFeatures[s][c[l]]=1;this.intents[s]=1,r.push(u)}let o=Object.keys(this.intentFeatures);this.featuresToIntent={};for(let a=0;a<o.length;a+=1){let s=o[a],u=Object.keys(this.intentFeatures[s]);for(let c=0;c<u.length;c+=1){let l=u[c];Object.prototype.hasOwnProperty.call(this.featuresToIntent,l)||(this.featuresToIntent[l]=[]),this.featuresToIntent[l].push(s)}}return this.spellCheck.setFeatures(this.features),this.numFeatures=Object.keys(this.features).length,this.numIntents=Object.keys(this.intents).length,e.corpus=r,e})}addNoneFeature(t){let{corpus:e}=t;return t.settings&&t.settings.useNoneFeature&&e.push({input:{nonefeature:1},output:{None:1}}),t}convertToArray(t){let e=t,{classifications:n}=e;if(n){this.intentsArr||(this.intents?(this.intentsArr=Object.keys(this.intents),this.intents.None||this.intentsArr.push("None")):this.intentsArr=Object.keys(n));let r=this.intentsArr,o=[];for(let a=0;a<r.length;a+=1){let s=r[a],u=n[s];u!==void 0&&(u>0||!e.settings.filterZeros)&&o.push({intent:s,score:u})}o.length||o.push({intent:"None",score:1}),e.classifications=o.sort((a,s)=>s.score-a.score)}return e}someSimilar(t,e){for(let n=0;n<e.length;n+=1)if(t[e[n]])return!0;return!1}matchAllowList(t,e){for(let n=0;n<e.length;n+=1)if(g1(t,e[n]))return!0;return!1}intentIsActivated(t,e,n){if(n){if(Array.isArray(n))return this.matchAllowList(t,n);if(!n[t])return!1}let r=this.intentFeatures[t];if(!r)return!1;let o=Object.keys(e);for(let a=0;a<o.length;a+=1)if(r[o[a]])return!0;return!1}filterNonActivated(t){if(this.intentFeatures&&t.classifications){let e=t.classifications.map(r=>r.intent),n=!1;for(let r=0;r<e.length;r+=1){let o=e[r];o!=="None"&&(this.intentIsActivated(o,t.tokens,t.settings.allowList)||(t.classifications[r].score=0,n=!0))}n&&t.classifications.sort((r,o)=>o.score-r.score)}return t}normalizeClassifications(t){let e=t,{classifications:n}=e;if(n){let r=0;for(let o=0;o<n.length;o+=1)n[o].score**=2,r+=n[o].score;if(r>0)for(let o=0;o<n.length;o+=1)n[o].score/=r}else e.classifications=e.nluAnswer;return e}textToFeatures(t){let e=t,{tokens:n}=e,r=Object.keys(n),o=0,a={};for(let c=0;c<r.length;c+=1){let l=r[c];l==="nonefeature"?n[l]=this.nonefeatureValue:!this.features||!this.features[l]?o+=1:a[l]=n[l]}let s=e.settings.nonedeltaValue===void 0?this.numIntents/this.numFeatures:this.settings.nonedeltaValue,u=0;for(let c=0;c<o;c+=1)u+=s,s*=this.settings.nonedeltaMultiplier;return e.settings&&e.settings.useNoneFeature&&u&&(a.nonefeature=u),e.tokens=a,e}innerTrain(){return K(this,null,function*(){throw new Error("This method should be implemented by child classes")})}train(t,e){return K(this,null,function*(){let n={corpus:t,settings:this.applySettings(e,this.settings)};return this.runPipeline(n,this.pipelineTrain)})}getExplanation(t,e){return K(this,null,function*(){if(!e)return;let n=yield this.container.get("normalize").run(t),r=yield this.container.get("tokenize").run(n),{tokens:o}=r,s=(yield this.container.get("stem").run(r)).tokens,u=[];u.push({token:"",stem:"##bias",weight:e.bias});for(let c=0;c<o.length;c+=1){let l=s[c];u.push({token:o[c],stem:l,weight:e.weights[l]})}return u})}process(t,e){return K(this,null,function*(){let n={text:t,settings:this.applySettings(e||{},this.settings)},r;if(this.pipelineProcess?r=yield this.runPipeline(n,this.pipelineProcess):r=yield this.defaultPipelineProcess(n),Array.isArray(r.classifications)){let o=n.settings.returnExplanation?yield this.getExplanation(n,r.explanation):void 0;return{classifications:r.classifications,entities:void 0,explanation:o}}return r.intents&&(r.classifications=r.intents,delete r.intents),r})}toJSON(){let t={settings:ve({},this.settings),features:this.features,intents:this.intents,intentFeatures:this.intentFeatures,featuresToIntent:this.featuresToIntent};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.features=t.features||{},this.intents=t.intents||{},this.intentsArr=Object.keys(t.intents),this.featuresToIntent=t.featuresToIntent||{},this.intentFeatures=t.intentFeatures||{},this.spellCheck.setFeatures(this.features),this.numFeatures=Object.keys(this.features).length,this.numIntents=Object.keys(this.intents).length}};Ff.exports=Ss});var If=Q((UE,Rf)=>{"use strict";var Fs=class{constructor(t,e="input"){this.dict={},this.items=[],t&&this.buildFromData(t,e)}add(t){this.dict[t]===void 0&&(this.dict[t]=this.items.length,this.items.push(t))}buildFromData(t,e){for(let n=0;n<t.length;n+=1){let r=t[n][e],o=Object.keys(r);for(let a=0;a<o.length;a+=1)this.add(o[a])}}prepare(t){let e=Object.keys(t),n=[],r={};for(let o=0;o<e.length;o+=1){let a=e[o];this.dict[a]!==void 0&&(n.push(this.dict[a]),r[this.dict[a]]=t[a])}return{keys:n,data:r}}};Rf.exports=Fs});var Nf=Q((jE,Tf)=>{"use strict";var vo=If(),Rs=class{constructor(t,e){if(t){this.inputLookup=new vo,this.outputLookup=new vo;for(let n=0;n<t.length;n+=1)this.inputLookup.add(t[n]);for(let n=0;n<e.length;n+=1)this.outputLookup.add(e[n]);this.numInputs=this.inputLookup.items.length,this.numOutputs=this.outputLookup.items.length}}build(t){this.inputLookup=new vo(t,"input"),this.outputLookup=new vo(t,"output"),this.numInputs=this.inputLookup.items.length,this.numOutputs=this.outputLookup.items.length;let e=[];for(let n=0;n<t.length;n+=1){let{input:r,output:o}=t[n];e.push({input:this.inputLookup.prepare(r),output:this.outputLookup.prepare(o)})}return e}transformInput(t){return this.inputLookup.prepare(t)}};Tf.exports=Rs});var Of=Q((GE,Mf)=>{"use strict";var Pf=Nf(),Is={iterations:2e4,errorThresh:5e-5,deltaErrorThresh:1e-6,learningRate:.6,momentum:.5,alpha:.07,log:!1},Ts=class{constructor(t={}){this.settings=t,this.applySettings(this.settings,Is),this.settings.log===!0?this.logFn=(e,n)=>console.log(`Epoch ${e.iterations} loss ${e.error} time ${n}ms`):typeof this.settings.log=="function"&&(this.logFn=this.settings.log)}applySettings(t={},e={}){return Object.keys(e).forEach(n=>{t[n]===void 0&&(t[n]=e[n])}),t}initialize(t,e){this.perceptronsByName={},this.perceptrons=[],this.outputs={},this.numPerceptrons=e.length;for(let n=0;n<e.length;n+=1){let r=e[n];this.outputs[r]=0;let o={name:r,id:n,weights:new Float32Array(t),changes:new Float32Array(t),bias:0};this.perceptrons.push(o),this.perceptronsByName[r]=o}}runInputPerceptron(t,e){let n=e.keys.reduce((r,o)=>r+e.data[o]*t.weights[o],t.bias);return n<=0?0:this.settings.alpha*n}runInput(t){for(let e=0;e<this.numPerceptrons;e+=1)this.outputs[this.perceptrons[e].name]=this.runInputPerceptron(this.perceptrons[e],t);return this.outputs}get isRunnable(){return!!this.numPerceptrons}run(t){return this.numPerceptrons?this.runInput(this.lookup.transformInput(t)):void 0}prepareCorpus(t){return this.lookup=new Pf,this.lookup.build(t)}verifyIsInitialized(){this.perceptrons||this.initialize(this.lookup.numInputs,this.lookup.outputLookup.items)}trainPerceptron(t,e){let{alpha:n,momentum:r}=this.settings,{changes:o,weights:a}=t,s=0;for(let u=0;u<e.length;u+=1){let{input:c,output:l}=e[u],f=this.runInputPerceptron(t,c),p=(l.data[t.id]||0)-f;if(p){s+=p**2;let d=(f>0?1:n)*p*this.decayLearningRate;for(let m=0;m<c.keys.length;m+=1){let v=c.keys[m],g=d*c.data[v]+r*o[v];o[v]=g,a[v]+=g}t.bias+=d}}return s}train(t){if(!t||!t.length)return{};if(t[t.length-1].input.nonefeature!==void 0){let a={};for(let c=0;c<t.length-1;c+=1){let l=Object.keys(t[c].output);for(let f=0;f<l.length;f+=1)a[l[f]]||(a[l[f]]=1)}let s=t[t.length-1],u=Object.keys(a);for(let c=0;c<u.length;c+=1)s.output[u[c]]=1e-7}let n=this.prepareCorpus(t);this.status||(this.status={error:1/0,deltaError:1/0,iterations:0}),this.verifyIsInitialized();let r=this.settings.errorThresh,o=this.settings.deltaErrorThresh;for(;this.status.iterations<this.settings.iterations&&this.status.error>r&&this.status.deltaError>o;){let a=new Date;this.status.iterations+=1,this.decayLearningRate=this.settings.learningRate/(1+.001*this.status.iterations);let s=this.status.error;this.status.error=0;for(let c=0;c<this.numPerceptrons;c+=1)this.status.error+=this.trainPerceptron(this.perceptrons[c],n);this.status.error/=this.numPerceptrons*n.length,this.status.deltaError=Math.abs(this.status.error-s);let u=new Date;this.logFn&&this.logFn(this.status,u.getTime()-a.getTime())}return this.status}explain(t,e){let n=this.lookup.transformInput(t),r={},o=this.lookup.outputLookup.dict[e];if(o===void 0)return{};for(let a=0;a<n.keys.length;a+=1){let s=n.keys[a];r[this.lookup.inputLookup.items[s]]=this.perceptrons[o].weights[s]}return{weights:r,bias:this.perceptrons[o].bias}}toJSON(){let t={},e=Object.keys(this.settings);for(let a=0;a<e.length;a+=1){let s=e[a];this.settings[s]!==Is[s]&&(t[s]=this.settings[s])}if(!this.lookup)return{settings:t};let n=this.lookup.inputLookup.items,r=this.lookup.outputLookup.items,o=[];for(let a=0;a<this.perceptrons.length;a+=1){let s=this.perceptrons[a],u=[...s.weights,s.bias];o.push(u)}return{settings:t,features:n,intents:r,perceptrons:o}}fromJSON(t){if(this.settings=this.applySettings(ve(ve({},Is),t.settings)),t.features){this.lookup=new Pf(t.features,t.intents),this.initialize(t.features.length,t.intents);for(let e=0;e<this.perceptrons.length;e+=1){let n=this.perceptrons[e],r=t.perceptrons[e];n.bias=r[r.length-1];for(let o=0;o<t.features.length;o+=1)n.weights[o]=r[o]}}}};Mf.exports=Ts});var Lf=Q((KE,Bf)=>{"use strict";var x1=Of();Bf.exports={NeuralNetwork:x1}});var qf=Q((XE,zf)=>{"use strict";var{NeuralNetwork:Wf}=Lf(),b1=As(),Ns=class i extends b1{innerTrain(t){return K(this,null,function*(){let e=t;return this.neuralNetwork=new Wf(e.settings,this.container),e.status=yield this.neuralNetwork.train(e.corpus),e})}innerProcess(t){let e=t;e.classifications=this.neuralNetwork?this.neuralNetwork.run(e.tokens)||{None:1}:{None:1},this.convertToArray(e);let{intent:n}=e.classifications[0];return e.settings&&e.settings.returnExplanation&&n&&this.neuralNetwork&&n!=="None"&&(e.explanation=this.neuralNetwork.explain(e.tokens,n)),e}registerDefault(){super.registerDefault(),this.container.register("NeuralNlu",i,!1)}toJSON(){let t=super.toJSON();return t.neuralNetwork=this.neuralNetwork?this.neuralNetwork.toJSON():void 0,t}fromJSON(t){super.fromJSON(t),t.neuralNetwork&&(this.neuralNetwork=new Wf,this.neuralNetwork.fromJSON(t.neuralNetwork))}};zf.exports=Ns});var Ms=Q((YE,Vf)=>{"use strict";var{Clonable:w1,compareWildcars:C1}=rt(),Xt="master_domain",Ps=class extends w1{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings,{locale:"en"}),this.settings.tag||(this.settings.tag=`domain-manager-${this.settings.locale}`),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.domains={},this.addDomain(Xt),this.stemDict={},this.intentDict={},this.sentences=[],this.applySettings(this,{pipelineTrain:this.getPipeline(`${this.settings.tag}-train`),pipelineProcess:this.getPipeline(`${this.settings.tag}-process`)})}registerDefault(){this.container.registerConfiguration("domain-manager-??",{nluByDomain:{default:{className:"NeuralNlu",settings:{}}},trainByDomain:!1,useStemDict:!0},!1),this.container.registerPipeline("domain-manager-??-train",[".trainStemmer",".generateCorpus",".fillStemDict",".innerTrain","output.status"],!1)}getDomainInstance(t){this.settings.nluByDomain||(this.settings.nluByDomain={});let e=this.settings.nluByDomain[t]||this.settings.nluByDomain.default||{className:"NeuralNlu",settings:{}};return this.container.get(e.className||"NeuralNlu",this.applySettings({locale:this.settings.locale},e.settings||{}))}addDomain(t){return this.domains[t]||(this.domains[t]=this.getDomainInstance(t)),this.domains[t]}removeDomain(t){delete this.domains[t]}generateStemKey(t){return K(this,null,function*(){let e;return typeof t!="string"?e=t:e=yield(yield this.prepare({utterance:t})).stems,Array.isArray(e)||(e=Object.keys(e)),e.slice().sort().join()})}add(t,e,n){n?this.sentences.push({domain:t,utterance:e,intent:n}):this.sentences.push({domain:Xt,utterance:t,intent:e})}getSentences(){return this.sentences}remove(t,e,n){let r=n?t:Xt,o=n?e:t,a=n||e;for(let s=0;s<this.sentences.length;s+=1){let u=this.sentences[s];if(u.domain===r&&u.utterance===o&&u.intent===a)return this.sentences.splice(s,1),!0}return!1}trainStemmer(t){return K(this,null,function*(){let e=t;this.cache||(this.cache={stem:this.container.get("stem")});for(let n=0;n<this.sentences.length;n+=1){let r=this.sentences[n],o=ve(ve({},r),e);yield this.cache.stem.addForTraining(o)}return yield this.cache.stem.train(e),e})}innerGenerateCorpus(t){this.intentDict={};let e={};e[Xt]=[];for(let n=0;n<this.sentences.length;n+=1){let r=this.sentences[n];this.intentDict[r.intent]=r.domain;let o=t||r.domain;e[o]||(e[o]=[]),e[o].push({utterance:r.utterance,intent:r.intent}),t||e[Xt].push({utterance:r.utterance,intent:r.domain})}return e}generateCorpus(t){return K(this,null,function*(){let e=t;return e.corpus=this.innerGenerateCorpus(this.settings.trainByDomain?void 0:Xt),e})}prepare(t){return K(this,null,function*(){let e=t,n=typeof e=="string",r=n?e:e.utterance,a=this.addDomain(Xt).prepare(r);return n?a:(e.stems=a,e)})}fillStemDict(t){return K(this,null,function*(){this.stemDict={};for(let e=0;e<this.sentences.length;e+=1){let{utterance:n,intent:r,domain:o}=this.sentences[e],a=yield this.generateStemKey(n);(!a||a==="")&&this.container.get("logger").warn(`This utterance: "${n}" contains only stop words`),this.stemDict[a]={intent:r,domain:o}}return t})}innerTrain(t){return K(this,null,function*(){let e=t,{corpus:n}=e,r=Object.keys(n),o={};for(let a=0;a<r.length;a+=1){let s=this.addDomain(r[a]),u={useNoneFeature:this.settings.useNoneFeature};t.settings&&t.settings.log!==void 0&&(u.log=t.settings.log);let c=yield s.train(n[r[a]],u);o[r[a]]=c.status}return e.status=o,e})}train(t){return K(this,null,function*(){let e={domainManager:this,settings:t||this.settings};return this.runPipeline(e,this.pipelineTrain)})}matchAllowList(t,e){for(let n=0;n<e.length;n+=1)if(C1(t,e[n]))return!0;return!1}classifyByStemDict(t,e,n){return K(this,null,function*(){let r=yield this.generateStemKey(t),o=this.stemDict[r];if(o&&(!e||o.domain===e)){if(n&&!this.matchAllowList(o.intent,n))return;let a=[];a.push({intent:o.intent,score:1});let s=Object.keys(this.intentDict);for(let u=0;u<s.length;u+=1)s[u]!==o.intent&&a.push({intent:s[u],score:0});return{domain:o.domain,classifications:a}}})}innerClassify(t,e){return K(this,null,function*(){let n=t;if(this.applySettings(ve({},n.settings),this.settings).useStemDict){let a=yield this.classifyByStemDict(n.utterance,e,t.settings?t.settings.allowList:void 0);if(a)return n.classification=a,n.explanation=[{token:"",stem:"##exact",weight:1}],n}if(e){let a=this.domains[e];if(!a)return n.classification={domain:"default",classifications:[{intent:"None",score:1}]},n;let s=yield a.process(n.utterance,n.settings||this.settings),u;Array.isArray(s)?u=s:(u=s.classifications,n.nluAnswer=s);let c;return e===Xt?u&&u.length?c=this.intentDict[u[0].intent]:c=Xt:c=e,n.classification={domain:c,classifications:u},n}let o=Xt;if(n.settings.trainByDomain===void 0&&this.settings.trainByDomain||n.settings.trainByDomain){let s=yield this.domains[Xt].process(n.utterance);if(s.classifications&&(s=s.classifications),Object.keys(this.domains).length===1)return n.classification={domain:"default",classifications:s},n;if(o=s[0].intent,o==="None")return n.classification={domain:"default",classifications:[{intent:"None",score:1}]},n}return this.innerClassify(n,o)})}defaultPipelineProcess(t){return K(this,null,function*(){return(yield this.innerClassify(t)).classification})}process(t,e){return K(this,null,function*(){let n=typeof t=="string"?{utterance:t,settings:e||this.settings}:t;return this.pipelineProcess?this.runPipeline(n,this.pipelineProcess):this.defaultPipelineProcess(n)})}toJSON(){let t={settings:this.settings,stemDict:this.stemDict,intentDict:this.intentDict,sentences:this.sentences,domains:{}};delete t.settings.container;let e=Object.keys(this.domains);for(let n=0;n<e.length;n+=1)t.domains[e[n]]=this.domains[e[n]].toJSON();return t}fromJSON(t){this.applySettings(this.settings,t.settings),this.stemDict=t.stemDict,this.intentDict=t.intentDict,this.sentences=t.sentences;let e=Object.keys(t.domains);for(let n=0;n<e.length;n+=1)this.addDomain(e[n]).fromJSON(t.domains[e[n]])}};Vf.exports=Ps});var Uf=Q((QE,_1)=>{_1.exports=[["ar","arb","Arabic"],["bn","ben","Bengali"],["ca","cat","Catalan"],["cs","ces","Czech"],["da","dan","Danish"],["de","deu","German"],["el","ell","Greek"],["en","eng","English"],["eu","eus","Basque"],["fa","fas","Persian"],["fi","fin","Finnish"],["fr","fra","French"],["ga","gle","Irish"],["gl","glg","Galician"],["hi","hin","Hindi"],["hu","hun","Hungarian"],["hy","hye","Armenian"],["id","ind","Indonesian"],["it","ita","Italian"],["ja","jpn","Japanese"],["ko","kor","Korean"],["lt","lit","Lithuanian"],["ne","nep","Nepali"],["nl","nld","Dutch"],["no","nor","Norwegian"],["pl","pol","Polish"],["pt","por","Portuguese"],["ro","ron","Romanian"],["ru","rus","Russian"],["sr","srp","Serbian"],["sl","slv","Slovenian"],["es","spa","Spanish"],["sv","swe","Swedish"],["ta","tam","Tamil"],["tl","tgl","Tagalog"],["th","tha","Thai"],["tr","tur","Turkish"],["uk","ukr","Ukrainian"],["zh","cmn","Chinese"]]});var jf=Q((ZE,E1)=>{E1.exports={Latin:{spa:"",eng:"",por:"",ind:"",fra:"",deu:"",ita:"",tur:"",nld:"",tgl:"",hun:"",ces:"",swe:"",fin:"",dan:"",cat:"",glg:"",slv:""},Cyrillic:{rus:"",ukr:""},Arabic:{arb:"",fas:""},Devanagari:{hin:""},Ethiopic:{},Hebrew:{}}});var $f=Q((ek,Xf)=>{"use strict";var go=Uf(),cn=jf(),Kf={cmn:/[\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3038-\u303B\u3400-\u4DB5\u4E00-\u9FCC\uF900-\uFA6D\uFA70-\uFAD9]|[\uD840-\uD868\uD86A-\uD86C][\uDC00-\uDFFF]|\uD869[\uDC00-\uDED6\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D]|\uD87E[\uDC00-\uDE1D]/g,Latin:/[A-Za-z\xAA\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02B8\u02E0-\u02E4\u1D00-\u1D25\u1D2C-\u1D5C\u1D62-\u1D65\u1D6B-\u1D77\u1D79-\u1DBE\u1E00-\u1EFF\u2071\u207F\u2090-\u209C\u212A\u212B\u2132\u214E\u2160-\u2188\u2C60-\u2C7F\uA722-\uA787\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA7FF\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uFB00-\uFB06\uFF21-\uFF3A\uFF41-\uFF5A]/g,Cyrillic:/[\u0400-\u0484\u0487-\u052F\u1D2B\u1D78\u2DE0-\u2DFF\uA640-\uA69D\uA69F]/g,Arabic:/[\u0600-\u0604\u0606-\u060B\u060D-\u061A\u061E\u0620-\u063F\u0641-\u064A\u0656-\u065F\u066A-\u066F\u0671-\u06DC\u06DE-\u06FF\u0750-\u077F\u08A0-\u08B2\u08E4-\u08FF\uFB50-\uFBC1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFD\uFE70-\uFE74\uFE76-\uFEFC]|\uD803[\uDE60-\uDE7E]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB\uDEF0\uDEF1]/g,ben:/[\u0980-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09FB]/g,Devanagari:/[\u0900-\u0950\u0953-\u0963\u0966-\u097F\uA8E0-\uA8FB]/g,jpn:/[\u3041-\u3096\u309D-\u309F]|\uD82C\uDC01|\uD83C\uDE00|[\u30A1-\u30FA\u30FD-\u30FF\u31F0-\u31FF\u32D0-\u32FE\u3300-\u3357\uFF66-\uFF6F\uFF71-\uFF9D]|\uD82C\uDC00/g,kor:/[\u1100-\u11FF\u302E\u302F\u3131-\u318E\u3200-\u321E\u3260-\u327E\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/g,tel:/[\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C78-\u0C7F]/g,tam:/[\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BFA]/g,guj:/[\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AF1]/g,kan:/[\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2]/g,mal:/[\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D75\u0D79-\u0D7F]/g,Myanmar:/[\u1000-\u109F\uA9E0-\uA9FE\uAA60-\uAA7F]/g,ori:/[\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B77]/g,pan:/[\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75]/g,Ethiopic:/[\u1200-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u137C\u1380-\u1399\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E]/g,tha:/[\u0E01-\u0E3A\u0E40-\u0E5B]/g,sin:/[\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2-\u0DF4]|\uD804[\uDDE1-\uDDF4]/g,ell:/[\u0370-\u0373\u0375-\u0377\u037A-\u037D\u037F\u0384\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03E1\u03F0-\u03FF\u1D26-\u1D2A\u1D5D-\u1D61\u1D66-\u1D6A\u1DBF\u1F00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FC4\u1FC6-\u1FD3\u1FD6-\u1FDB\u1FDD-\u1FEF\u1FF2-\u1FF4\u1FF6-\u1FFE\u2126\uAB65]|\uD800[\uDD40-\uDD8C\uDDA0]|\uD834[\uDE00-\uDE45]/g,khm:/[\u1780-\u17DD\u17E0-\u17E9\u17F0-\u17F9\u19E0-\u19FF]/g,hye:/[\u0531-\u0556\u0559-\u055F\u0561-\u0587\u058A\u058D-\u058F\uFB13-\uFB17]/g,sat:/[\u1C50-\u1C7F]/g,bod:/[\u0F00-\u0F47\u0F49-\u0F6C\u0F71-\u0F97\u0F99-\u0FBC\u0FBE-\u0FCC\u0FCE-\u0FD4\u0FD9\u0FDA]/g,Hebrew:/[\u0591-\u05C7\u05D0-\u05EA\u05F0-\u05F4\uFB1D-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFB4F]/g,kat:/[\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u10FF\u2D00-\u2D25\u2D27\u2D2D]/g,lao:/[\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF]/g,zgh:/[\u2D30-\u2D67\u2D6F\u2D70\u2D7F]/g,iii:/[\uA000-\uA48C\uA490-\uA4C6]/g,aii:/[\u0700-\u070D\u070F-\u074A\u074D-\u074F]/g},Gf=Object.keys(Kf),Hf=()=>[["und",1]],yo=class i{constructor(){this.languagesAlpha3={},this.languagesAlpha2={},this.extraSentences=[],this.buildData()}static getTrigrams(t){let e=[],n=t?` ${String(t).replace(/[\u0021-\u0040]+/g," ").replace(/\s+/g," ").trim().toLowerCase()} `:"";if(!n||n.length<3)return e;for(let r=0,o=n.length-2;r<o;r+=1)e[r]=n.substr(r,3);return e}static asTuples(t){let e=i.getTrigrams(t).reduce((r,o)=>{let a=r;return a[o]=(a[o]||0)+1,a},{}),n=[];return Object.keys(e).forEach(r=>{n.push([r,e[r]])}),n.sort((r,o)=>r[1]-o[1]),n}static getDistance(t,e){let n=0;return t.forEach(r=>{n+=r[0]in e?Math.abs(r[1]-e[r[0]]-1):300}),n}static getOccurrence(t,e){let n=t.match(e);return(n?n.length:0)/t.length||0}static isLatin(t){let e=0,n=t.length/2;for(let r=0;r<t.length;r+=1){let o=t.charCodeAt(r);if(o>=32&&o<=126&&(e+=1,e>n))return!0}return e>n}static getTopScript(t){if(i.isLatin(t))return["Latin",1];let e=-1,n;for(let r=0;r<Gf.length;r+=1){let o=Gf[r],a=i.getOccurrence(t,Kf[o]);if(a>e&&(e=a,n=o,e===1))return[n,e]}return[n,e]}static filterLanguages(t,e,n){if(e.length===0&&n.length===0)return t;let r={};return Object.keys(t).forEach(o=>{(e.length===0||e.indexOf(o)>-1)&&n.indexOf(o)===-1&&(r[o]=t[o])}),r}static getDistances(t,e,n){let r=[],o=n.allowList||[],a=n.denyList||[],s=i.filterLanguages(e,o,a);return s?(Object.keys(s).forEach(u=>{r.push([u,i.getDistance(t,s[u])])}),r.sort((u,c)=>u[1]-c[1])):Hf()}static detectAll(t,e={}){let n=e.minLength||10;if(!t||t.length<n)return Hf();let r=t.substr(0,2048),o=i.getTopScript(r);if(!(o[0]in cn)&&o[1]>.5)if(e.allowList){if(e.allowList.includes(o[0]))return[[o[0],1]];if(o[0]==="cmn"&&e.allowList.includes("jpn"))return[["jpn",1]]}else return[[o[0],1]];if(cn[o[0]]){let a=i.getDistances(i.asTuples(r),cn[o[0]],e);if(a[0][0]==="und")return[[o[0],1]];let s=a[0][1],u=r.length*300-s;return a.map(c=>[c[0],1-(c[1]-s)/u||0])}return[[o[0],1]]}buildData(){for(let t=0;t<go.length;t+=1){let e={alpha2:go[t][0],alpha3:go[t][1],name:go[t][2]};this.languagesAlpha3[e.alpha3]=e,this.languagesAlpha2[e.alpha2]=e}}transformAllowList(t){let e=[];for(let n=0;n<t.length;n+=1)if(t[n].length===3)e.push(t[n]);else{let r=this.languagesAlpha2[t[n]];r&&e.push(r.alpha3)}return e}guess(t,e,n){let r={};t.length<10&&(r.minLength=t.length),e&&e.length&&e.length>0&&(r.allowList=this.transformAllowList(e));let o=i.detectAll(t,r),a=[];for(let s=0;s<o.length;s+=1){let u=this.languagesAlpha3[o[s][0]];if(u&&(a.push({alpha3:u.alpha3,alpha2:u.alpha2,language:u.name,score:o[s][1]}),n&&a.length>=n))break}return a}guessBest(t,e){return this.guess(t,e,1)[0]}addTrigrams(t,e){let n=this.languagesAlpha2[t],r=n?n.alpha3:t,o=i.getTopScript(e)[0],a=i.getTrigrams(e);cn[o]&&(cn[o][r]||(cn[o][r]={}),a.forEach(s=>{cn[o][r][s]=1}))}addExtraSentence(t,e){this.extraSentences.push([t,e]),this.addTrigrams(t,e)}processExtraSentences(){this.extraSentences.forEach(t=>{this.addTrigrams(t[0],t[1])})}static lansplit(t){if(t.includes("|"))return t.split("|");let e=[];for(let n=0;n<t.length;n+=3)e.push(t.substr(n,3));return e}static addModel(t,e,n){let r=cn[t],o=i.lansplit(n),a=o.length,s={};for(;a>0;)a-=1,s[o[a]]=a;r[e]=s}addModel(t,e,n){i.addModel(t,e,n)}static buildModel(){Object.keys(cn).forEach(t=>{let e=cn[t];Object.keys(e).forEach(n=>{i.addModel(t,n,e[n])})})}};yo.buildModel();Xf.exports=yo});var Os=Q((tk,Yf)=>{"use strict";var k1=$f();Yf.exports={Language:k1}});var Qf=Q((nk,Jf)=>{"use strict";var{Clonable:D1}=rt(),{Language:S1}=Os(),A1=Ms(),Bs=class extends D1{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlu-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.container.get("Language")||this.container.register("Language",S1,!1),this.guesser=this.container.get("Language"),this.locales=[],this.languageNames={},this.domainManagers={},this.intentDomains={},this.settings.locales&&this.addLanguage(this.settings.locales),this.applySettings(this,{pipelineTrain:this.getPipeline(`${this.settings.tag}-train`),pipelineProcess:this.getPipeline(`${this.settings.tag}-process`)})}registerDefault(){this.container.registerConfiguration("nlu-manager",{},!1),this.container.registerPipeline("nlu-manager-train",[".innerTrain"],!1)}describeLanguage(t,e){this.languageNames[t]={locale:t,name:e}}addLanguage(t){if(t){let e=Array.isArray(t)?t:[t];for(let n=0;n<e.length;n+=1){let r=e[n].substr(0,2).toLowerCase();this.locales.includes(r)||this.locales.push(r),this.domainManagers[r]||(this.domainManagers[r]=new A1(wn(ve({locale:r},this.settings.domain),{useNoneFeature:this.settings.useNoneFeature,trainByDomain:this.settings.trainByDomain}),this.container))}}}removeLanguage(t){if(Array.isArray(t))t.forEach(e=>this.removeLanguage(e));else{delete this.domainManagers[t];let e=this.locales.indexOf(t);e!==-1&&this.locales.splice(e,1)}}guessLanguage(t){let e=t,n=typeof e=="string";if(this.locales.length===1)return n?this.locales[0]:([e.locale]=this.locales,e);if(!e)return n?void 0:e;if(!n&&e.locale)return e;let r=n?e:e.utterance;if(this.locales.length===1){if(n)return this.locales[0];[e.locale]=this.locales}let o=this.guesser.guess(r,this.locales,1),a=o&&o.length>0?o[0].alpha2:void 0;return n?a:(e.locale=a,e)}assignDomain(t,e,n){let r=n?t.substr(0,2).toLowerCase():void 0,o=n?e:t,a=n||e;if(r)this.intentDomains[r]||(this.intentDomains[r]={}),this.intentDomains[r][o]=a;else for(let s=0;s<this.locales.length;s+=1)this.assignDomain(this.locales[s],o,a)}getIntentDomain(t,e){let n=t.substr(0,2).toLowerCase();return this.intentDomains[n]&&this.intentDomains[n][e]||"default"}getDomains(){let t={},e=Object.keys(this.intentDomains);for(let n=0;n<e.length;n+=1){let r=e[n];t[r]={};let o=Object.keys(this.intentDomains[r]);for(let a=0;a<o.length;a+=1){let s=o[a],u=this.intentDomains[r][s];t[r][u]||(t[r][u]=[]),t[r][u].push(s)}}return t}consolidateLocale(t,e){let n=t?t.substr(0,2).toLowerCase():this.guessLanguage(e);if(!n)throw new Error("Locale must be defined");return n}consolidateManager(t){let e=this.domainManagers[t];if(!e)throw new Error(`Domain Manager not found for locale ${t}`);return e}add(t,e,n){let r=this.consolidateLocale(t,e),o=this.consolidateManager(r),a=this.getIntentDomain(r,n);this.guesser.addExtraSentence(r,e),o.add(a,e,n)}remove(t,e,n){let r=this.consolidateLocale(t,e),o=this.consolidateManager(r),a=this.getIntentDomain(r,n);o.remove(a,e,n)}innerTrain(t){return K(this,null,function*(){let e=t.locales||this.locales;Array.isArray(e)||(e=[e]);let n=e.filter(r=>this.domainManagers[r]).map(r=>this.domainManagers[r].train(t.settings));return Promise.all(n)})}train(t){return K(this,null,function*(){let e={nluManager:this,settings:this.applySettings(t,this.settings)};return delete e.settings.tag,this.runPipeline(e,this.pipelineTrain)})}fillLanguage(t){let e=t;return e.languageGuessed=!1,e.locale||(e.locale=this.guessLanguage(e.utterance),e.languageGuessed=!0),e.locale&&(e.localeIso2=e.locale.substr(0,2).toLowerCase(),e.language=(this.languageNames[e.localeIso2]||this.guesser.languagesAlpha2[e.localeIso2]||{}).name),e}classificationsIsNone(t){return t.length===1?!1:t.length===0||t[0].score===0?!0:t[0].score===t[1].score}checkIfIsNone(t){let e=t;return this.classificationsIsNone(e.classifications)&&(e.intent="None",e.score=1),e}innerClassify(t){return K(this,null,function*(){let e=t,n=this.domainManagers[e.localeIso2];if(!n)return e.classifications=[],e.domain=void 0,e.intent=void 0,e.score=void 0,e;let r=yield n.process(t);return e.classifications=r.classifications.sort((o,a)=>a.score-o.score),e.classifications.length===0&&e.classifications.push({intent:"None",score:1}),e.intent=e.classifications[0].intent,e.score=e.classifications[0].score,e.intent==="None"?r.domain="default":r.domain==="default"?e.domain=this.getIntentDomain(e.locale,e.intent):e.domain=r.domain,e})}defaultPipelineProcess(t){return K(this,null,function*(){let e=yield this.fillLanguage(t);return e=yield this.innerClassify(e),e=yield this.checkIfIsNone(e),delete e.settings,delete e.classification,e})}process(t,e,n,r){let o=typeof t=="object"?t:{locale:e===void 0?void 0:t,utterance:e===void 0?t:e,domain:n,settings:r||this.settings};return this.pipelineProcess?this.runPipeline(o,this.pipelineProcess):this.defaultPipelineProcess(o)}toJSON(){let t={settings:this.settings,locales:this.locales,languageNames:this.languageNames,domainManagers:{},intentDomains:this.intentDomains,extraSentences:this.guesser.extraSentences.slice(0)};delete t.settings.container;let e=Object.keys(this.domainManagers);for(let n=0;n<e.length;n+=1){let r=e[n];t.domainManagers[r]=this.domainManagers[r].toJSON()}return t}fromJSON(t){this.applySettings(this.settings,t.settings);for(let n=0;n<t.locales.length;n+=1)this.addLanguage(t.locales[n]);this.languageNames=t.languageNames,this.intentDomains=t.intentDomains;let e=Object.keys(t.domainManagers);for(let n=0;n<e.length;n+=1){let r=e[n];this.domainManagers[r].fromJSON(t.domainManagers[r])}for(let n=0;n<t.extraSentences.length;n+=1){let r=t.extraSentences[n];this.guesser.addExtraSentence(r[0],r[1])}}};Jf.exports=Bs});var eh=Q((ik,Zf)=>{"use strict";var F1=As(),R1=qf(),I1=Ms(),T1=Qf();Zf.exports={Nlu:F1,NluNeural:R1,DomainManager:I1,NluManager:T1}});var xo=Q((ok,nh)=>{"use strict";var th={Between:"between",After:"after",AfterLast:"afterLast",AfterFirst:"afterFirst",Before:"before",BeforeFirst:"beforeFirst",BeforeLast:"beforeLast"},N1=Object.values(th);nh.exports={TrimType:th,TrimTypesList:N1}});var mi=Q((ak,rh)=>{"use strict";var{TrimTypesList:P1}=xo();function M1(i,t,e,n=[]){let r,o;if(i.accuracy>t.accuracy||i.accuracy===t.accuracy&&i.length>t.length?(r=i,o=t):(r=t,o=i),o.start<=r.end&&o.end>=r.start){if(o.accuracy<r.accuracy)o.discarded=!0;else if((e||o.entity===r.entity||o.entity==="number")&&o.len<=r.len)o.start===r.start&&o.end===r.end&&o.type===r.type&&o.entity===r.entity&&o.option===r.option?o.discarded=!0:o.start===r.start&&o.end===r.end&&o.entity===r.entity&&o.type!==r.type&&(r.type==="trim"&&o.type!=="trim"?r.discarded=!0:(r.type!=="trim"&&o.type,o.discarded=!0));else if((e||o.entity===r.entity||r.entity==="number")&&o.len>r.len)r.discarded=!0;else if(r.type==="enum"&&o.type==="enum"){let a=n.includes(r.entity),s=n.includes(o.entity);a&&!s?o.discarded=!0:!a&&s||r.len<=o.len&&o.utteranceText.includes(r.utteranceText)?r.discarded=!0:r.len>o.len&&r.utteranceText.includes(o.utteranceText)&&(o.discarded=!0)}}}function O1(i){for(let t=0,e=i.length;t<e;t+=1){let n=i[t];if(n.type==="trim"&&P1.includes(n.subtype))for(let r=0;r<i.length;r+=1){let o=i[r];if(t!==r&&o.start>=n.start&&o.end<=n.end&&o.type!=="trim"){let a=n.end-n.start,s=o.end-o.start;if(n.end===o.end){let u=n.sourceText.substring(0,a-s-1);n.sourceText=u,n.utteranceText=u,n.end=o.start-1,n.len=u.length}else if(n.start===o.start){let u=n.sourceText.substring(s+1);n.sourceText=u,n.utteranceText=u,n.start=o.end+1,n.len=u.length}}}}return i}function B1(i,t=!0,e=[]){i=O1(i);let n=i.length;for(let r=0;r<n;r+=1){let o=i[r];if(o.len===0&&(o.discarded=!0),!o.discarded)for(let a=r+1;a<n;a+=1){let s=i[a];if(s.discarded||M1(o,s,t,e),o.discarded)break}if(!o.discarded){let a=e.indexOf(o.entity);a!==-1&&e.splice(a,1)}}return i.filter(r=>!r.discarded)}rh.exports=B1});var Ws=Q((sk,ih)=>{"use strict";var{defaultContainer:L1}=rt(),{Language:W1}=Os(),{similarity:bo}=Ds(),z1=mi(),Ls=class{constructor(t=L1){this.container=t.container||t,this.name="extract-enum"}getScripts(t){let e=[],n=t.split("");for(let r=0;r<n.length;r+=1)e.push(W1.getTopScript(n[r]));return e}isAlphanumeric(t){return/[\u00C0-\u1FFF\u2C00-\uD7FF\w]/.test(t)&&t!=="_"}getWordPositions(t){let e=this.getScripts(t),n=!0,r=0,o=0,a=t.length,s=[];for(;o<a;)this.isAlphanumeric(t.charAt(o))?n&&(e[o][0]==="cmn"?(s.push({start:o,end:o,len:1}),r=o):(r=o,n=!1)):n||(s.push({start:r,end:o-1,len:o-r}),n=!0),o+=1;return n||s.push({start:r,end:o-1,len:o-r}),s}getBestSubstring(t,e,n){let r=t.length,o=e.length;if(r<=o){let c={start:0,end:r-1,len:r,levenshtein:bo(t,e,!0)};return c.accuracy=(o-c.levenshtein)/o,c}let a=n||this.getWordPositions(t),s=a.length,u={start:0,end:0,len:0,levenshtein:void 0,accuracy:0};for(let c=0;c<s;c+=1)for(let l=c;l<s;l+=1){let f=t.substring(a[c].start,a[l].end+1),h=bo(f,e,!0);(u.levenshtein===void 0||h<u.levenshtein)&&(u.levenshtein=h,u.start=a[c].start,u.end=a[l].end,u.len=u.end-u.start+1)}return u.accuracy=(o-u.levenshtein)/o,u}getBestSubstringList(t,e,n,r=1){let o=t.length,a=e.length,s=[];if(o<=a){let f=bo(t,e,!0),h=(a-f)/a;return h>=r&&s.push({start:0,end:o-1,len:o,levenshtein:f,accuracy:h}),s}let u=a*(1-r),c=n||this.getWordPositions(t),l=c.length;for(let f=0;f<l;f+=1)for(let h=f;h<l;h+=1){let p=t.substring(c[f].start,c[h].end+1),d=bo(p,e,!0),m=(a-d)/a;if(m>=r&&s.push({start:c[f].start,end:c[h].end,len:c[h].end-c[f].start+1,levenshtein:d,accuracy:m}),p.length-c[0].len>=e.length+u)break}return s}getRules(t){let e=t.nerRules;return e||[]}normalize(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}buildRuleDict(t){let e={},n={};for(let r=0;r<t.rules.length;r+=1){let o=t.rules[r];for(let a=0;a<o.texts.length;a+=1){let s=o.texts[a],u=this.normalize(o.texts[a]);e[u]||(e[u]=[]),e[u].push(o),n[u]=s}}t.dict=e,t.inverseDict=n}getBestExact(t,e,n){let r=this.normalize(t),o=e||this.getWordPositions(r),a=o.length,s=[];for(let u=0;u<a;u+=1)for(let c=u;c<a;c+=1){let l=r.substring(o[u].start,o[c].end+1);if(n.dict[l]){let f=n.dict[l];for(let h=0;h<f.length;h+=1)s.push({accuracy:1,start:o[u].start,end:o[c].end,len:o[c].end-o[u].start+1,levenshtein:0,entity:n.name,type:n.type,option:f[h].option,sourceText:n.inverseDict[l],utteranceText:t.substring(o[u].start,o[c].end+1)})}}return s}extractFromRule(t,e,n,r){if(e.type==="enum"){let o=[];if(r>=1){e.dict||this.buildRuleDict(e);let a=this.getBestExact(t,n,e);for(let s=0;s<a.length;s+=1)o.push(a[s])}else for(let a=0;a<e.rules.length;a+=1){let s=e.rules[a];if(s&&s.option&&Array.isArray(s.texts))for(let u=0;u<s.texts.length;u+=1){let c=this.getBestSubstringList(t,s.texts[u],n,s.threshold||r);for(let l=0;l<c.length;l+=1)o.push(wn(ve({},c[l]),{entity:e.name,type:e.type,option:e.rules[a].option,sourceText:s.texts[u],utteranceText:t.substring(c[l].start,c[l].end+1)}))}}return o}return[]}extract(t){return K(this,null,function*(){let e=t,n=e.text||e.utterance,r=n,o=[],a=this.container.get("tokenize");if(a){let l=yield a.run({locale:e.locale,text:r});if(r=l.tokens.join(" "),r!==n){let f=0,h=0;for(let p=0;p<l.tokens.length;p+=1){let d=n.indexOf(l.tokens[p],f);for(let m=0;m<l.tokens[p].length;m+=1)o[h+m]=d+m;f+=l.tokens[p].length,h+=l.tokens[p].length+1}}}let s=this.getWordPositions(r),u=this.getRules(e),c=e.edges||[];for(let l=0;l<u.length;l+=1){let f=this.extractFromRule(r,u[l],s,e.threshold||.8);for(let h=0;h<f.length;h+=1)c.push(f[h])}if(o.length>0)for(let l=0;l<c.length;l+=1){let f=c[l];f.start=o[f.start],f.end=o[f.end]}return c.sort((l,f)=>l.start-f.start),e.edges=z1(c,!1,e.intentEntities),e})}run(t){let e=t,n=e.locale||"en";return(this.container.get(`extract-enum-${n}`)||this).extract(e)}};ih.exports=Ls});var qs=Q((ck,oh)=>{"use strict";var{defaultContainer:q1}=rt(),V1=mi(),zs=class{constructor(t=q1){this.container=t.container||t,this.name="extract-regex"}getRules(t){let e=t.nerRules;return e||[]}getMatchs(t,e){let n=[],r;do{let o=e instanceof RegExp?e.exec(t):null;if(o){if(o.length===1)n.push({start:o.index,end:e.lastIndex-1,accuracy:1,sourceText:o[0]});else{let a=t.indexOf(o[1]);n.push({start:a,end:a+o[1].length-1,accuracy:1,sourceText:o[1]})}r=!0}else r=!1}while(r);return n}extractFromRule(t,e){let n=[];for(let r=0;r<e.rules.length;r+=1){let o=this.getMatchs(t,e.rules[r]);for(let a=0;a<o.length;a+=1){let s=o[a];s.entity=e.name,s.type=e.type,s.utteranceText=t.substring(s.start,s.end+1),s.len=s.utteranceText.length,n.push(s)}}return n}extract(t){let e=t,n=this.getRules(e),r=e.edges||[];for(let o=0;o<n.length;o+=1){let a=this.extractFromRule(e.text||e.utterance,n[o]);for(let s=0;s<a.length;s+=1)r.push(a[s])}return r.sort((o,a)=>o.start-a.start),e.edges=V1(r,!1),e}run(t){let e=t,n=e.locale||"en";return(this.container.get(`extract-regex-${n}`)||this).extract(e)}};oh.exports=zs});var Us=Q((lk,ah)=>{"use strict";var{defaultContainer:U1}=rt(),j1=mi(),{TrimType:Rt}=xo(),Vs=class{constructor(t=U1){this.container=t.container||t,this.name="extract-trim"}mustSkip(t,e){if(e.options&&e.options.skip&&e.options.skip.length>0)for(let n=0;n<e.options.skip.length;n+=1){let r=e.options.skip[n];if(e.options.caseSensitive){if(r===t)return!0}else if(r.toLowerCase()===t.toLowerCase())return!0}return!1}matchBetween(t,e,n){let r=[],o;do{let s=e.regex.exec(` ${t} `);if(s){let u,c,l;if(e&&e.options&&e.options.closest){if(u=1,!s[u]){o=!1;break}let f=s[0].indexOf(s[u]);c=s.index-1+f,l=c+s[u].length-1}else u=0,c=s.index-1,l=e.regex.lastIndex-2;r.push({type:"trim",subtype:Rt.Between,start:c,end:l,len:s[u].length,accuracy:1,sourceText:s[u],utteranceText:s[u],entity:n}),o=!0}else o=!1}while(o);let a=[];for(let s=0;s<r.length;s+=1)this.mustSkip(r[s].utteranceText,e)||a.push(r[s]);return a}findWord(t,e,n=!1,r=!1){let o=[],a,s=new RegExp(r?e:` ${e} | ${e}|${e} `,n?"g":"ig");do{let u=s.exec(t);u?(o.push({start:u.index,end:s.lastIndex}),a=!0):a=!1}while(a);return o}getBeforeResults(t,e,n){let r=[],o=0,a=0;for(let s=0;s<e.length;s+=1){a=e[s].start;let u=t.substring(o,a);r.push({type:"trim",subtype:Rt.Before,start:o,end:a-1,len:u.length,accuracy:.99,sourceText:u,utteranceText:u,entity:n}),o=e[s].end}return r}getBeforeFirstResults(t,e,n){let r=[],a=e[0].start,s=t.substring(0,a);return r.push({type:"trim",subtype:Rt.BeforeFirst,start:0,end:a-1,len:s.length,accuracy:.99,sourceText:s,utteranceText:s,entity:n}),r}getBeforeLastResults(t,e,n){let r=[],a=e[e.length-1].start,s=t.substring(0,a);return r.push({type:"trim",subtype:Rt.BeforeLast,start:0,end:a-1,len:s.length,accuracy:.99,sourceText:s,utteranceText:s,entity:n}),r}getAfterResults(t,e,n){let r=[],o=0,a=t.length;for(let s=e.length-1;s>=0;s-=1){o=e[s].end;let u=t.substring(o,a);r.unshift({type:"trim",subtype:Rt.After,start:o,end:a-1,len:u.length,accuracy:.99,sourceText:u,utteranceText:u,entity:n}),a=e[s].start}return r}getAfterFirstResults(t,e,n){let r=[],o=e[0].end,a=t.length,s=t.substring(o,a);return r.push({type:"trim",subtype:Rt.AfterFirst,start:o,end:a-1,len:s.length,accuracy:.99,sourceText:s,utteranceText:s,entity:n}),r}getAfterLastResults(t,e,n){let r=[],o=e[e.length-1].end,a=t.length,s=t.substring(o,a);return r.push({type:"trim",subtype:Rt.AfterLast,start:o,end:a-1,len:s.length,accuracy:.99,sourceText:s,utteranceText:s,entity:n}),r}getResults(t,e,n,r){switch(n){case Rt.Before:return this.getBeforeResults(t,e,r);case Rt.BeforeFirst:return this.getBeforeFirstResults(t,e,r);case Rt.BeforeLast:return this.getBeforeLastResults(t,e,r);case Rt.After:return this.getAfterResults(t,e,r);case Rt.AfterFirst:return this.getAfterFirstResults(t,e,r);case Rt.AfterLast:return this.getAfterLastResults(t,e,r);default:return[]}}match(t,e,n,r){let o=[];if(e&&Array.isArray(e.words))for(let s=0;s<e.words.length;s+=1){let u=e.options.noSpaces?e.words[s]:` ${e.words[s]}`,c=this.findWord(t,u);if(!e.options.noSpaces){let l=this.findWord(t,e.words[s]);l.length>0&&l[0].start===0&&c.unshift(l[0])}c.length>0&&o.push(...this.getResults(t,c,n,r))}let a=[];for(let s=0;s<o.length;s+=1)o[s].sourceText=o[s].sourceText.replace(/^[\s,.!?;:([\]'"¡¿)/]+|[\s,.!?;:([\]'"¡¿)/]+$/,""),this.mustSkip(o[s].utteranceText,e)||a.push(o[s]);return a}getRules(t){let e=t.nerRules;return e||[]}extractFromRule(t,e){let n=[];for(let r=0;r<e.rules.length;r+=1){let o=e.rules[r];o.type===Rt.Between?n.push(...this.matchBetween(t,o,e.name)):n.push(...this.match(t,o,o.type,e.name))}return n}extract(t){let e=t,n=this.getRules(e),r=e.edges||[];for(let o=0;o<n.length;o+=1){let a=this.extractFromRule(e.text||e.utterance,n[o]);for(let s=0;s<a.length;s+=1)r.push(a[s])}return r.sort((o,a)=>o.start-a.start),e.edges=j1(r,!1),e}run(t){let e=t,n=e.locale||"en";return(this.container.get(`extract-trim-${n}`)||this).extract(e)}};ah.exports=Vs});var Gs=Q((fk,sh)=>{"use strict";var{defaultContainer:G1}=rt(),H1=mi(),js=class{constructor(t=G1){this.container=t.container||t,this.name="extract-builtin"}extract(t){return t}run(t){return K(this,null,function*(){let e=t,n=e.locale||"en",o=yield(this.container.get(`extract-builtin-${n}`)||this).extract({text:e.text||e.utterance,locale:e.locale});if(e.edges=e.edges||[],o.edges)for(let a=0;a<o.edges.length;a+=1)(!e.nerLimitToEntities||e.intentEntities.includes(o.edges[a].entity))&&e.edges.push(o.edges[a]);if(e.edges=H1(e.edges,!1),e.sourceEntities=e.sourceEntities||[],o.sourceEntities)for(let a=0;a<o.sourceEntities.length;a+=1)e.sourceEntities.push(o.sourceEntities[a]);return e})}};sh.exports=js});var ch=Q((pk,uh)=>{"use strict";var{Clonable:K1}=rt(),X1=Ws(),$1=qs(),Y1=Us(),J1=Gs(),{TrimType:Ar}=xo();function Q1(i){return i!=null&&i.constructor===Object}var Hs=class i extends K1{constructor(t={},e=void 0){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.applySettings(this.settings),this.settings.tag||(this.settings.tag="ner"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.rules={},this.applySettings(this,{pipelineProcess:this.getPipeline(`${this.settings.tag}-process`)})}registerDefault(){}getRulesByName(t="*",e="",n=!1){if(!this.rules[t]){if(!n)return;this.rules[t]={}}if(!this.rules[t][e]){if(!n)return;this.rules[t][e]={name:e,type:"enum",rules:[]}}return this.rules[t][e]}addRule(t="*",e,n,r){if(Array.isArray(t))for(let o=0;o<t.length;o+=1)this.addRule(t[o],e,n,r);else this.rules[t]||(this.rules[t]={}),this.rules[t][e]||(this.rules[t][e]={name:e,type:n,rules:[]}),this.rules[t][e].rules.push(r)}asString(t){if(t){if(Q1(t))return JSON.stringify(t);if(t.toString)return t.toString()}return""}findRule(t,e){let n=this.asString(e);for(let r=0;r<t.length;r+=1)if(this.asString(t[r])===n)return r;return-1}removeRule(t="*",e,n){if(this.rules[t]&&this.rules[t][e])if(!n)delete this.rules[t][e];else{let r=this.findRule(this.rules[t][e].rules,n);r>-1&&this.rules[t][e].rules.splice(r,1)}}getRules(t="*"){let e=[];if(this.rules[t]){let n=Object.keys(this.rules[t]);for(let r=0;r<n.length;r+=1)e.push(this.rules[t][n[r]])}if(t!=="*"&&this.rules["*"]){let n=Object.keys(this.rules["*"]);for(let r=0;r<n.length;r+=1)e.push(this.rules["*"][n[r]])}return e}decideRules(t,e){let n=t,r=this.getRules(n.locale||"en");if(e&&this.settings.considerOnlyIntentEntities)r=r.filter(o=>e.includes(o.name));else if(e){let o=[],a=[];r.forEach(s=>{e.includes(s.name)?o.push(s):a.push(s)}),r=o.concat(a)}return n.nerRules=r,n.nerLimitToEntities=this.settings.considerOnlyIntentEntities,n.intentEntities=e,n}getRuleOption(t,e){for(let n=0;n<t.length;n+=1)if(t[n].option===e)return t[n]}addRuleOptionTexts(t,e,n,r){if(Array.isArray(t))for(let o=0;o<t.length;o+=1)this.addRuleOptionTexts(t[o],e,n,r);else{let o=r||n;Array.isArray(o)||(o=[o]);let a=this.getRulesByName(t,e,!0),s=this.getRuleOption(a.rules,n);if(!s)s={option:n,texts:o},a.rules.push(s);else{let u={};for(let c=0;c<s.texts.length;c+=1)u[s.texts[c]]=1;for(let c=0;c<o.length;c+=1)u[o[c]]=1;s.texts=Object.keys(u)}}}removeRuleOptionTexts(t,e,n,r){if(Array.isArray(t))for(let o=0;o<t.length;o+=1)this.removeRuleOptionTexts(t[o],e,n,r);else{let o=r||n;Array.isArray(o)||(o=[o]);let a=this.getRulesByName(t,e,!1);if(a){let s=this.getRuleOption(a.rules,n);if(s){let u={};for(let c=0;c<s.texts.length;c+=1)u[s.texts[c]]=1;for(let c=0;c<o.length;c+=1)delete u[o[c]];s.texts=Object.keys(u)}}}}static str2regex(t){let e=t.lastIndexOf("/");return new RegExp(t.slice(1,e),t.slice(e+1))}static regex2str(t){return t.toString()}addRegexRule(t,e,n){let r=typeof n=="string"?i.str2regex(n):n,o="g",a=r.flags.includes(o)?r:new RegExp(r.source,`${r.flags}${o}`);this.addRule(t,e,"regex",a)}addBetweenLastCondition(t,e,n,r,o={}){let a=wn(ve({},o),{closest:!0});this.addBetweenCondition(t,e,n,r,a)}addBetweenCondition(t,e,n,r,o){let a=o||{},s=Array.isArray(n)?n:[n],u=Array.isArray(r)?r:[r],c=[];for(let h=0;h<s.length;h+=1)for(let p=0;p<u.length;p+=1){let d=a.noSpaces===!0?s[h]:` ${s[h]} `,m=a.noSpaces===!0?u[p]:` ${u[p]} `,v;a.closest===!0?v=`${d}(?!.*${d}.*)(.*)${m}`:v=`(?<=${d})(.*)(?=${m})`,c.push(v)}let l=`/${c.join("|")}/g`;a.caseSensitive!==!0&&(l+="i");let f={type:"between",leftWords:s,rightWords:u,regex:i.str2regex(l),options:a};this.addRule(t,e,"trim",f)}addPositionCondition(t,e,n,r,o){let a=o||{},s=Array.isArray(r)?r:[r],u={type:n,words:s,options:a};this.addRule(t,e,"trim",u)}addAfterCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.After,n,r)}addAfterFirstCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.AfterFirst,n,r)}addAfterLastCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.AfterLast,n,r)}addBeforeCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.Before,n,r)}addBeforeFirstCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.BeforeFirst,n,r)}addBeforeLastCondition(t,e,n,r){this.addPositionCondition(t,e,Ar.BeforeLast,n,r)}reduceEdges(t){return t.entities=t.edges,delete t.edges,delete t.nerRules,delete t.nerLimitToEntities,delete t.intentEntities,t}defaultPipelineProcess(t,e){return K(this,null,function*(){this.cache||(this.cache={extractEnum:this.container.get("extract-enum"),extractRegex:this.container.get("extract-regex"),extractTrim:this.container.get("extract-trim"),extractBuiltin:this.container.get("extract-builtin")},this.cache.extractEnum||(this.container.use(X1),this.cache.extractEnum=this.container.get("extract-enum")),this.cache.extractRegex||(this.container.use($1),this.cache.extractRegex=this.container.get("extract-regex")),this.cache.extractTrim||(this.container.use(Y1),this.cache.extractTrim=this.container.get("extract-trim")),this.cache.extractBuiltin||(this.container.use(J1),this.cache.extractBuiltin=this.container.get("extract-builtin")));let n=yield this.decideRules(t,e);return this.cache.extractEnum&&(n=yield this.cache.extractEnum.run(n)),this.cache.extractRegex&&(n=yield this.cache.extractRegex.run(n)),this.cache.extractTrim&&(n=yield this.cache.extractTrim.run(n)),this.cache.extractBuiltin&&(n=yield this.cache.extractBuiltin.run(n)),n=yield this.reduceEdges(n),n})}process(t,e){return K(this,null,function*(){let n=ve({threshold:this.settings.threshold||.8},t),r;if(n.locale){let o=this.container.getPipeline(`${this.settings.tag}-${n.locale}-process`);o&&(r=yield this.runPipeline(n,o))}else this.pipelineProcess&&(r=yield this.runPipeline(n,this.pipelineProcess));return r?e&&(r.entities=r.entities.filter(o=>e.includes(o.entity))):r=yield this.defaultPipelineProcess(n,e),delete r.threshold,r})}nameToEntity(t){let e=this.settings.entityPreffix===void 0?"@":this.settings.entityPreffix,n=this.settings.entitySuffix===void 0?"":this.settings.entitySuffix;return`${e}${t}${n}`}entityToName(t){if(!t)return t;let e=t,n=this.settings.entityPreffix===void 0?"@":this.settings.entityPreffix,r=this.settings.entitySuffix===void 0?"":this.settings.entitySuffix;if(n){if(!e.startsWith(n))return t;e=e.slice(n.length)}if(r){if(!e.endsWith(r))return t;e=e.slice(0,-r.length)}return e}isEntity(t){return this.entityToName(t)!==t}getEntitiesFromUtterance(t,e){e||(e=t,t="es");let n=e.split(/[\s,.!?;:([\]'"¡¿)/]+/).filter(o=>o),r=[];for(let o=0;o<n.length;o+=1){let a=n[o];this.isEntity(a)&&r.push(this.entityToName(a))}return r}generateEntityUtterance(t,e){return K(this,null,function*(){let n={locale:t,utterance:e};n=yield this.process(n);let{entities:r}=n;if(!r||!r.length)return e;r.sort((u,c)=>u.start-c.start);let o=0,a="";for(let u=0;u<r.length;u+=1){let c=r[u],l=e.slice(o,c.start);o=c.end+1,a+=l,a+=this.nameToEntity(c.entity)}let s=e.slice(r[r.length-1].end+1);return a+=s,a})}toJSON(){RegExp.prototype.toJSON=RegExp.prototype.toString;let t={settings:ve({},this.settings),rules:ve({},this.rules)};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),Object.keys(t.rules).forEach(n=>{Object.keys(t.rules[n]).forEach(o=>{t.rules[n][o].rules=t.rules[n][o].type==="regex"?t.rules[n][o].rules.map(a=>i.str2regex(a)):t.rules[n][o].rules.map(a=>typeof a.regex=="string"?wn(ve({},a),{regex:i.str2regex(a.regex)}):a)})}),this.rules=t.rules}};uh.exports=Hs});var fh=Q((mk,lh)=>{"use strict";var Z1=ch(),ey=Ws(),ty=qs(),ny=Us(),ry=Gs();lh.exports={Ner:Z1,ExtractorEnum:ey,ExtractorRegex:ty,ExtractorTrim:ny,ExtractorBuiltin:ry}});var ph=Q((vk,hh)=>{"use strict";var{Clonable:iy}=rt(),Ks=class extends iy{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlg-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.responses={},this.applySettings(this,{pipelineFind:this.getPipeline(`${this.settings.tag}-find`)})}registerDefault(){this.container.registerConfiguration("nlg-manager",{},!1)}findAllAnswers(t){let e=t;return this.responses[e.locale]?e.answers=this.responses[e.locale][e.intent]||[]:e.answers=[],e}filterAnswers(t){let e=t,{answers:n}=e;if(n&&n.length){let r=this.container.get("Evaluator");if(r){let o=e.context||{},a=[];for(let s=0;s<n.length;s+=1){let u=n[s];if(u.opts){let c=typeof u.opts=="string"?u.opts:u.opts.condition;c?r.evaluate(c,o)===!0&&a.push(u):a.push(u)}else a.push(u)}e.answers=a}}return e}chooseRandom(t){let e=t,{answers:n}=e;return n&&n.length&&(e.answer=n[Math.floor(Math.random()*n.length)].answer),e}renderText(t,e){if(!t)return t;let n=t.answer||t,r;do{let a=/\((?:[^()]+)\|(?:[^()]+)\)/g.exec(n);if(a){for(let s=0;s<a.length;s+=1){let u=a[s],c=u.substring(1,u.length-1).split("|");n=n.replace(u,c[Math.floor(Math.random()*c.length)])}r=!0}else r=!1}while(r);t.answer?t.answer=n:t=n;let o=this.container.get("Template");return o&&e?o.compile(t,e):t}renderRandom(t){let e=t,{answers:n,context:r}=e;for(let o=0;o<n.length;o+=1)n[o]=this.renderText(n[o],r);return e}indexOfAnswer(t,e,n,r){if(!this.responses[t]||!this.responses[t][e])return-1;let o=this.responses[t][e];for(let a=0;a<o.length;a+=1){let s=o[a];if(s.answer===n&&JSON.stringify(s.opts)===JSON.stringify(r))return a}return-1}add(t,e,n,r){let o=this.indexOfAnswer(t,e,n,r);if(o!==-1)return this.responses[t][e][o];this.responses[t]||(this.responses[t]={}),this.responses[t][e]||(this.responses[t][e]=[]);let a={answer:n,opts:r};return this.responses[t][e].push(a),a}remove(t,e,n,r){let o=this.indexOfAnswer(t,e,n,r);o!==-1&&this.responses[t][e].splice(o,1)}defaultPipelineFind(t){let e=this.findAllAnswers(t);return e=this.filterAnswers(e),e=this.renderRandom(e),e=this.chooseRandom(e),e}find(t,e,n,r){let o={locale:t,intent:e,context:n,settings:r||this.settings};return this.pipelineFind?this.runPipeline(o,this.pipelineFind):this.defaultPipelineFind(o)}run(t,e){return this.find(t.locale,t.intent,t.context,e)}toJSON(){let t={settings:ve({},this.settings),responses:this.responses};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.responses=t.responses}};hh.exports=Ks});var mh=Q((yk,dh)=>{"use strict";var{Clonable:oy}=rt(),Xs=class extends oy{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="action-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.actions={},this.actionsMap={},this.applySettings(this,{pipelineFind:this.getPipeline(`${this.settings.tag}-find`)})}registerDefault(){}posAction(t,e,n){if(!this.actions[t])return-1;let r=this.actions[t];for(let o=0;o<r.length;o+=1)if(r[o].action===e&&JSON.stringify(r[o].parameters)===JSON.stringify(n))return o;return-1}findActions(t){return(this.actions[t]||[]).map(n=>wn(ve({},n),{fn:this.actionsMap[n.action]}))}processActions(t,e){return K(this,null,function*(){let n=this.findActions(t);e&&typeof e=="object"&&(e.actions=n.map(o=>({action:o.action,parameters:o.parameters})));let r=e;for(let{fn:o,parameters:a}of n)if(o){let s=yield o(r,...a||[]);s&&(typeof r=="object"?typeof s=="object"?r=s:r.answer=s:r=s)}return r})}addAction(t,e,n,r){this.posAction(t,e,n)===-1&&(this.actions[t]||(this.actions[t]=[]),this.actions[t].push({action:e,parameters:n}),r&&(this.actionsMap[e]=r))}removeAction(t,e,n){let r=this.posAction(t,e,n);r>-1&&this.actions[t].splice(r,1)}removeActions(t){delete this.actions[t]}registerActionInMap(t,e){this.actionsMap[t]=e}removeActionFromMap(t){delete this.actionsMap[t]}run(t,e){let n=t;return n.settings=n.settings||e||this.settings,this.processActions(t.intent,n)}toJSON(){let t={settings:ve({},this.settings),actions:this.actions};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.actions=t.actions}};dh.exports=Xs});var gh=Q((bk,vh)=>{"use strict";var ay=ph(),sy=mh();vh.exports={NlgManager:ay,ActionManager:sy}});var xh=Q((wk,yh)=>{"use strict";var{Clonable:uy}=rt(),$s=class extends uy{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="sentiment-analyzer"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.applySettings(this,{pipelinePrepare:this.getPipeline(`${this.settings.tag}-prepare`),pipelineProcess:this.getPipeline(`${this.settings.tag}-process`)})}registerDefault(){this.container.registerConfiguration("sentiment-analyzer",{},!1)}prepare(t,e,n,r){let o=this.getPipeline(`${this.settings.tag}-prepare`);if(o){let u={text:e,locale:t,settings:n||this.settings};return this.runPipeline(u,o)}if(r){let u=this.container.get(`stemmer-${t}`)||this.container.get("stemmer-en");if(u)return u.tokenizeAndStem(e)}let a=this.container.get(`tokenizer-${t}`)||this.container.get("tokenizer-en");return a?a.tokenize(e,!0):e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().split(/[\s,.!?;:([\]'"¡¿)/]+/).filter(u=>u)}getDictionary(t){return K(this,null,function*(){let e=t,n=this.container.get(`sentiment-${e.locale}`),r;return n&&(n.senticon?r="senticon":n.pattern?r="pattern":n.afinn&&(r="afinn")),r?(e.sentimentDictionary={type:r,dictionary:n[r],negations:n.negations.words,stemmed:n.stemmed===void 0?!1:n.stemmed},e):(e.sentimentDictionary={type:r,dictionary:void 0,negations:[],stemmed:!1},e)})}getTokens(t){return K(this,null,function*(){let e=t;return!e.tokens&&e.sentimentDictionary.type&&(e.tokens=yield this.prepare(e.locale,e.utterance||e.text,e.settings,e.sentimentDictionary.stemmed)),e})}calculate(t){let e=t;if(e.sentimentDictionary.type){let n=Array.isArray(e.tokens)?e.tokens:Object.keys(e.tokens);if(!e.sentimentDictionary.dictionary)e.sentiment={score:0,numWords:n.length,numHits:0,average:0,type:e.sentimentDictionary.type,locale:e.locale};else{let{dictionary:r}=e.sentimentDictionary,{negations:o}=e.sentimentDictionary,a=0,s=1,u=0;for(let c=0;c<n.length;c+=1){let l=n[c].toLowerCase();o.indexOf(l)!==-1?(s=-1,u+=1):r[l]!==void 0&&(a+=s*r[l],u+=1)}e.sentiment={score:a,numWords:n.length,numHits:u,average:a/n.length,type:e.sentimentDictionary.type,locale:e.locale}}}else e.sentiment={score:0,numWords:0,numHits:0,average:0,type:e.sentimentDictionary.type,locale:e.locale};return e.sentiment.score>0?e.sentiment.vote="positive":e.sentiment.score<0?e.sentiment.vote="negative":e.sentiment.vote="neutral",e}defaultPipelineProcess(t){return K(this,null,function*(){let e=yield this.getDictionary(t);return e=yield this.getTokens(e),e=yield this.calculate(e),delete e.sentimentDictionary,e})}process(t,e){let n=t;return n.settings=n.settings||e||this.settings,this.pipelineProcess?this.runPipeline(n,this.pipelineProcess):this.defaultPipelineProcess(n)}};yh.exports=$s});var wh=Q((_k,bh)=>{"use strict";var cy=xh();bh.exports={SentimentAnalyzer:cy}});var _h=Q((Ek,Ch)=>{"use strict";var Ys=class{constructor(){this.intents={},this.isEmpty=!0}getSlot(t,e){if(this.intents[t])return this.intents[t][e]}existsSlot(t,e){return this.getSlot(t,e)!==void 0}addSlot(t,e,n=!1,r){return this.isEmpty=!1,this.intents[t]||(this.intents[t]={}),this.intents[t][e]={intent:t,entity:e,mandatory:n,locales:r||{}},this.intents[t][e]}updateSlot(t,e,n,r){if(!this.intents[t]||!this.intents[t][e])return this.addSlot(t,e,n,r);let o=this.intents[t][e];return n!==void 0&&(o.mandatory=n),o.locales=Object.assign(o.locales,r),this.intents[t][e]}removeSlot(t,e){this.intents[t]&&delete this.intents[t][e]}addBatch(t,e){let n=[];return e&&e.length>0&&e.forEach(r=>{let o=this.getSlot(t,r);o||(o=this.addSlot(t,r)),n.push(o)}),n}getIntentEntityNames(t){if(this.intents[t])return Object.keys(this.intents[t])}hasIntentEntities(t){return this.getIntentEntityNames(t).length>0}clear(){this.intents={}}load(t){this.intents=t||{},this.isEmpty=Object.keys(this.intents).length===0}save(){return this.intents}getMandatorySlots(t){let e={},n=this.intents[t];if(n){let r=Object.keys(n);for(let o=0,a=r.length;o<a;o+=1){let s=n[r[o]];s.mandatory&&(e[s.entity]=s)}}return e}cleanContextEntities(t,e){let n=e;if(n.slotFill)return;let r=this.getMandatorySlots(t),o=Object.keys(r);o.length!==0&&o.forEach(a=>{delete n[a]})}generateEntityAliases(t){let e=[],n={};for(let r=0;r<t.length;r+=1){let o=t[r];n[o.entity]||(n[o.entity]=[]),e[r]=`${o.entity}_${n[o.entity].length}`,n[o.entity].push(!0)}return e}process(t,e){let n=t,r=e;if(this.cleanContextEntities(n.intent,r),r.slotFill&&(n.intent=r.slotFill.intent,n.answer=r.slotFill.answer,n.srcAnswer=r.slotFill.srcAnswer),!n.intent||n.intent==="None")return!1;r.slotFill&&r.slotFill.intent===n.intent&&(n.entities=[...r.slotFill.entities,...n.entities]);let o=this.getMandatorySlots(n.intent),a=Object.keys(o);if(a.length===0)return!1;let s=this.generateEntityAliases(n.entities);for(let c=0,l=n.entities.length;c<l;c+=1){let f=n.entities[c];delete o[f.entity],delete o[s[c]]}if(r.slotFill&&o[r.slotFill.currentSlot]&&(n.entities.push({entity:r.slotFill.currentSlot,utteranceText:n.utterance,sourceText:n.utterance,accuracy:.95,start:0,end:n.utterance.length-1,len:n.utterance.length,isSlotFillingFallback:!0}),delete o[r.slotFill.currentSlot]),a=Object.keys(o),r.slotFill&&r.slotFill.currentSlot&&(r.slotFill.latestSlot=r.slotFill.currentSlot),!a||a.length===0)return delete n.srcAnswer,!0;r.slotFill&&r.slotFill.intent===n.intent&&(n.localeIso2=r.slotFill.localeIso2),n.slotFill={localeIso2:n.localeIso2,intent:n.intent,entities:n.entities,answer:n.answer,srcAnswer:n.srcAnswer},r.slotFill&&r.slotFill.latestSlot&&(n.slotFill.latestSlot=r.slotFill.latestSlot);let u=o[a[0]];return n.slotFill.currentSlot=u.entity,n.srcAnswer=u.locales[n.localeIso2],r.slotFill=n.slotFill,!0}};Ch.exports=Ys});var kh=Q((kk,Eh)=>{"use strict";var ly=_h();Eh.exports={SlotManager:ly}});var Qs=Q((Dk,Dh)=>{"use strict";var{Clonable:fy}=rt(),hy="_data",Js=class extends fy{constructor(t={},e){super({settings:{},container:t.container||e},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="context-manager"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.contextDictionary={},this.defaultData={}}registerDefault(){this.container.registerConfiguration("context-manager",{tableName:"context"})}getInputContextId(t){return K(this,null,function*(){let e;return this.onGetInputContextId&&(e=yield this.onGetInputContextId(t)),!e&&t&&t.activity&&(t.activity.address&&t.activity.address.conversation?e=t.activity.address.conversation.id:t.activity.conversation&&(e=t.activity.conversation.id)),e})}getContext(t){return K(this,null,function*(){let e=yield this.getInputContextId(t),n;if(e){if(this.settings.tableName){let r=this.container?this.container.get("database"):void 0;r&&(n=(yield r.findOne(this.settings.tableName,{conversationId:e}))||{conversationId:e})}n||(n=this.contextDictionary[e]||{conversationId:e})}else n={};return n[hy]=this.defaultData,n})}setContext(t,e){return K(this,null,function*(){let n=this.container.get("logger"),r=yield this.getInputContextId(t);if(r){if(!e.id){let s=yield this.getContext(t);s&&(e.id=s.id)}let o=Object.keys(e),a={conversationId:r};for(let s=0;s<o.length;s+=1){let u=o[s];u.startsWith("_")||(a[u]=e[u])}if(this.settings.tableName){let s=this.container?this.container.get("database"):void 0;s?yield s.save(this.settings.tableName,a):this.contextDictionary[r]=a}else this.contextDictionary[r]=a;this.onCtxUpdate&&(n.debug("emmitting event onCtxUpdate..."),yield this.onCtxUpdate(a))}})}resetConversations(){return K(this,null,function*(){for(let t of Object.keys(this.contextDictionary))yield this.resetConversation(t)})}resetConversation(t){return K(this,null,function*(){this.container.get("logger").debug(`resetting context in conversation: ${t}`);let n=this.contextDictionary[t];Object.keys(n).forEach(r=>{delete n[r]}),this.contextDictionary[t].dialogStack=[],this.contextDictionary[t].variableName=void 0})}};Dh.exports=Js});var Ah=Q((Ak,Sh)=>{"use strict";var{Clonable:py,containerBootstrap:dy}=rt(),{NluManager:my,NluNeural:vy}=eh(),{Ner:gy,ExtractorEnum:yy,ExtractorRegex:xy,ExtractorTrim:by,ExtractorBuiltin:wy}=fh(),{ActionManager:Cy,NlgManager:_y}=gh(),{SentimentAnalyzer:Ey}=wh(),{SlotManager:ky}=kh(),Dy=Qs(),Zs=class extends py{constructor(t={},e){super({settings:{},container:t.container||e||dy()},e),this.applySettings(this.settings,t),this.settings.tag||(this.settings.tag="nlp"),this.registerDefault(),this.applySettings(this.settings,this.container.getConfiguration(this.settings.tag)),this.nluManager=this.container.get("nlu-manager",this.settings.nlu),this.ner=this.container.get("ner",this.settings.ner),this.nlgManager=this.container.get("nlg-manager",this.settings.nlg),this.actionManager=this.container.get("action-manager",this.settings.action),this.sentiment=this.container.get("sentiment-analyzer",this.settings.sentiment),this.slotManager=this.container.get("SlotManager",this.settings.slot),this.contextManager=this.container.get("context-manager",this.settings.context),this.forceNER=this.settings.forceNER,this.forceNER===void 0&&(this.forceNER=!1),this.initialize()}registerDefault(){this.container.registerConfiguration("nlp",{threshold:.5,autoLoad:!0,autoSave:!0,modelFileName:"model.nlp",executeActionsBeforeAnswers:!1},!1),this.use(my),this.use(gy),this.use(yy),this.use(xy),this.use(by),this.use(wy),this.use(_y),this.use(Cy),this.use(vy),this.use(Ey),this.use(Dy),this.container.register("SlotManager",ky,!1)}initialize(){if(this.settings.nlu){let t=Object.keys(this.settings.nlu);for(let e=0;e<t.length;e+=1){let n=t[e],r=Object.keys(this.settings.nlu[n]);for(let o=0;o<r.length;o+=1){let a=r[o],s=this.settings.nlu[n][a],{className:u}=s;delete s.className,this.useNlu(u,n,a,s)}}}this.settings.languages&&this.addLanguage(this.settings.languages),this.settings.locales&&this.addLanguage(this.settings.locales),this.settings.calculateSentiment===void 0&&(this.settings.calculateSentiment=!0),this.settings.executeActionsBeforeAnswers===void 0&&(this.settings.executeActionsBeforeAnswers=!1)}start(){return K(this,null,function*(){this.settings.corpora&&(yield this.addCorpora(this.settings.corpora))})}loadOrTrain(){return K(this,null,function*(){let t=!1;this.settings.autoLoad&&(t=yield this.load(this.settings.modelFileName)),t||(yield this.train())})}useNlu(t,e,n,r){if(e||(e="??"),Array.isArray(e))for(let o=0;o<e.length;o+=1)this.useNlu(t,e[o],n,r);else{let o=typeof t=="string"?t:this.container.use(t),a=this.container.getConfiguration(`domain-manager-${e}`);a||(a={},this.container.registerConfiguration(`domain-manager-${e}`,a)),a.nluByDomain||(a.nluByDomain={});let s=!n||n==="*"?"default":n;a.nluByDomain[s]||(a.nluByDomain[s]={}),a.nluByDomain[s].className=o,a.nluByDomain[s].settings=r}}guessLanguage(t){return this.nluManager.guessLanguage(t)}addLanguage(t){return this.nluManager.addLanguage(t)}removeLanguage(t){return this.nluManager.removeLanguage(t)}addAdditionalEnumEntityUtterances(){this.settings.languages&&this.settings.languages.forEach(t=>{let e={};this.ner.getRules(t).forEach(a=>{if(a.type==="enum"){let s=this.ner.nameToEntity(a.name);e[s]=e[s]||[],a.rules.forEach(u=>{e[s]=e[s].concat(u.texts)})}});let r=this.nluManager.consolidateManager(t);r.getSentences().forEach(a=>{let s=this.ner.getEntitiesFromUtterance(t,a.utterance).map(u=>this.ner.nameToEntity(u));this.replaceEnumEntitiesInSentence(r,t,a.domain,a.utterance,a.intent,s,e)})})}replaceEnumEntitiesInSentence(t,e,n,r,o,a,s){if(!a.length){this.nluManager.guesser.addExtraSentence(e,r),t.add(n,r,o);return}let u=a[0];s[u]&&s[u].length?s[u].forEach(c=>{let l=r.replace(u,c);this.replaceEnumEntitiesInSentence(t,e,n,l,o,a.slice(1),s)}):this.replaceEnumEntitiesInSentence(t,e,n,r,o,a.slice(1),s)}addDocument(t,e,n){let r=this.ner.getEntitiesFromUtterance(e);return this.slotManager.addBatch(n,r),this.nluManager.add(t,e,n)}removeDocument(t,e,n){return this.nluManager.remove(t,e,n)}getRulesByName(t,e){return this.ner.getRulesByName(t,e)}addNerRule(t,e,n,r){return this.ner.addRule(t,e,n,r)}removeNerRule(t,e,n){return this.ner.removeRule(t,e,n)}addNerRuleOptionTexts(t,e,n,r){return this.ner.addRuleOptionTexts(t,e,n,r)}removeNerRuleOptionTexts(t,e,n,r){return this.ner.removeRuleOptionTexts(t,e,n,r)}addNerRegexRule(t,e,n){return this.ner.addRegexRule(t,e,n)}addNerBetweenCondition(t,e,n,r,o){return this.ner.addBetweenCondition(t,e,n,r,o)}addNerBetweenLastCondition(t,e,n,r,o){return this.ner.addBetweenLastCondition(t,e,n,r,o)}addNerPositionCondition(t,e,n,r,o){return this.ner.addPositionCondition(t,e,n,r,o)}addNerAfterCondition(t,e,n,r){return this.ner.addAfterCondition(t,e,n,r)}addNerAfterFirstCondition(t,e,n,r){return this.ner.addAfterFirstCondition(t,e,n,r)}addNerAfterLastCondition(t,e,n,r){return this.ner.addAfterLastCondition(t,e,n,r)}addNerBeforeCondition(t,e,n,r){return this.ner.addBeforeCondition(t,e,n,r)}addNerBeforeFirstCondition(t,e,n,r){return this.ner.addBeforeFirstCondition(t,e,n,r)}addNerBeforeLastCondition(t,e,n,r){return this.ner.addBeforeLastCondition(t,e,n,r)}assignDomain(t,e,n){return this.nluManager.assignDomain(t,e,n)}getIntentDomain(t,e){return this.nluManager.getIntentDomain(t,e)}getDomains(){return this.nluManager.getDomains()}addAction(t,e,n,r){return this.actionManager.addAction(t,e,n,r)}registerActionFunction(t,e){return this.actionManager.registerActionInMap(t,e)}getActions(t){return this.actionManager.findActions(t)}removeAction(t,e,n){return this.actionManager.removeAction(t,e,n)}removeActions(t){return this.actionManager.removeActions(t)}removeActionFunction(t){return this.actionManager.removeActionFromMap(t)}addAnswer(t,e,n,r){return this.nlgManager.add(t,e,n,r)}removeAnswer(t,e,n,r){return this.nlgManager.remove(t,e,n,r)}findAllAnswers(t,e){return this.nlgManager.findAllAnswers({locale:t,intent:e}).answers}addCorpora(t){return K(this,null,function*(){if(t)if(Array.isArray(t))for(let e=0;e<t.length;e+=1)yield this.addCorpus(t[e]);else yield this.addCorpus(t)})}addImported(t){return K(this,null,function*(){let e;if(t.content)e=t.content;else if(t.filename){if(e=yield this.container.get("fs").readFile(t.filename),!e)throw new Error(`Corpus not found "${t.filename}"`)}else throw new Error("Corpus information without content or file name");let n=this.container.get(t.importer);if(n||(n=this.container.get(`${t.importer}-importer`)),!n)throw new Error(`Corpus importer not found: ${t.importer}`);let r=n.transform(e,t);for(let o=0;o<r.length;o+=1)this.addCorpus(r[o])})}addEntities(t,e){let n=Object.keys(t);for(let r=0;r<n.length;r+=1){let o=n[r],a=t[o];typeof a=="string"&&(a={regex:[a]});let s=a.locale;if(s||(s=e||"en"),typeof s=="string"&&(s=s.slice(0,2)),a.options){let u=Object.keys(a.options);for(let c=0;c<u.length;c+=1)this.addNerRuleOptionTexts(s,o,u[c],a.options[u[c]])}if(a.regex)if(Array.isArray(a.regex))for(let u=0;u<a.regex.length;u+=1)this.addNerRegexRule(s,o,a.regex[u]);else typeof a.regex=="string"&&a.regex.trim()&&this.addNerRegexRule(s,o,a.regex);if(a.trim)for(let u=0;u<a.trim.length;u+=1)switch(a.trim[u].position){case"after":case"afterLast":case"afterFirst":case"before":case"beforeFirst":case"beforeLast":this.addNerPositionCondition(s,o,a.trim[u].position,a.trim[u].words,a.trim[u].opts);break;case"between":this.addNerBetweenCondition(s,o,a.trim[u].leftWords,a.trim[u].rightWords,a.trim[u].opts);break;case"betweenLast":this.addNerBetweenLastCondition(s,o,a.trim[u].leftWords,a.trim[u].rightWords,a.trim[u].opts);break;default:break}}}addData(t,e,n){for(let r=0;r<t.length;r+=1){let o=t[r],{intent:a,utterances:s,answers:u,slotFilling:c,actions:l}=o;for(let f=0;f<s.length;f+=1)n&&this.assignDomain(e,a,n.name),this.addDocument(e,s[f],a);if(u)for(let f=0;f<u.length;f+=1){let h=u[f];typeof h=="string"?this.addAnswer(e,a,h):this.addAnswer(e,a,h.answer,h.opts)}if(c){let f=Object.keys(c);for(let h=0;h<f.length;h+=1){let p=c[f[h]],d,m={};typeof p=="string"?(m[e]=p,d=!0):(m[e]=p.question,d=p.mandatory||!1),this.slotManager.updateSlot(a,f[h],d,m)}}l&&l.forEach(f=>{if(f)if(typeof f=="object"){if(!f.name)return;this.addAction(a,f.name,f.parameters||[])}else this.addAction(a,f,[])})}}addCorpus(t){return K(this,null,function*(){if(t.importer)yield this.addImported(t);else{let e=t,n=this.container.get("fs");if(typeof t=="string"){let r=yield n.readFile(t);if(!r)throw new Error(`Corpus not found "${t}"`);e=typeof r=="string"?JSON.parse(r):r}if(e.contextData){let{contextData:r}=e;typeof e.contextData=="string"&&(r=JSON.parse(yield n.readFile(e.contextData)));let o=this.container.get("context-manager"),a=Object.keys(r);for(let s=0;s<a.length;s+=1)o.defaultData[a[s]]=r[a[s]]}if(e.domains){e.entities&&this.addEntities(e.entities);for(let r=0;r<e.domains.length;r+=1){let o=e.domains[r],{data:a,entities:s}=o,u=o.locale.slice(0,2);this.addLanguage(u),s&&this.addEntities(s,u),this.addData(a,u,o)}}else{let r=e.locale.slice(0,2);this.addLanguage(r);let{data:o,entities:a}=e;a&&this.addEntities(a,r),this.addData(o,r)}}})}getSentiment(t,e){return typeof t=="object"?this.sentiment.process(t):(e||(e=t,t=this.guessLanguage(e)),this.sentiment.process({utterance:e,locale:t}))}describeLanguage(t,e){this.nluManager.describeLanguage(t,e)}train(){return K(this,null,function*(){this.nluManager.addLanguage(this.settings.languages);let t=yield this.nluManager.train();return this.settings.autoSave&&(yield this.save(this.settings.modelFileName,!0)),t})}classify(t,e,n){return K(this,null,function*(){return this.nluManager.process(t,e,n||this.settings.nlu)})}extractEntities(t,e,n,r){return K(this,null,function*(){return typeof t=="object"?this.ner.process(t):(e||(e=t,t=void 0),t||(t=this.guessLanguage(e)),yield this.ner.process({locale:t,utterance:e,context:n,settings:this.applySettings(r,this.settings.ner)}))})}organizeEntities(t){let e={};for(let r=0;r<t.length;r+=1){let o=t[r];e[o.entity]||(e[o.entity]=[]),e[o.entity].push(o)}let n=[];return Object.keys(e).forEach(r=>{let o=e[r];if(o.length===1)n.push(o[0]);else{for(let a=0;a<o.length;a+=1)o[a].alias=`${r}_${a}`;n.push({entity:r,isList:!0,items:o})}}),n}structureEntities(t){let e=this.organizeEntities(t.entities);t.context.entities||(t.context.entities={});for(let n=0;n<e.length;n+=1){let r=e[n];if(t.context.entities[r.entity]=r,r.alias&&(t.context[r.alias]=r.sourceText),r.isList)for(let o=0;o<r.items.length;o+=1)t.context[r.items[o].alias]=r.items[o].sourceText;else t.context[`${r.entity}_0`]=r.sourceText;t.context[r.entity]=r.isList?r.items[0].sourceText:r.sourceText}return t}process(t,e,n,r){return K(this,null,function*(){let o,a=n;typeof t=="object"&&(typeof e=="object"&&e.value?(t=void 0,e=e.value):o=t),o?(t=o.locale,e=o.utterance||o.message||o.text):(e||(e=t,t=void 0),t||(t=this.guessLanguage(e)),o={locale:t,utterance:e,settings:r},r&&(r.activity&&!o.activity&&(o.activity=r.activity),r.conversationId&&!o.activity&&(o.activity={conversation:{id:r.conversationId}}))),a||(a=yield this.contextManager.getContext(o)),a.channel=o.channel,a.app=o.app,a.from=o.from||null;let s={locale:t,utterance:e,context:a,settings:this.applySettings(r,this.settings.nlu)},u=s.settings&&"forceNER"in s.settings?s.settings.forceNER:this.forceNER,c=yield this.nluManager.process(s);if(u||!this.slotManager.isEmpty){let h=yield this.ner.generateEntityUtterance(c.locale||t,e);if(h&&h!==e){let p={locale:c.locale||t,utterance:h,context:a,settings:this.applySettings(r,this.settings.nlu)},d=yield this.nluManager.process(p);d&&(d.score>c.score||c.intent==="None")&&(c=d,c.utterance=e,c.optionalUtterance=h)}}if(c.score<this.settings.threshold&&(c.score=1,c.intent="None"),c.context=a,u||!this.slotManager.isEmpty){let h=this.slotManager.getIntentEntityNames(c.intent);c=yield this.ner.process(ve({},c),h)}else c.entities=[],c.sourceEntities=[];let l=this.container.get(`stemmer-${c.locale}`);if(l&&l.lastFill&&l.lastFill(c),c=this.structureEntities(c),(u||!this.slotManager.isEmpty)&&(this.slotManager.process(c,a)&&(c=this.structureEntities(c)),a.slotFill=c.slotFill),this.settings.executeActionsBeforeAnswers&&(c=yield this.actionManager.run(ve({},c))),this.settings.executeActionsBeforeAnswers&&c.answer)c.answer=this.nlgManager.renderText(c.answer,a);else{let h=yield this.nlgManager.run(ve({},c));c.answers=h.answers,c.answer=h.answer}if(c.srcAnswer&&(c.answer=this.nlgManager.renderText(c.srcAnswer,a)),this.settings.executeActionsBeforeAnswers||(c=yield this.actionManager.run(ve({},c))),this.settings.calculateSentiment){let h=yield this.getSentiment(t,e);c.sentiment=h?h.sentiment:void 0}yield this.contextManager.setContext(o,a),delete c.context,delete c.settings;let f=o?this.applySettings(o,c):c;if(f.intent==="None"&&!f.answer){let h=this.container.get("open-question");if(h){let p=yield h.getAnswer(f.locale,f.utterance);p&&p.answer&&p.answer.length>0&&(f.answer=p.answer,f.isOpenQuestionAnswer=!0,f.openQuestionFirstCharacter=p.position,f.openQuestionScore=p.score)}}if(this.onIntent)yield this.onIntent(this,f);else{let h=`onIntent(${f.intent})`,p=this.container.getPipeline(h);p&&(yield this.container.runPipeline(p,f,this))}return f})}toJSON(){let t={settings:ve({},this.settings),nluManager:this.nluManager.toJSON(),ner:this.ner.toJSON(),nlgManager:this.nlgManager.toJSON(),actionManager:this.actionManager.toJSON(),slotManager:this.slotManager.save()};return delete t.settings.container,t}fromJSON(t){this.applySettings(this.settings,t.settings),this.nluManager.fromJSON(t.nluManager),this.ner.fromJSON(t.ner),this.nlgManager.fromJSON(t.nlgManager),this.actionManager.fromJSON(t.actionManager),this.slotManager.load(t.slotManager)}export(t=!1){let e=this.toJSON();return t?JSON.stringify(e):JSON.stringify(e,null,2)}import(t){let e=typeof t=="string"?JSON.parse(t):t;this.fromJSON(e)}save(t,e=!1){return K(this,null,function*(){let n=this.container.get("fs"),r=t||"model.nlp";yield n.writeFile(r,this.export(e))})}load(t){return K(this,null,function*(){let e=this.container.get("fs"),n=t||"model.nlp",r=yield e.readFile(n);return r?(this.import(r),!0):!1})}};Sh.exports=Zs});var Rh=Q((Rk,Fh)=>{"use strict";var Sy=Ah(),Ay=Qs();Fh.exports={Nlp:Sy,ContextManager:Ay}});var tu=Q((Ik,Ih)=>{"use strict";var{Tokenizer:Fy}=rt(),eu=class extends Fy{constructor(t,e){super(t,e),this.name="tokenizer-fr"}innerTokenize(t){return t.replace(/’/gi,"'").split(/[\s,.!?;:([\]’'"¡¿)/]+/).filter(r=>r)}};Ih.exports=eu});var nu=Q((Tk,Th)=>{"use strict";var{Among:P,BaseStemmer:Ry}=rt(),yt=class i extends Ry{constructor(t){super(t),this.name="stemmer-fr",this.I_p2=0,this.I_p1=0,this.I_pV=0}copy_from(t){this.I_p2=t.I_p2,this.I_p1=t.I_p1,this.I_pV=t.I_pV,super.copy_from(t)}r_prelude(){let t,e,n,r;e:for(;;){t=this.cursor;let o=!0;t:for(;o==!0;){o=!1;r:for(;;){e=this.cursor;let a=!0;n:for(;a==!0;){a=!1;let s=!0;i:for(;s==!0;){s=!1,n=this.cursor;let u=!0;a:for(;u==!0&&(u=!1,!!this.in_grouping(i.g_v,97,251));){this.bra=this.cursor;let l=!0;o:for(;l==!0;){l=!1,r=this.cursor;let f=!0;for(;f==!0&&(f=!1,!(!this.eq_s(1,"u")||(this.ket=this.cursor,!this.in_grouping(i.g_v,97,251))));){if(!this.slice_from("U"))return!1;break o}this.cursor=r;let h=!0;for(;h==!0&&(h=!1,!(!this.eq_s(1,"i")||(this.ket=this.cursor,!this.in_grouping(i.g_v,97,251))));){if(!this.slice_from("I"))return!1;break o}if(this.cursor=r,!this.eq_s(1,"y"))break a;if(this.ket=this.cursor,!this.slice_from("Y"))return!1}break i}this.cursor=n;let c=!0;for(;c==!0&&(c=!1,this.bra=this.cursor,!(!this.eq_s(1,"y")||(this.ket=this.cursor,!this.in_grouping(i.g_v,97,251))));){if(!this.slice_from("Y"))return!1;break i}if(this.cursor=n,!this.eq_s(1,"q")||(this.bra=this.cursor,!this.eq_s(1,"u")))break n;if(this.ket=this.cursor,!this.slice_from("U"))return!1}this.cursor=e;break r}if(this.cursor=e,this.cursor>=this.limit)break t;this.cursor++}continue e}this.cursor=t;break}return!0}r_mark_regions(){let t,e,n;this.I_pV=this.limit,this.I_p1=this.limit,this.I_p2=this.limit,t=this.cursor;let r=!0;e:for(;r==!0;){r=!1;let a=!0;t:for(;a==!0;){a=!1,e=this.cursor;let s=!0;for(;s==!0&&(s=!1,!(!this.in_grouping(i.g_v,97,251)||!this.in_grouping(i.g_v,97,251)||this.cursor>=this.limit));){this.cursor++;break t}this.cursor=e;let u=!0;for(;u==!0&&(u=!1,this.find_among(i.a_0,3)!=0);)break t;if(this.cursor=e,this.cursor>=this.limit)break e;this.cursor++;r:for(;;){let c=!0;for(;c==!0&&(c=!1,!!this.in_grouping(i.g_v,97,251));)break r;if(this.cursor>=this.limit)break e;this.cursor++}}this.I_pV=this.cursor}this.cursor=t,n=this.cursor;let o=!0;e:for(;o==!0;){o=!1;t:for(;;){let a=!0;for(;a==!0&&(a=!1,!!this.in_grouping(i.g_v,97,251));)break t;if(this.cursor>=this.limit)break e;this.cursor++}t:for(;;){let a=!0;for(;a==!0&&(a=!1,!!this.out_grouping(i.g_v,97,251));)break t;if(this.cursor>=this.limit)break e;this.cursor++}this.I_p1=this.cursor;t:for(;;){let a=!0;for(;a==!0&&(a=!1,!!this.in_grouping(i.g_v,97,251));)break t;if(this.cursor>=this.limit)break e;this.cursor++}t:for(;;){let a=!0;for(;a==!0&&(a=!1,!!this.out_grouping(i.g_v,97,251));)break t;if(this.cursor>=this.limit)break e;this.cursor++}this.I_p2=this.cursor}return this.cursor=n,!0}r_postlude(){let t,e;e:for(;;){e=this.cursor;let n=!0;t:for(;n==!0&&(n=!1,this.bra=this.cursor,t=this.find_among(i.a_1,4),t!=0);){switch(this.ket=this.cursor,t){case 0:break t;case 1:if(!this.slice_from("i"))return!1;break;case 2:if(!this.slice_from("u"))return!1;break;case 3:if(!this.slice_from("y"))return!1;break;case 4:if(this.cursor>=this.limit)break t;this.cursor++;break}continue e}this.cursor=e;break}return!0}r_RV(){return this.I_pV<=this.cursor}r_R1(){return this.I_p1<=this.cursor}r_R2(){return this.I_p2<=this.cursor}r_standard_suffix(){let t,e,n,r,o,a,s,u,c,l,f,h;if(this.ket=this.cursor,t=this.find_among_b(i.a_4,43),t==0)return!1;switch(this.bra=this.cursor,t){case 0:return!1;case 1:if(!this.r_R2()||!this.slice_del())return!1;break;case 2:if(!this.r_R2()||!this.slice_del())return!1;e=this.limit-this.cursor;for(var p=!0;p==!0;){if(p=!1,this.ket=this.cursor,!this.eq_s_b(2,"ic")){this.cursor=this.limit-e;break}this.bra=this.cursor;let b=!0;e:for(;b==!0;){b=!1,n=this.limit-this.cursor;let C=!0;for(;C==!0&&(C=!1,!!this.r_R2());){if(!this.slice_del())return!1;break e}if(this.cursor=this.limit-n,!this.slice_from("iqU"))return!1}}break;case 3:if(!this.r_R2()||!this.slice_from("log"))return!1;break;case 4:if(!this.r_R2()||!this.slice_from("u"))return!1;break;case 5:if(!this.r_R2()||!this.slice_from("ent"))return!1;break;case 6:if(!this.r_RV()||!this.slice_del())return!1;r=this.limit-this.cursor;var d=!0;e:for(;d==!0;){if(d=!1,this.ket=this.cursor,t=this.find_among_b(i.a_2,6),t==0){this.cursor=this.limit-r;break}switch(this.bra=this.cursor,t){case 0:this.cursor=this.limit-r;break e;case 1:if(!this.r_R2()){this.cursor=this.limit-r;break e}if(!this.slice_del())return!1;if(this.ket=this.cursor,!this.eq_s_b(2,"at")){this.cursor=this.limit-r;break e}if(this.bra=this.cursor,!this.r_R2()){this.cursor=this.limit-r;break e}if(!this.slice_del())return!1;break;case 2:var m=!0;t:for(;m==!0;){m=!1,o=this.limit-this.cursor;let b=!0;for(;b==!0&&(b=!1,!!this.r_R2());){if(!this.slice_del())return!1;break t}if(this.cursor=this.limit-o,!this.r_R1()){this.cursor=this.limit-r;break e}if(!this.slice_from("eux"))return!1}break;case 3:if(!this.r_R2()){this.cursor=this.limit-r;break e}if(!this.slice_del())return!1;break;case 4:if(!this.r_RV()){this.cursor=this.limit-r;break e}if(!this.slice_from("i"))return!1;break}}break;case 7:if(!this.r_R2()||!this.slice_del())return!1;a=this.limit-this.cursor;var v=!0;e:for(;v==!0;){if(v=!1,this.ket=this.cursor,t=this.find_among_b(i.a_3,3),t==0){this.cursor=this.limit-a;break}switch(this.bra=this.cursor,t){case 0:this.cursor=this.limit-a;break e;case 1:var g=!0;t:for(;g==!0;){g=!1,s=this.limit-this.cursor;let b=!0;for(;b==!0&&(b=!1,!!this.r_R2());){if(!this.slice_del())return!1;break t}if(this.cursor=this.limit-s,!this.slice_from("abl"))return!1}break;case 2:var x=!0;t:for(;x==!0;){x=!1,u=this.limit-this.cursor;let b=!0;for(;b==!0&&(b=!1,!!this.r_R2());){if(!this.slice_del())return!1;break t}if(this.cursor=this.limit-u,!this.slice_from("iqU"))return!1}break;case 3:if(!this.r_R2()){this.cursor=this.limit-a;break e}if(!this.slice_del())return!1;break}}break;case 8:if(!this.r_R2()||!this.slice_del())return!1;c=this.limit-this.cursor;for(var w=!0;w==!0;){if(w=!1,this.ket=this.cursor,!this.eq_s_b(2,"at")){this.cursor=this.limit-c;break}if(this.bra=this.cursor,!this.r_R2()){this.cursor=this.limit-c;break}if(!this.slice_del())return!1;if(this.ket=this.cursor,!this.eq_s_b(2,"ic")){this.cursor=this.limit-c;break}this.bra=this.cursor;let b=!0;e:for(;b==!0;){b=!1,l=this.limit-this.cursor;let C=!0;for(;C==!0&&(C=!1,!!this.r_R2());){if(!this.slice_del())return!1;break e}if(this.cursor=this.limit-l,!this.slice_from("iqU"))return!1}}break;case 9:if(!this.slice_from("eau"))return!1;break;case 10:if(!this.r_R1()||!this.slice_from("al"))return!1;break;case 11:var y=!0;e:for(;y==!0;){y=!1,f=this.limit-this.cursor;let b=!0;for(;b==!0&&(b=!1,!!this.r_R2());){if(!this.slice_del())return!1;break e}if(this.cursor=this.limit-f,!this.r_R1()||!this.slice_from("eux"))return!1}break;case 12:if(!this.r_R1()||!this.out_grouping_b(i.g_v,97,251)||!this.slice_del())return!1;break;case 13:return!this.r_RV()||!this.slice_from("ant"),!1;case 14:return!this.r_RV()||!this.slice_from("ent"),!1;case 15:return h=this.limit-this.cursor,!this.in_grouping_b(i.g_v,97,251)||!this.r_RV()||(this.cursor=this.limit-h,!this.slice_del()),!1}return!0}r_i_verb_suffix(){let t,e,n;if(e=this.limit-this.cursor,this.cursor<this.I_pV)return!1;if(this.cursor=this.I_pV,n=this.limit_backward,this.limit_backward=this.cursor,this.cursor=this.limit-e,this.ket=this.cursor,t=this.find_among_b(i.a_5,35),t==0)return this.limit_backward=n,!1;switch(this.bra=this.cursor,t){case 0:return this.limit_backward=n,!1;case 1:if(!this.out_grouping_b(i.g_v,97,251))return this.limit_backward=n,!1;if(!this.slice_del())return!1;break}return this.limit_backward=n,!0}r_verb_suffix(){let t,e,n,r;if(e=this.limit-this.cursor,this.cursor<this.I_pV)return!1;if(this.cursor=this.I_pV,n=this.limit_backward,this.limit_backward=this.cursor,this.cursor=this.limit-e,this.ket=this.cursor,t=this.find_among_b(i.a_6,38),t==0)return this.limit_backward=n,!1;switch(this.bra=this.cursor,t){case 0:return this.limit_backward=n,!1;case 1:if(!this.r_R2())return this.limit_backward=n,!1;if(!this.slice_del())return!1;break;case 2:if(!this.slice_del())return!1;break;case 3:if(!this.slice_del())return!1;r=this.limit-this.cursor;for(var o=!0;o==!0;){if(o=!1,this.ket=this.cursor,!this.eq_s_b(1,"e")){this.cursor=this.limit-r;break}if(this.bra=this.cursor,!this.slice_del())return!1}break}return this.limit_backward=n,!0}r_residual_suffix(){let t,e,n,r,o,a;e=this.limit-this.cursor;let s=!0;for(;s==!0;){if(s=!1,this.ket=this.cursor,!this.eq_s_b(1,"s")){this.cursor=this.limit-e;break}if(this.bra=this.cursor,n=this.limit-this.cursor,!this.out_grouping_b(i.g_keep_with_s,97,232)){this.cursor=this.limit-e;break}if(this.cursor=this.limit-n,!this.slice_del())return!1}if(r=this.limit-this.cursor,this.cursor<this.I_pV)return!1;if(this.cursor=this.I_pV,o=this.limit_backward,this.limit_backward=this.cursor,this.cursor=this.limit-r,this.ket=this.cursor,t=this.find_among_b(i.a_7,7),t==0)return this.limit_backward=o,!1;switch(this.bra=this.cursor,t){case 0:return this.limit_backward=o,!1;case 1:if(!this.r_R2())return this.limit_backward=o,!1;var u=!0;e:for(;u==!0;){u=!1,a=this.limit-this.cursor;let c=!0;for(;c==!0&&(c=!1,!!this.eq_s_b(1,"s"));)break e;if(this.cursor=this.limit-a,!this.eq_s_b(1,"t"))return this.limit_backward=o,!1}if(!this.slice_del())return!1;break;case 2:if(!this.slice_from("i"))return!1;break;case 3:if(!this.slice_del())return!1;break;case 4:if(!this.eq_s_b(2,"gu"))return this.limit_backward=o,!1;if(!this.slice_del())return!1;break}return this.limit_backward=o,!0}r_un_double(){let t;return t=this.limit-this.cursor,!(this.find_among_b(i.a_8,5)==0||(this.cursor=this.limit-t,this.ket=this.cursor,this.cursor<=this.limit_backward)||(this.cursor--,this.bra=this.cursor,!this.slice_del()))}r_un_accent(){let t;{let n=1;e:for(;;){let r=!0;for(;r==!0&&(r=!1,!!this.out_grouping_b(i.g_v,97,251));){n--;continue e}break}if(n>0)return!1}this.ket=this.cursor;let e=!0;e:for(;e==!0;){e=!1,t=this.limit-this.cursor;let n=!0;for(;n==!0&&(n=!1,!!this.eq_s_b(1,"\xE9"));)break e;if(this.cursor=this.limit-t,!this.eq_s_b(1,"\xE8"))return!1}return this.bra=this.cursor,!!this.slice_from("e")}innerStem(){let t,e,n,r,o,a,s,u,c,l,f;t=this.cursor;let h=!0;for(;h==!0&&(h=!1,!!this.r_prelude()););this.cursor=t,e=this.cursor;let p=!0;for(;p==!0&&(p=!1,!!this.r_mark_regions()););this.cursor=e,this.limit_backward=this.cursor,this.cursor=this.limit,n=this.limit-this.cursor;let d=!0;e:for(;d==!0;){d=!1;let x=!0;t:for(;x==!0;){x=!1,r=this.limit-this.cursor;let w=!0;r:for(;w==!0;){w=!1,o=this.limit-this.cursor;let y=!0;n:for(;y==!0;){y=!1,a=this.limit-this.cursor;let C=!0;for(;C==!0&&(C=!1,!!this.r_standard_suffix());)break n;this.cursor=this.limit-a;let S=!0;for(;S==!0&&(S=!1,!!this.r_i_verb_suffix());)break n;if(this.cursor=this.limit-a,!this.r_verb_suffix())break r}this.cursor=this.limit-o,s=this.limit-this.cursor;let b=!0;n:for(;b==!0;){b=!1,this.ket=this.cursor;let C=!0;i:for(;C==!0;){C=!1,u=this.limit-this.cursor;let S=!0;for(;S==!0&&(S=!1,!!this.eq_s_b(1,"Y"));){if(this.bra=this.cursor,!this.slice_from("i"))return!1;break i}if(this.cursor=this.limit-u,!this.eq_s_b(1,"\xE7")){this.cursor=this.limit-s;break n}if(this.bra=this.cursor,!this.slice_from("c"))return!1}}break t}if(this.cursor=this.limit-r,!this.r_residual_suffix())break e}}this.cursor=this.limit-n,c=this.limit-this.cursor;let m=!0;for(;m==!0&&(m=!1,!!this.r_un_double()););this.cursor=this.limit-c,l=this.limit-this.cursor;let v=!0;for(;v==!0&&(v=!1,!!this.r_un_accent()););this.cursor=this.limit-l,this.cursor=this.limit_backward,f=this.cursor;let g=!0;for(;g==!0&&(g=!1,!!this.r_postlude()););return this.cursor=f,!0}};yt.methodObject=new yt;yt.a_0=[new P("col",-1,-1),new P("par",-1,-1),new P("tap",-1,-1)];yt.a_1=[new P("",-1,4),new P("I",0,1),new P("U",0,2),new P("Y",0,3)];yt.a_2=[new P("iqU",-1,3),new P("abl",-1,3),new P("I\xE8r",-1,4),new P("i\xE8r",-1,4),new P("eus",-1,2),new P("iv",-1,1)];yt.a_3=[new P("ic",-1,2),new P("abil",-1,1),new P("iv",-1,3)];yt.a_4=[new P("iqUe",-1,1),new P("atrice",-1,2),new P("ance",-1,1),new P("ence",-1,5),new P("logie",-1,3),new P("able",-1,1),new P("isme",-1,1),new P("euse",-1,11),new P("iste",-1,1),new P("ive",-1,8),new P("if",-1,8),new P("usion",-1,4),new P("ation",-1,2),new P("ution",-1,4),new P("ateur",-1,2),new P("iqUes",-1,1),new P("atrices",-1,2),new P("ances",-1,1),new P("ences",-1,5),new P("logies",-1,3),new P("ables",-1,1),new P("ismes",-1,1),new P("euses",-1,11),new P("istes",-1,1),new P("ives",-1,8),new P("ifs",-1,8),new P("usions",-1,4),new P("ations",-1,2),new P("utions",-1,4),new P("ateurs",-1,2),new P("ments",-1,15),new P("ements",30,6),new P("issements",31,12),new P("it\xE9s",-1,7),new P("ment",-1,15),new P("ement",34,6),new P("issement",35,12),new P("amment",34,13),new P("emment",34,14),new P("aux",-1,10),new P("eaux",39,9),new P("eux",-1,1),new P("it\xE9",-1,7)];yt.a_5=[new P("ira",-1,1),new P("ie",-1,1),new P("isse",-1,1),new P("issante",-1,1),new P("i",-1,1),new P("irai",4,1),new P("ir",-1,1),new P("iras",-1,1),new P("ies",-1,1),new P("\xEEmes",-1,1),new P("isses",-1,1),new P("issantes",-1,1),new P("\xEEtes",-1,1),new P("is",-1,1),new P("irais",13,1),new P("issais",13,1),new P("irions",-1,1),new P("issions",-1,1),new P("irons",-1,1),new P("issons",-1,1),new P("issants",-1,1),new P("it",-1,1),new P("irait",21,1),new P("issait",21,1),new P("issant",-1,1),new P("iraIent",-1,1),new P("issaIent",-1,1),new P("irent",-1,1),new P("issent",-1,1),new P("iront",-1,1),new P("\xEEt",-1,1),new P("iriez",-1,1),new P("issiez",-1,1),new P("irez",-1,1),new P("issez",-1,1)];yt.a_6=[new P("a",-1,3),new P("era",0,2),new P("asse",-1,3),new P("ante",-1,3),new P("\xE9e",-1,2),new P("ai",-1,3),new P("erai",5,2),new P("er",-1,2),new P("as",-1,3),new P("eras",8,2),new P("\xE2mes",-1,3),new P("asses",-1,3),new P("antes",-1,3),new P("\xE2tes",-1,3),new P("\xE9es",-1,2),new P("ais",-1,3),new P("erais",15,2),new P("ions",-1,1),new P("erions",17,2),new P("assions",17,3),new P("erons",-1,2),new P("ants",-1,3),new P("\xE9s",-1,2),new P("ait",-1,3),new P("erait",23,2),new P("ant",-1,3),new P("aIent",-1,3),new P("eraIent",26,2),new P("\xE8rent",-1,2),new P("assent",-1,3),new P("eront",-1,2),new P("\xE2t",-1,3),new P("ez",-1,2),new P("iez",32,2),new P("eriez",33,2),new P("assiez",33,3),new P("erez",32,2),new P("\xE9",-1,2)];yt.a_7=[new P("e",-1,3),new P("I\xE8re",0,2),new P("i\xE8re",0,2),new P("ion",-1,1),new P("Ier",-1,2),new P("ier",-1,2),new P("\xEB",-1,4)];yt.a_8=[new P("ell",-1,-1),new P("eill",-1,-1),new P("enn",-1,-1),new P("onn",-1,-1),new P("ett",-1,-1)];yt.g_v=[17,65,16,1,0,0,0,0,0,0,0,0,0,0,0,128,130,103,8,5];yt.g_keep_with_s=[1,65,20,0,0,0,0,0,0,0,0,0,0,0,0,0,128];Th.exports=yt});var iu=Q((Nk,Nh)=>{"use strict";var{Stopwords:Iy}=rt(),ru=class extends Iy{constructor(t,e){super(t),this.name="stopwords-fr",this.dictionary={};let n=e||["\xEAtre","avoir","faire","a","au","aux","avec","ce","ces","dans","de","des","du","elle","en","et","eux","il","je","la","le","leur","lui","ma","mais","me","m\xEAme","mes","moi","mon","ne","nos","notre","nous","on","ou","o\xF9","par","pas","pour","qu","que","qui","sa","se","ses","son","sur","ta","te","tes","toi","ton","tu","un","une","vos","votre","vous","c","d","j","l","\xE0","m","n","s","t","y","\xE9t\xE9","\xE9t\xE9e","\xE9t\xE9es","\xE9t\xE9s","\xE9tant","suis","es","est","sommes","\xEAtes","sont","serai","seras","sera","serons","serez","seront","serais","serait","serions","seriez","seraient","\xE9tais","\xE9tait","\xE9tions","\xE9tiez","\xE9taient","fus","fut","f\xFBmes","f\xFBtes","furent","sois","soit","soyons","soyez","soient","fusse","fusses","f\xFBt","fussions","fussiez","fussent","ayant","eu","eue","eues","eus","ai","as","avons","avez","ont","aurai","auras","aura","aurons","aurez","auront","aurais","aurait","aurions","auriez","auraient","avais","avait","avions","aviez","avaient","eut","e\xFBmes","e\xFBtes","eurent","aie","aies","ait","ayons","ayez","aient","eusse","eusses","e\xFBt","eussions","eussiez","eussent","ceci","cela","cet","cette","ici","ils","les","leurs","quel","quels","quelle","quelles","sans","soi"];this.build(n)}};Nh.exports=ru});var au=Q((Pk,Ph)=>{"use strict";var{Normalizer:Ty}=rt(),ou=class extends Ty{constructor(t){super(t),this.name="normalizer-fr"}normalize(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}run(t){let e=t;return e.text=this.normalize(e.text,e),e}};Ph.exports=ou});var Mh=Q((Mk,Ny)=>{Ny.exports={abandon:-.3,abandonne:-.3,abasourd:.24,abattu:-.12,abattus:-.12,aberr:0,abomin:-.9,abond:0,abord:.15,abracadabr:-.18,abrut:-.28,absent:-.1,absolu:.25,absolus:0,absorb:.3,absorbe:.3,abstrait:0,absurd:.4,abus:-.2,acariatr:.2,accabl:-.15,accable:-.15,accept:.05,accessibl:.13,accident:-.04,accidente:-.04,accol:0,accole:0,accommod:.45,accompl:.4,accort:.23,accueil:.4,acerb:-.15,acharn:.2,acharne:.2,achev:.07,acheve:.07,acidul:-.1,acidule:-.1,actif:.1,activ:-.1,actuel:.1,additionnel:.05,adjacent:.03,administr:0,admir:.7,adolescent:.16,ador:.5,adroit:.23,adul:.27,adventic:.05,advers:-.35,adequat:0,affabl:.31,affectu:.4,affil:.1,affile:.1,afflig:-.15,afflige:-.15,affol:-.5,affole:-.5,affreux:-.8,africain:0,agac:-.25,agiss:.2,agit:.1,agite:.1,agress:-.8,agreabl:.7,ahur:.15,aigr:-.3,aigu:.2,aiguis:.1,aiguise:.1,aigus:.2,aimabl:.9,aim:.4,aime:.4,ajout:.05,ajoute:.05,ajust:0,ajuste:0,alarm:-.2,algerien:0,allemand:0,allogen:-.1,allong:0,allonge:0,allum:.3,allume:.3,allegr:.25,altruist:.35,alter:-.4,altere:-.4,aleatoir:-.05,amaigr:-.1,ambi:0,ambigu:-.05,ambigus:-.05,amer:-.6,ami:.75,amical:.5,amis:.75,amour:.55,ample:.1,amus:.4,amelior:.27,ameliore:.27,americain:.08,amerindien:.04,amethyst:0,analog:0,analogu:.02,ancestral:.05,ancien:.04,android:.11,anglais:.07,angoiss:-.05,angoisse:-.05,angel:.05,anhydr:-.12,animal:-.3,annex:0,annexe:0,anodin:-.08,anonym:-.1,anormal:-.08,antagon:-.35,anthropoid:.11,anticapital:-.11,antiqu:.1,anterieur:0,anxieux:-.1,apeur:-.05,apeure:-.05,aphas:-.05,aplat:-.14,apparent:.1,appliqu:.22,applique:.22,approch:0,approche:0,appropr:0,approprie:0,approxim:0,appreci:.03,apprec:.4,arab:0,arachneen:.09,ardent:.5,argent:0,argente:0,aristocrat:.15,arme:-.2,arriv:.1,arrive:.1,arrier:-.18,arriere:-.18,arrond:-.15,arret:-.1,arrete:-.1,artificiel:-.1,artist:.1,assembl:0,assidu:.02,assidus:.02,assis:0,assoup:0,assujet:.05,assur:.2,assure:.2,astral:.05,astronom:.11,astuci:.45,athlet:.21,atroc:-.9,atrocit:-.5,attach:.23,attard:0,attarde:0,atten:.03,attent:.6,attention:.45,attentionne:.45,attir:.31,attitr:-.09,attitre:-.09,attrist:-.15,attriste:-.15,atyp:.1,aubergin:0,audaci:.01,audibl:0,august:.28,auster:-.1,authent:.3,autonom:.23,autoris:.05,autorise:.05,autoritair:-.11,autr:-.1,avanc:.3,avance:.3,avantag:.1,avar:-.4,avarie:-.4,aven:.4,aventur:-.28,aveugl:-.3,avid:.4,azimut:-.01,aerien:0,ain:0,aine:0,bagarreur:-.1,bagarr:-.1,balist:0,balourd:-.24,banal:-.3,bancal:-.1,barbar:-.7,bas:-.2,basan:0,basane:0,bass:-.2,batailleur:-.4,bataill:-.4,batt:-.2,battu:-.3,battus:-.3,bavard:-.3,beau:.8,beaucoup:.1,bel:.8,belg:0,belliger:-.1,belliqu:-.23,besogn:-.34,bien:0,bienfais:.35,bienheur:.35,biens:0,bienveil:.38,bijou:.3,biscornu:-.2,biscornus:-.2,bistr:0,bizarr:-.4,blafard:-.1,blanc:.05,blanch:.05,bless:-.4,blesse:-.4,bleu:.04,bleus:.04,bleut:.02,bleute:.02,bleuatr:.02,blond:.03,blamabl:-.12,blem:-.4,bon:.7,bonheur:.5,bonhomm:.35,boudin:-.15,boudine:-.15,boueux:-.2,bouff:0,bouffon:.26,bouill:0,bourgeois:-.1,bourr:.14,bourre:.14,brav:.6,bref:.08,breton:0,brill:.65,bris:-.4,brise:-.4,britann:.07,british:.03,brun:0,brusqu:-.5,brutal:-.6,brui:-.2,brev:.08,brul:-.1,brule:-.1,burin:.2,burine:.2,burlesqu:-.2,byzantin:0,be:0,bet:-.5,cabalist:.24,cach:.2,cache:.2,cadeau:.45,cagneux:-.1,calcin:0,calcine:0,calcul:0,calm:.17,camard:-.14,candid:.05,capabl:.35,capital:.2,capiton:0,capitonne:0,captif:-.15,captiv:-.15,carmin:.01,carr:0,carre:0,cass:-.4,casse:-.4,catastroph:-.5,cathol:-.1,cavali:.23,cavalier:.23,cavern:-.25,cendr:-.09,cendre:-.09,cens:-.1,cense:-.1,central:.05,certain:.29,chaleur:.3,chang:-.05,change:-.05,charit:.35,charm:.55,charnel:.1,charnu:-.17,charnus:-.17,chast:.05,chatoi:.2,chaud:.25,chauv:-.1,cher:.5,chic:-.3,chimer:-.05,chinois:0,chois:.1,chouet:.6,chroniqu:-.01,chretien:0,cherot:-.11,chetif:-.08,chetiv:-.08,cingl:-.01,cingle:-.01,cinoqu:-.01,cinquiem:0,cinet:0,circonspect:-.01,circulair:0,cireux:-.03,cisel:.2,cisele:.2,civil:.1,civilis:.05,civilise:.05,clair:.28,clandestin:-.1,classiqu:.7,clos:-.1,clerical:0,coc:-.1,coeur:.2,coll:-.03,collect:.2,collegial:.1,colonial:0,color:0,colore:0,colossal:0,coler:-.27,combat:-.25,combatt:-.2,combl:.27,comble:.27,comiqu:.4,commenc:.15,commercial:0,commod:.3,commun:.08,communautair:.07,compact:.1,compar:0,complet:.43,complex:-.05,complexe:-.05,complic:.38,compliqu:-.4,complique:-.4,composit:0,compress:-.15,compresse:-.15,comprim:-.14,comprime:-.14,comprehensibl:.09,con:-.7,concentr:.3,concentre:.3,conc:-.1,concis:-.1,conclu:0,concret:.25,condescend:.02,confessionnel:0,confi:.3,confidentiel:.04,confin:-.12,confine:-.12,confondu:.24,confondus:.24,conform:.1,confort:.3,confus:-.4,conjugal:0,conner:-.7,connu:.6,connus:.6,conscienci:0,conscient:.1,conseil:.2,consider:.1,consign:0,consigne:0,consist:.08,const:.1,constern:-.17,consterne:-.17,consequent:0,contemporain:.07,content:.65,contest:-.05,continental:.01,contingent:0,continu:0,continus:0,contract:-.22,contracte:-.22,contradictoir:-.05,contrair:-.1,contrari:-.25,contr:-.2,contrit:-.2,convaincu:.1,convaincus:.1,conven:.2,cordial:.25,coriac:-.11,corpulent:0,correct:.4,corrig:.27,corrige:.27,corrompu:-.4,corrompus:-.4,cosmiqu:.1,cosmopolit:.17,costaud:.21,coton:-.1,couch:-.2,couche:-.2,coupabl:-.25,coup:0,coupe:0,courag:.5,cour:.1,courb:-.03,court:-.1,courtois:.2,coutumi:0,coutumier:0,couteux:-.11,craintif:-.05,craintiv:-.05,cramois:.01,crasseux:-.4,crayeux:-.03,creus:-.5,creux:-.5,cri:.05,criminel:-.1,cristallin:.15,critiqu:0,crois:-.5,croise:-.5,croul:0,croustill:-.15,cru:-.3,crucial:.08,cruel:-.4,crus:-.3,credul:.05,cretin:-.35,cuis:0,cuit:0,culturel:.1,cuprifer:.1,cupriqu:.1,curieux:.07,cyclopeen:.08,celest:.24,celebr:.15,ceruleen:.02,cerebral:.05,emot:.4,danger:-.55,dantesqu:-.2,dem:-.05,dens:0,derni:-.29,dernier:-.29,deuxiem:.03,difficil:-.5,difform:-.35,different:.4,dign:.5,dingu:-.2,diplomat:0,direct:.2,dirig:-.05,discord:.2,discret:0,discut:-.05,disgraci:-.35,disparat:.1,disparu:-.14,disparus:-.14,dispendi:-.11,disponibl:.1,dissembl:.08,dissimul:.1,dissimule:.1,dist:-.05,distinct:0,distingu:.2,distingue:.2,distr:-.6,distrait:-.6,diurn:0,diver:0,divers:0,divin:.55,docil:-.1,domest:0,domin:.3,dommag:-.3,don:.1,donne:.1,dorm:0,dormeur:0,dormeux:0,dor:.2,dore:.2,doubl:0,douc:.4,doucer:.2,doulour:-.55,douteux:-.1,doux:.4,draconien:.16,dramat:-.2,dress:0,dresse:0,droit:.17,dru:0,drus:0,drol:.53,dur:-.21,duvet:.1,dynam:0,debil:-.5,debonnair:0,debut:.15,decent:0,decept:-.5,decharn:-.1,decharne:-.1,dechir:-.3,dechire:-.3,decid:.1,decide:.1,decis:.2,deconcert:.28,deconcerte:.28,deconf:-.2,deconfit:-.2,decoupl:.21,decouple:.21,decouvert:.1,decouvr:.1,def:-.1,defait:-.1,defavor:-.35,defendu:-.05,defendus:-.05,deficient:-.19,definit:0,deform:-.1,deforme:-.1,degout:-.43,degueul:-1,delaiss:-.12,delaisse:-.12,delect:.4,delicat:.25,delici:.8,delictu:-.06,dement:-.01,demerdard:-.05,demesur:.14,demesure:.14,demod:-.08,demode:-.08,denud:-.02,denude:-.02,depeupl:-.13,depeuple:-.13,deplais:.02,deplor:-.15,deraison:.2,derisoir:-.5,derout:.1,deregl:-.2,deregle:-.2,desagre:-.5,desarm:-.33,desarme:-.33,desastr:-.5,desax:-.01,desaxe:-.01,desert:-.14,deserte:-.14,desesper:-.7,desespere:-.7,deshabill:.08,deshabille:.08,deshydrat:-.12,deshydrate:-.12,desherit:-.5,desherite:-.5,desol:-.3,desole:-.3,detach:-.1,detache:-.1,detaill:.2,detaille:.2,detenu:-.15,detenus:-.15,detest:0,devor:.5,decu:-1,decus:-1,ecclesiast:0,effect:.1,efficac:.4,efficient:.2,effil:.06,effile:.06,efflanqu:-.1,efflanque:-.1,effrai:-.5,effray:-.5,effraye:-.5,effroi:-.2,effemin:0,effemine:0,ellipt:-.05,embarrass:-.23,embarr:-.5,embarrasse:-.5,emberlificot:0,embras:.25,embrase:.25,embrouill:-.2,embrouille:-.2,embrum:-.02,embrume:-.02,emmerd:-.25,emprison:-.15,emprisonne:-.15,empat:-.09,empate:-.09,encaiss:.13,encaisse:.13,encastr:.13,encastre:.13,enceint:.1,enchant:.32,enchante:.32,encrout:-.15,endeuill:-.32,endeuille:-.32,endommag:-.3,endommage:-.3,endorm:0,enfantin:-.15,enflamm:.25,enflamme:.25,engourd:-.11,enjou:.26,enjoue:.26,ennem:-.6,ennui:-.7,ennuy:-.7,ennuye:-.7,ensangl:-.2,ensanglante:-.2,ensorcel:.45,entaill:0,entaille:0,entendu:0,entendus:0,enthousiast:.8,entich:.27,entiche:.27,enti:.15,entier:.15,entortill:-.2,entortille:-.2,entrouvert:0,envah:-.25,envelopp:0,enveloppe:0,envieux:-.2,envout:.45,errant:-.1,espagnol:0,espiegl:.15,essai:-.05,essentiel:.3,esseul:-.1,esseule:-.1,estim:.15,europeen:0,exact:.25,excellent:.5,exceptionnel:.2,excess:-.4,excit:-.15,excite:-.15,exclus:-.03,exemplair:.3,exig:-.12,exist:.07,exorbit:.11,exot:.1,explicit:0,express:0,expre:0,exquis:.6,extern:0,extraordinair:.1,extravag:.2,extrem:-.3,exterieur:0,execr:-.36,fabul:1,facil:.27,factic:.25,fad:-.4,faibl:-.38,faisabl:0,fameux:.1,familial:.1,famili:.2,familier:.2,fantast:1,farouch:-.6,fatal:-.7,fatig:-.2,fatigu:-.2,fatigue:-.2,fauch:-.34,fauche:-.34,fauss:-.5,fauv:0,faux:-.5,favor:.3,favorit:.3,femel:0,ferm:-.28,ferme:-.28,fertil:.05,fessi:0,fessier:0,fichu:-.25,fichus:-.25,fidel:.1,fi:.38,fier:.38,fig:-.2,fige:-.2,fin:-.1,final:-.5,fix:.1,fievreux:-.2,flagad:-.1,flageol:-.05,flagr:-.1,flamboi:.25,flegmat:.07,fleur:.1,flexibl:.05,flott:0,flou:-.2,flous:-.2,fluid:0,flaneur:-.21,flaneux:-.21,foll:-.01,fonc:-.2,fonce:-.2,forcen:-.22,forcene:-.22,forc:-.4,force:-.4,formel:-.12,formid:.85,fort:.41,fortuit:.25,fortun:.23,fortune:.23,fossil:0,fou:-.01,foudroi:.02,fouineur:.04,fouin:.04,fourr:0,fourre:0,fourvoy:-.22,fourvoye:-.22,fous:-.01,foutais:-.6,foutu:-.4,foutus:-.4,fragil:-.25,frais:.3,franc:.2,franch:.2,franchouillard:.1,francais:.2,fraternel:.1,fraich:.3,frisquet:.15,frisson:-.05,fris:0,frise:0,froid:-.34,froiss:-.4,froisse:-.4,fructueux:.1,frust:.1,frem:-.05,frequent:.1,fretill:-.15,frel:-.1,fugit:-.1,fum:0,fume:0,funest:-.2,funebr:-.6,fureteur:.04,furet:.04,furibond:-.22,furieux:-.45,furtif:-.2,furtiv:-.2,futur:0,febril:.15,federal:0,feminin:0,feroc:-.3,gai:.5,gais:.5,galop:.05,gauch:-.16,gaulois:.1,gentil:.4,gentill:.4,gigantesqu:.1,girond:.4,glabr:.1,glacial:-.2,glac:-.25,glace:-.25,glauqu:0,global:0,glorieux:1,glu:-.1,gnangnan:-.21,godich:.05,gonfl:-.1,gonfle:-.1,gourmand:.1,gracieux:.8,grand:.3,grandios:.8,gras:-.35,grass:-.35,gratin:-.2,gratuit:.1,grav:.4,gravel:-.15,grec:0,grecqu:0,grelott:-.12,gris:-.18,grisatr:-.1,grivois:-.15,gros:0,gross:0,grossi:.3,grossier:.3,grotesqu:-.6,guerri:-.07,guerrier:-.07,ge:.2,genial:.9,general:0,gener:.7,gen:-.3,gene:-.3,habil:.3,habill:0,habille:0,habituel:-.05,hagard:-.2,haineux:-.38,halet:.1,hard:.2,hargneux:-.5,hasard:.4,hasarde:.4,haut:.18,hautain:-.7,hellen:0,hermet:.04,heureux:.7,hexagonal:.1,hideux:-.7,hispan:0,histor:0,hierat:.17,homogen:0,homologu:.03,honnet:.2,honor:.5,honteux:-.4,horizontal:0,horreur:-.6,horribl:-1,hostil:-.7,humain:.22,humanoid:.11,humbl:-.2,humid:-.03,hyperact:-.15,hypothet:-.05,hebreu:0,hebreux:0,hel:-.4,heroiqu:.5,hesit:-.1,heteroclit:0,heterogen:0,iber:0,ident:0,idiot:-.7,ideal:.8,ideau:.8,ignobl:-.8,ignor:-.1,ignore:-.1,illicit:-.05,illimit:.11,illimite:.11,illog:.2,illustr:.2,illegal:-.05,imaginair:.3,imbib:-.02,imbibe:-.02,imbecil:-1,immacul:.16,immacule:.16,immanqu:-.35,immens:.45,immigr:-.1,immobil:-.16,immuabl:0,immediat:.55,immemorial:.02,impar:-.35,imparf:-.08,imparfait:-.08,impassibl:-.1,impatient:-.3,impavid:.08,impecc:.7,impens:.02,imperceptibl:-.2,impitoi:-.6,implac:-.3,import:.4,impos:.5,impossibl:-.5,impratic:-.25,impression:.7,improb:-.1,imprec:.15,imprecis:.15,imprevisibl:-.2,imprevu:.08,imprevus:.08,impuiss:-.2,impenetr:.09,imper:.02,imperial:-.2,imperi:-.1,inabord:-.05,inaccessibl:-.2,inadmissibl:.3,inalter:.25,inaltere:.25,inamical:-.35,inapt:-.33,inattendu:.2,inattendus:.2,inaudibl:-.1,incalcul:.11,incap:-.67,incarnat:.01,incertain:-.3,incess:-.2,incompar:.1,incomprehensibl:-.4,inconcev:.3,inconnu:-.2,inconnus:-.2,inconscient:-.3,incroi:.6,incredul:-.4,indien:0,indifferent:-.4,indigent:-.5,indign:-.3,indiscret:-.3,indispens:.8,individuel:-.03,indompt:.04,indompte:.04,industriel:.05,indec:-.2,indecis:-.2,indefin:0,independ:.1,indetermin:-.15,indetermine:-.15,inentam:0,inentame:0,inert:-.1,inesper:.4,inespere:.4,inexplor:-.1,inexplore:-.1,infernal:-.6,infim:-.1,infin:0,infinitesimal:-.11,inflexibl:-.17,influent:.3,inferieur:-.5,ingenu:.1,ingenus:.1,inhumain:-.5,inimagin:.3,injust:-.4,innocent:.2,innombr:.2,inopin:.02,inopine:.02,inoubli:.6,inou:.9,inoui:.9,inquiet:-.4,inquisiteur:.04,inquisitric:.04,insatisf:-.32,insatisfait:-.32,insensibl:-.3,insens:-.4,insense:-.4,insignifi:-.4,insolent:-.7,insolit:-.3,insouten:-.1,inspir:.1,inspire:.1,instabl:-.12,instant:.1,instinct:0,insupport:-.2,intact:0,intangibl:.17,intellectuel:.1,intelligent:.9,intelligibl:.14,intens:.4,interd:-.1,interdit:-.1,interess:.3,intermin:-.5,intermediair:-.08,international:.35,intern:-.03,interrog:.04,intestin:-.02,intim:.2,intoler:-.5,integral:.09,interieur:-.07,inutil:-.3,invers:0,invincibl:.21,inviol:.17,invisibl:-.07,invraisembl:-.25,ined:.12,inedit:.12,inepuis:.1,inequit:-.2,inevit:-.2,irascibl:-.22,iron:.3,irrattrap:0,irrespons:.1,irreel:.1,irresistibl:.9,isol:-.2,isole:-.2,israelit:0,italien:0,ivre:-.5,jalous:-.4,jaloux:-.4,japon:0,japonais:0,jaun:-.02,jaunatr:0,jeun:.32,joint:0,jol:.57,jouiss:-.28,journali:0,journalier:0,joyeux:.55,judici:.1,juif:0,juiv:0,jumel:0,jumele:0,just:.22,laid:-.7,laiteux:0,lambin:-.21,lament:-.3,langour:.12,lapidair:0,larg:.15,las:-.4,lascif:.12,lasciv:.12,lass:-.4,latin:0,lent:-.42,lev:.4,leve:.4,libr:.45,liberal:-.05,liber:.1,libere:.1,licenci:.04,lilial:.03,limit:-.12,limite:-.12,limpid:0,liquid:0,liquor:.1,lisibl:.14,liss:.2,litterair:.1,liturg:.17,livid:-.5,local:0,logiqu:.1,lointain:-.1,long:-.4,longu:-.4,louabl:.25,louch:-.5,lourd:-.05,loyal:.1,lucid:.2,lugubr:-.6,luis:.4,lumin:.6,luxueux:.5,lach:-.1,legendair:.4,leg:.18,leger:.18,legitim:.2,leonin:-.2,maghrebin:0,magiqu:.7,magnif:1,maigr:-.2,majestu:1,mal:-.7,malad:-.35,maladroit:-.6,malentend:-.15,malfais:-.15,malgr:.2,malheur:-.3,malici:-.07,malign:-.3,malin:-.3,malleabl:.14,manifest:.05,manqu:-.05,marin:0,maritim:0,mar:0,marie:0,marr:.4,marron:0,martial:-.07,marxist:0,masculin:0,massif:0,massiv:0,mastoc:0,mat:-.1,maternel:0,matinal:0,materiel:.29,maud:-.8,maudit:-.8,mauv:0,mauvais:-.71,meilleur:.53,menac:-.6,mensong:-.25,mensonger:-.25,mental:.2,merc:.3,merd:-.7,merveil:.9,mesur:-.1,mesure:-.1,meurtri:-.6,meurtrier:-.6,mignon:.3,militair:-.13,minabl:-.2,minc:-.03,minim:-.2,minuscul:-.22,miracul:.2,misogyn:-.6,miser:-1,mobil:.1,moch:-.8,modern:.2,modest:-.2,model:0,moder:-.15,modere:-.15,moelleux:-.03,moindr:-.1,moit:-.1,molleton:0,molletonne:0,mondain:0,mondial:0,monocord:-.1,monoton:-.2,monstrueux:-.4,monumental:.3,moqu:-.2,moral:0,morn:-.6,mou:-.2,mouchet:-.3,mouchete:-.3,mouill:0,mouille:0,mous:-.2,mouv:.4,moyen:-.15,muet:-.1,multicolor:0,multipl:.2,municipal:0,muscl:.21,muscle:.21,musical:0,mystiqu:.2,mysteri:.28,mecan:0,mech:-.4,mecontent:-.4,median:-.08,medical:0,mediocr:-.4,mefi:-.4,melancol:-.3,melang:-.1,melange:-.1,menag:.05,menager:.05,mepris:-.6,metall:0,metaphys:0,metropolitain:.1,mem:0,mur:.2,naiss:.14,natal:.3,national:0,natur:.25,naturel:.38,nautiqu:0,naz:-.7,naif:.1,naiv:.1,nerveux:-.3,net:.3,neuf:.1,neutr:0,neuv:.1,nobl:.3,nocturn:0,noir:-.1,nombreux:0,non:-.01,nonchal:-.1,nord:0,normal:.17,nouveau:.34,nouvel:.1,nu:.16,nuageux:-.2,nul:-.2,null:-.2,nus:.16,necessair:.27,neglige:-.25,obligatoir:-.2,obliqu:0,obscur:-.47,obscen:-.9,occidental:.05,occult:.04,occup:-.1,occupe:-.1,odieux:-.7,oecumen:-.05,officiel:0,oiseux:-.15,ombreux:-.2,opalescent:.03,opaqu:-.1,oppos:-.1,oppose:-.1,opulent:.23,oper:.2,orang:0,ordinair:-.2,organis:.4,organise:.4,oriental:0,original:.2,orthodox:0,orthogonal:.03,oubl:-.4,oublie:-.4,oui:.01,ouvert:.31,oval:0,pacif:.4,paisibl:.8,pantouflard:.4,paradisiaqu:0,parallel:.1,paralys:-.08,paralyse:-.08,pareil:0,parental:.05,paress:-.4,parf:.8,parfait:.8,parfum:.2,parfume:.2,parigot:0,parisien:0,part:-.1,particuli:-.15,particulier:-.15,parvenu:.05,parvenus:.05,pascal:0,passion:.8,passionne:.8,pass:-.2,passe:-.2,passeist:0,patent:.1,paternel:-.2,pathet:-1,patient:0,pauvr:-.37,peinard:.4,pench:0,penche:0,pensif:.1,pensiv:.1,perceptibl:.05,perdu:-.45,perdus:-.45,permanent:0,perm:.03,perpendiculair:0,perplex:-.1,perpetuel:-.1,personnel:.05,pes:-.2,petiot:.05,pet:.1,petit:.1,peu:-.05,phosphorescent:.2,physiqu:.8,pieus:.1,pieux:.1,piment:-.17,pimente:-.17,piqu:.05,pirat:-.05,pir:-.4,piteux:-.15,pitoi:-.2,plais:.15,plaqu:-.25,plaque:-.25,plastiqu:-.03,plat:-.28,platin:.01,platine:.01,plein:.29,pleur:-.5,plebeien:.25,plus:.15,pointu:.3,pointus:.3,poisseux:-.05,pol:.3,polit:0,polon:0,polonais:0,ponder:.15,pondere:.15,populaci:-.02,populacier:-.02,populair:.5,posit:0,possibl:0,possed:.23,postal:0,posterieur:0,pos:.1,pose:.1,poubel:-.1,pourpr:0,pourr:-.8,poussier:-.2,poetiqu:.2,pratic:0,pratiqu:.2,premi:.5,premier:.5,press:-.3,presse:-.3,primit:-.1,primordial:.13,principal:.1,prisonni:-.3,prisonnier:-.3,privileg:.2,privilegie:.2,priv:0,prive:0,probabl:0,prob:0,prochain:0,proch:.32,prodigi:.15,product:.05,profan:.1,professionnel:.2,profond:.2,progress:-.11,proletarien:-.3,propic:.2,propr:.33,protest:0,provisoir:-.1,prudent:-.1,prussien:0,precair:-.12,precieux:.6,precipit:.17,precipite:.17,prec:.4,precis:.4,precoc:.1,precurseur:0,precedent:0,predomin:.3,preexist:.25,prefer:.75,prefere:.75,preponder:.2,present:.12,preeminent:.3,pret:.14,psychiqu:.05,pu:-.5,public:0,publiqu:0,puber:.16,puiss:.6,puniss:-.12,pur:.5,pueril:-.4,pal:-.05,palichon:.03,pateux:-.1,penibl:-.4,pepit:.7,peremptoir:-.14,perim:-.2,perime:-.2,periss:-.12,petrif:-.08,petrifie:-.08,quadrangulair:0,qualit:.4,quatriem:0,quelconqu:-.15,quotidien:0,raccourc:0,radical:-.1,radieux:.6,raffin:.1,raffine:.1,raid:-.2,raison:.2,ramollo:-.1,ramollos:-.1,rapid:.35,raplapl:-.1,rar:.25,rassas:.15,rassasie:.15,rassur:.2,rat:-.4,rate:-.4,rauqu:-.1,rav:.9,recherch:.3,recherche:.3,recommand:.2,recommande:.2,reconnu:.14,reconnus:.14,rectangulair:0,rectilign:.09,recul:-.07,recule:-.07,redoubl:0,redouble:0,redout:-.4,refroid:-.05,relat:0,relev:0,releve:0,religi:0,remarqu:.4,rempl:0,renvers:0,renverse:0,respons:.3,ressembl:.08,rich:.45,richess:.4,ridicul:-.75,rigid:-.1,rigol:.5,rigour:.1,rir:.5,robust:.2,rocheux:0,romain:0,romanesqu:0,romant:.4,rond:-.3,rondelet:-.15,ros:.08,rosatr:.04,roturi:-.3,roturier:-.3,roug:.01,roul:0,rouss:0,roussatr:0,roux:0,royal:.2,rud:-.2,ruineux:-.11,russ:0,rebarb:-.6,recent:.1,rechauff:.03,rechauffe:.03,reduit:-.1,reel:.2,reflech:.19,regal:.6,reglementair:.05,reguli:.1,regulier:.1,republicain:0,repugn:-.7,repet:0,repete:0,reserv:-.05,reserve:-.05,resist:-.11,resolu:.2,resolus:.2,retroact:.25,reuss:-.2,revolu:-.16,revolus:-.16,revolutionnair:.4,sacr:.35,sacre:.35,sag:.2,saign:-.2,saill:.1,sain:.3,salaud:-.8,sal:-.1,sale:-.1,sangl:-.4,sanguinolent:-.2,saoul:-.7,sarrasin:0,satisfais:.4,satisf:.3,satisfait:.3,saumon:.04,saumatr:-.17,sauvag:.08,sav:.5,scandal:-.8,scolair:.1,scrupul:0,sculpt:.2,sculpte:.2,sec:-.25,second:0,secret:.08,semblabl:0,sensibl:.2,sensuel:.6,sentimental:.1,serein:.1,serr:0,serre:0,seul:-.1,sexuel:.3,si:.1,silenci:.06,simpl:.1,simplist:.05,sincer:.5,singuli:-.2,singulier:-.2,sinistr:-.65,sirup:-.05,sixiem:0,social:.25,societal:.12,dis:-.3,soigneux:.22,soign:.1,soigne:.1,soldatesqu:-.07,solennel:-.5,solid:.5,solitair:-.2,sombr:-.33,sommair:.05,somptueux:.6,sonor:0,sordid:-.4,soucieux:-.25,soudain:.03,soup:-.5,soupl:.1,sourd:-.3,sourdingu:-.15,souri:.7,sourir:.3,sournois:-.6,souterrain:0,souverain:0,soviet:-.45,soyeux:.1,spacieux:.19,spirituel:.1,splendid:.8,spontan:.2,spontane:.2,spontaneit:.3,sportif:.1,sportiv:.1,special:.5,specif:-.08,stabl:-.01,strateg:0,strict:-.1,stupid:-.5,stupef:.4,stupefait:.4,steril:-.2,sub:-.2,subit:-.2,subject:-.1,sublim:1,subtil:.2,success:0,suffis:.1,suiss:0,suissess:0,suiv:0,suiveur:0,suiveux:0,sup:.7,superb:1,superflu:-.15,superflus:-.15,supplementair:.1,supranational:.17,suprem:.6,superieur:.4,surpren:.8,surpr:.55,surpris:.55,susceptibl:-.1,suspect:-.3,suspendu:-.1,suspendus:-.1,symbol:0,symp:.2,sympath:.6,sech:-.25,semit:0,separ:-.08,separe:-.08,serieux:.45,sever:-.25,sur:.2,taciturn:-.05,taill:.1,taille:.1,talent:.3,taraud:-.28,tardif:-.1,tardiv:-.1,technicien:.1,tel:0,tenac:-.1,tendr:.28,tendu:-.45,tendus:-.45,tenu:0,tenus:0,terminal:-.14,tern:-.5,terrestr:0,terribl:-.7,terrifi:-.7,territorial:0,teuton:0,theolog:0,theatral:-.05,timid:-.1,tied:.05,tomb:-.15,tombe:-.15,tordu:-.2,tordus:-.2,total:.1,touch:.3,tous:.22,tout:.22,traditionnel:0,tragiqu:-.4,tranquill:.15,transalpin:0,transcend:.09,transparent:.3,trembl:-.1,tremblot:-.05,tremp:0,trempe:0,tre:.01,tricolor:.1,triomphal:.6,triomph:.9,trist:-.3,troisiem:0,trompeur:-.3,trompeux:-.3,trop:-.25,troubl:-.1,trouble:-.1,tudesqu:0,turc:0,turqu:0,telephon:0,tenebr:-.16,terebr:-.28,ultim:.6,ultramontain:0,ulterieur:0,uni:.1,uniqu:.43,unis:.1,universel:.2,urgent:-.1,util:.2,vacill:-.05,vagu:-.4,vain:-.3,valabl:.4,valetudinair:-.18,vapor:.09,vast:.38,verdatr:0,vert:0,vertical:0,vertigin:-.1,vertueux:.05,victori:.8,vid:-.29,vieil:.5,vierg:.1,vieux:.5,vif:.27,vigil:.3,vigour:.4,vilain:-.6,violent:-.5,violet:0,viril:.4,visibl:0,visqueux:-.05,vital:.1,vitr:0,vitre:0,vivac:.4,viv:.27,voisin:.05,vol:0,volontair:0,volont:.1,voluptu:.6,vom:-.2,vout:0,voute:0,vrai:0,vrais:.05,vulgair:-.7,vulner:-.1,veloc:.17,verit:.2,vetu:0,vetus:0,waouh:.3,acre:-.3,apre:-.2,eblou:.2,ebouriff:.45,ecarlat:.01,ecart:-.1,ecarte:-.1,eclair:.6,eclaire:.6,eclat:.4,ecoeur:.2,econom:.1,ecras:-.2,ecrase:-.2,edifi:0,egal:.2,egar:-.2,egare:-.2,egoist:-.7,elanc:0,elance:0,elast:.05,electr:-.15,eloign:-.05,eloigne:-.05,eleg:.7,elementair:.1,elephantesqu:.05,emeraud:0,eminent:.07,emouss:-.3,emousse:-.3,emouv:.4,emu:.1,emus:.1,emech:-.25,emeche:-.25,enigmat:.1,enorm:.22,epais:.06,epaiss:.06,epanou:.28,epanoui:.28,epar:-.1,epars:-.1,epat:.43,ephemer:0,epouvant:-.7,eprouv:.3,eprouve:.3,epuis:-.6,epuise:-.6,equilibr:.15,equilibre:.15,equip:-.1,equit:.11,equivalent:.05,equivoqu:-.12,erot:.2,esoter:.18,eteint:-.4,etendu:.05,etendus:.05,eternel:.1,ether:.09,ethere:.09,etincel:.3,eton:.4,etonne:.4,etrang:-.5,etranger:-.2,etriqu:.05,etrique:.05,etroit:-.25,evacu:-.15,evacue:-.15,evanou:-.03,evanoui:-.03,evas:-.2,eventuel:0,evident:.1}});var Oh=Q((Ok,Py)=>{Py.exports={words:[]}});var su=Q((Bk,Bh)=>{"use strict";var My=Mh(),Oy=Oh();Bh.exports={afinn:void 0,pattern:My,senticon:void 0,negations:Oy,stemmed:!0}});var Wh=Q((Lk,Lh)=>{"use strict";function By(i){let t=i.get("Language");t&&t.addModel("Latin","fra"," dees de ionnt et tio etent lala e don ne oite lle  les de pt datiroi drdroit  \xE0  cot\xE9 ns te e smenre  tocon l\u2019touque qules sodesson peons uns ls e prue  pae ct lts onn aue aemee e liontantoututet \xE0resers sace  a trepera dctier libit\xE9 enux  reen rso\xE0 l ou inlleun natou nnen dune d\u2019 separnteus ur s sansdana pr lproits\xE9s t piree ts psa  d\xE9ond\xE9 da lnceertauxommnalme  na foiqu cert\xE9ectalebert as a dammeibesane r pocomal s cquiourt e nee nousr daliter difone oau  chairui ell eslits niss\xE9ratessocautoci\xEAtrienintdu est\xE9t\xE9trapou plratar ranrais oonaaincla\xE9gaancrs eurprin ce ms t\xE0 u dourebreut  \xEAtage \xE9tnsisureinsenserndiensessntrir  macian pst a c dul e sublige r\xE9s r\xE9e qassndapeu\xE9e l\u2019a tea statil t\xE9saisu dineind\xE9 equ\u2019 acs in tt cn al\u2019ht qsoit scunrit \xE9goir\u2019enntahom onn e moie ignrelnnat il n trillples \xE9l\u2019ereca rotesseuniid\xE9ives ut \xEAinsact fan s vigal asligssapr\xE9leue flicdisver nutenssirottecs mabl")}Lh.exports=By});var qh=Q((Wk,zh)=>{"use strict";var Ly=tu(),Wy=nu(),zy=iu(),qy=au(),Vy=su(),Uy=Wh(),uu=class{register(t){t.use(Ly),t.use(Wy),t.use(zy),t.use(qy),t.register("sentiment-fr",Vy),Uy(t)}};zh.exports=uu});var Uh=Q((zk,Vh)=>{"use strict";var jy=qh(),Gy=tu(),Hy=nu(),Ky=iu(),Xy=au(),$y=su();Vh.exports={LangFr:jy,StemmerFr:Hy,StopwordsFr:Ky,TokenizerFr:Gy,NormalizerFr:Xy,SentimentFr:$y}});var $h=Q(()=>{"use strict"});var Jh=Q((Fr,Yh)=>{"use strict";Yh.exports=Fr=window.fetch;Fr.default=window.fetch.bind(window);Fr.Headers=window.Headers;Fr.Request=window.Request;Fr.Response=window.Response});var Qh=Q(()=>{"use strict"});var Gh=ja(rt()),Hh=ja(Rh()),Kh=ja(Uh());var Xh=(()=>{class i{constructor(){this.isTrained=!1,this.processingSubject=new Ga(!1),this.responseSubject=new Ga(""),this.initializeNlp()}initializeNlp(){return K(this,null,function*(){try{let e=yield(0,Gh.containerBootstrap)();e.use(Hh.Nlp),e.use(Kh.LangFr),this.nlp=e.get("nlp"),this.nlp.settings.autoSave=!1,this.nlp.addLanguage("fr"),this.nlp.addDocument("fr","au revoir pour l'instant","greetings.bye"),this.nlp.addDocument("fr","au revoir et soyez prudent","greetings.bye"),this.nlp.addDocument("fr","tr\xE8s bien \xE0 plus tard","greetings.bye"),this.nlp.addDocument("fr","je dois partir","greetings.bye"),this.nlp.addDocument("fr","Salut","greetings.hello"),this.nlp.addDocument("fr","Bonjour","greetings.hello"),this.nlp.addDocument("fr","Coucou","greetings.hello"),this.nlp.addDocument("fr","je suis content","emotion.joie"),this.nlp.addDocument("fr","je suis heureux","emotion.joie"),this.nlp.addDocument("fr","je me sens bien aujourd'hui","emotion.joie"),this.nlp.addDocument("fr","quelle belle journ\xE9e","emotion.joie"),this.nlp.addDocument("fr","je suis de bonne humeur","emotion.joie"),this.nlp.addDocument("fr","je suis triste","emotion.tristesse"),this.nlp.addDocument("fr","je me sens d\xE9prim\xE9","emotion.tristesse"),this.nlp.addDocument("fr","je ne vais pas bien","emotion.tristesse"),this.nlp.addDocument("fr","je suis malheureux","emotion.tristesse"),this.nlp.addDocument("fr","quelle journ\xE9e difficile","emotion.tristesse"),this.nlp.addDocument("fr","je suis en col\xE8re","emotion.colere"),this.nlp.addDocument("fr","je suis \xE9nerv\xE9","emotion.colere"),this.nlp.addDocument("fr","\xE7a m'agace","emotion.colere"),this.nlp.addDocument("fr","je suis frustr\xE9","emotion.colere"),this.nlp.addDocument("fr","je suis furieux","emotion.colere"),this.nlp.addDocument("fr","je suis surpris","emotion.surprise"),this.nlp.addDocument("fr","incroyable","emotion.surprise"),this.nlp.addDocument("fr","je ne m'y attendais pas","emotion.surprise"),this.nlp.addDocument("fr","quelle surprise","emotion.surprise"),this.nlp.addDocument("fr","c'est \xE9tonnant","emotion.surprise"),this.nlp.addDocument("fr","mon patron m'a f\xE9licit\xE9","situation.travail.positif"),this.nlp.addDocument("fr","j'ai eu une promotion","situation.travail.positif"),this.nlp.addDocument("fr","j'ai r\xE9ussi mon projet","situation.travail.positif"),this.nlp.addDocument("fr","mon \xE9quipe est g\xE9niale","situation.travail.positif"),this.nlp.addDocument("fr","mon patron m'a critiqu\xE9","situation.travail.negatif"),this.nlp.addDocument("fr","j'ai rat\xE9 mon entretien","situation.travail.negatif"),this.nlp.addDocument("fr","mon projet a \xE9chou\xE9","situation.travail.negatif"),this.nlp.addDocument("fr","je d\xE9teste mon travail","situation.travail.negatif"),this.nlp.addDocument("fr","l'ambiance au bureau est tendue","situation.travail.negatif"),this.nlp.addDocument("fr","j'ai rencontr\xE9 quelqu'un de sp\xE9cial","situation.relation.positif"),this.nlp.addDocument("fr","mon ami m'a offert un cadeau","situation.relation.positif"),this.nlp.addDocument("fr","nous avons pass\xE9 un bon moment ensemble","situation.relation.positif"),this.nlp.addDocument("fr","ma famille me soutient","situation.relation.positif"),this.nlp.addDocument("fr","nous nous sommes disput\xE9s","situation.relation.negatif"),this.nlp.addDocument("fr","mon ami m'a trahi","situation.relation.negatif"),this.nlp.addDocument("fr","je me sens seul","situation.relation.negatif"),this.nlp.addDocument("fr","personne ne me comprend","situation.relation.negatif"),this.nlp.addDocument("fr","je me sens en pleine forme","situation.sante.positif"),this.nlp.addDocument("fr","j'ai commenc\xE9 un nouveau r\xE9gime","situation.sante.positif"),this.nlp.addDocument("fr","mes analyses sont bonnes","situation.sante.positif"),this.nlp.addDocument("fr","j'ai perdu du poids","situation.sante.positif"),this.nlp.addDocument("fr","je suis malade","situation.sante.negatif"),this.nlp.addDocument("fr","j'ai mal partout","situation.sante.negatif"),this.nlp.addDocument("fr","je n'arrive pas \xE0 dormir","situation.sante.negatif"),this.nlp.addDocument("fr","je me sens fatigu\xE9 constamment","situation.sante.negatif"),this.nlp.addDocument("fr","je suis content de ma promotion","emotion.joie.travail"),this.nlp.addDocument("fr","je suis heureux dans mon nouveau poste","emotion.joie.travail"),this.nlp.addDocument("fr","je suis triste d'avoir rat\xE9 mon entretien","emotion.tristesse.travail"),this.nlp.addDocument("fr","je suis furieux contre mon patron","emotion.colere.travail"),this.nlp.addDocument("fr","je suis content d'avoir rencontr\xE9 cette personne","emotion.joie.relation"),this.nlp.addDocument("fr","je suis heureux en couple","emotion.joie.relation"),this.nlp.addDocument("fr","je suis triste de notre rupture","emotion.tristesse.relation"),this.nlp.addDocument("fr","je suis en col\xE8re contre mon ami","emotion.colere.relation"),this.nlp.addDocument("fr","je suis content d'\xEAtre en bonne sant\xE9","emotion.joie.sante"),this.nlp.addDocument("fr","je suis triste de ma condition physique","emotion.tristesse.sante"),this.nlp.addDocument("fr","je suis frustr\xE9 par ma maladie","emotion.colere.sante"),this.nlp.addAnswer("fr","greetings.bye","\xE0 la prochaine"),this.nlp.addAnswer("fr","greetings.bye","\xE0 bient\xF4t!"),this.nlp.addAnswer("fr","greetings.hello","salut comment ca va!"),this.nlp.addAnswer("fr","greetings.hello","salutations!"),this.nlp.addAnswer("fr","emotion.joie","Je suis ravi que vous soyez content!"),this.nlp.addAnswer("fr","emotion.joie","C'est g\xE9nial de vous voir heureux aujourd'hui!"),this.nlp.addAnswer("fr","emotion.joie","Excellente nouvelle, continuez comme \xE7a!"),this.nlp.addAnswer("fr","emotion.tristesse","Je suis d\xE9sol\xE9 que vous vous sentiez triste."),this.nlp.addAnswer("fr","emotion.tristesse","\xC7a va aller mieux, gardez espoir."),this.nlp.addAnswer("fr","emotion.tristesse","Parfois parler \xE0 quelqu'un peut aider dans ces moments difficiles."),this.nlp.addAnswer("fr","emotion.colere","Je comprends votre frustration."),this.nlp.addAnswer("fr","emotion.colere","Prenez un moment pour respirer profond\xE9ment."),this.nlp.addAnswer("fr","emotion.colere","Exprimez ce qui vous pr\xE9occupe, \xE7a peut soulager."),this.nlp.addAnswer("fr","emotion.surprise","C'est en effet surprenant!"),this.nlp.addAnswer("fr","emotion.surprise","La vie est pleine de surprises, n'est-ce pas?"),this.nlp.addAnswer("fr","emotion.surprise","Je comprends votre \xE9tonnement!"),this.nlp.addAnswer("fr","situation.travail.positif","F\xE9licitations pour cette r\xE9ussite professionnelle!"),this.nlp.addAnswer("fr","situation.travail.positif","Votre travail acharn\xE9 a port\xE9 ses fruits!"),this.nlp.addAnswer("fr","situation.travail.positif","C'est une excellente nouvelle pour votre carri\xE8re!"),this.nlp.addAnswer("fr","situation.travail.negatif","Ne vous d\xE9couragez pas, c'est une exp\xE9rience d'apprentissage."),this.nlp.addAnswer("fr","situation.travail.negatif","Parfois les d\xE9fis professionnels nous rendent plus forts."),this.nlp.addAnswer("fr","situation.travail.negatif","Avez-vous envisag\xE9 d'en parler avec un coll\xE8gue de confiance?"),this.nlp.addAnswer("fr","situation.relation.positif","Les relations \xE9panouissantes sont pr\xE9cieuses!"),this.nlp.addAnswer("fr","situation.relation.positif","C'est merveilleux d'avoir des personnes qui vous soutiennent."),this.nlp.addAnswer("fr","situation.relation.positif","Ch\xE9rissez ces moments sp\xE9ciaux!"),this.nlp.addAnswer("fr","situation.relation.negatif","Les relations peuvent \xEAtre compliqu\xE9es parfois."),this.nlp.addAnswer("fr","situation.relation.negatif","Prenez le temps de r\xE9fl\xE9chir \xE0 ce qui est important pour vous."),this.nlp.addAnswer("fr","situation.relation.negatif","Une communication ouverte pourrait peut-\xEAtre aider?"),this.nlp.addAnswer("fr","situation.sante.positif","La sant\xE9 est notre bien le plus pr\xE9cieux!"),this.nlp.addAnswer("fr","situation.sante.positif","Continuez sur cette bonne voie!"),this.nlp.addAnswer("fr","situation.sante.positif","Prendre soin de soi est toujours un bon investissement."),this.nlp.addAnswer("fr","situation.sante.negatif","Prenez le temps de vous reposer."),this.nlp.addAnswer("fr","situation.sante.negatif","Avez-vous consult\xE9 un professionnel de sant\xE9?"),this.nlp.addAnswer("fr","situation.sante.negatif","La sant\xE9 fluctue, gardez espoir d'une am\xE9lioration."),this.nlp.addAnswer("fr","emotion.joie.travail","Votre bonheur au travail est m\xE9rit\xE9! Profitez de cette belle r\xE9ussite professionnelle."),this.nlp.addAnswer("fr","emotion.joie.travail","C'est formidable de vous voir \xE9panoui dans votre carri\xE8re!"),this.nlp.addAnswer("fr","emotion.tristesse.travail","Les difficult\xE9s professionnelles sont temporaires. Gardez confiance en vos comp\xE9tences."),this.nlp.addAnswer("fr","emotion.tristesse.travail","C'est normal de se sentir abattu apr\xE8s un revers professionnel. Prenez le temps de vous ressourcer."),this.nlp.addAnswer("fr","emotion.colere.travail","La frustration au travail est compr\xE9hensible. Peut-\xEAtre pourriez-vous en discuter avec un responsable?"),this.nlp.addAnswer("fr","emotion.colere.travail","Respirez profond\xE9ment et essayez d'identifier pr\xE9cis\xE9ment ce qui vous contrarie au travail."),this.nlp.addAnswer("fr","emotion.joie.relation","Les relations \xE9panouissantes sont une source de bonheur inestimable!"),this.nlp.addAnswer("fr","emotion.joie.relation","Votre bonheur relationnel est contagieux, c'est merveilleux!"),this.nlp.addAnswer("fr","emotion.tristesse.relation","Les peines de c\u0153ur sont douloureuses, mais vous n'\xEAtes pas seul face \xE0 cette \xE9preuve."),this.nlp.addAnswer("fr","emotion.tristesse.relation","Accordez-vous le temps de gu\xE9rir, les blessures relationnelles demandent de la patience."),this.nlp.addAnswer("fr","emotion.colere.relation","La col\xE8re dans les relations est souvent le signe d'un besoin non exprim\xE9. Avez-vous pu identifier ce besoin?"),this.nlp.addAnswer("fr","emotion.colere.relation","Prenez du recul avant de r\xE9agir sous le coup de l'\xE9motion dans cette situation relationnelle."),this.nlp.addAnswer("fr","emotion.joie.sante","Votre bien-\xEAtre physique est une excellente nouvelle! Continuez \xE0 prendre soin de vous!"),this.nlp.addAnswer("fr","emotion.joie.sante","Se sentir en bonne sant\xE9 est un vrai bonheur, profitez-en pleinement!"),this.nlp.addAnswer("fr","emotion.tristesse.sante","Les d\xE9fis de sant\xE9 peuvent \xEAtre d\xE9courageants, mais chaque petit progr\xE8s compte."),this.nlp.addAnswer("fr","emotion.tristesse.sante","C'est normal de se sentir triste face \xE0 des probl\xE8mes de sant\xE9. Soyez bienveillant envers vous-m\xEAme."),this.nlp.addAnswer("fr","emotion.colere.sante","La frustration face aux probl\xE8mes de sant\xE9 est l\xE9gitime. Avez-vous cherch\xE9 un second avis m\xE9dical?"),this.nlp.addAnswer("fr","emotion.colere.sante","Transformez cette col\xE8re en motivation pour prendre soin de vous diff\xE9remment."),yield this.nlp.train(),this.isTrained=!0,console.log("NLP model trained successfully")}catch(e){throw console.error("Error initializing NLP:",e),e}})}processText(e){return K(this,null,function*(){if(!this.isTrained)throw new Error("Le mod\xE8le NLP n'est pas encore entra\xEEn\xE9");this.processingSubject.next(!0);try{let n=yield this.nlp.process("fr",e);this.responseSubject.next(n.sentiment?.vote||"Je ne comprends pas votre demande.")}catch(n){console.error("Erreur lors du traitement du texte:",n),this.responseSubject.next("D\xE9sol\xE9, une erreur est survenue.")}finally{this.processingSubject.next(!1)}})}getResponse(){return this.responseSubject.asObservable()}isProcessing(){return this.processingSubject.asObservable()}addIntent(e,n,r){return K(this,null,function*(){if(!this.isTrained)throw new Error("Le mod\xE8le NLP n'est pas encore entra\xEEn\xE9");n.forEach(o=>{this.nlp.addDocument("fr",o,e)}),r.forEach(o=>{this.nlp.addAnswer("fr",e,o)}),yield this.nlp.train()})}getIntent(e){return K(this,null,function*(){if(!this.isTrained)throw new Error("Le mod\xE8le NLP n'est pas encore entra\xEEn\xE9");return(yield this.nlp.process("fr",e)).intent||"unknown"})}getSentiment(e){return K(this,null,function*(){if(!this.isTrained)throw new Error("Le mod\xE8le NLP n'est pas encore entra\xEEn\xE9");return(yield this.nlp.process("fr",e)).sentiment?.score||0})}static{this.\u0275fac=function(n){return new(n||i)}}static{this.\u0275prov=uo({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Op=function(i,t){return(Op=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])})(i,t)};function Qt(i,t){function e(){this.constructor=i}Op(i,t),i.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function te(i,t,e,n){return new(e||(e=Promise))(function(r,o){function a(c){try{u(n.next(c))}catch(l){o(l)}}function s(c){try{u(n.throw(c))}catch(l){o(l)}}function u(c){c.done?r(c.value):new e(function(l){l(c.value)}).then(a,s)}u((n=n.apply(i,t||[])).next())})}function ne(i,t){var e,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function s(u){return function(c){return function(l){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,n&&(r=2&l[0]?n.return:l[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,l[1])).done)return r;switch(n=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(l[0]===6||l[0]===2)){a=0;continue}if(l[0]===3&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(l[0]===6&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(i,a)}catch(f){l=[6,f],n=0}finally{e=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([u,c])}}}var Jy=function(){function i(t){this.global=t,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return i.prototype.setPlatform=function(t,e){this.platform!=null&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+e+"."),this.platformName=t,this.platform=e},i.prototype.registerFlag=function(t,e,n){if(this.flagRegistry[t]={evaluationFn:e,setHook:n},this.urlFlags[t]!=null){var r=this.urlFlags[t];console.warn("Setting feature override from URL "+t+": "+r+"."),this.set(t,r)}},i.prototype.get=function(t){return t in this.flags?this.flags[t]:(this.flags[t]=this.evaluateFlag(t),this.flags[t])},i.prototype.getNumber=function(t){return this.get(t)},i.prototype.getBool=function(t){return this.get(t)},i.prototype.getFlags=function(){return this.flags},Object.defineProperty(i.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),i.prototype.set=function(t,e){if(this.flagRegistry[t]==null)throw new Error("Cannot set flag "+t+" as it has not been registered.");this.flags[t]=e,this.flagRegistry[t].setHook!=null&&this.flagRegistry[t].setHook(e)},i.prototype.evaluateFlag=function(t){if(this.flagRegistry[t]==null)throw new Error("Cannot evaluate flag '"+t+"': no evaluation function found.");return this.flagRegistry[t].evaluationFn()},i.prototype.setFlags=function(t){this.flags=Object.assign({},t)},i.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},i.prototype.populateURLFlags=function(){var t=this;if(this.global!==void 0&&this.global.location!==void 0&&this.global.location.search!==void 0){var e,n,r=(e=this.global.location.search,n={},e.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(o){for(var a=[],s=1;s<arguments.length;s++)a[s-1]=arguments[s];return Qy(n,a[0],a[1]),a.join("=")}),n);"tfjsflags"in r&&r.tfjsflags.split(",").forEach(function(o){var a=o.split(":"),s=a[0],u=a[1];t.urlFlags[s]=function(c,l){if((l=l.toLowerCase())==="true"||l==="false")return l==="true";if(""+ +l===l)return+l;throw new Error("Could not parse value flag value "+l+" for flag "+c+".")}(s,u)})}},i}();function Qy(i,t,e){i[decodeURIComponent(t)]=decodeURIComponent(e||"")}function O(){return Bp}var Bp=null,Bo=new Map,Ru=new Map;function Lp(i,t){var e=zp(i,t);return Bo.get(e)}function Zy(i){return Ru.get(i)}function Zh(i){for(var t=Bo.entries(),e=[];;){var n=t.next(),r=n.done,o=n.value;if(r)break;var a=o[0],s=o[1];a.split("_")[0]===i&&e.push(s)}return e}function Wp(i){var t=i.kernelName,e=i.backendName,n=zp(t,e);if(Bo.has(n))throw new Error("The kernel '"+t+"' for backend '"+e+"' is already registered");Bo.set(n,i)}function ex(i){var t=i.kernelName;Ru.has(t)&&console.warn("Overriding the gradient for '"+t+"'"),Ru.set(t,i)}function zp(i,t){return t+"_"+i}function ep(i){for(var t=i.length,e=0,n=0;t>0;)n=Math.random()*t|0,e=i[--t],i[t]=i[n],i[n]=e}function Lo(i,t,e){return Math.max(i,Math.min(t,e))}function Ju(i){return i%2==0?i:i+1}function qp(i){for(var t=0,e=0;e<i.length;e++)t+=i[e];return t}function E(i,t){if(!i)throw new Error(typeof t=="string"?t:t())}function Ae(i,t,e){e===void 0&&(e=""),E(Je(i,t),function(){return e+" Shapes "+i+" and "+t+" must match"})}function fr(i){E(i!=null,function(){return"The input to the tensor constructor must be a non-null value."})}function Dn(i,t,e){if(t===void 0&&(t=[]),e===void 0&&(e=!1),t==null&&(t=[]),Array.isArray(i)||dt(i)&&!e)for(var n=0;n<i.length;++n)Dn(i[n],t,e);else t.push(i);return t}function re(i){if(i.length===0)return 1;for(var t=i[0],e=1;e<i.length;e++)t*=i[e];return t}function Je(i,t){if(i===t)return!0;if(i==null||t==null||i.length!==t.length)return!1;for(var e=0;e<i.length;e++)if(i[e]!==t[e])return!1;return!0}function Ge(i){return i%1==0}function Vp(i){if(Math.tanh!=null)return Math.tanh(i);if(i===1/0)return 1;if(i===-1/0)return-1;var t=Math.exp(2*i);return(t-1)/(t+1)}function Wo(i){var t=Math.ceil(Math.sqrt(i));return[t,Math.ceil(i/t)]}function or(i,t){return t<=i.length?i:i+" ".repeat(t-i.length)}function Iu(i,t,e){return t===void 0&&(t=function(n){return 0}),new Promise(function(n,r){var o=0,a=function(){if(i())n();else{o++;var s=t(o);e!=null&&o>=e?r():setTimeout(a,s)}};a()})}function Up(i,t){for(var e=1,n=-1,r=0;r<i.length;++r)if(i[r]>=0)e*=i[r];else if(i[r]===-1){if(n!==-1)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+n+" and dim "+r);n=r}else if(i[r]<0)throw Error("Shapes can not be < 0. Found "+i[r]+" at dim "+r);if(n===-1){if(t>0&&t!==e)throw Error("Size("+t+") must match the product of shape "+i);return i}if(e===0)throw Error("Cannot infer the missing size in ["+i+"] when there are 0 elements");if(t%e!=0)throw Error("The implicit shape can't be a fractional number. Got "+t+" / "+e);var o=i.slice();return o[n]=t/e,o}function Ze(i,t){var e=t.length;return E((i=i==null?t.map(function(n,r){return r}):[].concat(i)).every(function(n){return n>=-e&&n<e}),function(){return"All values in axis param must be in range [-"+e+", "+e+") but got axis "+i}),E(i.every(function(n){return Ge(n)}),function(){return"All values in axis param must be integers but got axis "+i}),i.map(function(n){return n<0?e+n:n})}function qn(i,t){for(var e=[],n=[],r=t!=null&&Array.isArray(t)&&t.length===0,o=t==null||r?null:Ze(t,i).sort(),a=0,s=0;s<i.length;++s){if(o!=null){if(o[a]===s&&i[s]!==1)throw new Error("Can't squeeze axis "+s+" since its dim '"+i[s]+"' is not 1");(o[a]==null||o[a]>s)&&i[s]===1&&(e.push(i[s]),n.push(s)),o[a]<=s&&a++}i[s]!==1&&(e.push(i[s]),n.push(s))}return{newShape:e,keptDims:n}}function qr(i,t){var e=null;if(i==null||i==="float32")e=new Float32Array(t);else if(i==="int32")e=new Int32Array(t);else{if(i!=="bool")throw new Error("Unknown data type "+i);e=new Uint8Array(t)}return e}function ki(i,t){var e=null;if(i==null||i==="float32")e=new Float32Array(t);else if(i==="int32")e=new Int32Array(t);else if(i==="bool")e=new Uint8Array(t);else{if(i!=="string")throw new Error("Unknown data type "+i);e=new Array(t)}return e}function jp(i,t){for(var e=0;e<i.length;e++){var n=i[e];if(isNaN(n)||!isFinite(n))throw Error("A tensor of type "+t+" being uploaded contains "+n+".")}}function Gp(i){return i==="bool"||i==="complex64"||i==="float32"||i==="int32"||i==="string"}function Hp(i,t){return t!=="complex64"&&(t!=="float32"||i==="complex64")&&(t!=="int32"||i==="float32"||i==="complex64")&&(t!=="bool"||i!=="bool")}function dt(i){return i instanceof Float32Array||i instanceof Int32Array||i instanceof Uint8Array}function Qu(i){if(i==="float32"||i==="int32")return 4;if(i==="complex64")return 8;if(i==="bool")return 1;throw new Error("Unknown dtype "+i)}function Kp(i){if(i==null)return 0;var t=0;return i.forEach(function(e){return t+=e.length}),t}function Vn(i){return typeof i=="string"||i instanceof String}function Xp(i){return typeof i=="boolean"}function $p(i){return typeof i=="number"}function Ur(i){return Array.isArray(i)?Ur(i[0]):i instanceof Float32Array?"float32":i instanceof Int32Array||i instanceof Uint8Array?"int32":$p(i)?"float32":Vn(i)?"string":Xp(i)?"bool":"float32"}function zo(i){return!!(i&&i.constructor&&i.call&&i.apply)}function qo(i,t){for(var e=t;e<i;++e)if(i%e==0)return e;return i}function Yt(i){var t=i.length;if(t<2)return[];var e=new Array(t-1);e[t-2]=i[t-1];for(var n=t-3;n>=0;--n)e[n]=e[n+1]*i[n+1];return e}function Zu(i,t,e){if(t==="string")throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(i)&&(i=Dn(i)),e&&jp(i,t),function(o,a){return o instanceof Float32Array&&a==="float32"||o instanceof Int32Array&&a==="int32"||o instanceof Uint8Array&&a==="bool"}(i,t))return i;if(t==null||t==="float32"||t==="complex64")return new Float32Array(i);if(t==="int32")return new Int32Array(i);if(t==="bool"){for(var n=new Uint8Array(i.length),r=0;r<n.length;++r)Math.round(i[r])!==0&&(n[r]=1);return n}throw new Error("Unknown data type "+t)}function Tu(i,t){if(i.length===0)return t[0];var e=i.reduce(function(n,r){return n*r});if(e===0)return[];if(e!==t.length)throw new Error("["+i+"] does not match the input size.");return function n(r,o,a){var s=new Array;if(o.length===1)for(var u=o[0],c=0;c<u;c++)s[c]=a[r+c];else{u=o[0];var l=o.slice(1),f=l.reduce(function(h,p){return h*p});for(c=0;c<u;c++)s[c]=n(r+c*f,l,a)}return s}(0,i,t)}function ec(i,t){for(var e=jr(i,t),n=0;n<e.length;n++)e[n]=1;return e}function jr(i,t){if(t==null||t==="float32"||t==="complex64")return new Float32Array(i);if(t==="int32")return new Int32Array(i);if(t==="bool")return new Uint8Array(i);throw new Error("Unknown data type "+t)}function $t(){return O().platform.now()}function tc(i){i.forEach(function(t){E(Number.isInteger(t)&&t>=0,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+i+"]."})})}function Yp(i,t){return t===void 0&&(t="utf-8"),t=t||"utf-8",O().platform.encode(i,t)}function Di(i,t){return t===void 0&&(t="utf-8"),t=t||"utf-8",O().platform.decode(i,t)}function Nu(i,t,e){if(t===0)return 0;if(t===1)return i[0];for(var n=i[i.length-1],r=0;r<i.length-1;++r)n+=e[r]*i[r];return n}function Jp(i,t,e){if(t===0)return[];if(t===1)return[i];for(var n=new Array(t),r=0;r<n.length-1;++r)n[r]=Math.floor(i/e[r]),i-=n[r]*e[r];return n[n.length-1]=i,n}var Kk=Object.freeze({shuffle:ep,clamp:Lo,nearestLargerEven:Ju,sum:qp,randUniform:function(i,t){var e=Math.random();return t*e+(1-e)*i},distSquared:function(i,t){for(var e=0,n=0;n<i.length;n++){var r=Number(i[n])-Number(t[n]);e+=r*r}return e},assert:E,assertShapesMatch:Ae,assertNonNull:fr,flatten:Dn,sizeFromShape:re,isScalarShape:function(i){return i.length===0},arraysEqual:Je,isInt:Ge,tanh:Vp,sizeToSquarishShape:Wo,createShuffledIndices:function(i){for(var t=new Uint32Array(i),e=0;e<i;++e)t[e]=e;return ep(t),t},rightPad:or,repeatedTry:Iu,inferFromImplicitShape:Up,parseAxisParam:Ze,squeezeShape:qn,getTypedArrayFromDType:qr,getArrayFromDType:ki,checkConversionForErrors:jp,isValidDtype:Gp,hasEncodingLoss:Hp,isTypedArray:dt,bytesPerElement:Qu,bytesFromStringArray:Kp,isString:Vn,isBoolean:Xp,isNumber:$p,inferDtype:Ur,isFunction:zo,nearestDivisor:qo,computeStrides:Yt,toTypedArray:Zu,toNestedArray:Tu,makeOnesTypedArray:ec,makeZerosTypedArray:jr,now:$t,assertNonNegativeIntegerDimensions:tc,fetch:function(i,t){return O().platform.fetch(i,t)},encodeString:Yp,decodeString:Di,locToIndex:Nu,indexToLoc:Jp}),tx=function(){function i(t,e){this.backendTimer=t,this.logger=e,e==null&&(this.logger=new nx)}return i.prototype.profileKernel=function(t,e,n){var r,o=this,a=this.backendTimer.time(function(){r=n()});return r.forEach(function(s){s.data().then(function(u){(function(c,l,f){if(l!=="float32")return!1;for(var h=0;h<c.length;h++){var p=c[h];if(isNaN(p)||!isFinite(p))return console.warn("Found "+p+" in the result of '"+f+"'"),!0}})(u,s.dtype,t),a.then(function(c){var l="";c.getExtraProfileInfo!=null&&(l=c.getExtraProfileInfo()),o.logger.logKernelProfile(t,s,u,c.kernelMs,e,l)})})}),r},i}(),nx=function(){function i(){}return i.prototype.logKernelProfile=function(t,e,n,r,o,a){var s=typeof r=="number"?or(r+"ms",9):r.error,u=or(t,25),c=e.rank,l=e.size,f=or(e.shape.toString(),14),h="";for(var p in o){var d=o[p].shape||e.shape,m=d.length;h+=p+": "+m+"D "+(m>0?d:"")+" "}console.log("%c"+u+"	%c"+s+"	%c"+c+"D "+f+"	%c"+l+"	%c"+h+"	%c"+a,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},i}(),tp=20,vi=3,cu=7;function rx(i,t,e,n){var r=Yt(t),o=function(c,l,f,h){var p=re(l),d=h[h.length-1],m=new Array(d).fill(0),v=l.length,g=f==="complex64"?yi(c):c;if(v>1)for(var x=0;x<p/d;x++)for(var w=x*d,y=0;y<d;y++)m[y]=Math.max(m[y],gi(g[w+y],0,f).length);return m}(i,t,e,r),a=t.length,s=function c(l,f,h,p,d,m){m===void 0&&(m=!0);var v=h==="complex64"?2:1,g=f[0],x=f.length;if(x===0)return h==="complex64"?[gi(yi(l)[0],0,h)]:h==="bool"?[Qp(l[0])]:[l[0].toString()];if(x===1){if(g>tp){var w=vi*v,y=Array.from(l.slice(0,w)),b=Array.from(l.slice((g-vi)*v,g*v));return h==="complex64"&&(y=yi(y),b=yi(b)),["["+y.map(function(L,V){return gi(L,d[V],h)}).join(", ")+", ..., "+b.map(function(L,V){return gi(L,d[g-vi+V],h)}).join(", ")+"]"]}return["["+(h==="complex64"?yi(l):Array.from(l)).map(function(L,V){return gi(L,d[V],h)}).join(", ")+"]"]}var C=f.slice(1),S=p.slice(1),A=p[0]*v,k=[];if(g>tp){for(var D=0;D<vi;D++){var T=(I=D*A)+A;k.push.apply(k,c(l.slice(I,T),C,h,S,d,!1))}for(k.push("..."),D=g-vi;D<g;D++)T=(I=D*A)+A,k.push.apply(k,c(l.slice(I,T),C,h,S,d,D===g-1))}else for(D=0;D<g;D++){var I;T=(I=D*A)+A,k.push.apply(k,c(l.slice(I,T),C,h,S,d,D===g-1))}var W=x===2?",":"";for(k[0]="["+k[0]+W,D=1;D<k.length-1;D++)k[D]=" "+k[D]+W;var B=`,
`;for(D=2;D<x;D++)B+=`
`;return k[k.length-1]=" "+k[k.length-1]+"]"+(m?"":B),k}(i,t,e,r,o),u=["Tensor"];return n&&(u.push("  dtype: "+e),u.push("  rank: "+a),u.push("  shape: ["+t+"]"),u.push("  values:")),u.push(s.map(function(c){return"    "+c}).join(`
`)),u.join(`
`)}function gi(i,t,e){return or(Array.isArray(i)?parseFloat(i[0].toFixed(cu))+" + "+parseFloat(i[1].toFixed(cu))+"j":Vn(i)?"'"+i+"'":e==="bool"?Qp(i):parseFloat(i.toFixed(cu)).toString(),t)}function Qp(i){return i===0?"false":"true"}function yi(i){for(var t=[],e=0;e<i.length;e+=2)t.push([i[e],i[e+1]]);return t}var Si=function(){function i(t,e,n){var r=this;if(this.dtype=e,this.shape=t.slice(),this.size=re(t),n!=null){var o=n.length;E(o===this.size,function(){return"Length of values '"+o+"' does not match the size inferred by the shape '"+r.size+"'."})}if(e==="complex64")throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=n||ki(e,this.size),this.strides=Yt(t)}return i.prototype.set=function(t){for(var e=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];n.length===0&&(n=[0]),E(n.length===this.rank,function(){return"The number of provided coordinates ("+n.length+") must match the rank ("+e.rank+")"});var o=this.locToIndex(n);this.values[o]=t},i.prototype.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];t.length===0&&(t=[0]);for(var n=0,r=0,o=t;r<o.length;r++){var a=o[r];if(a<0||a>=this.shape[n]){var s="Requested out of range element at "+t+".   Buffer shape="+this.shape;throw new Error(s)}n++}for(var u=t[t.length-1],c=0;c<t.length-1;++c)u+=this.strides[c]*t[c];return this.values[u]},i.prototype.locToIndex=function(t){if(this.rank===0)return 0;if(this.rank===1)return t[0];for(var e=t[t.length-1],n=0;n<t.length-1;++n)e+=this.strides[n]*t[n];return e},i.prototype.indexToLoc=function(t){if(this.rank===0)return[];if(this.rank===1)return[t];for(var e=new Array(this.shape.length),n=0;n<e.length-1;++n)e[n]=Math.floor(t/this.strides[n]),t-=e[n]*this.strides[n];return e[e.length-1]=t,e},Object.defineProperty(i.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),i.prototype.toTensor=function(){return ln().makeTensor(this.values,this.shape,this.dtype)},i}(),ln=null,M=null,Zp=null,Me=function(){function i(t,e,n,r){this.kept=!1,this.isDisposedInternal=!1,this.shape=t.slice(),this.dtype=e||"float32",this.size=re(t),this.strides=Yt(t),this.dataId=n,this.id=r,this.rankType=this.rank<5?this.rank.toString():"higher"}return i.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},i.prototype.asScalar=function(){return this.throwIfDisposed(),E(this.size===1,function(){return"The array must have only 1 element."}),this.reshape([])},i.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},i.prototype.as2D=function(t,e){return this.throwIfDisposed(),this.reshape([t,e])},i.prototype.as3D=function(t,e,n){return this.throwIfDisposed(),this.reshape([t,e,n])},i.prototype.as4D=function(t,e,n,r){return this.throwIfDisposed(),this.reshape([t,e,n,r])},i.prototype.as5D=function(t,e,n,r,o){return this.throwIfDisposed(),this.reshape([t,e,n,r,o])},i.prototype.asType=function(t){return this.throwIfDisposed(),M.cast(this,t)},Object.defineProperty(i.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),i.prototype.buffer=function(){return te(this,void 0,void 0,function(){var t;return ne(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,M.buffer(this.shape,this.dtype,t)]}})})},i.prototype.bufferSync=function(){return M.buffer(this.shape,this.dtype,this.dataSync())},i.prototype.array=function(){return te(this,void 0,void 0,function(){var t;return ne(this,function(e){switch(e.label){case 0:return[4,this.data()];case 1:return t=e.sent(),[2,Tu(this.shape,t)]}})})},i.prototype.arraySync=function(){return Tu(this.shape,this.dataSync())},i.prototype.data=function(){return te(this,void 0,void 0,function(){var t,e;return ne(this,function(n){switch(n.label){case 0:return this.throwIfDisposed(),t=ln().read(this.dataId),this.dtype!=="string"?[3,2]:[4,t];case 1:e=n.sent();try{return[2,e.map(function(r){return Di(r)})]}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}n.label=2;case 2:return[2,t]}})})},i.prototype.dataSync=function(){this.throwIfDisposed();var t=ln().readSync(this.dataId);if(this.dtype==="string")try{return t.map(function(e){return Di(e)})}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return t},i.prototype.bytes=function(){return te(this,void 0,void 0,function(){var t;return ne(this,function(e){switch(e.label){case 0:return this.throwIfDisposed(),[4,ln().read(this.dataId)];case 1:return t=e.sent(),this.dtype==="string"?[2,t]:[2,new Uint8Array(t.buffer)]}})})},i.prototype.dispose=function(){this.isDisposed||(ln().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(i.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),i.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},i.prototype.toFloat=function(){return this.asType("float32")},i.prototype.toInt=function(){return this.asType("int32")},i.prototype.toBool=function(){return this.asType("bool")},i.prototype.print=function(t){return t===void 0&&(t=!1),M.print(this,t)},i.prototype.reshape=function(t){return this.throwIfDisposed(),M.reshape(this,t)},i.prototype.reshapeAs=function(t){return this.throwIfDisposed(),this.reshape(t.shape)},i.prototype.expandDims=function(t){return t===void 0&&(t=0),M.expandDims(this,t)},i.prototype.cumsum=function(t,e,n){return t===void 0&&(t=0),e===void 0&&(e=!1),n===void 0&&(n=!1),M.cumsum(this,t,e,n)},i.prototype.squeeze=function(t){return this.throwIfDisposed(),M.squeeze(this,t)},i.prototype.clone=function(){return this.throwIfDisposed(),M.clone(this)},i.prototype.oneHot=function(t,e,n){return this.throwIfDisposed(),M.oneHot(this,t,e,n)},i.prototype.toString=function(t){return t===void 0&&(t=!1),rx(this.dataSync(),this.shape,this.dtype,t)},i.prototype.tile=function(t){return this.throwIfDisposed(),M.tile(this,t)},i.prototype.gather=function(t,e){return e===void 0&&(e=0),this.throwIfDisposed(),M.gather(this,t,e)},i.prototype.matMul=function(t,e,n){return e===void 0&&(e=!1),n===void 0&&(n=!1),this.throwIfDisposed(),M.matMul(this,t,e,n)},i.prototype.dot=function(t){return this.throwIfDisposed(),M.dot(this,t)},i.prototype.norm=function(t,e,n){return t===void 0&&(t="euclidean"),e===void 0&&(e=null),n===void 0&&(n=!1),this.throwIfDisposed(),M.norm(this,t,e,n)},i.prototype.slice=function(t,e){return this.throwIfDisposed(),M.slice(this,t,e)},i.prototype.reverse=function(t){return this.throwIfDisposed(),M.reverse(this,t)},i.prototype.concat=function(t,e){return e===void 0&&(e=0),this.throwIfDisposed(),t instanceof i&&(t=[t]),M.concat([this].concat(t),e)},i.prototype.split=function(t,e){return e===void 0&&(e=0),this.throwIfDisposed(),M.split(this,t,e)},i.prototype.stack=function(t,e){return e===void 0&&(e=0),M.stack([this,t],e)},i.prototype.unstack=function(t){return t===void 0&&(t=0),M.unstack(this,t)},i.prototype.pad=function(t,e){return e===void 0&&(e=0),M.pad(this,t,e)},i.prototype.batchNormalization=function(t,e,n,r,o){return n===void 0&&(n=.001),Zp("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(t,e,o,r,n)},i.prototype.batchNorm=function(t,e,n,r,o){return o===void 0&&(o=.001),this.throwIfDisposed(),M.batchNorm(this,t,e,n,r,o)},i.prototype.all=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.all(this,t,e)},i.prototype.any=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.any(this,t,e)},i.prototype.logSumExp=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.logSumExp(this,t,e)},i.prototype.sum=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.sum(this,t,e)},i.prototype.prod=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.prod(this,t,e)},i.prototype.mean=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.mean(this,t,e)},i.prototype.min=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.min(this,t,e)},i.prototype.max=function(t,e){return t===void 0&&(t=null),e===void 0&&(e=!1),this.throwIfDisposed(),M.max(this,t,e)},i.prototype.argMin=function(t){return t===void 0&&(t=null),this.throwIfDisposed(),M.argMin(this,t)},i.prototype.argMax=function(t){return t===void 0&&(t=null),this.throwIfDisposed(),M.argMax(this,t)},i.prototype.cast=function(t){return this.throwIfDisposed(),M.cast(this,t)},i.prototype.add=function(t){return this.throwIfDisposed(),M.add(this,t)},i.prototype.addStrict=function(t){return this.throwIfDisposed(),M.addStrict(this,t)},i.prototype.atan2=function(t){return this.throwIfDisposed(),M.atan2(this,t)},i.prototype.sub=function(t){return this.throwIfDisposed(),M.sub(this,t)},i.prototype.subStrict=function(t){return this.throwIfDisposed(),M.subStrict(this,t)},i.prototype.pow=function(t){return this.throwIfDisposed(),M.pow(this,t)},i.prototype.powStrict=function(t){return this.throwIfDisposed(),M.powStrict(this,t)},i.prototype.mul=function(t){return this.throwIfDisposed(),M.mul(this,t)},i.prototype.mulStrict=function(t){return this.throwIfDisposed(),M.mulStrict(this,t)},i.prototype.div=function(t){return this.throwIfDisposed(),M.div(this,t)},i.prototype.divNoNan=function(t){return this.throwIfDisposed(),M.divNoNan(this,t)},i.prototype.floorDiv=function(t){return this.throwIfDisposed(),M.floorDiv(this,t)},i.prototype.divStrict=function(t){return this.throwIfDisposed(),M.divStrict(this,t)},i.prototype.minimum=function(t){return this.throwIfDisposed(),M.minimum(this,t)},i.prototype.minimumStrict=function(t){return this.throwIfDisposed(),M.minimumStrict(this,t)},i.prototype.maximum=function(t){return this.throwIfDisposed(),M.maximum(this,t)},i.prototype.maximumStrict=function(t){return this.throwIfDisposed(),M.maximumStrict(this,t)},i.prototype.mod=function(t){return this.throwIfDisposed(),M.mod(this,t)},i.prototype.modStrict=function(t){return this.throwIfDisposed(),M.modStrict(this,t)},i.prototype.squaredDifferenceStrict=function(t){return this.throwIfDisposed(),M.squaredDifferenceStrict(this,t)},i.prototype.transpose=function(t){return this.throwIfDisposed(),M.transpose(this,t)},i.prototype.notEqual=function(t){return this.throwIfDisposed(),M.notEqual(this,t)},i.prototype.notEqualStrict=function(t){return this.throwIfDisposed(),M.notEqualStrict(this,t)},i.prototype.less=function(t){return this.throwIfDisposed(),M.less(this,t)},i.prototype.lessStrict=function(t){return this.throwIfDisposed(),M.lessStrict(this,t)},i.prototype.equal=function(t){return this.throwIfDisposed(),M.equal(this,t)},i.prototype.equalStrict=function(t){return this.throwIfDisposed(),M.equalStrict(this,t)},i.prototype.lessEqual=function(t){return this.throwIfDisposed(),M.lessEqual(this,t)},i.prototype.lessEqualStrict=function(t){return this.throwIfDisposed(),M.lessEqualStrict(this,t)},i.prototype.greater=function(t){return this.throwIfDisposed(),M.greater(this,t)},i.prototype.greaterStrict=function(t){return this.throwIfDisposed(),M.greaterStrict(this,t)},i.prototype.greaterEqual=function(t){return this.throwIfDisposed(),M.greaterEqual(this,t)},i.prototype.greaterEqualStrict=function(t){return this.throwIfDisposed(),M.greaterEqualStrict(this,t)},i.prototype.logicalAnd=function(t){return this.throwIfDisposed(),M.logicalAnd(this,t)},i.prototype.logicalOr=function(t){return this.throwIfDisposed(),M.logicalOr(this,t)},i.prototype.logicalNot=function(){return this.throwIfDisposed(),M.logicalNot(this)},i.prototype.logicalXor=function(t){return this.throwIfDisposed(),M.logicalXor(this,t)},i.prototype.where=function(t,e){return this.throwIfDisposed(),M.where(t,this,e)},i.prototype.neg=function(){return this.throwIfDisposed(),M.neg(this)},i.prototype.ceil=function(){return this.throwIfDisposed(),M.ceil(this)},i.prototype.floor=function(){return this.throwIfDisposed(),M.floor(this)},i.prototype.sign=function(){return this.throwIfDisposed(),M.sign(this)},i.prototype.isNaN=function(){return this.throwIfDisposed(),M.isNaN(this)},i.prototype.isInf=function(){return this.throwIfDisposed(),M.isInf(this)},i.prototype.isFinite=function(){return this.throwIfDisposed(),M.isFinite(this)},i.prototype.exp=function(){return this.throwIfDisposed(),M.exp(this)},i.prototype.expm1=function(){return this.throwIfDisposed(),M.expm1(this)},i.prototype.log=function(){return this.throwIfDisposed(),M.log(this)},i.prototype.log1p=function(){return this.throwIfDisposed(),M.log1p(this)},i.prototype.sqrt=function(){return this.throwIfDisposed(),M.sqrt(this)},i.prototype.rsqrt=function(){return this.throwIfDisposed(),M.rsqrt(this)},i.prototype.square=function(){return this.throwIfDisposed(),M.square(this)},i.prototype.reciprocal=function(){return this.throwIfDisposed(),M.reciprocal(this)},i.prototype.abs=function(){return this.throwIfDisposed(),M.abs(this)},i.prototype.clipByValue=function(t,e){return this.throwIfDisposed(),M.clipByValue(this,t,e)},i.prototype.relu=function(){return this.throwIfDisposed(),M.relu(this)},i.prototype.relu6=function(){return this.throwIfDisposed(),M.relu6(this)},i.prototype.elu=function(){return this.throwIfDisposed(),M.elu(this)},i.prototype.selu=function(){return this.throwIfDisposed(),M.selu(this)},i.prototype.leakyRelu=function(t){return t===void 0&&(t=.2),this.throwIfDisposed(),M.leakyRelu(this,t)},i.prototype.prelu=function(t){return this.throwIfDisposed(),M.prelu(this,t)},i.prototype.sigmoid=function(){return this.throwIfDisposed(),M.sigmoid(this)},i.prototype.logSigmoid=function(){return this.throwIfDisposed(),M.logSigmoid(this)},i.prototype.softplus=function(){return this.throwIfDisposed(),M.softplus(this)},i.prototype.zerosLike=function(){return this.throwIfDisposed(),M.zerosLike(this)},i.prototype.onesLike=function(){return this.throwIfDisposed(),M.onesLike(this)},i.prototype.sin=function(){return this.throwIfDisposed(),M.sin(this)},i.prototype.cos=function(){return this.throwIfDisposed(),M.cos(this)},i.prototype.tan=function(){return this.throwIfDisposed(),M.tan(this)},i.prototype.asin=function(){return this.throwIfDisposed(),M.asin(this)},i.prototype.acos=function(){return this.throwIfDisposed(),M.acos(this)},i.prototype.atan=function(){return this.throwIfDisposed(),M.atan(this)},i.prototype.sinh=function(){return this.throwIfDisposed(),M.sinh(this)},i.prototype.cosh=function(){return this.throwIfDisposed(),M.cosh(this)},i.prototype.tanh=function(){return this.throwIfDisposed(),M.tanh(this)},i.prototype.asinh=function(){return this.throwIfDisposed(),M.asinh(this)},i.prototype.acosh=function(){return this.throwIfDisposed(),M.acosh(this)},i.prototype.atanh=function(){return this.throwIfDisposed(),M.atanh(this)},i.prototype.erf=function(){return this.throwIfDisposed(),M.erf(this)},i.prototype.round=function(){return this.throwIfDisposed(),M.round(this)},i.prototype.step=function(t){return t===void 0&&(t=0),this.throwIfDisposed(),M.step(this,t)},i.prototype.softmax=function(t){return t===void 0&&(t=-1),this.throwIfDisposed(),M.softmax(this,t)},i.prototype.logSoftmax=function(t){return t===void 0&&(t=-1),this.throwIfDisposed(),M.logSoftmax(this,t)},i.prototype.resizeBilinear=function(t,e){return e===void 0&&(e=!1),this.throwIfDisposed(),M.image.resizeBilinear(this,t,e)},i.prototype.resizeNearestNeighbor=function(t,e){return e===void 0&&(e=!1),this.throwIfDisposed(),M.image.resizeNearestNeighbor(this,t,e)},i.prototype.conv1d=function(t,e,n,r,o,a){return r===void 0&&(r="NWC"),o===void 0&&(o=1),this.throwIfDisposed(),M.conv1d(this,t,e,n,r,o,a)},i.prototype.conv2d=function(t,e,n,r,o,a){return r===void 0&&(r="NHWC"),o===void 0&&(o=[1,1]),this.throwIfDisposed(),M.conv2d(this,t,e,n,r,o,a)},i.prototype.conv2dTranspose=function(t,e,n,r,o){return this.throwIfDisposed(),M.conv2dTranspose(this,t,e,n,r,o)},i.prototype.depthwiseConv2D=function(t,e,n,r,o,a){return r===void 0&&(r="NHWC"),o===void 0&&(o=[1,1]),this.throwIfDisposed(),M.depthwiseConv2d(this,t,e,n,r,o,a)},i.prototype.separableConv2d=function(t,e,n,r,o,a){return o===void 0&&(o=[1,1]),a===void 0&&(a="NHWC"),this.throwIfDisposed(),M.separableConv2d(this,t,e,n,r,o,a)},i.prototype.avgPool=function(t,e,n,r){return this.throwIfDisposed(),M.avgPool(this,t,e,n,r)},i.prototype.maxPool=function(t,e,n,r){return this.throwIfDisposed(),M.maxPool(this,t,e,n,r)},i.prototype.localResponseNormalization=function(t,e,n,r){return t===void 0&&(t=5),e===void 0&&(e=1),n===void 0&&(n=1),r===void 0&&(r=.5),M.localResponseNormalization(this,t,e,n,r)},i.prototype.pool=function(t,e,n,r,o){return this.throwIfDisposed(),M.pool(this,t,e,n,r,o)},i.prototype.variable=function(t,e,n){return t===void 0&&(t=!0),this.throwIfDisposed(),ln().makeVariable(this,t,e,n)},i.prototype.unsortedSegmentSum=function(t,e){return this.throwIfDisposed(),M.unsortedSegmentSum(this,t,e)},i.prototype.batchToSpaceND=function(t,e){return this.throwIfDisposed(),M.batchToSpaceND(this,t,e)},i.prototype.spaceToBatchND=function(t,e){return this.throwIfDisposed(),M.spaceToBatchND(this,t,e)},i.prototype.topk=function(t,e){return t===void 0&&(t=1),e===void 0&&(e=!0),this.throwIfDisposed(),M.topk(this,t,e)},i.prototype.stridedSlice=function(t,e,n,r,o,a,s,u){return r===void 0&&(r=0),o===void 0&&(o=0),a===void 0&&(a=0),s===void 0&&(s=0),u===void 0&&(u=0),this.throwIfDisposed(),M.stridedSlice(this,t,e,n,r,o,a,s,u)},i.prototype.depthToSpace=function(t,e){return this.throwIfDisposed(),M.depthToSpace(this,t,e)},i.prototype.fft=function(){return this.throwIfDisposed(),M.spectral.fft(this)},i.prototype.ifft=function(){return this.throwIfDisposed(),M.spectral.ifft(this)},i.prototype.rfft=function(){return this.throwIfDisposed(),M.spectral.rfft(this)},i.prototype.irfft=function(){return this.throwIfDisposed(),M.spectral.irfft(this)},i}();Object.defineProperty(Me,Symbol.hasInstance,{value:function(i){return!!i&&i.dataId!=null&&i.shape!=null&&i.dtype!=null}});var np,Pu,Mu,Ou,Bu,sr=function(i){function t(e,n,r,o){var a=i.call(this,e.shape,e.dtype,e.dataId,o)||this;return a.trainable=n,a.name=r,a}return Qt(t,i),t.prototype.assign=function(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!Je(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");ln().disposeTensor(this),this.dataId=e.dataId,ln().incRef(this,null)},t.prototype.dispose=function(){ln().disposeVariable(this),this.isDisposedInternal=!0},t}(Me);Object.defineProperty(sr,Symbol.hasInstance,{value:function(i){return i instanceof Me&&i.assign!=null&&i.assign instanceof Function}}),function(i){i.R0="R0",i.R1="R1",i.R2="R2",i.R3="R3",i.R4="R4",i.R5="R5",i.R6="R6"}(np||(np={})),function(i){i.float32="float32",i.int32="int32",i.bool="int32",i.complex64="complex64"}(Pu||(Pu={})),function(i){i.float32="float32",i.int32="int32",i.bool="bool",i.complex64="complex64"}(Mu||(Mu={})),function(i){i.float32="float32",i.int32="float32",i.bool="float32",i.complex64="complex64"}(Ou||(Ou={})),function(i){i.float32="complex64",i.int32="complex64",i.bool="complex64",i.complex64="complex64"}(Bu||(Bu={}));var ix={float32:Ou,int32:Pu,bool:Mu,complex64:Bu};function at(i,t){if(i==="string"||t==="string"){if(i==="string"&&t==="string")return"string";throw new Error("Can not upcast "+i+" with "+t)}return ix[i][t]}function lu(i){return at(i,"int32")}function qe(i,t){if(i.dtype===t.dtype)return[i,t];var e=at(i.dtype,t.dtype);return[i.cast(e),t.cast(e)]}function ed(i,t){E(i.dtype===t.dtype,function(){return"The dtypes of the first("+i.dtype+") and second("+t.dtype+") input must match"})}function nc(i){var t=[];return function e(n,r,o){if(n!=null){if(n instanceof Me)return void r.push(n);if(a=n,!(!Array.isArray(a)&&typeof a!="object")){var a,s=n;for(var u in s){var c=s[u];o.has(c)||(o.add(c),e(c,r,o))}}}}(i,t,new Set),t}var fu,Xk=Object.freeze({makeTypesMatch:qe,assertTypesMatch:ed,isTensorInList:function(i,t){return t.some(function(e){return e.id===i.id})},getTensorsInContainer:nc}),rp=function(){function i(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return i.prototype.dispose=function(){for(var t in this.registeredVariables)this.registeredVariables[t].dispose()},i}(),ox=function(){function i(t){this.ENV=t,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new rp}return i.prototype.ready=function(){return te(this,void 0,void 0,function(){var t,e,n;return ne(this,function(r){switch(r.label){case 0:if(this.pendingBackendInit!=null)return[2,this.pendingBackendInit.then(function(){})];if(this.backendInstance!=null)return[2];t=this.getSortedBackends(),e=0,r.label=1;case 1:return e<t.length?(n=t[e],[4,this.initializeBackend(n).success]):[3,5];case 2:return r.sent()?[4,this.setBackend(n)]:[3,4];case 3:return r.sent(),[2];case 4:return e++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(i.prototype,"backend",{get:function(){if(this.pendingBackendInit!=null)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(this.backendInstance==null){var t=this.initializeBackendsAndReturnBest(),e=t.name;if(t.asyncInit)throw new Error("The highest priority backend '"+e+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(e)}return this.backendInstance},enumerable:!0,configurable:!0}),i.prototype.backendNames=function(){return Object.keys(this.registryFactory)},i.prototype.findBackend=function(t){return!(t in this.registry)&&(!(t in this.registryFactory)||this.initializeBackend(t).asyncInit)?null:this.registry[t]},i.prototype.findBackendFactory=function(t){return t in this.registryFactory?this.registryFactory[t].factory:null},i.prototype.registerBackend=function(t,e,n){return n===void 0&&(n=1),t in this.registryFactory?(console.warn(t+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[t]={factory:e,priority:n},!0)},i.prototype.setBackend=function(t){return te(this,void 0,void 0,function(){var e,n,r;return ne(this,function(o){switch(o.label){case 0:if(this.registryFactory[t]==null)throw new Error("Backend name '"+t+"' not found in registry");return this.backendName=t,this.registry[t]!=null?[3,4]:(this.backendInstance=null,e=this.initializeBackend(t),n=e.success,e.asyncInit?[4,n]:[3,2]);case 1:return r=o.sent(),[3,3];case 2:r=n,o.label=3;case 3:if(!r)return[2,!1];o.label=4;case 4:return this.backendInstance=this.registry[t],this.setupRegisteredKernels(),this.profiler=new tx(this.backendInstance),[2,!0]}})})},i.prototype.setupRegisteredKernels=function(){var t=this;Zh(this.backendName).forEach(function(e){e.setupFunc!=null&&e.setupFunc(t.backendInstance)})},i.prototype.disposeRegisteredKernels=function(t){var e=this;Zh(t).forEach(function(n){n.disposeFunc!=null&&n.disposeFunc(e.registry[t])})},i.prototype.initializeBackend=function(t){var e=this,n=this.registryFactory[t];if(n==null)throw new Error("Cannot initialize backend "+t+", no registration found.");try{var r=n.factory();if(Promise.resolve(r)===r){var o=++this.pendingBackendInitId,a=r.then(function(s){return!(o<e.pendingBackendInitId)&&(e.registry[t]=s,e.pendingBackendInit=null,!0)}).catch(function(s){return!(o<e.pendingBackendInitId)&&(e.pendingBackendInit=null,console.warn("Initialization of backend "+t+" failed"),console.warn(s.stack||s.message),!1)});return this.pendingBackendInit=a,{success:a,asyncInit:!0}}return this.registry[t]=r,{success:!0,asyncInit:!1}}catch(s){return console.warn("Initialization of backend "+t+" failed"),console.warn(s.stack||s.message),{success:!1,asyncInit:!1}}},i.prototype.removeBackend=function(t){if(!(t in this.registryFactory))throw new Error(t+" backend not found in registry");this.backendName===t&&this.pendingBackendInit!=null&&this.pendingBackendInitId++,t in this.registry&&(this.disposeRegisteredKernels(t),this.registry[t].dispose(),delete this.registry[t]),delete this.registryFactory[t],this.backendName===t&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},i.prototype.getSortedBackends=function(){var t=this;if(Object.keys(this.registryFactory).length===0)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(e,n){return t.registryFactory[n].priority-t.registryFactory[e].priority})},i.prototype.initializeBackendsAndReturnBest=function(){for(var t=this.getSortedBackends(),e=0;e<t.length;e++){var n=t[e],r=this.initializeBackend(n),o=r.success,a=r.asyncInit;if(a||o)return{name:n,asyncInit:a}}throw new Error("Could not initialize any backends, all backend initializations failed.")},i.prototype.moveData=function(t,e){var n=this.state.tensorInfo.get(e),r=n.backend,o=this.readSync(e);r.disposeData(e),n.backend=t,t.move(e,o,n.shape,n.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},i.prototype.tidy=function(t,e){var n,r=this,o=null;if(e==null){if(typeof t!="function")throw new Error("Please provide a function to tidy()");e=t}else{if(typeof t!="string"&&!(t instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if(typeof e!="function")throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");o=t}return this.scopedRun(function(){return r.startScope(o)},function(){return r.endScope(n)},function(){return(n=e())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),n})},i.prototype.scopedRun=function(t,e,n){t();try{var r=n();return e(),r}catch(o){throw e(),o}},i.prototype.nextTensorId=function(){return i.nextTensorId++},i.prototype.nextVariableId=function(){return i.nextVariableId++},i.prototype.clone=function(t){var e=this.makeTensorFromDataId(t.dataId,t.shape,t.dtype),n={x:t};return this.addTapeNode(this.state.activeScope.name,n,[e],function(r){return{x:function(){return r.toFloat()}}},[]),e},i.prototype.runKernel=function(t,e,n,r,o){return this.runKernelFunc(null,e,null,t,n,r,o)},i.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},i.prototype.checkKernelForMemLeak=function(t,e,n){var r=this.backend.numDataIds(),o=0;n.forEach(function(u){o+=u.dtype==="complex64"?3:1});var a=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],s=r-e-o-a;if(s>0)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+s+" data ids) after running '"+t+"'")},i.prototype.runKernelFunc=function(t,e,n,r,o,a,s){var u,c=this;a===void 0&&(a=[]),s===void 0&&(s=[]);var l=[],f=this.isTapeOn();r==null&&(r=this.state.activeScope!=null?this.state.activeScope.name:"");var h,p=function(x){f&&(l=x.map(function(w){return c.keep(c.clone(w))}))},d=this.state.numBytes,m=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var v,g=Lp(r,this.backendName);return h=g!=null?function(){var x=c.backend.numDataIds();v=g.kernelFunc({inputs:e,attrs:o,backend:c.backend});var w=Array.isArray(v)?v:[v];c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(r,x,w);var y=w.map(function(C){var S=C.dataId,A=C.shape,k=C.dtype;return c.makeTensorFromDataId(S,A,k)}),b=y.filter(function(C,S){return s[S]});return p((a||[]).slice().concat(b)),y}:function(){var x=c.backend.numDataIds();v=c.tidy(function(){return t(c.backend,p)});var w=Array.isArray(v)?v:[v];return c.shouldCheckForMemLeaks()&&c.checkKernelForMemLeak(r,x,w),w},this.scopedRun(function(){return c.state.kernelDepth++},function(){return c.state.kernelDepth--},function(){u=c.ENV.getBool("DEBUG")?c.profiler.profileKernel(r,e,function(){return h()}):h()}),f&&this.addTapeNode(r,e,u,n,l),this.state.profiling&&this.state.activeProfile.kernels.push({name:r,bytesAdded:this.state.numBytes-d,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-m,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(e).map(function(x){return e[x].shape}),outputShapes:u.map(function(x){return x.shape})}),Array.isArray(v)?u:u[0]},i.prototype.makeTensor=function(t,e,n,r){if(t==null)throw new Error("Values passed to engine.makeTensor() are null");n=n||"float32",r=r||this.backend;var o=t;n==="string"&&Vn(t[0])&&(o=t.map(function(l){return Yp(l)}));var a=r.write(o,e,n),s=new Me(e,n,a,this.nextTensorId());if(this.incRef(s,r),n==="string"){var u=this.state.tensorInfo.get(a),c=Kp(o);this.state.numBytes+=c-u.bytes,u.bytes=c}return s},i.prototype.makeTensorFromDataId=function(t,e,n,r){var o=new Me(e,n=n||"float32",t,this.nextTensorId());return this.incRef(o,r),o},i.prototype.makeVariable=function(t,e,n,r){e===void 0&&(e=!0),n=n||this.nextVariableId().toString(),r!=null&&r!==t.dtype&&(t=t.asType(r));var o=new sr(t,e,n,this.nextTensorId());if(this.state.registeredVariables[o.name]!=null)throw new Error("Variable with name "+o.name+" was already registered");return this.state.registeredVariables[o.name]=o,this.incRef(o,this.backend),o},i.prototype.incRef=function(t,e){var n=this.state.tensorInfo.has(t.dataId)?this.state.tensorInfo.get(t.dataId).refCount:0;if(this.state.numTensors++,t.dtype==="string"&&this.state.numStringTensors++,n===0){this.state.numDataBuffers++;var r=0;t.dtype!=="complex64"&&t.dtype!=="string"&&(r=t.size*Qu(t.dtype)),this.state.tensorInfo.set(t.dataId,{backend:e||this.backend,dtype:t.dtype,shape:t.shape,bytes:r,refCount:0}),this.state.numBytes+=r}this.state.tensorInfo.get(t.dataId).refCount++,t instanceof sr||this.track(t)},i.prototype.disposeTensor=function(t){if(this.state.tensorInfo.has(t.dataId)){this.state.numTensors--,t.dtype==="string"&&this.state.numStringTensors--;var e=this.state.tensorInfo.get(t.dataId);e.refCount<=1?(t.dtype!=="complex64"&&(this.state.numBytes-=e.bytes),this.state.numDataBuffers--,e.backend.disposeData(t.dataId),this.state.tensorInfo.delete(t.dataId)):this.state.tensorInfo.get(t.dataId).refCount--}},i.prototype.disposeVariables=function(){for(var t in this.state.registeredVariables){var e=this.state.registeredVariables[t];this.disposeVariable(e)}},i.prototype.disposeVariable=function(t){this.disposeTensor(t),this.state.registeredVariables[t.name]!=null&&delete this.state.registeredVariables[t.name]},i.prototype.memory=function(){var t=this.backend.memory();return t.numTensors=this.state.numTensors,t.numDataBuffers=this.state.numDataBuffers,t.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(t.unreliable=!0,t.reasons==null&&(t.reasons=[]),t.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),t},i.prototype.profile=function(t){return te(this,void 0,void 0,function(){var e,n;return ne(this,function(r){return this.state.profiling=!0,e=this.state.numBytes,n=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=t(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(o){return o.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-e,this.state.activeProfile.newTensors=this.state.numTensors-n,[2,this.state.activeProfile]})})},i.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&this.state.kernelDepth===0},i.prototype.addTapeNode=function(t,e,n,r,o){var a=this,s={id:this.state.nextTapeNodeId++,kernelName:t,inputs:e,outputs:n,saved:o},u=Zy(t);u!=null&&(r=u.gradFunc),r!=null&&(s.gradient=function(c){return c=c.map(function(l,f){if(l==null){var h=n[f],p=jr(h.size,h.dtype);return a.makeTensor(p,h.shape,h.dtype)}return l}),r(c.length>1?c:c[0],o)}),this.state.activeTape.push(s)},i.prototype.keep=function(t){return t.kept=!0,t},i.prototype.startTape=function(){this.state.gradientDepth===0&&(this.state.activeTape=[]),this.state.gradientDepth++},i.prototype.endTape=function(){this.state.gradientDepth--},i.prototype.startScope=function(t){var e={track:[],name:"unnamed scope",id:this.state.nextScopeId++};t&&(e.name=t),this.state.scopeStack.push(e),this.state.activeScope=e},i.prototype.endScope=function(t){for(var e=this,n=nc(t),r=new Set(n.map(function(u){return u.id})),o=0;o<this.state.activeScope.track.length;o++){var a=this.state.activeScope.track[o];a.kept||r.has(a.id)||a.dispose()}var s=this.state.scopeStack.pop();this.state.activeScope=this.state.scopeStack.length===0?null:this.state.scopeStack[this.state.scopeStack.length-1],n.forEach(function(u){u.kept||u.scopeId!==s.id||e.track(u)})},i.prototype.gradients=function(t,e,n,r){var o=this;if(r===void 0&&(r=!1),E(e.length>0,function(){return"gradients() received an empty list of xs."}),n!=null&&n.dtype!=="float32")throw new Error("dy must have 'float32' dtype, but has '"+n.dtype+"'");var a=this.scopedRun(function(){return o.startTape()},function(){return o.endTape()},function(){return o.tidy("forward",t)});E(a instanceof Me,function(){return"The result y returned by f() must be a tensor."});var s=function(u,c,l){for(var f={},h={},p=0;p<c.length;p++)f[c[p].id]=!0;for(p=0;p<u.length;p++){var d=(C=u[p]).inputs;for(var m in d){for(var v=d[m],g=!1,x=0;x<c.length;x++)if(f[v.id]){C.outputs.forEach(function(D){return f[D.id]=!0}),g=!0,h[C.id]=!0;break}if(g)break}}var w={};w[l.id]=!0;var y={};for(p=u.length-1;p>=0;p--)for(d=(C=u[p]).inputs,x=0;x<C.outputs.length;x++)if(w[C.outputs[x].id]){for(var m in d)w[d[m].id]=!0,y[C.id]=!0;break}var b=[];for(p=0;p<u.length;p++){var C;if(h[(C=u[p]).id]&&y[C.id]){var S={};for(var m in C.inputs){var A=C.inputs[m];f[A.id]&&(S[m]=A)}var k=Object.assign({},C);k.inputs=S,k.outputs=C.outputs,b.push(k)}}return b}(this.state.activeTape,e,a);if(!r&&s.length===0&&e.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var u,c,l={};l[a.id]=n??(u=a.shape,c=ec(re(u),"float32"),R.makeTensor(c,u,"float32")),function(h,p,d){for(var m=function(g){var x=p[g],w=[];if(x.outputs.forEach(function(S){var A=h[S.id];A!=null?w.push(A):w.push(null)}),x.gradient==null)throw new Error("Cannot compute gradient: gradient function not found for "+x.kernelName+".");var y=x.gradient(w),b=function(S){if(!(S in y))throw new Error("Cannot backprop through input "+S+". Available gradients found: "+Object.keys(y)+".");var A=d(function(){return y[S]()});if(A.dtype!=="float32")throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input "+S+" must have 'float32' dtype, but has '"+A.dtype+"'");var k=x.inputs[S];if(!Je(A.shape,k.shape))throw new Error("Error in gradient for op "+x.kernelName+". The gradient of input '"+S+"' has shape '"+A.shape+"', which does not match the shape of the input '"+k.shape+"'");if(h[k.id]==null)h[k.id]=A;else{var D=h[k.id];h[k.id]=D.add(A),D.dispose()}};for(var C in x.inputs)b(C)},v=p.length-1;v>=0;v--)m(v)}(l,s,function(h){return o.tidy(h)});var f=e.map(function(h){return l[h.id]});return o.state.gradientDepth===0&&(o.state.activeTape.forEach(function(h){for(var p=0,d=h.saved;p<d.length;p++)d[p].dispose()}),o.state.activeTape=null),{value:a,grads:f}})},i.prototype.customGrad=function(t){var e=this;return E(zo(t),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var n,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];E(r.every(function(s){return s instanceof Me}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var a={};return r.forEach(function(s,u){a[u]=s}),e.runKernelFunc(function(s,u){return E((n=t.apply(void 0,r.concat([u]))).value instanceof Me,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),E(zo(n.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),n.value},a,function(s,u){var c=n.gradFunc(s,u),l=Array.isArray(c)?c:[c];E(l.length===r.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),E(l.every(function(h){return h instanceof Me}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var f={};return l.forEach(function(h,p){f[p]=function(){return h}}),f})}},i.prototype.readSync=function(t){return this.state.tensorInfo.get(t).backend.readSync(t)},i.prototype.read=function(t){return this.state.tensorInfo.get(t).backend.read(t)},i.prototype.time=function(t){return te(this,void 0,void 0,function(){var e,n;return ne(this,function(r){switch(r.label){case 0:return e=$t(),[4,this.backend.time(t)];case 1:return(n=r.sent()).wallMs=$t()-e,[2,n]}})})},i.prototype.track=function(t){return this.state.activeScope!=null&&(t.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(t)),t},Object.defineProperty(i.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),i.prototype.reset=function(){for(var t in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new rp,this.registry)this.disposeRegisteredKernels(t),this.registry[t].dispose(),delete this.registry[t];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},i.nextTensorId=0,i.nextVariableId=0,i}(),R=function(){var i=function(){if(fu==null){var e=void 0;if(typeof window<"u")e=window;else if(typeof global<"u")e=global;else if(typeof process<"u")e=process;else{if(typeof self>"u")throw new Error("Could not find a global object");e=self}fu=e}return fu}();if(i._tfengine==null){var t=new Jy(i);i._tfengine=new ox(t)}return function(e){Bp=e}(i._tfengine.ENV),ln=function(){return i._tfengine},i._tfengine}();function td(){return typeof window<"u"&&window.document!=null||typeof WorkerGlobalScope<"u"}var Cn=O();Cn.registerFlag("DEBUG",function(){return!1},function(i){i&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),Cn.registerFlag("IS_BROWSER",function(){return td()}),Cn.registerFlag("IS_NODE",function(){return typeof process<"u"&&process.versions!==void 0&&process.versions.node!==void 0}),Cn.registerFlag("IS_CHROME",function(){return typeof navigator<"u"&&navigator!=null&&navigator.userAgent!=null&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),Cn.registerFlag("PROD",function(){return!1}),Cn.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return Cn.getBool("DEBUG")}),Cn.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),Cn.registerFlag("IS_TEST",function(){return!1});var Ai,Lt,Bt,tr={},hu={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function nd(i,t){tr[i]=t}function dn(i){i in tr||(tr[i]=function(e){if(e!==1&&e!==2)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var n=function(r){if(typeof OffscreenCanvas<"u"&&r===2)return new OffscreenCanvas(300,150);if(typeof document<"u")return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}(e);return n.addEventListener("webglcontextlost",function(r){r.preventDefault(),delete tr[e]},!1),e===1?n.getContext("webgl",hu)||n.getContext("experimental-webgl",hu):n.getContext("webgl2",hu)}(i));var t=tr[i];return t.isContextLost()?(delete tr[i],dn(i)):(t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.disable(t.BLEND),t.disable(t.DITHER),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SAMPLE_COVERAGE),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),tr[i])}function Zo(i,t){return[t,i]}function _i(i){var t=re(i);return Wo(Math.ceil(t/4))}function Mi(i,t){return[Math.max(1,Math.ceil(t/2)),Math.max(1,Math.ceil(i/2))]}function rc(i,t){var e,n,r,o,a,s,u,c,l,f=i;return O().getNumber("WEBGL_VERSION")===2?(e=f.R32F,n=f.R16F,r=f.RGBA16F,o=f.RGBA32F,a=f.RED,s=4,u=1,c=f.HALF_FLOAT,l=f.FLOAT):(e=i.RGBA,n=i.RGBA,r=i.RGBA,o=f.RGBA,a=i.RGBA,s=4,u=4,c=t!=null?t.HALF_FLOAT_OES:null,l=i.FLOAT),{internalFormatFloat:e,internalFormatHalfFloat:n,internalFormatPackedHalfFloat:r,internalFormatPackedFloat:o,textureFormatFloat:a,downloadTextureFormat:i.RGBA,downloadUnpackNumChannels:s,defaultNumChannels:u,textureTypeHalfFloat:c,textureTypeFloat:l}}function ee(i,t,e){var n=e();return t&&function(r){var o=r.getError();if(o!==r.NO_ERROR)throw new Error("WebGL Error: "+id(r,o))}(i),n}(function(i){i[i.DENSE=0]="DENSE",i[i.SHARED_BATCH=1]="SHARED_BATCH"})(Ai||(Ai={})),function(i){i[i.RENDER=0]="RENDER",i[i.UPLOAD=1]="UPLOAD",i[i.PIXELS=2]="PIXELS",i[i.DOWNLOAD=3]="DOWNLOAD"}(Lt||(Lt={})),function(i){i[i.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",i[i.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",i[i.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",i[i.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",i[i.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(Bt||(Bt={}));var ax=596e-10,sx=65504;function rd(i){return!!(O().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||i===0||ax<Math.abs(i)&&Math.abs(i)<sx)}function id(i,t){switch(t){case i.NO_ERROR:return"NO_ERROR";case i.INVALID_ENUM:return"INVALID_ENUM";case i.INVALID_VALUE:return"INVALID_VALUE";case i.INVALID_OPERATION:return"INVALID_OPERATION";case i.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case i.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case i.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+t}}function bi(i,t,e){return Sn(i,t,function(){return i.getExtension(e)},'Extension "'+e+'" not supported on this browser.')}function od(i,t,e){var n=Sn(i,t,function(){return i.createShader(i.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(ee(i,t,function(){return i.shaderSource(n,e)}),ee(i,t,function(){return i.compileShader(n)}),i.getShaderParameter(n,i.COMPILE_STATUS)===!1)throw console.log(i.getShaderInfoLog(n)),new Error("Failed to compile vertex shader.");return n}function ad(i,t,e){var n=Sn(i,t,function(){return i.createShader(i.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(ee(i,t,function(){return i.shaderSource(n,e)}),ee(i,t,function(){return i.compileShader(n)}),i.getShaderParameter(n,i.COMPILE_STATUS)===!1)throw function(r,o){var a=ux.exec(o);if(a==null)return console.log("Couldn't parse line number in error: "+o),void console.log(r);for(var s=+a[1],u=r.split(`
`),c=u.length.toString().length+2,l=u.map(function(v,g){return or((g+1).toString(),c)+v}),f=0,h=0;h<l.length;h++)f=Math.max(l[h].length,f);var p=l.slice(0,s-1),d=l.slice(s-1,s),m=l.slice(s);console.log(p.join(`
`)),console.log(o.split(`
`)[0]),console.log("%c "+or(d[0],f),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(m.join(`
`))}(e,i.getShaderInfoLog(n)),new Error("Failed to compile fragment shader.");return n}var Ro,Io,ux=/ERROR: [0-9]+:([0-9]+):/g;function sd(i,t){return Sn(i,t,function(){return i.createProgram()},"Unable to create WebGLProgram.")}function ud(i,t,e){if(ee(i,t,function(){return i.linkProgram(e)}),i.getProgramParameter(e,i.LINK_STATUS)===!1)throw console.log(i.getProgramInfoLog(e)),new Error("Failed to link vertex and fragment shaders.")}function To(i,t,e){if(ee(i,t,function(){return i.validateProgram(e)}),i.getProgramParameter(e,i.VALIDATE_STATUS)===!1)throw console.log(i.getProgramInfoLog(e)),new Error("Shader program validation failed.")}function cd(i,t,e){var n=Sn(i,t,function(){return i.createBuffer()},"Unable to create WebGLBuffer");return ee(i,t,function(){return i.bindBuffer(i.ARRAY_BUFFER,n)}),ee(i,t,function(){return i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW)}),n}function ld(i,t,e){var n=Sn(i,t,function(){return i.createBuffer()},"Unable to create WebGLBuffer");return ee(i,t,function(){return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n)}),ee(i,t,function(){return i.bufferData(i.ELEMENT_ARRAY_BUFFER,e,i.STATIC_DRAW)}),n}function fd(i,t){return Sn(i,t,function(){return i.createTexture()},"Unable to create WebGLTexture.")}function hd(i,t){var e=O().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(i<=0||t<=0){var n="["+i+"x"+t+"]";throw new Error("Requested texture size "+n+" is invalid.")}if(i>e||t>e)throw n="["+i+"x"+t+"]",new Error("Requested texture size "+n+" greater than WebGL maximum on this browser / GPU "+("["+e+"x"+e+"]")+".")}function pd(i,t){return Sn(i,t,function(){return i.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function Lu(i,t,e,n,r,o,a,s){var u=i.getAttribLocation(e,n);return u!==-1&&(ee(i,t,function(){return i.bindBuffer(i.ARRAY_BUFFER,r)}),ee(i,t,function(){return i.vertexAttribPointer(u,o,i.FLOAT,!1,a,s)}),ee(i,t,function(){return i.enableVertexAttribArray(u)}),!0)}function dd(i,t,e,n){xd(i,n),ee(i,t,function(){return i.activeTexture(i.TEXTURE0+n)}),ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,e)})}function md(i,t,e,n){return Sn(i,t,function(){return i.getUniformLocation(e,n)},'uniform "'+n+'" not present in program.')}function vd(i,t,e){return i.getUniformLocation(t,e)}function gd(i,t,e,n,r,o){ee(i,t,function(){return dd(i,t,n,o)}),ee(i,t,function(){return i.uniform1i(r,o)})}function No(i,t,e,n){ee(i,t,function(){return i.bindFramebuffer(i.FRAMEBUFFER,n)}),ee(i,t,function(){return i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e,0)})}function Wu(i,t,e){ee(i,t,function(){return i.bindFramebuffer(i.FRAMEBUFFER,e)}),ee(i,t,function(){return i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,null,0)})}function wi(i){var t=i.checkFramebufferStatus(i.FRAMEBUFFER);if(t!==i.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+yd(i,t))}function yd(i,t){switch(t){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+t}}function Sn(i,t,e,n){var r=ee(i,t,function(){return e()});if(r==null)throw new Error(n);return r}function xd(i,t){var e=i.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,n=t+i.TEXTURE0;if(n<i.TEXTURE0||n>e)throw new Error("textureUnit must be in "+("[gl.TEXTURE0, gl.TEXTURE"+e+"]")+".")}function Fi(i,t){return t===void 0&&(t=2),re(i.slice(0,i.length-t))}function Ri(i){if(i.length===0)throw Error("Cannot get rows and columns of an empty shape array.");return[i.length>1?i[i.length-2]:1,i[i.length-1]]}function Po(i){var t=[1,1,1];return i.length===0||i.length===1&&i[0]===1||(t=[Fi(i)].concat(Ri(i))),t}function bd(i,t){var e;t===void 0&&(t=!1);var n=O().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(t&&(n*=2,(i=i.map(function(c,l){return l>=i.length-2?Ju(i[l]):i[l]})).length===1&&(i=[2,i[0]])),i.length!==2){var r=qn(i);i=r.newShape}var o=re(i);if(i.length<=1&&o<=n)return[1,o];if(i.length===2&&i[0]<=n&&i[1]<=n)return i;if(i.length===3&&i[0]*i[1]<=n&&i[2]<=n)return[i[0]*i[1],i[2]];if(i.length===3&&i[0]<=n&&i[1]*i[2]<=n)return[i[0],i[1]*i[2]];if(i.length===4&&i[0]*i[1]*i[2]<=n&&i[3]<=n)return[i[0]*i[1]*i[2],i[3]];if(i.length===4&&i[0]<=n&&i[1]*i[2]*i[3]<=n)return[i[0],i[1]*i[2]*i[3]];if(t){var a=Fi(i),s=2,u=2;return i.length&&(s=(e=Ri(i))[0],u=e[1]),Wo(o=a*(s/2)*(u/2)).map(function(c){return 2*c})}return Wo(o)}function wo(i){return i%2==0}function Ci(i,t){if(Je(i=i.slice(-2),t=t.slice(-2))||!i.length||!t.length||i[0]===0||i[1]===0||t[0]===0||t[1]===0)return!0;if(i.length!==t.length){var e=i.slice(-1)[0],n=t.slice(-1)[0];if(e===n||wo(e)&&wo(n)&&(i[0]===1||t[0]===1))return!0}return i[1]===t[1]&&wo(i[0])&&wo(t[0])}function wd(i){if(Ro==null){var t=dn(i);Ro=t.getParameter(t.MAX_TEXTURE_SIZE)}return Ro}function Cd(i){if(Io==null){var t=dn(i);Io=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,Io)}function _d(i){if(i===0)return 0;var t=dn(i);return Wt(t,"EXT_disjoint_timer_query_webgl2")&&i===2?2:Wt(t,"EXT_disjoint_timer_query")?1:0}function Wt(i,t){return i.getExtension(t)!=null}function zu(i){try{if(dn(i)!=null)return!0}catch{return!1}return!1}function Ed(i){if(i===0)return!1;var t=dn(i);if(i===1){if(!Wt(t,"OES_texture_float"))return!1}else if(!Wt(t,"EXT_color_buffer_float"))return!1;return qu(t)}function kd(i){if(i===0)return!1;var t=dn(i);if(i!==1){if(Wt(t,"EXT_color_buffer_float"))return qu(t);if(Wt(t,"EXT_color_buffer_half_float")){var e=t.getExtension("EXT_color_buffer_half_float");return function(n,r){var o=rc(n,r),a=n.createTexture();n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,o.internalFormatHalfFloat,1,1,0,o.textureFormatFloat,o.textureTypeHalfFloat,null);var s=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,s),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,a,0);var u=n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE;return n.bindTexture(n.TEXTURE_2D,null),n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteTexture(a),n.deleteFramebuffer(s),u}(t,e)}return!1}return!!Wt(t,"OES_texture_float")&&!!Wt(t,"WEBGL_color_buffer_float")&&qu(t)}function qu(i){var t=rc(i),e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e),i.texImage2D(i.TEXTURE_2D,0,t.internalFormatFloat,1,1,0,t.textureFormatFloat,t.textureTypeFloat,null);var n=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e,0);var r=i.checkFramebufferStatus(i.FRAMEBUFFER)===i.FRAMEBUFFER_COMPLETE;return i.bindTexture(i.TEXTURE_2D,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.deleteTexture(e),i.deleteFramebuffer(n),r}function Dd(i){return i===2&&dn(i).fenceSync!=null}var cx=Object.freeze({callAndCheck:ee,canBeRepresented:rd,getWebGLErrorMessage:id,getExtensionOrThrow:bi,createVertexShader:od,createFragmentShader:ad,createProgram:sd,linkProgram:ud,validateProgram:To,createStaticVertexBuffer:cd,createStaticIndexBuffer:ld,getNumChannels:function(){return O().getNumber("WEBGL_VERSION")===2?1:4},createTexture:fd,validateTextureSize:hd,createFramebuffer:pd,bindVertexBufferToProgramAttribute:Lu,bindTextureUnit:dd,unbindTextureUnit:function(i,t,e){xd(i,e),ee(i,t,function(){return i.activeTexture(i.TEXTURE0+e)}),ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:md,getProgramUniformLocation:vd,bindTextureToProgramUniformSampler:gd,bindCanvasToFramebuffer:function(i,t){ee(i,t,function(){return i.bindFramebuffer(i.FRAMEBUFFER,null)}),ee(i,t,function(){return i.viewport(0,0,i.canvas.width,i.canvas.height)}),ee(i,t,function(){return i.scissor(0,0,i.canvas.width,i.canvas.height)})},bindColorTextureToFramebuffer:No,unbindColorTextureFromFramebuffer:Wu,validateFramebuffer:wi,getFramebufferErrorMessage:yd,getBatchDim:Fi,getRowsCols:Ri,getShapeAs3D:Po,getTextureShapeFromLogicalShape:bd,isReshapeFree:Ci,getWebGLMaxTextureSize:wd,resetMaxTextureSize:function(){Ro=null},resetMaxTexturesInShader:function(){Io=null},getMaxTexturesInShader:Cd,getWebGLDisjointQueryTimerVersion:_d,hasExtension:Wt,isWebGLVersionEnabled:zu,isCapableOfRenderingToFloatTexture:Ed,isDownloadFloatTextureEnabled:kd,isWebGLFenceEnabled:Dd}),ce=O();function Sd(i){O().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(i+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function j(i,t){return R.tidy(i,t)}function Nt(i){nc(i).forEach(function(t){return t.dispose()})}function lx(i){return R.keep(i)}function Vo(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];O().getBool("IS_TEST")||console.warn.apply(console,i)}function pn(i,t){var e=i;if(dt(i))return t==="string"?[]:[i.length];if(!Array.isArray(i))return[];for(var n=[];Array.isArray(e)||dt(e)&&t!=="string";)n.push(e.length),e=e[0];return Array.isArray(i)&&O().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function r(o,a,s){if(s=s||[],!Array.isArray(o)&&!dt(o))return void E(a.length===0,function(){return"Element arr["+s.join("][")+"] is a primitive, but should be an array/TypedArray of "+a[0]+" elements"});E(a.length>0,function(){return"Element arr["+s.join("][")+"] should be a primitive, but is an array of "+o.length+" elements"}),E(o.length===a[0],function(){return"Element arr["+s.join("][")+"] should have "+a[0]+" elements, but has "+o.length+" elements"});for(var u=a.slice(1),c=0;c<o.length;++c)r(o[c],u,s.concat(c))}(i,n,[]),n}function ip(i,t,e,n){if(i!=null&&(i!=="numeric"&&i!==t||i==="numeric"&&t==="string"))throw new Error("Argument '"+e+"' passed to '"+n+"' must be "+i+" tensor, but got "+t+" tensor")}function _(i,t,e,n){if(n===void 0&&(n="numeric"),i instanceof Me)return ip(n,i.dtype,t,e),i;var r=Ur(i);if(r!=="string"&&["bool","int32","float32"].indexOf(n)>=0&&(r=n),ip(n,r,t,e),i==null||!dt(i)&&!Array.isArray(i)&&typeof i!="number"&&typeof i!="boolean"&&typeof i!="string"){var o=i==null?"null":i.constructor.name;throw new Error("Argument '"+t+"' passed to '"+e+"' must be a Tensor or TensorLike, but got '"+o+"'")}var a=pn(i,r);dt(i)||Array.isArray(i)||(i=[i]);var s=r!=="string"?Zu(i,r,O().getBool("DEBUG")):Dn(i,[],!0);return R.makeTensor(s,a,r)}function Uo(i,t,e,n){if(n===void 0&&(n="numeric"),!Array.isArray(i))throw new Error("Argument "+t+" passed to "+e+" must be a `Tensor[]` or `TensorLike[]`");return i.map(function(r,o){return _(r,t+"["+o+"]",e)},n)}function ic(i,t){for(var e=0;e<i.length;++e)if(i[i.length-e-1]!==t-1-e)return!1;return!0}function Ad(i,t,e){for(var n=i.length+t.length,r=[],o=0,a=0,s=0;s<n;s++)e.indexOf(s)===-1?r.push(i[o++]):r.push(t[a++]);return r}function pt(i,t){for(var e=[],n=i.length,r=0;r<n;r++)t.indexOf(r)===-1&&e.push(i[r]);return[e,t.map(function(o){return i[o]})]}function Et(i,t){return Ad(i,t.map(function(e){return 1}),t)}function It(i,t,e){E(ic(t,e),function(){return i+" supports only inner-most axes for now. Got axes "+t+" and rank-"+e+" input."})}function Zt(i,t){if(ic(i,t))return null;for(var e=[],n=0;n<t;++n)i.indexOf(n)===-1&&e.push(n);return i.forEach(function(r){return e.push(r)}),e}function ea(i){return i.map(function(t,e){return[e,t]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}function en(i,t){for(var e=[],n=t-i;n<t;++n)e.push(n);return e}function Fd(i,t){var e=i[0].length;i.forEach(function(r,o){E(r.length===e,function(){return"Error in concat"+e+"D: rank of tensors["+o+"] must be the same as the rank of the rest ("+e+")"})}),E(t>=0&&t<e,function(){return"Error in concat"+e+"D: axis must be between 0 and "+(e-1)+"."});var n=i[0];i.forEach(function(r,o){for(var a=0;a<e;a++)E(a===t||r[a]===n[a],function(){return"Error in concat"+e+"D: Shape of tensors["+o+"] ("+r+") does not match the shape of the rest ("+n+") along the non-concatenated axis "+o+"."})})}function ur(i,t){for(var e=i[0].slice(),n=1;n<i.length;n++)e[t]+=i[n][t];return e}function F(i){var t=Object.keys(i);if(t.length!==1)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+t.length+" keys.");var e=t[0],n=i[e];e.endsWith("_")&&(e=e.substring(0,e.length-1));var r=function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];R.startScope(e);try{var s=n.apply(void 0,o);return s instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),R.endScope(s),s}catch(u){throw R.endScope(null),u}};return Object.defineProperty(r,"name",{value:e,configurable:!0}),r}ce.registerFlag("HAS_WEBGL",function(){return ce.getNumber("WEBGL_VERSION")>0}),ce.registerFlag("WEBGL_VERSION",function(){return zu(2)?2:zu(1)?1:0}),ce.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return ce.get("WEBGL_VERSION")===2}),ce.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),ce.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),ce.registerFlag("WEBGL_PACK",function(){return ce.getBool("HAS_WEBGL")}),ce.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_CLIP",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),ce.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_PACK_REDUCE",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_LAZILY_UNPACK",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_CONV_IM2COL",function(){return ce.getBool("WEBGL_PACK")}),ce.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return wd(ce.getNumber("WEBGL_VERSION"))}),ce.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return Cd(ce.getNumber("WEBGL_VERSION"))}),ce.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var i=ce.getNumber("WEBGL_VERSION");return i===0?0:_d(i)}),ce.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return ce.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&(i=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(i)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(i.substr(0,4))));var i}),ce.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return Ed(ce.getNumber("WEBGL_VERSION"))}),ce.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!ce.getBool("WEBGL_FORCE_F16_TEXTURES")&&ce.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),ce.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return kd(ce.getNumber("WEBGL_VERSION"))}),ce.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return Dd(ce.getNumber("WEBGL_VERSION"))}),ce.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return ce.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),Zp=Sd;var ht=F({complex_:function(i,t){var e=_(i,"real","complex"),n=_(t,"imag","complex");return Ae(e.shape,n.shape,"real and imag shapes, "+e.shape+" and "+n.shape+", must match in call to tf.complex()."),R.runKernelFunc(function(r){return r.complex(e,n)},{$real:e,$imag:n})}}),Vt=F({real_:function(i){var t=_(i,"input","real");return R.runKernelFunc(function(e){return e.real(t)},{$input:t})}}),fn=F({imag_:function(i){var t=_(i,"input","imag");return R.runKernelFunc(function(e){return e.imag(t)},{$input:t})}});function st(i,t,e){return Gn(i,t,pn(i,e),e)}function Gn(i,t,e,n){if(n==null&&(n=Ur(i)),n==="complex64")throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!dt(i)&&!Array.isArray(i)&&typeof i!="number"&&typeof i!="boolean"&&typeof i!="string")throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(t!=null){tc(t);var r=re(t),o=re(e);E(r===o,function(){return"Based on the provided shape, ["+t+"], the tensor should have "+r+" values but has "+o});for(var a=0;a<e.length;++a){var s=e[a],u=a!==e.length-1||s!==re(t.slice(a));E(e[a]===t[a]||!u,function(){return"Error creating a new Tensor. Inferred shape ("+e+") does not match the provided shape ("+t+"). "})}}return dt(i)||Array.isArray(i)||(i=[i]),t=t||e,i=n!=="string"?Zu(i,n,O().getBool("DEBUG")):Dn(i,[],!0),R.makeTensor(i,t,n)}function Y(i,t){if((dt(i)&&t!=="string"||Array.isArray(i))&&t!=="complex64")throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if(t==="string"&&dt(i)&&!(i instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return Gn(i,[],[],t)}function Be(i,t){fr(i);var e=pn(i,t);if(e.length!==1)throw new Error("tensor1d() requires values to be a flat/TypedArray");return Gn(i,null,e,t)}function hn(i,t,e){if(fr(i),t!=null&&t.length!==2)throw new Error("tensor2d() requires shape to have two numbers");var n=pn(i,e);if(n.length!==2&&n.length!==1)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(n.length===1&&t==null)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return Gn(i,t,n,e)}function ta(i,t,e){if(fr(i),t!=null&&t.length!==3)throw new Error("tensor3d() requires shape to have three numbers");var n=pn(i,e);if(n.length!==3&&n.length!==1)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(n.length===1&&t==null)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return Gn(i,t,n,e)}function it(i,t,e){if(fr(i),t!=null&&t.length!==4)throw new Error("tensor4d() requires shape to have four numbers");var n=pn(i,e);if(n.length!==4&&n.length!==1)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(n.length===1&&t==null)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return Gn(i,t,n,e)}function fx(i,t,e){if(fr(i),t!=null&&t.length!==5)throw new Error("tensor5d() requires shape to have five numbers");var n=pn(i,e);if(n.length!==5&&n.length!==1)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(n.length===1&&t==null)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return Gn(i,t,n,e)}function hx(i,t,e){if(fr(i),t!=null&&t.length!==6)throw new Error("tensor6d() requires shape to have six numbers");var n=pn(i,e);if(n.length!==6&&n.length!==1)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(n.length===1&&t==null)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return Gn(i,t=t||n,n,e)}function px(i,t,e,n){return t===void 0&&(t=!0),R.makeVariable(i,t,e,n)}function Gr(i,t){if(t===void 0&&(t="float32"),t==="complex64"){var e=Gr(i,"float32"),n=Le(i,"float32");return ht(e,n)}var r=ec(re(i),t);return R.makeTensor(r,i,t)}function Le(i,t){if(t===void 0&&(t="float32"),t==="complex64"){var e=Le(i,"float32"),n=Le(i,"float32");return ht(e,n)}var r=jr(re(i),t);return R.makeTensor(r,i,t)}function qt(i,t,e){return R.runKernelFunc(function(n){return n.fill(i,t,e)},{})}function dx(i,t,e){if(e<=0)throw new Error("The number of values should be positive.");return R.runKernelFunc(function(n){return n.linspace(i,t,e)},{})}function jo(i,t,e,n){if(e===void 0&&(e=1),n===void 0&&(n="float32"),e===0)throw new Error("Cannot have a step of zero");if(i===t||i<t&&e<0||t<i&&e>1)return Le([0],n);var r=jr(Math.abs(Math.ceil((t-i)/e)),n);t<i&&e===1&&(e=-1),r[0]=i;for(var o=1;o<r.length;o++)r[o]=r[o-1]+e;return Be(r,n)}var Rd=F({onesLike_:function(i){var t=_(i,"x","onesLike");if(t.dtype==="complex64"){var e=Rd(Vt(t)),n=De(fn(t));return ht(e,n)}return R.runKernelFunc(function(r){return r.onesLike(t)},{$x:t},function(r,o){return{$x:function(){return De(r)}}})}}),De=F({zerosLike_:function(i){var t=_(i,"x","zerosLike");return R.runKernelFunc(function(e){return e.zerosLike(t)},{$x:t},function(e,n){return{$x:function(){return De(e)}}})}}),ze=F({concat_:function(i,t){t===void 0&&(t=0),E(i.length>=1,function(){return"Pass at least one tensor to concat"});var e=Uo(i,"tensors","concat");e[0].dtype==="complex64"&&e.forEach(function(s){if(s.dtype!=="complex64")throw new Error(`Cannot concatenate complex64 tensors with a tensor
          with dtype `+s.dtype+". ")}),t=Ze(t,e[0].shape)[0];var n=ur(e.map(function(s){return s.shape}),t);if(re(n)===0)return st([],n);if((e=e.filter(function(s){return s.size>0})).length===1)return e[0];var r=e.map(function(s){return s.shape});Fd(r,t);var o=e,a={axis:t};return R.runKernelFunc(function(s){return s.concat(e,t)},o,function(s){var u=r.map(function(c){return c[t]});return oc(s,u,t).map(function(c){return function(){return c}})},"Concat",a)}}),mx=F({concat1d_:function(i){return ze(i,0)}}),vx=F({concat2d_:function(i,t){return ze(i,t)}}),gx=F({concat3d_:function(i,t){return ze(i,t)}}),yx=F({concat4d_:function(i,t){return ze(i,t)}}),oc=F({split_:function(i,t,e){e===void 0&&(e=0);var n,r=_(i,"x","split");return e=Ze(e,r.shape)[0],typeof t=="number"?(E(r.shape[e]%t==0,function(){return"Number of splits must evenly divide the axis."}),n=new Array(t).fill(r.shape[e]/t)):(E(r.shape[e]===t.reduce(function(o,a){return o+a}),function(){return"The sum of sizes must match the size of the axis dimension."}),n=t),R.runKernelFunc(function(o){return o.split(r,n,e)},{$x:r},function(o){return{$x:function(){return ze(o,e)}}})}});function hr(i,t){return i(t={exports:{}},t.exports),t.exports}var xx=hr(function(i){(function(t,e,n){function r(s){var u,c=this,l=(u=4022871197,function(f){f=f.toString();for(var h=0;h<f.length;h++){var p=.02519603282416938*(u+=f.charCodeAt(h));p-=u=p>>>0,u=(p*=u)>>>0,u+=4294967296*(p-=u)}return 23283064365386963e-26*(u>>>0)});c.next=function(){var f=2091639*c.s0+23283064365386963e-26*c.c;return c.s0=c.s1,c.s1=c.s2,c.s2=f-(c.c=0|f)},c.c=1,c.s0=l(" "),c.s1=l(" "),c.s2=l(" "),c.s0-=l(s),c.s0<0&&(c.s0+=1),c.s1-=l(s),c.s1<0&&(c.s1+=1),c.s2-=l(s),c.s2<0&&(c.s2+=1),l=null}function o(s,u){return u.c=s.c,u.s0=s.s0,u.s1=s.s1,u.s2=s.s2,u}function a(s,u){var c=new r(s),l=u&&u.state,f=c.next;return f.int32=function(){return 4294967296*c.next()|0},f.double=function(){return f()+11102230246251565e-32*(2097152*f()|0)},f.quick=f,l&&(typeof l=="object"&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.alea=a})(0,i,!1)}),bx=hr(function(i){(function(t,e,n){function r(s){var u=this,c="";u.x=0,u.y=0,u.z=0,u.w=0,u.next=function(){var f=u.x^u.x<<11;return u.x=u.y,u.y=u.z,u.z=u.w,u.w^=u.w>>>19^f^f>>>8},s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),u.next()}function o(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u}function a(s,u){var c=new r(s),l=u&&u.state,f=function(){return(c.next()>>>0)/4294967296};return f.double=function(){do var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152;while(h===0);return h},f.int32=c.next,f.quick=f,l&&(typeof l=="object"&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.xor128=a})(0,i,!1)}),wx=hr(function(i){(function(t,e,n){function r(s){var u=this,c="";u.next=function(){var f=u.x^u.x>>>2;return u.x=u.y,u.y=u.z,u.z=u.w,u.w=u.v,(u.d=u.d+362437|0)+(u.v=u.v^u.v<<4^f^f<<1)|0},u.x=0,u.y=0,u.z=0,u.w=0,u.v=0,s===(0|s)?u.x=s:c+=s;for(var l=0;l<c.length+64;l++)u.x^=0|c.charCodeAt(l),l==c.length&&(u.d=u.x<<10^u.x>>>4),u.next()}function o(s,u){return u.x=s.x,u.y=s.y,u.z=s.z,u.w=s.w,u.v=s.v,u.d=s.d,u}function a(s,u){var c=new r(s),l=u&&u.state,f=function(){return(c.next()>>>0)/4294967296};return f.double=function(){do var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152;while(h===0);return h},f.int32=c.next,f.quick=f,l&&(typeof l=="object"&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.xorwow=a})(0,i,!1)}),Cx=hr(function(i){(function(t,e,n){function r(s){var u=this;u.next=function(){var c,l,f=u.x,h=u.i;return c=f[h],l=(c^=c>>>7)^c<<24,l^=(c=f[h+1&7])^c>>>10,l^=(c=f[h+3&7])^c>>>3,l^=(c=f[h+4&7])^c<<7,c=f[h+7&7],l^=(c^=c<<13)^c<<9,f[h]=l,u.i=h+1&7,l},function(c,l){var f,h=[];if(l===(0|l))h[0]=l;else for(l=""+l,f=0;f<l.length;++f)h[7&f]=h[7&f]<<15^l.charCodeAt(f)+h[f+1&7]<<13;for(;h.length<8;)h.push(0);for(f=0;f<8&&h[f]===0;++f);for(f==8?h[7]=-1:h[f],c.x=h,c.i=0,f=256;f>0;--f)c.next()}(u,s)}function o(s,u){return u.x=s.x.slice(),u.i=s.i,u}function a(s,u){s==null&&(s=+new Date);var c=new r(s),l=u&&u.state,f=function(){return(c.next()>>>0)/4294967296};return f.double=function(){do var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152;while(h===0);return h},f.int32=c.next,f.quick=f,l&&(l.x&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.xorshift7=a})(0,i,!1)}),_x=hr(function(i){(function(t,e,n){function r(s){var u=this;u.next=function(){var c,l,f=u.w,h=u.X,p=u.i;return u.w=f=f+1640531527|0,l=h[p+34&127],c=h[p=p+1&127],l^=l<<13,c^=c<<17,l^=l>>>15,c^=c>>>12,l=h[p]=l^c,u.i=p,l+(f^f>>>16)|0},function(c,l){var f,h,p,d,m,v=[],g=128;for(l===(0|l)?(h=l,l=null):(l+="\0",h=0,g=Math.max(g,l.length)),p=0,d=-32;d<g;++d)l&&(h^=l.charCodeAt((d+32)%l.length)),d===0&&(m=h),h^=h<<10,h^=h>>>15,h^=h<<4,h^=h>>>13,d>=0&&(m=m+1640531527|0,p=(f=v[127&d]^=h+m)==0?p+1:0);for(p>=128&&(v[127&(l&&l.length||0)]=-1),p=127,d=512;d>0;--d)h=v[p+34&127],f=v[p=p+1&127],h^=h<<13,f^=f<<17,h^=h>>>15,f^=f>>>12,v[p]=h^f;c.w=m,c.X=v,c.i=p}(u,s)}function o(s,u){return u.i=s.i,u.w=s.w,u.X=s.X.slice(),u}function a(s,u){s==null&&(s=+new Date);var c=new r(s),l=u&&u.state,f=function(){return(c.next()>>>0)/4294967296};return f.double=function(){do var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152;while(h===0);return h},f.int32=c.next,f.quick=f,l&&(l.X&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.xor4096=a})(0,i,!1)}),Ex=hr(function(i){(function(t,e,n){function r(s){var u=this,c="";u.next=function(){var f=u.b,h=u.c,p=u.d,d=u.a;return f=f<<25^f>>>7^h,h=h-p|0,p=p<<24^p>>>8^d,d=d-f|0,u.b=f=f<<20^f>>>12^h,u.c=h=h-p|0,u.d=p<<16^h>>>16^d,u.a=d-f|0},u.a=0,u.b=0,u.c=-1640531527,u.d=1367130551,s===Math.floor(s)?(u.a=s/4294967296|0,u.b=0|s):c+=s;for(var l=0;l<c.length+20;l++)u.b^=0|c.charCodeAt(l),u.next()}function o(s,u){return u.a=s.a,u.b=s.b,u.c=s.c,u.d=s.d,u}function a(s,u){var c=new r(s),l=u&&u.state,f=function(){return(c.next()>>>0)/4294967296};return f.double=function(){do var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152;while(h===0);return h},f.int32=c.next,f.quick=f,l&&(typeof l=="object"&&o(l,c),f.state=function(){return o(c,{})}),f}e&&e.exports?e.exports=a:n&&n.amd?n(function(){return a}):this.tychei=a})(0,i,!1)}),nr=hr(function(i){(function(t,e){var n,r=this,o=256,a=6,s="random",u=e.pow(o,a),c=e.pow(2,52),l=2*c,f=o-1;function h(g,x,w){var y=[],b=m(function A(k,D){var T,I=[],W=typeof k;if(D&&W=="object")for(T in k)try{I.push(A(k[T],D-1))}catch{}return I.length?I:W=="string"?k:k+"\0"}((x=x==1?{entropy:!0}:x||{}).entropy?[g,v(t)]:g??function(){try{var A;return n&&(A=n.randomBytes)?A=A(o):(A=new Uint8Array(o),(r.crypto||r.msCrypto).getRandomValues(A)),v(A)}catch{var k=r.navigator,D=k&&k.plugins;return[+new Date,r,D,r.screen,v(t)]}}(),3),y),C=new p(y),S=function(){for(var A=C.g(a),k=u,D=0;A<c;)A=(A+D)*o,k*=o,D=C.g(1);for(;A>=l;)A/=2,k/=2,D>>>=1;return(A+D)/k};return S.int32=function(){return 0|C.g(4)},S.quick=function(){return C.g(4)/4294967296},S.double=S,m(v(C.S),t),(x.pass||w||function(A,k,D,T){return T&&(T.S&&d(T,C),A.state=function(){return d(C,{})}),D?(e[s]=A,k):A})(S,b,"global"in x?x.global:this==e,x.state)}function p(g){var x,w=g.length,y=this,b=0,C=y.i=y.j=0,S=y.S=[];for(w||(g=[w++]);b<o;)S[b]=b++;for(b=0;b<o;b++)S[b]=S[C=f&C+g[b%w]+(x=S[b])],S[C]=x;(y.g=function(A){for(var k,D=0,T=y.i,I=y.j,W=y.S;A--;)k=W[T=f&T+1],D=D*o+W[f&(W[T]=W[I=f&I+k])+(W[I]=k)];return y.i=T,y.j=I,D})(o)}function d(g,x){return x.i=g.i,x.j=g.j,x.S=g.S.slice(),x}function m(g,x){for(var w,y=g+"",b=0;b<y.length;)x[f&b]=f&(w^=19*x[f&b])+y.charCodeAt(b++);return v(x)}function v(g){return String.fromCharCode.apply(0,g)}if(e["seed"+s]=h,m(e.random(),t),i.exports){i.exports=h;try{n=$h()}catch{}}})([],Math)});nr.alea=xx,nr.xor128=bx,nr.xorwow=wx,nr.xorshift7=Cx,nr.xor4096=_x,nr.tychei=Ex;var na=nr.alea,ac=function(){function i(t,e,n,r,o){this.mean=t,this.stdDev=e,this.dtype=n,this.nextVal=NaN,this.truncated=r,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var a=o||Math.random();this.random=na(a.toString())}return i.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var t=this.nextVal;return this.nextVal=NaN,t}for(var e,n,r=!1;!r;){var o=void 0,a=void 0,s=void 0;do s=(o=2*this.random()-1)*o+(a=2*this.random()-1)*a;while(s>=1||s===0);var u=Math.sqrt(-2*Math.log(s)/s);e=this.mean+this.stdDev*o*u,n=this.mean+this.stdDev*a*u,this.truncated&&!this.isValidTruncated(e)||(r=!0)}return this.truncated&&!this.isValidTruncated(n)||(this.nextVal=this.convertValue(n)),this.convertValue(e)},i.prototype.convertValue=function(t){return this.dtype==null||this.dtype==="float32"?t:Math.round(t)},i.prototype.isValidTruncated=function(t){return t<=this.upper&&t>=this.lower},i}(),kx=function(){function i(t,e,n,r){this.alpha=t,this.beta=1/e,this.dtype=n;var o=r||Math.random();this.randu=na(o.toString()),this.randn=new ac(0,1,n,!1,this.randu()),this.d=t<1?t+2/3:t-1/3,this.c=1/Math.sqrt(9*this.d)}return i.prototype.nextValue=function(){for(var t,e,n,r,o,a;;){do r=this.randn.nextValue(),a=1+this.c*r;while(a<=0);if(a*=a*a,e=1-.331*(t=r*r)*t,n=.5*t+this.d*(1-a+Math.log(a)),(o=this.randu())<e||Math.log(o)<n)break}return a=1/this.beta*this.d*a,this.alpha<1&&(a*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(a)},i.prototype.convertValue=function(t){return this.dtype==="float32"?t:Math.round(t)},i}(),Dx=function(){function i(t,e,n,r){var o=this;if(t===void 0&&(t=0),e===void 0&&(e=1),this.canReturnFloat=function(){return o.dtype==null||o.dtype==="float32"},this.min=t,this.range=e-t,this.dtype=n,r==null&&(r=Math.random()),typeof r=="number"&&(r=r.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+t+" - "+e+" <= 1 and dtype is not float");this.random=na(r)}return i.prototype.convertValue=function(t){return this.canReturnFloat()?t:Math.round(t)},i.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},i}();function le(i,t,e){return t===void 0&&(t="float32"),t=t||"float32",tc(i),new Si(i,t,e)}function Sx(i,t){t===void 0&&(t=!1),console.log(i.toString(t))}var Id=F({batchToSpaceND_:function(i,t,e){var n=_(i,"x","batchToSpaceND"),r=t.reduce(function(o,a){return o*a});return E(n.rank>=1+t.length,function(){return"input rank is "+n.rank+" but should be > than blockShape.length "+t.length}),E(e.length===t.length,function(){return"crops.length is "+e.length+" but should be equal to blockShape.length  "+t.length}),E(n.shape[0]%r==0,function(){return"input tensor batch is "+n.shape[0]+" but is not divisible by the product of the elements of blockShape "+t.join(" * ")+" === "+r}),R.runKernelFunc(function(o){return o.batchToSpaceND(n,t,e)},{$x:n},function(o){return{$x:function(){return o.spaceToBatchND(t,e)}}})}}),Ax=F({broadcastTo_:function(i,t){var e=_(i,"broadcastTo","x"),n=e.shape;if(t.some(function(u){return!(u>0)||u%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+t+"].");if(t.length<e.rank)throw new Error("broadcastTo(): shape.length="+t.length+" < input.rank="+e.rank+".");if(t.length>e.rank){for(var r=e.shape.slice();r.length<t.length;)r.unshift(1);e=e.reshape(r)}for(var o=Array.from(t),a=t.length-1;a>=0;a--)if(e.shape[a]===t[a])o[a]=1;else if(e.shape[a]!==1)throw new Error("broadcastTo(): ["+n+"] cannot be broadcast to ["+t+"].");var s=o.map(function(u,c){return u>1?c:-1}).filter(function(u){return u>=0});return s.length===0?e.clone():R.runKernelFunc(function(u){return u.tile(e,o)},{input:e},function(u){return{input:function(){return u.sum(s,!0)}}})}}),Fx=F({cast_:function(i,t){var e=_(i,"x","cast");if(!Gp(t))throw new Error("Failed to cast to unknown dtype "+t);if(t==="string"&&e.dtype!=="string"||t!=="string"&&e.dtype==="string")throw new Error("Only strings can be casted to strings");var n={dtype:t};return R.runKernelFunc(function(r){return r.cast(e,t)},{x:e},function(r){return{x:function(){return r.clone()}}},"Cast",n)}}),Rx=F({clone_:function(i){var t=_(i,"x","clone",null);return R.runKernelFunc(function(){return R.makeTensorFromDataId(t.dataId,t.shape,t.dtype)},{$x:t},function(e){return{$x:function(){return e.toFloat()}}})}}),Ix=F({cumsum_:function(i,t,e,n){t===void 0&&(t=0),e===void 0&&(e=!1),n===void 0&&(n=!1);var r=_(i,"x","cumsum"),o=Zt([t|=0],r.rank),a=r;o!=null&&(a=r.transpose(o));var s=en(1,r.rank)[0],u=R.runKernelFunc(function(c){return c.cumsum(a,s,e,n)},{permutedX:a},function(c){return{permutedX:function(){return c.cumsum(t,e,!n)}}});return o!=null&&(u=u.transpose(o)),u}}),Tx=F({depthToSpace_:function(i,t,e){e===void 0&&(e="NHWC");var n=_(i,"x","depthToSpace"),r=e==="NHWC"?n.shape[1]:n.shape[2],o=e==="NHWC"?n.shape[2]:n.shape[3],a=e==="NHWC"?n.shape[3]:n.shape[1];return E(r*t>=0,function(){return`Negative dimension size caused by overflow when multiplying
      `+r+" and "+t+`  for depthToSpace with input shape
      `+n.shape}),E(o*t>=0,function(){return`Negative dimension size caused by overflow when multiplying
      `+o+" and "+t+` for depthToSpace with input shape
          `+n.shape}),E(a%(t*t)==0,function(){return"Dimension size must be evenly divisible by "+t*t+" but is "+a+" for depthToSpace with input shape "+n.shape}),R.runKernelFunc(function(s){return s.depthToSpace(n,t,e)},{$x:n})}}),xt=F({expandDims_:function(i,t){t===void 0&&(t=0);var e=_(i,"x","expandDims",null);E(t<=e.rank,function(){return"Axis must be <= rank of the tensor"});var n=e.shape.slice();return t<0&&(E(-(e.rank+1)<=t,function(){return"Axis must be in the interval ["+-(e.rank+1)+", "+e.rank+"]"}),t=e.rank+t+1),n.splice(t,0,1),Dt(e,n)}}),Td=F({eye_:function(i,t,e,n){n===void 0&&(n="float32"),t==null&&(t=i);for(var r=le([i,t],n),o=i<=t?i:t,a=0;a<o;++a)r.set(1,a,a);var s=r.toTensor().as2D(i,t);if(e==null)return s;if(e.length===1)return ar(xt(s,0),[e[0],1,1]);if(e.length===2)return ar(xt(xt(s,0),0),[e[0],e[1],1,1]);if(e.length===3)return ar(xt(xt(xt(s,0),0),0),[e[0],e[1],e[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+e.length+"D.")}}),Nx=F({multinomial_:function(i,t,e,n){n===void 0&&(n=!1);var r=_(i,"logits","multinomial"),o=r.size,a=r.rank;if(o<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+o+".");if(a>2)throw new Error("Rank of probabilities must be 1 or 2, but is "+a);e=e||Math.random();var s=a===1?r.as2D(1,-1):r,u=R.runKernelFunc(function(c){return c.multinomial(s,n,t,e)},{logits2D:s});return a===1?u.as1D():u}}),Vu=F({oneHot_:function(i,t,e,n){if(e===void 0&&(e=1),n===void 0&&(n=0),t<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+t);var r=_(i,"indices","oneHot","int32"),o=r.shape.concat([t]);return r=r.flatten(),R.runKernelFunc(function(a){return a.oneHot(r,t,e,n)},{$indices:r},function(a){return{$indices:function(){return Le(r.shape,"float32")}}}).reshape(o)}}),An=F({pad_:function(i,t,e){e===void 0&&(e=0);var n=_(i,"x","pad");if(n.rank===0)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");var r={paddings:t,constantValue:e};return R.runKernelFunc(function(o){return o.pad(n,t,e)},{x:n},function(o){var a=t.map(function(s){return s[0]});return{x:function(){return o.slice(a,n.shape)}}},"PadV2",r)}}),Px=F({pad1d_:function(i,t,e){return e===void 0&&(e=0),E(t.length===2,function(){return"Invalid number of paddings. Must be length of 2."}),An(i,[t],e)}}),Mx=F({pad2d_:function(i,t,e){return e===void 0&&(e=0),E(t.length===2&&t[0].length===2&&t[1].length===2,function(){return"Invalid number of paddings. Must be length of 2 each."}),An(i,t,e)}}),Ox=F({pad3d_:function(i,t,e){return e===void 0&&(e=0),E(t.length===3&&t[0].length===2&&t[1].length===2&&t[2].length===2,function(){return"Invalid number of paddings. Must be length of 2 each."}),An(i,t,e)}}),Bx=F({pad4d_:function(i,t,e){return e===void 0&&(e=0),E(t.length===4&&t[0].length===2&&t[1].length===2&&t[2].length===2&&t[3].length===2,function(){return"Invalid number of paddings. Must be length of 2 each."}),An(i,t,e)}}),Lx=F({rand_:function(i,t,e){var n=re(i),r=null;if(e==null||e==="float32")r=new Float32Array(n);else if(e==="int32")r=new Int32Array(n);else{if(e!=="bool")throw new Error("Unknown data type "+e);r=new Uint8Array(n)}for(var o=0;o<n;o++)r[o]=t();return R.makeTensor(r,i,e)}}),Wx=F({randomNormal_:function(i,t,e,n,r){if(t===void 0&&(t=0),e===void 0&&(e=1),n!=null&&n==="bool")throw new Error("Unsupported data type "+n);for(var o=new ac(t,e,n,!1,r),a=le(i,n),s=0;s<a.values.length;s++)a.values[s]=o.nextValue();return a.toTensor()}}),zx=F({randomGamma_:function(i,t,e,n,r){if(e===void 0&&(e=1),n===void 0&&(n="float32"),e==null&&(e=1),n==null&&(n="float32"),n!=="float32"&&n!=="int32")throw new Error("Unsupported data type "+n);for(var o=new kx(t,e,n,r),a=le(i,n),s=0;s<a.values.length;s++)a.values[s]=o.nextValue();return a.toTensor()}}),Nd=F({randomUniform_:function(i,t,e,n,r){t===void 0&&(t=0),e===void 0&&(e=1),n===void 0&&(n="float32");for(var o=le(i,n),a=new Dx(t,e,null,r),s=0;s<o.values.length;s++)o.values[s]=a.nextValue();return o.toTensor()}}),Dt=F({reshape_:function(i,t){var e=_(i,"x","reshape",null);t=Up(t,e.size),E(e.size===re(t),function(){return"new shape and old shape must have the same number of elements."});var n={shape:t};return R.runKernelFunc(function(r){return r.reshape(e,t)},{x:e},function(r){return{x:function(){return r.reshape(e.shape)}}},"Reshape",n)}}),Pd=F({spaceToBatchND_:function(i,t,e){var n=_(i,"x","spaceToBatchND");return E(n.rank>=1+t.length,function(){return"input rank "+n.rank+" should be > than [blockShape] "+t.length}),E(e.length===t.length,function(){return"paddings.shape[0] "+e.length+" must be equal to [blockShape] "+t.length}),E(n.shape.reduce(function(r,o,a){return a>0&&a<=t.length?r&&(o+e[a-1][0]+e[a-1][1])%t[a-1]==0:r},!0),function(){return"input spatial dimensions "+n.shape.slice(1)+" with paddings "+e.toString()+" must be divisible by blockShapes "+t.toString()}),R.runKernelFunc(function(r){return r.spaceToBatchND(n,t,e)},{$x:n},function(r){return{$x:function(){return r.batchToSpaceND(t,e)}}})}}),Md=F({squeeze_:function(i,t){var e=_(i,"x","squeeze");return Dt(e,qn(e.shape,t).newShape)}}),mt=F({stack_:function(i,t){t===void 0&&(t=0);var e=Uo(i,"tensors","stack");if(E(e.length>=1,function(){return"Pass at least one tensor to tf.stack"}),e.length===1)return e[0].expandDims(t);var n=e[0].rank,r=e[0].shape,o=e[0].dtype;E(t<=n,function(){return"Axis must be <= rank of the tensor"}),e.forEach(function(s){Ae(r,s.shape,"All tensors passed to stack must have matching shapes")}),e.forEach(function(s){E(o===s.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var a=e.map(function(s){return s.expandDims(t)});return ze(a,t)}}),ar=F({tile_:function(i,t){var e=_(i,"x","tile",null);E(e.rank===t.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of reps "+t+"."});var n=[e],r={reps:t};return R.runKernelFunc(function(o,a){var s=o.tile(e,t);return a([e]),s},{x:e},function(o,a){var s=a[0];return{x:function(){var u=De(s);if(s.rank===1)for(var c=0;c<t[0];++c)u=u.add(o.slice([c*s.shape[0]],[s.shape[0]]));else if(s.rank===2)for(c=0;c<t[0];++c)for(var l=0;l<t[1];++l)u=u.add(o.slice([c*s.shape[0],l*s.shape[1]],[s.shape[0],s.shape[1]]));else if(s.rank===3)for(c=0;c<t[0];++c)for(l=0;l<t[1];++l)for(var f=0;f<t[2];++f)u=u.add(o.slice([c*s.shape[0],l*s.shape[1],f*s.shape[2]],[s.shape[0],s.shape[1],s.shape[2]]));else{if(s.rank!==4)throw new Error("Gradient for tile operation is not implemented for rank-"+s.rank+" tensors yet.");for(c=0;c<t[0];++c)for(l=0;l<t[1];++l)for(f=0;f<t[2];++f)for(var h=0;h<t[3];++h)u=u.add(o.slice([c*s.shape[0],l*s.shape[1],f*s.shape[2],h*s.shape[3]],[s.shape[0],s.shape[1],s.shape[2],s.shape[3]]))}return u}}},"Tile",r,n)}}),qx=F({truncatedNormal_:function(i,t,e,n,r){if(t===void 0&&(t=0),e===void 0&&(e=1),n!=null&&n==="bool")throw new Error("Unsupported data type "+n);for(var o=new ac(t,e,n,!0,r),a=le(i,n),s=0;s<a.values.length;s++)a.values[s]=o.nextValue();return a.toTensor()}}),Te=F({unstack_:function(i,t){t===void 0&&(t=0),t=t||0;var e=_(i,"x","unstack");E(t>=-e.shape.length&&t<e.shape.length,function(){return"Axis = "+t+" is not in [-"+e.shape.length+", "+e.shape.length+")"}),t<0&&(t+=e.shape.length);var n={axis:t};return R.runKernelFunc(function(r){return r.unstack(e,t)},{x:e},function(r){return{x:function(){return mt(r,t)}}},"Unpack",n)}}),Vx=function(i,t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s,u,c,l,f;return ne(this,function(h){switch(h.label){case 0:return e=_(i,"x","setdiff1d"),n=_(t,"y","setdiff1d"),E(e.dtype===n.dtype,function(){return"x and y should have the same dtype, but got x ("+e.dtype+") and y ("+n.dtype+")."}),E(e.rank===1,function(){return"x should be 1D tensor, but got x ("+e.shape+")."}),E(n.rank===1,function(){return"y should be 1D tensor, but got y ("+n.shape+")."}),[4,e.data()];case 1:return r=h.sent(),[4,n.data()];case 2:for(o=h.sent(),a=new Set(o),s=0,l=0;l<r.length;l++)a.has(r[l])||s++;for(u=new Si([s],e.dtype),c=new Si([s],"int32"),l=0,f=0;l<r.length;l++)a.has(r[l])||(u.values[f]=r[l],c.values[f]=l,f++);return[2,[u.toTensor(),c.toTensor()]]}})})};function Go(i,t,e,n){n===void 0&&(n=!0);var r=[];if(n)(r=r.concat(t.slice(0))).push(i[0]/e),r=r.concat(i.slice(1));else{r=r.concat(i[0]);for(var o=t.length,a=0;a<o;++a)r=r.concat([i[a+1]/t[a],t[a]]);r=r.concat(i.slice(o+1))}return r}function Ho(i,t,e){e===void 0&&(e=!0);var n=[];if(e){n.push(t);for(var r=t+1;r<i;++r)r<=2*t?(n.push(r),n.push(r-(t+1))):n.push(r)}else{var o=[],a=[];for(r=1;r<i;++r)r>=2*t+1||r%2==1?a.push(r):o.push(r);n.push.apply(n,o),n.push(0),n.push.apply(n,a)}return n}function Ko(i,t,e,n){n===void 0&&(n=!0);var r=[];n?r.push(i[0]/e):r.push(i[0]*e);for(var o=1;o<i.length;++o)o<=t.length?n?r.push(t[o-1]*i[o]):r.push(i[o]/t[o-1]):r.push(i[o]);return r}function Od(i,t){for(var e=[0],n=0;n<t;++n)e.push(i[n][0]);return e}function Bd(i,t,e){for(var n=i.slice(0,1),r=0;r<e;++r)n.push(i[r+1]-t[r][0]-t[r][1]);return n}function sc(i,t){if(i.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+i.rank+".");if(t.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if(t.dtype!=="int32")throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+t.dtype+".");if(t.shape[t.rank-1]>i.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+t.shape[t.rank-1]+" vs. "+i.rank);if(i.size===0)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+i.shape+".");for(var e=t.shape,n=e[e.length-1],r=1,o=0;o<e.length-1;++o)r*=e[o];var a=i.shape,s=e.slice();s.pop();var u=1;for(o=n;o<i.rank;++o)u*=a[o],s.push(a[o]);var c=Yt(i.shape).map(function(l){return l/u}).concat([1]).slice(0,n);return[s,r,u,c]}var $k=Object.freeze({prepareAndValidate:sc}),uc=30;function Mo(i){return i<=uc?i:qo(i,Math.floor(Math.sqrt(i)))}function Ld(i,t,e){var n=t.rank>1?t.shape[t.rank-1]:1,r=t.rank>1?t.rank-1:1,o="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+e.shape+", indices.shape: "+t.shape+", shape: "+i+", sliceDim: "+n+", and batchDim: "+r+".";if(e.rank<r)throw new Error(o+" update.rank < "+r+". ");if(i.length<n+(e.rank-r))throw new Error(o+" Output shape length < "+(n+(e.rank-r)));if(e.rank!==r+i.length-n)throw new Error(o+" update.rank != "+(r+i.length-n));for(var a=0;a<r;++a)if(e.shape[a]!==t.shape[a])throw new Error(o+" updates.shape["+a+"] ("+e.shape[a]+") != indices.shape["+a+"] ("+t.shape[a]+").");for(a=0;a<e.rank-r;++a)if(e.shape[a+r]!==i[a+n])throw new Error(o+" updates.shape["+(a+r)+"] ("+e.shape[a+r]+") != shape["+(a+r)+"] ("+i[a+r]+")")}function Wd(i,t,e){if(t.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+t.rank+".");if(i.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+i.rank+".");if(t.dtype!=="int32")throw new Error("The dtype of 'indices' should be int32, but got dtype: "+t.dtype);if(e.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+e);if(e.length===0){if(t.size===0)throw new Error("Indices specified for empty output. indices shape: "+t.shape);if(i.size===0)throw new Error("Updates specified for empty output. updates shape: "+i.shape)}Ld(e,t,i)}function Ii(i,t,e){for(var n=t.shape.length,r=n>1?t.shape[n-1]:1,o=e.length,a=1,s=r;s<o;++s)a*=e[s];var u=r<1?1:r;return{sliceRank:r,numUpdates:re(t.shape)/u,sliceSize:a,strides:Yt(e.slice(0,r)).concat([1]),outputSize:re(e)}}var Yk=Object.freeze({validateUpdateShape:Ld,validateInput:Wd,calculateShapes:Ii});function zd(i,t,e){E(i.rank===t.length,function(){return"Error in slice"+i.rank+"D: Length of begin "+t+" must match the rank of the array ("+i.rank+")."}),E(i.rank===e.length,function(){return"Error in slice"+i.rank+"D: Length of size "+e+" must match the rank of the array ("+i.rank+")."});for(var n=function(o){E(t[o]+e[o]<=i.shape[o],function(){return"Error in slice"+i.rank+"D: begin["+o+"] + size["+o+"] ("+(t[o]+e[o])+") would overflow input.shape["+o+"] ("+i.shape[o]+")"})},r=0;r<i.rank;++r)n(r)}function Uu(i){for(var t=[],e=0;i>0;)1&i&&t.push(e),i/=2,e++;return t}function ra(i,t,e){for(var n=[],r=0;r<i.length;r++)n[r]=Math.ceil((t[r]-i[r])/e[r]);return n}function qd(i,t,e,n,r){var o=t[r],a=e[r]||1;(i&1<<r||o==null)&&(o=a>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var s=n[r];return o<0&&(o+=s),o=Lo(0,o,s-1)}function Vd(i,t,e,n,r){var o=t[r],a=e[r]||1;(i&1<<r||o==null)&&(o=a>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var s=n[r];return o<0&&(o+=s),o=a>0?Lo(0,o,s):Lo(-1,o,s-1)}function cc(i,t,e){for(var n=e.length,r=0;r<e.length;r++)if(e[r]>1){n=r;break}for(r=n+1;r<e.length;r++)if(t[r]>0||e[r]!==i[r])return!1;return!0}function lc(i,t){for(var e=i.length>0?i[i.length-1]:1,n=0;n<i.length-1;n++)e+=i[n]*t[n];return e}var Jk=Object.freeze({assertParamsValid:zd,maskToAxes:Uu,computeOutShape:ra,startForAxis:qd,stopForAxis:Vd,isSliceContinous:cc,computeFlatOffset:lc});function Ux(i,t){E(zo(i),function(){return"The f passed in variableGrads(f) must be a function"}),E(t==null||Array.isArray(t)&&t.every(function(l){return l instanceof sr}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var e=t!=null;if(!e)for(var n in t=[],R.registeredVariables)t.push(R.registeredVariables[n]);var r=e?t.filter(function(l){return!l.trainable}):null,o=t.length;E((t=t.filter(function(l){return l.trainable})).length>0,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+o+" variables is trainable."});var a=R.gradients(i,t,null,!0),s=a.value,u=a.grads;E(u.some(function(l){return l!=null}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),E(s.rank===0,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+s.rank+" tensor"});var c={};return t.forEach(function(l,f){u[f]!=null&&(c[l.name]=u[f])}),r?.forEach(function(l){return c[l.name]=null}),{value:s,grads:c}}function ia(i){return R.customGrad(i)}var St=F({softmax_:function(i,t){t===void 0&&(t=-1);var e=_(i,"logits","softmax","float32");if(t===-1&&(t=e.rank-1),t!==e.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and dim was "+t);return R.runKernelFunc(function(n,r){var o=n.softmax(e,t);return r([o]),o},{logits:e},function(n,r){var o=r[0],a=n.mul(o);return{logits:function(){return a.sub(a.sum([t],!0).mul(o))}}},"Softmax",{dim:t},[],[!0])}}),jx=F({logSoftmax_:function(i,t){t===void 0&&(t=-1);var e=_(i,"logits","logSoftmax");if(t===-1&&(t=e.rank-1),t!==e.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+e.rank+" and axis was "+t);return ia(function(n,r){var o=n.max(t,!0),a=n.sub(o),s=a.toFloat().sub(a.exp().sum(t,!0).log());return r([s]),{value:s,gradFunc:function(u,c){var l=c[0].exp();return u.sub(u.sum(t,!0).mul(l))}}})(e)}}),Ud=function(){function i(t,e){this.backend=t,this.dataMover=e,this.data=new WeakMap,this.dataIdsCount=0}return i.prototype.get=function(t){return this.data.has(t)||this.dataMover.moveData(this.backend,t),this.data.get(t)},i.prototype.set=function(t,e){this.dataIdsCount++,this.data.set(t,e)},i.prototype.has=function(t){return this.data.has(t)},i.prototype.delete=function(t){return this.dataIdsCount--,this.data.delete(t)},i.prototype.numDataIds=function(){return this.dataIdsCount},i}(),jd=function(){function i(){}return i.prototype.time=function(t){return N("time")},i.prototype.read=function(t){return N("read")},i.prototype.readSync=function(t){return N("readSync")},i.prototype.numDataIds=function(){return N("numDataIds")},i.prototype.disposeData=function(t){return N("disposeData")},i.prototype.write=function(t,e,n){return N("write")},i.prototype.move=function(t,e,n,r){return N("move")},i.prototype.memory=function(){return N("memory")},i.prototype.floatPrecision=function(){return N("floatPrecision")},i.prototype.epsilon=function(){return this.floatPrecision()===32?1e-7:1e-4},i.prototype.batchMatMul=function(t,e,n,r){return N("batchMatMul")},i.prototype.fusedBatchMatMul=function(t){return t.a,t.b,t.transposeA,t.transposeB,t.bias,t.activation,t.preluActivationWeights,N("fusedBatchMatMul")},i.prototype.slice=function(t,e,n){return N("slice")},i.prototype.stridedSlice=function(t,e,n,r){return N("stridedSlice")},i.prototype.unstack=function(t,e){return N("unstack")},i.prototype.reverse=function(t,e){return N("reverse")},i.prototype.concat=function(t,e){return N("concat")},i.prototype.neg=function(t){return N("neg")},i.prototype.add=function(t,e){return N("add")},i.prototype.addN=function(t){return N("addN")},i.prototype.subtract=function(t,e){return N("subtract")},i.prototype.multiply=function(t,e){return N("multiply")},i.prototype.realDivide=function(t,e){return N("realDivide")},i.prototype.floorDiv=function(t,e){return N("floorDiv")},i.prototype.sum=function(t,e){return N("sum")},i.prototype.prod=function(t,e){return N("prod")},i.prototype.unsortedSegmentSum=function(t,e,n){return N("unsortedSegmentSum")},i.prototype.argMin=function(t,e){return N("argMin")},i.prototype.argMax=function(t,e){return N("argMax")},i.prototype.equal=function(t,e){return N("equal")},i.prototype.notEqual=function(t,e){return N("notEqual")},i.prototype.less=function(t,e){return N("less")},i.prototype.lessEqual=function(t,e){return N("lessEqual")},i.prototype.greater=function(t,e){return N("greater")},i.prototype.greaterEqual=function(t,e){return N("greaterEqual")},i.prototype.logicalNot=function(t){return N("logicalNot")},i.prototype.logicalAnd=function(t,e){return N("logicalAnd")},i.prototype.logicalOr=function(t,e){return N("logicalOr")},i.prototype.where=function(t){return N("where")},i.prototype.select=function(t,e,n){return N("select")},i.prototype.topk=function(t,e,n){return N("topk")},i.prototype.min=function(t,e){return N("min")},i.prototype.minimum=function(t,e){return N("minimum")},i.prototype.mod=function(t,e){return N("mod")},i.prototype.max=function(t,e){return N("max")},i.prototype.maximum=function(t,e){return N("maximum")},i.prototype.all=function(t,e){return N("all")},i.prototype.any=function(t,e){return N("any")},i.prototype.squaredDifference=function(t,e){return N("squaredDifference")},i.prototype.ceil=function(t){return N("ceil")},i.prototype.floor=function(t){return N("floor")},i.prototype.round=function(t){return N("round")},i.prototype.sign=function(t){return N("sign")},i.prototype.isNaN=function(t){return N("isNaN")},i.prototype.isInf=function(t){return N("isInf")},i.prototype.isFinite=function(t){return N("isFinite")},i.prototype.pow=function(t,e){return N("pow")},i.prototype.exp=function(t){return N("exp")},i.prototype.expm1=function(t){return N("expm1")},i.prototype.softmax=function(t,e){return N("softmax")},i.prototype.log=function(t){return N("log")},i.prototype.log1p=function(t){return N("log1p")},i.prototype.sqrt=function(t){return N("sqrt")},i.prototype.rsqrt=function(t){return N("rsqrt")},i.prototype.square=function(t){return N("square")},i.prototype.reciprocal=function(t){return N("reciprocal")},i.prototype.relu=function(t){return N("relu")},i.prototype.relu6=function(t){return N("relu6")},i.prototype.prelu=function(t,e){return N("prelu")},i.prototype.elu=function(t){return N("elu")},i.prototype.eluDer=function(t,e){return N("eluDer")},i.prototype.selu=function(t){return N("selu")},i.prototype.int=function(t){return N("int")},i.prototype.clip=function(t,e,n){return N("clip")},i.prototype.abs=function(t){return N("abs")},i.prototype.complexAbs=function(t){return N("complexAbs")},i.prototype.sigmoid=function(t){return N("sigmoid")},i.prototype.softplus=function(t){return N("softplus")},i.prototype.sin=function(t){return N("sin")},i.prototype.cos=function(t){return N("cos")},i.prototype.tan=function(t){return N("tan")},i.prototype.asin=function(t){return N("asin")},i.prototype.acos=function(t){return N("acos")},i.prototype.atan=function(t){return N("atan")},i.prototype.atan2=function(t,e){return N("atan2")},i.prototype.sinh=function(t){return N("sinh")},i.prototype.cosh=function(t){return N("cosh")},i.prototype.tanh=function(t){return N("tanh")},i.prototype.asinh=function(t){return N("asinh")},i.prototype.acosh=function(t){return N("acosh")},i.prototype.atanh=function(t){return N("atanh")},i.prototype.erf=function(t){return N("erf")},i.prototype.step=function(t,e){return N("step")},i.prototype.fusedConv2d=function(t){return t.input,t.filter,t.convInfo,t.bias,t.activation,t.preluActivationWeights,N("fusedConv2d")},i.prototype.conv2d=function(t,e,n){return N("conv2d")},i.prototype.conv2dDerInput=function(t,e,n){return N("conv2dDerInput")},i.prototype.conv2dDerFilter=function(t,e,n){return N("conv2dDerFilter")},i.prototype.fusedDepthwiseConv2D=function(t){return t.input,t.filter,t.convInfo,t.bias,t.activation,t.preluActivationWeights,N("fusedDepthwiseConv2D")},i.prototype.depthwiseConv2D=function(t,e,n){return N("depthwiseConv2D")},i.prototype.depthwiseConv2DDerInput=function(t,e,n){return N("depthwiseConv2DDerInput")},i.prototype.depthwiseConv2DDerFilter=function(t,e,n){return N("depthwiseConv2DDerFilter")},i.prototype.conv3d=function(t,e,n){return N("conv3d")},i.prototype.conv3dDerInput=function(t,e,n){return N("conv3dDerInput")},i.prototype.conv3dDerFilter=function(t,e,n){return N("conv3dDerFilter")},i.prototype.maxPool=function(t,e){return N("maxPool")},i.prototype.maxPoolBackprop=function(t,e,n,r){return N("maxPoolBackprop")},i.prototype.avgPool=function(t,e){return N("avgPool")},i.prototype.avgPoolBackprop=function(t,e,n){return N("avgPoolBackprop")},i.prototype.avgPool3d=function(t,e){return N("avgPool3d")},i.prototype.avgPool3dBackprop=function(t,e,n){return N("avgPool3dBackprop")},i.prototype.maxPool3d=function(t,e){return N("maxPool3d")},i.prototype.maxPool3dBackprop=function(t,e,n,r){return N("maxPool3dBackprop")},i.prototype.reshape=function(t,e){return N("reshape")},i.prototype.cast=function(t,e){return N("cast")},i.prototype.tile=function(t,e){return N("tile")},i.prototype.pad=function(t,e,n){return N("pad")},i.prototype.transpose=function(t,e){return N("transpose")},i.prototype.gather=function(t,e,n){return N("gather")},i.prototype.gatherND=function(t,e){return N("gatherND")},i.prototype.scatterND=function(t,e,n){return N("scatterND")},i.prototype.batchToSpaceND=function(t,e,n){return N("batchToSpaceND")},i.prototype.spaceToBatchND=function(t,e,n){return N("spaceToBatchND")},i.prototype.resizeBilinear=function(t,e,n,r){return N("resizeBilinear")},i.prototype.resizeBilinearBackprop=function(t,e,n){return N("resizeBilinearBackprop")},i.prototype.resizeNearestNeighbor=function(t,e,n,r){return N("resizeNearestNeighbor")},i.prototype.resizeNearestNeighborBackprop=function(t,e,n){return N("resizeNearestNeighborBackprop")},i.prototype.batchNormalization=function(t,e,n,r,o,a){return N("batchNormalization")},i.prototype.localResponseNormalization4D=function(t,e,n,r,o){return N("localResponseNormalization4D")},i.prototype.LRNGrad=function(t,e,n,r,o,a,s){return N("LRNGrad")},i.prototype.multinomial=function(t,e,n,r){return N("multinomial")},i.prototype.oneHot=function(t,e,n,r){return N("oneHot")},i.prototype.cumsum=function(t,e,n,r){return N("cumsum")},i.prototype.nonMaxSuppression=function(t,e,n,r,o){return N("nonMaxSuppression")},i.prototype.fft=function(t){return N("fft")},i.prototype.ifft=function(t){return N("ifft")},i.prototype.complex=function(t,e){return N("complex")},i.prototype.real=function(t){return N("real")},i.prototype.imag=function(t){return N("imag")},i.prototype.cropAndResize=function(t,e,n,r,o,a){return N("cropAndResize")},i.prototype.depthToSpace=function(t,e,n){return N("depthToSpace")},i.prototype.split=function(t,e,n){return N("split")},i.prototype.sparseToDense=function(t,e,n,r){return N("sparseToDense")},i.prototype.diag=function(t){return N("diag")},i.prototype.fill=function(t,e,n){return N("fill")},i.prototype.onesLike=function(t){return N("onesLike")},i.prototype.zerosLike=function(t){return N("zerosLike")},i.prototype.linspace=function(t,e,n){return N("linspace")},i.prototype.dispose=function(){return N("dispose")},i}();function N(i){throw new Error("'"+i+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function kn(i,t){for(var e=i.length,n=[],r=0;r<e;r++){var o=e-1-r,a=i[o]||1;(t[t.length-1-r]||1)>1&&a===1&&n.unshift(o)}return n}function Qe(i,t){for(var e=[],n=0;n<t.length;n++){var r=i[i.length-n-1],o=t.length-n-1,a=t[o];(r==null||r===1&&a>1)&&e.unshift(o)}return e}function ye(i,t){for(var e=[],n=Math.max(i.length,t.length),r=0;r<n;r++){var o=i[i.length-r-1];o==null&&(o=1);var a=t[t.length-r-1];if(a==null&&(a=1),o===1)e.unshift(a);else if(a===1)e.unshift(o);else{if(o!==a)throw Error("Operands could not be broadcast together with shapes "+i+" and "+t+".");e.unshift(o)}}return e}function Vr(i,t,e,n,r,o,a){a===void 0&&(a="channelsLast");var s,u=Xo(t),c=u[0],l=u[1];if(a==="channelsLast")s=[c,l,i[3],i[3]];else{if(a!=="channelsFirst")throw new Error("Unknown dataFormat "+a);s=[c,l,i[1],i[1]]}return Hn(i,s,e,n,r,o,!1,a)}function Ti(i,t,e,n,r,o,a){a===void 0&&(a="NDHWC");var s,u,c=ju(t),l=c[0],f=c[1],h=c[2];if(a==="NDHWC")u="channelsLast",s=[l,f,h,i[4],i[4]];else{if(a!=="NCDHW")throw new Error("Unknown dataFormat "+a);u="channelsFirst",s=[l,f,h,i[1],i[1]]}return Ni(i,s,e,n,r,!1,u,o)}function Hn(i,t,e,n,r,o,a,s){a===void 0&&(a=!1),s===void 0&&(s="channelsLast");var u=[-1,-1,-1,-1],c=u[0],l=u[1],f=u[2],h=u[3];if(s==="channelsLast")c=i[0],l=i[1],f=i[2],h=i[3];else{if(s!=="channelsFirst")throw new Error("Unknown dataFormat "+s);c=i[0],h=i[1],l=i[2],f=i[3]}var p,d=t[0],m=t[1],v=t[3],g=Xo(e),x=g[0],w=g[1],y=Xo(n),b=y[0],C=y[1],S=Br(d,b),A=Br(m,C),k=function(B,L,V,q,z,G,H,Z){var ie,ae,de;if(typeof B=="number"){ie={top:B,bottom:B,left:B,right:B,type:B===0?"VALID":"NUMBER"};var me=function(_e,Pe,Se,Ke,Ve){Ke==null&&(Ke=fc(_e,Pe,Se));var Ue=_e[0],on=_e[1],an=Ei((Ue-Pe+2*Ke)/Se+1,Ve);E(Ge(an),function(){return"The output # of rows ("+an+") must be an integer. Change the stride and/or zero pad parameters"});var Mt=Ei((on-Pe+2*Ke)/Se+1,Ve);return E(Ge(Mt),function(){return"The output # of columns ("+Mt+") must be an integer. Change the stride and/or zero pad parameters"}),[an,Mt]}([L,V],G,q,B,Z);ae=me[0],de=me[1]}else if(B==="same"){ae=Math.ceil(L/q),de=Math.ceil(V/z);var xe=Math.max(0,(ae-1)*q+G-L),Ee=Math.max(0,(de-1)*z+H-V),Ce=Math.floor(xe/2),ke=xe-Ce,$e=Math.floor(Ee/2);ie={top:Ce,bottom:ke,left:$e,right:Ee-$e,type:"SAME"}}else{if(B!=="valid")throw Error("Unknown padding parameter: "+B);ie={top:0,bottom:0,left:0,right:0,type:"VALID"},ae=Math.ceil((L-G+1)/q),de=Math.ceil((V-H+1)/z)}return{padInfo:ie,outHeight:ae,outWidth:de}}(r,l,f,x,w,S,A,o),D=k.padInfo,T=k.outHeight,I=k.outWidth,W=a?v*h:v;return s==="channelsFirst"?p=[c,W,T,I]:s==="channelsLast"&&(p=[c,T,I,W]),{batchSize:c,dataFormat:s,inHeight:l,inWidth:f,inChannels:h,outHeight:T,outWidth:I,outChannels:W,padInfo:D,strideHeight:x,strideWidth:w,filterHeight:d,filterWidth:m,effectiveFilterHeight:S,effectiveFilterWidth:A,dilationHeight:b,dilationWidth:C,inShape:i,outShape:p,filterShape:t}}function Ni(i,t,e,n,r,o,a,s){o===void 0&&(o=!1),a===void 0&&(a="channelsLast");var u=[-1,-1,-1,-1,-1],c=u[0],l=u[1],f=u[2],h=u[3],p=u[4];if(a==="channelsLast")c=i[0],l=i[1],f=i[2],h=i[3],p=i[4];else{if(a!=="channelsFirst")throw new Error("Unknown dataFormat "+a);c=i[0],p=i[1],l=i[2],f=i[3],h=i[4]}var d,m=t[0],v=t[1],g=t[2],x=t[4],w=ju(e),y=w[0],b=w[1],C=w[2],S=ju(n),A=S[0],k=S[1],D=S[2],T=Br(m,A),I=Br(v,k),W=Br(g,D),B=function(H,Z,ie,ae,de,me,xe,Ee,Ce,ke,$e){var _e,Pe,Se,Ke;if(typeof H=="number"){_e={top:H,bottom:H,left:H,right:H,front:H,back:H,type:H===0?"VALID":"NUMBER"};var Ve=function(Er,bn,La,kr,sn,Wa){sn==null&&(sn=fc(Er,bn,kr));var T0=Er[0],N0=Er[1],P0=Er[2],za=Ei((T0-bn+2*sn)/kr+1,Wa);E(Ge(za),function(){return"The output # of depths ("+za+") must be an integer. Change the stride and/or zero pad parameters"});var qa=Ei((N0-bn+2*sn)/kr+1,Wa);E(Ge(qa),function(){return"The output # of rows ("+qa+") must be an integer. Change the stride and/or zero pad parameters"});var Va=Ei((P0-bn+2*sn)/kr+1,Wa);return E(Ge(Va),function(){return"The output # of columns ("+Va+") must be an integer. Change the stride and/or zero pad parameters"}),[za,qa,Va,La]}([Z,ie,ae,1],Ee,1,de,H,$e);Pe=Ve[0],Se=Ve[1],Ke=Ve[2]}else if(H==="same"){Pe=Math.ceil(Z/de),Se=Math.ceil(ie/me),Ke=Math.ceil(ae/xe);var Ue=(Pe-1)*de+Ee-Z,on=(Se-1)*me+Ce-ie,an=(Ke-1)*xe+ke-ae,Mt=Math.floor(Ue/2),_r=Ue-Mt,yn=Math.floor(on/2),Ln=on-yn,xn=Math.floor(an/2);_e={top:yn,bottom:Ln,left:xn,right:an-xn,front:Mt,back:_r,type:"SAME"}}else{if(H!=="valid")throw Error("Unknown padding parameter: "+H);_e={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},Pe=Math.ceil((Z-Ee+1)/de),Se=Math.ceil((ie-Ce+1)/me),Ke=Math.ceil((ae-ke+1)/xe)}return{padInfo:_e,outDepth:Pe,outHeight:Se,outWidth:Ke}}(r,l,f,h,y,b,C,T,I,W,s),L=B.padInfo,V=B.outDepth,q=B.outHeight,z=B.outWidth,G=o?x*p:x;return a==="channelsFirst"?d=[c,G,V,q,z]:a==="channelsLast"&&(d=[c,V,q,z,G]),{batchSize:c,dataFormat:a,inDepth:l,inHeight:f,inWidth:h,inChannels:p,outDepth:V,outHeight:q,outWidth:z,outChannels:G,padInfo:L,strideDepth:y,strideHeight:b,strideWidth:C,filterDepth:m,filterHeight:v,filterWidth:g,effectiveFilterDepth:T,effectiveFilterHeight:I,effectiveFilterWidth:W,dilationDepth:A,dilationHeight:k,dilationWidth:D,inShape:i,outShape:d,filterShape:t}}function fc(i,t,e,n){n===void 0&&(n=1);var r=Br(t,n);return Math.floor((i[0]*(e-1)-e+r)/2)}function Xo(i){return typeof i=="number"?[i,i,i]:i.length===2?[i[0],i[1],1]:i}function ju(i){return typeof i=="number"?[i,i,i]:i}function Br(i,t){return t<=1?i:i+(i-1)*(t-1)}function Ei(i,t){if(!t)return i;switch(t){case"round":return Math.round(i);case"ceil":return Math.ceil(i);case"floor":return Math.floor(i);default:throw new Error("Unknown roundingMode "+t)}}function cr(i){var t=Xo(i),e=t[0],n=t[1],r=t[2];return e===1&&n===1&&r===1}function kt(i,t){return cr(i)||cr(t)}function oa(i){if(i==="NHWC")return"channelsLast";if(i==="NCHW")return"channelsFirst";throw new Error("Unknown dataFormat "+i)}function hc(i,t,e){if(t==="complex64"){if(i.dtype==="complex64")return i.clone();var n=Le(i.shape),r=i.toFloat(),o=e.complex(r,n);return n.dispose(),r.dispose(),o}if(!Hp(i.dtype,t))return R.makeTensorFromDataId(i.dataId,i.shape,t);if(i.dtype==="complex64"){var a=e.real(i);return o=a.cast(t),a.dispose(),o}if(t==="int32")return e.int(i);if(t==="bool"){var s=Y(0,i.dtype);return o=e.notEqual(i,s),s.dispose(),o}throw new Error("Error in Cast: failed to cast "+i.dtype+" to "+t)}function $o(i,t){return R.makeTensorFromDataId(i.dataId,t,i.dtype)}function pc(i,t,e){var n=(t-i)/(e-1),r=jr(e,"float32");r[0]=i;for(var o=1;o<r.length;o++)r[o]=r[o-1]+n;return Be(r,"float32")}var Qk=Object.freeze({castTensor:hc,reshapeTensor:$o,linspaceImpl:pc,upcastType:at,axesAreInnerMostDims:ic,combineLocations:Ad,computeOutAndReduceShapes:pt,expandShapeToKeepDim:Et,assertAxesAreInnerMostDims:It,getAxesPermutation:Zt,getUndoAxesPermutation:ea,getInnerMostAxes:en,getBroadcastDims:kn,getReductionAxes:Qe,assertAndGetBroadcastShape:ye,assertParamsConsistent:Fd,computeOutShape:ur,computePool2DInfo:Vr,computePool3DInfo:Ti,computeConv2DInfo:Hn,computeConv3DInfo:Ni,computeDefaultPad:fc,tupleValuesAreOne:cr,eitherStridesOrDilationsAreOne:kt,convertConv2DDataFormat:oa,PARALLELIZE_THRESHOLD:uc,computeOptimalWindowSize:Mo});function Gu(i,t){if(i.length!==t.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+i.length+", imag: "+t.length+".");for(var e=new Float32Array(2*i.length),n=0;n<e.length;n+=2)e[n]=i[n/2],e[n+1]=t[n/2];return e}function op(i,t){return{real:i[2*t],imag:i[2*t+1]}}function Gx(i,t,e,n){i[2*n]=t,i[2*n+1]=e}function Hx(i,t,e){var n=(e?2:-2)*Math.PI*(i/t);return{real:Math.cos(n),imag:Math.sin(n)}}function Kx(i,t,e){var n=function(o,a,s){return function(u,c,l){for(var f=0,h=u.length,p=0,d=!1;f<h;){var m=l(c,u[p=f+(h-f>>>1)]);m>0?f=p+1:(h=p,d=!m)}return d?f:-f-1}(o,a,s||Xx)}(i,t,e),r=n<0?-(n+1):n;i.splice(r,0,t)}function Xx(i,t){return i>t?1:i<t?-1:0}function dc(i,t,e,n,r){return Gd(i,t,e,n,r,0).selectedIndices}function mc(i,t,e,n,r,o){var a=Gd(i,t,e,n,r,o,!0);return a.numValidOutputs.dispose(),{selectedIndices:a.selectedIndices,selectedScores:a.selectedScores}}function Gd(i,t,e,n,r,o,a,s){a===void 0&&(a=!1),s===void 0&&(s=!1);for(var u=Array.from(t).map(function(y,b){return{score:y,boxIndex:b,suppressBeginIndex:0}}).filter(function(y){return y.score>r}).sort(ap),c=o>0?-.5/o:0,l=[],f=[];l.length<e&&u.length>0;){var h=u.pop(),p=h.score,d=h.boxIndex,m=h.suppressBeginIndex;if(p<r)break;for(var v=!1,g=l.length-1;g>=m;--g){var x=$x(i,d,l[g]);if(x>=n){v=!0;break}if(h.score=h.score*Yx(n,c,x),h.score<=r)break}h.suppressBeginIndex=l.length,v||(h.score===p?(l.push(d),f.push(h.score)):h.score>r&&Kx(u,h,ap))}var w=l.length;return s&&(l.fill(0,w),f.fill(0,w)),{selectedIndices:Be(l,"int32"),selectedScores:Be(f,"float32"),numValidOutputs:Y(w,"int32")}}function $x(i,t,e){var n=i.subarray(4*t,4*t+4),r=i.subarray(4*e,4*e+4),o=Math.min(n[0],n[2]),a=Math.min(n[1],n[3]),s=Math.max(n[0],n[2]),u=Math.max(n[1],n[3]),c=Math.min(r[0],r[2]),l=Math.min(r[1],r[3]),f=Math.max(r[0],r[2]),h=Math.max(r[1],r[3]),p=(s-o)*(u-a),d=(f-c)*(h-l);if(p<=0||d<=0)return 0;var m=Math.max(o,c),v=Math.max(a,l),g=Math.min(s,f),x=Math.min(u,h),w=Math.max(g-m,0)*Math.max(x-v,0);return w/(p+d-w)}function Yx(i,t,e){var n=Math.exp(t*e*e);return e<=i?n:0}function ap(i,t){return i.score-t.score||i.score===t.score&&t.boxIndex-i.boxIndex}function Hd(i,t,e){var n=new Array(i.rank).fill(0),r=i.shape.slice();return t.map(function(o){r[e]=o;var a=i.slice(n,r);return n[e]+=o,a})}function Kd(i,t){for(var e=new Array(i.rank),n=0;n<e.length;n++)e[n]=i.shape[n]*t[n];var r=le(e,i.dtype);for(n=0;n<r.values.length;++n){for(var o=r.indexToLoc(n),a=new Array(i.rank),s=0;s<a.length;s++)a[s]=o[s]%i.shape[s];var u=i.locToIndex(a);r.values[n]=i.values[u]}return r.toTensor()}function Xd(i,t,e,n,r){for(var o=t[t.length-1],a=[i.length/o,o],s=a[0],u=a[1],c=qr(e,s*n),l=qr("int32",s*n),f=0;f<s;f++){for(var h=f*u,p=i.subarray(h,h+u),d=[],m=0;m<p.length;m++)d.push({value:p[m],index:m});d.sort(function(y,b){return b.value-y.value});var v=f*n,g=c.subarray(v,v+n),x=l.subarray(v,v+n);for(m=0;m<n;m++)g[m]=d[m].value,x[m]=d[m].index}var w=t.slice();return w[w.length-1]=n,[st(c,w,e),st(l,w,"int32")]}function vc(i,t){for(var e=[],n=0;n<t.length;n++)t[n]&&e.push(n);var r=le(i,"int32"),o=le([e.length,i.length],"int32");for(n=0;n<e.length;n++){var a=r.indexToLoc(e[n]),s=n*i.length;o.values.set(a,s)}return o.toTensor()}var Jx=function(i,t){this.outputShape=[],this.outputShape=i,this.variableNames=t.map(function(r,o){return"T"+o});var e=[];this.variableNames.forEach(function(r){e.push("float v"+r+" = get"+r+"AtOutCoords();")});var n=this.variableNames.map(function(r){return"v"+r}).join(" + ");this.userCode=`
      void main() {
        `+e.join(`
        `)+`

        float result = `+n+`;
        setOutput(result);
      }
    `},Qx=function(i,t){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=i,this.variableNames=t.map(function(r,o){return"T"+o});var e=[];this.variableNames.forEach(function(r){e.push("vec4 v"+r+" = get"+r+"AtOutCoords();")});var n=this.variableNames.map(function(r){return"v"+r}).join(" + ");this.userCode=`
      void main() {
        `+e.join(`
        `)+`

        vec4 result = `+n+`;
        setOutput(result);
      }
    `},Zx=function(i,t,e){this.variableNames=["A"];var n=i.windowSize,r=i.batchSize,o=i.inSize,a=Math.ceil(o/n);e||this.variableNames.push("bestIndicesA"),this.outputShape=[r,a];var s=t==="max"?">":"<",u=e?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode=`
      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];
        int outIdx = coords[1];
        int inOffset = outIdx * `+n+`;

        int bestIndex = inOffset;
        float bestValue = getA(batch, bestIndex);

        for (int i = 0; i < `+n+`; i++) {
          int inIdx = `+u+`;
          float candidate = getA(batch, inIdx);
          if (candidate `+s+` bestValue) {
            bestValue = candidate;
            bestIndex = inIdx;
          }
        }
        setOutput(float(bestIndex));
      }
    `};function $d(i,t){return["x","y","z","w","u","v"].slice(0,t).map(function(e){return i+"."+e})}function Tt(i,t){return t===1?[i]:$d(i,t)}function bt(){var i,t,e,n,r,o,a,s,u,c;return O().getNumber("WEBGL_VERSION")===2?(i="#version 300 es",t="in",e="out",n="in",r="texture",o="outputColor",a="out vec4 outputColor;",s=`
      bool isnan_custom(float val) {
        return (val > 0.0 || val < 0.0) ? false : val != 0.0;
      }

      bvec4 isnan_custom(vec4 val) {
        return bvec4(isnan_custom(val.x),
          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));
      }

      #define isnan(value) isnan_custom(value)
    `,u="",c=`
      #define round(value) newRound(value)
      int newRound(float value) {
        return int(floor(value + 0.5));
      }

      ivec4 newRound(vec4 value) {
        return ivec4(floor(value + vec4(0.5)));
      }
    `):(i="",t="attribute",e="varying",n="varying",r="texture2D",o="gl_FragColor",a="",s=`
      #define isnan(value) isnan_custom(value)
      bool isnan_custom(float val) {
        return (val > 0. || val < 1. || val == 0.) ? false : true;
      }
      bvec4 isnan_custom(vec4 val) {
        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));
      }
    `,u=`
      uniform float INFINITY;

      bool isinf(float val) {
        return abs(val) == INFINITY;
      }
      bvec4 isinf(vec4 val) {
        return equal(abs(val), vec4(INFINITY));
      }
    `,c=`
      int round(float value) {
        return int(floor(value + 0.5));
      }

      ivec4 round(vec4 value) {
        return ivec4(floor(value + vec4(0.5)));
      }
    `),{version:i,attribute:t,varyingVs:e,varyingFs:n,texture2D:r,output:o,defineOutput:a,defineSpecialNaN:s,defineSpecialInf:u,defineRound:c}}function rr(i,t,e){e===void 0&&(e="index");var n=Yt(t);return n.map(function(r,o){return"int "+i[o]+" = "+e+" / "+r+"; "+(o===n.length-1?"int "+i[o+1]+" = "+e+" - "+i[o]+" * "+r:"index -= "+i[o]+" * "+r)+";"}).join("")}function gc(i){var t=Yt(i).map(function(e){return e.toString()});return`
  int getFlatIndex(ivec3 coords) {
    return coords.x * `+t[0]+" + coords.y * "+t[1]+` + coords.z;
  }
`}var Yd=`
  const float FLOAT_MAX = 1.70141184e38;
  const float FLOAT_MIN = 1.17549435e-38;

  lowp vec4 encode_float(highp float v) {
    if (isnan(v)) {
      return vec4(255, 255, 255, 255);
    }

    highp float av = abs(v);

    if(av < FLOAT_MIN) {
      return vec4(0.0, 0.0, 0.0, 0.0);
    } else if(v > FLOAT_MAX) {
      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;
    } else if(v < -FLOAT_MAX) {
      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;
    }

    highp vec4 c = vec4(0,0,0,0);

    highp float e = floor(log2(av));
    highp float m = exp2(fract(log2(av))) - 1.0;

    c[2] = floor(128.0 * m);
    m -= c[2] / 128.0;
    c[1] = floor(32768.0 * m);
    m -= c[1] / 32768.0;
    c[0] = floor(8388608.0 * m);

    highp float ebias = e + 127.0;
    c[3] = floor(ebias / 2.0);
    ebias -= c[3] * 2.0;
    c[2] += floor(ebias) * 128.0;

    c[3] += 128.0 * step(0.0, -v);

    return c / 255.0;
  }
`;function eb(i,t,e,n){var r=[];i.forEach(function(p){var d=re(p.shapeInfo.logicalShape);p.shapeInfo.isUniform?r.push("uniform float "+p.name+(d>1?"["+d+"]":"")+";"):(r.push("uniform sampler2D "+p.name+";"),r.push("uniform int offset"+p.name+";"))});var o,a,s=r.join(`
`),u=i.map(function(p){return function(d,m,v){v===void 0&&(v=!1);var g="";g+=v?Jd(d):Nr(d);var x=d.shapeInfo.logicalShape,w=m.logicalShape;return x.length<=w.length&&(g+=v?function(y,b){var C,S=y.name,A=S.charAt(0).toUpperCase()+S.slice(1),k="get"+A+"AtOutCoords",D=y.shapeInfo.logicalShape.length,T=b.logicalShape.length,I=kn(y.shapeInfo.logicalShape,b.logicalShape),W=We(T),B=T-D,L=["x","y","z","w","u","v"];C=D===0?"":T<2&&I.length>=1?"coords = 0;":I.map(function(ie){return"coords."+L[ie+B]+" = 0;"}).join(`
`);var V="";V=T<2&&D>0?"coords":y.shapeInfo.logicalShape.map(function(ie,ae){return"coords."+L[ae+B]}).join(", ");var q="return outputValue;",z=re(y.shapeInfo.logicalShape)===1,G=re(b.logicalShape)===1;if(D!==1||z||G){if(z&&!G)q=T===1?`
        return vec4(outputValue.x, outputValue.x, 0., 0.);
      `:`
        return vec4(outputValue.x);
      `;else if(I.length){var H=D-2,Z=D-1;I.indexOf(H)>-1&&I.indexOf(Z)>-1?q="return vec4(outputValue.x);":I.indexOf(H)>-1?q="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":I.indexOf(Z)>-1&&(q="return vec4(outputValue.xx, outputValue.zz);")}}else q=`
      return vec4(outputValue.xy, outputValue.xy);
    `;return`
    vec4 `+k+`() {
      `+W+` coords = getOutputCoords();
      `+C+`
      vec4 outputValue = get`+A+"("+V+`);
      `+q+`
    }
  `}(d,m):function(y,b){var C=y.name,S=C.charAt(0).toUpperCase()+C.slice(1),A="get"+S+"AtOutCoords",k=b.texShape,D=y.shapeInfo.texShape,T=y.shapeInfo.logicalShape.length,I=b.logicalShape.length;if(!y.shapeInfo.isUniform&&T===I&&y.shapeInfo.flatOffset==null&&Je(D,k))return`
      float `+A+`() {
        return sampleTexture(`+C+`, resultUV);
      }
    `;var W,B=We(I),L=kn(y.shapeInfo.logicalShape,b.logicalShape),V=I-T,q=["x","y","z","w","u","v"];W=T===0?"":I<2&&L.length>=1?"coords = 0;":L.map(function(G){return"coords."+q[G+V]+" = 0;"}).join(`
`);var z="";return z=I<2&&T>0?"coords":y.shapeInfo.logicalShape.map(function(G,H){return"coords."+q[H+V]}).join(", "),`
    float `+A+`() {
      `+B+` coords = getOutputCoords();
      `+W+`
      return get`+S+"("+z+`);
    }
  `}(d,m)),g}(p,t,n)}).join(`
`),c=t.texShape,l=bt(),f=function(p){return`
    float sampleTexture(sampler2D textureSampler, vec2 uv) {
      return `+p.texture2D+`(textureSampler, uv).r;
    }
  `}(l),h=function(p){return p.version+`
    precision highp float;
    precision highp int;
    precision highp sampler2D;
    `+p.varyingFs+` vec2 resultUV;
    `+p.defineOutput+`
    const vec2 halfCR = vec2(0.5, 0.5);

    struct ivec5
    {
      int x;
      int y;
      int z;
      int w;
      int u;
    };

    struct ivec6
    {
      int x;
      int y;
      int z;
      int w;
      int u;
      int v;
    };

    uniform float NAN;
    `+p.defineSpecialNaN+`
    `+p.defineSpecialInf+`
    `+p.defineRound+`

    int imod(int x, int y) {
      return x - y * (x / y);
    }

    int idiv(int a, int b, float sign) {
      int res = a / b;
      int mod = imod(a, b);
      if (sign < 0. && mod != 0) {
        res -= 1;
      }
      return res;
    }

    //Based on the work of Dave Hoskins
    //https://www.shadertoy.com/view/4djSRW
    #define HASHSCALE1 443.8975
    float random(float seed){
      vec2 p = resultUV * seed;
      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);
      p3 += dot(p3, p3.yzx + 19.19);
      return fract((p3.x + p3.y) * p3.z);
    }

    `+tb+`
    `+nb+`
    `+rb+`
  `}(l);return t.isPacked?(o=function(p,d){switch(p.length){case 0:return`
    int getOutputCoords() {
      return 0;
    }
  `;case 1:return function(y,b){var C=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)];return C[0]===1?`
      int getOutputCoords() {
        return 2 * int(resultUV.x * `+C[1]+`.0);
      }
    `:C[1]===1?`
      int getOutputCoords() {
        return 2 * int(resultUV.y * `+C[0]+`.0);
      }
    `:`
    int getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+C[0]+", "+C[1]+`));
      return 2 * (resTexRC.x * `+C[1]+` + resTexRC.y);
    }
  `}(0,d);case 2:return function(y,b){var C=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)];if(Je(y,b))return`
      ivec2 getOutputCoords() {
        return 2 * ivec2(resultUV.yx * vec2(`+C[0]+", "+C[1]+`));
      }
    `;var S=Math.ceil(y[1]/2);return`
    ivec2 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+C[0]+", "+C[1]+`));

      int index = resTexRC.x * `+C[1]+` + resTexRC.y;
      int r = 2 * (index / `+S+`);
      int c = imod(index, `+S+`) * 2;

      return ivec2(r, c);
    }
  `}(p,d);case 3:return m=p,v=d,g=[Math.ceil(v[0]/2),Math.ceil(v[1]/2)],x=Math.ceil(m[2]/2),w=x*Math.ceil(m[1]/2),`
    ivec3 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+g[0]+", "+g[1]+`));
      int index = resTexRC.x * `+g[1]+` + resTexRC.y;

      int b = index / `+w+`;
      index -= b * `+w+`;

      int r = 2 * (index / `+x+`);
      int c = imod(index, `+x+`) * 2;

      return ivec3(b, r, c);
    }
  `;default:return function(y,b){for(var C=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)],S=Math.ceil(y[y.length-1]/2),A=S*Math.ceil(y[y.length-2]/2),k=A,D="",T="b, r, c",I=2;I<y.length-1;I++)k*=y[y.length-I-1],D=`
      int b`+I+" = index / "+k+`;
      index -= b`+I+" * "+k+`;
    `+D,T="b"+I+", "+T;return`
    ivec`+y.length+` getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+C[0]+", "+C[1]+`));
      int index = resTexRC.x * `+C[1]+` + resTexRC.y;

      `+D+`

      int b = index / `+A+`;
      index -= b * `+A+`;

      int r = 2 * (index / `+S+`);
      int c = imod(index, `+S+`) * 2;

      return ivec`+y.length+"("+T+`);
    }
  `}(p,d)}var m,v,g,x,w}(t.logicalShape,c),a=function(p){return`
    void setOutput(vec4 val) {
      `+p.output+` = val;
    }
  `}(l)):(o=function(p,d){switch(p.length){case 0:return`
    int getOutputCoords() {
      return 0;
    }
  `;case 1:return function(g,x){return x[0]===1?`
      int getOutputCoords() {
        return int(resultUV.x * `+x[1]+`.0);
      }
    `:x[1]===1?`
      int getOutputCoords() {
        return int(resultUV.y * `+x[0]+`.0);
      }
    `:`
    int getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+x[0]+", "+x[1]+`));
      return resTexRC.x * `+x[1]+` + resTexRC.y;
    }
  `}(0,d);case 2:return function(g,x){return Je(g,x)?`
      ivec2 getOutputCoords() {
        return ivec2(resultUV.yx * vec2(`+x[0]+", "+x[1]+`));
      }
    `:g[1]===1?`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(`+x[0]+", "+x[1]+`));
        int index = resTexRC.x * `+x[1]+` + resTexRC.y;
        return ivec2(index, 0);
      }
    `:g[0]===1?`
      ivec2 getOutputCoords() {
        ivec2 resTexRC = ivec2(resultUV.yx *
                               vec2(`+x[0]+", "+x[1]+`));
        int index = resTexRC.x * `+x[1]+` + resTexRC.y;
        return ivec2(0, index);
      }
    `:`
    ivec2 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+x[0]+", "+x[1]+`));
      int index = resTexRC.x * `+x[1]+` + resTexRC.y;
      int r = index / `+g[1]+`;
      int c = index - r * `+g[1]+`;
      return ivec2(r, c);
    }
  `}(p,d);case 3:return m=d,v=rr(["r","c","d"],p),`
    ivec3 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
                             vec2(`+m[0]+", "+m[1]+`));
      int index = resTexRC.x * `+m[1]+` + resTexRC.y;
      `+v+`
      return ivec3(r, c, d);
    }
  `;case 4:return function(g,x){var w=rr(["r","c","d","d2"],g);return`
    ivec4 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
        vec2(`+x[0]+", "+x[1]+`));
      int index = resTexRC.x * `+x[1]+` + resTexRC.y;
      `+w+`
      return ivec4(r, c, d, d2);
    }
  `}(p,d);case 5:return function(g,x){var w=rr(["r","c","d","d2","d3"],g);return`
    ivec5 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx * vec2(`+x[0]+`,
                             `+x[1]+`));

      int index = resTexRC.x * `+x[1]+` + resTexRC.y;

      `+w+`

      ivec5 outShape = ivec5(r, c, d, d2, d3);
      return outShape;
    }
  `}(p,d);case 6:return function(g,x){var w=rr(["r","c","d","d2","d3","d4"],g);return`
    ivec6 getOutputCoords() {
      ivec2 resTexRC = ivec2(resultUV.yx *
        vec2(`+x[0]+", "+x[1]+`));
      int index = resTexRC.x * `+x[1]+` + resTexRC.y;

      `+w+`

      ivec6 result = ivec6(r, c, d, d2, d3, d4);
      return result;
    }
  `}(p,d);default:throw new Error(p.length+"-D output sampling is not yet supported")}var m,v}(t.logicalShape,c),a=function(p){return`
    void setOutput(float val) {
      `+p.output+` = vec4(val, 0, 0, 0);
    }
  `}(l)),n&&(h+=ib),[h,f,a,s,o,u,e].join(`
`)}function Nr(i){var t=i.shapeInfo.logicalShape;switch(t.length){case 0:return function(e){var n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return"float "+r+"() {return "+n+";}";var o=e.shapeInfo.texShape,a=o[0],s=o[1];if(a===1&&s===1)return`
      float `+r+`() {
        return sampleTexture(`+n+`, halfCR);
      }
    `;var u=e.shapeInfo.texShape,c=u[0],l=u[1],f=Zn(n);return`
    float `+r+`() {
      vec2 uv = uvFromFlat(`+c+", "+l+", "+f+`);
      return sampleTexture(`+n+`, uv);
    }
  `}(i);case 1:return function(e){var n=e.name,r="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return`
      float `+r+`(int index) {
        `+Rr(e)+`
      }
    `;var o=e.shapeInfo.texShape,a=o[0],s=o[1];if(s===1&&a===1)return`
      float `+r+`(int index) {
        return sampleTexture(`+n+`, halfCR);
      }
    `;var u=Zn(n);return s===1?`
      float `+r+`(int index) {
        vec2 uv = vec2(0.5, (float(index + `+u+") + 0.5) / "+a+`.0);
        return sampleTexture(`+n+`, uv);
      }
    `:a===1?`
      float `+r+`(int index) {
        vec2 uv = vec2((float(index + `+u+") + 0.5) / "+s+`.0, 0.5);
        return sampleTexture(`+n+`, uv);
      }
    `:`
    float `+r+`(int index) {
      vec2 uv = uvFromFlat(`+a+", "+s+", index + "+u+`);
      return sampleTexture(`+n+`, uv);
    }
  `}(i);case 2:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),a=e.shapeInfo.texShape;if(a!=null&&Je(n,a)){var s=a[0],u=a[1];return`
    float `+o+`(int row, int col) {
      vec2 uv = (vec2(col, row) + halfCR) / vec2(`+u+".0, "+s+`.0);
      return sampleTexture(`+r+`, uv);
    }
  `}var c=qn(n),l=c.newShape,f=c.keptDims,h=l;if(h.length<n.length){var p=Pr(e,h);return`
      `+Nr(p)+`
      float `+o+`(int row, int col) {
        return `+o+"("+Mr(["row","col"],f)+`);
      }
    `}if(e.shapeInfo.isUniform)return`
      float `+o+`(int row, int col) {
        int index = round(dot(vec2(row, col), vec2(`+n[1]+`, 1)));
        `+Rr(e)+`
      }
    `;var d=a[0],m=a[1],v=Zn(r);return m===1?`
    float `+o+`(int row, int col) {
      float index = dot(vec3(row, col, `+v+"), vec3("+n[1]+`, 1, 1));
      vec2 uv = vec2(0.5, (index + 0.5) / `+d+`.0);
      return sampleTexture(`+r+`, uv);
    }
  `:d===1?`
    float `+o+`(int row, int col) {
      float index = dot(vec3(row, col, `+v+"), vec3("+n[1]+`, 1, 1));
      vec2 uv = vec2((index + 0.5) / `+m+`.0, 0.5);
      return sampleTexture(`+r+`, uv);
    }
  `:`
  float `+o+`(int row, int col) {
    // Explicitly use integer operations as dot() only works on floats.
    int index = row * `+n[1]+" + col + "+v+`;
    vec2 uv = uvFromFlat(`+d+", "+m+`, index);
    return sampleTexture(`+r+`, uv);
  }
`}(i);case 3:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[1]*n[2],s=n[2],u=qn(n),c=u.newShape,l=u.keptDims,f=c;if(f.length<n.length){var h=Pr(e,f);return`
        `+Nr(h)+`
        float `+o+`(int row, int col, int depth) {
          return `+o+"("+Mr(["row","col","depth"],l)+`);
        }
      `}if(e.shapeInfo.isUniform)return`
      float `+o+`(int row, int col, int depth) {
        int index = round(dot(vec3(row, col, depth),
                          vec3(`+a+", "+s+`, 1)));
        `+Rr(e)+`
      }
    `;var p=e.shapeInfo.texShape,d=p[0],m=p[1],v=e.shapeInfo.flatOffset;if(m===a&&v==null)return`
        float `+o+`(int row, int col, int depth) {
          float texR = float(row);
          float texC = dot(vec2(col, depth), vec2(`+s+`, 1));
          vec2 uv = (vec2(texC, texR) + halfCR) /
                     vec2(`+m+".0, "+d+`.0);
          return sampleTexture(`+r+`, uv);
        }
      `;if(m===s&&v==null)return`
    float `+o+`(int row, int col, int depth) {
      float texR = dot(vec2(row, col), vec2(`+n[1]+`, 1));
      float texC = float(depth);
      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+m+".0, "+d+`.0);
      return sampleTexture(`+r+`, uv);
    }
  `;var g=Zn(r);return`
      float `+o+`(int row, int col, int depth) {
        // Explicitly use integer operations as dot() only works on floats.
        int index = row * `+a+" + col * "+s+" + depth + "+g+`;
        vec2 uv = uvFromFlat(`+d+", "+m+`, index);
        return sampleTexture(`+r+`, uv);
      }
  `}(i);case 4:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[3],s=n[2]*a,u=n[1]*s,c=qn(n),l=c.newShape,f=c.keptDims;if(l.length<n.length){var h=Pr(e,l);return`
      `+Nr(h)+`
      float `+o+`(int row, int col, int depth, int depth2) {
        return `+o+"("+Mr(["row","col","depth","depth2"],f)+`);
      }
    `}if(e.shapeInfo.isUniform)return`
      float `+o+`(int row, int col, int depth, int depth2) {
        int index = round(dot(vec4(row, col, depth, depth2),
                          vec4(`+u+", "+s+", "+a+`, 1)));
        `+Rr(e)+`
      }
    `;var p=e.shapeInfo.flatOffset,d=e.shapeInfo.texShape,m=d[0],v=d[1];if(v===u&&p==null)return`
      float `+o+`(int row, int col, int depth, int depth2) {
        float texR = float(row);
        float texC =
            dot(vec3(col, depth, depth2),
                vec3(`+s+", "+a+`, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+v+".0, "+m+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;if(v===a&&p==null)return`
      float `+o+`(int row, int col, int depth, int depth2) {
        float texR = dot(vec3(row, col, depth),
                         vec3(`+n[1]*n[2]+", "+n[2]+`, 1));
        float texC = float(depth2);
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+v+".0, "+m+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;var g=Zn(r);return`
    float `+o+`(int row, int col, int depth, int depth2) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+u+" + col * "+s+` +
          depth * `+a+` + depth2;
      vec2 uv = uvFromFlat(`+m+", "+v+", index + "+g+`);
      return sampleTexture(`+r+`, uv);
    }
  `}(i);case 5:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),a=n[4],s=n[3]*a,u=n[2]*s,c=n[1]*u,l=qn(n),f=l.newShape,h=l.keptDims;if(f.length<n.length){var p=Pr(e,f);return`
      `+Nr(p)+`
      float `+o+`(int row, int col, int depth, int depth2, int depth3) {
        return `+o+"("+Mr(["row","col","depth","depth2","depth3"],h)+`);
      }
    `}if(e.shapeInfo.isUniform)return`
      float `+o+`(int row, int col, int depth, int depth2, int depth3) {
        float index = dot(
          vec4(row, col, depth, depth2),
          vec4(`+c+", "+u+", "+s+", "+a+`)) +
          depth3;
        `+Rr(e)+`
      }
    `;var d=e.shapeInfo.flatOffset,m=e.shapeInfo.texShape,v=m[0],g=m[1];if(g===c&&d==null)return`
      float `+o+`(int row, int col, int depth, int depth2, int depth3) {
        int texR = row;
        float texC = dot(vec4(col, depth, depth2, depth3),
                         vec4(`+u+", "+s+", "+a+`, 1));
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+g+".0, "+v+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;if(g===a&&d==null)return`
      float `+o+`(int row, int col, int depth, int depth2, int depth3) {
        float texR = dot(
          vec4(row, col, depth, depth2),
          vec4(`+n[1]*n[2]*n[3]+`,
               `+n[2]*n[3]+", "+n[3]+`, 1));
        int texC = depth3;
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+g+".0, "+v+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;var x=Zn(r);return`
    float `+o+`(int row, int col, int depth, int depth2, int depth3) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+c+" + col * "+u+" + depth * "+s+` +
          depth2 * `+a+" + depth3 + "+x+`;
      vec2 uv = uvFromFlat(`+v+", "+g+`, index);
      return sampleTexture(`+r+`, uv);
    }
  `}(i);case 6:return function(e){var n=e.shapeInfo.logicalShape,r=e.name,o="get"+r.charAt(0).toUpperCase()+r.slice(1),a=qn(n),s=a.newShape,u=a.keptDims;if(s.length<n.length){var c=Pr(e,s);return`
      `+Nr(c)+`
      float `+o+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        return `+o+"("+Mr(["row","col","depth","depth2","depth3","depth4"],u)+`);
      }
    `}var l=n[5],f=n[4]*l,h=n[3]*f,p=n[2]*h,d=n[1]*p;if(e.shapeInfo.isUniform)return`
      float `+o+`(int row, int col, int depth,
                  int depth2, int depth3, int depth4) {
        int index = round(dot(
          vec4(row, col, depth, depth2),
          vec4(`+d+", "+p+", "+h+", "+f+`)) +
          dot(
            vec2(depth3, depth4),
            vec2(`+l+`, 1)));
        `+Rr(e)+`
      }
    `;var m=e.shapeInfo.flatOffset,v=e.shapeInfo.texShape,g=v[0],x=v[1];if(x===d&&m==null)return`
      float `+o+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        int texR = row;
        float texC = dot(vec4(col, depth, depth2, depth3),
          vec4(`+p+", "+h+", "+f+", "+l+`)) +
               float(depth4);
        vec2 uv = (vec2(texC, texR) + halfCR) /
                   vec2(`+x+".0, "+g+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;if(x===l&&m==null)return`
      float `+o+`(int row, int col, int depth,
                    int depth2, int depth3, int depth4) {
        float texR = dot(vec4(row, col, depth, depth2),
          vec4(`+n[1]*n[2]*n[3]*n[4]+`,
               `+n[2]*n[3]*n[4]+`,
               `+n[3]*n[4]+`,
               `+n[4]+`)) + float(depth3);
        int texC = depth4;
        vec2 uv = (vec2(texC, texR) + halfCR) /
                  vec2(`+x+".0, "+g+`.0);
        return sampleTexture(`+r+`, uv);
      }
    `;var w=Zn(r);return`
    float `+o+`(int row, int col, int depth,
                  int depth2, int depth3, int depth4) {
      // Explicitly use integer operations as dot() only works on floats.
      int index = row * `+d+" + col * "+p+" + depth * "+h+` +
          depth2 * `+f+" + depth3 * "+l+" + depth4 + "+w+`;
      vec2 uv = uvFromFlat(`+g+", "+x+`, index);
      return sampleTexture(`+r+`, uv);
    }
  `}(i);default:throw new Error(t.length+"-D input sampling is not yet supported")}}function Jd(i){var t,e,n;switch(i.shapeInfo.logicalShape.length){case 0:return t=i.name,e="get"+t.charAt(0).toUpperCase()+t.slice(1),n=bt(),`
    vec4 `+e+`() {
      return `+n.texture2D+"("+t+`, halfCR);
    }
  `;case 1:return function(r){var o=r.name,a="get"+o.charAt(0).toUpperCase()+o.slice(1),s=r.shapeInfo.texShape,u=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)],c=bt();return`
    vec4 `+a+`(int index) {
      vec2 uv = packedUVfrom1D(
        `+u[0]+", "+u[1]+`, index);
      return `+c.texture2D+"("+o+`, uv);
    }
  `}(i);case 2:return function(r){var o=r.shapeInfo.logicalShape,a=r.name,s="get"+a.charAt(0).toUpperCase()+a.slice(1),u=r.shapeInfo.texShape,c=u[0],l=u[1],f=bt();if(u!=null&&Je(o,u))return`
      vec4 `+s+`(int row, int col) {
        vec2 uv = (vec2(col, row) + halfCR) / vec2(`+l+".0, "+c+`.0);

        return `+f.texture2D+"("+a+`, uv);
      }
    `;var h=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)],p=Math.ceil(o[1]/2);return`
    vec4 `+s+`(int row, int col) {
      vec2 uv = packedUVfrom2D(`+p+", "+h[0]+", "+h[1]+`, row, col);
      return `+f.texture2D+"("+a+`, uv);
    }
  `}(i);case 3:return function(r){var o=r.shapeInfo.logicalShape,a=r.name,s="get"+a.charAt(0).toUpperCase()+a.slice(1),u=r.shapeInfo.texShape,c=[Math.ceil(u[0]/2),Math.ceil(u[1]/2)];if(o[0]===1){var l=o.slice(1),f=Pr(r,l);return`
        `+Jd(f)+`
        vec4 `+s+`(int b, int row, int col) {
          return `+s+"("+Mr(["b","row","col"],[1,2])+`);
        }
      `}var h=c[0],p=c[1],d=Math.ceil(o[2]/2),m=d*Math.ceil(o[1]/2),v=bt();return`
    vec4 `+s+`(int b, int row, int col) {
      vec2 uv = packedUVfrom3D(
        `+h+", "+p+", "+m+", "+d+`, b, row, col);
      return `+v.texture2D+"("+a+`, uv);
    }
  `}(i);default:return function(r){for(var o=r.shapeInfo.logicalShape,a=o.length,s=r.name,u="get"+s.charAt(0).toUpperCase()+s.slice(1),c=r.shapeInfo.texShape,l=[Math.ceil(c[0]/2),Math.ceil(c[1]/2)],f=l[0],h=l[1],p=Math.ceil(o[a-1]/2),d=p*Math.ceil(o[a-2]/2),m="int b, int row, int col",v="b * "+d+" + (row / 2) * "+p+" + (col / 2)",g=2;g<a-1;g++)m="int b"+g+", "+m,d*=o[a-g-1],v="b"+g+" * "+d+" + "+v;var x=bt();return`
    vec4 `+u+"("+m+`) {
      int index = `+v+`;
      int texR = index / `+h+`;
      int texC = index - texR * `+h+`;
      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+h+", "+f+`);
      return `+x.texture2D+"("+s+`, uv);
    }
  `}(i)}}var tb=`
vec2 uvFromFlat(int texNumR, int texNumC, int index) {
  int texR = index / texNumC;
  int texC = index - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
vec2 packedUVfrom1D(int texNumR, int texNumC, int index) {
  int texelIndex = index / 2;
  int texR = texelIndex / texNumC;
  int texC = texelIndex - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,nb=`
vec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,
  int texNumC, int row, int col) {
  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);
  int texR = texelIndex / texNumC;
  int texC = texelIndex - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,rb=`
vec2 packedUVfrom3D(int texNumR, int texNumC,
    int texelsInBatch, int texelsInLogicalRow, int b,
    int row, int col) {
  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);
  int texR = index / texNumC;
  int texC = index - texR * texNumC;
  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);
}
`,ib=`
  float getChannel(vec4 frag, vec2 innerDims) {
    vec2 modCoord = mod(innerDims, 2.);
    return modCoord.x == 0. ?
      (modCoord.y == 0. ? frag.r : frag.g) :
      (modCoord.y == 0. ? frag.b : frag.a);
  }
  float getChannel(vec4 frag, int dim) {
    float modCoord = mod(float(dim), 2.);
    return modCoord == 0. ? frag.r : frag.g;
  }
`;function Zn(i){return"offset"+i}function Rr(i){var t=i.name,e=re(i.shapeInfo.logicalShape);return e<2?"return "+t+";":`
    for (int i = 0; i < `+e+`; i++) {
      if (i == index) {
        return `+t+`[i];
      }
    }
  `}function We(i){if(i<=1)return"int";if(i===2)return"ivec2";if(i===3)return"ivec3";if(i===4)return"ivec4";if(i===5)return"ivec5";if(i===6)return"ivec6";throw Error("GPU for rank "+i+" is not yet supported")}function Pr(i,t){var e=JSON.parse(JSON.stringify(i));return e.shapeInfo.logicalShape=t,e}function Mr(i,t){return t.map(function(e){return i[e]}).join(", ")}var ob=function(i,t,e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,E(i.length>2,function(){return"Packed arg"+(e.charAt(0).toUpperCase()+e.slice(1))+" supports only inputs with rank above 2."});var r=i[i.length-1],o=Math.ceil(r/t);this.outputShape=i.slice(0,-1),o>1&&this.outputShape.push(o),n||this.variableNames.push("bestIndicesA");var a,s,u=this.outputShape,c=u.length,l=We(c),f=Tt("coords",c);if(o===1){var h=We(s=c+1);a=`
        `+h+" sourceLocR = "+h+"("+f.join()+`, 0);
        ++`+f[c-1]+`;
        `+h+" sourceLocG = "+h+"("+f.join()+`, 0);
        ++`+f[c-2]+`;
        `+h+" sourceLocA = "+h+"("+f.join()+`, 0);
        --`+f[c-1]+`;
        `+h+" sourceLocB = "+h+"("+f.join()+`, 0);
        --`+f[c-2]+";"}else s=c,a=`
        `+l+` sourceLocR = coords;
        ++`+f[c-1]+`;
        `+l+` sourceLocG = coords;
        ++`+f[c-2]+`;
        `+l+` sourceLocA = coords;
        --`+f[c-1]+`;
        `+l+` sourceLocB = coords;
        --`+f[c-2]+";";var p=["x","y","z","w","u","v"].slice(0,s),d="."+p[s-1],m=p.map(function(A){return"int "+A}),v=Tt("sourceLocR",s-1).concat("inIdx.r"),g=Tt("sourceLocG",s-1).concat("inIdx.g"),x=Tt("sourceLocB",s-1).concat("inIdx.b"),w=Tt("sourceLocA",s-1).concat("inIdx.a"),y=e==="max"?"greaterThan":"lessThan",b=n?"":`
          inIdx = round(vec4(getBestIndicesAChannel(`+v.join()+`),
                             getBestIndicesAChannel(`+g.join()+`),
                             getBestIndicesAChannel(`+x.join()+`),
                             getBestIndicesAChannel(`+w.join()+")));",C=`vec4(
            getAChannel(`+v.join()+`),
            hasNextCol ? getAChannel(`+g.join()+`) : 0.,
            hasNextRow ? getAChannel(`+x.join()+`) : 0.,
            hasNextRow && hasNextCol ? getAChannel(`+w.join()+") : 0.)",S=n?"":`
      float getBestIndicesAChannel(`+m.join()+`) {
        return getChannel(getBestIndicesA(`+p.join()+`),
                                          vec2(`+p.slice(-2).join()+`));
      }`;this.userCode=`
      float getAChannel(`+m.join()+`) {
        return getChannel(getA(`+p.join()+`),
                               vec2(`+p.slice(-2).join()+`));
      }
      `+S+`
      void main() {
        `+l+` coords = getOutputCoords();
        bool hasNextCol = `+f[c-1]+" < "+(u[c-1]-1)+`;
        bool hasNextRow = `+f[c-2]+" < "+(u[c-2]-1)+`;
        `+a+`
        ivec4 srcIdx = ivec4(sourceLocR`+d+", sourceLocG"+d+`,
          sourceLocB`+d+", sourceLocA"+d+") * "+t+`;
        ivec4 inIdx = srcIdx;
        vec4 bestIndex = vec4(inIdx);
        vec4 bestValue = `+C+`;

        for (int i = 0; i < `+t+`; i++) {
          inIdx = srcIdx;
          `+b+`
          vec4 candidate = `+C+`;
          bvec4 nan = isnan(candidate);
          bvec4 replace = bvec4(
            vec4(`+y+`(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));

          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,
                           replace.y  ? candidate.y : bestValue.y,
                           replace.z  ? candidate.z : bestValue.z,
                           replace.w  ? candidate.w : bestValue.w);
          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));
          srcIdx++;
        }
        setOutput(bestIndex);
      }
    `},ab=function(i){this.variableNames=["dy"],this.outputShape=i.inShape;var t=i.filterHeight,e=i.filterWidth,n=i.strideHeight,r=i.strideWidth,o=i.dilationHeight,a=i.dilationWidth,s=i.effectiveFilterHeight,u=i.effectiveFilterWidth,c=s-1-i.padInfo.top,l=u-1-i.padInfo.left,f=1/(t*e);this.userCode=`
      const ivec2 pads = ivec2(`+c+", "+l+`);
      const float avgMultiplier = float(`+f+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];

        ivec2 dyRCCorner = coords.yz - pads;
        int dyRCorner = dyRCCorner.x;
        int dyCCorner = dyRCCorner.y;

        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        for (int wR = 0; wR < `+s+`;
            wR += `+o+`) {
          float dyR = float(dyRCorner + wR) / `+n+`.0;

          if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 || fract(dyR) > 0.0) {
            continue;
          }
          int idyR = int(dyR);

          for (int wC = 0; wC < `+u+`;
            wC+= `+a+`) {
            float dyC = float(dyCCorner + wC) / `+r+`.0;

            if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                fract(dyC) > 0.0) {
              continue;
            }
            int idyC = int(dyC);

            float dyValue = getDy(b, idyR, idyC, d);

            dotProd += dyValue * avgMultiplier;
          }
        }
        setOutput(dotProd);
      }
    `},sb=function(i){this.variableNames=["dy"],this.outputShape=i.inShape;var t=i.filterDepth,e=i.filterHeight,n=i.filterWidth,r=i.strideDepth,o=i.strideHeight,a=i.strideWidth,s=i.dilationDepth,u=i.dilationHeight,c=i.dilationWidth,l=i.effectiveFilterDepth,f=i.effectiveFilterHeight,h=i.effectiveFilterWidth,p=l-1-i.padInfo.front,d=f-1-i.padInfo.top,m=h-1-i.padInfo.left,v=1/(t*e*n);this.userCode=`
      const ivec3 pads = ivec3(`+p+", "+d+", "+m+`);
      const float avgMultiplier = float(`+v+`);

      void main() {
        ivec5 coords = getOutputCoords();
        int batch = coords.x;
        int ch = coords.u;

        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;
        int dyDCorner = dyCorner.x;
        int dyRCorner = dyCorner.y;
        int dyCCorner = dyCorner.z;

        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get
        // dx(xD, xR, xC, ch).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;

        for (int wD = 0; wD < `+l+`;
            wD += `+s+`) {
          float dyD = float(dyDCorner + wD) / `+r+`.0;

          if (dyD < 0.0 || dyD >= `+i.outDepth+`.0 || fract(dyD) > 0.0) {
            continue;
          }
          int idyD = int(dyD);

          for (int wR = 0; wR < `+f+`;
              wR += `+u+`) {
            float dyR = float(dyRCorner + wR) / `+o+`.0;

            if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 ||
                fract(dyR) > 0.0) {
              continue;
            }
            int idyR = int(dyR);

            for (int wC = 0; wC < `+h+`;
                wC += `+c+`) {
              float dyC = float(dyCCorner + wC) / `+a+`.0;

              if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                  fract(dyC) > 0.0) {
                continue;
              }
              int idyC = int(dyC);

              float dyValue = getDy(batch, idyD, idyR, idyC, ch);

              dotProd += dyValue * avgMultiplier;
            }
          }
        }
        setOutput(dotProd);
      }
    `},ub=function(i,t,e,n,r,o){this.outputShape=[],this.variableNames=["x","mean","variance"],ye(i,t),ye(i,e);var a="0.0";n!=null&&(ye(i,n),this.variableNames.push("offset"),a="getOffsetAtOutCoords()");var s="1.0";r!=null&&(ye(i,r),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=i,this.userCode=`
      void main() {
        float x = getXAtOutCoords();
        float mean = getMeanAtOutCoords();
        float variance = getVarianceAtOutCoords();
        float offset = `+a+`;
        float scale = `+s+`;
        float inv = scale * inversesqrt(variance + float(`+o+`));
        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));
      }
    `},cb=function(i,t,e,n,r,o){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],ye(i,t),ye(i,e);var a="vec4(0.0)";n!=null&&(ye(i,n),this.variableNames.push("offset"),a="getOffsetAtOutCoords()");var s="vec4(1.0)";r!=null&&(ye(i,r),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=i,this.userCode=`
      void main() {
        vec4 offset = `+a+`;
        vec4 scale = `+s+`;

        vec4 x = getXAtOutCoords();
        vec4 mean = getMeanAtOutCoords();
        vec4 variance = getVarianceAtOutCoords();

        vec4 inv = scale * inversesqrt(variance + vec4(`+o+`));

        setOutput((x - mean) * inv + offset);
      }
    `},lb="return areal * breal - aimag * bimag;",fb="return areal * bimag + aimag * breal;",sp=function(i,t,e){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=ye(t,e),this.userCode=`
      float binaryOpComplex(
          float areal, float aimag, float breal, float bimag) {
        `+i+`
      }

      void main() {
        float areal = getARealAtOutCoords();
        float aimag = getAImagAtOutCoords();
        float breal = getBRealAtOutCoords();
        float bimag = getBImagAtOutCoords();
        setOutput(binaryOpComplex(areal, aimag, breal, bimag));
      }
    `},pu="return a + b;",du="return a - b;",up="return a * b;",Qd="return (a < 0.) ? b * a : a;",Xe=function(i,t,e){this.variableNames=["A","B"],this.outputShape=ye(t,e),this.userCode=`
      float binaryOperation(float a, float b) {
        `+i+`
      }

      void main() {
        float a = getAAtOutCoords();
        float b = getBAtOutCoords();
        setOutput(binaryOperation(a, b));
      }
    `},Zd=`
  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));
  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);
`,_n=function(i,t,e,n){n===void 0&&(n=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=ye(t,e);var r=this.outputShape.length,o="";if(n)if(r===0||re(this.outputShape)===1)o=`
          result.y = 0.;
          result.z = 0.;
          result.w = 0.;
        `;else if(o=`
          `+We(r)+` coords = getOutputCoords();
        `,r===1)o+=`
            result.y = (coords + 1) >= `+this.outputShape[0]+` ? 0. : result.y;
            result.z = 0.;
            result.w = 0.;
          `;else{var a=Tt("coords",r);o+=`
            bool nextRowOutOfBounds =
              (`+a[r-2]+" + 1) >= "+this.outputShape[r-2]+`;
            bool nextColOutOfBounds =
              (`+a[r-1]+" + 1) >= "+this.outputShape[r-1]+`;
            result.y = nextColOutOfBounds ? 0. : result.y;
            result.z = nextRowOutOfBounds ? 0. : result.z;
            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;
          `}this.userCode=`
      vec4 binaryOperation(vec4 a, vec4 b) {
        `+i+`
      }

      void main() {
        vec4 a = getAAtOutCoords();
        vec4 b = getBAtOutCoords();

        vec4 result = binaryOperation(a, b);
        `+o+`

        setOutput(result);
      }
    `},hb=function(){function i(t){this.variableNames=["A"],this.outputShape=t,this.userCode=`
      uniform float minVal;
      uniform float maxVal;

      void main() {
        float value = getAAtOutCoords();
        if (isnan(value)) {
          setOutput(value);
          return;
        }

        setOutput(clamp(value, minVal, maxVal));
      }
    `}return i.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(r,o){n.minLoc==null&&(n.minLoc=r.getUniformLocationNoThrow(o,"minVal"),n.maxLoc=r.getUniformLocationNoThrow(o,"maxVal")),r.gl.uniform1f(n.minLoc,t),r.gl.uniform1f(n.maxLoc,e)}},i}(),pb=function(){function i(t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t,this.userCode=`
      uniform float minVal;
      uniform float maxVal;

      void main() {
        vec4 value = getAAtOutCoords();

        if (any(isnan(value))) {
          setOutput(value);
          return;
        }

        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));
      }
    `}return i.prototype.getCustomSetupFunc=function(t,e){var n=this;return function(r,o){n.minLoc==null&&(n.minLoc=r.getUniformLocationNoThrow(o,"minVal"),n.maxLoc=r.getUniformLocationNoThrow(o,"maxVal")),r.gl.uniform1f(n.minLoc,t),r.gl.uniform1f(n.maxLoc,e)}},i}(),db=function(i){this.variableNames=["real","imag"],this.outputShape=i,this.userCode=`
      void main() {
        float re = abs(getRealAtOutCoords());
        float im = abs(getImagAtOutCoords());
        float mx = max(re, im);

        // sadly the length function in glsl is not underflow-safe
        // (at least not on Intel GPUs). So the safe solution is
        // to ensure underflow-safety in all cases.
        setOutput(
          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))
        );
      }
    `},mb=function(i){this.outputShape=[],this.outputShape=ur(i,1),this.variableNames=i.map(function(s,u){return"T"+u});var t=new Array(i.length-1);t[0]=i[0][1];for(var e=1;e<t.length;e++)t[e]=t[e-1]+i[e][1];var n=["if (yC < "+t[0]+") setOutput(getT0(yR, yC));"];for(e=1;e<t.length;e++){var r=t[e-1];n.push("else if (yC < "+t[e]+") setOutput(getT"+e+"(yR, yC-"+r+"));")}var o=t.length,a=t[t.length-1];n.push("else setOutput(getT"+o+"(yR, yC-"+a+"));"),this.userCode=`
      void main() {
        ivec2 coords = getOutputCoords();
        int yR = coords.x;
        int yC = coords.y;

        `+n.join(`
        `)+`
      }
    `},vb=function(i,t){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=ur(i,t);var e=this.outputShape,n=e.length,r=We(n),o=Tt("coords",n),a=["x","y","z","w","u","v"].slice(0,n);this.variableNames=i.map(function(v,g){return"T"+g});var s=new Array(i.length-1);s[0]=i[0][t];for(var u=1;u<s.length;u++)s[u]=s[u-1]+i[u][t];var c=a[t],l=a.slice(-2),f=a.join(),h="if ("+c+" < "+s[0]+`) {
        return getChannel(
            getT0(`+f+"), vec2("+l.join()+`));
        }`;for(u=1;u<s.length;u++){var p=s[u-1];h+=`
        if (`+c+" < "+s[u]+"  && "+c+" >= "+s[u-1]+`) {
          return getChannel(
            getT`+u+"("+Co(a,c,p)+`),
            vec2(`+Co(l,c,p)+`));
        }`}var d=s.length,m=s[s.length-1];h+=`
        return getChannel(
          getT`+d+"("+Co(a,c,m)+`),
          vec2(`+Co(l,c,m)+"));",this.userCode=`
      float getValue(`+a.map(function(v){return"int "+v})+`) {
        `+h+`
      }

      void main() {
        `+r+` coords = getOutputCoords();
        vec4 result = vec4(getValue(`+o+`), 0., 0., 0.);

        `+o[n-1]+" = "+o[n-1]+` + 1;
        if (`+o[n-1]+" < "+e[n-1]+`) {
          result.g = getValue(`+o+`);
        }

        `+o[n-2]+" = "+o[n-2]+` + 1;
        if (`+o[n-2]+" < "+e[n-2]+`) {
          result.a = getValue(`+o+`);
        }

        `+o[n-1]+" = "+o[n-1]+` - 1;
        if (`+o[n-2]+" < "+e[n-2]+` &&
            `+o[n-1]+" < "+e[n-1]+`) {
          result.b = getValue(`+o+`);
        }
        setOutput(result);
      }
    `};function Co(i,t,e){var n=i.indexOf(t);return i.map(function(r,o){return o===n?r+" - "+e:r}).join()}var gb=function(i){this.variableNames=["x","dy"],this.outputShape=i.filterShape;var t=i.strideHeight,e=i.strideWidth,n=i.padInfo.top,r=i.padInfo.left,o=i.dataFormat==="channelsLast";this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int wR = coords.x;
        int wC = coords.y;
        int d1 = coords.z;
        int d2 = coords.w;

        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;

        for (int b = 0; b < `+i.batchSize+`; b++) {
          for (int yR = 0; yR < `+i.outHeight+`; yR++) {
            int xR = wR + yR * `+t+" - "+n+`;

            if (xR < 0 || xR >= `+i.inHeight+`) {
              continue;
            }

            for (int yC = 0; yC < `+i.outWidth+`; yC++) {
              int xC = wC + yC * `+e+" - "+r+`;

              if (xC < 0 || xC >= `+i.inWidth+`) {
                continue;
              }

              if (`+o+`) {
                float dyValue = getDy(b, yR, yC, d2);
                float xValue = getX(b, xR, xC, d1);
                dotProd += (xValue * dyValue);
              } else {
                float dyValue = getDy(b, d2, yR, yC);
                float xValue = getX(b, d1, xR, xC);
                dotProd += (xValue * dyValue);
              }

            }
          }
        }
        setOutput(dotProd);
      }
    `},yb=function(i){this.variableNames=["dy","W"],this.outputShape=i.inShape;var t=i.filterHeight,e=i.filterWidth,n=i.strideHeight,r=i.strideWidth,o=i.dataFormat==="channelsLast",a=t-1-i.padInfo.top,s=e-1-i.padInfo.left,u=o?1:2,c=o?2:3,l=o?3:1;this.userCode=`
      const ivec2 pads = ivec2(`+a+", "+s+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d1 = coords[`+l+`];

        ivec2 dyCorner = ivec2(coords[`+u+"], coords["+c+`]) - pads;
        int dyRCorner = dyCorner.x;
        int dyCCorner = dyCorner.y;

        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        for (int wR = 0; wR < `+t+`; wR++) {
          float dyR = float(dyRCorner + wR) / `+n+`.0;

          if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 || fract(dyR) > 0.0) {
            continue;
          }
          int idyR = int(dyR);

          int wRPerm = `+t+` - 1 - wR;

          for (int wC = 0; wC < `+e+`; wC++) {
            float dyC = float(dyCCorner + wC) / `+r+`.0;

            if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                fract(dyC) > 0.0) {
              continue;
            }
            int idyC = int(dyC);

            int wCPerm = `+e+` - 1 - wC;

            for (int d2 = 0; d2 < `+i.outChannels+`; d2++) {

              if (`+o+`) {
                float xValue = getDy(batch, idyR, idyC, d2);
                float wValue = getW(wRPerm, wCPerm, d1, d2);
                dotProd += xValue * wValue;
              } else {
                float xValue = getDy(batch, d2, idyR, idyC);
                float wValue = getW(wRPerm, wCPerm, d1, d2);
                dotProd += xValue * wValue;
              }

            }
          }
        }
        setOutput(dotProd);
      }
    `},xb=function(i){this.variableNames=["x","dy"],this.outputShape=i.filterShape;var t=i.strideDepth,e=i.strideHeight,n=i.strideWidth,r=i.padInfo.front,o=i.padInfo.top,a=i.padInfo.left;this.userCode=`
      void main() {
        ivec5 coords = getOutputCoords();
        int wF = coords.x;
        int wR = coords.y;
        int wC = coords.z;
        int d1 = coords.w;
        int d2 = coords.u;

        float dotProd = 0.0;

        for (int b = 0; b < `+i.batchSize+`; b++) {
          for (int yF = 0; yF < `+i.outDepth+`; yF++) {
            int xF = wF + yF * `+t+" - "+r+`;

            if (xF < 0 || xF >= `+i.inDepth+`) {
              continue;
            }

            for (int yR = 0; yR < `+i.outHeight+`; yR++) {
              int xR = wR + yR * `+e+" - "+o+`;

              if (xR < 0 || xR >= `+i.inHeight+`) {
                continue;
              }

              for (int yC = 0; yC < `+i.outWidth+`; yC++) {
                int xC = wC + yC * `+n+" - "+a+`;

                if (xC < 0 || xC >= `+i.inWidth+`) {
                  continue;
                }

                float dyValue = getDy(b, yF, yR, yC, d2);
                float xValue = getX(b, xF, xR, xC, d1);
                dotProd += (xValue * dyValue);
              }
            }
          }
        }
        setOutput(dotProd);
      }
    `},bb=function(i){this.variableNames=["dy","W"],this.outputShape=i.inShape;var t=i.filterDepth,e=i.filterHeight,n=i.filterWidth,r=i.strideDepth,o=i.strideHeight,a=i.strideWidth,s=t-1-i.padInfo.front,u=e-1-i.padInfo.top,c=n-1-i.padInfo.left;this.userCode=`
      const ivec3 pads = ivec3(`+s+", "+u+", "+c+`);

      void main() {
        ivec5 coords = getOutputCoords();
        int batch = coords.x;
        int d1 = coords.u;


        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;
        int dyFCorner = dyCorner.x;
        int dyRCorner = dyCorner.y;
        int dyCCorner = dyCorner.z;

        float dotProd = 0.0;
        for (int wF = 0; wF < `+t+`; wF++) {
          float dyF = float(dyFCorner + wF) / `+r+`.0;

          if (dyF < 0.0 || dyF >= `+i.outDepth+`.0 || fract(dyF) > 0.0) {
            continue;
          }
          int idyF = int(dyF);

          int wFPerm = `+t+` - 1 - wF;

          for (int wR = 0; wR < `+e+`; wR++) {
            float dyR = float(dyRCorner + wR) / `+o+`.0;

            if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 ||
              fract(dyR) > 0.0) {
              continue;
            }
            int idyR = int(dyR);

            int wRPerm = `+e+` - 1 - wR;

            for (int wC = 0; wC < `+n+`; wC++) {
              float dyC = float(dyCCorner + wC) / `+a+`.0;

              if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                  fract(dyC) > 0.0) {
                continue;
              }
              int idyC = int(dyC);

              int wCPerm = `+n+` - 1 - wC;

              for (int d2 = 0; d2 < `+i.outChannels+`; d2++) {
                float xValue = getDy(batch, idyF, idyR, idyC, d2);
                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);
                dotProd += xValue * wValue;
              }
            }
          }
        }
        setOutput(dotProd);
      }
    `},wb=function(i){this.variableNames=["x","dy"],this.outputShape=i.filterShape;var t=i.strideHeight,e=i.strideWidth,n=i.padInfo.top,r=i.padInfo.left,o=i.outChannels/i.inChannels;this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int wR = coords.x;
        int wC = coords.y;
        int d1 = coords.z;
        int dm = coords.w;
        int d2 = d1 * `+o+` + dm;

        float dotProd = 0.0;

        // TO DO: Vec4 over the batch size
        for (int b = 0; b < `+i.batchSize+`; b++) {
          for (int yR = 0; yR < `+i.outHeight+`; yR++) {
            int xR = wR + yR * `+t+" - "+n+`;

            if (xR < 0 || xR >= `+i.inHeight+`) {
              continue;
            }

            for (int yC = 0; yC < `+i.outWidth+`; yC++) {
              int xC = wC + yC * `+e+" - "+r+`;

              if (xC < 0 || xC >= `+i.inWidth+`) {
                continue;
              }

              float dyValue = getDy(b, yR, yC, d2);
              float xValue = getX(b, xR, xC, d1);
              dotProd += (xValue * dyValue);
            }
          }
        }
        setOutput(dotProd);
      }
    `},Cb=function(i){this.variableNames=["dy","W"],this.outputShape=i.inShape;var t=i.filterHeight,e=i.filterWidth,n=i.strideHeight,r=i.strideWidth,o=t-1-i.padInfo.top,a=e-1-i.padInfo.left,s=i.outChannels/i.inChannels;this.userCode=`
      const ivec2 pads = ivec2(`+o+", "+a+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d1 = coords[3];
        ivec2 dyCorner = coords.yz - pads;
        int dyRCorner = dyCorner.x;
        int dyCCorner = dyCorner.y;

        float dotProd = 0.0;

        for (int wR = 0; wR < `+t+`; wR++) {
          float dyR = float(dyRCorner + wR) / `+n+`.0;

          if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 || fract(dyR) > 0.0) {
            continue;
          }
          int idyR = int(dyR);

          int wRPerm = `+t+` - 1 - wR;

          for (int wC = 0; wC < `+e+`; wC++) {
            float dyC = float(dyCCorner + wC) / `+r+`.0;

            if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                fract(dyC) > 0.0) {
              continue;
            }
            int idyC = int(dyC);

            int wCPerm = `+e+` - 1 - wC;

            // TO DO: Vec4 over the channelMul
            for (int dm = 0; dm < `+s+`; dm++) {
              int d2 = d1 * `+s+` + dm;
              float xValue = getDy(batch, idyR, idyC, d2);
              float wValue = getW(wRPerm, wCPerm, d1, dm);
              dotProd += xValue * wValue;
            }
          }
        }
        setOutput(dotProd);
      }
    `},cp=function(i,t,e,n){t===void 0&&(t=!1),e===void 0&&(e=null),n===void 0&&(n=!1),this.variableNames=["x","W"],this.outputShape=i.outShape;var r=i.padInfo.top,o=i.padInfo.left,a=i.strideHeight,s=i.strideWidth,u=i.dilationHeight,c=i.dilationWidth,l=i.filterHeight,f=i.filterWidth,h=4*Math.floor(i.inChannels/4),p=i.inChannels%4,d=i.dataFormat==="channelsLast",m=d?1:2,v=d?2:3,g=d?3:1,x="",w="";e&&(x=n?`float activation(float a) {
          float b = getPreluActivationWeightsAtOutCoords();
          `+e+`
        }`:`
          float activation(float x) {
            `+e+`
          }
        `,w="result = activation(result);");var y=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode=`
      `+x+`

      const ivec2 strides = ivec2(`+a+", "+s+`);
      const ivec2 pads = ivec2(`+r+", "+o+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d2 = coords[`+g+`];

        ivec2 xRCCorner =
            ivec2(coords[`+m+"], coords["+v+`]) * strides - pads;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        for (int wR = 0; wR < `+l+`; wR++) {
          int xR = xRCorner + wR * `+u+`;

          if (xR < 0 || xR >= `+i.inHeight+`) {
            continue;
          }

          for (int wC = 0; wC < `+f+`; wC++) {
            int xC = xCCorner + wC * `+c+`;

            if (xC < 0 || xC >= `+i.inWidth+`) {
              continue;
            }

            for (int d1 = 0; d1 < `+h+`; d1 += 4) {
              vec4 wValues = vec4(
                getW(wR, wC, d1, d2),
                getW(wR, wC, d1 + 1, d2),
                getW(wR, wC, d1 + 2, d2),
                getW(wR, wC, d1 + 3, d2)
              );

              if (`+d+`) {
                vec4 xValues = vec4(
                  getX(batch, xR, xC, d1),
                  getX(batch, xR, xC, d1 + 1),
                  getX(batch, xR, xC, d1 + 2),
                  getX(batch, xR, xC, d1 + 3)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec4 xValues = vec4(
                  getX(batch, d1, xR, xC),
                  getX(batch, d1 + 1, xR, xC),
                  getX(batch, d1 + 2, xR, xC),
                  getX(batch, d1 + 3, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }
            }

            if (`+(p===1)+`) {

              if (`+d+`) {
                dotProd +=
                    getX(batch, xR, xC, `+h+`) *
                    getW(wR, wC, `+h+`, d2);
              } else {
                dotProd +=
                    getX(batch, `+h+`, xR, xC) *
                    getW(wR, wC, `+h+`, d2);
              }

            } else if (`+(p===2)+`) {
              vec2 wValues = vec2(
                getW(wR, wC, `+h+`, d2),
                getW(wR, wC, `+h+` + 1, d2)
              );

              if (`+d+`) {
                vec2 xValues = vec2(
                  getX(batch, xR, xC, `+h+`),
                  getX(batch, xR, xC, `+h+` + 1)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec2 xValues = vec2(
                  getX(batch, `+h+`, xR, xC),
                  getX(batch, `+h+` + 1, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }

            } else if (`+(p===3)+`) {
              vec3 wValues = vec3(
                getW(wR, wC, `+h+`, d2),
                getW(wR, wC, `+h+` + 1, d2),
                getW(wR, wC, `+h+` + 2, d2)
              );

              if (`+d+`) {
                vec3 xValues = vec3(
                  getX(batch, xR, xC, `+h+`),
                  getX(batch, xR, xC, `+h+` + 1),
                  getX(batch, xR, xC, `+h+` + 2)
                );
                dotProd += dot(xValues, wValues);
              } else {
                vec3 xValues = vec3(
                  getX(batch, `+h+`, xR, xC),
                  getX(batch, `+h+` + 1, xR, xC),
                  getX(batch, `+h+` + 2, xR, xC)
                );
                dotProd += dot(xValues, wValues);
              }

            }
          }
        }

        float result = dotProd;
        `+y+`
        `+w+`
        setOutput(result);
      }
    `},_b=function(i){this.variableNames=["x","W"],this.outputShape=i.outShape;var t=i.padInfo.front,e=i.padInfo.top,n=i.padInfo.left,r=i.strideDepth,o=i.strideHeight,a=i.strideWidth,s=i.dilationDepth,u=i.dilationHeight,c=i.dilationWidth,l=i.filterDepth,f=i.filterHeight,h=i.filterWidth,p=4*Math.floor(i.inChannels/4),d=i.inChannels%4;this.userCode=`
      const ivec3 strides = ivec3(`+r+", "+o+", "+a+`);
      const ivec3 pads = ivec3(`+t+", "+e+", "+n+`);

      void main() {
        ivec5 coords = getOutputCoords();
        int batch = coords.x;
        int d2 = coords.u;

        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;
        int xFCorner = xFRCCorner.x;
        int xRCorner = xFRCCorner.y;
        int xCCorner = xFRCCorner.z;

        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get
        // y(yF, yR, yC, d2). ? = to be determined. : = across all
        // values in that axis.
        float dotProd = 0.0;
        for (int wF = 0; wF < `+l+`; wF++) {
          int xF = xFCorner + wF * `+s+`;

          if (xF < 0 || xF >= `+i.inDepth+`) {
            continue;
          }

          for (int wR = 0; wR < `+f+`; wR++) {
            int xR = xRCorner + wR * `+u+`;

            if (xR < 0 || xR >= `+i.inHeight+`) {
              continue;
            }

            for (int wC = 0; wC < `+h+`; wC++) {
              int xC = xCCorner + wC * `+c+`;

              if (xC < 0 || xC >= `+i.inWidth+`) {
                continue;
              }

              for (int d1 = 0; d1 < `+p+`; d1 += 4) {
                vec4 xValues = vec4(
                  getX(batch, xF, xR, xC, d1),
                  getX(batch, xF, xR, xC, d1 + 1),
                  getX(batch, xF, xR, xC, d1 + 2),
                  getX(batch, xF, xR, xC, d1 + 3)
                );
                vec4 wValues = vec4(
                  getW(wF, wR, wC, d1, d2),
                  getW(wF, wR, wC, d1 + 1, d2),
                  getW(wF, wR, wC, d1 + 2, d2),
                  getW(wF, wR, wC, d1 + 3, d2)
                );

                dotProd += dot(xValues, wValues);
              }

              if (`+(d===1)+`) {
                dotProd +=
                  getX(batch, xF, xR, xC, `+p+`) *
                  getW(wF, wR, wC, `+p+`, d2);
              } else if (`+(d===2)+`) {
                vec2 xValues = vec2(
                  getX(batch, xF, xR, xC, `+p+`),
                  getX(batch, xF, xR, xC, `+p+` + 1)
                );
                vec2 wValues = vec2(
                  getW(wF, wR, wC, `+p+`, d2),
                  getW(wF, wR, wC, `+p+` + 1, d2)
                );
                dotProd += dot(xValues, wValues);
              } else if (`+(d===3)+`) {
                vec3 xValues = vec3(
                  getX(batch, xF, xR, xC, `+p+`),
                  getX(batch, xF, xR, xC, `+p+` + 1),
                  getX(batch, xF, xR, xC, `+p+` + 2)
                );
                vec3 wValues = vec3(
                  getW(wF, wR, wC, `+p+`, d2),
                  getW(wF, wR, wC, `+p+` + 1, d2),
                  getW(wF, wR, wC, `+p+` + 2, d2)
                );
                dotProd += dot(xValues, wValues);
              }
            }
          }
        }
        setOutput(dotProd);
      }
    `},lp=function(i,t,e,n){t===void 0&&(t=!1),e===void 0&&(e=null),n===void 0&&(n=!1),this.variableNames=["x","W"],this.outputShape=i.outShape;var r=i.inHeight,o=i.inWidth,a=i.padInfo.top,s=i.padInfo.left,u=i.strideHeight,c=i.strideWidth,l=i.dilationHeight,f=i.dilationWidth,h=i.filterHeight,p=i.filterWidth,d=i.outChannels/i.inChannels,m="",v="";e&&(m=n?`float activation(float a) {
          float b = getPreluActivationWeightsAtOutCoords();
          `+e+`
        }`:`
          float activation(float x) {
            `+e+`
          }
        `,v="result = activation(result);");var g=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode=`
      `+m+`

      const ivec2 strides = ivec2(`+u+", "+c+`);
      const ivec2 pads = ivec2(`+a+", "+s+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords.x;
        ivec2 xRCCorner = coords.yz * strides - pads;
        int d2 = coords.w;
        int d1 = d2 / `+d+`;
        int q = d2 - d1 * `+d+`;

        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.
        for (int wR = 0; wR < `+h+`; wR++) {
          int xR = xRCorner + wR * `+l+`;

          if (xR < 0 || xR >= `+r+`) {
            continue;
          }

          for (int wC = 0; wC < `+p+`; wC++) {
            int xC = xCCorner + wC * `+f+`;

            if (xC < 0 || xC >= `+o+`) {
              continue;
            }

            float xVal = getX(batch, xR, xC, d1);
            float wVal = getW(wR, wC, d1, q);
            dotProd += xVal * wVal;
          }
        }

        float result = dotProd;
        `+g+`
        `+v+`
        setOutput(result);
      }
    `},fp=function(i,t,e,n){t===void 0&&(t=!1),e===void 0&&(e=null),n===void 0&&(n=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=i.outShape;for(var r=i.inHeight,o=i.inWidth,a=i.padInfo.top,s=i.padInfo.left,u=i.strideHeight,c=i.strideWidth,l=i.dilationHeight,f=i.dilationWidth,h=i.filterHeight,p=i.filterWidth,d=p,m="int xR; int xC; int xCOffset;",v=0;v<h;v++)for(var g=0;g<p;g++)m+=`
          vec4 xTexelR`+v+"C"+2*g+` = vec4(0.);
          vec4 wR`+v+"C"+g+` = vec4(0.);
          vec4 xR`+v+"C"+g+" = vec4(0.);";for(v=0;v<h;v++)for(var x=0;x<d;x++){if(m+=`
          xR = xRCorner + `+v*l+`;
          xC = xCCorner + `+(g=2*x)*f+`;
        `,c===1){if(g<p&&(m+=s%2==1?`
                xCOffset = xC + 1;
                if(xR >= 0 && xR < `+r+" && xCOffset >= 0 && xCOffset < "+o+`) {
                  xTexelR`+v+"C"+g+` = getX(batch, xR, xCOffset, d1);

                  // Need to manually clear unused channels in case
                  // we're reading from recycled texture.
                  if(xCOffset + 1 >= `+o+`) {
                    xTexelR`+v+"C"+g+`.zw = vec2(0.);
                  }
                } else {
                  xTexelR`+v+"C"+g+` = vec4(0.);
                }

                xCOffset = xC + 1 - 2;
                if(xR >= 0 && xR < `+r+" && xCOffset >= 0 && xCOffset < "+o+`) {
                  vec4 previous = getX(batch, xR, xCOffset, d1);

                  // Need to manually clear unused channels in case
                  // we're reading from recycled texture.
                  if(xCOffset + 1 >= `+o+`) {
                    previous.zw = vec2(0.);
                  }

                  xR`+v+"C"+g+" = vec4(previous.zw, xTexelR"+v+"C"+g+`.xy);
                } else {
                  xR`+v+"C"+g+" = vec4(0, 0, xTexelR"+v+"C"+g+`.xy);
                }
              `:`
                if(xR >= 0 && xR < `+r+" && xC >= 0 && xC < "+o+`) {
                  xTexelR`+v+"C"+g+` = getX(batch, xR, xC, d1);
                } else {
                  xTexelR`+v+"C"+g+` = vec4(0.);
                }

                xR`+v+"C"+g+" = xTexelR"+v+"C"+g+`;
              `,g+1<p)){var w=s%2==0?Ju(f):f;f%2==0&&s%2==1||f%2!=0&&s%2!=1?(m+=`
                  xCOffset = xC + `+s%2+" + "+w+`;

                  if(xR >= 0 && xR < `+r+` &&
                    xCOffset >= 0 && xCOffset < `+o+`) {
                    xTexelR`+v+"C"+(g+2)+` = getX(batch, xR, xCOffset, d1);
                  }
                `,f>1&&(m+=`
                    xCOffset -= 2;
                    if(xR >= 0 && xR < `+r+` &&
                      xCOffset >= 0 && xCOffset < `+o+`) {
                      xTexelR`+v+"C"+g+` = getX(batch, xR, xCOffset, d1);
                    } else {
                      xTexelR`+v+"C"+g+` = vec4(0.);
                    }
                  `),m+=`
                  xR`+v+"C"+(g+1)+` = vec4(
                    xTexelR`+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+`.xy);
                `):m+=`
                  xCOffset = xC + `+w+`;

                  if(xR >= 0 && xR < `+r+` &&
                    xCOffset >= 0 && xCOffset < `+o+`) {
                    xTexelR`+v+"C"+(g+2)+` = getX(batch, xR, xCOffset, d1);
                  }

                  xR`+v+"C"+(g+1)+" = xTexelR"+v+"C"+(g+2)+`;
                `}}else g<p&&(m+=`
              if(xR >= 0 && xR < `+r+`) {
            `,s%2==1?(m+=`
                xCOffset = xC + 1 - `+c+`;
                if(xCOffset >= 0 && xCOffset < `+o+`) {
                  xTexelR`+v+"C"+g+` = getX(batch, xR, xCOffset, d1);
                } else {
                  xTexelR`+v+"C"+g+` = vec4(0.);
                }

                if(xC + 1 >= 0 && xC + 1 < `+o+`) {
                  xTexelR`+v+"C"+(g+2)+` = getX(batch, xR, xC + 1, d1);
                } else {
                  xTexelR`+v+"C"+(g+2)+` = vec4(0.);
                }

                xR`+v+"C"+g+` = vec4(
                  xTexelR`+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+`.zw);
              `,g+1<p&&(m+=`
                  vec4 final = vec4(0.);
                  xCOffset = xC + 1 + `+c+`;
                  if(xCOffset >= 0 && xCOffset < `+o+`) {
                    final = getX(batch, xR, xCOffset, d1);
                  }
                  xR`+v+"C"+(g+1)+" = vec4(xTexelR"+v+"C"+(g+2)+`.xy, final.xy);
                `)):(m+=`
                if(xC >= 0 && xC < `+o+`) {
                  xTexelR`+v+"C"+g+` = getX(batch, xR, xC, d1);
                } else {
                  xTexelR`+v+"C"+g+` = vec4(0.);
                }

                xCOffset = xC + `+c+`;
                if(xCOffset >= 0 && xCOffset < `+o+`) {
                  xTexelR`+v+"C"+(g+2)+` = getX(batch, xR, xCOffset, d1);
                } else {
                  xTexelR`+v+"C"+(g+2)+` = vec4(0.);
                }

                xR`+v+"C"+g+` = vec4(
                  xTexelR`+v+"C"+g+".xy, xTexelR"+v+"C"+(g+2)+`.xy);
              `,g+1<p&&(m+=`
                  xR`+v+"C"+(g+1)+` = vec4(
                    xTexelR`+v+"C"+g+".zw, xTexelR"+v+"C"+(g+2)+`.zw);
                `)),m+="}");g<p&&(m+=`
            vec4 wTexelR`+v+"C"+g+" = getW("+v+", "+g+`, d1, q);
            wR`+v+"C"+g+" = vec4(wTexelR"+v+"C"+g+".xz, wTexelR"+v+"C"+g+`.xz);
          `,g+1<p&&(m+=`
              vec4 wTexelR`+v+"C"+(g+1)+" = getW("+v+", "+(g+1)+`, d1, q);
              wR`+v+"C"+(g+1)+` =
                vec4(wTexelR`+v+"C"+(g+1)+".xz, wTexelR"+v+"C"+(g+1)+".xz);"))}for(v=0;v<h;v++)for(g=0;g<p;g++)m+="dotProd += xR"+v+"C"+g+" * wR"+v+"C"+g+";";var y="",b="";e&&(y=n?`vec4 activation(vec4 a) {
          vec4 b = getPreluActivationWeightsAtOutCoords();
          `+e+`
        }`:`vec4 activation(vec4 x) {
          `+e+`
        }`,b="result = activation(result);");var C=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),n&&this.variableNames.push("preluActivationWeights"),this.userCode=`
      `+y+`

      const ivec2 strides = ivec2(`+u+", "+c+`);
      const ivec2 pads = ivec2(`+a+", "+s+`);

      void main() {

        ivec4 coords = getOutputCoords();
        int batch = coords.x;
        ivec2 xRCCorner = coords.yz * strides - pads;
        int d2 = coords.w;
        int d1 = d2;
        int q = 0;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        vec4 dotProd = vec4(0.);

        `+m+`

        vec4 result = dotProd;
        `+C+`
        `+b+`
        setOutput(result);
      }
    `},Eb=function(i,t,e,n,r){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var o=i[0],a=i[1],s=i[2],u=i[3],c=t[0],l=e[0],f=e[1];this.outputShape=[c,l,f,u];var h=n==="bilinear"?1:0,p=[a-1+".0",s-1+".0"],d=p[0],m=p[1],v=l>1?[""+(a-1)/(l-1),"(y2-y1) * height_ratio","y1*"+d+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+d],g=v[0],x=v[1],w=v[2],y=f>1?[""+(s-1)/(f-1),"(x2-x1) * width_ratio","x1*"+m+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+m],b=y[0],C=y[1],S=y[2];this.userCode=`
      const float height_ratio = float(`+g+`);
      const float width_ratio = float(`+b+`);
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int y = coords[1];
        int x = coords[2];
        int d = coords[3];

        // get box vals
        float y1 = getBoxes(b,0);
        float x1 = getBoxes(b,1);
        float y2 = getBoxes(b,2);
        float x2 = getBoxes(b,3);

        // get image in batch index
        int bInd = round(getBoxInd(b));
        if(bInd < 0 || bInd >= `+o+`) {
          return;
        }

        float height_scale = `+x+`;
        float width_scale = `+C+`;

        float in_y = `+w+`;
        if( in_y < 0.0 || in_y > `+d+` ) {
          setOutput(float(`+r+`));
          return;
        }
        float in_x = `+S+`;
        if( in_x < 0.0 || in_x > `+m+` ) {
          setOutput(float(`+r+`));
          return;
        }

        vec2 sourceFracIndexCR = vec2(in_x,in_y);
        if(`+h+` == 1) {
          // Compute the four integer indices.
          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);
          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));

          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);
          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);
          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);
          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);

          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);

          float top = topLeft + (topRight - topLeft) * fracCR.x;
          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;
          float newValue = top + (bottom - top) * fracCR.y;
          setOutput(newValue);
        } else {
          // Compute the coordinators of nearest neighbor point.
          ivec2 sourceNearestCR = ivec2(floor(
            sourceFracIndexCR + vec2(0.5,0.5)));
          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);
          setOutput(newValue);
        }
      }
    `},kb=function(i,t,e){this.variableNames=["x"],this.outputShape=i;var n=i.length,r=i[i.length-1],o=e?"<":">";this.userCode=`
      int getIndex(int i) {
        `+(e?"return "+r+" -i - 1;":"return i;")+`
      }

      void main() {
        `+We(n)+` coords = getOutputCoords();
        int end = `+hp(n,"coords")+`;
        float val = 0.0;
        for (int i = `+r+` - 1; i >= 0; i -= 1) {
          int idx = getIndex(i);
          if (idx `+o+` end) {
            continue;
          }
          if (idx == end && `+t+`) {
            continue;
          }
          `+hp(n,"coords")+` = idx;
          val += getX(`+function(a,s){if(a===1)return""+s;if(a===2)return s+".x, "+s+".y";if(a===3)return s+".x, "+s+".y, "+s+".z";if(a===4)return s+".x, "+s+".y, "+s+".z, "+s+".w";throw Error("Cumulative sum for rank "+a+" is not yet supported")}(n,"coords")+`);
        }
        setOutput(val);
      }
    `};function hp(i,t){if(i===1)return""+t;if(i===2)return t+".y";if(i===3)return t+".z";if(i===4)return t+".w";throw Error("Cumulative sum for rank "+i+" is not yet supported")}var Db=function(i){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=Ai.DENSE;var t=_i(i),e=bt();this.outputShape=i,this.userCode=`
      ivec3 outCoordsFromFlatIndex(int index) {
        `+rr(["r","c","d"],i)+`
        return ivec3(r, c, d);
      }

      void main() {
        ivec2 resTexRC = ivec2(resultUV.yx *
          vec2(`+t[0]+", "+t[1]+`));
        int index = 4 * (resTexRC.x * `+t[1]+` + resTexRC.y);

        vec4 result = vec4(0.);

        for (int i=0; i<4; i++) {
          int flatIndex = index + i;
          ivec3 rc = outCoordsFromFlatIndex(flatIndex);
          result[i] = getA(rc.x, rc.y, rc.z);
        }

        `+e.output+` = result;
      }
    `},Sb=function(i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=Ai.DENSE;var t=_i(i),e=bt();this.outputShape=i,this.userCode=`
      ivec3 outCoordsFromFlatIndex(int index) {
        `+rr(["r","c","d"],i)+`
        return ivec3(r, c, d);
      }

      void main() {
        ivec2 resTexRC = ivec2(resultUV.yx *
          vec2(`+t[0]+", "+t[1]+`));
        int index = 4 * (resTexRC.x * `+t[1]+` + resTexRC.y);

        vec4 result = vec4(0.);

        for (int i=0; i<4; i++) {
          int flatIndex = index + i;
          ivec3 rc = outCoordsFromFlatIndex(flatIndex);
          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));
        }

        `+e.output+` = result;
      }
    `},Ab=function(){function i(t,e,n){this.variableNames=["x"],this.outputShape=[],this.outputShape=t,this.blockSize=e,this.dataFormat=n,this.userCode=`
    void main() {
      ivec4 coords = getOutputCoords();
      int b = coords[0];
      int h = `+this.getHeightCoordString()+`;
      int w = `+this.getWidthCoordString()+`;
      int d = `+this.getDepthCoordString()+`;

      int in_h = h / `+e+`;
      int offset_h = imod(h, `+e+`);
      int in_w = w / `+e+`;
      int offset_w = imod(w, `+e+`);
      int offset_d = (offset_h * `+e+` + offset_w) *
        `+this.getOutputDepthSize()+`;
      int in_d = d + offset_d;

      float result = `+this.getInputSamplingString()+`;
      setOutput(result);
    }
  `}return i.prototype.getHeightCoordString=function(){return this.dataFormat==="NHWC"?"coords[1]":"coords[2]"},i.prototype.getWidthCoordString=function(){return this.dataFormat==="NHWC"?"coords[2]":"coords[3]"},i.prototype.getDepthCoordString=function(){return this.dataFormat==="NHWC"?"coords[3]":"coords[1]"},i.prototype.getOutputDepthSize=function(){return this.dataFormat==="NHWC"?this.outputShape[3]:this.outputShape[1]},i.prototype.getInputSamplingString=function(){return this.dataFormat==="NHWC"?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},i}(),Fb=function(i){this.variableNames=["X"],this.outputShape=[i,i],this.userCode=`
      void main() {
          ivec2 coords = getOutputCoords();
          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;
          setOutput(val);
      }
    `},Rb=function(i){this.variableNames=["A"],this.outTexUsage=Lt.DOWNLOAD;var t=bt();this.outputShape=i,this.userCode=`
      `+Yd+`

      void main() {
        float x = getAAtOutCoords();
        `+t.output+` = encode_float(x);
      }
    `},Ib=function(i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=Lt.DOWNLOAD;var t=bt();this.outputShape=i,this.userCode=`
      `+Yd+`

      void main() {
        ivec3 coords = getOutputCoords();
        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));
        `+t.output+` = encode_float(x);
      }
    `},Tb=function(i,t,e){e===void 0&&(e=!1),this.variableNames=["A"];var n=bt(),r=t[0],o=t[1];this.outputShape=i;var a="result";e&&(a="floor(result * 255. + 0.5)"),this.userCode=`
      `+gc(i)+`

      void main() {
        ivec3 coords = getOutputCoords();

        int flatIndex = getFlatIndex(coords);
        int offset = imod(flatIndex, 4);

        flatIndex = idiv(flatIndex, 4, 1.);
        
        int r = flatIndex / `+o+`;
        int c = imod(flatIndex, `+o+`);
        vec2 uv = (vec2(c, r) + halfCR) / vec2(`+o+".0, "+r+`.0);
        vec4 values = `+n.texture2D+`(A, uv);

        float result;

        if(offset == 0) {
          result = values[0];
        } else if(offset == 1) {
          result = values[1];
        } else if(offset == 2) {
          result = values[2];
        } else {
          result = values[3];
        }

        `+n.output+" = vec4("+a+`, 0., 0., 0.);
      }
    `},Nb=function(i,t,e){e===void 0&&(e=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var n=bt(),r=t[0],o=t[1];this.outputShape=i;var a="",s="result";e&&(s="floor(result * 255. + 0.5)");for(var u=0;u<=1;u++)for(var c=0;c<=1;c++){var l=2*u+c;a+=`
          localCoords = coords;
          if(localCoords[2] + `+c+" < "+i[2]+`) {
            localCoords[2] += `+c+`;
            if(localCoords[1] + `+u+" < "+i[1]+`) {
              localCoords[1] += `+u+`;

              flatIndex = getFlatIndex(localCoords);
              offset = imod(flatIndex, 4);

              flatIndex = idiv(flatIndex, 4, 1.);

              r = flatIndex / `+o+`;
              c = imod(flatIndex, `+o+`);
              uv = (vec2(c, r) + halfCR) / vec2(`+o+".0, "+r+`.0);
              values = `+n.texture2D+`(A, uv);

              if(offset == 0) {
                result[`+l+`] = values[0];
              } else if(offset == 1) {
                result[`+l+`] = values[1];
              } else if(offset == 2) {
                result[`+l+`] = values[2];
              } else {
                result[`+l+`] = values[3];
              }
            }
          }
        `}this.userCode=`
      `+gc(i)+`

      void main() {
        ivec3 coords = getOutputCoords();

        vec4 result = vec4(0.);
        int flatIndex, r, c, offset;
        ivec3 localCoords;
        vec2 uv;
        vec4 values;

        `+a+`

        `+n.output+" = "+s+`;
      }
    `},Pb="return real * expR - imag * expI;",Mb="return real * expI + imag * expR;",pp=function(i,t,e){this.variableNames=["real","imag"];var n=t[1];this.outputShape=t;var r=e?"2.0 * "+Math.PI:"-2.0 * "+Math.PI,o=e?n+".0":"1.0";this.userCode=`
      const float exponentMultiplier = `+r+`;

      float unaryOpComplex(float real, float expR, float imag, float expI) {
        `+i+`
      }

      float mulMatDFT(int batch, int index) {
        float indexRatio = float(index) / float(`+n+`);
        float exponentMultiplierTimesIndexRatio =
            exponentMultiplier * indexRatio;

        float result = 0.0;

        for (int i = 0; i < `+n+`; i++) {
          // x = (-2|2 * PI / N) * index * i;
          float x = exponentMultiplierTimesIndexRatio * float(i);
          float expR = cos(x);
          float expI = sin(x);
          float real = getReal(batch, i);
          float imag = getImag(batch, i);

          result +=
              unaryOpComplex(real, expR, imag, expI) / `+o+`;
        }

        return result;
      }

      void main() {
        ivec2 coords = getOutputCoords();
        setOutput(mulMatDFT(coords[0], coords[1]));
      }
    `},Ob=function(){function i(t,e){this.outputShape=[],this.variableNames=["x"],this.outputShape=t,this.userCode=`
      uniform float value;
      void main() {
        // Input can be obtained from uniform value.
        setOutput(value);
      }
    `}return i.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,r){e.valueLoc==null&&(e.valueLoc=n.getUniformLocationNoThrow(r,"value")),n.gl.uniform1f(e.valueLoc,t)}},i}(),Bb=function(i,t,e){this.variableNames=["A","indices"];var n=i.slice();n[e]=t,this.outputShape=n,this.rank=n.length;var r=We(this.rank),o=function(a,s){var u=a.length;if(u>4)throw Error("Gather for rank "+u+" is not yet supported");if(u===1)return"int(getIndices(resRC))";for(var c=["resRC.x","resRC.y","resRC.z","resRC.w"],l=[],f=0;f<a.length;f++)f===s?l.push("int(getIndices("+c[f]+"))"):l.push(""+c[f]);return l.join()}(i,e);this.userCode=`
      void main() {
        `+r+` resRC = getOutputCoords();
        setOutput(getA(`+o+`));
      }
    `},Lb=function(i,t,e){this.sliceDim=i,this.strides=t,this.variableNames=["x","indices"],this.outputShape=e;var n=We(t.length),r=We(e.length),o=this.sliceDim>1?"strides[j]":"strides";this.userCode=`
        `+n+" strides = "+n+"("+this.strides+`);
         void main() {
          `+r+` coords = getOutputCoords();
          int flattenIndex = 0;
          for (int j = 0; j < `+this.sliceDim+`; j++) {
            int index = round(getIndices(coords[0], j));
            flattenIndex += index * `+o+`;
          }
          setOutput(getX(flattenIndex, coords[1]));
        }
      `};function em(i,t){var e=bt();return od(i,t,e.version+`
    precision highp float;
    `+e.attribute+` vec3 clipSpacePos;
    `+e.attribute+` vec2 uv;
    `+e.varyingVs+` vec2 resultUV;

    void main() {
      gl_Position = vec4(clipSpacePos, 1);
      resultUV = uv;
    }`)}function tm(i,t){return cd(i,t,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function nm(i,t){return ld(i,t,new Uint16Array([0,1,2,2,1,3]))}function Oi(i,t,e,n,r,o,a){hd(e,n);var s=fd(i,t),u=i.TEXTURE_2D;return ee(i,t,function(){return i.bindTexture(u,s)}),ee(i,t,function(){return i.texParameteri(u,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE)}),ee(i,t,function(){return i.texParameteri(u,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}),ee(i,t,function(){return i.texParameteri(u,i.TEXTURE_MIN_FILTER,i.NEAREST)}),ee(i,t,function(){return i.texParameteri(u,i.TEXTURE_MAG_FILTER,i.NEAREST)}),ee(i,t,function(){return i.texImage2D(u,0,r,e,n,0,o,a,null)}),ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,null)}),s}function rm(i,t,e,n,r){var o=Zo(e,n);return Oi(i,t,o[0],o[1],r.internalFormatFloat,r.textureFormatFloat,i.FLOAT)}function im(i,t,e,n,r){var o=Zo(e,n);return Oi(i,t,o[0],o[1],r.internalFormatHalfFloat,r.textureFormatFloat,r.textureTypeHalfFloat)}function om(i,t,e,n,r){var o=Zo(e,n);return Oi(i,t,o[0],o[1],i.RGBA,i.RGBA,i.UNSIGNED_BYTE)}function am(i,t,e,n,r){var o=Mi(e,n);return Oi(i,t,o[0],o[1],r.internalFormatPackedFloat,i.RGBA,i.FLOAT)}function sm(i,t,e,n,r){var o=Mi(e,n);return Oi(i,t,o[0],o[1],r.internalFormatPackedHalfFloat,i.RGBA,r.textureTypeHalfFloat)}function um(i,t,e,n){return ee(i,t,function(){return i.bindBuffer(i.ARRAY_BUFFER,n)}),Lu(i,t,e,"clipSpacePos",n,3,20,0)&&Lu(i,t,e,"uv",n,2,20,12)}function cm(i,t,e,n,r,o,a){var s,u,c;ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,e)}),o instanceof Uint8Array?(s=new Uint8Array(n*r*4),u=i.UNSIGNED_BYTE,c=i.RGBA):(s=new Float32Array(n*r*4),u=i.FLOAT,c=a.internalFormatPackedFloat),s.set(o),ee(i,t,function(){return i.texImage2D(i.TEXTURE_2D,0,c,n,r,0,i.RGBA,u,s)}),ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,null)})}function lm(i,t,e,n){ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,e)}),n.data instanceof Uint8Array?ee(i,t,function(){return i.texImage2D(i.TEXTURE_2D,0,i.RGBA,n.width,n.height,0,i.RGBA,i.UNSIGNED_BYTE,n.data)}):ee(i,t,function(){return i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,n)}),ee(i,t,function(){return i.bindTexture(i.TEXTURE_2D,null)})}function fm(i,t,e,n,r){var o=i.createBuffer();ee(i,t,function(){return i.bindBuffer(i.PIXEL_PACK_BUFFER,o)});var a=16*e*n;return ee(i,t,function(){return i.bufferData(i.PIXEL_PACK_BUFFER,a,i.STREAM_READ)}),ee(i,t,function(){return i.readPixels(0,0,n,e,i.RGBA,i.FLOAT,0)}),ee(i,t,function(){return i.bindBuffer(i.PIXEL_PACK_BUFFER,null)}),o}function hm(i,t,e){var n=i,r=new Float32Array(e);return n.bindBuffer(n.PIXEL_PACK_BUFFER,t),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,r),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),r}function pm(i,t,e,n,r){var o=Zo(e,n),a=o[0],s=o[1],u=new Uint8Array(e*n*4);return ee(i,t,function(){return i.readPixels(0,0,a,s,r.downloadTextureFormat,i.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function dm(i,t,e,n,r,o,a,s){var u=i,c=new Float32Array(function(l,f){var h=Mi(l,f);return h[0]*h[1]*4}(o,a));return u.bindBuffer(u.PIXEL_PACK_BUFFER,t),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,c),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),c}function mm(i,t,e,n){var r=new Float32Array(e*n*4);return ee(i,t,function(){return i.readPixels(0,0,n,e,i.RGBA,i.FLOAT,r)}),r}var Wb=Object.freeze({createVertexShader:em,createVertexBuffer:tm,createIndexBuffer:nm,createFloat32MatrixTexture:rm,createFloat16MatrixTexture:im,createUnsignedBytesMatrixTexture:om,createPackedMatrixTexture:am,createFloat16PackedMatrixTexture:sm,bindVertexProgramAttributeStreams:um,uploadDenseMatrixToTexture:cm,uploadPixelDataToTexture:lm,createBufferFromOutputTexture:fm,downloadFloat32MatrixFromBuffer:hm,downloadByteEncodedFloatMatrixFromOutputTexture:pm,downloadPackedMatrixFromBuffer:dm,downloadMatrixFromPackedOutputTexture:mm}),vm=function(){function i(t){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var e=O().getNumber("WEBGL_VERSION");t!=null?(this.gl=t,nd(e,t)):this.gl=dn(e);var n="WEBGL_color_buffer_float";if(O().getNumber("WEBGL_VERSION")===1){if(this.textureFloatExtension=bi(this.gl,this.debug,"OES_texture_float"),Wt(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=bi(this.gl,this.debug,"OES_texture_half_float");else if(O().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(n),Wt(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=bi(this.gl,this.debug,"EXT_color_buffer_half_float");else if(O().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(n="EXT_color_buffer_float",Wt(this.gl,n))this.colorBufferFloatExtension=this.gl.getExtension(n);else{if(!Wt(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=tm(this.gl,this.debug),this.indexBuffer=nm(this.gl,this.debug),this.framebuffer=pd(this.gl,this.debug),this.textureConfig=rc(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(i.prototype,"debug",{get:function(){return O().getBool("DEBUG")},enumerable:!0,configurable:!0}),i.prototype.dispose=function(){var t=this;if(!this.disposed){this.program!=null&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),this.outputTexture!=null&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var e=this.gl;ee(e,this.debug,function(){return e.finish()}),ee(e,this.debug,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),ee(e,this.debug,function(){return e.deleteFramebuffer(t.framebuffer)}),ee(e,this.debug,function(){return e.bindBuffer(e.ARRAY_BUFFER,null)}),ee(e,this.debug,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}),ee(e,this.debug,function(){return e.deleteBuffer(t.indexBuffer)}),this.disposed=!0}},i.prototype.createFloat32MatrixTexture=function(t,e){return this.throwIfDisposed(),rm(this.gl,this.debug,t,e,this.textureConfig)},i.prototype.createFloat16MatrixTexture=function(t,e){return this.throwIfDisposed(),im(this.gl,this.debug,t,e,this.textureConfig)},i.prototype.createUnsignedBytesMatrixTexture=function(t,e){return this.throwIfDisposed(),om(this.gl,this.debug,t,e,this.textureConfig)},i.prototype.uploadPixelDataToTexture=function(t,e){this.throwIfDisposed(),lm(this.gl,this.debug,t,e)},i.prototype.uploadDenseMatrixToTexture=function(t,e,n,r){this.throwIfDisposed(),cm(this.gl,this.debug,t,e,n,r,this.textureConfig)},i.prototype.createFloat16PackedMatrixTexture=function(t,e){return this.throwIfDisposed(),sm(this.gl,this.debug,t,e,this.textureConfig)},i.prototype.createPackedMatrixTexture=function(t,e){return this.throwIfDisposed(),am(this.gl,this.debug,t,e,this.textureConfig)},i.prototype.deleteMatrixTexture=function(t){var e=this;this.throwIfDisposed(),this.outputTexture===t&&(Wu(this.gl,this.debug,this.framebuffer),this.outputTexture=null),ee(this.gl,this.debug,function(){return e.gl.deleteTexture(t)})},i.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(t,e,n){var r=this;return this.downloadMatrixDriver(t,function(){return pm(r.gl,r.debug,e,n,r.textureConfig)})},i.prototype.downloadPackedMatrixFromBuffer=function(t,e,n,r,o,a){return dm(this.gl,t,0,0,0,o,a,this.textureConfig)},i.prototype.downloadFloat32MatrixFromBuffer=function(t,e){return hm(this.gl,t,e)},i.prototype.createBufferFromTexture=function(t,e,n){this.bindTextureToFrameBuffer(t);var r=fm(this.gl,this.debug,e,n,this.textureConfig);return this.unbindTextureToFrameBuffer(),r},i.prototype.createAndWaitForFence=function(){var t=this.createFence(this.gl);return this.pollFence(t)},i.prototype.createFence=function(t){var e,n,r=this;if(O().getBool("WEBGL_FENCE_API_ENABLED")){var o=t,a=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush(),n=function(){var s=o.clientWaitSync(a,0,0);return s===o.ALREADY_SIGNALED||s===o.CONDITION_SATISFIED},e=a}else O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(e=this.beginQuery(),this.endQuery(),n=function(){return r.isQueryAvailable(e,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):n=function(){return!0};return{query:e,isFencePassed:n}},i.prototype.downloadMatrixFromPackedTexture=function(t,e,n){var r=this;return this.downloadMatrixDriver(t,function(){return mm(r.gl,r.debug,e,n)})},i.prototype.createProgram=function(t){this.throwIfDisposed();var e=this.gl,n=ad(e,this.debug,t),r=em(e,this.debug),o=sd(e,this.debug);return ee(e,this.debug,function(){return e.attachShader(o,r)}),ee(e,this.debug,function(){return e.attachShader(o,n)}),ud(e,this.debug,o),this.debug&&To(e,this.debug,o),this.vertexAttrsAreBound||(this.setProgram(o),this.vertexAttrsAreBound=um(e,this.debug,this.program,this.vertexBuffer)),o},i.prototype.deleteProgram=function(t){var e=this;this.throwIfDisposed(),t===this.program&&(this.program=null),t!=null&&ee(this.gl,this.debug,function(){return e.gl.deleteProgram(t)})},i.prototype.setProgram=function(t){var e=this;this.throwIfDisposed(),this.program=t,this.program!=null&&this.debug&&To(this.gl,this.debug,this.program),ee(this.gl,this.debug,function(){return e.gl.useProgram(t)})},i.prototype.getUniformLocation=function(t,e,n){return n===void 0&&(n=!0),this.throwIfDisposed(),n?md(this.gl,this.debug,t,e):vd(this.gl,t,e)},i.prototype.getAttributeLocation=function(t,e){var n=this;return this.throwIfDisposed(),ee(this.gl,this.debug,function(){return n.gl.getAttribLocation(t,e)})},i.prototype.getUniformLocationNoThrow=function(t,e){return this.throwIfDisposed(),this.gl.getUniformLocation(t,e)},i.prototype.setInputMatrixTexture=function(t,e,n){this.throwIfDisposed(),this.throwIfNoProgram(),gd(this.gl,this.debug,this.program,t,e,n)},i.prototype.setOutputMatrixTexture=function(t,e,n){this.setOutputMatrixTextureDriver(t,n,e)},i.prototype.setOutputPackedMatrixTexture=function(t,e,n){this.throwIfDisposed();var r=Mi(e,n),o=r[0],a=r[1];this.setOutputMatrixTextureDriver(t,o,a)},i.prototype.setOutputMatrixWriteRegion=function(t,e,n,r){this.setOutputMatrixWriteRegionDriver(n,t,r,e)},i.prototype.setOutputPackedMatrixWriteRegion=function(t,e,n,r){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},i.prototype.debugValidate=function(){this.program!=null&&To(this.gl,this.debug,this.program),wi(this.gl)},i.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var t=this.gl;this.debug&&this.debugValidate(),ee(t,this.debug,function(){return t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)})},i.prototype.blockUntilAllProgramsCompleted=function(){var t=this;this.throwIfDisposed(),ee(this.gl,this.debug,function(){return t.gl.finish()})},i.prototype.getQueryTimerExtension=function(){return this.disjointQueryTimerExtension==null&&(this.disjointQueryTimerExtension=bi(this.gl,this.debug,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")===2?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},i.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},i.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},i.prototype.beginQuery=function(){if(O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")===2){var t=this.gl,e=this.getQueryTimerExtensionWebGL2(),n=t.createQuery();return t.beginQuery(e.TIME_ELAPSED_EXT,n),n}var r=this.getQueryTimerExtensionWebGL1(),o=r.createQueryEXT();return r.beginQueryEXT(r.TIME_ELAPSED_EXT,o),o},i.prototype.endQuery=function(){if(O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")!==2){var t=this.getQueryTimerExtensionWebGL1();t.endQueryEXT(t.TIME_ELAPSED_EXT)}else{var e=this.gl,n=this.getQueryTimerExtensionWebGL2();e.endQuery(n.TIME_ELAPSED_EXT)}},i.prototype.waitForQueryAndGetTime=function(t){return te(this,void 0,void 0,function(){var e=this;return ne(this,function(n){switch(n.label){case 0:return[4,Iu(function(){return e.disposed||e.isQueryAvailable(t,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return n.sent(),[2,this.getQueryTime(t,O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},i.prototype.getQueryTime=function(t,e){if(e===0)return null;if(e===2){var n=this.gl;return n.getQueryParameter(t,n.QUERY_RESULT)/1e6}var r=this.getQueryTimerExtensionWebGL1();return r.getQueryObjectEXT(t,r.QUERY_RESULT_EXT)/1e6},i.prototype.isQueryAvailable=function(t,e){if(e===0)return!0;if(e===2){var n=this.gl,r=this.getQueryTimerExtensionWebGL2(),o=n.getQueryParameter(t,n.QUERY_RESULT_AVAILABLE);return this.disjoint==null&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),o&&!this.disjoint}return o=(r=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(t,r.QUERY_RESULT_AVAILABLE_EXT),this.disjoint==null&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),o&&!this.disjoint},i.prototype.pollFence=function(t){var e=this;return new Promise(function(n){e.addItemToPoll(function(){return t.isFencePassed()},function(){return n()})})},i.prototype.pollItems=function(){for(var t=function(n){for(var r=0;r<n.length&&n[r]();++r);return r-1}(this.itemsToPoll.map(function(n){return n.isDoneFn})),e=0;e<=t;++e)(0,this.itemsToPoll[e].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(t+1)},i.prototype.addItemToPoll=function(t,e){var n=this;this.itemsToPoll.push({isDoneFn:t,resolveFn:e}),this.itemsToPoll.length>1||Iu(function(){return n.pollItems(),n.itemsToPoll.length===0})},i.prototype.bindTextureToFrameBuffer=function(t){this.throwIfDisposed(),No(this.gl,this.debug,t,this.framebuffer),this.debug&&wi(this.gl)},i.prototype.unbindTextureToFrameBuffer=function(){this.outputTexture!=null?(No(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&wi(this.gl)):Wu(this.gl,this.debug,this.framebuffer)},i.prototype.downloadMatrixDriver=function(t,e){this.bindTextureToFrameBuffer(t);var n=e();return this.unbindTextureToFrameBuffer(),n},i.prototype.setOutputMatrixTextureDriver=function(t,e,n){this.throwIfDisposed();var r=this.gl;No(r,this.debug,t,this.framebuffer),this.debug&&wi(r),this.outputTexture=t,ee(r,this.debug,function(){return r.viewport(0,0,e,n)}),ee(r,this.debug,function(){return r.scissor(0,0,e,n)})},i.prototype.setOutputMatrixWriteRegionDriver=function(t,e,n,r){var o=this;this.throwIfDisposed(),ee(this.gl,this.debug,function(){return o.gl.scissor(t,e,n,r)})},i.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},i.prototype.throwIfNoProgram=function(){if(this.program==null)throw new Error("No GPU program is currently set.")},i}();function dp(i,t){if(i.length!==t.length)throw Error("Binary was compiled with "+i.length+" inputs, but was executed with "+t.length+" inputs");i.forEach(function(e,n){var r=e.logicalShape,o=t[n],a=o.shape;if(!Je(r,a))throw Error("Binary was compiled with different shapes than the current args. Shapes "+r+" and "+a+" must match");if(!e.isUniform||!o.isUniform){var s=e.texShape,u=o.isUniform?null:o.texData.texShape;if(!Je(s,u))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+s+" and "+u+" must match")}})}var zb=function(i,t,e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=i;for(var n=e.filterWidth,r=e.inChannels,o=e.strideWidth,a=e.strideHeight,s=e.padInfo,u=e.outWidth,c=e.dilationWidth,l=e.dilationHeight,f=e.dataFormat,h=s.left,p=s.top,d=r*n,m=bt(),v=f==="channelsLast",g=v?0:1,x=v?1:2,w="",y=0;y<=1;y++)for(var b=0;b<=1;b++)w+=`
          blockIndex = rc.y + `+b+`;
          pos = rc.x + `+y+`;

          if(blockIndex < `+i[1]+" && pos < "+i[0]+`) {
            offsetY = int(blockIndex / (`+u+")) * "+a+" - "+p+`;
            d0 = offsetY + `+l+" * (pos / "+d+`);

            if(d0 < `+t[g]+` && d0 >= 0) {

              offsetX = int(mod(float(blockIndex), `+u+".) * "+o+". - "+h+`.);
              d1 = offsetX + `+c+" * (int(mod(float(pos), "+d+".) / "+r+`.));

              if(d1 < `+t[x]+` && d1 >= 0) {

                ch = int(mod(float(pos), `+r+`.));

                if (`+v+`) {
                  innerDims = vec2(d1, ch);
                  result[`+(2*y+b)+`] = getChannel(
                    getA(d0, int(innerDims.x),
                    int(innerDims.y)), innerDims);
                } else {
                  innerDims = vec2(d0, d1);
                  result[`+(2*y+b)+`] = getChannel(
                    getA(ch, int(innerDims.x),
                    int(innerDims.y)), innerDims);
                }
              }
            }
          }
        `;this.userCode=`
      void main() {
        ivec2 rc = getOutputCoords();

        vec4 result = vec4(0);

        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;
        vec2 innerDims;

        `+w+`

        `+m.output+` = result;
      }
    `},qb=function(i,t,e,n,r){this.variableNames=["x"],this.outputShape=[];var o,a=t,s=i[3]-1;this.outputShape=i;var u="float("+e+") + float("+n+") * sum";o=r===.5?"inversesqrt("+u+")":r===1?"1.0/("+u+")":"exp(log("+u+") * float(-"+r+"));",this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int r = coords[1];
        int c = coords[2];
        int d = coords[3];
        float x = getX(b, r, c, d);
        float sum = 0.0;
        for (int j = -`+a+"; j <= "+a+`; j++) {
          int idx = d + j;
          if (idx >= 0 && idx <=  `+s+`) {
            float z = getX(b, r, c, idx);
            sum += z * z;
          }
        }
        float val = x * `+o+`;
        setOutput(val);
      }
    `},Vb=function(i,t,e,n,r){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=i,this.depth=i[3],this.depthRadius=t,this.bias=e,this.alpha=n,this.beta=r,this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int r = coords[1];
        int c = coords[2];

        float result = 0.0;
        for (int d = 0; d < `+this.depth+`; ++d) {
          int depthBegin = int(max(0.0, float(d - `+t+`)));
          int depthEnd = int(min(float(`+this.depth+`),
              float(d + `+t+` + 1)));

          const int MIN_DEPTH_BEGIN = 0;
          const int MAX_DEPTH_END = `+this.depth+`;

          float norm = 0.0;
          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {
            if (k < depthBegin){
              continue;
            }
            else if (k >= depthBegin && k < depthEnd) {
              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);
            }
            else {
              break;
            }
          }

          norm = float(`+n+") * norm + float("+e+`);

          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){
            if (k < depthBegin){
              continue;
            }
            else if (k >= depthBegin && k < depthEnd){
              float dyi = -2.0 * float(`+n+`)
                * float(`+r+`)
                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)
                / norm;
              if (k == d) {
                dyi += pow(norm, -1.0 * `+r+`);
              }
              if (k == coords[3]) {
                dyi *= getDy(b, r, c, d);
                result += dyi;
              }
            }
            else {
              break;
            }
          }
      }
      setOutput(result);
      }
    `},Ub=function(i,t,e,n,r){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var o,a=t,s=i[3]-1;this.outputShape=i;var u="float("+e+") + float("+n+") * sum";o=r===.5?"inversesqrt("+u+")":r===1?"1.0/("+u+")":"exp(log("+u+") * float(-"+r+"));",this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords.x;
        int r = coords.y;
        int c = coords.z;
        int d = coords.w;

        bool hasNextCol = d < `+this.outputShape[3]+`;
        bool hasNextRow = c < `+this.outputShape[2]+`;

        vec4 sum = vec4(0.);
        vec4 xFragAtOutputCoords = getX(b, r, c, d);

        vec4 xAtOutputCoords = vec4(
          getChannel(xFragAtOutputCoords, vec2(c, d)),
          hasNextCol ?
            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,
          hasNextRow ?
            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,
          (hasNextRow && hasNextCol) ?
            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0
        );

        int firstChannel = d - `+a+`;
        vec2 cache = vec2(0.);
        if(firstChannel >= 0){
          vec4 firstChannelFrag = getX(b, r, c, firstChannel);
          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));
            if(hasNextRow){
              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));
            }
        }

        ivec2 depth = ivec2(d, d + 1);
        for (int j = - `+a+"; j <= "+a+`; j++) {
          ivec2 idx = depth + j;
          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));
          bvec2 belowUpperBound = lessThanEqual(idx, ivec2(`+s+`));

          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;
          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;

          if(depthInRange || depthPlusOneInRange){
            vec4 z = vec4(0.);
            vec4 xFragAtCurrentDepth;
            z.xz = cache.xy;
            if(depthPlusOneInRange && hasNextCol){
              xFragAtCurrentDepth = idx.y != d ?
                getX(b, r, c, idx.y) : xFragAtOutputCoords;
              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));
              if(hasNextRow){
                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));
              }
            }
            cache.xy = z.yw;
            sum += z * z;
          }
        }
        vec4 result = xAtOutputCoords * `+o+`;
        setOutput(result);
      }
    `},jb=function(i){this.variableNames=["dy","maxPos"],this.outputShape=i.inShape;var t=i.strideHeight,e=i.strideWidth,n=i.dilationHeight,r=i.effectiveFilterHeight,o=i.effectiveFilterWidth,a=r-1-i.padInfo.top,s=o-1-i.padInfo.left,u=r*o-1;this.userCode=`
      const ivec2 pads = ivec2(`+a+", "+s+`);

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];

        ivec2 dyRCCorner = coords.yz - pads;
        int dyRCorner = dyRCCorner.x;
        int dyCCorner = dyRCCorner.y;

        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;
        for (int wR = 0; wR < `+r+`;
          wR += `+n+`) {
          float dyR = float(dyRCorner + wR) / `+t+`.0;

          if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 || fract(dyR) > 0.0) {
            continue;
          }
          int idyR = int(dyR);

          for (int wC = 0; wC < `+o+`; wC++) {
            float dyC = float(dyCCorner + wC) / `+e+`.0;

            if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                fract(dyC) > 0.0) {
              continue;
            }
            int idyC = int(dyC);

            float dyValue = getDy(b, idyR, idyC, d);
            int maxPosValue = `+u+` - int(getMaxPos(b, idyR, idyC, d));

            // Get the current value, check it against the value from the
            // position matrix.
            int curPosValue = wR * `+o+` + wC;
            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);

            dotProd += dyValue * mask;
          }
        }
        setOutput(dotProd);
      }
    `},Gb=function(i){this.variableNames=["dy","maxPos"],this.outputShape=i.inShape;var t=i.strideDepth,e=i.strideHeight,n=i.strideWidth,r=i.dilationDepth,o=i.dilationHeight,a=i.dilationWidth,s=i.effectiveFilterDepth,u=i.effectiveFilterHeight,c=i.effectiveFilterWidth,l=s-1-i.padInfo.front,f=u-1-i.padInfo.top,h=c-1-i.padInfo.left,p=s*u*c-1;this.userCode=`
      const ivec3 pads = ivec3(`+l+", "+f+", "+h+`);

      void main() {
        ivec5 coords = getOutputCoords();
        int batch = coords.x;
        int ch = coords.u;

        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;
        int dyDCorner = dyCorner.x;
        int dyRCorner = dyCorner.y;
        int dyCCorner = dyCorner.z;

        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get
        // dx(xD, xR, xC, ch).
        // ? = to be determined. : = across all values in that axis.
        float dotProd = 0.0;

        for (int wD = 0; wD < `+s+`;
           wD += `+r+`) {
          float dyD = float(dyDCorner + wD) / `+t+`.0;

          if (dyD < 0.0 || dyD >= `+i.outDepth+`.0 || fract(dyD) > 0.0) {
            continue;
          }
          int idyD = int(dyD);

          for (int wR = 0; wR < `+u+`;
              wR += `+o+`) {
            float dyR = float(dyRCorner + wR) / `+e+`.0;

            if (dyR < 0.0 || dyR >= `+i.outHeight+`.0 ||
                fract(dyR) > 0.0) {
              continue;
            }
            int idyR = int(dyR);

            for (int wC = 0; wC < `+c+`;
                wC += `+a+`) {
              float dyC = float(dyCCorner + wC) / `+n+`.0;

              if (dyC < 0.0 || dyC >= `+i.outWidth+`.0 ||
                  fract(dyC) > 0.0) {
                continue;
              }
              int idyC = int(dyC);

              float dyValue = getDy(batch, idyD, idyR, idyC, ch);
              int maxPosValue = `+p+` -
                  int(getMaxPos(batch, idyD, idyR, idyC, ch));

              // Get the current value, check it against the value from the
              // position matrix.
              int curPosValue =
                  wD * `+u+" * "+c+` +
                  wR * `+c+` + wC;
              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);

              dotProd += dyValue * mask;
            }
          }
        }
        setOutput(dotProd);
      }
    `},mu=function(i,t,e,n,r,o,a){e===void 0&&(e=!1),n===void 0&&(n=!1),r===void 0&&(r=!1),o===void 0&&(o=null),a===void 0&&(a=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t;var s=e?i[1]:i[2],u=Math.ceil(s/2),c=e?"i * 2, rc.y":"rc.y, i * 2",l=n?"rc.z, i * 2":"i * 2, rc.z",f=e?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],h=n?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],p="",d="";o&&(p=a?`vec4 activation(vec4 a) {
          vec4 b = getPreluActivationWeightsAtOutCoords();
          `+o+`
        }`:`vec4 activation(vec4 x) {
          `+o+`
        }`,d="result = activation(result);");var m=r?"result += getBiasAtOutCoords();":"";r&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),this.userCode=`
      `+p+`

      const float sharedDimension = `+u+`.0;

      vec4 dot2x2ARowBCol(ivec3 rc) {
        vec4 result = vec4(0);
        for (int i = 0; i < `+u+`; i++) {
          vec4 a = getMatrixA(rc.x, `+c+`);
          vec4 b = getMatrixB(rc.x, `+l+`);

          // These swizzled products need to be separately added.
          // See: https://github.com/tensorflow/tfjs/issues/1735
          result += (`+f[0]+" * "+h[0]+`);
          result += (`+f[1]+" * "+h[1]+`);
        }
        return result;
      }

      void main() {
        ivec3 rc = getOutputCoords();
        vec4 result = dot2x2ARowBCol(rc);

        `+m+`

        `+d+`

        setOutput(result);
      }
    `},Hb=function(){function i(t,e,n){this.variableNames=["probs"],this.outputShape=[t,n],this.userCode=`
      uniform float seed;

      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];

        float r = random(seed);
        float cdf = 0.0;

        for (int i = 0; i < `+(e-1)+`; i++) {
          cdf += getProbs(batch, i);

          if (r < cdf) {
            setOutput(float(i));
            return;
          }
        }

        // If no other event happened, last event happened.
        setOutput(float(`+(e-1)+`));
      }
    `}return i.prototype.getCustomSetupFunc=function(t){var e=this;return function(n,r){e.seedLoc==null&&(e.seedLoc=n.getUniformLocation(r,"seed")),n.gl.uniform1f(e.seedLoc,t)}},i}(),Kb=function(i,t,e,n){this.variableNames=["indices"],this.outputShape=[i,t],this.userCode=`
      void main() {
        ivec2 coords = getOutputCoords();
        int index = round(getIndices(coords.x));
        setOutput(mix(float(`+n+"), float("+e+`),
                      float(index == coords.y)));
      }
    `},Xb=function(i){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=i;var t=i.length;if(t===0)this.userCode=`
        void main() {
          setOutput(vec4(getA(), 0., 0., 0.));
        }
      `;else{var e=Tt("rc",t),n=We(t),r=function(s,u,c){if(s===1)return"rc > "+u[0];for(var l="",f=s-2;f<s;f++)l+=c[f]+" >= "+u[f],f<s-1&&(l+="||");return l}(t,i,e),o=function(s,u,c,l){if(s===1)return"";var f=l.slice(-2);return`
    int r = `+f[0]+`;
    int c = `+f[1]+`;
    int rp1 = r + 1;
    int cp1 = c + 1;

    bool cEdge = cp1 >= `+u+`;
    bool rEdge = rp1 >= `+c+`;
  `}(t,i[i.length-1],i[i.length-2],e),a=function(s,u){var c=s.length,l=function(f,h){for(var p=[],d=0;d<=1;d++)for(var m=0;m<=1;m++){for(var v=(d===0?"r":"rp1")+", "+(m===0?"c":"cp1"),g=2;g<f;g++)v=h[h.length-1-g]+","+v;p.push(v)}return p}(c,u);return c===1?`getA(rc),
            rc + 1 >= `+s[0]+` ? 0. : getA(rc + 1),
            0, 0`:"getA("+l[0]+`),
          cEdge ? 0. : getA(`+l[1]+`),
          rEdge ? 0. : getA(`+l[2]+`),
          rEdge || cEdge ? 0. : getA(`+l[3]+")"}(i,e);this.userCode=`
        void main() {
          `+n+` rc = getOutputCoords();

          if(`+r+`) {
            setOutput(vec4(0));
          } else {
            `+o+`

            setOutput(vec4(`+a+`));
          }
        }
      `}},$b=function(i,t,e){this.variableNames=["x"],this.outputShape=t.map(function(u,c){return u[0]+i[c]+u[1]});var n=i.length,r=We(n),o=t.map(function(u){return u[0]}).join(","),a=t.map(function(u,c){return u[0]+i[c]}).join(","),s=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,n);this.userCode=n!==1?`
      `+r+" start = "+r+"("+o+`);
      `+r+" end = "+r+"("+a+`);

      void main() {
        `+r+` outC = getOutputCoords();
        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {
          setOutput(float(`+e+`));
        } else {
          `+r+` coords = outC - start;
          setOutput(getX(`+s+`));
        }
      }
    `:`
        int start = `+o+`;
        int end = `+a+`;

        void main() {
          int outC = getOutputCoords();
          if (outC < start || outC >= end) {
            setOutput(float(`+e+`));
          } else {
            setOutput(getX(outC - start));
          }
        }
      `},Yb=function(i,t,e){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t.map(function(v,g){return v[0]+i[g]+v[1]});for(var n=i.length,r=We(n),o=t.map(function(v){return v[0]}).join(","),a=t.map(function(v,g){return v[0]+i[g]}).join(","),s=Tt("rc",n),u=Tt("source",n),c=s[n-1]+" < "+this.outputShape[n-1],l=n===1?"source":"vec2("+u.slice(-2).join()+")",f=[r+" rc = outputLoc;",s[n-1]+` += 1;
       if(`+c+`) {
      `,n===1?"":`}
       rc = outputLoc;
       `+s[n-2]+` += 1;
       if(`+s[n-2]+" < "+this.outputShape[n-2]+") {",n===1?"":"  "+s[n-1]+` += 1;
         if(`+c+") {"],h=n===1?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",p="",d=0,m=n===1?2:4;d<m;d++)p+=`
        `+f[d]+`
        if (`+h+`) {
          result[`+d+"] = float("+e+`);
        } else {
          `+r+` source = rc - start;
          result[`+d+"] = getChannel(getX("+u.join()+"), "+l+`);
        }
      `;p+=n===1?"} ":"}}",this.userCode=`
      const `+r+" start = "+r+"("+o+`);
      const `+r+" end = "+r+"("+a+`);

      void main() {
        `+r+` outputLoc = getOutputCoords();
        vec4 result = vec4(0.);
        `+p+`
        setOutput(result);
      }
    `},vu=function(i,t,e){if(this.variableNames=["x"],t==="avg"&&e)throw new Error("Cannot compute positions for average pool.");var n=i.filterWidth,r=i.strideHeight,o=i.strideWidth,a=i.dilationHeight,s=i.dilationWidth,u=i.effectiveFilterHeight,c=i.effectiveFilterWidth,l=i.padInfo.top,f=i.padInfo.left;this.outputShape=i.outShape;var h=t==="avg",p="0.0";if(h||(p="-1.0 / 1e-20"),e)this.userCode=`
        const ivec2 strides = ivec2(`+r+", "+o+`);
        const ivec2 pads = ivec2(`+l+", "+f+`);

        void main() {
          ivec4 coords = getOutputCoords();
          int batch = coords[0];
          int d = coords[3];

          ivec2 xRCCorner = coords.yz * strides - pads;
          int xRCorner = xRCCorner.x;
          int xCCorner = xRCCorner.y;

          // max/min x(?, ?, d) to get y(yR, yC, d).
          // ? = to be determined
          float minMaxValue = 0.0;
          float minMaxValueFound = 0.0;
          int minMaxPosition = 0;
          float avgValue = 0.0;

          for (int wR = 0; wR < `+u+`;
              wR += `+a+`) {
            int xR = xRCorner + wR;

            if (xR < 0 || xR >= `+i.inHeight+`) {
              continue;
            }

            for (int wC = 0; wC < `+c+`;
                wC += `+s+`) {
              int xC = xCCorner + wC;

              if (xC < 0 || xC >= `+i.inWidth+`) {
                continue;
              }

              float value = getX(batch, xR, xC, d);

              // If a min / max value has already been found, use it. If not,
              // use the current value.
              float currMinMaxValue = mix(
                  value, minMaxValue, minMaxValueFound);
              if (value >= currMinMaxValue) {
                minMaxValue = value;
                minMaxValueFound = 1.0;
                minMaxPosition = wR * `+c+` + wC;
              }
            }
          }
          setOutput(float(minMaxPosition));
        }
      `;else{var d=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";t==="avg"&&(d="avgValue / count");var m=4*Math.floor(n/4),v=n%4,g=`
      if (`+h+`) {
        avgValue += dot(values, ones);
      } else {
        minMaxValue = max(values, minMaxValue);
      }
    `;this.userCode=`
      const ivec2 strides = ivec2(`+r+", "+o+`);
      const ivec2 pads = ivec2(`+l+", "+f+`);
      const float initializationValue = `+p+`;
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float count = 0.0;

      float getValue(int batch, int xR, int xC, int d) {
        if (xC < 0 || xC >= `+i.inWidth+`) {
          return initializationValue;
        }
        count += 1.0;
        return getX(batch, xR, xC, d);
      }

      void main() {
        ivec4 coords = getOutputCoords();
        int batch = coords[0];
        int d = coords[3];

        ivec2 xRCCorner = coords.yz * strides - pads;
        int xRCorner = xRCCorner.x;
        int xCCorner = xRCCorner.y;

        // max/min x(?, ?, d) to get y(yR, yC, d).
        // ? = to be determined
        vec4 minMaxValue = vec4(`+p+`);
        float avgValue = 0.0;
        count = 0.0;

        for (int wR = 0; wR < `+u+`;
            wR += `+a+`) {
          int xR = xRCorner + wR;

          if (xR < 0 || xR >= `+i.inHeight+`) {
            continue;
          }

          for (int wC = 0; wC < `+m+`; wC += 4) {
            int xC = xCCorner + wC * `+s+`;

            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+s+`, d),
              getValue(batch, xR, xC + 2 * `+s+`, d),
              getValue(batch, xR, xC + 3 * `+s+`, d)
            );

            `+g+`
          }

          int xC = xCCorner + `+m+`;
          if (`+(v===1)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              initializationValue,
              initializationValue,
              initializationValue
            );

            `+g+`
          } else if (`+(v===2)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+s+`, d),
              initializationValue,
              initializationValue
            );

            `+g+`
          } else if (`+(v===3)+`) {
            vec4 values = vec4(
              getValue(batch, xR, xC, d),
              getValue(batch, xR, xC + `+s+`, d),
              getValue(batch, xR, xC + 2 * `+s+`, d),
              initializationValue
            );

            `+g+`
          }
        }
        setOutput(`+d+`);
      }
    `}},gu=function(i,t,e){if(this.variableNames=["x"],t==="avg"&&e)throw new Error("Cannot compute positions for average pool.");var n=i.filterWidth,r=i.strideDepth,o=i.strideHeight,a=i.strideWidth,s=i.dilationDepth,u=i.dilationHeight,c=i.dilationWidth,l=i.effectiveFilterDepth,f=i.effectiveFilterHeight,h=i.effectiveFilterWidth,p=i.padInfo.front,d=i.padInfo.top,m=i.padInfo.left;this.outputShape=i.outShape;var v=t==="avg",g="0.0";if(v||(g="-1.0 / 1e-20"),e)this.userCode=`
        const ivec3 strides =
            ivec3(`+r+", "+o+", "+a+`);
        const ivec3 pads = ivec3(`+p+", "+d+", "+m+`);

        void main() {
          ivec5 coords = getOutputCoords();
          int batch = coords.x;
          int ch = coords.u;

          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;
          int xDCorner = xCorner.x;
          int xRCorner = xCorner.y;
          int xCCorner = xCorner.z;

          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).
          // ? = to be determined
          float minMaxValue = 0.0;
          float minMaxValueFound = 0.0;
          int minMaxPosition = 0;

          for (int wD = 0; wD < `+l+`;
              wD += `+s+`) {
            int xD = xDCorner + wD;

            if (xD < 0 || xD >= `+i.inDepth+`) {
              continue;
            }

            for (int wR = 0; wR < `+f+`;
                wR += `+u+`) {
              int xR = xRCorner + wR;

              if (xR < 0 || xR >= `+i.inHeight+`) {
                continue;
              }

              for (int wC = 0; wC < `+h+`;
                  wC += `+c+`) {
                int xC = xCCorner + wC;

                if (xC < 0 || xC >= `+i.inWidth+`) {
                  continue;
                }

                float value = getX(batch, xD, xR, xC, ch);

                // If a min / max value has already been found, use it. If not,
                // use the current value.
                float currMinMaxValue = mix(
                    value, minMaxValue, minMaxValueFound);
                if (value >= currMinMaxValue) {
                  minMaxValue = value;
                  minMaxValueFound = 1.0;
                  minMaxPosition =
                      wD * `+f+" * "+h+` +
                      wR * `+h+` + wC;;
                }
              }
            }
          }
          setOutput(float(minMaxPosition));
        }
      `;else{var x=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";t==="avg"&&(x="avgValue / count");var w=4*Math.floor(n/4),y=n%4,b=`
      if (`+v+`) {
        avgValue += dot(values, ones);
      } else {
        minMaxValue = max(values, minMaxValue);
      }
    `;this.userCode=`
      const ivec3 strides =
        ivec3(`+r+", "+o+", "+a+`);
      const ivec3 pads = ivec3(`+p+", "+d+", "+m+`);
      const float initializationValue = `+g+`;
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float count = 0.0;

      float getValue(int batch, int xD, int xR, int xC, int ch) {
        if (xC < 0 || xC >= `+i.inWidth+`) {
          return initializationValue;
        }
        count += 1.0;
        return getX(batch, xD, xR, xC, ch);
      }

      void main() {
        ivec5 coords = getOutputCoords();
        int batch = coords.x;
        int ch = coords.u;

        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;
        int xDCorner = xCorner.x;
        int xRCorner = xCorner.y;
        int xCCorner = xCorner.z;

        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).
        // ? = to be determined
        vec4 minMaxValue = vec4(`+g+`);
        float avgValue = 0.0;
        count = 0.0;

        for (int wD = 0; wD < `+l+`;
            wD += `+s+`) {
          int xD = xDCorner + wD;

          if (xD < 0 || xD >= `+i.inDepth+`) {
            continue;
          }

          for (int wR = 0; wR < `+f+`;
            wR += `+u+`) {
            int xR = xRCorner + wR;

            if (xR < 0 || xR >= `+i.inHeight+`) {
              continue;
            }

            for (int wC = 0; wC < `+w+`; wC += 4) {
              int xC = xCCorner + wC * `+c+`;

              vec4 values = vec4(
                getValue(batch, xD, xR, xC, ch),
                getValue(batch, xD, xR, xC + `+c+`, ch),
                getValue(batch, xD, xR, xC + 2 * `+c+`, ch),
                getValue(batch, xD, xR, xC + 3 * `+c+`, ch)
              );

              `+b+`
            }

            int xC = xCCorner + `+w+`;
            if (`+(y===1)+`) {
              vec4 values = vec4(
                getValue(batch, xD, xR, xC, ch),
                initializationValue,
                initializationValue,
                initializationValue
              );

              `+b+`
            } else if (`+(y===2)+`) {
              vec4 values = vec4(
                getValue(batch, xD, xR, xC, ch),
                getValue(batch, xD, xR, xC + `+c+`, ch),
                initializationValue,
                initializationValue
              );

              `+b+`
            } else if (`+(y===3)+`) {
              vec4 values = vec4(
                getValue(batch, xD, xR, xC, ch),
                getValue(batch, xD, xR, xC + `+c+`, ch),
                getValue(batch, xD, xR, xC + 2 * `+c+`, ch),
                initializationValue
              );

              `+b+`
            }
          }
          setOutput(`+x+`);
        }
      }
    `}},Jb=function(i,t){this.variableNames=["x"];var e=i.windowSize,n=i.batchSize,r=i.inSize,o=Math.ceil(r/e);this.outputShape=[n,o];var a="0.0",s="";t==="prod"?a="1.0":t==="min"?(a="1.0 / 1e-20",s="min"):t==="max"&&(a="-1.0 / 1e-20",s="max");var u=t+"("+t+"("+t+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";t==="sum"?u="sumValue":t==="prod"?u="prodValue":t==="all"?u="allValue":t==="any"&&(u="anyValue");var c=4*Math.floor(e/4),l=e%4,f=`
      if (`+(t==="sum")+`) {
        sumValue += dot(values, ones);
      } else if (`+(t==="prod")+`) {
        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);
        prodValue *= tmp[0] * tmp[1];
      } else {
        minMaxValue = `+s+`(values, minMaxValue);
      }
    `,h="vec4";t==="all"?(a="1.0",f=`
        bool reducedAllValue = all(values);
        float floatedReducedAllValue = float(reducedAllValue);
        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);
      `,h="bvec4"):t==="any"&&(a="0.0",f=`
        bool reducedAnyValue = any(values);
        float floatedReducedAnyValue = float(reducedAnyValue);
        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);
      `,h="bvec4");var p="";r%e>0&&(p=`
        if (inIdx < 0 || inIdx >= `+r+`) {
          return initializationValue;
        }
      `),this.userCode=`
      const float initializationValue = `+a+`;
      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);

      float getValue(int batch, int inIdx) {
        `+p+`
        return getX(batch, inIdx);
      }

      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];
        int outIdx = coords[1];
        int inOffset = outIdx * `+e+`;

        vec4 minMaxValue = vec4(`+a+`);
        float prodValue = 1.0;
        float sumValue = 0.0;
        float allValue = 1.0;
        float anyValue = 0.0;

        for (int i = 0; i < `+c+`; i += 4) {
          int inIdx = inOffset + i;
          `+h+" values = "+h+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            getValue(batch, inIdx + 3)
          );

          `+f+`
        }

        int inIdx = inOffset + `+c+`;
        if (`+(l===1)+`) {
          `+h+" values = "+h+`(
            getValue(batch, inIdx),
            initializationValue,
            initializationValue,
            initializationValue
          );

          `+f+`
        } else if (`+(l===2)+`) {
          `+h+" values = "+h+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            initializationValue,
            initializationValue
          );

          `+f+`
        } else if (`+(l===3)+`) {
          `+h+" values = "+h+`(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            initializationValue
          );

          `+f+`
        }
        setOutput(`+u+`);
      }
    `},Qb=function(i,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=i;for(var e="",n=0;n<4;n++){var r="thisRC = rc;";n%2==1&&(r+="thisRC.z += 1;"),n>1&&(r+="thisRC.y += 1;"),e+=`
        `+r+`
        `+(n>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+`
          int flatIndex = getFlatIndex(thisRC);

          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);
          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));

          result[`+n+`] =
            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);
        `+(n>0?"}":"")+`
      `}this.userCode=`
      
    ivec3 inputCoordsFromReshapedOutCoords(int index) {
      `+rr(["r","c","d"],t)+`
      return ivec3(r, c, d);
    }
  
      `+gc(i)+`

      void main() {
        ivec3 rc = getOutputCoords();

        vec4 result = vec4(0.);

        ivec3 thisRC;
        int rows = `+i[1]+`;
        int cols = `+i[2]+`;

        `+e+`

        setOutput(result);
      }
    `},Zb=function(i,t,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var n=t.shape,r=n[1],o=n[2],a=i.shape,s=a[1],u=a[2],c=[e&&s>1?r-1:r,e&&u>1?o-1:o],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],f=c[0]/l[0],h=c[1]/l[1],p=1/f,d=1/h,m=2*Math.ceil(p)+2,v=2*Math.ceil(d)+2;this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        int r = coords[1];
        int c = coords[2];

        float accumulator = 0.0;

        const float heightScale = float(`+f+`);
        const float widthScale = float(`+h+`);

        const float invHeightScale = float(`+p+`);
        const float invWidthScale = float(`+d+`);

        const int winHeight = int(`+m+`);
        const int winWidth = int(`+v+`);

        // Compute bounds for where in dy we will look
        float startRLerp = floor(float(r) * invHeightScale);
        int startDyR = int(startRLerp - float(winHeight / 2));

        float startCLerp = floor(float(c) * invWidthScale);
        int startDyC = int(startCLerp - float(winWidth / 2));

        // Loop over dy
        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {
          int dyR = dyROffset + startDyR;

          // Guard against the window exceeding the bounds of dy
          if (dyR < 0 || dyR >= `+s+`) {
            continue;
          }

          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {
            int dyC = dyCOffset + startDyC;

            // Guard against the window exceeding the bounds of dy
            if (dyC < 0 || dyC >= `+u+`) {
              continue;
            }

            float dxR = float(dyR) * heightScale;
            int topDxRIndex = int(floor(dxR));
            int bottomDxRIndex = int(min(ceil(dxR), `+(r-1)+`.0));
            float dxRLerp = dxR - float(topDxRIndex);
            float inverseDxRLerp = 1.0 - dxRLerp;

            float dxC = float(dyC) * widthScale;
            int leftDxCIndex = int(floor(dxC));
            int rightDxCIndex = int(min(ceil(dxC), `+(o-1)+`.0));
            float dxCLerp = dxC - float(leftDxCIndex);
            float inverseDxCLerp = 1.0 - dxCLerp;

            if (r == topDxRIndex && c == leftDxCIndex) {
              // topLeft
              accumulator +=
                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;
            }

            if (r == topDxRIndex && c == rightDxCIndex) {
              // topRight
              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;
            }

            if (r == bottomDxRIndex && c == leftDxCIndex) {
              // bottomLeft
              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;
            }

            if (r == bottomDxRIndex && c == rightDxCIndex) {
              // bottomRight
              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;
            }
          }
        }
        // End loop over dy

        setOutput(accumulator);
      }
    `},ew=function(i,t,e,n){this.variableNames=["A"],this.outputShape=[];var r=i[0],o=i[1],a=i[2],s=i[3];this.outputShape=[r,t,e,s];var u=[n&&t>1?o-1:o,n&&e>1?a-1:a],c=[n&&t>1?t-1:t,n&&e>1?e-1:e];this.userCode=`
      const vec2 effectiveInputOverOutputRatioRC = vec2(
          `+u[0]/c[0]+`,
          `+u[1]/c[1]+`);
      const vec2 inputShapeRC = vec2(`+o+".0, "+a+`.0);

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        ivec2 yRC = coords.yz;

        // Fractional source index.
        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;

        // Compute the four integer indices.
        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);
        ivec2 sourceCeilRC = ivec2(
          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));

        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);
        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);
        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);
        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);

        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);

        float top = topLeft + (topRight - topLeft) * fracRC.y;
        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;
        float newValue = top + (bottom - top) * fracRC.x;

        setOutput(newValue);
      }
    `},tw=function(i,t,e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var r=i[0],o=i[1],a=i[2],s=i[3];this.outputShape=[r,t,e,s];var u=[n&&t>1?o-1:o,n&&e>1?a-1:a],c=[n&&t>1?t-1:t,n&&e>1?e-1:e];this.userCode=`
      const vec3 effectiveInputOverOutputRatioRC = vec3(
          `+u[0]/c[0]+`,
          `+u[1]/c[1]+`,
          `+u[1]/c[1]+`);
      const vec3 inputShapeRC = vec3(`+o+".0, "+a+`.0,
                                     `+a+`.0);

      float getAValue(int b, int r, int c, int d) {
        return getChannel(getA(b, r, c, d), vec2(c, d));
      }

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        // Calculate values for next column in yRC.z.
        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);

        // Fractional source index.
        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;

        // Compute the four integer indices.
        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);
        ivec3 sourceCeilRC = ivec3(
          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));

        // Should we calculate next column and row elements in 2x2 packed cell.
        bool hasNextCol = d < `+(s-1)+`;
        bool hasNextRow = coords.z < `+(e-1)+`;

        // In parallel, construct four corners for all four components in
        // packed 2x2 cell.
        vec4 topLeft = vec4(
          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),
          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);

        vec4 bottomLeft = vec4(
          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),
          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);

        vec4 topRight = vec4(
          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),
          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);

        vec4 bottomRight = vec4(
          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),
          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)
                     : 0.0,
          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)
                     : 0.0,
          (hasNextRow && hasNextCol) ?
            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);

        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);

        vec4 top = mix(topLeft, topRight, fracRC.yyzz);
        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);
        vec4 newValue = mix(top, bottom, fracRC.x);

        setOutput(newValue);
      }
    `},nw=function(i,t,e){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t.shape;var n=t.shape,r=n[1],o=n[2],a=i.shape,s=a[1],u=a[2],c=[e&&s>1?r-1:r,e&&u>1?o-1:o],l=[e&&s>1?s-1:s,e&&u>1?u-1:u],f=c[0]/l[0],h=c[1]/l[1],p=1/f,d=1/h,m=2*Math.ceil(p)+2,v=2*Math.ceil(d)+2;this.userCode=`
      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        int r = coords[1];
        int c = coords[2];

        float accumulator = 0.0;

        const float heightScale = float(`+f+`);
        const float widthScale = float(`+h+`);

        const float invHeightScale = float(`+p+`);
        const float invWidthScale = float(`+d+`);

        const int winHeight = int(`+m+`);
        const int winWidth = int(`+v+`);

        // Compute bounds for where in dy we will look
        float startRLerp = floor(float(r) * invHeightScale);
        int startDyR = int(floor(startRLerp - float(winHeight / 2)));

        float startCLerp = floor(float(c) * invWidthScale);
        int startDyC = int(floor(startCLerp - float(winWidth / 2)));

        // Loop over dy
        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {
          int dyR = dyROffset + startDyR;

          // Guard against the window exceeding the bounds of dy
          if (dyR < 0 || dyR >= `+s+`) {
            continue;
          }

          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {
            int dyC = dyCOffset + startDyC;

            // Guard against the window exceeding the bounds of dy
            if (dyC < 0 || dyC >= `+u+`) {
              continue;
            }

            float sourceFracRow =
              float(`+c[0]+`) *
                (float(dyR) / float(`+l[0]+`));

            float sourceFracCol =
                float(`+c[1]+`) *
                  (float(dyC) / float(`+l[1]+`));

            int sourceNearestRow = int(min(
                float(int(`+r+`) - 1),
                `+e+` ? float(round(sourceFracRow)) :
                                  float(floor(sourceFracRow))));

            int sourceNearestCol = int(min(
                float(int(`+o+`) - 1),
                `+e+` ? float(round(sourceFracCol)) :
                                  float(floor(sourceFracCol))));

            if (r == sourceNearestRow && c == sourceNearestCol) {
              accumulator += getDy(b, dyR, dyC, d);
            }
          }
        }
        // End loop over dy

        setOutput(accumulator);
      }
    `},rw=function(i,t,e,n){this.variableNames=["A"],this.outputShape=[];var r=i[0],o=i[1],a=i[2],s=i[3];this.outputShape=[r,t,e,s];var u=[n&&t>1?o-1:o,n&&e>1?a-1:a],c=[n&&t>1?t-1:t,n&&e>1?e-1:e],l=n?"0.5":"0.0";this.userCode=`
      const vec2 effectiveInputOverOutputRatioRC = vec2(
          `+u[0]/c[0]+`,
          `+u[1]/c[1]+`);
      const vec2 inputShapeRC = vec2(`+o+".0, "+a+`.0);

      void main() {
        ivec4 coords = getOutputCoords();
        int b = coords[0];
        int d = coords[3];
        ivec2 yRC = coords.yz;

        // Fractional source index.
        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;

        // Compute the coordinators of nearest neighbor point.
        ivec2 sourceNearestRC = ivec2(
          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + `+l+`)));

        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);

        setOutput(newValue);
      }
    `},iw=function(i,t){this.variableNames=["x"];var e=i.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");if(this.outputShape=i,e!==1){var n=i.map(function(o,a){return function(s){return t.indexOf(s)!==-1&&i[s]!==1?i[s]+" - coords["+s+"] - 1":"coords["+s+"]"}(a)}).join(","),r=We(e);this.userCode=`
      void main() {
        `+r+` coords = getOutputCoords();
        setOutput(getX(`+n+`));
      }
    `}else this.userCode=`
        void main() {
          int coord = getOutputCoords();
          setOutput(getX(`+i[0]+` - coord - 1));
        }
      `},ow=function(i,t){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var e=i.length;if(e>4)throw new Error("WebGL backend: Reverse of rank-"+e+" tensor is not yet supported");this.outputShape=i;var n=Tt("rc",e),r=n[e-1]+" + 1 < "+this.outputShape[e-1],o=n[e-2]+" + 1 < "+this.outputShape[e-2],a=We(e);function s(u){var c=i.map(function(l,f){return function(h,p){return t.indexOf(h)!==-1&&i[h]!==1?i[h]+" - "+p[h]+" - 1":""+p[h]}(f,u)});return"getChannel(getX("+c.join(",")+"), vec2("+c.slice(-2).join(",")+"))"}this.userCode=e===1?`
        void main(){
          int rc = getOutputCoords();
          vec4 result = vec4(0.);
          result.r = getChannel(getX(`+i[0]+` - rc - 1),
            `+i[0]+` - rc - 1);
          if(`+r+`){
              result.g = getChannel(getX(`+i[0]+` - (rc  + 1) - 1),
                `+i[0]+` - (rc  + 1) - 1);
          }
          setOutput(result);
        }
      `:`
        void main() {
          `+a+` rc = getOutputCoords();
          vec4 result = vec4(0.);
          result.r = `+function(u){return s(u)}(n.slice())+`;
          if(`+r+`){
            result.g = `+function(u){return u[e-1]="("+u[e-1]+" + 1)",s(u)}(n.slice())+`;
          }
          if(`+o+`) {
            result.b = `+function(u){return u[e-2]="("+u[e-2]+" + 1)",s(u)}(n.slice())+`;
            if(`+r+`) {
              result.a = `+function(u){return u[e-1]="("+u[e-1]+" + 1)",u[e-2]="("+u[e-2]+" + 1)",s(u)}(n.slice())+`;
            }
          }
          setOutput(result);
        }
    `},mp=function(i,t,e,n,r,o,a){a===void 0&&(a=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=o;var s=We(r.length),u=We(o.length),c="";e===1?c="i":e===2&&(c="i, j");var l="getIndices("+c+")",f="";n===1?f="i":n===2&&(f="i, coords[1]");var h="getUpdates("+f+")",p=t>1?"strides[j]":"strides";this.userCode=`
        `+s+" strides = "+s+"("+r+`);

        void main() {
          `+u+` coords = getOutputCoords();
          float sum = 0.0;
          bool found = false;
          for (int i = 0; i < `+i+`; i++) {
            int flattenedIndex = 0;
            for (int j = 0; j < `+t+`; j++) {
              int index = round(`+l+`);
              flattenedIndex += index * `+p+`;
            }
            if (flattenedIndex == coords[0]) {
              sum += `+h+`;
              found = true;
            }
          }
          setOutput(mix(getDefaultValue(), sum, float(found)));
        }
      `},aw=function(i,t){this.variableNames=["x","segmentIds"];var e=i.windowSize,n=i.batchSize,r=i.inSize,o=i.numSegments,a=o*Math.ceil(r/e);this.outputShape=[n,a];var s=4*Math.floor(e/4),u=e%4,c=`
        sumValue += dot(values, segFilter);
    `,l="";r%e>0&&(l=`
        if (inIdx < 0 || inIdx >= `+r+`) {
          return initializationValue;
        }
      `);var f="";r%e>0&&(f=`
        if (inIdx < 0 || inIdx >= `+r+`) {
          return -1.0;
        }
      `),this.userCode=`
      const float initializationValue = 0.0;

      float getValue(int batch, int inIdx) {
        `+l+`
        return getX(batch, inIdx);
      }

      float getSegmentIdAtIndex(int inIdx) {
        `+f+`
        return getSegmentIds(inIdx);
      }

      void main() {
        ivec2 coords = getOutputCoords();
        int batch = coords[0];
        int outIdx = coords[1];
        int inOffset = int(floor(float(outIdx) / float(
          `+o+")) * float("+e+`));
        int currentSeg = int(mod(float(outIdx), float(`+o+`)));

        float sumValue = 0.0;

        for (int i = 0; i < `+s+`; i += 4) {
          int inIdx = inOffset + i;
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            getValue(batch, inIdx + 3)
          );

          vec4 segFilter = vec4(
            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0
          );

          `+c+`
        }

        int inIdx = inOffset + `+s+`;
        if (`+(u===1)+`) {
          vec4 values = vec4(
            getValue(batch, inIdx),
            initializationValue,
            initializationValue,
            initializationValue
          );

          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));

          vec4 segFilter = vec4(
            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,
            0,
            0,
            0
          );

          `+c+`
        } else if (`+(u===2)+`) {
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            initializationValue,
            initializationValue
          );

          vec4 segFilter = vec4(
            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,
              0,
              0
          );

          `+c+`
        } else if (`+(u===3)+`) {
          vec4 values = vec4(
            getValue(batch, inIdx),
            getValue(batch, inIdx + 1),
            getValue(batch, inIdx + 2),
            initializationValue
          );

          vec4 segFilter = vec4(
            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,
            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,
            0
          );

          `+c+`
        }
        setOutput(sumValue);
      }
    `},sw=function(i,t,e){var n,r;if(this.variableNames=["c","a","b"],this.outputShape=t,e>4)throw Error("Where for rank "+e+" is not yet supported");if(e===1)r="resRC",n="resRC";else{for(var o=["resRC.x","resRC.y","resRC.z","resRC.w"],a=[],s=[],u=0;u<t.length;u++)s.push(""+o[u]),u<i&&a.push(""+o[u]);n=a.join(),r=s.join()}var c=We(e);this.userCode=`
      void main() {
        `+c+` resRC = getOutputCoords();
        float cVal = getC(`+n+`);
        if (cVal >= 1.0) {
          setOutput(getA(`+r+`));
        } else {
          setOutput(getB(`+r+`));
        }
      }
    `},uw=function(){function i(t){this.variableNames=["source"],this.outputShape=t,this.rank=t.length;var e,n=We(this.rank),r="uniform int start["+this.rank+"];",o=function(a){if(a===1)return"sourceLoc";if(a<=6)return yu.slice(0,a).map(function(s){return"sourceLoc."+s}).join(",");throw Error("Slicing for rank "+a+" is not yet supported")}(this.rank);e=`
        `+n+` sourceLoc;
        `+n+` coords = getOutputCoords();
        `+t.map(function(a,s){return"sourceLoc."+yu[s]+" = start["+s+"] + coords."+yu[s]+";"}).join(`
`)+`
      `,this.userCode=`
      `+r+`
      void main() {
        `+e+`
        setOutput(getSource(`+o+`));
      }
    `}return i.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,r){e.startLoc==null&&(e.startLoc=n.getUniformLocationNoThrow(r,"start"),e.startLoc==null)||n.gl.uniform1iv(e.startLoc,t)}},i}(),yu=["x","y","z","w","u","v"],cw=function(){function i(t){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t,this.rank=t.length;var e=We(this.rank),n=Tt("coords",this.rank),r=Tt("sourceLoc",this.rank),o=this.rank===1?"sourceLoc":"vec2("+r.slice(-2).join()+")",a="getChannel(getSource("+r.join()+"), "+o+")",s=`
      result.x = `+a+`;
      if (++`+n[this.rank-1]+" < "+t[this.rank-1]+`) {
        ++`+r[this.rank-1]+`;
        result.y = `+a+`;
        --`+r[this.rank-1]+`;
      }
    `,u=this.rank===1?"":`
      --`+n[this.rank-1]+`;
      if (++`+n[this.rank-2]+" < "+t[this.rank-2]+`) {
        ++`+r[this.rank-2]+`;
        result.z = `+a+`;
        if (++`+n[this.rank-1]+" < "+t[this.rank-1]+`) {
          ++`+r[this.rank-1]+`;
          result.w = `+a+`;
        }
      }
    `,c=this.rank<=4?`sourceLoc = coords +
            `+e+"("+t.map(function(l,f){return"start["+f+"]"}).join()+");":t.map(function(l,f){return r[f]+" = "+n[f]+" + start["+f+"];"}).join(`
`);this.userCode=`
      uniform int start[`+this.rank+`];
      void main() {
        `+e+` coords = getOutputCoords();
        `+e+` sourceLoc;
        `+c+`
        vec4 result = vec4(0.);
        `+s+`
        `+u+`
        setOutput(result);
      }
    `}return i.prototype.getCustomSetupFunc=function(t){var e=this;if(t.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+t.length+")");return function(n,r){e.startLoc==null&&(e.startLoc=n.getUniformLocationNoThrow(r,"start"),e.startLoc==null)||n.gl.uniform1iv(e.startLoc,t)}},i}(),lw=function(i,t,e){this.variableNames=["x"],this.outputShape=e;var n=e.length,r=We(e.length),o=We(e.length),a="";if(n===1)a="coords * strides + begin";else{var s=0;a=e.map(function(u,c){return s++,e.length===1?"coords * strides["+c+"] + begin["+c+"]":"coords["+(s-1)+"] * strides["+c+"] + begin["+c+"]"}).join(",")}this.userCode=`
      `+r+" begin = "+r+"("+i+`);
      `+r+" strides = "+r+"("+t+`);

      void main() {
        `+o+` coords = getOutputCoords();
        setOutput(getX(`+a+`));
      }
    `},fw=function(){function i(t){this.gpgpu=t,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return i.prototype.acquireTexture=function(t,e,n){var r,o=vp(e,n),a=gp(t,o,n);if(a in this.freeTextures||(this.freeTextures[a]=[]),a in this.usedTextures||(this.usedTextures[a]=[]),this.freeTextures[a].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var s=this.freeTextures[a].shift();return this.usedTextures[a].push(s),s}return this.numUsedTextures++,this.log(),o===Bt.PACKED_2X2_FLOAT32?r=this.gpgpu.createPackedMatrixTexture(t[0],t[1]):o===Bt.PACKED_2X2_FLOAT16?r=this.gpgpu.createFloat16PackedMatrixTexture(t[0],t[1]):o===Bt.UNPACKED_FLOAT32?r=this.gpgpu.createFloat32MatrixTexture(t[0],t[1]):o===Bt.UNPACKED_FLOAT16?r=this.gpgpu.createFloat16MatrixTexture(t[0],t[1]):o===Bt.PACKED_4X1_UNSIGNED_BYTE&&(r=this.gpgpu.createUnsignedBytesMatrixTexture(t[0],t[1])),this.usedTextures[a].push(r),r},i.prototype.releaseTexture=function(t,e,n,r){if(this.freeTextures!=null){var o=gp(e,vp(n,r),r);o in this.freeTextures||(this.freeTextures[o]=[]),this.freeTextures[o].push(t),this.numFreeTextures++,this.numUsedTextures--;var a=this.usedTextures[o],s=a.indexOf(t);if(s<0)throw new Error("Cannot release a texture that was never provided by this texture manager");a.splice(s,1),this.log()}},i.prototype.log=function(){if(this.logEnabled){var t=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+t+")")}},i.prototype.getNumUsedTextures=function(){return this.numUsedTextures},i.prototype.getNumFreeTextures=function(){return this.numFreeTextures},i.prototype.dispose=function(){var t=this;if(this.freeTextures!=null){for(var e in this.freeTextures)this.freeTextures[e].forEach(function(n){t.gpgpu.deleteMatrixTexture(n)});for(var e in this.usedTextures)this.usedTextures[e].forEach(function(r){t.gpgpu.deleteMatrixTexture(r)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},i}();function vp(i,t){if(i===Lt.UPLOAD)return Bt.PACKED_2X2_FLOAT32;if(i===Lt.RENDER||i==null)return function(e){return O().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?e?Bt.PACKED_2X2_FLOAT32:Bt.UNPACKED_FLOAT32:e?Bt.PACKED_2X2_FLOAT16:Bt.UNPACKED_FLOAT16}(t);if(i===Lt.DOWNLOAD||i===Lt.PIXELS)return Bt.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+i)}function gp(i,t,e){return i[0]+"_"+i[1]+"_"+t+"_"+e}var hw=function(i,t){this.variableNames=["A"];for(var e=new Array(i.length),n=0;n<e.length;n++)e[n]=i[n]*t[n];this.outputShape=e,this.rank=e.length;var r=We(this.rank),o=function(a){var s=a.length;if(s>5)throw Error("Tile for rank "+s+" is not yet supported");if(s===1)return"imod(resRC, "+a[0]+")";for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],c=[],l=0;l<a.length;l++)c.push("imod("+u[l]+", "+a[l]+")");return c.join()}(i);this.userCode=`
      void main() {
        `+r+` resRC = getOutputCoords();
        setOutput(getA(`+o+`));
      }
    `},pw=function(i,t){this.variableNames=["A"];for(var e=new Array(i.length),n=0;n<e.length;n++)e[n]=i[t[n]];this.outputShape=e,this.rank=e.length;var r=We(this.rank),o=function(a){var s=a.length;if(s>6)throw Error("Transpose for rank "+s+" is not yet supported");for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],c=new Array(s),l=0;l<a.length;l++)c[a[l]]=u[l];return c.join()}(t);this.userCode=`
    void main() {
      `+r+` resRC = getOutputCoords();
      setOutput(getA(`+o+`));
    }
    `},dw=function(i,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var e=new Array(i.length),n=0;n<e.length;n++)e[n]=i[t[n]];if(this.outputShape=e,this.rank=e.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var r=We(this.rank),o=$d("rc",this.rank),a=new Array(this.rank);for(n=0;n<t.length;n++)a[t[n]]=o[n];var s="vec2("+a.slice(-2).join()+")",u="++"+o[this.rank-1]+" < "+e[this.rank-1],c="getChannel(getA("+a.join()+"), "+s+")";this.userCode=`
    void main() {
      `+r+` rc = getOutputCoords();
      vec4 result = vec4(0.);
      result[0] = `+c+`;
      if(`+u+`) {
        result[1] = `+c+`;
      }
      --`+o[this.rank-1]+`;
      if(++`+o[this.rank-2]+" < "+e[this.rank-2]+`) {
        result[2] = `+c+`;
        if(`+u+`) {
          result[3] = `+c+`;
        }
      }
      setOutput(result);
    }
    `},yc=1.7580993408473768,xc=1.0507009873554805,fe=function(i,t){this.variableNames=["A"],this.outputShape=i,this.userCode=`
      float unaryOperation(float x) {
        `+t+`
      }

      void main() {
        float x = getAAtOutCoords();
        float y = unaryOperation(x);

        setOutput(y);
      }
    `},tn="if (isnan(x)) return x;",mw="return x;",yp="return abs(x);",gm=tn+`
  return (x < 0.0) ? 0.0 : x;
`,ym=tn+`
  return (x < 0.0) ? 0.0 : min(6.0, x);
`,xm="return (x >= 0.0) ? x : (exp(x) - 1.0);",vw=`
  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.
  // see: https://arxiv.org/abs/1706.02515
  float scaleAlpha = `+yc+`;
  float scale = `+xc+`;
  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);
`,xp="return -x;",bp="return ceil(x);",wp="return floor(x);",Cp="return exp(x);",_p="return exp(x) - 1.0;",gw=tn+`
  return sin(x);
`,yw=tn+`
  return cos(x);
`,xw=tn+`
  if (abs(x) > 1.) {
    return NAN;
  }
  return asin(x);
`,bw=tn+`
  if (abs(x) > 1.) {
    return NAN;
  }
  return acos(x);
`,ww=tn+`
  return atan(x);
`,Cw=tn+"return log(x + sqrt(x * x + 1.0));",_w=tn+`
  if (x < 1.0) return NAN;
  return log(x + sqrt(x * x - 1.0));`,Ew=tn+`
  if ((x < -1.0) || (x > 1.0)) return NAN;
  return (log(1.0 + x) - log(1.0 - x)) / 2.0;`,_o="return x;",kw="return x;",bm=`
  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,wm=`
  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));
  bvec4 isNaN = isnan(x);

  result.r = isNaN.r ? x.r : result.r;
  result.g = isNaN.g ? x.g : result.g;
  result.b = isNaN.b ? x.b : result.b;
  result.a = isNaN.a ? x.a : result.a;

  return result;
`,Cm=`
  vec4 result;

  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);
  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);
  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);
  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);

  return result;
`,xi=function(i,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=i,this.userCode=`
      vec4 unaryOperation(vec4 x) {
        `+t+`
      }

      void main() {
        vec4 x = getAAtOutCoords();
        vec4 y = unaryOperation(x);

        setOutput(y);
      }
    `},Dw=function(i){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=i;var t=i.length,e=Tt("rc",t),n=We(t),r=function(s,u){if(s===1)return"rc";for(var c="",l=0;l<s;l++)c+=u[l],l<s-1&&(c+=",");return c}(t,e),o=e.slice(-2),a=t<=1?"rc":"vec2("+o.join(",")+")";this.userCode=`
      void main() {
        `+n+` rc = getOutputCoords();
        vec4 packedInput = getA(`+r+`);

        setOutput(getChannel(packedInput, `+a+`));
      }
    `},Eo={};function ko(i,t){if(t===void 0&&(t=!1),i==="linear")return t?kw:mw;if(i==="relu")return t?bm:gm;if(i==="elu")return t?Cm:xm;if(i==="relu6")return t?wm:ym;if(i==="prelu")return t?Zd:Qd;throw new Error("Activation "+i+" has not been implemented for the WebGL backend.")}var Sw=600,_m=function(i){function t(e){var n,r=i.call(this)||this;if(r.pendingRead=new WeakMap,r.pendingDisposal=new WeakSet,r.dataRefCount=new WeakMap,r.numBytesInGPU=0,r.uploadWaitMs=0,r.downloadWaitMs=0,r.warnedAboutMemory=!1,r.pendingDeletes=0,r.disposed=!1,!O().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(e==null){var o=dn(O().getNumber("WEBGL_VERSION"));r.binaryCache=((n=O().getNumber("WEBGL_VERSION"))in Eo||(Eo[n]={}),Eo[n]),r.gpgpu=new vm(o),r.canvas=o.canvas,r.gpgpuCreatedLocally=!0}else r.gpgpu=e,r.binaryCache={},r.gpgpuCreatedLocally=!1,r.canvas=e.gl.canvas;return r.textureManager=new fw(r.gpgpu),r.numMBBeforeWarning=O().global.screen==null?1024:O().global.screen.height*O().global.screen.width*window.devicePixelRatio*Sw/1024/1024,r.texData=new Ud(r,R),r}return Qt(t,i),t.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},t.prototype.write=function(e,n,r){if(O().getBool("DEBUG")&&this.checkNumericalProblems(e),r==="complex64"&&e!=null)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var o={};return this.texData.set(o,{shape:n,dtype:r,values:e,usage:Lt.UPLOAD}),o},t.prototype.move=function(e,n,r,o){if(O().getBool("DEBUG")&&this.checkNumericalProblems(n),o==="complex64")throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:r,dtype:o,values:n,usage:Lt.UPLOAD})},t.prototype.readSync=function(e){var n=this.texData.get(e),r=n.values,o=n.dtype,a=n.complexTensors,s=n.slice,u=n.shape,c=n.isPacked;if(s!=null){var l=void 0;l=c?new xi(u,_o):new fe(u,_o);var f=this.runWebGLProgram(l,[{dataId:e,shape:u,dtype:o}],o),h=this.readSync(f.dataId);return this.disposeData(f.dataId),h}if(r!=null)return this.convertAndCacheOnCPU(e);if(o==="string")return r;var p,d,m=this.activeTimers!=null;return m&&(p=$t()),o==="complex64"?d=Gu(a.real.dataSync(),a.imag.dataSync()):d=this.getValuesFromTexture(e),m&&(this.downloadWaitMs+=$t()-p),this.convertAndCacheOnCPU(e,d)},t.prototype.read=function(e){return te(this,void 0,void 0,function(){var n,r,o,a,s,u,c,l,f,h,p,d,m,v,g,x,w,y,b,C,S,A;return ne(this,function(k){switch(k.label){case 0:if(this.pendingRead.has(e))return n=this.pendingRead.get(e),[2,new Promise(function(D){return n.push(D)})];if(r=this.texData.get(e),o=r.values,a=r.shape,s=r.slice,u=r.dtype,c=r.complexTensors,l=r.isPacked,s!=null)return f=void 0,f=l?new xi(a,_o):new fe(a,_o),h=this.runWebGLProgram(f,[{dataId:e,shape:a,dtype:u}],u),p=this.read(h.dataId),this.disposeData(h.dataId),[2,p];if(o!=null)return[2,this.convertAndCacheOnCPU(e)];if(!O().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&O().getNumber("WEBGL_VERSION")===2)throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return d=null,u!=="complex64"&&O().get("WEBGL_BUFFER_SUPPORTED")&&(m=this.decode(e),v=this.texData.get(m.dataId),d=(A=this.gpgpu).createBufferFromTexture.apply(A,[v.texture].concat(_i(a)))),this.pendingRead.set(e,[]),u==="complex64"?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:k.sent(),k.label=2;case 2:return u!=="complex64"?[3,4]:[4,Promise.all([c.real.data(),c.imag.data()])];case 3:return x=k.sent(),w=x[0],y=x[1],g=Gu(w,y),[3,5];case 4:d==null?g=this.getValuesFromTexture(e):(b=re(a),g=this.gpgpu.downloadFloat32MatrixFromBuffer(d,b)),k.label=5;case 5:return m!=null&&this.disposeData(m.dataId),C=this.convertAndCacheOnCPU(e,g),S=this.pendingRead.get(e),this.pendingRead.delete(e),S.forEach(function(D){return D(C)}),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e),this.pendingDeletes--),[2,C]}})})},t.prototype.checkNumericalProblems=function(e){if(e!=null)for(var n=0;n<e.length;n++){var r=e[n];if(!rd(r))throw O().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error("The value "+r+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'"):Error("The value "+r+" cannot be represented on this device.")}},t.prototype.getValuesFromTexture=function(e){var n,r=this.texData.get(e),o=r.shape,a=r.dtype,s=r.isPacked,u=re(o);if(O().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var c=this.decode(e),l=this.texData.get(c.dataId),f=(n=this.gpgpu).downloadMatrixFromPackedTexture.apply(n,[l.texture].concat(_i(o))).subarray(0,u);return this.disposeData(c.dataId),f}var h=O().getBool("WEBGL_PACK")&&s===!0,p=h?Po(o):o,d=h?new Ib(p):new Rb(p),m=this.runWebGLProgram(d,[{shape:p,dtype:a,dataId:e}],"float32"),v=this.texData.get(m.dataId),g=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(v.texture,v.texShape[0],v.texShape[1]).subarray(0,u);return this.disposeData(m.dataId),g},t.prototype.time=function(e){return te(this,void 0,void 0,function(){var n,r,o,a,s,u,c;return ne(this,function(l){switch(l.label){case 0:return n=this.activeTimers,r=[],o=!1,this.programTimersStack==null?(this.programTimersStack=r,o=!0):this.activeTimers.push(r),this.activeTimers=r,e(),a=Dn(this.activeTimers.map(function(f){return f.query})).filter(function(f){return f!=null}),s=Dn(this.activeTimers.map(function(f){return f.name})).filter(function(f){return f!=null}),this.activeTimers=n,o&&(this.programTimersStack=null),u={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[4,Promise.all(a)]:[3,2];case 1:return c=l.sent(),u.kernelMs=qp(c),u.getExtraProfileInfo=function(){return c.map(function(f,h){return{name:s[h],ms:f}}).map(function(f){return f.name+": "+f.ms}).join(", ")},[3,3];case 2:u.kernelMs={error:"WebGL query timers are not supported in this environment."},l.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,u]}})})},t.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},t.prototype.startTimer=function(){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:$t(),endMs:null}},t.prototype.endTimer=function(e){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),e):(e.endMs=$t(),e)},t.prototype.getQueryTime=function(e){return te(this,void 0,void 0,function(){var n;return ne(this,function(r){return O().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[2,this.gpgpu.waitForQueryAndGetTime(e)]:[2,(n=e).endMs-n.startMs]})})},t.prototype.disposeData=function(e){if(!this.pendingDisposal.has(e)){if(this.pendingRead.has(e))return this.pendingDisposal.add(e),void this.pendingDeletes++;if(this.texData.has(e)){this.releaseGPUData(e);var n=this.texData.get(e).complexTensors;n!=null&&(n.real.dispose(),n.imag.dispose()),this.texData.delete(e)}}},t.prototype.releaseGPUData=function(e){var n=this.texData.get(e),r=n.texture,o=n.dtype,a=n.texShape,s=n.usage,u=n.isPacked,c=n.slice,l=c&&c.origDataId||e,f=this.dataRefCount.get(l);f>1?this.dataRefCount.set(l,f-1):(this.dataRefCount.delete(l),r!=null&&(this.numBytesInGPU-=this.computeBytes(a,o),this.textureManager.releaseTexture(r,a,s,u)));var h=this.texData.get(e);h.texture=null,h.texShape=null,h.isPacked=!1,h.slice=null},t.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},t.prototype.getDataInfo=function(e){return this.texData.get(e)},t.prototype.getCPUBackend=function(){return O().getBool("WEBGL_CPU_FORWARD")?(this.cpuBackend==null&&(this.cpuBackend=R.findBackend("cpu")),this.cpuBackend):null},t.prototype.shouldExecuteOnCPU=function(e,n){var r=this;return n===void 0&&(n=128),this.getCPUBackend()!=null&&e.every(function(o){return r.texData.get(o.dataId).texture==null&&o.size<n})},t.prototype.getGPGPUContext=function(){return this.gpgpu},t.prototype.complex=function(e,n){var r=this.makeOutput(e.shape,"complex64");return this.texData.get(r.dataId).complexTensors={real:R.keep(e.clone()),imag:R.keep(n.clone())},r},t.prototype.real=function(e){return this.texData.get(e.dataId).complexTensors.real.clone()},t.prototype.imag=function(e){return this.texData.get(e.dataId).complexTensors.imag.clone()},t.prototype.slice=function(e,n,r){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,n,r);if(re(r)===0)return st([],r,e.dtype);var o=this.texData.get(e.dataId).isPacked,a=cc(e.shape,n,r);if(o||!a){var s=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new cw(r):new uw(r),u=s.getCustomSetupFunc(n);return this.compileAndRun(s,[e],null,u)}return this.uploadToGPU(e.dataId),this.shallowSlice(e,n,r)},t.prototype.shallowSlice=function(e,n,r){var o=this.texData.get(e.dataId),a=this.makeOutput(r,e.dtype),s=this.texData.get(a.dataId);Object.assign(s,o),s.shape=r,s.dtype=e.dtype;var u=lc(n,e.strides);o.slice&&(u+=o.slice.flatOffset),s.slice={flatOffset:u,origDataId:o.slice&&o.slice.origDataId||e.dataId};var c=this.dataRefCount.get(s.slice.origDataId)||1;return this.dataRefCount.set(s.slice.origDataId,c+1),a},t.prototype.stridedSlice=function(e,n,r,o){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.stridedSlice(e,n,r,o);var a=ra(n,r,o);if(a.some(function(u){return u===0}))return st([],a);var s=new lw(n,o,a);return this.compileAndRun(s,[e])},t.prototype.reverse=function(e,n){var r=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new ow(e.shape,n):new iw(e.shape,n);return this.compileAndRun(r,[e])},t.prototype.concat=function(e,n){if(e[0].dtype==="complex64"){var r=e.map(function(p){return Vt(p)}),o=e.map(function(p){return fn(p)});return ht(this.concat(r,n),this.concat(o,n))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,n);if(e.length===1)return e[0];if(e.length>O().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var a=Math.floor(e.length/2),s=this.concat(e.slice(0,a),n),u=this.concat(e.slice(a),n);return this.concat([s,u],n)}if(O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&e[0].rank>1){var c=new vb(e.map(function(p){return p.shape}),n);return this.compileAndRun(c,e)}var l=ur(e.map(function(p){return p.shape}),n),f=e.map(function(p){return p.as2D(-1,re(p.shape.slice(n)))}),h=new mb(f.map(function(p){return p.shape}));return this.compileAndRun(h,f).reshape(l)},t.prototype.neg=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.neg(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,xp,e.dtype);var n=new fe(e.shape,xp);return this.compileAndRun(n,[e])},t.prototype.batchMatMul=function(e,n,r,o){var a=r?e.shape[2]:e.shape[1],s=o?n.shape[1]:n.shape[2],u=r?e.shape[1]:e.shape[2],c=e.shape[0];if((a===1||s===1)&&u>1e3){r&&(e=e.transpose([0,2,1])),o&&(n=n.transpose([0,2,1]));var l=s===1?e:e.as3D(c,u,1),f=s===1?2:1,h=s===1?n.as3D(c,1,u):n;return this.multiply(l,h).sum(f,!0)}var p=at(e.dtype,n.dtype),d=new mu(e.shape,[c,a,s],r,o);return this.compileAndRun(d,[e,n],p)},t.prototype.fusedBatchMatMul=function(e){var n=e.a,r=e.b,o=e.transposeA,a=e.transposeB,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=o?n.shape[2]:n.shape[1],f=a?r.shape[1]:r.shape[2],h=n.shape[0],p=at(n.dtype,r.dtype),d=s!=null,m=c!=null,v=u?ko(u,!0):null,g=new mu(n.shape,[h,l,f],o,a,d,v,m),x=[n,r];return s&&x.push(s),c&&x.push(c),this.compileAndRun(g,x,p)},t.prototype.multiply=function(e,n){if(e.dtype==="complex64"){var r=this.texData.get(e.dataId),o=this.texData.get(n.dataId),a=new sp(lb,e.shape,n.shape),s=new sp(fb,e.shape,n.shape),u=[this.makeComplexComponentTensorInfo(e,r.complexTensors.real),this.makeComplexComponentTensorInfo(e,r.complexTensors.imag),this.makeComplexComponentTensorInfo(n,o.complexTensors.real),this.makeComplexComponentTensorInfo(n,o.complexTensors.imag)],c=this.compileAndRun(a,u),l=this.compileAndRun(s,u),f=this.complex(c,l);return c.dispose(),l.dispose(),f}if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.multiply(e,n);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,up,e.dtype);var h=new Xe(up,e.shape,n.shape);return this.compileAndRun(h,[e,n],e.dtype)},t.prototype.batchNormalization=function(e,n,r,o,a,s){var u=[e,n,r],c=null;s!=null&&(c=s.shape,u.push(s));var l=null;if(a!=null&&(l=a.shape,u.push(a)),O().getBool("WEBGL_PACK_NORMALIZATION")){var f=new cb(e.shape,n.shape,r.shape,c,l,o);return this.compileAndRun(f,u)}var h=new ub(e.shape,n.shape,r.shape,c,l,o);return this.compileAndRun(h,u)},t.prototype.localResponseNormalization4D=function(e,n,r,o,a){var s=O().getBool("WEBGL_PACK_NORMALIZATION")?new Ub(e.shape,n,r,o,a):new qb(e.shape,n,r,o,a);return this.compileAndRun(s,[e])},t.prototype.LRNGrad=function(e,n,r,o,a,s,u){var c=new Vb(n.shape,o,a,s,u);return this.compileAndRun(c,[n,r,e])},t.prototype.tile=function(e,n){if(e.dtype==="string"){var r=this.readSync(e.dataId).map(function(a){return Di(a)});return Kd(le(e.shape,e.dtype,r),n)}var o=new hw(e.shape,n);return this.compileAndRun(o,[e])},t.prototype.pad=function(e,n,r){var o=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new Yb(e.shape,n,r):new $b(e.shape,n,r);return this.compileAndRun(o,[e])},t.prototype.transpose=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,n);var r=O().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new dw(e.shape,n):new pw(e.shape,n);return this.compileAndRun(r,[e])},t.prototype.gather=function(e,n,r){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.gather(e,n,r);var o=new Bb(e.shape,n.size,r);return this.compileAndRun(o,[e,n])},t.prototype.batchToSpaceND=function(e,n,r){E(e.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var o=n.reduce(function(f,h){return f*h}),a=Go(e.shape,n,o),s=Ho(a.length,n.length),u=Ko(e.shape,n,o),c=Od(r,n.length),l=Bd(u,r,n.length);return e.reshape(a).transpose(s).reshape(u).slice(c,l)},t.prototype.spaceToBatchND=function(e,n,r){E(e.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var o=n.reduce(function(h,p){return h*p}),a=[[0,0]];a.push.apply(a,r);for(var s=1+n.length;s<e.shape.length;++s)a.push([0,0]);var u=e.pad(a),c=Go(u.shape,n,o,!1),l=Ho(c.length,n.length,!1),f=Ko(u.shape,n,o,!1);return u.reshape(c).transpose(l).reshape(f)},t.prototype.reduce=function(e,n,r){var o=e.shape[0],a=e.shape[1],s=Mo(a),u=new Jb({windowSize:s,inSize:a,batchSize:o},n),c=this.compileAndRun(u,[e],r);return c.shape[1]===1?c:this.reduce(c,n,r)},t.prototype.argReduce=function(e,n,r){r===void 0&&(r=null);var o=e.shape[0],a=e.shape[1];r!=null&&(o=r.shape[0],a=r.shape[1]);var s=Mo(a),u=new Zx({windowSize:s,inSize:a,batchSize:o},n,r==null),c=[e];r!=null&&c.push(r);var l=this.compileAndRun(u,c,"int32");return l.shape[1]===1?l:this.argReduce(e,n,l)},t.prototype.argReducePacked=function(e,n,r){r===void 0&&(r=null);var o=r!=null?r.shape:e.shape,a=Mo(o[o.length-1]),s=new ob(o,a,n,r==null),u=r==null?[e]:[e,r],c=this.compileAndRun(s,u,"int32");return c.rank===e.rank?this.argReducePacked(e,n,c):c},t.prototype.sum=function(e,n){It("sum",n,e.rank);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a),u=lu(e.dtype);return this.reduce(s,"sum",u).reshape(o)},t.prototype.prod=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.prod(e,n);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a),u=lu(e.dtype);return this.reduce(s,"prod",u).reshape(o)},t.prototype.unsortedSegmentSum=function(e,n,r){var o=0,a=Zt([o],e.rank),s=e;a!=null&&(s=e.transpose(a),o=en(1,e.rank)[0]);var u=function(p,d,m){for(var v=[],g=p.length,x=0;x<g;x++)x!==d?v.push(p[x]):v.push(m);return v}(s.shape,o,r),c=re([s.shape[o]]),l=s.as2D(-1,c),f=lu(e.dtype),h=this.segOpCompute(l,"unsortedSegmentSum",n,f,r).reshape(u);return a!=null&&(h=h.transpose(ea(a))),h},t.prototype.segOpCompute=function(e,n,r,o,a){var s=e.shape[0],u=e.shape[1],c=function(h,p){var d,m=!1;for(h<=uc?(d=h,m=!0):d=qo(h,Math.floor(Math.sqrt(h)));!m;)d>p||d===h?m=!0:d=qo(h,d+1);return d}(u,a),l=new aw({windowSize:c,inSize:u,batchSize:s,numSegments:a},n),f=this.compileAndRun(l,[e,r],o);return f.shape[1]===a?f:(r=jo(0,a).tile([u/c]),this.segOpCompute(f,n,r,o,a))},t.prototype.argMinMaxReduce=function(e,n,r){var o=[n];if(It("arg"+r.charAt(0).toUpperCase()+r.slice(1),o,e.rank),!O().getBool("WEBGL_PACK_REDUCE")||e.rank<=2){var a=pt(e.shape,o),s=a[0],u=re(a[1]),c=e.as2D(-1,u);return this.argReduce(c,r).reshape(s)}return this.argReducePacked(e,r)},t.prototype.argMin=function(e,n){return this.argMinMaxReduce(e,n,"min")},t.prototype.argMax=function(e,n){return this.argMinMaxReduce(e,n,"max")},t.prototype.cumsum=function(e,n,r,o){if(n!==e.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(e.rank-1)+" but got axis="+n);var a=new kb(e.shape,r,o);return this.compileAndRun(a,[e])},t.prototype.equal=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(equal(a, b));
`,"bool");var r=new Xe("return float(a == b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.notEqual=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(notEqual(a, b));
`,"bool");var r=new Xe("return float(a != b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.less=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.less(e,n);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(lessThan(a, b));
`,"bool");var r=new Xe("return float(a < b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.lessEqual=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(lessThanEqual(a, b));
`,"bool");var r=new Xe("return float(a <= b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.greater=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.greater(e,n);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(greaterThan(a, b));
`,"bool");var r=new Xe("return float(a > b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.greaterEqual=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(greaterThanEqual(a, b));
`,"bool");var r=new Xe("return float(a >= b);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.logicalNot=function(e){var n=new fe(e.shape,"return float(!(x >= 1.0));");return this.compileAndRun(n,[e])},t.prototype.logicalAnd=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return vec4(
    vec4(greaterThanEqual(a, vec4(1.0))) *
    vec4(greaterThanEqual(b, vec4(1.0))));
`,"bool");var r=new Xe("return float(a >= 1.0 && b >= 1.0);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.logicalOr=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  return min(
    vec4(greaterThanEqual(a, vec4(1.0))) +
    vec4(greaterThanEqual(b, vec4(1.0))),
    vec4(1.0));
`,"bool");var r=new Xe("return float(a >= 1.0 || b >= 1.0);",e.shape,n.shape);return this.compileAndRun(r,[e,n],"bool")},t.prototype.select=function(e,n,r){var o=new sw(e.rank,n.shape,n.rank);return this.compileAndRun(o,[e,n,r],at(n.dtype,r.dtype))},t.prototype.where=function(e){Vo("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var n=e.dataSync();return vc(e.shape,n)},t.prototype.topk=function(e,n,r){return Xd(e.dataSync(),e.shape,e.dtype,n)},t.prototype.min=function(e,n){It("min",n,e.rank);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a);return this.reduce(s,"min",s.dtype).reshape(o)},t.prototype.minimum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.minimum(e,n);var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  vec4 result = vec4(min(a, b));
  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));
  
  result.r = isNaN.r > 0. ? NAN : result.r;
  result.g = isNaN.g > 0. ? NAN : result.g;
  result.b = isNaN.b > 0. ? NAN : result.b;
  result.a = isNaN.a > 0. ? NAN : result.a;

  return result;
`,e.shape,n.shape):new Xe(`
  if (isnan(a)) return a;
  if (isnan(b)) return b;

  return min(a, b);
`,e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.mod=function(e,n){var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  vec4 result = mod(a, b);
  vec4 isNaN = vec4(equal(b, vec4(0.0)));
  
  result.r = isNaN.r > 0. ? NAN : result.r;
  result.g = isNaN.g > 0. ? NAN : result.g;
  result.b = isNaN.b > 0. ? NAN : result.b;
  result.a = isNaN.a > 0. ? NAN : result.a;

  return result;
`,e.shape,n.shape):new Xe(`if (b == 0.0) return NAN;
  return mod(a, b);`,e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.max=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.max(e,n);It("max",n,e.rank);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a);return this.reduce(s,"max",s.dtype).reshape(o)},t.prototype.maximum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.maximum(e,n);var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  vec4 result = vec4(max(a, b));
  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));
  
  result.r = isNaN.r > 0. ? NAN : result.r;
  result.g = isNaN.g > 0. ? NAN : result.g;
  result.b = isNaN.b > 0. ? NAN : result.b;
  result.a = isNaN.a > 0. ? NAN : result.a;

  return result;
`,e.shape,n.shape):new Xe(`
  if (isnan(a)) return a;
  if (isnan(b)) return b;

  return max(a, b);
`,e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.all=function(e,n){It("all",n,e.rank);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a);return this.reduce(s,"all",s.dtype).reshape(o)},t.prototype.any=function(e,n){It("any",n,e.rank);var r=pt(e.shape,n),o=r[0],a=re(r[1]),s=e.as2D(-1,a);return this.reduce(s,"any",s.dtype).reshape(o)},t.prototype.realDivide=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  // vec4 one = vec4(equal(a, b));
  // return one + (vec4(1.0) - one) * a / b;
  vec4 result = a / b;
  if(a.x == b.x) {
    result.x = 1.;
  }
  if(a.y == b.y) {
    result.y = 1.;
  }
  if(a.z == b.z) {
    result.z = 1.;
  }
  if(a.w == b.w) {
    result.w = 1.;
  }

  return result;
`,"float32",!0);var r=new Xe(`
if (a == b) {
  return 1.0;
};
return a / b;`,e.shape,n.shape);return this.compileAndRun(r,[e,n],"float32")},t.prototype.floorDiv=function(e,n){if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,`
  ivec4 ia = round(a);
  ivec4 ib = round(b);
  bvec4 cond = notEqual(ib, ivec4(0));
  ivec4 result = ivec4(0);
  vec4 s = sign(a) * sign(b);

  // Windows (D3D) wants guaranteed non-zero int division at compile-time.
  if (cond[0]) {
    result[0] = idiv(ia[0], ib[0], s[0]);
  }
  if (cond[1]) {
    result[1] = idiv(ia[1], ib[1], s[1]);
  }
  if (cond[2]) {
    result[2] = idiv(ia[2], ib[2], s[2]);
  }
  if (cond[3]) {
    result[3] = idiv(ia[3], ib[3], s[3]);
  }
  return vec4(result);
`,"int32");var r=new Xe(`
  float s = sign(a) * sign(b);
  int ia = round(a);
  int ib = round(b);
  if (ib != 0) {
    // Windows (D3D) wants guaranteed non-zero int division at compile-time.
    return float(idiv(ia, ib, s));
  } else {
    return NAN;
  }
`,e.shape,n.shape);return this.compileAndRun(r,[e,n],"int32")},t.prototype.add=function(e,n){if(e.dtype==="complex64"&&n.dtype==="complex64")return this.complexSeparableBinaryOp(e,n,pu);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.add(e,n);var r=at(e.dtype,n.dtype);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,pu,r);var o=new Xe(pu,e.shape,n.shape);return this.compileAndRun(o,[e,n],r)},t.prototype.packedUnaryOp=function(e,n,r){var o=new xi(e.shape,n);return this.compileAndRun(o,[e],r)},t.prototype.packedBinaryOp=function(e,n,r,o,a){a===void 0&&(a=!1);var s=new _n(r,e.shape,n.shape,a);return this.compileAndRun(s,[e,n],o)},t.prototype.complexSeparableBinaryOp=function(e,n,r){var o=this,a=this.texData.get(e.dataId),s=this.texData.get(n.dataId),u=[[a.complexTensors.real,s.complexTensors.real],[a.complexTensors.imag,s.complexTensors.imag]].map(function(h){var p=h[0],d=h[1],m=o.makeComplexComponentTensorInfo(e,p),v=o.makeComplexComponentTensorInfo(n,d),g=new Xe(r,e.shape,n.shape);return o.compileAndRun(g,[m,v],at(p.dtype,d.dtype))}),c=u[0],l=u[1],f=this.complex(c,l);return c.dispose(),l.dispose(),f},t.prototype.makeComplexComponentTensorInfo=function(e,n){return{dataId:n.dataId,dtype:n.dtype,shape:e.shape}},t.prototype.addN=function(e){if(e.length===1)return e[0];if(e.length>O().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var n=Math.floor(e.length/2),r=this.addN(e.slice(0,n)),o=this.addN(e.slice(n));return this.addN([r,o])}var a=e.map(function(c){return c.dtype}).reduce(function(c,l){return at(c,l)}),s=e.map(function(c){return c.shape}),u=O().getBool("WEBGL_PACK")?new Qx(e[0].shape,s):new Jx(e[0].shape,s);return this.compileAndRun(u,e,a)},t.prototype.subtract=function(e,n){if(e.dtype==="complex64"&&n.dtype==="complex64")return this.complexSeparableBinaryOp(e,n,du);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.subtract(e,n);var r=at(e.dtype,n.dtype);if(O().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,du,e.dtype);var o=new Xe(du,e.shape,n.shape);return this.compileAndRun(o,[e,n],r)},t.prototype.pow=function(e,n){var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.
  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));
  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);
  vec4 result = multiplier * pow(abs(a), b);

  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS
  bvec4 isExpZero = equal(b, vec4(0.0));
  result.r = isExpZero.r ? 1.0 : result.r;
  result.g = isExpZero.g ? 1.0 : result.g;
  result.b = isExpZero.b ? 1.0 : result.b;
  result.a = isExpZero.a ? 1.0 : result.a;

  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));
  
  result.r = isNaN.r > 0. ? NAN : result.r;
  result.g = isNaN.g > 0. ? NAN : result.g;
  result.b = isNaN.b > 0. ? NAN : result.b;
  result.a = isNaN.a > 0. ? NAN : result.a;

  return result;
`,e.shape,n.shape):new Xe(`
if(a < 0.0 && floor(b) < b){
  return NAN;
}
if (b == 0.0) {
  return 1.0;
}
return (round(mod(b, 2.0)) != 1) ?
    pow(abs(a), b) : sign(a) * pow(abs(a), b);
`,e.shape,n.shape),o=at(e.dtype,n.dtype);return this.compileAndRun(r,[e,n],o)},t.prototype.ceil=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.ceil(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,bp,e.dtype);var n=new fe(e.shape,bp);return this.compileAndRun(n,[e])},t.prototype.floor=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.floor(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,wp,e.dtype);var n=new fe(e.shape,wp);return this.compileAndRun(n,[e])},t.prototype.sign=function(e){var n=new fe(e.shape,`
  if (isnan(x)) { return 0.0; }
  return sign(x);
`);return this.compileAndRun(n,[e])},t.prototype.isNaN=function(e){var n=new fe(e.shape,"return float(isnan(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.isInf=function(e){var n=new fe(e.shape,"return float(isinf(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.isFinite=function(e){var n=new fe(e.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(n,[e],"bool")},t.prototype.round=function(e){var n=new fe(e.shape,`
  // OpenGL ES does not support round function.
  // The algorithm is based on banker's rounding.
  float base = floor(x);
  if ((x - base) < 0.5) {
    return floor(x);
  } else if ((x - base) > 0.5) {
    return ceil(x);
  } else {
    if (mod(base, 2.0) == 0.0) {
      return base;
    } else {
      return base + 1.0;
    }
  }
`);return this.compileAndRun(n,[e])},t.prototype.exp=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.exp(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Cp,e.dtype);var n=new fe(e.shape,Cp);return this.compileAndRun(n,[e])},t.prototype.expm1=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.expm1(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,_p,e.dtype);var n=new fe(e.shape,_p);return this.compileAndRun(n,[e])},t.prototype.softmax=function(e,n){var r=Ze([n],e.shape),o=this.max(e,r),a=Et(o.shape,r),s=this.subtract(e,o.reshape(a)),u=this.exp(s),c=this.sum(u,r).reshape(a);return this.realDivide(u,c)},t.prototype.log=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.log(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,`
  vec4 result = log(x);
  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));
  result.r = isNaN.r == 1.0 ? NAN : result.r;
  result.g = isNaN.g == 1.0 ? NAN : result.g;
  result.b = isNaN.b == 1.0 ? NAN : result.b;
  result.a = isNaN.a == 1.0 ? NAN : result.a;

  return result;
`,e.dtype);var n=new fe(e.shape,`if (x < 0.0) return NAN;
  return log(x);`);return this.compileAndRun(n,[e])},t.prototype.log1p=function(e){var n=new fe(e.shape,"return log(1.0 + x);");return this.compileAndRun(n,[e])},t.prototype.sqrt=function(e){var n=new fe(e.shape,"return sqrt(x);");return this.compileAndRun(n,[e])},t.prototype.rsqrt=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.rsqrt(e);var n=new fe(e.shape,"return inversesqrt(x);");return this.compileAndRun(n,[e])},t.prototype.reciprocal=function(e){var n=new fe(e.shape,"return 1.0 / x;");return this.compileAndRun(n,[e])},t.prototype.relu=function(e){var n;return n=O().getBool("WEBGL_PACK")?new xi(e.shape,bm):new fe(e.shape,gm),this.compileAndRun(n,[e])},t.prototype.relu6=function(e){var n;return n=O().getBool("WEBGL_PACK")?new xi(e.shape,wm):new fe(e.shape,ym),this.compileAndRun(n,[e])},t.prototype.prelu=function(e,n){var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(Zd,e.shape,n.shape):new Xe(Qd,e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.elu=function(e){if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Cm,e.dtype);var n=new fe(e.shape,xm);return this.compileAndRun(n,[e])},t.prototype.eluDer=function(e,n){var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));
  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));
`,e.shape,n.shape):new Xe("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.selu=function(e){var n=new fe(e.shape,vw);return this.compileAndRun(n,[e])},t.prototype.int=function(e){var n=new fe(e.shape,"return float(int(x));");return this.compileAndRun(n,[e],"int32")},t.prototype.clip=function(e,n,r){var o,a=(o=O().getBool("WEBGL_PACK_CLIP")?new pb(e.shape):new hb(e.shape)).getCustomSetupFunc(n,r);return this.compileAndRun(o,[e],null,a)},t.prototype.abs=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.abs(e);if(O().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,yp,e.dtype);var n=new fe(e.shape,yp);return this.compileAndRun(n,[e])},t.prototype.complexAbs=function(e){var n=this.texData.get(e.dataId),r=new db(e.shape),o=[this.makeComplexComponentTensorInfo(e,n.complexTensors.real),this.makeComplexComponentTensorInfo(e,n.complexTensors.imag)];return this.compileAndRun(r,o)},t.prototype.sigmoid=function(e){var n=new fe(e.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(n,[e])},t.prototype.softplus=function(e){var n=new fe(e.shape,`
  float epsilon = 1.1920928955078125e-7;
  float threshold = log(epsilon) + 2.0;

  bool too_large = x > -threshold;
  bool too_small = x < threshold;

  float result;
  float exp_x = exp(x);

  if (too_large){
    result = x;
  }
  else if (too_small){
    result = exp_x;
  }
  else{
    result = log(exp_x + 1.0);
  }
  return result;
`);return this.compileAndRun(n,[e])},t.prototype.sin=function(e){var n=new fe(e.shape,gw);return this.compileAndRun(n,[e])},t.prototype.cos=function(e){var n=new fe(e.shape,yw);return this.compileAndRun(n,[e])},t.prototype.tan=function(e){var n=new fe(e.shape,"return tan(x);");return this.compileAndRun(n,[e])},t.prototype.asin=function(e){var n=new fe(e.shape,xw);return this.compileAndRun(n,[e])},t.prototype.acos=function(e){var n=new fe(e.shape,bw);return this.compileAndRun(n,[e])},t.prototype.atan=function(e){var n=new fe(e.shape,ww);return this.compileAndRun(n,[e])},t.prototype.atan2=function(e,n){var r=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n(`
  vec4 result = atan(a, b);
  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));
  
  result.r = isNaN.r > 0. ? NAN : result.r;
  result.g = isNaN.g > 0. ? NAN : result.g;
  result.b = isNaN.b > 0. ? NAN : result.b;
  result.a = isNaN.a > 0. ? NAN : result.a;

  return result;
`,e.shape,n.shape):new Xe(`
  if (isnan(a)) return a;
  if (isnan(b)) return b;

  return atan(a, b);
`,e.shape,n.shape);return this.compileAndRun(r,[e,n])},t.prototype.sinh=function(e){var n=new fe(e.shape,`
  float e2x = exp(x);
  return (e2x - 1.0 / e2x) / 2.0;
`);return this.compileAndRun(n,[e])},t.prototype.cosh=function(e){var n=new fe(e.shape,`
  float e2x = exp(-x);
  return (e2x + 1.0 / e2x) / 2.0;
`);return this.compileAndRun(n,[e])},t.prototype.tanh=function(e){var n=new fe(e.shape,`
  float e2x = exp(-2.0 * abs(x));
  return sign(x) * (1.0 - e2x) / (1.0 + e2x);
`);return this.compileAndRun(n,[e])},t.prototype.asinh=function(e){var n=new fe(e.shape,Cw);return this.compileAndRun(n,[e])},t.prototype.acosh=function(e){var n=new fe(e.shape,_w);return this.compileAndRun(n,[e])},t.prototype.atanh=function(e){var n=new fe(e.shape,Ew);return this.compileAndRun(n,[e])},t.prototype.erf=function(e){var n=new fe(e.shape,`
  // Error function is calculated approximately with elementary function.
  // See "Handbook of Mathematical Functions with Formulas,
  // Graphs, and Mathematical Tables", Abramowitz and Stegun.
  float p = 0.3275911;
  float a1 = 0.254829592;
  float a2 = -0.284496736;
  float a3 = 1.421413741;
  float a4 = -1.453152027;
  float a5 = 1.061405429;

  float sign = sign(x);
  x = abs(x);
  float t = 1.0 / (1.0 + p * x);
  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));
`);return this.compileAndRun(n,[e])},t.prototype.step=function(e,n){var r=new fe(e.shape,function(o){return o===void 0&&(o=0),tn+`
    return x > 0.0 ? 1.0 : float(`+o+`);
  `}(n));return this.compileAndRun(r,[e])},t.prototype.conv2dByMatMul=function(e,n,r,o,a,s){var u=e.shape,c=this.texData.get(e.dataId),l=r.inChannels,f=u[0]*u[1]*u[2],h=r.outChannels,p=r.dataFormat==="channelsLast",d=(f===1||h===1)&&l>1e3,m=u[2]%2!=0&&!!c.isPacked;if(d||!O().getBool("WEBGL_LAZILY_UNPACK")||!O().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!m){var v=p?u[0]*u[1]*u[2]:u[0]*u[2]*u[3],g=this.reshape(e,[1,v,r.inChannels]),x=this.reshape(n,[1,r.inChannels,r.outChannels]);return this.reshape(this.fusedBatchMatMul({a:g,b:x,transposeA:!1,transposeB:!1,bias:o,activation:a,preluActivationWeights:s}),r.outShape)}var w=p?u[0]*u[1]*(u[2]+1):u[0]*u[2]*(u[3]+1),y={dataId:e.dataId,shape:[1,w,r.inChannels],dtype:e.dtype},b=c.shape;c.shape=c.shape.slice(),c.shape[c.shape.length-2]++,E(Ci(c.shape,y.shape),function(){return"packed reshape "+c.shape+" to "+y.shape+" isn't free"});var C=this.reshape(n,[1,r.inChannels,r.outChannels]),S=this.fusedBatchMatMul({a:y,b:C,transposeA:!1,transposeB:!1,bias:o,activation:a,preluActivationWeights:s}),A=this.texData.get(S.dataId);return E(A.isPacked,function(){return"batchMatMul result is expected to be packed"}),c.shape=b,A.shape=r.outShape,R.makeTensorFromDataId(S.dataId,r.outShape,S.dtype)},t.prototype.conv2dWithIm2Row=function(e,n,r,o,a,s){var u=r.filterWidth,c=r.filterHeight,l=r.inChannels,f=r.outWidth,h=r.outHeight,p=r.dataFormat==="channelsLast",d=u*c*l,m=h*f,v=[d,m],g=e.squeeze([0]),x=n.reshape([1,d,-1]),w=new zb(v,g.shape,r),y=this.compileAndRun(w,[g]).reshape([1,v[0],v[1]]),b=o!=null,C=s!=null,S=a?ko(a,!0):null,A=new mu(y.shape,[1,m,r.outChannels],!0,!1,b,S,C),k=[y,x];o&&k.push(o),C&&k.push(s);var D=this.compileAndRun(A,k);return p?D.reshape([1,h,f,r.outChannels]):D.reshape([1,r.outChannels,h,f])},t.prototype.fusedConv2d=function(e){var n=e.input,r=e.filter,o=e.convInfo,a=e.bias,s=e.activation,u=e.preluActivationWeights;if(o.filterHeight===1&&o.filterWidth===1&&o.dilationHeight===1&&o.dilationWidth===1&&o.strideHeight===1&&o.strideWidth===1&&(o.padInfo.type==="SAME"||o.padInfo.type==="VALID"))return this.conv2dByMatMul(n,r,o,a,s,u);if(O().getBool("WEBGL_CONV_IM2COL")&&n.shape[0]===1)return this.conv2dWithIm2Row(n,r,o,a,s,u);var c=a!=null,l=u!=null,f=s?ko(s,!1):null,h=new cp(o,c,f,l),p=[n,r];return a&&p.push(a),u&&p.push(u),this.compileAndRun(h,p)},t.prototype.conv2d=function(e,n,r){if(r.filterHeight===1&&r.filterWidth===1&&r.dilationHeight===1&&r.dilationWidth===1&&r.strideHeight===1&&r.strideWidth===1&&(r.padInfo.type==="SAME"||r.padInfo.type==="VALID"))return this.conv2dByMatMul(e,n,r);if(O().getBool("WEBGL_CONV_IM2COL")&&e.shape[0]===1)return this.conv2dWithIm2Row(e,n,r);var o=new cp(r);return this.compileAndRun(o,[e,n])},t.prototype.conv2dDerInput=function(e,n,r){var o=new yb(r);return this.compileAndRun(o,[e,n])},t.prototype.conv2dDerFilter=function(e,n,r){var o=new gb(r);return this.compileAndRun(o,[e,n])},t.prototype.fusedDepthwiseConv2D=function(e){var n,r=e.input,o=e.filter,a=e.convInfo,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=O().getBool("WEBGL_PACK_DEPTHWISECONV")&&a.strideWidth<=2&&a.outChannels/a.inChannels==1,f=u?ko(u,l):null,h=[r,o],p=s!=null,d=c!=null;return p&&h.push(s),d&&h.push(c),l?(n=new fp(a,p,f,d),this.compileAndRun(n,h)):(n=new lp(a,p,f,d),this.compileAndRun(n,h))},t.prototype.depthwiseConv2D=function(e,n,r){var o;return O().getBool("WEBGL_PACK_DEPTHWISECONV")&&r.strideWidth<=2&&r.outChannels/r.inChannels==1?(o=new fp(r),this.compileAndRun(o,[e,n])):(o=new lp(r),this.compileAndRun(o,[e,n]))},t.prototype.depthwiseConv2DDerInput=function(e,n,r){var o=new Cb(r);return this.compileAndRun(o,[e,n])},t.prototype.depthwiseConv2DDerFilter=function(e,n,r){var o=new wb(r);return this.compileAndRun(o,[e,n])},t.prototype.conv3d=function(e,n,r){var o=new _b(r);return this.compileAndRun(o,[e,n])},t.prototype.conv3dDerInput=function(e,n,r){var o=new bb(r);return this.compileAndRun(o,[e,n])},t.prototype.conv3dDerFilter=function(e,n,r){var o=new xb(r);return this.compileAndRun(o,[e,n])},t.prototype.maxPool=function(e,n){var r=new vu(n,"max",!1);return this.compileAndRun(r,[e])},t.prototype.avgPool=function(e,n){var r=new vu(n,"avg",!1);return this.compileAndRun(r,[e],"float32")},t.prototype.maxPoolBackprop=function(e,n,r,o){var a=new vu(o,"max",!0),s=this.compileAndRun(a,[n]),u=new jb(o),c=this.compileAndRun(u,[e,s],n.dtype);return s.dispose(),c},t.prototype.avgPoolBackprop=function(e,n,r){var o=new ab(r);return this.compileAndRun(o,[e],n.dtype)},t.prototype.cast=function(e,n){return hc(e,n,this)},t.prototype.unstack=function(e,n){for(var r=e.shape[n],o=new Array(e.rank-1),a=0,s=0;s<e.rank;s++)s!==n&&(o[a++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[n]=1;var l=new Array(r);for(s=0;s<l.length;s++)u[n]=s,l[s]=this.slice(e,u,c).reshape(o);return l},t.prototype.avgPool3d=function(e,n){var r=new gu(n,"avg",!1);return this.compileAndRun(r,[e],"float32")},t.prototype.avgPool3dBackprop=function(e,n,r){var o=new sb(r);return this.compileAndRun(o,[e],n.dtype)},t.prototype.maxPool3d=function(e,n){var r=new gu(n,"max",!1);return this.compileAndRun(r,[e],"float32")},t.prototype.maxPool3dBackprop=function(e,n,r,o){var a=new gu(o,"max",!0),s=this.compileAndRun(a,[n]),u=new Gb(o),c=this.compileAndRun(u,[e,s],n.dtype);return s.dispose(),c},t.prototype.reshape=function(e,n){var r=this.texData.get(e.dataId);if(r.isPacked&&!Ci(e.shape,n)&&(r.texture===null||!Ci(r.shape,n))){var o=this.packedReshape(e,n);return R.makeTensorFromDataId(o.dataId,o.shape,o.dtype)}return $o(e,n)},t.prototype.resizeBilinear=function(e,n,r,o){var a=O().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new tw(e.shape,n,r,o):new ew(e.shape,n,r,o);return this.compileAndRun(a,[e],"float32")},t.prototype.resizeBilinearBackprop=function(e,n,r){var o=new Zb(e,n,r);return this.compileAndRun(o,[e])},t.prototype.resizeNearestNeighbor=function(e,n,r,o){var a=new rw(e.shape,n,r,o);return this.compileAndRun(a,[e])},t.prototype.resizeNearestNeighborBackprop=function(e,n,r){var o=new nw(e,n,r);return this.compileAndRun(o,[e])},t.prototype.multinomial=function(e,n,r,o){var a=n?e:St(e),s=a.shape[0],u=a.shape[1],c=new Hb(s,u,r),l=c.getCustomSetupFunc(o);return this.compileAndRun(c,[a],"int32",l)},t.prototype.oneHot=function(e,n,r,o){var a=new Kb(e.size,n,r,o);return this.compileAndRun(a,[e])},t.prototype.diag=function(e){var n=new Fb(e.size);return this.compileAndRun(n,[e])},t.prototype.nonMaxSuppression=function(e,n,r,o,a){return Vo("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),dc(e.dataSync(),n.dataSync(),r,o,a)},t.prototype.cropAndResize=function(e,n,r,o,a,s){var u=new Eb(e.shape,n.shape,o,a,s);return this.compileAndRun(u,[e,n,r],"float32")},t.prototype.depthToSpace=function(e,n,r){E(n>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});var o=e.shape[0],a=r==="NHWC"?e.shape[1]:e.shape[2],s=r==="NHWC"?e.shape[2]:e.shape[3],u=r==="NHWC"?e.shape[3]:e.shape[1],c=a*n,l=s*n,f=u/(n*n),h=new Ab(r==="NHWC"?[o,c,l,f]:[o,f,c,l],n,r);return this.compileAndRun(h,[e])},t.prototype.split=function(e,n,r){return Hd(e,n,r)},t.prototype.scatterND=function(e,n,r){var o=Ii(0,e,r),a=o.sliceRank,s=o.numUpdates,u=o.sliceSize,c=o.strides,l=o.outputSize,f=[l/u,u],h=e.reshape([s,a]),p=n.reshape([s,u]);if(l===0)return $o(st([]),r);var d=Y(0),m=new mp(s,a,h.rank,p.rank,c,f);return this.compileAndRun(m,[p,h,d]).reshape(r)},t.prototype.sparseToDense=function(e,n,r,o){var a=Ii(0,e,r),s=a.sliceRank,u=a.numUpdates,c=a.strides,l=a.outputSize,f=new mp(u,s,e.rank,n.rank,c,[l,1],!1);return this.compileAndRun(f,[n,e,o]).reshape(r)},t.prototype.fft=function(e){return this.fftImpl(e,!1)},t.prototype.ifft=function(e){return this.fftImpl(e,!0)},t.prototype.fftImpl=function(e,n){var r=this.texData.get(e.dataId),o=new pp(Pb,e.shape,n),a=new pp(Mb,e.shape,n),s=[this.makeComplexComponentTensorInfo(e,r.complexTensors.real),this.makeComplexComponentTensorInfo(e,r.complexTensors.imag)],u=this.compileAndRun(o,s),c=this.compileAndRun(a,s),l=this.complex(u,c).as2D(e.shape[0],e.shape[1]);return u.dispose(),c.dispose(),l},t.prototype.gatherND=function(e,n){var r=n.shape,o=r[r.length-1],a=sc(e,n),s=a[0],u=a[1],c=a[2],l=a[3],f=n.reshape([u,o]),h=e.reshape([e.size/c,c]),p=new Lb(o,l,[u,c]);return this.compileAndRun(p,[h,f]).reshape(s)},t.prototype.fill=function(e,n,r){if((r=r||Ur(n))==="string"){var o=ki(r,re(e));return o.fill(n),R.makeTensor(o,e,r,this)}var a=new Ob(e,n),s=a.getCustomSetupFunc(n);return this.compileAndRun(a,[],r,s)},t.prototype.onesLike=function(e){if(e.dtype==="string")throw new Error("onesLike is not supported under string dtype");return this.fill(e.shape,1,e.dtype)},t.prototype.zerosLike=function(e){return this.fill(e.shape,e.dtype==="string"?"":0,e.dtype)},t.prototype.linspace=function(e,n,r){return pc(e,n,r)},t.prototype.makeTensorInfo=function(e,n){var r=this.write(null,e,n);return this.texData.get(r).usage=null,{dataId:r,shape:e,dtype:n}},t.prototype.makeOutput=function(e,n){var r=this.makeTensorInfo(e,n).dataId;return R.makeTensorFromDataId(r,e,n,this)},t.prototype.unpackTensor=function(e){var n=new Dw(e.shape);return this.runWebGLProgram(n,[e],e.dtype)},t.prototype.packTensor=function(e){var n=new Xb(e.shape);return this.runWebGLProgram(n,[e],e.dtype,null,!0)},t.prototype.packedReshape=function(e,n){var r=[Fi(e.shape)].concat(Ri(e.shape)),o={dtype:e.dtype,shape:r,dataId:e.dataId},a=[Fi(n)].concat(Ri(n)),s=new Qb(a,r),u=this.runWebGLProgram(s,[o],e.dtype,null,!0);return{dataId:u.dataId,shape:n,dtype:u.dtype}},t.prototype.decode=function(e){var n,r=this.texData.get(e),o=r.isPacked,a=r.shape,s=r.dtype,u=Po(a);return n=o?new Sb(u):new Db(u),{dtype:s,shape:a,dataId:this.runWebGLProgram(n,[{shape:u,dtype:s,dataId:e}],s,null,!0).dataId}},t.prototype.runWebGLProgram=function(e,n,r,o,a){var s=this;a===void 0&&(a=!1);var u=this.makeTensorInfo(e.outputShape,r),c=this.texData.get(u.dataId);if(e.packedOutput&&(c.isPacked=!0),e.outPackingScheme===Ai.DENSE){var l=_i(e.outputShape);c.texShape=l.map(function(w){return 2*w})}if(e.outTexUsage!=null&&(c.usage=e.outTexUsage),re(u.shape)===0)return c.values=qr(u.dtype,0),u;var f=[],h=n.map(function(w){if(w.dtype==="complex64")throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var y=s.texData.get(w.dataId);if(y.texture==null){if(!e.packedInputs&&re(w.shape)<=O().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:w.shape,texData:null,isUniform:!0,uniformValues:y.values};e.packedInputs&&(y.isPacked=!0,y.shape=w.shape)}else if(!!y.isPacked!=!!e.packedInputs)w=y.isPacked?s.unpackTensor(w):s.packTensor(w),f.push(w),y=s.texData.get(w.dataId);else if(y.isPacked&&!Ci(y.shape,w.shape)){var b=w,C=w.shape;w.shape=y.shape,w=s.packedReshape(w,C),f.push(w),y=s.texData.get(w.dataId),b.shape=C}return s.uploadToGPU(w.dataId),{shape:w.shape,texData:y,isUniform:!1}});this.uploadToGPU(u.dataId);var p,d={shape:u.shape,texData:c,isUniform:!1},m=function(w,y,b){var C="";y.concat(b).forEach(function(k){var D=k.texData!=null&&k.texData.slice!=null&&k.texData.slice.flatOffset>0,T=k.isUniform?"uniform":k.texData.texShape;C+=k.shape+"_"+T+"_"+D});var S=w.userCode,A=w.constructor.name;return A+="_"+C+"_"+S}(e,h,d),v=this.getAndSaveBinary(m,function(){return function(w,y,b,C){var S=y.userCode,A=b.map(function(z,G){var H={logicalShape:z.shape,texShape:z.isUniform?null:z.texData.texShape,isUniform:z.isUniform,isPacked:!z.isUniform&&z.texData.isPacked,flatOffset:null};return z.texData!=null&&z.texData.slice!=null&&z.texData.slice.flatOffset>0&&(H.flatOffset=z.texData.slice.flatOffset),{name:y.variableNames[G],shapeInfo:H}}),k=A.map(function(z){return z.shapeInfo}),D={logicalShape:C.shape,texShape:C.texData.texShape,isUniform:!1,isPacked:C.texData.isPacked,flatOffset:null},T=eb(A,D,S,y.packedInputs),I=w.createProgram(T),W=null,B=w.getUniformLocation(I,"NAN",!1);O().getNumber("WEBGL_VERSION")===1&&(W=w.getUniformLocation(I,"INFINITY",!1));for(var L={},V=0;V<y.variableNames.length;V++){var q=y.variableNames[V];L[q]=w.getUniformLocation(I,q,!1),L["offset"+q]=w.getUniformLocation(I,"offset"+q,!1)}return{program:y,source:T,webGLProgram:I,uniformLocations:L,inShapeInfos:k,outShapeInfo:D,infLoc:W,nanLoc:B}}(s.gpgpu,e,h,d)}),g=this.activeTimers!=null;if(g&&(p=this.startTimer()),function(w,y,b,C,S){dp(y.inShapeInfos,b),dp([y.outShapeInfo],[C]);var A=C.texData.texture,k=C.texData.texShape;C.texData.isPacked?w.setOutputPackedMatrixTexture(A,k[0],k[1]):w.setOutputMatrixTexture(A,k[0],k[1]),w.setProgram(y.webGLProgram),O().getNumber("WEBGL_VERSION")===1&&y.infLoc!==null&&w.gl.uniform1f(y.infLoc,1/0),y.nanLoc!==null&&w.gl.uniform1f(y.nanLoc,NaN),b.forEach(function(D,T){var I=y.program.variableNames[T],W=y.uniformLocations[I],B=y.uniformLocations["offset"+I];if(W!=null)if(D.isUniform)if(re(D.shape)<2)w.gl.uniform1f(W,D.uniformValues[0]);else{var L=D.uniformValues;L instanceof Float32Array||(L=new Float32Array(L)),w.gl.uniform1fv(W,L)}else D.texData.slice!=null&&B!=null&&w.gl.uniform1i(B,D.texData.slice.flatOffset),w.setInputMatrixTexture(D.texData.texture,W,T)}),S?.(w,y.webGLProgram),w.executeProgram()}(this.gpgpu,v,h,d,o),f.forEach(function(w){return s.disposeData(w.dataId)}),g&&(p=this.endTimer(p),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(p)})),!O().getBool("WEBGL_LAZILY_UNPACK")&&c.isPacked&&a===!1){var x=this.unpackTensor(u);return this.disposeData(u.dataId),x}return u},t.prototype.compileAndRun=function(e,n,r,o,a){a===void 0&&(a=!1),r=r||n[0].dtype;var s=this.runWebGLProgram(e,n,r,o,a);return R.makeTensorFromDataId(s.dataId,s.shape,s.dtype)},t.prototype.getAndSaveBinary=function(e,n){return e in this.binaryCache||(this.binaryCache[e]=n()),this.binaryCache[e]},t.prototype.getTextureManager=function(){return this.textureManager},t.prototype.dispose=function(){var e=this;this.disposed||(O().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(n){e.gpgpu.deleteProgram(e.binaryCache[n].webGLProgram),delete e.binaryCache[n]}),this.textureManager.dispose(),this.canvas!=null&&typeof HTMLCanvasElement<"u"&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},t.prototype.floatPrecision=function(){var e=this;return this.floatPrecisionValue==null&&(this.floatPrecisionValue=j(function(){if(!O().get("WEBGL_RENDER_FLOAT32_ENABLED")){var n=O().getBool("DEBUG");O().set("DEBUG",!1);var r=e.abs(Y(1e-8)).dataSync()[0];if(O().set("DEBUG",n),r>0)return 32}return 16})),this.floatPrecisionValue},t.prototype.epsilon=function(){return this.floatPrecision()===32?1e-7:1e-4},t.prototype.uploadToGPU=function(e){var n,r=this.texData.get(e),o=r.shape,a=r.dtype,s=r.values,u=r.texture,c=r.usage,l=r.isPacked;if(u==null){var f,h=this.activeTimers!=null;h&&(f=$t());var p=r.texShape;if(p==null&&(p=bd(o,l),r.texShape=p),s!=null){var d=Po(o),m=void 0,v=p[1],g=p[0],x=s instanceof Uint8Array;l?(v=(n=Mi(p[0],p[1]))[0],g=n[1],m=new Nb(d,[g,v],x)):m=new Tb(d,[g,v],x);var w=this.makeTensorInfo([g,v],a);this.texData.get(w.dataId).usage=x?Lt.PIXELS:Lt.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(w.dataId),v,g,s);var y=this.runWebGLProgram(m,[w],a,null,!0),b=this.texData.get(y.dataId);r.texture=b.texture,r.texShape=b.texShape,r.isPacked=b.isPacked,r.usage=b.usage,this.disposeData(w.dataId),this.texData.delete(y.dataId),r.values=null,h&&(this.uploadWaitMs+=$t()-f)}else{var C=this.acquireTexture(p,c,a,l);r.texture=C}}},t.prototype.convertAndCacheOnCPU=function(e,n){var r=this.texData.get(e),o=r.dtype;return this.releaseGPUData(e),n!=null&&(r.values=function(a,s){if(s==="float32"||s==="complex64")return a;if(s==="int32"||s==="bool"){for(var u=s==="int32"?new Int32Array(a.length):new Uint8Array(a.length),c=0;c<u.length;++c)u[c]=Math.round(a[c]);return u}throw new Error("Unknown dtype "+s)}(n,o)),r.values},t.prototype.acquireTexture=function(e,n,r,o){if(this.numBytesInGPU+=this.computeBytes(e,r),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var a=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+a+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(e,n,o)},t.prototype.computeBytes=function(e,n){return e[0]*e[1]*Qu(n)},t}(jd);td()&&R.registerBackend("webgl",function(){return new _m},2);var Aw=F({square_:function(i){var t=_(i,"x","square"),e=[t];return R.runKernelFunc(function(n,r){return r([t]),n.square(t)},{x:t},null,"Square",{},e,[])}}),Pi="SquaredDifference",Em=F({squaredDifference_:function(i,t){var e,n=_(i,"a","squaredDifference"),r=_(t,"b","squaredDifference");e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape);var o={a:n,b:r},a=[n,r];return R.runKernelFunc(function(s,u){var c=s.squaredDifference(n,r);return u([n,r]),c},o,function(s,u){var c=u[0],l=u[1],f=Y(2);return{a:function(){return s.mul(c.sub(l).mul(f))},b:function(){return s.mul(l.sub(c).mul(f))}}},Pi,{},a,[])}}),Fw=F({abs_:function(i){var t=_(i,"x","abs");return t.dtype==="complex64"?R.runKernelFunc(function(e){return e.complexAbs(t)},{$x:t}):R.runKernelFunc(function(e,n){var r=e.abs(t);return n([t]),r},{x:t},function(e,n){var r=n[0];return{x:function(){return e.mul(r.toFloat().step(-1))}}},"Abs")}}),Rw=F({acos_:function(i){var t=_(i,"x","acos");return R.runKernelFunc(function(e,n){var r=e.acos(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.divStrict(Y(1).sub(r.toFloat().square()).sqrt()).neg()}}})}}),Iw=F({acosh_:function(i){var t=_(i,"x","acosh");return R.runKernelFunc(function(e,n){var r=e.acosh(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.divStrict(r.toFloat().square().sub(1).sqrt())}}})}}),Tw=F({asin_:function(i){var t=_(i,"x","asin");return R.runKernelFunc(function(e,n){var r=e.asin(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.divStrict(Y(1).sub(r.toFloat().square()).sqrt())}}})}}),Nw=F({asinh_:function(i){var t=_(i,"x","asinh");return R.runKernelFunc(function(e,n){var r=e.asinh(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.divStrict(Y(1).add(r.toFloat().square()).sqrt())}}})}}),Pw=F({atan_:function(i){var t=_(i,"x","atan");return R.runKernelFunc(function(e,n){var r=e.atan(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(r.toFloat().square().add(1))}}})}}),Mw=F({atanh_:function(i){var t=_(i,"x","atanh");return R.runKernelFunc(function(e,n){var r=e.atanh(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(Y(1).sub(r.toFloat().square()))}}})}}),Ow=F({ceil_:function(i){var t=_(i,"x","ceil");return R.runKernelFunc(function(e){return e.ceil(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),Bi=F({clipByValue_:function(i,t,e){var n=_(i,"x","clipByValue");E(t<=e,function(){return"Error in clip: min ("+t+") must be less than or equal to max ("+e+")."});var r=[n],o={min:t,max:e};return R.runKernelFunc(function(a,s){var u=a.clip(n,t,e);return s([n]),u},{x:n},function(a,s){var u=s[0];return{x:function(){return a.where(u.greaterEqual(t).logicalAnd(u.lessEqual(e)),De(a))}}},"ClipByValue",o,r)}}),Bw=F({cos_:function(i){var t=_(i,"x","cos"),e=[t];return R.runKernelFunc(function(n,r){var o=n.cos(t);return r([t]),o},{x:t},function(n,r){var o=r[0];return{x:function(){return o.toFloat().sin().neg().mul(n)}}},"Cos",{},e)}}),Lw=F({cosh_:function(i){var t=_(i,"x","cosh");return R.runKernelFunc(function(e,n){var r=e.cosh(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return r.toFloat().sinh().mulStrict(e)}}})}}),Ww=F({erf_:function(i){var t=_(i,"x","erf");return E(t.dtype==="int32"||t.dtype==="float32",function(){return"Input dtype must be `int32` or `float32`."}),t.dtype==="int32"&&(t=t.toFloat()),R.runKernelFunc(function(e,n){var r=e.erf(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.mul(r.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),aa=F({exp_:function(i){var t=_(i,"x","exp");return R.runKernelFunc(function(e,n){var r=e.exp(t);return n([r]),r},{x:t},function(e,n){return{x:function(){return e.mulStrict(n[0])}}},"Exp",{},[],[!0])}}),zw=F({expm1_:function(i){var t=_(i,"x","expm1");return R.runKernelFunc(function(e,n){var r=e.expm1(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.mul(r.exp())}}})}}),qw=F({floor_:function(i){var t=_(i,"x","floor");return R.runKernelFunc(function(e){return e.floor(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),Vw=F({log_:function(i){var t=_(i,"x","log"),e=[t];return R.runKernelFunc(function(n,r){var o=n.log(t);return r([t]),o},{x:t},function(n,r){var o=r[0];return{x:function(){return n.div(o.toFloat())}}},"Log",{},e)}}),Uw=F({log1p_:function(i){var t=_(i,"x","log1p");return R.runKernelFunc(function(e,n){var r=e.log1p(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(r.add(1))}}})}}),jw=F({logSigmoid_:function(i){var t=_(i,"x","logSigmoid");return R.runKernelFunc(function(e,n){var r=e.softplus(t.neg()).neg();return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.mul(r.neg().sigmoid())}}})}}),Li=F({neg_:function(i){var t=_(i,"x","neg"),e=[t];return R.runKernelFunc(function(n){return n.neg(t)},{x:t},function(n){return{x:function(){return n.neg()}}},"Neg",{},e)}}),Gw=F({reciprocal_:function(i){var t=_(i,"x","reciprocal");return R.runKernelFunc(function(e,n){var r=e.reciprocal(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(r.square().neg())}}})}}),Hw=F({round_:function(i){var t=_(i,"x","round");return R.runKernelFunc(function(e){return e.round(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),km=F({rsqrt_:function(i){var t=_(i,"x","rsqrt"),e=[t];return R.runKernelFunc(function(n,r){var o=n.rsqrt(t);return r([t]),o},{x:t},function(n,r){var o=r[0];return{x:function(){return n.div(o.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},e)}}),bc=F({sigmoid_:function(i){var t=_(i,"x","sigmoid");return R.runKernelFunc(function(e,n){var r=e.sigmoid(t);return n([r]),r},{x:t},function(e,n){var r=n[0];return{x:function(){return e.mul(r.mul(Y(1).sub(r)))}}},"Sigmoid")}}),Kw=F({sign_:function(i){var t=_(i,"x","sign");return R.runKernelFunc(function(e){return e.sign(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),Xw=F({isNaN_:function(i){var t=_(i,"x","isNaN");return R.runKernelFunc(function(e){return e.isNaN(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),$w=F({isInf_:function(i){var t=_(i,"x","isInf");return R.runKernelFunc(function(e){return e.isInf(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),Yw=F({isFinite_:function(i){var t=_(i,"x","isFinite");return R.runKernelFunc(function(e){return e.isFinite(t)},{$x:t},function(e){return{$x:function(){return De(e)}}})}}),Jw=F({sin_:function(i){var t=_(i,"x","sin"),e=[t];return R.runKernelFunc(function(n,r){var o=n.sin(t);return r([t]),o},{x:t},function(n,r){var o=r[0];return{x:function(){return o.toFloat().cos().mul(n)}}},"Sin",{},e)}}),Qw=F({sinh_:function(i){var t=_(i,"x","sinh");return R.runKernelFunc(function(e,n){var r=e.sinh(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return r.toFloat().cosh().mulStrict(e)}}})}}),Zw=F({softplus_:function(i){var t=_(i,"x","softplus");return R.runKernelFunc(function(e,n){var r=e.softplus(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.mul(r.sigmoid())}}})}}),e2=F({sqrt_:function(i){var t=_(i,"x","sqrt");return R.runKernelFunc(function(e,n){var r=e.sqrt(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(r.toFloat().sqrt().mul(2))}}})}}),t2=F({step_:function(i,t){t===void 0&&(t=0);var e=_(i,"x","step");return R.runKernelFunc(function(n){return n.step(e,t)},{$x:e},function(n){return{$x:function(){return De(n)}}})}}),n2=F({tan_:function(i){var t=_(i,"x","tan");return R.runKernelFunc(function(e,n){var r=e.tan(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return e.div(r.cos().square())}}})}}),r2=F({tanh_:function(i){var t=_(i,"x","tanh");return R.runKernelFunc(function(e,n){var r=e.tanh(t);return n([r]),r},{x:t},function(e,n){var r=n[0];return{x:function(){return Y(1).sub(r.square()).mulStrict(e)}}},"Tanh",{},null,[!0])}});function Dm(i,t,e,n,r,o){var a,s,u=_(i,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return r!=null&&(a=_(r,"scale","batchNorm")),n!=null&&(s=_(n,"offset","batchNorm")),E(u.rank===2,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),E(c.rank===2||c.rank===1,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),E(l.rank===2||l.rank===1,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+l.rank+"."}),a!=null&&E(a.rank===2||a.rank===1,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+a.rank+"."}),s!=null&&E(s.rank===2||s.rank===1,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),Wi(u,c,l,s,a,o)}function Sm(i,t,e,n,r,o){var a,s,u=_(i,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return r!=null&&(a=_(r,"scale","batchNorm")),n!=null&&(s=_(n,"offset","batchNorm")),E(u.rank===3,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),E(c.rank===3||c.rank===1,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),E(l.rank===3||l.rank===1,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+l.rank+"."}),a!=null&&E(a.rank===3||a.rank===1,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+a.rank+"."}),s!=null&&E(s.rank===3||s.rank===1,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),Wi(u,c,l,s,a,o)}function Am(i,t,e,n,r,o){var a,s,u=_(i,"x","batchNorm"),c=_(t,"mean","batchNorm"),l=_(e,"variance","batchNorm");return r!=null&&(a=_(r,"scale","batchNorm")),n!=null&&(s=_(n,"offset","batchNorm")),E(u.rank===4,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),E(c.rank===4||c.rank===1,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),E(l.rank===4||l.rank===1,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+l.rank+"."}),a!=null&&E(a.rank===4||a.rank===1,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+a.rank+"."}),s!=null&&E(s.rank===4||s.rank===1,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),Wi(u,c,l,s,a,o)}function Wi(i,t,e,n,r,o){o==null&&(o=.001);var a,s,u,c=_(i,"x","batchNorm"),l=_(t,"mean","batchNorm"),f=_(e,"variance","batchNorm");r!=null&&(a=_(r,"scale","batchNorm")),n!=null&&(s=_(n,"offset","batchNorm")),E(l.rank===f.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),E(s==null||l.rank===s.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),E(a==null||l.rank===a.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),u=c.rank===0||c.rank===1?c.as4D(1,1,1,c.size):c.rank===2?c.as4D(1,1,c.shape[0],c.shape[1]):c.rank===3?c.as4D(1,c.shape[0],c.shape[1],c.shape[2]):c;var h=[c,l,f,a];return R.runKernelFunc(function(p,d){var m=p.batchNormalization(u,Do(l),Do(f),o,Do(a),Do(s));return d([c,l,f,a]),m},{x:c,mean:l,variance:f,scale:a,offset:s},function(p,d){var m=d,v=m[0],g=m[1],x=m[2],w=m[3],y=w??Y(1),b=Qe(g.shape,u.shape),C=[];if(g.rank===1){for(var S=0;S<u.shape.length-1;++S)C.push(u.shape[S]);C.push(1)}var A=v.sub(g),k=p.mul(y),D=km(x.add(Y(o))),T=D.mul(D).mul(D).mul(Y(-.5));return{x:function(){return g.rank===1?p.mul(ar(D.as4D(1,1,1,g.shape[0]),C)).mul(y).reshape(v.shape):p.mul(D).mul(y).reshape(v.shape)},mean:function(){var I=D.mul(Y(-1)).mul(k);return g.rank===1&&(I=I.sum(b)),I.reshape(g.shape)},variance:function(){var I=T.mul(A).mul(k);return g.rank===1&&(I=I.sum(b)),I.reshape(g.shape)},scale:function(){var I=A.mul(D),W=p.mul(I);return g.rank===1&&(W=W.sum(b)),W.reshape(g.shape)},offset:function(){var I=p;return g.rank===1&&(I=I.sum(b)),I.reshape(g.shape)}}},"BatchNormalization",{varianceEpsilon:o},h).reshape(c.shape)}function Do(i){return i==null?null:i.rank===0?i.as1D():i.rank===1?i:i.rank===2?i.as4D(1,1,i.shape[0],i.shape[1]):i.rank===3?i.as4D(1,i.shape[0],i.shape[1],i.shape[2]):i}function sa(){Sd("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var i2=F({batchNormalization2d_:function(i,t,e,n,r,o){return n===void 0&&(n=.001),sa(),Dm(i,t,e,o,r,n)}}),o2=F({batchNormalization3d_:function(i,t,e,n,r,o){return n===void 0&&(n=.001),sa(),Sm(i,t,e,o,r,n)}}),a2=F({batchNormalization4d_:function(i,t,e,n,r,o){return n===void 0&&(n=.001),sa(),Am(i,t,e,o,r,n)}}),s2=F({batchNormalization_:function(i,t,e,n,r,o){return n===void 0&&(n=.001),sa(),Wi(i,t,e,o,r,n)}}),wc=F({batchNorm_:Wi}),u2=F({batchNorm2d_:Dm}),c2=F({batchNorm3d_:Sm}),l2=F({batchNorm4d_:Am}),ua=F({logicalAnd_:function(i,t){var e=_(i,"a","logicalAnd","bool"),n=_(t,"b","logicalAnd","bool");return ye(e.shape,n.shape),R.runKernelFunc(function(r){return r.logicalAnd(e,n)},{a:e,b:n},null,"LogicalAnd")}}),f2=F({logicalNot_:function(i){var t=_(i,"x","logicalNot","bool");return R.runKernelFunc(function(e){return e.logicalNot(t)},{$x:t})}}),Fm=F({logicalOr_:function(i,t){var e=_(i,"a","logicalOr","bool"),n=_(t,"b","logicalOr","bool");return ye(e.shape,n.shape),R.runKernelFunc(function(r){return r.logicalOr(e,n)},{$a:e,$b:n})}}),h2=F({logicalXor_:function(i,t){var e=_(i,"a","logicalXor","bool"),n=_(t,"b","logicalXor","bool");return ye(e.shape,n.shape),Fm(i,t).logicalAnd(ua(i,t).logicalNot())}}),lr=F({where_:function(i,t,e){var n=_(t,"a","where"),r=_(e,"b","where"),o=_(i,"condition","where","bool");return Ae(n.shape,r.shape,"Error in where: "),o.rank===1?E(o.shape[0]===n.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):Ae(o.shape,r.shape,"Error in where: "),R.runKernelFunc(function(a,s){var u=a.select(o,n,r);return s([o]),u},{$condition:o,$a:n,$b:r},function(a,s){var u=s[0];return{$condition:function(){return De(u).toFloat()},$a:function(){return a.mul(u.cast(a.dtype))},$b:function(){return a.mul(u.logicalNot().cast(a.dtype))}}})}}),Rm=function(i){return te(this,void 0,void 0,function(){var t,e,n;return ne(this,function(r){switch(r.label){case 0:return[4,(t=_(i,"condition","whereAsync","bool")).data()];case 1:return e=r.sent(),n=vc(t.shape,e),i!==t&&t.dispose(),[2,n]}})})},se=F({add_:function(i,t){var e,n=_(i,"a","add"),r=_(t,"b","add");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a){return a.add(n,r)},{a:n,b:r},function(a){return{a:function(){var s=a,u=Qe(n.shape,o);return u.length>0&&(s=s.sum(u)),s.reshape(n.shape)},b:function(){var s=a,u=Qe(r.shape,o);return u.length>0&&(s=s.sum(u)),s.reshape(r.shape)}}},"Add")}}),p2=F({addN_:function(i){E(Array.isArray(i),function(){return"The argument passed to tf.addN() must be a list of tensors"}),E(i.length>=1,function(){return"Must pass at least one tensor to tf.addN(), but got "+i.length});var t=i.map(function(r,o){return _(r,"tensors"+o,"addN")}),e=t[0];t.forEach(function(r){if(r.dtype!==e.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),t.forEach(function(r){if(!Je(r.shape,e.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});var n=t;return R.runKernelFunc(function(r){return r.addN(t)},n,function(r){var o={};return t.forEach(function(a,s){o[s]=function(){return r.clone()}}),o},"AddN")}}),d2=F({addStrict_:function(i,t){var e=_(i,"a","addStrict"),n=_(t,"b","addStrict");return Ae(e.shape,n.shape,"Error in addStrict: "),e.add(n)}}),m2=F({atan2_:function(i,t){var e,n=_(i,"a","atan2"),r=_(t,"b","atan2");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a,s){var u=a.atan2(n,r);return s([n,r]),u},{$a:n,$b:r},function(a,s){var u=s[0],c=s[1];return{$a:function(){var l=se(u.square(),c.square()),f=a.mul(c.div(l)),h=Qe(u.shape,o);return h.length>0&&(f=f.sum(h)),f.reshape(u.shape)},$b:function(){var l=se(u.square(),c.square()),f=Li(a.mul(u.div(l))),h=Qe(c.shape,o);return h.length>0&&(f=f.sum(h)),f.reshape(c.shape)}}})}}),Ut=F({div_:function(i,t){var e,n=_(i,"a","div"),r=_(t,"b","div");if(e=qe(n,r),n=e[0],r=e[1],n.dtype==="int32"&&r.dtype==="int32")return Im(n,r);var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a,s){var u=a.realDivide(n,r);return s([n,r]),u},{a:n,b:r},function(a,s){var u=s[0],c=s[1];return{a:function(){var l=a.div(c.toFloat()),f=Qe(u.shape,o);return f.length>0?l.sum(f).reshape(u.shape):l},b:function(){var l=a.mul(u.toFloat()),f=Qe(c.shape,o);f.length>0&&(l=l.sum(f).reshape(c.shape));var h=c.square();return l.div(h.toFloat()).neg()}}},"Div")}}),v2=F({divNoNan_:function(i,t){var e,n=_(i,"a","div"),r=_(t,"b","div");n=(e=qe(n,r))[0],r=e[1];var o=Ut(n,r),a=De(o),s=r.equal(a);return lr(s,a,o)}}),g2=F({divStrict_:function(i,t){var e=_(i,"a","div"),n=_(t,"b","div");return Ae(e.shape,n.shape,"Error in divideStrict: "),e.div(n)}}),Im=F({floorDiv_:function(i,t){var e,n=_(i,"a","floorDiv"),r=_(t,"b","floorDiv");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a,s){var u=a.floorDiv(n,r);return s([n,r]),u},{a:n,b:r},function(a,s){var u=s[0],c=s[1];return{a:function(){var l=a.div(c.toFloat()),f=Qe(u.shape,o);return f.length>0?l.sum(f).reshape(u.shape):l},b:function(){var l=a.mul(u.toFloat()),f=Qe(c.shape,o);f.length>0&&(l=l.sum(f).reshape(c.shape));var h=c.square();return l.div(h.toFloat()).neg()}}},"FloorDiv")}}),Cc=F({maximum_:function(i,t){var e,n=_(i,"a","maximum"),r=_(t,"b","maximum");return e=qe(n,r),n=e[0],r=e[1],n.dtype==="bool"&&(n=n.toInt(),r=r.toInt()),ye(n.shape,r.shape),R.runKernelFunc(function(o,a){var s=o.maximum(n,r);return a([n,r]),s},{a:n,b:r},function(o,a){var s=a[0],u=a[1];return{a:function(){return o.mul(s.greaterEqual(u).toFloat())},b:function(){return o.mul(s.less(u).toFloat())}}},"Maximum")}}),y2=F({maximumStrict_:function(i,t){var e=_(i,"a","maximumStrict"),n=_(t,"b","maximumStrict");return Ae(e.shape,n.shape,"Error in maximumStrict: "),e.maximum(n)}}),Tm=F({minimum_:function(i,t){var e,n=_(i,"a","minimum"),r=_(t,"b","minimum");return e=qe(n,r),n=e[0],r=e[1],n.dtype==="bool"&&(n=n.toInt(),r=r.toInt()),ye(n.shape,r.shape),R.runKernelFunc(function(o,a){var s=o.minimum(n,r);return a([n,r]),s},{a:n,b:r},function(o,a){var s=a[0],u=a[1];return{a:function(){return o.mul(s.lessEqual(u).toFloat())},b:function(){return o.mul(s.greater(u).toFloat())}}},"Minimum")}}),x2=F({minimumStrict_:function(i,t){var e=_(i,"a","minimumStrict"),n=_(t,"b","minimumStrict");return Ae(e.shape,n.shape,"Error in minimumStrict: "),e.minimum(n)}}),b2=F({mod_:function(i,t){var e,n=_(i,"a","mod"),r=_(t,"b","mod");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a,s){var u=a.mod(n,r);return s([n,r]),u},{$a:n,$b:r},function(a,s){var u=s[0],c=s[1];return{$a:function(){var l=Qe(u.shape,o);return l.length>0?a.sum(l).reshape(u.shape):a},$b:function(){var l=a.mul(u.div(c).floor().neg()),f=Qe(c.shape,o);return f.length>0?l.sum(f).reshape(c.shape):l}}})}}),w2=F({modStrict_:function(i,t){var e=_(i,"a","modStrict"),n=_(t,"b","modStrict");return Ae(e.shape,n.shape,"Error in modStrict: "),e.mod(n)}}),je=F({mul_:function(i,t){var e,n=_(i,"a","mul"),r=_(t,"b","mul");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a,s){var u=a.multiply(n,r);return s([n,r]),u},{a:n,b:r},function(a,s){var u=s[0],c=s[1];return{a:function(){var l=a.mul(c.toFloat()),f=Qe(u.shape,o);return f.length>0?l.sum(f).reshape(u.shape):l},b:function(){var l=a.mul(u.toFloat()),f=Qe(c.shape,o);return f.length>0?l.sum(f).reshape(c.shape):l}}},"Mul")}}),C2=F({mulStrict_:function(i,t){var e=_(i,"a","mul"),n=_(t,"b","mul");return Ae(e.shape,n.shape,"Error in multiplyStrict: "),e.mul(n)}}),Yo=F({pow_:function(i,t){var e,n=_(i,"base","pow"),r=_(t,"exp","pow");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape),a=[n,r];return R.runKernelFunc(function(s,u){var c=s.pow(n,r);return u([n,r,c]),c},{a:n,b:r},function(s,u){var c=u[0],l=u[1],f=u[2];return{a:function(){var h=l.toFloat(),p=s.mul(h.mul(c.pow(h.sub(Y(1))))),d=Qe(c.shape,o);return d.length>0&&(p=p.sum(d)),p.reshape(c.shape)},b:function(){var h=c.greater(0),p=c.log().where(h,De(c)),d=s.mul(f.mul(p)),m=Qe(l.shape,o);return m.length>0&&(d=d.sum(m)),d.reshape(l.shape)}}},"Pow",{},a,[!0])}}),_2=F({powStrict_:function(i,t){return Ae(i.shape,t.shape,"Error in powStrict: "),i.pow(t)}}),E2=F({squaredDifferenceStrict_:function(i,t){var e=_(i,"a","squaredDifferenceStrict"),n=_(t,"b","squaredDifferenceStrict");return Ae(e.shape,n.shape,"Error in squaredDifferenceStrict: "),e.squaredDifference(n)}}),Oe=F({sub_:function(i,t){var e,n=_(i,"a","sub"),r=_(t,"b","sub");e=qe(n,r),n=e[0],r=e[1];var o=ye(n.shape,r.shape);return R.runKernelFunc(function(a){return a.subtract(n,r)},{a:n,b:r},function(a){return{a:function(){var s=a,u=Qe(n.shape,o);return u.length>0&&(s=s.sum(u)),s.reshape(n.shape)},b:function(){var s=a,u=Qe(r.shape,o);return u.length>0&&(s=s.sum(u)),s.neg().reshape(r.shape)}}},"Sub")}}),k2=F({subStrict_:function(i,t){var e=_(i,"a","subStrict"),n=_(t,"b","subStrict");return Ae(e.shape,n.shape,"Error in subStrict: "),e.sub(n)}}),Nm=F({equal_:function(i,t){var e,n=_(i,"a","equal"),r=_(t,"b","equal");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o){return o.equal(n,r)},{$a:n,$b:r})}}),D2=F({equalStrict_:function(i,t){var e=_(i,"a","equalStrict"),n=_(t,"b","equalStrict");return Ae(e.shape,n.shape,"Error in equalStrict: "),e.equal(n)}}),S2=F({greater_:function(i,t){var e,n=_(i,"a","greater"),r=_(t,"b","greater");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o){return o.greater(n,r)},{a:n,b:r},null,"Greater")}}),Pm=F({greaterEqual_:function(i,t){var e,n=_(i,"a","greaterEqual"),r=_(t,"b","greaterEqual");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o,a){var s=o.greaterEqual(n,r);return a([n,r]),s},{a:n,b:r},function(o,a){var s=a[0],u=a[1];return{a:function(){return De(s)},b:function(){return De(u)}}},"GreaterEqual")}}),A2=F({greaterEqualStrict_:function(i,t){var e=_(i,"a","greaterEqualStrict"),n=_(t,"b","greaterEqualStrict");return Ae(e.shape,n.shape,"Error in greaterEqualStrict: "),e.greaterEqual(n)}}),F2=F({greaterStrict_:function(i,t){var e=_(i,"a","greaterStrict"),n=_(t,"b","greaterStrict");return Ae(e.shape,n.shape,"Error in greaterStrict: "),e.greater(n)}}),R2=F({less_:function(i,t){var e,n=_(i,"a","less"),r=_(t,"b","less");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o){return o.less(n,r)},{a:n,b:r},null,"Less")}}),I2=F({lessEqual_:function(i,t){var e,n=_(i,"a","lessEqual"),r=_(t,"b","lessEqual");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o,a){var s=o.lessEqual(n,r);return a([n,r]),s},{a:n,b:r},null,"LessEqual")}}),T2=F({lessEqualStrict_:function(i,t){var e=_(i,"a","lessEqualStrict"),n=_(t,"b","lessEqualStrict");return Ae(e.shape,n.shape,"Error in lessEqualStrict: "),e.lessEqual(n)}}),N2=F({lessStrict_:function(i,t){var e=_(i,"a","lessStrict"),n=_(t,"b","lessStrict");return Ae(e.shape,n.shape,"Error in lessStrict: "),e.less(n)}}),P2=F({notEqual_:function(i,t){var e,n=_(i,"a","notEqual"),r=_(t,"b","notEqual");return e=qe(n,r),n=e[0],r=e[1],ye(n.shape,r.shape),R.runKernelFunc(function(o){return o.notEqual(n,r)},{a:n,b:r},null,"NotEqual")}}),M2=F({notEqualStrict_:function(i,t){var e=_(i,"a","notEqualStrict"),n=_(t,"b","notEqualStrict");return Ae(e.shape,n.shape,"Error in notEqualStrict: "),e.notEqual(n)}});function Ep(i,t){for(var e=[],n=i;n<t;++n)e.push(n);return e}function kp(i){for(var t=[],e=0;e<i.length;++e)for(var n=0;n<i[e].length;++n)t.push(i[e][n]);return t}var _c=F({gather_:function(i,t,e){e===void 0&&(e=0);var n=_(i,"x","gather"),r=_(t,"indices","gather","int32");e=Ze(e,n.shape)[0];var o=function(a,s,u){for(var c=a.shape[u],l=[],f=1,h=1,p=0;p<u;p++)l.push(a.shape[p]),f*=a.shape[p];for(p=0;p<s.rank;p++)l.push(s.shape[p]);for(p=u+1;p<a.rank;p++)l.push(a.shape[p]),h*=a.shape[p];return{batchSize:f,sliceSize:h,dimSize:c,outputShape:l}}(n,r,e);return R.runKernelFunc(function(a,s){var u=a.gather(n,r.flatten(),e);return s([r]),u},{x:n,indices:r},function(a,s){var u=s[0];return{x:function(){var c=n.shape,l=u.size,f=c.slice(0,e),h=f.length,p=c.slice(e,c.length).slice(1),d=p.length,m=Ep(0,h),v=Ep(h+1,h+1+d),g=kp([f,[l],p]),x=a.reshape(g),w=u.reshape([l]),y=kp([[h],m,v]),b=x.transpose(y),C=Mm(b,w,n.shape[e]),S=ea(y);return C=C.transpose(S)},indices:function(){return u}}},"Gather",{axis:e}).reshape(o.outputShape)}}),Mm=F({unsortedSegmentSum_:function(i,t,e){var n=_(i,"x","unsortedSegmentSum"),r=_(t,"segmentIds","unsortedSegmentSum","int32");return E(Ge(e),function(){return"numSegments must be of dtype int"}),R.runKernelFunc(function(o,a){var s=o.unsortedSegmentSum(n,r,e);return a([r]),s},{$x:n},function(o,a){var s=a[0];return{$x:function(){return function(u,c){for(var l=Cc(c,De(c)),f=_c(u,l),h=Pm(c,Y(0,"int32")),p=f.rank-h.rank,d=0;d<p;++d)h=xt(h,d+1);h=ua(h,Gr(f.shape,"bool"));var m=De(f);return lr(h,f,m)}(o,s)}}})}}),O2=function(i,t,e){return te(this,void 0,void 0,function(){var n,r,o,a,s,u,c,l,f,h,p,d,m;return ne(this,function(v){switch(v.label){case 0:for(n=_(i,"tensor","boolMask"),r=_(t,"mask","boolMask","bool"),o=e??0,a=r.rank,s=n.shape,E(a>0,function(){return"mask cannot be scalar"}),Ae(s.slice(o,o+a),r.shape,"mask's shape must match the first K dimensions of tensor's shape,"),u=1,c=o;c<o+a;c++)u*=s[c];return l=s.slice(0,o).concat([u],s.slice(o+a)),f=n.reshape(l),h=r.reshape([-1]),[4,Rm(h)];case 1:return p=v.sent(),d=p.squeeze([1]),m=_c(f,d,o),i!==n&&n.dispose(),t!==r&&r.dispose(),d.dispose(),f.dispose(),h.dispose(),p.dispose(),[2,m]}})})};function Om(i,t,e,n,r,o,a){o===void 0&&(o="NHWC"),E(i.length===t.rank,function(){return"Length of inShape ("+i.length+") and rank of dy ("+t.rank+") must match"});var s=i,u=t,c=!1;t.rank===3&&(c=!0,u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]),s=[1,i[0],i[1],i[2]]),E(s.length===4,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+s.length+"."}),E(u.rank===4,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),E(e.rank===4,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+e.rank});var l=o==="NHWC"?s[3]:s[1],f=o==="NHWC"?u.shape[3]:u.shape[1];E(l===e.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+e.shape[2]+"."}),E(f===e.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+f+") must match output depth for filter "+e.shape[3]+"."}),a!=null&&E(Ge(r),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."});var h=oa(o),p=Hn(s,e.shape,n,1,r,a,!1,h),d=R.runKernelFunc(function(m,v){var g=m.conv2dDerInput(u,e,p);return v([e,u]),g},{dy4D:u,filter:e},function(m,v){var g=v[0],x=v[1];return{dy4D:function(){return ut(m,g,n,r,o,1,a)},filter:function(){return Ec(m,x,g.shape,n,r,o,a)}}});return c?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}function xu(i){var t=function(o){return typeof o=="number"?[o,o,o]:o.length===2?[o[0],o[1],1]:o}(i),e=t[0],n=t[1],r=t[2];return e===1&&n===1&&r===1}function Bm(i,t,e,n,r){E(i.length===t.rank,function(){return"Length of inShape ("+i.length+") and rank of dy ("+t.rank+") must match"});var o=i,a=t,s=!1;t.rank===4&&(s=!0,a=t.as5D(1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]),o=[1,i[0],i[1],i[2],i[3]]);var u=o[4],c=a.shape[4];E(o.length===5,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+o.length+"."}),E(a.rank===5,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+a.rank}),E(e.rank===5,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+e.rank}),E(u===e.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+e.shape[3]+"."}),E(c===e.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+c+") must match output depth for filter "+e.shape[4]+"."});var l=Ni(o,e.shape,n,1,r),f=R.runKernelFunc(function(h){return h.conv3dDerInput(a,e,l)},{dy5D:a});return s?f.as4D(f.shape[1],f.shape[2],f.shape[3],f.shape[4]):f}var B2=F({conv1d_:function(i,t,e,n,r,o,a){r===void 0&&(r="NWC"),o===void 0&&(o=1);var s=_(i,"x","conv1d"),u=_(t,"filter","conv1d"),c=s,l=!1;s.rank===2&&(l=!0,c=s.as3D(1,s.shape[0],s.shape[1])),E(c.rank===3,function(){return"Error in conv1d: input must be rank 3, but got rank "+c.rank+"."}),E(u.rank===3,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),a!=null&&E(Ge(n),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+n+"."}),E(c.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+c.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),E(kt(e,o),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+e+" and dilation '"+o+"'"}),E(r==="NWC",function(){return"Error in conv1d: got dataFormat of "+r+" but only NWC is currently supported."});var f=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),h=c.as4D(c.shape[0],1,c.shape[1],c.shape[2]),p=ut(h,f,[1,e],n,"NHWC",[1,o],a);return l?p.as2D(p.shape[2],p.shape[3]):p.as3D(p.shape[0],p.shape[2],p.shape[3])}}),ut=F({conv2d_:function(i,t,e,n,r,o,a){r===void 0&&(r="NHWC"),o===void 0&&(o=[1,1]);var s=_(i,"x","conv2d"),u=_(t,"filter","conv2d"),c=s,l=!1;s.rank===3&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),E(c.rank===4,function(){return"Error in conv2d: input must be rank 4, but got rank "+c.rank+"."}),E(u.rank===4,function(){return"Error in conv2d: filter must be rank 4, but got rank "+u.rank+"."}),a!=null&&E(Ge(n),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+n+"."});var f=r==="NHWC"?c.shape[3]:c.shape[1];E(f===u.shape[2],function(){return"Error in conv2d: depth of input ("+f+") must match input depth for filter "+u.shape[2]+"."}),E(kt(e,o),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+o+"'"});var h=oa(r),p=Hn(c.shape,u.shape,e,o,n,a,!1,h),d=[u,c],m=R.runKernelFunc(function(v,g){var x=v.conv2d(c,u,p);return g([u,c]),x},{x:c,filter:u},function(v,g){var x=g,w=x[0],y=x[1];return E(cr(o),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+o+"'"}),{x:function(){return Lm(y.shape,v,w,e,n,r)},filter:function(){return Ec(y,v,w.shape,e,n,r)}}},"Conv2D",p,d);return l?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}}),L2=F({conv3d_:function(i,t,e,n,r,o){r===void 0&&(r="NDHWC"),o===void 0&&(o=[1,1,1]);var a=_(i,"x","conv3d"),s=_(t,"filter","conv3d"),u=a,c=!1;a.rank===4&&(c=!0,u=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3])),E(u.rank===5,function(){return"Error in conv3d: input must be rank 5, but got rank "+u.rank+"."}),E(s.rank===5,function(){return"Error in conv3d: filter must be rank 5, but got rank "+s.rank+"."}),E(u.shape[4]===s.shape[3],function(){return"Error in conv3d: depth of input ("+u.shape[4]+") must match input depth for filter "+s.shape[3]+"."}),E(function(h,p){return xu(h)||xu(p)}(e,o),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+o+"'"}),E(r==="NDHWC",function(){return"Error in conv3d: got dataFormat of "+r+" but only NDHWC is currently supported."});var l=Ni(u.shape,s.shape,e,o,n),f=R.runKernelFunc(function(h,p){var d=h.conv3d(u,s,l);return p([u,s]),d},{x:u,$filter:s},function(h,p){E(xu(o),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+o+"'"});var d=p[0],m=p[1];return{x:function(){return Bm(d.shape,h,m,e,n)},$filter:function(){return function(v,g,x,w,y){var b=v;v.rank===4&&(b=v.as5D(1,v.shape[0],v.shape[1],v.shape[2],v.shape[3]));var C=g;C.rank===4&&(C=g.as5D(1,g.shape[0],g.shape[1],g.shape[2],g.shape[3])),E(b.rank===5,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+b.shape+"."}),E(C.rank===5,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+C.shape+"."}),E(x.length===5,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+x+"."}),E(b.shape[4]===x[3],function(){return"Error in conv3dDerFilter: depth of input "+b.shape[4]+") must match input depth in filter ("+x[3]+"."}),E(C.shape[4]===x[4],function(){return"Error in conv3dDerFilter: depth of dy ("+C.shape[4]+") must match output depth for filter ("+x[4]+")."});var S=Ni(b.shape,x,w,1,y);return R.runKernelFunc(function(A){return A.conv3dDerFilter(b,C,S)},{x5D:b,dy5D:C})}(d,h,m.shape,e,n)}}});return c?f.as4D(f.shape[1],f.shape[2],f.shape[3],f.shape[4]):f}}),Ec=F({conv2dDerFilter_:function(i,t,e,n,r,o,a){o===void 0&&(o="NHWC");var s=i;i.rank===3&&(s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2]));var u=t;u.rank===3&&(u=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),E(s.rank===4,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),E(u.rank===4,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),E(e.length===4,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+e+"."});var c=o==="NHWC"?s.shape[3]:s.shape[1],l=o==="NHWC"?u.shape[3]:u.shape[1];E(c===e[2],function(){return"Error in conv2dDerFilter: depth of input "+c+") must match input depth in filter ("+e[2]+"."}),E(l===e[3],function(){return"Error in conv2dDerFilter: depth of dy ("+l+") must match output depth for filter ("+e[3]+")."}),a!=null&&E(Ge(r),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+r+"."});var f=oa(o),h=Hn(s.shape,e,n,1,r,a,!1,f);return R.runKernelFunc(function(p){return p.conv2dDerFilter(s,u,h)},{x4D:s,dy4D:u})}}),Lm=F({conv2dDerInput_:Om}),zi=F({depthwiseConv2d_:function(i,t,e,n,r,o,a){r===void 0&&(r="NHWC"),o===void 0&&(o=[1,1]);var s=_(i,"x","depthwiseConv2d"),u=_(t,"filter","depthwiseConv2d"),c=s,l=!1;s.rank===3&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),E(c.rank===4,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),E(u.rank===4,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+u.rank+"."}),E(c.shape[3]===u.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+u.shape[2]+"."}),o==null&&(o=[1,1]),E(kt(e,o),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+o+"'"}),a!=null&&E(Ge(n),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+n+"."});var f=Hn(c.shape,u.shape,e,o,n,a,!0),h=[c,u],p=R.runKernelFunc(function(d,m){var v=d.depthwiseConv2D(c,u,f);return m([c,u]),v},{x:c,filter:u},function(d,m){E(cr(o),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+o+"'"});var v=m[0],g=m[1];return{x:function(){return Wm(v.shape,d,g,f)},filter:function(){return zm(v,d,g.shape,f)}}},"DepthwiseConv2dNative",f,h);return l?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p}}),Wm=F({depthwiseConv2dDerInput_:function(i,t,e,n){var r=t,o=!1;t.rank===3&&(o=!0,r=t.as4D(1,t.shape[0],t.shape[1],t.shape[2]));var a=R.runKernelFunc(function(s){return s.depthwiseConv2DDerInput(r,e,n)},{dy4D:r});return o?a.as3D(a.shape[1],a.shape[2],a.shape[3]):a}}),zm=F({depthwiseConv2dDerFilter_:function(i,t,e,n){var r=i;i.rank===3&&(r=i.as4D(1,i.shape[0],i.shape[1],i.shape[2]));var o=t;return o.rank===3&&(o=t.as4D(1,t.shape[0],t.shape[1],t.shape[2])),R.runKernelFunc(function(a){return a.depthwiseConv2DDerFilter(r,o,n)},{x4D:r,dy4D:o})}}),qi=F({separableConv2d_:function(i,t,e,n,r,o,a){o===void 0&&(o=[1,1]),a===void 0&&(a="NHWC");var s=_(i,"x","separableConv2d"),u=_(t,"depthwiseFilter","separableConv2d"),c=_(e,"pointwiseFilter","separableConv2d"),l=s,f=!1;if(s.rank===3&&(f=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),a==="NCHW")throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");E(l.rank===4,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+l.rank+"."}),E(u.rank===4,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+u.rank+"."}),E(c.rank===4,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+u.rank+"."}),E(c.shape[0]===1,function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+c.shape[0]+"."}),E(c.shape[1]===1,function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+c.shape[1]+"."});var h=u.shape[2],p=u.shape[3];E(c.shape[2]===h*p,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+h*p+", but got "+c.shape[2]+"."});var d=zi(l,u,n,r,a,o),m=ut(d,c,1,"valid",a);return f?m.as3D(m.shape[1],m.shape[2],m.shape[3]):m}}),W2=F({conv2dTranspose_:function(i,t,e,n,r,o){return Om(e,_(i,"x","conv2dTranspose"),_(t,"filter","conv2dTranspose"),n,r,"NHWC",o)}}),z2=F({conv3dTranspose_:function(i,t,e,n,r){return Bm(e,_(i,"x","conv3dTranspose"),_(t,"filter","conv3dTranspose"),n,r)}}),Hr=F({matMul_:function(i,t,e,n){var r;e===void 0&&(e=!1),n===void 0&&(n=!1);var o=_(i,"a","matMul"),a=_(t,"b","matMul");r=qe(o,a),o=r[0],a=r[1];var s=e?o.shape[o.rank-2]:o.shape[o.rank-1],u=n?a.shape[a.rank-1]:a.shape[a.rank-2],c=e?o.shape[o.rank-1]:o.shape[o.rank-2],l=n?a.shape[a.rank-2]:a.shape[a.rank-1],f=o.shape.slice(0,-2),h=a.shape.slice(0,-2),p=re(f),d=re(h);E(o.rank>=2&&a.rank>=2&&o.rank===a.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+o.rank+" and "+a.rank+"."}),E(Je(f,h),function(){return"Error in matMul: outer dimensions ("+f+") and ("+h+") of Tensors with shapes "+o.shape+" and "+a.shape+" must match."}),E(s===u,function(){return"Error in matMul: inner shapes ("+s+") and ("+u+") of Tensors with shapes "+o.shape+" and "+a.shape+" and transposeA="+e+" and transposeB="+n+" must match."});var m=o.shape.slice(0,-2).concat([c,l]),v=e?o.as3D(p,s,c):o.as3D(p,c,s),g=n?a.as3D(d,l,u):a.as3D(d,u,l),x={transposeA:e,transposeB:n};return R.runKernelFunc(function(w,y){var b=w.batchMatMul(v,g,e,n);return y([v,g]),b},{a:v,b:g},function(w,y){var b=y,C=b[0],S=b[1];return e||n?!e&&n?{a:function(){return w.matMul(S,!1,!1)},b:function(){return w.matMul(C,!0,!1)}}:e&&!n?{a:function(){return S.matMul(w,!1,!0)},b:function(){return C.matMul(w,!1,!1)}}:{a:function(){return S.matMul(w,!0,!0)},b:function(){return w.matMul(C,!0,!0)}}:{a:function(){return w.matMul(S,!1,!0)},b:function(){return C.matMul(w,!0,!1)}}},"BatchMatMul",x).reshape(m)}}),q2=F({dot_:function(i,t){var e=_(i,"t1","dot"),n=_(t,"t2","dot");E(!(e.rank!==1&&e.rank!==2||n.rank!==1&&n.rank!==2),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+e.rank+" and "+n.rank+"."});var r=e.rank===1?e.size:e.shape[1],o=n.rank===1?n.size:n.shape[0];return E(r===o,function(){return"Error in dot: inner dimensions of inputs must match, but got "+r+" and "+o+"."}),e.rank===1&&n.rank===1?e.as2D(1,-1).matMul(n.as2D(-1,1)).asScalar():e.rank===1&&n.rank===2?e.as2D(1,-1).matMul(n.as2D(n.shape[0],n.shape[1])).as1D():e.rank===2&&n.rank===1?e.matMul(n.as2D(-1,1)).as1D():e.matMul(n.as2D(n.shape[0],n.shape[1]))}}),V2=F({outerProduct_:function(i,t){var e=_(i,"v1","outerProduct"),n=_(t,"v2","outerProduct");return E(e.rank===1&&n.rank===1,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+e.rank+" and "+n.rank+"."}),e.as2D(-1,1).matMul(n.as2D(1,-1))}}),Vi=F({reverse_:function(i,t){var e=_(i,"x","reverse");if(e.rank===0)return e.clone();var n=Ze(t,e.shape);return R.runKernelFunc(function(r){return r.reverse(e,n)},{$x:e},function(r){return{$x:function(){return r.reverse(n)}}}).reshapeAs(e)}}),U2=F({reverse1d_:function(i){var t=_(i,"x","reverse");return E(t.rank===1,function(){return"Error in reverse1D: x must be rank 1 but got rank "+t.rank+"."}),Vi(t,0)}}),j2=F({reverse2d_:function(i,t){var e=_(i,"x","reverse");return E(e.rank===2,function(){return"Error in reverse2D: x must be rank 2 but got rank "+e.rank+"."}),Vi(e,t)}}),G2=F({reverse3d_:function(i,t){var e=_(i,"x","reverse");return E(e.rank===3,function(){return"Error in reverse3D: x must be rank 3 but got rank "+e.rank+"."}),Vi(e,t)}}),H2=F({reverse4d_:function(i,t){var e=_(i,"x","reverse");return E(e.rank===4,function(){return"Error in reverse4D: x must be rank 4 but got rank "+e.rank+"."}),Vi(e,t)}});function qm(i,t,e,n,r,o){var a=_(i,"x","maxPool"),s=a,u=!1;a.rank===3&&(u=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),n==null&&(n=[1,1]),E(s.rank===4,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),E(kt(e,n),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+n+"'"}),o!=null&&E(Ge(r),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var c=Vr(s.shape,t,e,n,r,o);if(c.filterWidth===1&&c.filterHeight===1&&Je(c.inShape,c.outShape))return a.clone();var l=[s],f=R.runKernelFunc(function(h,p){var d=h.maxPool(s,c);return p([s,d]),d},{x:s},function(h,p){var d=p[0],m=p[1];return{x:function(){return function(v,g,x,w,y,b,C,S){var A=_(v,"dy","maxPoolBackprop"),k=_(g,"input","maxPoolBackprop"),D=_(x,"output","maxPoolBackprop");E(k.rank===A.rank,function(){return"Rank of input ("+k.rank+") does not match rank of dy ("+A.rank+")"}),b==null&&(b=[1,1]),E(kt(y,b),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+y+" and dilations '"+b+"'"}),E(A.rank===4,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+A.rank+"."}),E(k.rank===4,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+k.rank+"."}),S!=null&&E(Ge(C),function(){return"Error in maxPoolBackprop: pad must be an integer when using, dimRoundingMode "+S+" but got pad "+C+"."});var T=Vr(k.shape,w,y,b,C,S);return R.runKernelFunc(function(I){return I.maxPoolBackprop(A,k,D,T)},{$dy:A,$input:k})}(h,d,m,t,e,n,r)}}},"MaxPool",c,l);return u?f.as3D(f.shape[1],f.shape[2],f.shape[3]):f}function Vm(i,t,e,n,r,o){var a=_(i,"x","avgPool","float32");n==null&&(n=[1,1]),E(kt(e,n),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+n+"'"});var s=a,u=!1;a.rank===3&&(u=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),E(s.rank===4,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),o!=null&&E(Ge(r),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var c=Vr(s.shape,t,e,n,r,o);if(c.filterWidth===1&&c.filterHeight===1&&Je(c.inShape,c.outShape))return a.clone();var l=R.runKernelFunc(function(f){return f.avgPool(s,c)},{x:s},function(f){return{x:function(){return function(h,p,d,m,v,g){var x=_(h,"dy","avgPoolBackprop"),w=_(p,"input","avgPoolBackprop");E(w.rank===x.rank,function(){return"Rank of input ("+w.rank+") does not match rank of dy ("+x.rank+")"}),v==null&&(v=[1,1]),E(kt(m,v),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+m+" and dilations '"+v+"'"});var y=w,b=x,C=!1;w.rank===3&&(C=!0,y=w.as4D(1,w.shape[0],w.shape[1],w.shape[2]),b=x.as4D(1,x.shape[0],x.shape[1],x.shape[2])),E(b.rank===4,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+b.rank+"."}),E(y.rank===4,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+y.rank+"."});var S=Vr(y.shape,d,m,v,g),A=R.runKernelFunc(function(k){return k.avgPoolBackprop(b,y,S)},{dy4D:b,input4D:y});return C?A.as3D(A.shape[1],A.shape[2],A.shape[3]):A}(f,s,t,e,n,r)}}},"AvgPool",c);return l=l.cast(a.dtype),u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l}var He=F({maxPool_:function(i,t,e,n,r){return qm(i,t,e,1,n,r)}}),Fn=F({avgPool_:function(i,t,e,n,r){return Vm(i,t,e,1,n,r)}}),K2=F({pool_:function(i,t,e,n,r,o){r==null&&(r=[1,1]),o==null&&(o=1),n===0&&(n="valid");var a=_(i,"x","maxPool"),s=a,u=!1;a.rank===3&&(u=!0,s=a.as4D(1,a.shape[0],a.shape[1],a.shape[2])),E(kt(o,r),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+o+" and dilations '"+r+"'"});var c,l=Vr(s.shape,t,o,r,n),f=[l.dilationHeight,l.dilationWidth];c=n==="same"?function(y,b){var C=y.map(function(k,D){return k+(k-1)*(b[D]-1)}).map(function(k){return k-1}),S=C.map(function(k){return Math.floor(k/2)}),A=C.map(function(k,D){return k-S[D]});return C.map(function(k,D){return[S[D],A[D]]})}([l.filterHeight,l.filterWidth],f):[[0,0],[0,0]];var h=f[0]===1&&f[1]===1,p=function(y,b,C){var S=C.map(function(B){return B[0]}),A=C.map(function(B){return B[1]}),k=y.concat(S,A),D=b.map(function(B,L){return(B-k[L]%B)%B}),T=A.map(function(B,L){return B+D[L]}),I=b.map(function(B,L){return[S[L],T[L]]}),W=b.map(function(B,L){return[0,D[L]]});return[I,W]}([l.inHeight,l.inWidth],f,c),d=p[0],m=p[1],v=h?n:"valid",g=h?s:Pd(s,f,d),x=(e==="avg"?function(){return Vm(g,t,o,1,v)}:function(){return qm(g,t,o,1,v)})(),w=h?x:Id(x,f,m);return u?w.as3D(w.shape[1],w.shape[2],w.shape[3]):w}}),X2=F({maxPool3d_:function(i,t,e,n,r,o,a){o===void 0&&(o="NDHWC");var s=_(i,"x","maxPool3d"),u=s,c=!1;s.rank===4&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),a==null&&(a=[1,1,1]),E(u.rank===5,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),E(o==="NDHWC",function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+o}),E(kt(e,a),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),r!=null&&E(Ge(n),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+r+" but got pad "+n+"."});var l=Ti(u.shape,t,e,a,n,r,o),f=R.runKernelFunc(function(h,p){var d=h.maxPool3d(u,l);return p([u,d]),d},{x:u},function(h,p){var d=p[0],m=p[1];return{x:function(){return function(v,g,x,w,y,b,C,S){var A=_(v,"dy","maxPool3dBackprop"),k=_(g,"input","maxPool3dBackprop"),D=_(x,"output","maxPool3dBackprop"),T=A,I=k,W=D,B=!1;k.rank===4&&(B=!0,T=A.as5D(1,A.shape[0],A.shape[1],A.shape[2],A.shape[3]),I=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3]),W=D.as5D(1,D.shape[0],D.shape[1],D.shape[2],D.shape[3])),E(T.rank===5,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+T.rank+"."}),E(I.rank===5,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+I.rank+"."}),E(W.rank===5,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+W.rank+"."}),b==null&&(b=[1,1,1]),E(kt(y,b),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+y+" and dilations '"+b+"'"}),S!=null&&E(Ge(C),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+S+" but got pad "+C+"."});var L=Ti(I.shape,w,y,b,C,S),V=R.runKernelFunc(function(q){return q.maxPool3dBackprop(T,I,W,L)},{dy5D:T,input5D:I});return B?V.as4D(V.shape[1],V.shape[2],V.shape[3],V.shape[4]):V}(h,d,m,t,e,a,n,r)}}});return c?f.as4D(f.shape[1],f.shape[2],f.shape[3],f.shape[4]):f}}),$2=F({avgPool3d_:function(i,t,e,n,r,o,a){o===void 0&&(o="NDHWC");var s=_(i,"x","avgPool3d","float32"),u=s,c=!1;s.rank===4&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),a==null&&(a=[1,1,1]),E(u.rank===5,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),E(o==="NDHWC",function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+o}),E(kt(e,a),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+e+" and dilations '"+a+"'"}),r!=null&&E(Ge(n),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+r+" but got pad "+n+"."});var l=Ti(u.shape,t,e,a,n,r,o),f=R.runKernelFunc(function(h){return h.avgPool3d(u,l)},{x:u},function(h){return{x:function(){return function(p,d,m,v,g,x,w){var y=_(p,"dy","avgPool3dBackprop"),b=_(d,"input","avgPool3dBackprop"),C=y,S=b,A=!1;b.rank===4&&(A=!0,C=y.as5D(1,y.shape[0],y.shape[1],y.shape[2],y.shape[3]),S=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3])),E(C.rank===5,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+C.rank+"."}),E(S.rank===5,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+S.rank+"."}),g==null&&(g=[1,1,1]),E(kt(v,g),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+v+" and dilations '"+g+"'"}),w!=null&&E(Ge(x),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+w+" but got pad "+x+"."});var k=Ti(S.shape,m,v,g,x,w),D=R.runKernelFunc(function(T){return T.avgPool3dBackprop(C,S,k)},{dy5D:C,input5D:S});return A?D.as4D(D.shape[1],D.shape[2],D.shape[3],D.shape[4]):D}(h,u,t,e,a,n,r)}}});return f=f.cast(u.dtype),c?f.as4D(f.shape[1],f.shape[2],f.shape[3],f.shape[4]):f}}),Jt=F({slice_:function(i,t,e){var n,r,o=_(i,"x","slice");if(o.rank===0)throw new Error("Slicing scalar is not possible");(n=typeof t=="number"?[t].concat(new Array(o.rank-1).fill(0)):t.length<o.rank?t.concat(new Array(o.rank-t.length).fill(0)):t.slice()).forEach(function(u){E(u!==-1,function(){return"slice() does not support negative begin indexing."})}),r=(r=e==null?new Array(o.rank).fill(-1):typeof e=="number"?[e].concat(new Array(o.rank-1).fill(-1)):e.length<o.rank?e.concat(new Array(o.rank-e.length).fill(-1)):e).map(function(u,c){return u>=0?u:(E(u===-1,function(){return"Negative size values should be exactly -1 but got "+u+" for the slice() size at index "+c+"."}),o.shape[c]-n[c])}),zd(o,n,r);var a=o.shape,s={begin:n,size:r};return R.runKernelFunc(function(u){return u.slice(o,n,r)},{x:o},function(u){for(var c=[],l=0;l<u.rank;l++)c.push([n[l],a[l]-n[l]-r[l]]);return{x:function(){return u.pad(c)}}},"Slice",s)}}),Y2=F({slice1d_:function(i,t,e){var n=_(i,"x","slice1d");return E(n.rank===1,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+n.rank+" tensor"}),Jt(n,[t],[e])}}),J2=F({slice2d_:function(i,t,e){var n=_(i,"x","slice2d");return E(n.rank===2,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+n.rank+" tensor"}),Jt(n,t,e)}}),kc=F({slice3d_:function(i,t,e){var n=_(i,"x","slice3d");return E(n.rank===3,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+n.rank+" tensor"}),Jt(n,t,e)}}),Q2=F({slice4d_:function(i,t,e){var n=_(i,"x","slice4d");return E(n.rank===4,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+n.rank+" tensor"}),Jt(n,t,e)}});function Um(i,t,e,n,r){return t.rank<e.rank&&(t=t.reshape(Et(t.shape,n))),i.rank<e.rank&&(i=i.reshape(Et(i.shape,n))),{x:function(){var o=i.mul(e.equal(t).cast(i.dtype));return r==null?o:o.transpose(r)}}}var Z2=F({all_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","all","bool"),r=Ze(t,n.shape),o=r,a=Zt(o,n.rank);a!=null&&(n=n.transpose(a),o=en(o.length,n.rank));var s=R.runKernelFunc(function(c){return c.all(n,o)},{$x:n});if(e){var u=Et(s.shape,r);return s.reshape(u)}return s}}),eC=F({any_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","any","bool"),r=Ze(t,n.shape),o=r,a=Zt(o,n.rank);a!=null&&(n=n.transpose(a),o=en(o.length,n.rank));var s=R.runKernelFunc(function(c){return c.any(n,o)},{$x:n});if(e){var u=Et(s.shape,r);return s.reshape(u)}return s}}),tC=F({argMax_:function(i,t){t===void 0&&(t=0);var e=_(i,"x","argMax");t==null&&(t=0);var n=Ze(t,e.shape),r=Zt(n,e.rank);r!=null&&(e=e.transpose(r),n=en(n.length,e.rank));var o={axis:n[0]},a=[e];return R.runKernelFunc(function(s,u){var c=s.argMax(e,n[0]);return u([e]),c},{x:e},function(s,u){var c=u[0];return{x:function(){return De(c)}}},"ArgMax",o,a)}}),nC=F({argMin_:function(i,t){t===void 0&&(t=0);var e=_(i,"x","argMin");t==null&&(t=0);var n=Ze(t,e.shape),r=Zt(n,e.rank);return r!=null&&(e=e.transpose(r),n=en(n.length,e.rank)),R.runKernelFunc(function(o,a){var s=o.argMin(e,n[0]);return a([e]),s},{$x:e},function(o,a){var s=a[0];return{$x:function(){return De(s)}}})}}),rC=F({logSumExp_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","logSumExp"),r=Ze(t,n.shape),o=n.max(r,!0),a=n.sub(o).exp().sum(r).log(),s=o.reshape(a.shape).add(a);if(e){var u=Et(s.shape,r);return s.reshape(u)}return s}}),pr=F({max_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","max"),r=n,o=Ze(t,n.shape),a=o,s=Zt(a,n.rank);s!=null&&(n=n.transpose(s),a=en(a.length,n.rank));var u=[n],c=R.runKernelFunc(function(f,h){var p=f.max(n,a);return h([r,p]),p},{x:n},function(f,h){return Um(f,h[1],h[0],o,s)},"Max",{axes:a},u,[!0]);if(e){var l=Et(c.shape,o);c=c.reshape(l)}return c}}),iC=F({mean_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","mean"),r=Ze(t,n.shape),o=re(pt(n.shape,r)[1]);return ia(function(a){var s=Y(o);return{value:(s.dtype===a.dtype?a:a.cast(s.dtype)).div(s).sum(t,e),gradFunc:function(u){var c=a.shape.slice();return r.forEach(function(l){c[l]=1}),u.reshape(c).mul(Gr(a.shape,"float32")).div(o)}}})(n)}}),oC=F({min_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","min"),r=n,o=Ze(t,n.shape),a=o,s=Zt(a,n.rank);s!=null&&(n=n.transpose(s),a=en(a.length,n.rank));var u=[n],c=R.runKernelFunc(function(f,h){var p=f.min(n,a);return h([r,p]),p},{x:n},function(f,h){return Um(f,h[1],h[0],o,s)},"Min",{axes:a},u,[!0]);if(e){var l=Et(c.shape,o);c=c.reshape(l)}return c}}),aC=F({moments_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=Ze(t,(i=_(i,"x","moments")).shape),r=i.mean(n,e),o=r.shape;e||(o=Et(r.shape,n));var a=i.toFloat().sub(r.reshape(o)).square();return{mean:r,variance:a.mean(n,e)}}}),jm=F({sum_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","sum");n.dtype==="bool"&&(n=n.toInt());var r=Ze(t,n.shape);return ia(function(o){var a=Zt(r,o.rank),s=r,u=o;a!=null&&(u=o.transpose(a),s=en(s.length,o.rank));var c=function(p){var d=o.shape.slice();return r.forEach(function(m){d[m]=1}),p.reshape(d).mul(Gr(o.shape,"float32"))},l={axes:s},f=R.runKernelFunc(function(p){return p.sum(u,s)},{x:u},function(p){return{x:function(){return c(p)}}},"Sum",l);if(e){var h=Et(f.shape,r);f=f.reshape(h)}return{value:f,gradFunc:c}})(n)}}),sC=F({prod_:function(i,t,e){t===void 0&&(t=null),e===void 0&&(e=!1);var n=_(i,"x","prod");n.dtype==="bool"&&(n=n.toInt());var r=Ze(t,n.shape),o=Zt(r,n.rank),a=r,s=n;o!=null&&(s=n.transpose(o),a=en(a.length,n.rank));var u=R.runKernelFunc(function(l){return l.prod(s,a)},{permutedX:s});if(e){var c=Et(u.shape,r);u=u.reshape(c)}return u}}),Gm=F({elu_:function(i){var t=_(i,"x","elu");return R.runKernelFunc(function(e,n){var r=e.elu(t);return n([r]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){return R.runKernelFunc(function(o){return o.eluDer(e,r)},{dy:e,y:r})}}})}}),uC=F({leakyRelu_:function(i,t){t===void 0&&(t=.2);var e=_(i,"x","leakyRelu");return Cc(Y(t).mul(e),e)}}),Hm=F({prelu_:function(i,t){var e=_(i,"x","prelu"),n=_(t,"alpha","prelu");return R.runKernelFunc(function(r,o){var a=r.prelu(e,n);return o([e,n]),a},{x:e,alpha:n},function(r,o){var a=o[0],s=o[1],u=a.greater(0);return{x:function(){return lr(u,r,r.mul(s))},alpha:function(){var c=lr(u,De(r),r.mul(a)),l=Qe(s.shape,r.shape);return l.length>0&&(c=c.sum(l)),c.reshape(s.shape)}}},"Prelu")}}),Re=F({relu_:function(i){var t=_(i,"x","relu");return t.dtype==="bool"?t.toInt():R.runKernelFunc(function(e,n){var r=e.relu(t);return n([t]),r},{x:t},function(e,n){var r=n[0];return{x:function(){return e.mulStrict(r.step().toFloat())}}},"Relu")}}),Km=F({relu6_:function(i){var t=_(i,"x","relu6");return t.dtype==="bool"?t.toInt():R.runKernelFunc(function(e,n){var r=e.relu6(t);return n([t]),r},{x:t},function(e,n){var r=n[0],o=r.lessEqual(6).mul(r.step());return{x:function(){return e.mulStrict(o.toFloat())}}},"Relu6")}}),cC=F({selu_:function(i){var t=_(i,"x","selu");return R.runKernelFunc(function(e,n){var r=e.selu(t);return n([t]),r},{$x:t},function(e,n){var r=n[0];return{$x:function(){var o=r.greater(Y(0)),a=Y(yc),s=Y(xc),u=e.mul(s),c=e.mul(a).mul(r.toFloat().exp());return lr(o,u,c)}}})}}),jt=F({transpose_:function(i,t){var e=_(i,"x","transpose");if(t==null&&(t=e.shape.map(function(r,o){return o}).reverse()),E(e.rank===t.length,function(){return"Error in transpose: rank of input "+e.rank+" must match length of perm "+t+"."}),t.forEach(function(r){E(r>=0&&r<e.rank,function(){return"All entries in 'perm' must be between 0 and "+(e.rank-1)+" but got "+t})}),e.rank<=1)return e.clone();var n={perm:t};return R.runKernelFunc(function(r){return r.transpose(e,t)},{x:e},function(r){var o=ea(t);return{x:function(){return r.transpose(o)}}},"Transpose",n)}}),lC=F({localResponseNormalization_:function(i,t,e,n,r){t===void 0&&(t=5),e===void 0&&(e=1),n===void 0&&(n=1),r===void 0&&(r=.5);var o=_(i,"x","localResponseNormalization");E(o.rank===4||o.rank===3,function(){return`Error in localResponseNormalization: x must be rank 3 or 4 but got
               rank `+o.rank+"."}),E(Ge(t),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+t+"."});var a=o,s=!1;o.rank===3&&(s=!0,a=o.as4D(1,o.shape[0],o.shape[1],o.shape[2]));var u=R.runKernelFunc(function(c,l){var f=c.localResponseNormalization4D(a,t,e,n,r);return l([a,f]),f},{x4D:a},function(c,l){var f=l[0],h=l[1];return{x4D:function(){return R.runKernelFunc(function(p){return p.LRNGrad(c,f,h,t,e,n,r)},{})}}});return s?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),Xm=F({norm_:function(i,t,e,n){t===void 0&&(t="euclidean"),e===void 0&&(e=null),n===void 0&&(n=!1);var r=function s(u,c,l){if(l===void 0&&(l=null),u.rank===0)return u.abs();if(u.rank!==1&&l===null)return s(u.reshape([-1]),c,l);if(u.rank===1||typeof l=="number"||Array.isArray(l)&&l.length===1){if(c===1)return u.abs().sum(l);if(c===1/0)return u.abs().max(l);if(c===-1/0)return u.abs().min(l);if(c==="euclidean"||c===2)return u.abs().pow(Y(2,"int32")).sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(l)&&l.length===2){if(c===1)return u.abs().sum(l[0]).max(l[1]-1);if(c===1/0)return u.abs().sum(l[1]).max(l[0]);if(c===-1/0)return u.abs().sum(l[1]).min(l[0]);if(c==="fro"||c==="euclidean")return u.square().sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}throw new Error("Error in norm: invalid axis: "+l)}(i=_(i,"x","norm"),t,e),o=r.shape;if(n){var a=Ze(e,i.shape);o=Et(r.shape,a)}return r.reshape(o)}}),fC=F({basicLSTMCell_:function(i,t,e,n,r,o){var a=_(i,"forgetBias","basicLSTMCell"),s=_(t,"lstmKernel","basicLSTMCell"),u=_(e,"lstmBias","basicLSTMCell"),c=_(n,"data","basicLSTMCell"),l=_(r,"c","basicLSTMCell"),f=_(o,"h","basicLSTMCell"),h=c.concat(f,1).matMul(s).add(u),p=h.shape[0],d=h.shape[1]/4,m=[p,d],v=h.slice([0,0],m),g=h.slice([0,d],m),x=h.slice([0,2*d],m),w=h.slice([0,3*d],m),y=v.sigmoid().mulStrict(g.tanh()).addStrict(l.mulStrict(a.add(x).sigmoid())),b=y.tanh().mulStrict(w.sigmoid());return[y,b]}}),hC=F({multiRNNCell_:function(i,t,e,n){for(var r=_(t,"data","multiRNNCell"),o=Uo(e,"c","multiRNNCell"),a=Uo(n,"h","multiRNNCell"),s=r,u=[],c=0;c<i.length;c++){var l=i[c](s,o[c],a[c]);u.push(l[0]),u.push(l[1]),s=l[1]}var f=[],h=[];for(c=0;c<u.length;c+=2)f.push(u[c]),h.push(u[c+1]);return[f,h]}}),pC=F({movingAverage_:function(i,t,e,n,r){r===void 0&&(r=!0);var o=_(i,"v","movingAverage"),a=_(t,"x","movingAverage"),s=_(e,"decay","movingAverage");ed(o,a),E(Je(o.shape,a.shape),function(){return"Shape mismatch in v and x"});var u=Y(1),c=u.sub(s),l=a.sub(o).mul(c);if(r){E(n!=null,function(){return"When using zeroDebias: true, step is required."});var f=_(n,"step","movingAverage");l=l.div(u.sub(Yo(s,f)))}return o.add(l)}}),dC=F({stridedSlice_:function(i,t,e,n,r,o,a,s,u){if(r===void 0&&(r=0),o===void 0&&(o=0),a===void 0&&(a=0),s===void 0&&(s=0),u===void 0&&(u=0),n==null&&(n=new Array(t.length)),a!==0)throw new Error("ellipsis mask is not yet supported");var c=_(i,"x","stridedSlice"),l=Uu(s),f=c.shape.slice();l.forEach(function(v){t[v]=0,e[v]=1,f.splice(v,0,1)}),c=c.reshape(f);for(var h=0;h<c.rank;h++)t[h]=qd(r,t,n,c.shape,h),e[h]=Vd(o,e,n,c.shape,h),n[h]=n[h]||1;var p=Uu(u);p.forEach(function(v){e[v]=t[v]+1,n[v]=1});var d=ra(t,e,n),m=d.filter(function(v,g){return p.indexOf(g)===-1});return n.every(function(v){return v===1})?Jt(c,t,d).reshape(m):R.runKernelFunc(function(v){return v.stridedSlice(c,t,e,n)},{$x:c}).reshape(m)}}),mC=F({topk_:function(i,t,e){t===void 0&&(t=1),e===void 0&&(e=!0);var n=_(i,"x","topk");if(n.rank===0)throw new Error("topk() expects the input to be of rank 1 or higher");var r=n.shape[n.shape.length-1];if(t>r)throw new Error("'k' passed to topk() must be <= the last dimension ("+r+") but got "+t);var o=R.runKernelFunc(function(a){return a.topk(n,t,e)},{$x:n});return{values:o[0],indices:o[1]}}}),vC=F({scatterND_:function(i,t,e){var n=_(i,"indices","scatterND","int32"),r=_(t,"updates","scatterND");return Wd(r,n,e),R.runKernelFunc(function(o){return o.scatterND(n,r,e)},{indices:n,updates:r},null,"ScatterNd",{shape:e})}}),Dc=F({fft_:function(i){E(i.dtype==="complex64",function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+i.dtype+"."});var t=i.shape[i.shape.length-1],e=i.size/t,n=i.as2D(e,t);return R.runKernelFunc(function(r){return r.fft(n)},{input:i}).reshape(i.shape)}}),Jo=F({ifft_:function(i){E(i.dtype==="complex64",function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+i.dtype+"."});var t=i.shape[i.shape.length-1],e=i.size/t,n=i.as2D(e,t);return R.runKernelFunc(function(r){return r.ifft(n)},{input:i}).reshape(i.shape)}}),Sc=F({rfft_:function(i,t){E(i.dtype==="float32",function(){return"The dtype for rfft() must be real value but got "+i.dtype});var e,n=i.shape[i.shape.length-1],r=i.size/n;if(t!=null&&t<n){var o=i.shape.map(function(g){return 0}),a=i.shape.map(function(g){return g});a[i.shape.length-1]=t,e=i.slice(o,a),n=t}else if(t!=null&&t>n){var s=i.shape.map(function(g){return g});s[i.shape.length-1]=t-n,e=i.concat(Le(s),i.shape.length-1),n=t}else e=i;var u=e.zerosLike(),c=ht(e,u).as2D(r,n),l=Dc(c),f=Math.floor(n/2)+1,h=Vt(l),p=fn(l),d=h.split([f,n-f],h.shape.length-1),m=p.split([f,n-f],p.shape.length-1),v=e.shape.slice();return v[e.shape.length-1]=f,ht(d[0],m[0]).reshape(v)}}),$m=F({irfft_:function(i){var t=i.shape[i.shape.length-1],e=i.size/t;if(t<=2){var n=i.as2D(e,t),r=Jo(n);return Vt(r)}var o=[e,2*(t-1)],a=Vt(i).as2D(e,t),s=fn(i).as2D(e,t),u=a.slice([0,1],[e,t-2]).reverse(1),c=s.slice([0,1],[e,t-2]).reverse(1).mul(Y(-1)),l=a.concat(u,1),f=s.concat(c,1);return n=ht(l,f).as2D(o[0],o[1]),r=Jo(n),Vt(r)}}),gC=Object.freeze({fft:Dc,ifft:Jo,rfft:Sc,irfft:$m}),yC=F({sparseToDense_:function(i,t,e,n){n===void 0&&(n=0);var r=_(i,"sparseIndices","sparseToDense","int32"),o=_(t,"sparseValues","sparseToDense"),a=_(n,"defaultValue","sparseToDense",o.dtype);return function(s,u,c,l){if(s.dtype!=="int32")throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+s.dtype+".");if(s.rank>2)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+s.shape+".");var f=s.rank>0?s.shape[0]:1,h=s.rank>1?s.shape[1]:1;if(c.length!==h)throw new Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+h+".");var p=u.size;if(u.rank!==0&&(u.rank!==1||p!==f))throw new Error("sparseValues has incorrect shape "+u.shape+", should be [] or ["+f+"]");if(u.dtype!==l.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(r,o,e,a),R.runKernelFunc(function(s){return s.sparseToDense(r,o,e,a)},{$sparseIndices:r,$sparseValues:o,$defaultValue:a})}}),xC=F({gatherND_:function(i,t){var e=_(t,"indices","gatherND","int32"),n=_(i,"x","gatherND");return R.runKernelFunc(function(r){return r.gatherND(n,e)},{x:n,indices:e},null,"GatherNd")}}),bC=F({diag_:function(i){var t=_(i,"x","diag").flatten(),e=i.shape.concat(i.shape);return R.runKernelFunc(function(n){return n.diag(t)},{$x:t}).reshape(e)}}),wC=F({dropout_:function(i,t,e,n){var r=_(i,"x","dropout");if(E(r.dtype==="float32",function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+r.dtype+" tensor instead."}),E(t>=0&&t<1,function(){return"rate must be a float in the range [0, 1), but got "+t+"."}),t===0)return i instanceof Me?r.clone():r;var o=function(u,c){if(c==null)return u.shape.slice();if(Je(u.shape,c))return c;if(u.shape.length===c.length){for(var l=[],f=0;f<u.shape.length;f++)c[f]==null&&u.shape[f]!=null?l.push(u.shape[f]):l.push(c[f]);return l}return c}(r,e),a=1-t,s=Nd(o,0,1,"float32",n).add(a).floor().div(a);return r.mul(s)}});function Ym(i,t,e){for(var n=1-i%2,r=new Float32Array(i),o=0;o<i;++o){var a=2*Math.PI*o/(i+n-1);r[o]=t-e*Math.cos(a)}return Be(r,"float32")}var Ac=F({hannWindow_:function(i){return Ym(i,.5,.5)}}),Jm=F({hammingWindow_:function(i){return Ym(i,.54,.46)}}),Fc=F({frame_:function(i,t,e,n,r){n===void 0&&(n=!1),r===void 0&&(r=0);for(var o=0,a=[];o+t<=i.size;)a.push(Jt(i,o,t)),o+=e;if(n)for(;o<i.size;){var s=o+t-i.size,u=ze([Jt(i,o,t-s),qt([s],r)]);a.push(u),o+=e}return a.length===0?hn([],[0,t]):ze(a).as2D(a.length,t)}}),Qm=F({stft_:function(i,t,e,n,r){var o;r===void 0&&(r=Ac),n==null&&(o=t,n=Math.floor(Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)))));for(var a=Fc(i,t,e),s=je(a,r(t)),u=[],c=0;c<a.shape[0];c++)u.push(Sc(s.slice([c,0],[1,t]),n));return ze(u)}}),CC=Object.freeze({hannWindow:Ac,hammingWindow:Jm,frame:Fc,stft:Qm}),wt,_C=function(i,t,e){return e===void 0&&(e=1),te(this,void 0,void 0,function(){var n,r,o,a,s,u,c,l,f,h,p,d,m,v;return ne(this,function(g){switch(g.label){case 0:return n=_(i,"predictions","inTopK"),r=_(t,"targets","inTopK"),E(n.rank>1,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+n.rank}),E(n.rank-1===r.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+n.rank+" and targets rank "+r.rank}),Ae(n.shape.slice(0,n.shape.length-1),r.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),o=n.shape[n.shape.length-1],E(e>0&&e<=o,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+o+"), but got "+e}),[4,n.data()];case 1:return a=g.sent(),[4,r.data()];case 2:for(s=g.sent(),u=[a.length/o,o],l=u[1],f=qr("bool",c=u[0]),h=0;h<c;h++){for(p=h*l,d=a.subarray(p,p+l),m=[],v=0;v<d.length;v++)m.push({value:d[v],index:v});for(m.sort(function(x,w){return w.value-x.value}),f[h]=0,v=0;v<e;v++)if(m[v].index===s[h]){f[h]=1;break}}return i!==n&&n.dispose(),t!==r&&r.dispose(),[2,st(f,r.shape,"bool")]}})})};(function(i){i[i.NONE=0]="NONE",i[i.MEAN=1]="MEAN",i[i.SUM=2]="SUM",i[i.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"})(wt||(wt={}));var EC=F({absoluteDifference_:function(i,t,e,n){n===void 0&&(n=wt.SUM_BY_NONZERO_WEIGHTS);var r=_(i,"labels","absoluteDifference"),o=_(t,"predictions","absoluteDifference"),a=null;e!=null&&(a=_(e,"weights","absoluteDifference")),Ae(r.shape,o.shape,"Error in absoluteDifference: ");var s=r.sub(o).abs();return Rn(s,a,n)}}),Rn=F({computeWeightedLoss_:function(i,t,e){e===void 0&&(e=wt.SUM_BY_NONZERO_WEIGHTS);var n=_(i,"losses","computeWeightedLoss"),r=null;t!=null&&(r=_(t,"weights","computeWeightedLoss"));var o=r==null?n:n.mul(r);if(e===wt.NONE)return o;if(e===wt.SUM)return o.sum();if(e===wt.MEAN){if(r==null)return o.mean();var a=n.size/r.size,s=o.sum().div(r.sum());return a>1?s.div(Y(a)):s}if(e===wt.SUM_BY_NONZERO_WEIGHTS){if(r==null)return o.sum().div(Y(n.size));var u=r.mul(Gr(n.shape)).notEqual(Y(0)).sum().toFloat();return o.sum().div(u)}throw Error("Unknown reduction: "+e)}}),kC=F({cosineDistance_:function(i,t,e,n,r){r===void 0&&(r=wt.SUM_BY_NONZERO_WEIGHTS);var o=_(i,"labels","cosineDistance"),a=_(t,"predictions","cosineDistance"),s=null;n!=null&&(s=_(n,"weights","cosineDistance")),Ae(o.shape,a.shape,"Error in cosineDistance: ");var u=Y(1).sub(o.mul(a).sum(e,!0));return Rn(u,s,r)}}),DC=F({hingeLoss_:function(i,t,e,n){n===void 0&&(n=wt.SUM_BY_NONZERO_WEIGHTS);var r=_(i,"labels","hingeLoss"),o=_(t,"predictions","hingeLoss"),a=null;e!=null&&(a=_(e,"weights","hingeLoss")),Ae(r.shape,o.shape,"Error in hingeLoss: ");var s=Y(1);r=Y(2).mul(r).sub(s);var u=s.sub(r.mul(o)).relu();return Rn(u,a,n)}}),SC=F({huberLoss_:function(i,t,e,n,r){n===void 0&&(n=1),r===void 0&&(r=wt.SUM_BY_NONZERO_WEIGHTS);var o=_(i,"labels","huberLoss"),a=_(t,"predictions","huberLoss"),s=null;e!=null&&(s=_(e,"weights","huberLoss")),Ae(o.shape,a.shape,"Error in huberLoss: ");var u=Y(n),c=a.sub(o).abs(),l=Tm(c,u),f=c.sub(l),h=Y(.5).mul(l.square()).add(u.mul(f));return Rn(h,s,r)}}),AC=F({logLoss_:function(i,t,e,n,r){n===void 0&&(n=1e-7),r===void 0&&(r=wt.SUM_BY_NONZERO_WEIGHTS);var o=_(i,"labels","logLoss"),a=_(t,"predictions","logLoss"),s=null;e!=null&&(s=_(e,"weights","logLoss")),Ae(o.shape,a.shape,"Error in logLoss: ");var u=Y(1),c=Y(n),l=o.mul(a.add(c).log()).neg().sub(u.sub(o).mul(u.sub(a).add(c).log()));return Rn(l,s,r)}}),FC=F({meanSquaredError_:function(i,t,e,n){n===void 0&&(n=wt.SUM_BY_NONZERO_WEIGHTS);var r=_(i,"labels","meanSquaredError"),o=_(t,"predictions","meanSquaredError"),a=null;e!=null&&(a=_(e,"weights","meanSquaredError")),Ae(r.shape,o.shape,"Error in meanSquaredError: ");var s=r.squaredDifference(o);return Rn(s,a,n)}}),RC=F({sigmoidCrossEntropy_:function(i,t,e,n,r){n===void 0&&(n=0),r===void 0&&(r=wt.SUM_BY_NONZERO_WEIGHTS);var o=_(i,"multiClassLabels","sigmoidCrossEntropy"),a=_(t,"logits","sigmoidCrossEntropy"),s=null;if(e!=null&&(s=_(e,"weights","sigmoidCrossEntropy")),Ae(o.shape,a.shape,"Error in sigmoidCrossEntropy: "),n>0){var u=Y(n),c=Y(1),l=Y(.5);o=o.mul(c.sub(u)).add(l.mul(u))}var f=function(h,p){var d=_(h,"labels","sigmoidCrossEntropyWithLogits"),m=_(p,"logits","sigmoidCrossEntropyWithLogits");Ae(d.shape,m.shape,"Error in sigmoidCrossEntropyWithLogits: ");var v=m.relu(),g=m.mul(d),x=m.abs().neg().exp().log1p();return v.sub(g).add(x)}(o,a);return Rn(f,s,r)}}),IC=F({softmaxCrossEntropy_:function(i,t,e,n,r){n===void 0&&(n=0),r===void 0&&(r=wt.SUM_BY_NONZERO_WEIGHTS);var o=_(i,"onehotLabels","softmaxCrossEntropy"),a=_(t,"logits","softmaxCrossEntropy"),s=null;if(e!=null&&(s=_(e,"weights","softmaxCrossEntropy")),Ae(o.shape,a.shape,"Error in softmaxCrossEntropy: "),n>0){var u=Y(n),c=Y(1),l=Y(o.shape[1]);o=o.mul(c.sub(u)).add(u.div(l))}var f=function(h,p,d){if(d===void 0&&(d=-1),d===-1&&(d=p.rank-1),d!==p.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+p.rank+" and dim was "+d);return ia(function(m,v,g){var x=v.logSumExp([d],!0),w=v.toFloat().sub(x);return g([m,w]),{value:w.mul(m).neg().sum([d]),gradFunc:function(y,b){var C=b[0],S=b[1],A=Et(y.shape,[d]);return[y.reshape(A).mul(C.toFloat().sub(S.exp())),y.reshape(A).mul(S.exp().sub(C.toFloat()))]}}})(h,p)}(o,a);return Rn(f,s,r)}}),TC=Object.freeze({get Reduction(){return wt},absoluteDifference:EC,computeWeightedLoss:Rn,cosineDistance:kC,hingeLoss:DC,huberLoss:SC,logLoss:AC,meanSquaredError:FC,sigmoidCrossEntropy:RC,softmaxCrossEntropy:IC});function Dp(i,t){return t===void 0&&(t=!1),R.tidy(function(){if(i.shape.length!==2)throw new Error("qr2d() requires a 2D Tensor, but got a "+i.shape.length+"D Tensor.");for(var e=i.shape[0],n=i.shape[1],r=Td(e),o=i.clone(),a=hn([[1]],[1,1]),s=a.clone(),u=e>=n?n:e,c=function(f){var h,p=o,d=s,m=r;h=R.tidy(function(){var v=o.slice([f,f],[e-f,1]),g=v.norm(),x=o.slice([f,f],[1,1]),w=hn([[-1]]).where(x.greater(0),hn([[1]])),y=x.sub(w.mul(g)),b=v.div(y);s=b.shape[0]===1?a.clone():a.concat(b.slice([1,0],[b.shape[0]-1,b.shape[1]]),0);var C=w.matMul(y).div(g).neg(),S=o.slice([f,0],[e-f,n]),A=C.mul(s);if(f===0)o=S.sub(A.matMul(s.transpose().matMul(S)));else{var k=S.sub(A.matMul(s.transpose().matMul(S)));o=o.slice([0,0],[f,n]).concat(k,0)}var D=r.slice([0,f],[e,r.shape[1]-f]);if(f===0)r=D.sub(D.matMul(s).matMul(A.transpose()));else{var T=D.sub(D.matMul(s).matMul(A.transpose()));r=r.slice([0,0],[e,f]).concat(T,1)}return[s,o,r]}),s=h[0],o=h[1],r=h[2],Nt([p,d,m])},l=0;l<u;++l)c(l);return!t&&e>n&&(r=r.slice([0,0],[e,n]),o=o.slice([0,0],[n,n])),[r,o]})}var NC=F({bandPart_:function(i,t,e){if(t%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+t+".");if(e%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+e+".");var n=_(i,"a","bandPart");if(n.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+n.rank+".");var r=n.shape,o=n.shape.slice(-2),a=o[0],s=o[1];if(!(t<=a))throw new Error("bandPart(): numLower ("+t+") must not be greater than the number of rows ("+a+").");if(!(e<=s))throw new Error("bandPart(): numUpper ("+e+") must not be greater than the number of columns ("+s+").");t<0&&(t=a),e<0&&(e=s);var u=jo(0,a,1,"int32").reshape([-1,1]),c=jo(0,s,1,"int32"),l=Oe(u,c),f=ua(l.lessEqual(Y(+t,"int32")),l.greaterEqual(Y(-e,"int32"))),h=Le([a,s],n.dtype);return mt(Te(n.reshape([-1,a,s])).map(function(p){return lr(f,p,h)})).reshape(r)}}),PC=F({gramSchmidt_:function(i){var t;if(Array.isArray(i)){t=!1,E(i!=null&&i.length>0,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var e=i[0].shape[0],n=function(u){E(i[u].shape[0]===e,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+i[u].shape[0]+" vs. "+e+")"})},r=1;r<i.length;++r)n(r)}else t=!0,i=oc(i,i.shape[0],0).map(function(u){return Md(u,[0])});E(i.length<=i[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+i.length+") exceeds number of dimensions ("+i[0].shape[0]+")."});var o=[],a=i,s=function(u){o.push(R.tidy(function(){var c=a[u];if(u>0)for(var l=0;l<u;++l){var f=jm(o[l].mulStrict(c)).mul(o[l]);c=c.sub(f)}return c.div(Xm(c,"euclidean"))}))};for(r=0;r<i.length;++r)s(r);return t?mt(o,0):o}}),MC=F({qr_:function(i,t){if(t===void 0&&(t=!1),i.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+i.rank);if(i.rank===2)return Dp(i,t);var e=i.shape.slice(0,i.shape.length-2).reduce(function(a,s){return a*s}),n=Te(i.reshape([e,i.shape[i.shape.length-2],i.shape[i.shape.length-1]]),0),r=[],o=[];return n.forEach(function(a){var s=Dp(a,t),u=s[0],c=s[1];r.push(u),o.push(c)}),[mt(r,0).reshape(i.shape),mt(o,0).reshape(i.shape)]}}),OC=Object.freeze({bandPart:NC,gramSchmidt:PC,qr:MC});function ca(i,t,e,n,r,o){n==null&&(n=.5),r==null&&(r=Number.NEGATIVE_INFINITY),o==null&&(o=0);var a=i.shape[0];return e=Math.min(e,a),E(0<=n&&n<=1,function(){return"iouThreshold must be in [0, 1], but was '"+n+"'"}),E(i.rank===2,function(){return"boxes must be a 2D tensor, but was of rank '"+i.rank+"'"}),E(i.shape[1]===4,function(){return"boxes must have 4 columns, but 2nd dimension was "+i.shape[1]}),E(t.rank===1,function(){return"scores must be a 1D tensor"}),E(t.shape[0]===a,function(){return"scores has incompatible shape with boxes. Expected "+a+", but was "+t.shape[0]}),E(0<=o&&o<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+o+"'"}),{maxOutputSize:e,iouThreshold:n,scoreThreshold:r,softNmsSigma:o}}var BC=F({resizeBilinear_:function(i,t,e){e===void 0&&(e=!1);var n=_(i,"images","resizeBilinear");E(n.rank===3||n.rank===4,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+n.rank+"."}),E(t.length===2,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+t+"."});var r=n,o=!1;n.rank===3&&(o=!0,r=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var a=t[0],s=t[1],u=R.runKernelFunc(function(c,l){return l([r]),c.resizeBilinear(r,a,s,e)},{x:r},function(c,l){return{x:function(){return R.runKernelFunc(function(f){return f.resizeBilinearBackprop(c,l[0],e)},{})}}},"ResizeBilinear",{alignCorners:e,newHeight:a,newWidth:s});return o?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),LC=F({resizeNearestNeighbor_:function(i,t,e){e===void 0&&(e=!1);var n=_(i,"images","resizeNearestNeighbor");E(n.rank===3||n.rank===4,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+n.rank+"."}),E(t.length===2,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+t+"."}),E(n.dtype==="float32"||n.dtype==="int32",function(){return"`images` must have `int32` or `float32` as dtype"});var r=n,o=!1;n.rank===3&&(o=!0,r=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var a=t[0],s=t[1],u=R.runKernelFunc(function(c,l){return l([r]),c.resizeNearestNeighbor(r,a,s,e)},{batchImages:r},function(c,l){return{batchImages:function(){return R.runKernelFunc(function(f){return f.resizeNearestNeighborBackprop(c,l[0],e)},{})}}});return o?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),WC=F({nonMaxSuppression_:function(i,t,e,n,r){n===void 0&&(n=.5),r===void 0&&(r=Number.NEGATIVE_INFINITY);var o=_(i,"boxes","nonMaxSuppression"),a=_(t,"scores","nonMaxSuppression"),s=ca(o,a,e,n,r);e=s.maxOutputSize,n=s.iouThreshold,r=s.scoreThreshold;var u={maxOutputSize:e,iouThreshold:n,scoreThreshold:r};return R.runKernelFunc(function(c){return c.nonMaxSuppression(o,a,e,n,r)},{boxes:o,scores:a},null,"NonMaxSuppressionV3",u)}}),zC=function(i,t,e,n,r){return n===void 0&&(n=.5),r===void 0&&(r=Number.NEGATIVE_INFINITY),te(this,void 0,void 0,function(){var o,a,s,u,c,l,f;return ne(this,function(h){switch(h.label){case 0:return o=_(i,"boxes","nonMaxSuppressionAsync"),a=_(t,"scores","nonMaxSuppressionAsync"),s=ca(o,a,e,n,r),e=s.maxOutputSize,n=s.iouThreshold,r=s.scoreThreshold,[4,Promise.all([o.data(),a.data()])];case 1:return u=h.sent(),c=u[0],l=u[1],f=dc(c,l,e,n,r),o!==i&&o.dispose(),a!==t&&a.dispose(),[2,f]}})})},qC=F({nonMaxSuppressionWithScore_:function(i,t,e,n,r,o){n===void 0&&(n=.5),r===void 0&&(r=Number.NEGATIVE_INFINITY),o===void 0&&(o=0);var a=_(i,"boxes","nonMaxSuppression"),s=_(t,"scores","nonMaxSuppression"),u=ca(a,s,e,n,r,o),c={maxOutputSize:e=u.maxOutputSize,iouThreshold:n=u.iouThreshold,scoreThreshold:r=u.scoreThreshold,softNmsSigma:o=u.softNmsSigma},l=R.runKernel("NonMaxSuppressionV5",{boxes:a,scores:s},c);return{selectedIndices:l[0],selectedScores:l[1]}}}),VC=function(i,t,e,n,r,o){return n===void 0&&(n=.5),r===void 0&&(r=Number.NEGATIVE_INFINITY),o===void 0&&(o=0),te(this,void 0,void 0,function(){var a,s,u,c,l,f,h;return ne(this,function(p){switch(p.label){case 0:return a=_(i,"boxes","nonMaxSuppressionAsync"),s=_(t,"scores","nonMaxSuppressionAsync"),u=ca(a,s,e,n,r,o),e=u.maxOutputSize,n=u.iouThreshold,r=u.scoreThreshold,o=u.softNmsSigma,[4,Promise.all([a.data(),s.data()])];case 1:return c=p.sent(),l=c[0],f=c[1],h=mc(l,f,e,n,r,o),a!==i&&a.dispose(),s!==t&&s.dispose(),[2,h]}})})},UC=F({cropAndResize_:function(i,t,e,n,r,o){var a=_(i,"image","cropAndResize"),s=_(t,"boxes","cropAndResize","float32"),u=_(e,"boxInd","cropAndResize","int32");r=r||"bilinear",o=o||0;var c=s.shape[0];return E(a.rank===4,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+a.rank+"."}),E(s.rank===2&&s.shape[1]===4,function(){return"Error in cropAndResize: boxes must be have size ["+c+",4] but had shape "+s.shape+"."}),E(u.rank===1&&u.shape[0]===c,function(){return"Error in cropAndResize: boxInd must be have size ["+c+"] but had shape "+s.shape+"."}),E(n.length===2,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+n.length+"."}),E(n[0]>=1&&n[1]>=1,function(){return"cropSize must be atleast [1,1], but was "+n}),E(r==="bilinear"||r==="nearest",function(){return"method must be bilinear or nearest, but was "+r}),R.runKernelFunc(function(l,f){return l.cropAndResize(a,s,u,n,r,o)},{images:a,boxes:s,boxInd:u},null,"CropAndResize",{method:r,extrapolationValue:o,cropSize:n})}}),Ui=Object.freeze({resizeBilinear:BC,resizeNearestNeighbor:LC,nonMaxSuppression:WC,nonMaxSuppressionAsync:zC,nonMaxSuppressionWithScore:qC,nonMaxSuppressionWithScoreAsync:VC,cropAndResize:UC}),Rc=function(i,t){return!(i>0)||t==="linear"},Ic=function(i,t,e){if(e==null||e==="linear")return i;if(e==="relu")return i.mul(t.step());throw new Error("Gradient for activation "+e+" has not been implemented yet.")},Tc=function(i,t){var e=t,n=Qe(i.shape,t.shape);return n.length>0&&(e=e.sum(n)),e.reshape(i.shape)},Nc=function(i,t,e){if(t==="linear")return i;if(t==="relu")return Re(i);if(t==="elu")return Gm(i);if(t==="relu6")return Km(i);if(t==="prelu")return Hm(i,e);throw new Error("Unknown fused activation "+t+".")},jC=F({fusedMatMul_:function(i){var t,e=i.a,n=i.b,r=i.transposeA,o=r!==void 0&&r,a=i.transposeB,s=a!==void 0&&a,u=i.bias,c=i.activation,l=c===void 0?"linear":c,f=i.preluActivationWeights;if(Rc(R.state.gradientDepth,l)===!1){var h=Hr(e,n,o,s);return u!=null&&(h=se(h,u)),Nc(h,l,f)}var p=_(e,"a","fused matMul"),d=_(n,"b","fused matMul");t=qe(p,d),p=t[0],d=t[1];var m=o?p.shape[p.rank-2]:p.shape[p.rank-1],v=s?d.shape[d.rank-1]:d.shape[d.rank-2],g=o?p.shape[p.rank-1]:p.shape[p.rank-2],x=s?d.shape[d.rank-2]:d.shape[d.rank-1],w=p.shape.slice(0,-2),y=d.shape.slice(0,-2),b=re(w),C=re(y);E(p.rank>=2&&d.rank>=2&&p.rank===d.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+p.rank+" and "+d.rank+"."}),E(Je(w,y),function(){return"Error in fused matMul: outer dimensions ("+w+") and ("+y+") of Tensors with shapes "+p.shape+" and "+d.shape+" must match."}),E(m===v,function(){return"Error in fused matMul: inner shapes ("+m+") and ("+v+") of Tensors with shapes "+p.shape+" and "+d.shape+" and transposeA="+o+" and transposeB="+s+" must match."});var S,A,k=p.shape.slice(0,-2).concat([g,x]),D=o?p.as3D(b,m,g):p.as3D(b,g,m),T=s?d.as3D(C,x,v):d.as3D(C,v,x);u!=null&&ye(k,(S=qe(S=_(u,"bias","fused matMul"),p)[0]).shape),f!=null&&(A=_(f,"prelu weights","fused matMul"));var I={a:D,b:T};u!=null&&(I.bias=S),f!=null&&(I.preluActivationWeights=A);var W=[D,T];return R.runKernelFunc(function(B,L){var V=B.fusedBatchMatMul({a:D,b:T,transposeA:o,transposeB:s,bias:S,activation:l,preluActivationWeights:A});return L([D,T,V]),V},I,function(B,L){var V=L[0],q=L[1],z=L[2],G=Ic(B,z,l),H={};return u!=null&&(H={bias:function(){return Tc(S,G)}}),Object.assign(o||s?!o&&s?{a:function(){return G.matMul(q,!1,!1)},b:function(){return G.matMul(V,!0,!1)}}:o&&!s?{a:function(){return q.matMul(G,!1,!0)},b:function(){return V.matMul(G,!1,!1)}}:{a:function(){return q.matMul(G,!0,!0)},b:function(){return G.matMul(V,!0,!0)}}:{a:function(){return G.matMul(q,!1,!0)},b:function(){return V.matMul(G,!0,!1)}},H)},"_FusedMatMul",{transposeA:o,transposeB:s,activation:l},W,[!0]).reshape(k)}}),GC=F({fusedConv2d_:function(i){var t=i.x,e=i.filter,n=i.strides,r=i.pad,o=i.dataFormat,a=o===void 0?"NHWC":o,s=i.dilations,u=s===void 0?[1,1]:s,c=i.dimRoundingMode,l=i.bias,f=i.activation,h=f===void 0?"linear":f,p=i.preluActivationWeights;if(h=h||"linear",Rc(R.state.gradientDepth,h)===!1){var d=ut(t,e,n,r,a,u,c);return l!=null&&(d=se(d,l)),Nc(d,h,p)}var m=_(t,"x","conv2d"),v=_(e,"filter","conv2d"),g=m,x=!1;m.rank===3&&(x=!0,g=m.as4D(1,m.shape[0],m.shape[1],m.shape[2])),E(g.rank===4,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+g.rank+"."}),E(v.rank===4,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+v.rank+"."}),c!=null&&E(Ge(r),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+c+" but got pad "+r+"."}),E(g.shape[3]===v.shape[2],function(){return"Error in conv2d: depth of input ("+g.shape[3]+") must match input depth for filter "+v.shape[2]+"."}),E(kt(n,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+u+"'"}),E(a==="NHWC",function(){return"Error in conv2d: got dataFormat of "+a+" but only NHWC is currently supported."});var w,y,b=Hn(g.shape,v.shape,n,u,r,c);l!=null&&(w=qe(w=_(l,"bias","fused conv2d"),m)[0],ye(b.outShape,w.shape)),p!=null&&(y=_(p,"prelu weights","fused conv2d"));var C={x:g,filter:v};l!=null&&(C.bias=w),p!=null&&(C.preluActivationWeights=y);var S=[v,g],A=R.runKernelFunc(function(k,D){var T=k.fusedConv2d({input:g,filter:v,convInfo:b,bias:w,activation:h,preluActivationWeights:y});return D([v,g,T]),T},C,function(k,D){var T=D,I=T[0],W=T[1],B=T[2],L=Ic(k,B,h);E(cr(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});var V={};return l!=null&&(V={bias:function(){return Tc(w,L)}}),Object.assign({x:function(){return Lm(W.shape,L,I,n,r)},filter:function(){return Ec(W,L,I.shape,n,r)}},V)},"FusedConv2D",{convInfo:b,activation:h},S,[!0]);return x?A.as3D(A.shape[1],A.shape[2],A.shape[3]):A}}),HC=F({fusedDepthwiseConv2d_:function(i){var t=i.x,e=i.filter,n=i.strides,r=i.pad,o=i.dataFormat,a=o===void 0?"NHWC":o,s=i.dilations,u=s===void 0?[1,1]:s,c=i.dimRoundingMode,l=i.bias,f=i.activation,h=f===void 0?"linear":f,p=i.preluActivationWeights;if(Rc(R.state.gradientDepth,h)===!1){var d=zi(t,e,n,r,a,u,c);return l!=null&&(d=se(d,l)),Nc(d,h,p)}var m=_(t,"x","depthwiseConv2d"),v=_(e,"filter","depthwiseConv2d"),g=m,x=!1;m.rank===3&&(x=!0,g=m.as4D(1,m.shape[0],m.shape[1],m.shape[2])),E(g.rank===4,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+g.rank+"."}),E(v.rank===4,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+v.rank+"."}),E(g.shape[3]===v.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+g.shape[3]+") must match the inChannels dimension in filter "+v.shape[2]+"."}),u==null&&(u=[1,1]),E(kt(n,u),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+n+" and dilations '"+u+"'"}),c!=null&&E(Ge(r),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+c+" but got pad "+r+"."});var w,y,b=Hn(g.shape,v.shape,n,u,r,c,!0);l!=null&&(w=qe(w=_(l,"bias","fused conv2d"),m)[0],ye(b.outShape,w.shape)),p!=null&&(y=_(p,"prelu weights","fused depthwiseConv2d"));var C={x:g,filter:v};l!=null&&(C.bias=w),p!=null&&(C.preluActivationWeights=y);var S=[v,g],A=R.runKernelFunc(function(k,D){var T=k.fusedDepthwiseConv2D({input:g,filter:v,convInfo:b,bias:w,activation:h,preluActivationWeights:y});return D([v,g,T]),T},C,function(k,D){E(cr(u),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+u+"'"});var T=D[0],I=D[1],W=D[2],B=Ic(k,W,h),L={};return l!=null&&(L={bias:function(){return Tc(w,B)}}),Object.assign({x:function(){return Wm(I.shape,B,T,b)},filter:function(){return zm(I,B,T.shape,b)}},L)},"FusedDepthwiseConv2D",{convInfo:b,activation:h},S,[!0]);return x?A.as3D(A.shape[1],A.shape[2],A.shape[3]):A}}),KC=Object.freeze({matMul:jC,conv2d:GC,depthwiseConv2d:HC}),XC=Object.freeze({image:Ui,linalg:OC,losses:TC,spectral:gC,fused:KC,signal:CC,square:Aw,squaredDifference:Em,conv1d:B2,conv2d:ut,conv3d:L2,depthwiseConv2d:zi,separableConv2d:qi,conv2dTranspose:W2,conv3dTranspose:z2,op:F,batchNormalization2d:i2,batchNormalization3d:o2,batchNormalization4d:a2,batchNormalization:s2,batchNorm:wc,batchNorm2d:u2,batchNorm3d:c2,batchNorm4d:l2,booleanMaskAsync:O2,complex:ht,real:Vt,imag:fn,concat:ze,concat1d:mx,concat2d:vx,concat3d:gx,concat4d:yx,split:oc,matMul:Hr,dot:q2,outerProduct:V2,reverse:Vi,reverse1d:U2,reverse2d:j2,reverse3d:G2,reverse4d:H2,maxPool:He,avgPool:Fn,pool:K2,maxPool3d:X2,avgPool3d:$2,slice:Jt,slice1d:Y2,slice2d:J2,slice3d:kc,slice4d:Q2,abs:Fw,acos:Rw,acosh:Iw,asin:Tw,asinh:Nw,atan:Pw,atanh:Mw,ceil:Ow,clipByValue:Bi,cos:Bw,cosh:Lw,erf:Ww,exp:aa,expm1:zw,floor:qw,log:Vw,log1p:Uw,logSigmoid:jw,neg:Li,reciprocal:Gw,round:Hw,rsqrt:km,sigmoid:bc,sign:Kw,isNaN:Xw,isInf:$w,isFinite:Yw,sin:Jw,sinh:Qw,softplus:Zw,sqrt:e2,step:t2,tan:n2,tanh:r2,all:Z2,any:eC,argMax:tC,argMin:nC,logSumExp:rC,max:pr,mean:iC,min:oC,moments:aC,sum:jm,prod:sC,equal:Nm,equalStrict:D2,greater:S2,greaterEqual:Pm,greaterEqualStrict:A2,greaterStrict:F2,less:R2,lessEqual:I2,lessEqualStrict:T2,lessStrict:N2,notEqual:P2,notEqualStrict:M2,add:se,addN:p2,addStrict:d2,atan2:m2,div:Ut,divNoNan:v2,divStrict:g2,floorDiv:Im,maximum:Cc,maximumStrict:y2,minimum:Tm,minimumStrict:x2,mod:b2,modStrict:w2,mul:je,mulStrict:C2,pow:Yo,powStrict:_2,squaredDifferenceStrict:E2,sub:Oe,subStrict:k2,elu:Gm,leakyRelu:uC,prelu:Hm,relu:Re,relu6:Km,selu:cC,logicalAnd:ua,logicalNot:f2,logicalOr:Fm,logicalXor:h2,where:lr,whereAsync:Rm,buffer:le,print:Sx,batchToSpaceND:Id,broadcastTo:Ax,cast:Fx,clone:Rx,cumsum:Ix,depthToSpace:Tx,expandDims:xt,eye:Td,multinomial:Nx,oneHot:Vu,pad:An,pad1d:Px,pad2d:Mx,pad3d:Ox,pad4d:Bx,rand:Lx,randomNormal:Wx,randomGamma:zx,randomUniform:Nd,reshape:Dt,spaceToBatchND:Pd,squeeze:Md,stack:mt,tile:ar,truncatedNormal:qx,unstack:Te,setdiff1dAsync:Vx,fill:qt,linspace:dx,ones:Gr,range:jo,scalar:Y,tensor:st,tensor1d:Be,tensor2d:hn,tensor3d:ta,tensor4d:it,tensor5d:fx,tensor6d:hx,variable:px,zeros:Le,onesLike:Rd,zerosLike:De,transpose:jt,softmax:St,logSoftmax:jx,localResponseNormalization:lC,norm:Xm,gather:_c,unsortedSegmentSum:Mm,basicLSTMCell:fC,multiRNNCell:hC,movingAverage:pC,stridedSlice:dC,topk:mC,scatterND:vC,fft:Dc,ifft:Jo,rfft:Sc,irfft:$m,sparseToDense:yC,gatherND:xC,diag:bC,dropout:wC,hannWindow:Ac,hammingWindow:Jm,frame:Fc,stft:Qm,inTopKAsync:_C});function U(i,t){Array.isArray(i)||(i=[i]),i.forEach(function(e){e!=null&&E(e.dtype!=="complex64",function(){return t+" does not support complex64 tensors."})})}function bu(i,t,e,n){if(e==="linear")return i.linear(t);if(e==="relu")return i.relu(t);if(e==="elu")return i.elu(t);if(e==="relu6")return i.relu6(t);if(e==="prelu")return i.prelu(t,n);throw new Error("Activation "+e+" has not been implemented for the CPU backend.")}var $C=function(i){function t(){var e=i.call(this)||this;return e.blockSize=48,e.firstUse=!0,e.data=new Ud(e,R),e}return Qt(t,i),t.prototype.write=function(e,n,r){this.firstUse&&(this.firstUse=!1,O().get("IS_NODE")&&Vo(`
============================
Hi there \u{1F44B}. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.
============================`));var o={};return this.data.set(o,{values:e,dtype:r}),o},t.prototype.move=function(e,n,r,o){this.data.set(e,{values:n,dtype:o})},t.prototype.numDataIds=function(){return this.data.numDataIds()},t.prototype.read=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){return[2,this.readSync(e)]})})},t.prototype.readSync=function(e){var n=this.data.get(e),r=n.dtype,o=n.complexTensors;return r==="complex64"?Gu(this.readSync(o.real.dataId),this.readSync(o.imag.dataId)):this.data.get(e).values},t.prototype.bufferSync=function(e){var n=this.readSync(e.dataId),r=n;if(e.dtype==="string")try{r=n.map(function(o){return Di(o)})}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return le(e.shape,e.dtype,r)},t.prototype.makeOutput=function(e,n,r){var o=this.write(e,n,r);return R.makeTensorFromDataId(o,n,r,this)},t.prototype.disposeData=function(e){if(this.data.has(e)){var n=this.data.get(e).complexTensors;n!=null&&(n.real.dispose(),n.imag.dispose()),this.data.delete(e)}},t.prototype.time=function(e){return te(this,void 0,void 0,function(){var n;return ne(this,function(r){return n=$t(),e(),[2,{kernelMs:$t()-n}]})})},t.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},t.prototype.complex=function(e,n){var r=this.makeOutput(null,e.shape,"complex64");return this.data.get(r.dataId).complexTensors={real:R.keep(e.clone()),imag:R.keep(n.clone())},r},t.prototype.real=function(e){return this.data.get(e.dataId).complexTensors.real.clone()},t.prototype.imag=function(e){return this.data.get(e.dataId).complexTensors.imag.clone()},t.prototype.slice=function(e,n,r){if(U(e,"slice"),cc(e.shape,n,r)){var o=lc(n,e.strides),a=re(r);return st(this.readSync(e.dataId).subarray(o,o+a),r,e.dtype)}for(var s=le(r,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c).map(function(f,h){return f+n[h]});s.values[c]=u.get.apply(u,l)}return s.toTensor()},t.prototype.stridedSlice=function(e,n,r,o){U(e,"stridedSlice");var a=ra(n,r,o);if(a.some(function(p){return p===0}))return st([],a);for(var s=le(a,e.dtype),u=this.bufferSync(e),c=0;c<s.size;c++){for(var l=s.indexToLoc(c),f=new Array(l.length),h=0;h<f.length;h++)f[h]=l[h]*o[h]+n[h];s.set.apply(s,[u.get.apply(u,f)].concat(l))}return s.toTensor()},t.prototype.diag=function(e){for(var n=this.readSync(e.dataId),r=le([e.size,e.size],e.dtype),o=r.values,a=0;a<n.length;a++)o[a*e.size+a]=n[a];return r.toTensor()},t.prototype.unstack=function(e,n){for(var r=e.shape[n],o=new Array(e.rank-1),a=0,s=0;s<e.rank;s++)s!==n&&(o[a++]=e.shape[s]);var u=new Array(e.rank).fill(0),c=e.shape.slice();c[n]=1;var l=new Array(r);for(s=0;s<l.length;s++)u[n]=s,l[s]=this.slice(e,u,c).reshape(o);return l},t.prototype.reverse=function(e,n){U(e,"reverse");for(var r=le(e.shape,e.dtype),o=this.bufferSync(e),a=function(u){var c=r.indexToLoc(u),l=c.slice();n.forEach(function(f){return l[f]=e.shape[f]-1-l[f]}),r.set.apply(r,[o.get.apply(o,l)].concat(c))},s=0;s<r.size;s++)a(s);return r.toTensor()},t.prototype.concat=function(e,n){var r=this;if(e[0].dtype==="complex64"){var o=e.map(function(p){return Vt(p)}),a=e.map(function(p){return fn(p)});return ht(this.concat(o,n),this.concat(a,n))}var s=e.map(function(p){var d=re(p.shape.slice(n));return p.as2D(-1,d)}),u=ur(s.map(function(p){return p.shape}),1),c=le(u,e[0].dtype).values;if(s[0].shape[0]===1){var l=0;s.forEach(function(p){c.set(r.readSync(p.dataId),l),l+=p.size})}else{var f=0;s.forEach(function(p){for(var d=r.readSync(p.dataId),m=0,v=0;v<p.shape[0];++v)for(var g=v*u[1]+f,x=0;x<p.shape[1];++x)c[g+x]=d[m++];f+=p.shape[1]})}var h=ur(e.map(function(p){return p.shape}),n);return st(c,h,e[0].dtype)},t.prototype.neg=function(e){return U(e,"neg"),this.multiply(Y(-1),e)},t.prototype.add=function(e,n){return e.dtype==="complex64"||n.dtype==="complex64"?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(r,o,a,s){return{real:r+a,imag:o+s}}):this.broadcastedBinaryOp(e,n,at(e.dtype,n.dtype),function(r,o){return r+o})},t.prototype.addN=function(e){var n=this;U(e,"addN");for(var r=e.map(function(l){return n.readSync(l.dataId)}),o=le(e[0].shape,e[0].dtype),a=o.values,s=0;s<e.length;s++)for(var u=r[s],c=0;c<a.length;c++)a[c]+=u[c];return o.toTensor()},t.prototype.softmax=function(e,n){var r=Ze([n],e.shape),o=this.max(e,r),a=Et(o.shape,r),s=this.subtract(e,o.reshape(a)),u=this.exp(s),c=this.sum(u,r).reshape(a);return this.realDivide(u,c)},t.prototype.subtract=function(e,n){return e.dtype==="complex64"||n.dtype==="complex64"?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(r,o,a,s){return{real:r-a,imag:o-s}}):this.broadcastedBinaryOp(e,n,at(e.dtype,n.dtype),function(r,o){return r-o})},t.prototype.pow=function(e,n){return U([e,n],"pow"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){return Math.pow(r,o)})},t.prototype.batchMatMul=function(e,n,r,o){U([e,n],"matMul");for(var a=r?e.shape[1]:e.shape[2],s=r?e.shape[2]:e.shape[1],u=o?n.shape[1]:n.shape[2],c=e.shape[0],l=this.readSync(e.dataId),f=this.readSync(n.dataId),h=r?[e.strides[0],1,e.strides[1]]:[e.strides[0],e.strides[1],1],p=h[0],d=h[1],m=h[2],v=o?[1,n.strides[1],n.strides[0]]:[n.strides[1],1,n.strides[0]],g=v[0],x=v[1],w=v[2],y=s*u,b=le([c,s,u],e.dtype),C=b.values,S=this.blockSize,A=0;A<c;A++)for(var k=0;k<s;k+=S)for(var D=0;D<u;D+=S)for(var T=0;T<a;T+=S)for(var I=Math.min(k+S,s),W=Math.min(D+S,u),B=Math.min(T+S,a),L=k;L<I;L++)for(var V=D;V<W;V++){for(var q=0,z=T;z<B;z++)q+=l[A*p+L*d+z*m]*f[z*g+V*x+A*w];C[A*y+(L*u+V)]+=q}return b.toTensor()},t.prototype.fusedBatchMatMul=function(e){var n=e.a,r=e.b,o=e.transposeA,a=e.transposeB,s=e.bias,u=e.activation,c=e.preluActivationWeights,l=this.batchMatMul(n,r,o,a);return s&&(l=this.add(l,s)),u&&(l=bu(this,l,u,c)),l},t.prototype.multiply=function(e,n){return e.dtype==="complex64"||n.dtype==="complex64"?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(r,o,a,s){return{real:r*a-o*s,imag:r*s+o*a}}):this.broadcastedBinaryOp(e,n,at(e.dtype,n.dtype),function(r,o){return r*o})},t.prototype.realDivide=function(e,n){return U([e,n],"realDivide"),this.broadcastedBinaryOp(e,n,"float32",function(r,o){return r/o})},t.prototype.floorDiv=function(e,n){return U([e,n],"floorDiv"),this.broadcastedBinaryOp(e,n,"int32",function(r,o){return Math.floor(r/o)})},t.prototype.sum=function(e,n){U(e,"sum"),It("sum",n,e.rank);for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,at(e.dtype,"int32")),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=0,d=0;d<u;++d)p+=l[h+d];c[f]=p}return s},t.prototype.prod=function(e,n){U(e,"sum");for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,at(e.dtype,"int32")),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=1,d=0;d<u;++d)p*=l[h+d];c[f]=p}return s},t.prototype.unsortedSegmentSum=function(e,n,r){U(e,"unsortedSegmentSum");for(var o=[],a=e.rank-n.rank,s=0;s<a;++s)n=n.expandDims(s+1);for(s=0;s<r;++s){var u=Y(s,"int32"),c=Nm(u,n).asType("float32").mul(e).sum(0);o.push(c)}return mt(o)},t.prototype.argMin=function(e,n){U(e,"argMin");var r=[n];It("argMin",r,e.rank);for(var o=pt(e.shape,r),a=o[0],s=o[1],u=Le(a,"int32"),c=re(s),l=this.readSync(u.dataId),f=this.readSync(e.dataId),h=0;h<l.length;++h){for(var p=h*c,d=f[p],m=0,v=0;v<c;++v){var g=f[p+v];g<d&&(d=g,m=v)}l[h]=m}return u},t.prototype.argMax=function(e,n){U(e,"argMax");var r=[n];It("argMax",r,e.rank);for(var o=pt(e.shape,r),a=o[0],s=o[1],u=Le(a,"int32"),c=re(s),l=this.readSync(u.dataId),f=this.readSync(e.dataId),h=0;h<l.length;++h){for(var p=h*c,d=f[p],m=0,v=0;v<c;++v){var g=f[p+v];g>d&&(d=g,m=v)}l[h]=m}return u},t.prototype.cumsum=function(e,n,r,o){if(U(e,"cumsum"),n!==e.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(e.rank-1)+" but got axis="+n);for(var a=at(e.dtype,"int32"),s=Le(e.shape,a),u=this.readSync(s.dataId),c=this.readSync(e.dataId),l=e.shape[e.rank-1],f=o?function(v,g){return v+l-g-1}:function(v,g){return v+g},h=0;h<c.length;h+=l)for(var p=0;p<l;p++){var d=f(h,p);if(p===0)u[d]=r?0:c[d];else{var m=f(h,p-1);u[d]=r?c[m]+u[m]:c[d]+u[m]}}return s},t.prototype.equal=function(e,n){return U([e,n],"equal"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r===o?1:0})},t.prototype.notEqual=function(e,n){return U([e,n],"notEqual"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r!==o?1:0})},t.prototype.less=function(e,n){return U([e,n],"less"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r<o?1:0})},t.prototype.lessEqual=function(e,n){return U([e,n],"lessEqual"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r<=o?1:0})},t.prototype.greater=function(e,n){return U([e,n],"greater"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r>o?1:0})},t.prototype.greaterEqual=function(e,n){return U([e,n],"greaterEqual"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r>=o?1:0})},t.prototype.logicalNot=function(e){U(e,"logicalNot");for(var n=this.readSync(e.dataId),r=new Uint8Array(n.length),o=0;o<n.length;++o)r[o]=n[o]?0:1;return this.makeOutput(r,e.shape,"bool")},t.prototype.logicalAnd=function(e,n){return U([e,n],"logicalAnd"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r&&o})},t.prototype.logicalOr=function(e,n){return U([e,n],"logicalOr"),this.broadcastedBinaryOp(e,n,"bool",function(r,o){return r||o})},t.prototype.select=function(e,n,r){U([e,n,r],"select");for(var o=this.readSync(e.dataId),a=this.readSync(n.dataId),s=this.readSync(r.dataId),u=Le(n.shape,at(n.dtype,r.dtype)),c=this.readSync(u.dataId),l=0,f=e.rank===0||e.rank>1||n.rank===1?1:re(n.shape.slice(1)),h=0;h<o.length;h++)for(var p=0;p<f;p++)o[h]===1?c[l++]=a[h]:c[l++]=s[h];return u},t.prototype.where=function(e){U([e],"where");var n=this.readSync(e.dataId);return vc(e.shape,n)},t.prototype.topk=function(e,n,r){return U(e,"topk"),Xd(this.readSync(e.dataId),e.shape,e.dtype,n)},t.prototype.min=function(e,n){U(e,"min"),It("min",n,e.rank);for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,e.dtype),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=l[h],d=0;d<u;++d){var m=l[h+d];m<p&&(p=m)}c[f]=p}return s},t.prototype.minimum=function(e,n){return U([e,n],"minimum"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){return Math.min(r,o)})},t.prototype.mod=function(e,n){return U([e,n],"mod"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){var a=r%o;return r<0&&o<0||r>=0&&o>=0?a:(a+o)%o})},t.prototype.max=function(e,n){U(e,"max"),It("max",n,e.rank);for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,e.dtype),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=l[h],d=0;d<u;++d){var m=l[h+d];m>p&&(p=m)}c[f]=p}return s},t.prototype.maximum=function(e,n){return U([e,n],"maximum"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){return Math.max(r,o)})},t.prototype.all=function(e,n){U(e,"all"),It("all",n,e.rank);for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,e.dtype),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=l[h],d=0;d<u;++d){var m=l[h+d];p=p&&m}c[f]=p}return s},t.prototype.any=function(e,n){U(e,"any"),It("any",n,e.rank);for(var r=pt(e.shape,n),o=r[0],a=r[1],s=Le(o,e.dtype),u=re(a),c=this.readSync(s.dataId),l=this.readSync(e.dataId),f=0;f<c.length;++f){for(var h=f*u,p=l[h],d=0;d<u;++d){var m=l[h+d];p=p||m}c[f]=p}return s},t.prototype.squaredDifference=function(e,n){return U([e,n],"squaredDifference"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){var a=r-o;return a*a})},t.prototype.ceil=function(e){U(e,"ceil");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)r[o]=Math.ceil(n[o]);return this.makeOutput(r,e.shape,"float32")},t.prototype.floor=function(e){U(e,"floor");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)r[o]=Math.floor(n[o]);return this.makeOutput(r,e.shape,"float32")},t.prototype.sign=function(e){U(e,"x");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)n[o]<0?r[o]=-1:n[o]>0?r[o]=1:r[o]=0;return this.makeOutput(r,e.shape,"float32")},t.prototype.isNaN=function(e){U(e,"x");for(var n=this.readSync(e.dataId),r=new Uint8Array(n.length),o=0;o<n.length;++o)Number.isNaN(n[o])&&(r[o]=1);return this.makeOutput(r,e.shape,"bool")},t.prototype.isInf=function(e){U(e,"x");for(var n=this.readSync(e.dataId),r=new Uint8Array(n.length),o=0;o<n.length;++o)Math.abs(n[o])===1/0&&(r[o]=1);return this.makeOutput(r,e.shape,"bool")},t.prototype.isFinite=function(e){U(e,"x");for(var n=this.readSync(e.dataId),r=new Uint8Array(n.length),o=0;o<n.length;++o)Number.isFinite(n[o])&&(r[o]=1);return this.makeOutput(r,e.shape,"bool")},t.prototype.round=function(e){U(e,"round");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o){var a=Math.floor(n[o]);n[o]-a<.5?r[o]=Math.floor(n[o]):n[o]-a>.5?r[o]=Math.ceil(n[o]):r[o]=a%2==0?a:a+1}return this.makeOutput(r,e.shape,"float32")},t.prototype.exp=function(e){U(e,"exp");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)r[o]=Math.exp(n[o]);return this.makeOutput(r,e.shape,"float32")},t.prototype.expm1=function(e){U(e,"expm1");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)r[o]=Math.expm1(n[o]);return this.makeOutput(r,e.shape,"float32")},t.prototype.log=function(e){U(e,"log");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o){var a=n[o];r[o]=Math.log(a)}return this.makeOutput(r,e.shape,"float32")},t.prototype.log1p=function(e){U(e,"log1p");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o){var a=n[o];r[o]=Math.log1p(a)}return this.makeOutput(r,e.shape,"float32")},t.prototype.sqrt=function(e){U(e,"sqrt");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o){var a=n[o];r[o]=Math.sqrt(a)}return this.makeOutput(r,e.shape,"float32")},t.prototype.rsqrt=function(e){U(e,"rsqrt");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o){var a=n[o];r[o]=1/Math.sqrt(a)}return this.makeOutput(r,e.shape,"float32")},t.prototype.reciprocal=function(e){U(e,"reciprocal");for(var n=this.readSync(e.dataId),r=new Float32Array(n.length),o=0;o<n.length;++o)r[o]=1/n[o];return this.makeOutput(r,e.shape,"float32")},t.prototype.linear=function(e){return e},t.prototype.relu=function(e){U(e,"relu");for(var n=Le(e.shape,e.dtype),r=this.readSync(n.dataId),o=this.readSync(e.dataId),a=0;a<o.length;++a)r[a]=Math.max(0,o[a]);return n},t.prototype.relu6=function(e){U(e,"relu");for(var n=Le(e.shape,e.dtype),r=this.readSync(n.dataId),o=this.readSync(e.dataId),a=0;a<o.length;++a)r[a]=Math.min(Math.max(0,o[a]),6);return n},t.prototype.prelu=function(e,n){return U([e,n],"prelu"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){return r<0?o*r:r})},t.prototype.elu=function(e){U(e,"elu");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var a=r[o];n[o]=a>=0?a:Math.exp(a)-1}return this.makeOutput(n,e.shape,"float32")},t.prototype.eluDer=function(e,n){U([e,n],"eluDer");for(var r=new Float32Array(n.size),o=this.readSync(n.dataId),a=this.readSync(e.dataId),s=0;s<o.length;++s){var u=o[s];r[s]=u>=1?a[s]:a[s]*(u+1)}return this.makeOutput(r,n.shape,"float32")},t.prototype.selu=function(e){U(e,"selu");for(var n=yc,r=xc,o=new Float32Array(e.size),a=this.readSync(e.dataId),s=0;s<a.length;++s){var u=a[s];o[s]=u>=0?r*u:n*(Math.exp(u)-1)}return this.makeOutput(o,e.shape,"float32")},t.prototype.clip=function(e,n,r){U(e,"clip");for(var o=new Float32Array(e.size),a=this.readSync(e.dataId),s=0;s<a.length;++s){var u=a[s];o[s]=u>r?r:u<n?n:u}return this.makeOutput(o,e.shape,"float32")},t.prototype.abs=function(e){for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.abs(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.complexAbs=function(e){for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<e.size;++o){var a=r[2*o],s=r[2*o+1];n[o]=Math.hypot(a,s)}return this.makeOutput(n,e.shape,"float32")},t.prototype.int=function(e){U(e,"int");for(var n=new Int32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=r[o];return this.makeOutput(n,e.shape,"int32")},t.prototype.sigmoid=function(e){U(e,"sigmoid");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=1/(1+Math.exp(-r[o]));return this.makeOutput(n,e.shape,"float32")},t.prototype.softplus=function(e){U(e,"softplus");for(var n=Math.log(11920928955078125e-23)+2,r=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var s=o[a]>-n,u=o[a]<n,c=Math.exp(o[a]),l=void 0;l=u?c:s?o[a]:Math.log(1+c),r[a]=l}return this.makeOutput(r,e.shape,"float32")},t.prototype.sin=function(e){U(e,"sin");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.sin(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.cos=function(e){U(e,"cos");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.cos(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.tan=function(e){U(e,"tan");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.tan(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.asin=function(e){U(e,"asin");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.asin(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.acos=function(e){U(e,"acos");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.acos(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atan=function(e){U(e,"atan");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.atan(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atan2=function(e,n){return U([e,n],"atan2"),this.broadcastedBinaryOp(e,n,e.dtype,function(r,o){return Math.atan2(r,o)})},t.prototype.sinh=function(e){U(e,"sinh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.sinh(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.cosh=function(e){U(e,"cosh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.cosh(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.tanh=function(e){U(e,"tanh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Vp(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.asinh=function(e){U(e,"asinh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.asinh(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.acosh=function(e){U(e,"acosh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.acosh(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.atanh=function(e){U(e,"atanh");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o)n[o]=Math.atanh(r[o]);return this.makeOutput(n,e.shape,"float32")},t.prototype.erf=function(e){U(e,"erf");for(var n=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var a=Math.sign(r[o]),s=Math.abs(r[o]),u=1/(1+.3275911*s);n[o]=a*(1-((((1.061405429*u-1.453152027)*u+1.421413741)*u-.284496736)*u+.254829592)*u*Math.exp(-s*s))}return this.makeOutput(n,e.shape,"float32")},t.prototype.step=function(e,n){n===void 0&&(n=0),U(e,"step");for(var r=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var s=o[a];isNaN(s)?r[a]=NaN:r[a]=s>0?1:n}return this.makeOutput(r,e.shape,"float32")},t.prototype.fusedConv2d=function(e){var n=e.input,r=e.filter,o=e.convInfo,a=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.conv2d(n,r,o);return a&&(c=this.add(c,a)),s&&(c=bu(this,c,s,u)),c},t.prototype.conv2d=function(e,n,r){U([e,n],"conv2d");for(var o=r.filterHeight,a=r.filterWidth,s=r.dilationHeight,u=r.dilationWidth,c=r.padInfo.left,l=r.padInfo.top,f=r.dataFormat==="channelsLast",h=le(r.outShape,e.dtype),p=e.strides[0],d=f?e.strides[1]:e.strides[2],m=f?e.strides[2]:1,v=f?1:e.strides[1],g=h.strides[0],x=f?h.strides[1]:h.strides[2],w=f?h.strides[2]:1,y=f?1:h.strides[1],b=this.readSync(e.dataId),C=this.readSync(n.dataId),S=h.values,A=0;A<r.batchSize;++A)for(var k=A*p,D=A*g,T=0;T<r.outHeight;++T)for(var I=D+T*x,W=T*r.strideHeight-l,B=0;B<o;B++){var L=W+B*s;if(!(L<0||L>=r.inHeight))for(var V=B*n.strides[0],q=k+L*d,z=0;z<r.outWidth;++z)for(var G=I+z*w,H=z*r.strideWidth-c,Z=0;Z<a;Z++){var ie=H+Z*u;if(!(ie<0||ie>=r.inWidth))for(var ae=q+ie*m,de=V+Z*n.strides[1],me=0;me<r.inChannels;++me){for(var xe=b[ae+me*v],Ee=0;Ee<r.outChannels;++Ee)S[G+Ee*y]+=xe*C[de+Ee];de+=r.outChannels}}}return h.toTensor()},t.prototype.conv3d=function(e,n,r){for(var o=r.filterDepth,a=r.filterHeight,s=r.filterWidth,u=r.dilationDepth,c=r.dilationHeight,l=r.dilationWidth,f=r.padInfo.front,h=r.padInfo.left,p=r.padInfo.top,d=le(r.outShape,e.dtype),m=this.readSync(e.dataId),v=this.readSync(n.dataId),g=d.values,x=0;x<r.batchSize;++x)for(var w=x*e.strides[0],y=x*d.strides[0],b=0;b<r.outDepth;++b)for(var C=y+b*d.strides[1],S=b*r.strideDepth-f,A=0;A<o;A++){var k=S+A*u;if(!(k<0||k>=r.inDepth))for(var D=A*n.strides[0],T=w+k*e.strides[1],I=0;I<r.outHeight;++I)for(var W=C+I*d.strides[2],B=I*r.strideHeight-p,L=0;L<a;L++){var V=B+L*c;if(!(V<0||V>=r.inHeight))for(var q=D+L*n.strides[1],z=T+V*e.strides[2],G=0;G<r.outWidth;++G)for(var H=W+G*r.outChannels,Z=G*r.strideWidth-h,ie=0;ie<s;ie++){var ae=Z+ie*l;if(!(ae<0||ae>=r.inWidth))for(var de=q+ie*n.strides[2],me=z+ae*r.inChannels,xe=de,Ee=0;Ee<r.inChannels;++Ee){for(var Ce=m[me+Ee],ke=0;ke<r.outChannels;++ke)g[H+ke]+=Ce*v[xe+ke];xe+=r.outChannels}}}}return d.toTensor()},t.prototype.conv2dDerInput=function(e,n,r){U([e,n],"conv2dDerInput");for(var o=le(r.inShape,"float32"),a=o.values,s=this.readSync(e.dataId),u=this.readSync(n.dataId),c=n.strides,l=c[0],f=c[1],h=c[2],p=r.batchSize,d=r.filterHeight,m=r.filterWidth,v=r.inChannels,g=r.inHeight,x=r.inWidth,w=r.outChannels,y=r.outHeight,b=r.outWidth,C=r.strideHeight,S=r.strideWidth,A=r.dataFormat,k=d-1-r.padInfo.top,D=m-1-r.padInfo.left,T=A==="channelsLast",I=o.strides[0],W=T?o.strides[1]:o.strides[2],B=T?o.strides[2]:1,L=T?1:o.strides[1],V=e.strides[0],q=T?e.strides[1]:e.strides[2],z=T?e.strides[2]:1,G=T?1:e.strides[1],H=0;H<p;++H)for(var Z=0;Z<v;++Z)for(var ie=0;ie<g;++ie)for(var ae=ie-k,de=Math.max(0,Math.ceil(ae/C)),me=Math.min(y,(d+ae)/C),xe=0;xe<x;++xe){for(var Ee=xe-D,Ce=Math.max(0,Math.ceil(Ee/S)),ke=Math.min(b,(m+Ee)/S),$e=0,_e=de;_e<me;++_e)for(var Pe=_e*C-ae,Se=Ce;Se<ke;++Se)for(var Ke=V*H+q*_e+z*Se,Ve=l*(d-1-Pe)+f*(m-1-(Se*S-Ee))+h*Z,Ue=0;Ue<w;++Ue)$e+=s[Ke+G*Ue]*u[Ve+Ue];a[I*H+W*ie+B*xe+L*Z]=$e}return o.toTensor()},t.prototype.conv3dDerInput=function(e,n,r){for(var o=le(r.inShape,"float32"),a=o.values,s=o.strides,u=s[0],c=s[1],l=s[2],f=s[3],h=this.readSync(e.dataId),p=e.strides,d=p[0],m=p[1],v=p[2],g=p[3],x=this.readSync(n.dataId),w=n.strides,y=w[0],b=w[1],C=w[2],S=w[3],A=r.batchSize,k=r.filterDepth,D=r.filterHeight,T=r.filterWidth,I=r.inChannels,W=r.inDepth,B=r.inHeight,L=r.inWidth,V=r.outChannels,q=r.outDepth,z=r.outHeight,G=r.outWidth,H=r.strideDepth,Z=r.strideHeight,ie=r.strideWidth,ae=k-1-r.padInfo.front,de=D-1-r.padInfo.top,me=T-1-r.padInfo.left,xe=0;xe<A;++xe)for(var Ee=0;Ee<I;++Ee)for(var Ce=0;Ce<W;++Ce)for(var ke=Ce-ae,$e=Math.max(0,Math.ceil(ke/H)),_e=Math.min(q,(k+ke)/H),Pe=0;Pe<B;++Pe)for(var Se=Pe-de,Ke=Math.max(0,Math.ceil(Se/Z)),Ve=Math.min(z,(D+Se)/Z),Ue=0;Ue<L;++Ue){for(var on=Ue-me,an=Math.max(0,Math.ceil(on/ie)),Mt=Math.min(G,(T+on)/ie),_r=0,yn=$e;yn<_e;++yn)for(var Ln=yn*H-ke,xn=Ke;xn<Ve;++xn)for(var Er=xn*Z-Se,bn=an;bn<Mt;++bn)for(var La=d*xe+m*yn+v*xn+g*bn,kr=y*(k-1-Ln)+b*(D-1-Er)+C*(T-1-(bn*ie-on))+S*Ee,sn=0;sn<V;++sn)_r+=h[La+sn]*x[kr+sn];a[u*xe+c*Ce+l*Pe+f*Ue+Ee]=_r}return o.toTensor()},t.prototype.conv2dDerFilter=function(e,n,r){U([e,n],"conv2dDerFilter");for(var o=r.strideHeight,a=r.strideWidth,s=r.filterHeight,u=r.filterWidth,c=r.dataFormat==="channelsLast",l=le(r.filterShape,"float32"),f=r.padInfo.left,h=r.padInfo.top,p=this.bufferSync(e),d=this.bufferSync(n),m=0;m<s;++m)for(var v=Math.max(0,Math.ceil((h-m)/o)),g=Math.min(r.outHeight,(r.inHeight+h-m)/o),x=0;x<u;++x)for(var w=Math.max(0,Math.ceil((f-x)/a)),y=Math.min(r.outWidth,(r.inWidth+f-x)/a),b=0;b<r.inChannels;++b)for(var C=0;C<r.outChannels;++C){for(var S=0,A=0;A<r.batchSize;++A)for(var k=v;k<g;++k)for(var D=m+k*o-h,T=w;T<y;++T){var I=x+T*a-f;S+=c?p.get(A,D,I,b)*d.get(A,k,T,C):p.get(A,b,D,I)*d.get(A,C,k,T)}l.set(S,m,x,b,C)}return l.toTensor()},t.prototype.conv3dDerFilter=function(e,n,r){for(var o=r.strideDepth,a=r.strideHeight,s=r.strideWidth,u=r.filterDepth,c=r.filterHeight,l=r.filterWidth,f=le(r.filterShape,"float32"),h=f.values,p=f.strides,d=p[0],m=p[1],v=p[2],g=p[3],x=this.readSync(n.dataId),w=n.strides,y=w[0],b=w[1],C=w[2],S=w[3],A=this.readSync(e.dataId),k=e.strides,D=k[0],T=k[1],I=k[2],W=k[3],B=r.padInfo.front,L=r.padInfo.left,V=r.padInfo.top,q=0;q<u;++q)for(var z=Math.max(0,Math.ceil((B-q)/o)),G=Math.min(r.outDepth,(r.inDepth+B-q)/o),H=q*d,Z=0;Z<c;++Z)for(var ie=Math.max(0,Math.ceil((V-Z)/a)),ae=Math.min(r.outHeight,(r.inHeight+V-Z)/a),de=Z*m+H,me=0;me<l;++me)for(var xe=Math.max(0,Math.ceil((L-me)/s)),Ee=Math.min(r.outWidth,(r.inWidth+L-me)/s),Ce=me*v+de,ke=0;ke<r.inChannels;++ke)for(var $e=ke*g+Ce,_e=0;_e<r.outChannels;++_e){for(var Pe=0,Se=0;Se<r.batchSize;++Se)for(var Ke=Se*D,Ve=Se*y,Ue=z;Ue<G;++Ue)for(var on=(q+Ue*o-B)*T+Ke,an=Ue*b+Ve,Mt=ie;Mt<ae;++Mt)for(var _r=(Z+Mt*a-V)*I+on,yn=Mt*C+an,Ln=xe;Ln<Ee;++Ln){var xn=Ln*S+yn;Pe+=A[(me+Ln*s-L)*W+_r+ke]*x[xn+_e]}h[$e+_e]=Pe}return f.toTensor()},t.prototype.fusedDepthwiseConv2D=function(e){var n=e.input,r=e.filter,o=e.convInfo,a=e.bias,s=e.activation,u=e.preluActivationWeights,c=this.depthwiseConv2D(n,r,o);return a&&(c=this.add(c,a)),s&&(c=bu(this,c,s,u)),c},t.prototype.depthwiseConv2D=function(e,n,r){U([e,n],"depthwiseConv2D");for(var o=r.filterHeight,a=r.filterWidth,s=r.dilationHeight,u=r.dilationWidth,c=r.padInfo.left,l=r.padInfo.top,f=r.outChannels/r.inChannels,h=le(r.outShape,e.dtype),p=this.readSync(e.dataId),d=this.readSync(n.dataId),m=h.values,v=0;v<r.batchSize;++v)for(var g=v*e.strides[0],x=v*h.strides[0],w=0;w<r.outHeight;++w)for(var y=x+w*h.strides[1],b=w*r.strideHeight-c,C=0;C<o;++C){var S=b+C*s;if(!(S<0||S>=r.inHeight))for(var A=C*n.strides[0],k=g+S*e.strides[1],D=0;D<r.outWidth;++D)for(var T=y+D*h.strides[2],I=D*r.strideWidth-l,W=0;W<a;++W){var B=I+W*u;if(!(B<0||B>=r.inWidth))for(var L=A+W*n.strides[1],V=k+B*r.inChannels,q=T,z=L,G=0;G<r.inChannels;++G){for(var H=p[V+G],Z=0;Z<f;++Z)m[q+Z]+=H*d[z+Z];q+=f,z+=f}}}return h.toTensor()},t.prototype.depthwiseConv2DDerInput=function(e,n,r){U([e,n],"depthwiseConv2DDerInput");for(var o=le(r.inShape,"float32"),a=o.values,s=o.strides,u=s[0],c=s[1],l=s[2],f=this.readSync(e.dataId),h=e.strides,p=h[0],d=h[1],m=h[2],v=this.readSync(n.dataId),g=n.strides,x=g[0],w=g[1],y=g[2],b=r.batchSize,C=r.filterHeight,S=r.filterWidth,A=r.inChannels,k=r.inHeight,D=r.inWidth,T=r.outChannels,I=r.outHeight,W=r.outWidth,B=r.strideHeight,L=r.strideWidth,V=C-1-r.padInfo.top,q=S-1-r.padInfo.left,z=T/A,G=0;G<b;++G)for(var H=0;H<A;++H)for(var Z=0;Z<k;++Z)for(var ie=Z-V,ae=Math.max(0,Math.ceil(ie/B)),de=Math.min(I,(C+ie)/B),me=0;me<D;++me){for(var xe=me-q,Ee=Math.max(0,Math.ceil(xe/L)),Ce=Math.min(W,(S+xe)/L),ke=0,$e=ae;$e<de;++$e)for(var _e=$e*B-ie,Pe=Ee;Pe<Ce;++Pe)for(var Se=p*G+d*$e+m*Pe,Ke=x*(C-1-_e)+w*(S-1-(Pe*L-xe))+y*H,Ve=0;Ve<z;++Ve)ke+=f[Se+(H*z+Ve)]*v[Ke+Ve];a[u*G+c*Z+l*me+H]=ke}return o.toTensor()},t.prototype.depthwiseConv2DDerFilter=function(e,n,r){U([e,n],"depthwiseConv2DDerFilter");for(var o=r.strideHeight,a=r.strideWidth,s=r.filterHeight,u=r.filterWidth,c=le(r.filterShape,"float32"),l=r.padInfo.left,f=r.padInfo.top,h=r.outChannels/r.inChannels,p=this.bufferSync(e),d=this.bufferSync(n),m=0;m<s;++m)for(var v=Math.max(0,Math.ceil((f-m)/o)),g=Math.min(r.outHeight,(r.inHeight+f-m)/o),x=0;x<u;++x)for(var w=Math.max(0,Math.ceil((l-x)/a)),y=Math.min(r.outWidth,(r.inWidth+l-x)/a),b=0;b<r.outChannels;++b){for(var C=Math.trunc(b/h),S=b%h,A=0,k=0;k<r.batchSize;++k)for(var D=v;D<g;++D)for(var T=m+D*o-f,I=w;I<y;++I){var W=x+I*a-l;A+=p.get(k,T,W,C)*d.get(k,D,I,b)}c.set(A,m,x,C,S)}return c.toTensor()},t.prototype.tile=function(e,n){return U(e,"tile"),Kd(this.bufferSync(e),n)},t.prototype.pad=function(e,n,r){U(e,"pad");var o=n.map(function(h,p){return h[0]+e.shape[p]+h[1]}),a=n.map(function(h){return h[0]}),s=this.bufferSync(e),u=le(o,e.dtype);r!==0&&u.values.fill(r);for(var c=0;c<e.size;c++){var l=s.indexToLoc(c),f=l.map(function(h,p){return h+a[p]});u.set.apply(u,[s.get.apply(s,l)].concat(f))}return u.toTensor()},t.prototype.transpose=function(e,n){U(e,"transpose");for(var r=new Array(e.rank),o=0;o<r.length;o++)r[o]=e.shape[n[o]];var a=this.readSync(e.dataId),s=le(r,e.dtype),u=this.bufferSync(e);for(o=0;o<e.size;++o){for(var c=u.indexToLoc(o),l=new Array(c.length),f=0;f<l.length;f++)l[f]=c[n[f]];var h=s.locToIndex(l);s.values[h]=a[o]}return s.toTensor()},t.prototype.gather=function(e,n,r){U([e,n],"gather");var o=e.shape.slice(),a=this.readSync(n.dataId);o[r]=a.length;for(var s=le(o,e.dtype),u=this.bufferSync(e),c=0;c<s.size;++c){var l=s.indexToLoc(c),f=l.slice();f[r]=a[l[r]];var h=u.locToIndex(f);s.values[c]=u.values[h]}return s.toTensor()},t.prototype.batchToSpaceND=function(e,n,r){U([e],"batchToSpaceND");var o=n.reduce(function(f,h){return f*h}),a=Go(e.shape,n,o),s=Ho(a.length,n.length),u=Ko(e.shape,n,o),c=Od(r,n.length),l=Bd(u,r,n.length);return e.reshape(a).transpose(s).reshape(u).slice(c,l)},t.prototype.spaceToBatchND=function(e,n,r){U([e],"spaceToBatchND");var o=n.reduce(function(h,p){return h*p}),a=[[0,0]];a.push.apply(a,r);for(var s=1+n.length;s<e.shape.length;++s)a.push([0,0]);var u=e.pad(a),c=Go(u.shape,n,o,!1),l=Ho(c.length,n.length,!1),f=Ko(u.shape,n,o,!1);return u.reshape(c).transpose(l).reshape(f)},t.prototype.pool=function(e,n,r){U(e,"pool");for(var o=n.strideHeight,a=n.strideWidth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterHeight,l=n.effectiveFilterWidth,f=n.padInfo.top,h=n.padInfo.left,p=r==="max"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,d=this.readSync(e.dataId),m=le(n.outShape,e.dtype),v=m.values,g=n.outShape[1]*n.outShape[2]*n.outShape[3],x=n.outShape[2]*n.outShape[3],w=n.outShape[3],y=0;y<n.batchSize;++y)for(var b=y*g,C=y*e.strides[0],S=0;S<n.inChannels;++S)for(var A=0;A<n.outHeight;++A)for(var k=A*o-f,D=Math.max(0,k),T=Math.min(n.inHeight,c+k),I=b+A*x,W=0;W<n.outWidth;++W){for(var B=W*a-h,L=Math.max(0,B),V=Math.min(n.inWidth,l+B),q=p,z=0,G=0,H=D;H<T;H+=s){for(var Z=C+H*e.strides[1],ie=L;ie<V;ie+=u){var ae=d[Z+ie*e.strides[2]+S];r==="max"&&ae>q?q=ae:r==="avg"&&(z+=ae,G++)}if(isNaN(q))break}v[I+W*w+S]=r==="avg"?z/G:q}return m.toTensor()},t.prototype.maxPool=function(e,n){return this.pool(e,n,"max")},t.prototype.maxPoolPositions=function(e,n){for(var r=le(n.outShape,"int32"),o=n.strideHeight,a=n.strideWidth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterHeight,l=n.effectiveFilterWidth,f=n.padInfo.top,h=n.padInfo.left,p=this.bufferSync(e),d=0;d<n.batchSize;++d)for(var m=0;m<n.inChannels;++m)for(var v=0;v<n.outHeight;++v){for(var g=v*o-f,x=g;x<0;)x+=s;for(var w=Math.min(n.inHeight,c+g),y=0;y<n.outWidth;++y){for(var b=y*a-h,C=b;C<0;)C+=u;for(var S=Math.min(n.inWidth,l+b),A=Number.NEGATIVE_INFINITY,k=-1,D=x;D<w;D+=s)for(var T=D-g,I=C;I<S;I+=u){var W=I-b,B=p.get(d,D,I,m);B>A&&(A=B,k=T*l+W)}r.set(k,d,v,y,m)}}return r.toTensor()},t.prototype.maxPoolBackprop=function(e,n,r,o){U([n,r],"maxPoolBackprop");for(var a=this.maxPoolPositions(n,o),s=o.strideHeight,u=o.strideWidth,c=o.dilationHeight,l=o.dilationWidth,f=o.effectiveFilterHeight,h=o.effectiveFilterWidth,p=h-1-o.padInfo.left,d=f-1-o.padInfo.top,m=le(n.shape,"float32"),v=this.bufferSync(a),g=this.bufferSync(e),x=0;x<o.batchSize;++x)for(var w=0;w<o.inChannels;++w)for(var y=0;y<o.inHeight;++y)for(var b=0;b<o.inWidth;++b){for(var C=y-d,S=b-p,A=0,k=0;k<f;k+=c){var D=(C+k)/s;if(!(D<0||D>=o.outHeight||Math.floor(D)!==D))for(var T=0;T<h;T+=l){var I=(S+T)/u;if(!(I<0||I>=o.outWidth||Math.floor(I)!==I)){var W=f*h-1-v.get(x,D,I,w)===k*h+T?1:0;W!==0&&(A+=g.get(x,D,I,w)*W)}}}m.set(A,x,y,b,w)}return m.toTensor()},t.prototype.avgPoolBackprop=function(e,n,r){U([e,n],"avgPoolBackprop");for(var o=r.strideHeight,a=r.strideWidth,s=r.filterHeight,u=r.filterWidth,c=r.dilationHeight,l=r.dilationWidth,f=r.effectiveFilterHeight,h=r.effectiveFilterWidth,p=h-1-r.padInfo.left,d=f-1-r.padInfo.top,m=le(n.shape,"float32"),v=1/(s*u),g=this.bufferSync(e),x=0;x<r.batchSize;++x)for(var w=0;w<r.inChannels;++w)for(var y=0;y<r.inHeight;++y)for(var b=0;b<r.inWidth;++b){for(var C=y-d,S=b-p,A=0,k=0;k<f;k+=c){var D=(C+k)/o;if(!(D<0||D>=r.outHeight||Math.floor(D)!==D))for(var T=0;T<h;T+=l){var I=(S+T)/a;I<0||I>=r.outWidth||Math.floor(I)!==I||(A+=g.get(x,D,I,w))}}m.set(A*v,x,y,b,w)}return m.toTensor()},t.prototype.pool3d=function(e,n,r){U(e,"pool3d");for(var o=n.strideDepth,a=n.strideHeight,s=n.strideWidth,u=n.dilationDepth,c=n.dilationHeight,l=n.dilationWidth,f=n.effectiveFilterDepth,h=n.effectiveFilterHeight,p=n.effectiveFilterWidth,d=n.padInfo.front,m=n.padInfo.top,v=n.padInfo.left,g=r==="max"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,x=this.readSync(e.dataId),w=le(n.outShape,e.dtype),y=w.values,b=n.outShape[1]*n.outShape[2]*n.outShape[3]*n.outShape[4],C=n.outShape[2]*n.outShape[3]*n.outShape[4],S=n.outShape[3]*n.outShape[4],A=n.outShape[4],k=0;k<n.batchSize;++k)for(var D=k*b,T=k*e.strides[0],I=0;I<n.inChannels;++I)for(var W=0;W<n.outDepth;++W){for(var B=W*o-d,L=B;L<0;)L+=u;for(var V=Math.min(n.inDepth,f+B),q=D+W*C,z=0;z<n.outHeight;++z){for(var G=z*a-m,H=G;H<0;)H+=c;for(var Z=Math.min(n.inHeight,h+G),ie=q+z*S,ae=0;ae<n.outWidth;++ae){for(var de=ae*s-v,me=de;me<0;)me+=l;for(var xe=Math.min(n.inWidth,p+de),Ee=ie+ae*A,Ce=g,ke=0,$e=0,_e=L;_e<V;_e+=u){for(var Pe=T+_e*e.strides[1],Se=H;Se<Z;Se+=c){for(var Ke=Pe+Se*e.strides[2],Ve=me;Ve<xe;Ve+=l){var Ue=x[Ke+Ve*e.strides[3]+I];if(r==="max"&&Ue>Ce?Ce=Ue:r==="avg"&&(ke+=Ue,$e++),isNaN(Ce))break}if(isNaN(Ce))break}if(isNaN(Ce))break}y[Ee+I]=r==="avg"?ke/$e:Ce}}}return w.toTensor()},t.prototype.avgPool3d=function(e,n){return U(e,"avgPool3d"),this.pool3d(e,n,"avg").toFloat()},t.prototype.avgPool3dBackprop=function(e,n,r){U([e,n],"avgPool3dBackprop");for(var o=r.strideDepth,a=r.strideHeight,s=r.strideWidth,u=r.filterDepth,c=r.filterHeight,l=r.filterWidth,f=r.dilationDepth,h=r.dilationHeight,p=r.dilationWidth,d=r.effectiveFilterDepth,m=r.effectiveFilterHeight,v=r.effectiveFilterWidth,g=d-1-r.padInfo.front,x=v-1-r.padInfo.left,w=m-1-r.padInfo.top,y=le(n.shape,"float32"),b=1/(u*c*l),C=this.bufferSync(e),S=0;S<r.batchSize;++S)for(var A=0;A<r.inChannels;++A)for(var k=0;k<r.inDepth;++k)for(var D=0;D<r.inHeight;++D)for(var T=0;T<r.inWidth;++T){for(var I=k-g,W=D-w,B=T-x,L=0,V=0;V<d;V+=f){var q=(I+V)/o;if(!(q<0||q>=r.outDepth||Math.floor(q)!==q))for(var z=0;z<m;z+=h){var G=(W+z)/a;if(!(G<0||G>=r.outHeight||Math.floor(G)!==G))for(var H=0;H<v;H+=p){var Z=(B+H)/s;Z<0||Z>=r.outWidth||Math.floor(Z)!==Z||(L+=C.get(S,q,G,Z,A))}}}y.set(L*b,S,k,D,T,A)}return y.toTensor()},t.prototype.maxPool3d=function(e,n){return U(e,"maxPool3d"),this.pool3d(e,n,"max").toFloat()},t.prototype.maxPool3dPositions=function(e,n){for(var r=le(n.outShape,"int32"),o=n.strideDepth,a=n.strideHeight,s=n.strideWidth,u=n.dilationDepth,c=n.dilationHeight,l=n.dilationWidth,f=n.effectiveFilterDepth,h=n.effectiveFilterHeight,p=n.effectiveFilterWidth,d=n.padInfo.front,m=n.padInfo.top,v=n.padInfo.left,g=this.bufferSync(e),x=0;x<n.batchSize;++x)for(var w=0;w<n.inChannels;++w)for(var y=0;y<n.outDepth;++y){for(var b=y*o-d,C=b;C<0;)C+=u;for(var S=Math.min(n.inDepth,f+b),A=0;A<n.outHeight;++A){for(var k=A*a-m,D=k;D<0;)D+=c;for(var T=Math.min(n.inHeight,h+k),I=0;I<n.outWidth;++I){for(var W=I*s-v,B=W;B<0;)B+=l;for(var L=Math.min(n.inWidth,p+W),V=Number.NEGATIVE_INFINITY,q=-1,z=C;z<S;z+=u)for(var G=z-b,H=D;H<T;H+=c)for(var Z=H-k,ie=B;ie<L;ie+=l){var ae=ie-W,de=g.get(x,z,H,ie,w);de>=V&&(V=de,q=G*h*p+Z*h+ae)}r.set(q,x,y,A,I,w)}}}return r.toTensor()},t.prototype.maxPool3dBackprop=function(e,n,r,o){U([n,r],"maxPool3dBackprop");for(var a=this.maxPool3dPositions(n,o),s=o.strideDepth,u=o.strideHeight,c=o.strideWidth,l=o.dilationDepth,f=o.dilationHeight,h=o.dilationWidth,p=o.effectiveFilterDepth,d=o.effectiveFilterHeight,m=o.effectiveFilterWidth,v=p-1-o.padInfo.front,g=m-1-o.padInfo.left,x=d-1-o.padInfo.top,w=le(n.shape,"float32"),y=this.bufferSync(a),b=this.bufferSync(e),C=0;C<o.batchSize;++C)for(var S=0;S<o.inChannels;++S)for(var A=0;A<o.inDepth;++A)for(var k=0;k<o.inHeight;++k)for(var D=0;D<o.inWidth;++D){for(var T=A-v,I=k-x,W=D-g,B=0,L=0;L<p;L+=l){var V=(T+L)/s;if(!(V<0||V>=o.outDepth||Math.floor(V)!==V))for(var q=0;q<d;q+=f){var z=(I+q)/u;if(!(z<0||z>=o.outHeight||Math.floor(z)!==z))for(var G=0;G<m;G+=h){var H=(W+G)/c;if(!(H<0||H>=o.outWidth||Math.floor(H)!==H)){var Z=p*d*m-1-y.get(C,V,z,H,S)===L*d*m+q*m+G?1:0;Z!==0&&(B+=b.get(C,V,z,H,S)*Z)}}}}w.set(B,C,A,k,D,S)}return w.toTensor()},t.prototype.cast=function(e,n){return hc(e,n,this)},t.prototype.reshape=function(e,n){return $o(e,n)},t.prototype.avgPool=function(e,n){return U(e,"avgPool"),this.pool(e,n,"avg").toFloat()},t.prototype.resizeBilinear=function(e,n,r,o){U(e,"resizeBilinear");for(var a=e.shape,s=a[0],u=a[1],c=a[2],l=a[3],f=this.readSync(e.dataId),h=new Float32Array(re([s,n,r,l])),p=[o&&n>1?u-1:u,o&&r>1?c-1:c],d=[o&&n>1?n-1:n,o&&r>1?r-1:r],m=0,v=p[0]/d[0],g=p[1]/d[1],x=0;x<s;x++)for(var w=0;w<n;w++)for(var y=v*w,b=Math.floor(y),C=y-b,S=Math.min(u-1,Math.ceil(y)),A=x*e.strides[0]+b*e.strides[1],k=x*e.strides[0]+S*e.strides[1],D=0;D<r;D++)for(var T=g*D,I=Math.floor(T),W=T-I,B=Math.min(c-1,Math.ceil(T)),L=A+I*e.strides[2],V=k+I*e.strides[2],q=A+B*e.strides[2],z=k+B*e.strides[2],G=0;G<l;G++){var H=f[L+G],Z=f[V+G],ie=H+(f[q+G]-H)*W,ae=ie+(Z+(f[z+G]-Z)*W-ie)*C;h[m++]=ae}return st(h,[s,n,r,l])},t.prototype.resizeBilinearBackprop=function(e,n,r){U([e,n],"resizeBilinearBackprop");for(var o=n.shape,a=o[0],s=o[1],u=o[2],c=o[3],l=e.shape,f=l[1],h=l[2],p=new Float32Array(a*s*u*c),d=[r&&f>1?s-1:s,r&&h>1?u-1:u],m=[r&&f>1?f-1:f,r&&h>1?h-1:h],v=d[0]/m[0],g=d[1]/m[1],x=this.readSync(e.dataId),w=0,y=0;y<a;y++)for(var b=y*n.strides[0],C=0;C<f;C++)for(var S=C*v,A=Math.floor(S),k=Math.min(Math.ceil(S),s-1),D=b+A*n.strides[1],T=b+k*n.strides[1],I=S-A,W=1-I,B=0;B<h;B++)for(var L=B*g,V=Math.floor(L),q=Math.min(Math.ceil(L),u-1),z=L-V,G=1-z,H=D+V*n.strides[2],Z=D+q*n.strides[2],ie=T+V*n.strides[2],ae=T+q*n.strides[2],de=W*G,me=W*z,xe=I*G,Ee=I*z,Ce=0;Ce<c;Ce++){var ke=x[w++];p[H+Ce]+=ke*de,p[Z+Ce]+=ke*me,p[ie+Ce]+=ke*xe,p[ae+Ce]+=ke*Ee}return it(p,[a,u,s,c],n.dtype)},t.prototype.resizeNearestNeighbor=function(e,n,r,o){U(e,"resizeNearestNeighbor");for(var a=e.shape,s=a[0],u=a[1],c=a[2],l=a[3],f=this.readSync(e.dataId),h=new Float32Array(s*n*r*l),p=[o&&n>1?u-1:u,o&&r>1?c-1:c],d=[o&&n>1?n-1:n,o&&r>1?r-1:r],m=p[0]/d[0],v=p[1]/d[1],g=0,x=0;x<s;x++)for(var w=x*e.strides[0],y=0;y<n;y++)for(var b=m*y,C=w+Math.min(u-1,o?Math.round(b):Math.floor(b))*e.strides[1],S=0;S<r;S++)for(var A=v*S,k=C+Math.min(c-1,o?Math.round(A):Math.floor(A))*e.strides[2],D=0;D<l;D++){var T=f[k+D];h[g++]=T}return st(h,[s,n,r,l],e.dtype)},t.prototype.resizeNearestNeighborBackprop=function(e,n,r){U([e,n],"resizeNearestNeighborBackprop");for(var o=n.shape,a=o[0],s=o[1],u=o[2],c=o[3],l=e.shape,f=l[1],h=l[2],p=new Float32Array(a*s*u*c),d=this.readSync(e.dataId),m=[r&&f>1?s-1:s,r&&h>1?u-1:u],v=[r&&f>1?f-1:f,r&&h>1?h-1:h],g=m[0]/v[0],x=m[1]/v[1],w=1/g,y=1/x,b=2*Math.ceil(w)+2,C=2*Math.ceil(y)+2,S=0;S<a;S++)for(var A=S*n.strides[0],k=0;k<s;k++)for(var D=A+k*n.strides[1],T=Math.floor(k*w),I=Math.floor(T-b/2),W=0;W<u;W++)for(var B=D+W*n.strides[2],L=Math.floor(W*y),V=Math.floor(L-C/2),q=0;q<c;q++){for(var z=0,G=0;G<b;G++){var H=G+I;if(!(H<0||H>=f)){var Z=A+H*e.strides[1],ie=H*g;if(k===Math.min(s-1,r?Math.round(ie):Math.floor(ie)))for(var ae=0;ae<C;ae++){var de=ae+V;if(!(de<0||de>=h)){var me=Z+de*e.strides[2],xe=de*x;W===Math.min(u-1,r?Math.round(xe):Math.floor(xe))&&(z+=d[me+q])}}}}p[B+q]=z}return it(p,n.shape,n.dtype)},t.prototype.batchNormalization=function(e,n,r,o,a,s){U([e,n,r,a,s],"batchNorm");for(var u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=this.readSync(r.dataId),f=a?this.readSync(a.dataId):new Float32Array([1]),h=s?this.readSync(s.dataId):new Float32Array([0]),p=new Float32Array(u.length),d=h.length,m=f.length,v=l.length,g=c.length,x=0,w=0,y=0,b=0,C=0;C<u.length;++C)p[C]=h[x++]+(u[C]-c[w++])*f[y++]/Math.sqrt(l[b++]+o),x>=d&&(x=0),w>=g&&(w=0),y>=m&&(y=0),b>=v&&(b=0);return it(p,e.shape)},t.prototype.localResponseNormalization4D=function(e,n,r,o,a){U(e,"localResponseNormalization4D");var s=e.shape[3],u=s-1,c=this.readSync(e.dataId),l=e.size,f=new Float32Array(l);function h(v){for(var g=v%s,x=v-g+Math.max(0,g-n),w=v-g+Math.min(g+n,u),y=0;x<=w;x++){var b=c[x];y+=b*b}return y}for(var p=0;p<l;p++){var d=h(p),m=c[p]*Math.pow(r+o*d,-a);f[p]=m}return it(f,e.shape)},t.prototype.LRNGrad=function(e,n,r,o,a,s,u){U(e,"LRNGrad");for(var c=e.shape[3],l=this.readSync(e.dataId),f=this.readSync(n.dataId),h=this.readSync(r.dataId),p=new Float32Array(e.size),d=e.size,m=0;m<d;m++){for(var v=m%c,g=m-v+Math.max(0,v-o),x=m-v+Math.min(c,v+o+1),w=0,y=g;y<x;y++)w+=Math.pow(f[y],2);for(w=s*w+a,y=g;y<x;y++){var b=-2*s*u*f[y]*h[m]/w;m===y&&(b+=Math.pow(w,-u)),b*=l[m],p[y]+=b}}return it(p,e.shape)},t.prototype.multinomial=function(e,n,r,o){U(e,"multinomial");for(var a=n?e:St(e),s=a.shape[0],u=a.shape[1],c=Le([s,r],"int32"),l=this.readSync(c.dataId),f=this.readSync(a.dataId),h=0;h<s;++h){var p=h*u,d=new Float32Array(u-1);d[0]=f[p];for(var m=1;m<d.length;++m)d[m]=d[m-1]+f[p+m];for(var v=na(o.toString()),g=h*r,x=0;x<r;++x){var w=v();l[g+x]=d.length;for(var y=0;y<d.length;y++)if(w<d[y]){l[g+x]=y;break}}}return c},t.prototype.oneHot=function(e,n,r,o){U(e,"oneHot");var a=new Float32Array(e.size*n);a.fill(o);for(var s=this.readSync(e.dataId),u=0;u<e.size;++u)s[u]>=0&&s[u]<n&&(a[u*n+s[u]]=r);return hn(a,[e.size,n],"int32")},t.prototype.nonMaxSuppression=function(e,n,r,o,a){return U(e,"nonMaxSuppression"),dc(this.readSync(e.dataId),this.readSync(n.dataId),r,o,a)},t.prototype.fft=function(e){return this.fftBatch(e,!1)},t.prototype.ifft=function(e){return this.fftBatch(e,!0)},t.prototype.fftBatch=function(e,n){for(var r=e.shape[0],o=e.shape[1],a=le(e.shape,"float32"),s=le(e.shape,"float32"),u=Vt(e).as2D(r,o),c=fn(e).as2D(r,o),l=0;l<r;l++)for(var f=u.slice([l,0],[1,o]),h=c.slice([l,0],[1,o]),p=ht(f,h),d=this.readSync(this.fftImpl(p,n).dataId),m=0;m<o;m++){var v=op(d,m);a.values[l*o+m]=v.real,s.values[l*o+m]=v.imag}return ht(a.toTensor(),s.toTensor()).as2D(r,o)},t.prototype.fftImpl=function(e,n){var r=e.as1D(),o=r.size;if(this.isExponentOf2(o)){var a=this.fftRadix2(r,o,n).as2D(e.shape[0],e.shape[1]);return n&&(a=ht(Vt(a).div(Y(o)),fn(a).div(Y(o)))),a}var s=this.readSync(e.dataId),u=function(c){for(var l=new Float32Array(c.length/2),f=new Float32Array(c.length/2),h=0;h<c.length;h+=2)l[h/2]=c[h],f[h/2]=c[h+1];return{real:l,imag:f}}(this.fourierTransformByMatmul(s,o,n));return ht(u.real,u.imag).as2D(e.shape[0],e.shape[1])},t.prototype.isExponentOf2=function(e){return(e&e-1)==0},t.prototype.fftRadix2=function(e,n,r){if(n===1)return e;var o=this.readSync(e.dataId),a=n/2,s=function(g){for(var x=Math.ceil(g.length/4),w=new Float32Array(x),y=new Float32Array(x),b=0;b<g.length;b+=4)w[Math.floor(b/4)]=g[b],y[Math.floor(b/4)]=g[b+1];return{real:w,imag:y}}(o),u=ht(s.real,s.imag).as1D(),c=function(g){for(var x=Math.floor(g.length/4),w=new Float32Array(x),y=new Float32Array(x),b=2;b<g.length;b+=4)w[Math.floor(b/4)]=g[b],y[Math.floor(b/4)]=g[b+1];return{real:w,imag:y}}(o),l=ht(c.real,c.imag).as1D();u=this.fftRadix2(u,a,r),l=this.fftRadix2(l,a,r);var f=function(g,x){for(var w=new Float32Array(g/2),y=new Float32Array(g/2),b=0;b<Math.ceil(g/2);b++){var C=(x?2:-2)*Math.PI*(b/g);w[b]=Math.cos(C),y[b]=Math.sin(C)}return{real:w,imag:y}}(n,r),h=ht(f.real,f.imag).mul(l),p=u.add(h),d=u.sub(h),m=Vt(p).concat(Vt(d)),v=fn(p).concat(fn(d));return ht(m,v).as1D()},t.prototype.fourierTransformByMatmul=function(e,n,r){for(var o=new Float32Array(2*n),a=0;a<n;a++){for(var s=0,u=0,c=0;c<n;c++){var l=Hx(a*c,n,r),f=op(e,c);s+=f.real*l.real-f.imag*l.imag,u+=f.real*l.imag+f.imag*l.real}r&&(s/=n,u/=n),Gx(o,s,u,a)}return o},t.prototype.depthToSpace=function(e,n,r){E(r==="NHWC",function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+r}),E(n>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});for(var o=e.shape[0],a=e.shape[1],s=e.shape[2],u=e.shape[3],c=a*n,l=s*n,f=u/(n*n),h=this.readSync(e.dataId),p=new Float32Array(o*c*l*f),d=0,m=0;m<o;++m)for(var v=0;v<c;++v)for(var g=Math.floor(v/n),x=v%n,w=0;w<l;++w)for(var y=Math.floor(w/n),b=(x*n+w%n)*f,C=0;C<f;++C){var S=C+b+u*(y+s*(g+a*m));p[d++]=h[S]}return it(p,[o,c,l,f])},t.prototype.broadcastedBinaryOp=function(e,n,r,o){var a=ye(e.shape,n.shape),s=le(a,r),u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=kn(e.shape,a),f=kn(n.shape,a),h=s.values;if(l.length+f.length===0)for(var p=0;p<h.length;++p)h[p]=o(u[p%u.length],c[p%c.length]);else{var d=this.bufferSync(e),m=this.bufferSync(n),v=function(g){var x=s.indexToLoc(g),w=x.slice(-e.rank);l.forEach(function(S){return w[S]=0});var y=d.locToIndex(w),b=x.slice(-n.rank);f.forEach(function(S){return b[S]=0});var C=m.locToIndex(b);h[g]=o(u[y],c[C])};for(p=0;p<h.length;++p)v(p)}return s.toTensor()},t.prototype.broadcastedBinaryComplexOp=function(e,n,r){var o=ye(e.shape,n.shape),a=le(o,"float32"),s=le(o,"float32"),u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=kn(e.shape,o),f=kn(n.shape,o),h=a.values,p=s.values;if(l.length+f.length===0)for(var d=0;d<h.length;d++){var m=d%u.length,v=d%c.length,g=r(u[2*m],u[2*m+1],c[2*v],c[2*v+1]);h[d]=g.real,p[d]=g.imag}else{var x=this.bufferSync(this.data.get(e.dataId).complexTensors.real),w=this.bufferSync(this.data.get(n.dataId).complexTensors.real),y=function(b){var C=a.indexToLoc(b),S=C.slice(-e.rank);l.forEach(function(I){return S[I]=0});var A=x.locToIndex(S),k=C.slice(-n.rank);f.forEach(function(I){return k[I]=0});var D=w.locToIndex(k),T=r(u[2*A],u[2*A+1],c[2*D],c[2*D+1]);h[b]=T.real,p[b]=T.imag};for(d=0;d<h.length;d++)y(d)}return this.complex(a.toTensor(),s.toTensor())},t.prototype.split=function(e,n,r){return Hd(e,n,r)},t.prototype.dispose=function(){},t.prototype.floatPrecision=function(){return 32},t.prototype.epsilon=function(){return 1e-7},t.prototype.cropAndResize=function(e,n,r,o,a,s){for(var u=e.shape,c=u[0],l=u[1],f=u[2],h=u[3],p=n.shape[0],d=o[0],m=o[1],v=le([p,d,m,h],"float32"),g=this.readSync(n.dataId),x=this.readSync(r.dataId),w=this.readSync(e.dataId),y=e.strides,b=v.strides,C=0;C<p;C++){var S=4*C,A=g[S],k=g[S+1],D=g[S+2],T=g[S+3],I=x[C];if(!(I>=c))for(var W=d>1?(D-A)*(l-1)/(d-1):0,B=m>1?(T-k)*(f-1)/(m-1):0,L=0;L<d;L++){var V=d>1?A*(l-1)+L*W:.5*(A+D)*(l-1);if(V<0||V>l-1)for(var q=0;q<m;q++)for(var z=0;z<h;z++){var G=z+q*b[2]+L*b[1]+C*b[0];v.values[G]=s}else if(a==="bilinear"){var H=Math.floor(V),Z=Math.ceil(V),ie=V-H;for(q=0;q<m;q++)if((_e=m>1?k*(f-1)+q*B:.5*(k+T)*(f-1))<0||_e>f-1)for(z=0;z<h;z++)G=z+q*b[2]+L*b[1]+C*b[0],v.values[G]=s;else{var ae=Math.floor(_e),de=Math.ceil(_e),me=_e-ae;for(z=0;z<h;z++){var xe=w[G=z+ae*y[2]+H*y[1]+I*y[0]],Ee=w[G=z+de*y[2]+H*y[1]+I*y[0]],Ce=w[G=z+ae*y[2]+Z*y[1]+I*y[0]],ke=xe+(Ee-xe)*me,$e=Ce+(w[G=z+de*y[2]+Z*y[1]+I*y[0]]-Ce)*me;G=z+q*b[2]+L*b[1]+C*b[0],v.values[G]=ke+($e-ke)*ie}}}else for(q=0;q<m;++q){var _e;if((_e=m>1?k*(f-1)+q*B:.5*(k+T)*(f-1))<0||_e>f-1)for(z=0;z<h;z++)G=z+q*b[2]+L*b[1]+C*b[0],v.values[G]=s;else{var Pe=Math.round(_e),Se=Math.round(V);for(z=0;z<h;z++){var Ke=z+Pe*y[2]+Se*y[1]+I*y[0],Ve=z+q*b[2]+L*b[1]+C*b[0];v.values[Ve]=w[Ke]}}}}}return v.toTensor()},t.prototype.sparseToDense=function(e,n,r,o){var a=Ii(0,e,r),s=a.sliceRank,u=a.numUpdates,c=a.sliceSize,l=a.strides,f=a.outputSize;return this.scatter(e,n,r,f,c,u,s,l,o,!1)},t.prototype.gatherND=function(e,n){var r=n.shape,o=r[r.length-1],a=sc(e,n),s=a[0],u=a[1],c=a[2],l=a[3];if(u===0)return st([],s,e.dtype);for(var f=new Si([u,c],e.dtype),h=this.readSync(n.dataId),p=this.readSync(e.dataId),d=0;d<u;d++){for(var m=[],v=0,g=0;g<o;g++){var x=h[d*o+g];v+=x*l[g],m.push(x)}if(v<0||v>=e.size/c)throw new Error("Invalid indices: "+m+" does not index into "+e.shape);for(var w=0;w<c;w++)f.values[d*c+w]=p[v*c+w]}return f.toTensor().reshape(s)},t.prototype.scatterND=function(e,n,r){var o=Ii(0,e,r),a=o.sliceRank,s=o.numUpdates,u=o.sliceSize,c=o.strides,l=o.outputSize,f=Y(0);return this.scatter(e,n,r,l,u,s,a,c,f,!0)},t.prototype.fill=function(e,n,r){var o=ki(r=r||Ur(n),re(e));return o.fill(n),R.makeTensor(o,e,r,this)},t.prototype.onesLike=function(e){if(e.dtype==="string")throw new Error("onesLike is not supported for string tensors");return this.fill(e.shape,1,e.dtype)},t.prototype.zerosLike=function(e){var n=ki(e.dtype,re(e.shape));return this.makeOutput(n,e.shape,e.dtype)},t.prototype.linspace=function(e,n,r){return pc(e,n,r)},t.prototype.scatter=function(e,n,r,o,a,s,u,c,l,f){var h=[o/a,a],p=this.readSync(e.dataId),d=this.readSync(n.dataId);if(o===0)return st([],r,n.dtype);var m=new Si(h,n.dtype);m.values.fill(this.readSync(l.dataId)[0]);for(var v=0;v<s;v++){for(var g=[],x=0,w=0;w<u;w++){var y=p[v*u+w];g.push(y),x+=y*c[w]}if(x<0||x>=o/a)throw new Error("Invalid indices: "+g+" does not index into "+r);for(var b=0;b<a;b++)f?m.values[x*a+b]+=d[v*a+b]:m.values[x*a+b]=n.rank===0?d[0]:d[v*a+b]}return m.toTensor().reshape(r)},t}(jd);R.registerBackend("cpu",function(){return new $C},1);for(So=0,wu=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=i.attrs,r=t,o=r.boxes,a=r.scores,s=n,u=s.maxOutputSize,c=s.iouThreshold,l=s.scoreThreshold,f=s.softNmsSigma,h=e;U(o,"NonMaxSuppressionWithScore");var p=mc(h.data.get(o.dataId).values,h.data.get(a.dataId).values,u,c,l,f);return[p.selectedIndices,p.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=t.x,r=e;U(n,"square");for(var o=r.data.get(n.dataId).values,a=new Float32Array(o.length),s=0;s<o.length;++s){var u=o[s];a[s]=u*u}return{dataId:r.write(a,n.shape,n.dtype),shape:n.shape,dtype:n.dtype}}},{kernelName:Pi,backendName:"cpu",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=t,r=n.a,o=n.b,a=e;U([r,o],Pi);var s=a.data.get(r.dataId).values,u=a.data.get(o.dataId).values,c=function(h,p,d,m,v,g){var x=ye(h,p),w=x.length,y=Yt(x),b=qr(v,re(x)),C=h.length,S=p.length,A=Yt(h),k=Yt(p),D=kn(h,x),T=kn(p,x);if(D.length+T.length===0)for(var I=0;I<b.length;++I)b[I]=g(d[I%d.length],m[I%m.length]);else{var W=function(B){var L=Jp(B,w,y),V=L.slice(-C);D.forEach(function(H){return V[H]=0});var q=Nu(V,C,A),z=L.slice(-S);T.forEach(function(H){return z[H]=0});var G=Nu(z,S,k);b[B]=g(d[q],m[G])};for(I=0;I<b.length;++I)W(I)}return[b,x]}(r.shape,o.shape,s,u,r.dtype,function(h,p){var d=h-p;return d*d}),l=c[0],f=c[1];return{dataId:a.write(l,f,r.dtype),shape:f,dtype:r.dtype}}}];So<wu.length;So++)Wp(wu[So]);var So,wu,Ir,YC=function(i){this.variableNames=["A"];var t=bt(),e=i[0],n=i[1];this.outputShape=i,this.userCode=`
      void main() {
        ivec3 coords = getOutputCoords();
        int texR = coords[0];
        int texC = coords[1];
        int depth = coords[2];
        vec2 uv = (vec2(texC, texR) + halfCR) / vec2(`+n+".0, "+e+`.0);

        vec4 values = `+t.texture2D+`(A, uv);
        float value;
        if (depth == 0) {
          value = values.r;
        } else if (depth == 1) {
          value = values.g;
        } else if (depth == 2) {
          value = values.b;
        } else if (depth == 3) {
          value = values.a;
        }

        setOutput(floor(value * 255.0 + 0.5));
      }
    `},JC=function(i){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var t=bt(),e=i[0],n=i[1];this.outputShape=i,this.userCode=`
      void main() {
        ivec3 coords = getOutputCoords();
        int texR = coords[0];
        int texC = coords[1];
        int depth = coords[2];

        vec4 result = vec4(0.);

        for(int row=0; row<=1; row++) {
          for(int col=0; col<=1; col++) {
            texC = coords[1] + row;
            depth = coords[2] + col;

            vec2 uv = (vec2(texC, texR) + halfCR) /
                       vec2(`+n+".0, "+e+`.0);
            vec4 values = `+t.texture2D+`(A, uv);
            float value;
            if (depth == 0) {
              value = values.r;
            } else if (depth == 1) {
              value = values.g;
            } else if (depth == 2) {
              value = values.b;
            } else if (depth == 3) {
              value = values.a;
            }

            result[row * 2 + col] = floor(value * 255.0 + 0.5);
          }
        }

        `+t.output+` = result;
      }
    `};for(Ao=0,Cu=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=i.attrs,r=t.pixels,o=n.numChannels,a=typeof HTMLVideoElement<"u"&&r instanceof HTMLVideoElement,s=typeof HTMLImageElement<"u"&&r instanceof HTMLImageElement,u=a?[r.videoWidth,r.videoHeight]:[r.width,r.height],c=u[0],l=u[1],f=[l,c],h=[l,c,o];(s||a)&&(Ir==null&&(Ir=document.createElement("canvas").getContext("2d")),Ir.canvas.width=c,Ir.canvas.height=l,Ir.drawImage(r,0,0,c,l),r=Ir.canvas);var p=e.makeTensorInfo(f,"int32");e.texData.get(p.dataId).usage=Lt.PIXELS,e.gpgpu.uploadPixelDataToTexture(e.getTexture(p.dataId),r);var d=O().getBool("WEBGL_PACK")?new JC(h):new YC(h),m=e.runWebGLProgram(d,[p],"int32");return e.disposeData(p.dataId),m}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=i.attrs;Vo("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var r=t,o=r.boxes,a=r.scores,s=n,u=s.maxOutputSize,c=s.iouThreshold,l=s.scoreThreshold,f=s.softNmsSigma,h=e,p=mc(h.readSync(o.dataId),h.readSync(a.dataId),u,c,l,f);return[p.selectedIndices,p.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=t.x,r=e,o=new fe(n.shape,"return x * x;");return r.runWebGLProgram(o,[n],n.dtype)}},{kernelName:Pi,backendName:"webgl",kernelFunc:function(i){var t=i.inputs,e=i.backend,n=t,r=n.a,o=n.b,a=e,s=O().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new _n("return (a - b) * (a - b);",r.shape,o.shape):new Xe("return (a - b) * (a - b);",r.shape,o.shape);return a.compileAndRun(s,[r,o])}}];Ao<Cu.length;Ao++)Wp(Cu[Ao]);var Ao,Cu;for(Fo=0,_u=[{kernelName:"Square",gradFunc:function(i,t){var e=t[0];return{x:function(){return i.mul(e.toFloat().mul(2))}}}},{kernelName:Pi,gradFunc:function(i,t){var e=t[0],n=t[1],r=Y(2);return{a:function(){return je(i,je(r,Oe(e,n)))},b:function(){return je(i,je(r,Oe(n,e)))}}}}];Fo<_u.length;Fo++)ex(_u[Fo]);var Fo,_u,QC=function(){function i(){}return i.prototype.fetch=function(t,e){return fetch(t,e)},i.prototype.now=function(){return performance.now()},i.prototype.encode=function(t,e){if(e!=="utf-8"&&e!=="utf8")throw new Error("Browser's encoder only supports utf-8, but got "+e);return this.textEncoder==null&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(t)},i.prototype.decode=function(t,e){return new TextDecoder(e).decode(t)},i}();O().get("IS_BROWSER")&&O().setPlatform("browser",new QC);var Eu,ZC=function(){return Jh()},e_=function(){function i(){this.util=Qh(),this.textEncoder=new this.util.TextEncoder}return i.prototype.fetch=function(t,e){return O().global.fetch!=null?O().global.fetch(t,e):(Eu==null&&(Eu=ZC()),Eu(t,e))},i.prototype.now=function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6},i.prototype.encode=function(t,e){if(e!=="utf-8"&&e!=="utf8")throw new Error("Node built-in encoder only supports utf-8, but got "+e);return this.textEncoder.encode(t)},i.prototype.decode=function(t,e){return t.length===0?"":new this.util.TextDecoder(e).decode(t)},i}();O().get("IS_NODE")&&O().setPlatform("node",new e_);var Hu={float32:4,int32:4,uint16:2,uint8:1,bool:1},Qo=4;function Zm(i,t){for(var e={},n=0,r=function(s){var u=s.name,c=s.dtype,l=s.shape,f=re(l),h=void 0;if("quantization"in s){var p=s.quantization;if(p.dtype!=="uint8"&&p.dtype!=="uint16")throw new Error("Weight "+s.name+" has unknown quantization dtype "+p.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var d=Hu[p.dtype],m=i.slice(n,n+f*d),v=p.dtype==="uint8"?new Uint8Array(m):new Uint16Array(m);if(c==="float32")h=Float32Array.from(v,function(C){return C*p.scale+p.min});else{if(c!=="int32")throw new Error("Unsupported dtype in weight '"+u+"': "+c);h=Int32Array.from(v,function(C){return Math.round(C*p.scale+p.min)})}n+=f*d}else if(c==="string"){var g=re(s.shape);h=[];for(var x=0;x<g;x++){var w=new Uint32Array(i.slice(n,n+Qo))[0];n+=Qo;var y=new Uint8Array(i.slice(n,n+w));h.push(y),n+=w}}else{var b=Hu[c];if(m=i.slice(n,n+f*b),c==="float32")h=new Float32Array(m);else if(c==="int32")h=new Int32Array(m);else{if(c!=="bool")throw new Error("Unsupported dtype in weight '"+u+"': "+c);h=new Uint8Array(m)}n+=f*b}e[u]=st(h,l,c)},o=0,a=t;o<a.length;o++)r(a[o]);return e}function t_(i){if(i===null)throw new Error("Invalid input value: "+JSON.stringify(i));var t=0,e=[];i.forEach(function(o){if(t+=o.byteLength,e.push(o.byteLength===o.buffer.byteLength?o:new o.constructor(o)),!(o instanceof Float32Array||o instanceof Int32Array||o instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+o.constructor.name)});var n=new Uint8Array(t),r=0;return e.forEach(function(o){n.set(new Uint8Array(o.buffer),r),r+=o.byteLength}),n.buffer}var Ku=typeof Buffer<"u"&&(typeof Blob>"u"||typeof atob>"u"||typeof btoa>"u");function Sp(i){return Ku?Buffer.byteLength(i):new Blob([i]).size}function Pc(i){var t=0;i.forEach(function(r){t+=r.byteLength});var e=new Uint8Array(t),n=0;return i.forEach(function(r){e.set(new Uint8Array(r),n),n+=r.byteLength}),e.buffer}function Ap(i){for(i=i.trim();i.endsWith("/");)i=i.slice(0,i.length-1);var t=i.split("/");return t[t.length-1]}function ji(i){if(i.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:i.modelTopology==null?0:Sp(JSON.stringify(i.modelTopology)),weightSpecsBytes:i.weightSpecs==null?0:Sp(JSON.stringify(i.weightSpecs)),weightDataBytes:i.weightData==null?0:i.weightData.byteLength}}var zt=function(){function i(){this.saveRouters=[],this.loadRouters=[]}return i.getInstance=function(){return i.instance==null&&(i.instance=new i),i.instance},i.registerSaveRouter=function(t){i.getInstance().saveRouters.push(t)},i.registerLoadRouter=function(t){i.getInstance().loadRouters.push(t)},i.getSaveHandlers=function(t){return i.getHandlers(t,"save")},i.getLoadHandlers=function(t,e){return i.getHandlers(t,"load",e)},i.getHandlers=function(t,e,n){var r=[];return(e==="load"?i.getInstance().loadRouters:i.getInstance().saveRouters).forEach(function(o){var a=o(t,n);a!==null&&r.push(a)}),r},i}(),Lr="://",jn=function(){function i(){this.managers={}}return i.getInstance=function(){return i.instance==null&&(i.instance=new i),i.instance},i.registerManager=function(t,e){E(t!=null,function(){return"scheme must not be undefined or null."}),t.endsWith(Lr)&&(t=t.slice(0,t.indexOf(Lr))),E(t.length>0,function(){return"scheme must not be an empty string."});var n=i.getInstance();E(n.managers[t]==null,function(){return"A model store manager is already registered for scheme '"+t+"'."}),n.managers[t]=e},i.getManager=function(t){var e=this.getInstance().managers[t];if(e==null)throw new Error("Cannot find model manager for scheme '"+t+"'");return e},i.getSchemes=function(){return Object.keys(this.getInstance().managers)},i}();function Oo(i){if(i.indexOf(Lr)===-1)throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+jn.getSchemes().join(","));return{scheme:i.split(Lr)[0],path:i.split(Lr)[1]}}function Fp(i,t,e){return e===void 0&&(e=!1),te(this,void 0,void 0,function(){var n,r,o,a,s,u,c,l,f;return ne(this,function(h){switch(h.label){case 0:return E(i!==t,function(){return"Old path and new path are the same: '"+i+"'"}),E((n=zt.getLoadHandlers(i)).length>0,function(){return"Copying failed because no load handler is found for source URL "+i+"."}),E(n.length<2,function(){return"Copying failed because more than one ("+n.length+") load handlers for source URL "+i+"."}),r=n[0],E((o=zt.getSaveHandlers(t)).length>0,function(){return"Copying failed because no save handler is found for destination URL "+t+"."}),E(o.length<2,function(){return"Copying failed because more than one ("+n.length+") save handlers for destination URL "+t+"."}),a=o[0],s=Oo(i).scheme,u=Oo(i).path,c=s===Oo(i).scheme,[4,r.load()];case 1:return l=h.sent(),e&&c?[4,jn.getManager(s).removeModel(u)]:[3,3];case 2:h.sent(),h.label=3;case 3:return[4,a.save(l)];case 4:return f=h.sent(),!e||c?[3,6]:[4,jn.getManager(s).removeModel(u)];case 5:h.sent(),h.label=6;case 6:return[2,f.modelArtifactsInfo]}})})}var ir="models_store",Un="model_info_store";function ev(){if(!O().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var i=window||self,t=i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB||i.shimIndexedDB;if(t==null)throw new Error("The current browser does not appear to support IndexedDB.");return t}function Xu(i){var t=i.result;t.createObjectStore(ir,{keyPath:"modelPath"}),t.createObjectStore(Un,{keyPath:"modelPath"})}var Wr=function(){function i(t){if(this.indexedDB=ev(),t==null||!t)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=t}return i.prototype.save=function(t){return te(this,void 0,void 0,function(){return ne(this,function(e){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,t)]})})},i.prototype.load=function(){return te(this,void 0,void 0,function(){return ne(this,function(t){return[2,this.databaseAction(this.modelPath)]})})},i.prototype.databaseAction=function(t,e){var n=this;return new Promise(function(r,o){var a=n.indexedDB.open("tensorflowjs",1);a.onupgradeneeded=function(){return Xu(a)},a.onsuccess=function(){var s=a.result;if(e==null){var u=s.transaction(ir,"readonly"),c=u.objectStore(ir).get(n.modelPath);c.onsuccess=function(){if(c.result==null)return s.close(),o(new Error("Cannot find model with path '"+n.modelPath+"' in IndexedDB."));r(c.result.modelArtifacts)},c.onerror=function(m){return s.close(),o(c.error)},u.oncomplete=function(){return s.close()}}else{var l,f=ji(e),h=s.transaction(Un,"readwrite"),p=h.objectStore(Un),d=p.put({modelPath:n.modelPath,modelArtifactsInfo:f});d.onsuccess=function(){var m=(l=s.transaction(ir,"readwrite")).objectStore(ir).put({modelPath:n.modelPath,modelArtifacts:e,modelArtifactsInfo:f});m.onsuccess=function(){return r({modelArtifactsInfo:f})},m.onerror=function(v){var g=(p=h.objectStore(Un)).delete(n.modelPath);g.onsuccess=function(){return s.close(),o(m.error)},g.onerror=function(x){return s.close(),o(m.error)}}},d.onerror=function(m){return s.close(),o(d.error)},h.oncomplete=function(){l==null?s.close():l.oncomplete=function(){return s.close()}}}},a.onerror=function(s){return o(a.error)}})},i.URL_SCHEME="indexeddb://",i}(),Rp=function(i){return O().getBool("IS_BROWSER")&&!Array.isArray(i)&&i.startsWith(Wr.URL_SCHEME)?(t=i.slice(Wr.URL_SCHEME.length),new Wr(t)):null;var t};zt.registerSaveRouter(Rp),zt.registerLoadRouter(Rp);var n_=function(){function i(){this.indexedDB=ev()}return i.prototype.listModels=function(){return te(this,void 0,void 0,function(){var t=this;return ne(this,function(e){return[2,new Promise(function(n,r){var o=t.indexedDB.open("tensorflowjs",1);o.onupgradeneeded=function(){return Xu(o)},o.onsuccess=function(){var a=o.result,s=a.transaction(Un,"readonly"),u=s.objectStore(Un).getAll();u.onsuccess=function(){for(var c={},l=0,f=u.result;l<f.length;l++){var h=f[l];c[h.modelPath]=h.modelArtifactsInfo}n(c)},u.onerror=function(c){return a.close(),r(u.error)},s.oncomplete=function(){return a.close()}},o.onerror=function(a){return r(o.error)}})]})})},i.prototype.removeModel=function(t){return te(this,void 0,void 0,function(){var e=this;return ne(this,function(n){var r;return t=(r=t).startsWith(Wr.URL_SCHEME)?r.slice(Wr.URL_SCHEME.length):r,[2,new Promise(function(o,a){var s=e.indexedDB.open("tensorflowjs",1);s.onupgradeneeded=function(){return Xu(s)},s.onsuccess=function(){var u,c=s.result,l=c.transaction(Un,"readwrite"),f=l.objectStore(Un),h=f.get(t);h.onsuccess=function(){if(h.result==null)return c.close(),a(new Error("Cannot find model with path '"+t+"' in IndexedDB."));var p=f.delete(t),d=function(){var m=(u=c.transaction(ir,"readwrite")).objectStore(ir).delete(t);m.onsuccess=function(){return o(h.result.modelArtifactsInfo)},m.onerror=function(v){return a(h.error)}};p.onsuccess=d,p.onerror=function(m){return d(),c.close(),a(h.error)}},h.onerror=function(p){return c.close(),a(h.error)},l.oncomplete=function(){u==null?c.close():u.oncomplete=function(){return c.close()}}},s.onerror=function(u){return a(s.error)}})]})})},i}();if(O().getBool("IS_BROWSER"))try{jn.registerManager(Wr.URL_SCHEME,new n_)}catch{}var En="/",Or="tensorflowjs_models",tv="info",r_="model_topology",i_="weight_specs",o_="weight_data",a_="model_metadata";function nv(i){return{info:[Or,i,tv].join(En),topology:[Or,i,r_].join(En),weightSpecs:[Or,i,i_].join(En),weightData:[Or,i,o_].join(En),modelMetadata:[Or,i,a_].join(En)}}function s_(i){var t=i.split(En);if(t.length<3)throw new Error("Invalid key format: "+i);return t.slice(1,t.length-1).join(En)}var zr=function(){function i(t){if(!O().getBool("IS_BROWSER")||typeof window>"u"||window.localStorage===void 0)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,t==null||!t)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=t,this.keys=nv(this.modelPath)}return i.prototype.save=function(t){return te(this,void 0,void 0,function(){var e,n,r;return ne(this,function(o){if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");e=JSON.stringify(t.modelTopology),n=JSON.stringify(t.weightSpecs),r=ji(t);try{return this.LS.setItem(this.keys.info,JSON.stringify(r)),this.LS.setItem(this.keys.topology,e),this.LS.setItem(this.keys.weightSpecs,n),this.LS.setItem(this.keys.weightData,function(a){if(Ku)return Buffer.from(a).toString("base64");for(var s=new Uint8Array(a),u="",c=0,l=s.length;c<l;c++)u+=String.fromCharCode(s[c]);return btoa(u)}(t.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,userDefinedMetadata:t.userDefinedMetadata})),[2,{modelArtifactsInfo:r}]}catch{throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+r.modelTopologyBytes+", weightSpecsBytes="+r.weightSpecsBytes+", weightDataBytes="+r.weightDataBytes+".")}return[2]})})},i.prototype.load=function(){return te(this,void 0,void 0,function(){var t,e,n,r,o,a,s;return ne(this,function(u){if((t=JSON.parse(this.LS.getItem(this.keys.info)))==null)throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if(t.modelTopologyType!=="JSON")throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(e={},(n=JSON.parse(this.LS.getItem(this.keys.topology)))==null)throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(e.modelTopology=n,(r=JSON.parse(this.LS.getItem(this.keys.weightSpecs)))==null)throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(e.weightSpecs=r,(o=this.LS.getItem(this.keys.modelMetadata))!=null&&(a=JSON.parse(o),e.format=a.format,e.generatedBy=a.generatedBy,e.convertedBy=a.convertedBy,e.userDefinedMetadata=a.userDefinedMetadata),(s=this.LS.getItem(this.keys.weightData))==null)throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return e.weightData=function(c){if(Ku){var l=Buffer.from(c,"base64");return l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)}for(var f=atob(c),h=new Uint8Array(f.length),p=0;p<f.length;++p)h.set([f.charCodeAt(p)],p);return h.buffer}(s),[2,e]})})},i.URL_SCHEME="localstorage://",i}(),Ip=function(i){return O().getBool("IS_BROWSER")&&!Array.isArray(i)&&i.startsWith(zr.URL_SCHEME)?(t=i.slice(zr.URL_SCHEME.length),new zr(t)):null;var t};zt.registerSaveRouter(Ip),zt.registerLoadRouter(Ip);var u_=function(){function i(){E(O().getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),E(typeof window>"u"||window.localStorage!==void 0,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return i.prototype.listModels=function(){return te(this,void 0,void 0,function(){var t,e,n,r,o,a;return ne(this,function(s){for(t={},e=Or+En,n=En+tv,r=0;r<this.LS.length;++r)(o=this.LS.key(r)).startsWith(e)&&o.endsWith(n)&&(a=s_(o),t[a]=JSON.parse(this.LS.getItem(o)));return[2,t]})})},i.prototype.removeModel=function(t){return te(this,void 0,void 0,function(){var e,n;return ne(this,function(r){var o;if(t=(o=t).startsWith(zr.URL_SCHEME)?o.slice(zr.URL_SCHEME.length):o,e=nv(t),this.LS.getItem(e.info)==null)throw new Error("Cannot find model at path '"+t+"'");return n=JSON.parse(this.LS.getItem(e.info)),this.LS.removeItem(e.info),this.LS.removeItem(e.topology),this.LS.removeItem(e.weightSpecs),this.LS.removeItem(e.weightData),[2,n]})})},i}();if(O().getBool("IS_BROWSER"))try{jn.registerManager(zr.URL_SCHEME,new u_)}catch{}var c_="model",l_=".json",f_=".weights.bin";function Tp(i){return new Promise(function(t){return setTimeout(t)}).then(i)}var ku=function(){function i(t){if(!O().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");t.startsWith(i.URL_SCHEME)&&(t=t.slice(i.URL_SCHEME.length)),t!=null&&t.length!==0||(t=c_),this.modelTopologyFileName=t+l_,this.weightDataFileName=t+f_}return i.prototype.save=function(t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s;return ne(this,function(u){switch(u.label){case 0:if(typeof document>"u")throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(e=window.URL.createObjectURL(new Blob([t.weightData],{type:"application/octet-stream"})),!(t.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return n=[{paths:["./"+this.weightDataFileName],weights:t.weightSpecs}],r={modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,weightsManifest:n},o=window.URL.createObjectURL(new Blob([JSON.stringify(r)],{type:"application/json"})),(a=this.jsonAnchor==null?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,a.href=o,[4,Tp(function(){return a.dispatchEvent(new MouseEvent("click"))})];case 2:return u.sent(),t.weightData==null?[3,4]:((s=this.weightDataAnchor==null?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,s.href=e,[4,Tp(function(){return s.dispatchEvent(new MouseEvent("click"))})]);case 3:u.sent(),u.label=4;case 4:return[2,{modelArtifactsInfo:ji(t)}]}})})},i.URL_SCHEME="downloads://",i}(),h_=function(){function i(t){if(t==null||t.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+t);this.files=t}return i.prototype.load=function(){return te(this,void 0,void 0,function(){var t,e,n=this;return ne(this,function(r){return t=this.files[0],e=this.files.slice(1),[2,new Promise(function(o,a){var s=new FileReader;s.onload=function(u){var c=JSON.parse(u.target.result),l=c.modelTopology;if(l!=null){e.length===0&&o({modelTopology:l});var f=c.weightsManifest;if(f!=null){var h;try{h=n.checkManifestAndWeightFiles(f,e)}catch(v){return void a(v)}var p=[],d=[],m=[];f.forEach(function(v){v.paths.forEach(function(g){d.push(g),m.push(null)}),p.push.apply(p,v.weights)}),f.forEach(function(v){v.paths.forEach(function(g){var x=new FileReader;x.onload=function(w){var y=w.target.result,b=d.indexOf(g);m[b]=y,m.indexOf(null)===-1&&o({modelTopology:l,weightSpecs:p,weightData:Pc(m),format:c.format,generatedBy:c.generatedBy,convertedBy:c.convertedBy,userDefinedMetadata:c.userDefinedMetadata})},x.onerror=function(w){return a("Failed to weights data from file of path '"+g+"'.")},x.readAsArrayBuffer(h[g])})})}else a(new Error("weightManifest field is missing from file "+t.name))}else a(new Error("modelTopology field is missing from file "+t.name))},s.onerror=function(u){return a("Failed to read model topology and weights manifest JSON from file '"+t.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},s.readAsText(t)})]})})},i.prototype.checkManifestAndWeightFiles=function(t,e){for(var n=[],r=e.map(function(u){return Ap(u.name)}),o={},a=0,s=t;a<s.length;a++)s[a].paths.forEach(function(u){var c=Ap(u);if(n.indexOf(c)!==-1)throw new Error("Duplicate file basename found in weights manifest: '"+c+"'");if(n.push(c),r.indexOf(c)===-1)throw new Error("Weight file with basename '"+c+"' is not provided.");o[u]=e[r.indexOf(c)]});if(n.length!==e.length)throw new Error("Mismatch in the number of files in weights manifest ("+n.length+") and the number of weight files provided ("+e.length+").");return o},i}();function Np(i,t,e,n){(function(o){E(o!=null&&Array.isArray(o)&&o.length>0,function(){return"promises must be a none empty array"})})(i),function(o,a){E(o>=0&&o<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+o}),E(a>=0&&a<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+a}),E(a>=o,function(){return"startFraction must be no more than endFraction, but got startFraction "+o+" and endFraction "+a})}(e=e??0,n=n??1);var r=0;return Promise.all(i.map(function(o){return o.then(function(a){var s=e+ ++r/i.length*(n-e);return t(s),a}),o}))}function rv(i,t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s,u,c,l;return ne(this,function(f){switch(f.label){case 0:return t==null&&(t={}),e=t.fetchFunc==null?O().platform.fetch:t.fetchFunc,n=i.map(function(h){return e(h,t.requestInit,{isBinary:!0})}),r=0,o=.5,t.onProgress!=null?[3,2]:[4,Promise.all(n)];case 1:return a=f.sent(),[3,4];case 2:return[4,Np(n,t.onProgress,r,o)];case 3:a=f.sent(),f.label=4;case 4:return s=a.map(function(h){return h.arrayBuffer()}),u=.5,c=1,t.onProgress!=null?[3,6]:[4,Promise.all(s)];case 5:return l=f.sent(),[3,8];case 6:return[4,Np(s,t.onProgress,u,c)];case 7:l=f.sent(),f.label=8;case 8:return[2,l]}})})}function Pp(i){var t=this;return function(e,n,r){return n===void 0&&(n=""),te(t,void 0,void 0,function(){var o,a,s,u,c,l,f,h,p,d;return ne(this,function(m){switch(m.label){case 0:if(o=e.map(function(){return!1}),a={},s=r!=null?r.map(function(){return!1}):[],u=[],e.forEach(function(v,g){var x=0;v.weights.forEach(function(w){var y="quantization"in w?w.quantization.dtype:w.dtype,b=Hu[y]*re(w.shape),C=function(){o[g]=!0,a[g]==null&&(a[g]=[]),a[g].push({manifestEntry:w,groupOffset:x,sizeBytes:b})};r!=null?r.forEach(function(S,A){S===w.name&&(C(),s[A]=!0)}):C(),u.push(w.name),x+=b})}),!s.every(function(v){return v}))throw c=r.filter(function(v,g){return!s[g]}),new Error("Could not find weights in manifest with names: "+c.join(", ")+`. 
Manifest JSON has weights with names: `+u.join(", ")+".");return l=o.reduce(function(v,g,x){return g&&v.push(x),v},[]),f=[],l.forEach(function(v){e[v].paths.forEach(function(g){var x=n+(n.endsWith("/")?"":"/")+g;f.push(x)})}),[4,i(f)];case 1:return h=m.sent(),p={},d=0,l.forEach(function(v){for(var g=e[v].paths.length,x=0,w=0;w<g;w++)x+=h[d+w].byteLength;for(var y=new ArrayBuffer(x),b=new Uint8Array(y),C=0,S=0;S<g;S++){var A=new Uint8Array(h[d+S]);b.set(A,C),C+=A.byteLength}a[v].forEach(function(k){var D=Zm(y.slice(k.groupOffset,k.groupOffset+k.sizeBytes),[k.manifestEntry]);for(var T in D)p[T]=D[T]}),d+=g}),[2,p]}})})}}zt.registerSaveRouter(function(i){return O().getBool("IS_BROWSER")&&!Array.isArray(i)&&i.startsWith(ku.URL_SCHEME)?function(t){return t===void 0&&(t="model"),new ku(t)}(i.slice(ku.URL_SCHEME.length)):null});var iv=function(){function i(t,e){if(this.DEFAULT_METHOD="POST",e==null&&(e={}),this.weightPathPrefix=e.weightPathPrefix,this.onProgress=e.onProgress,e.fetchFunc!=null?(E(typeof e.fetchFunc=="function",function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=e.fetchFunc):this.fetch=O().platform.fetch,E(t!=null&&t.length>0,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(t)&&E(t.length===2,function(){return"URL paths for http must have a length of 2, (actual length is "+t.length+")."}),this.path=t,e.requestInit!=null&&e.requestInit.body!=null)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=e.requestInit||{}}return i.prototype.save=function(t){return te(this,void 0,void 0,function(){var e,n,r,o;return ne(this,function(a){switch(a.label){case 0:if(t.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(e=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,n=[{paths:["./model.weights.bin"],weights:t.weightSpecs}],r={modelTopology:t.modelTopology,format:t.format,generatedBy:t.generatedBy,convertedBy:t.convertedBy,userDefinedMetadata:t.userDefinedMetadata,weightsManifest:n},e.body.append("model.json",new Blob([JSON.stringify(r)],{type:"application/json"}),"model.json"),t.weightData!=null&&e.body.append("model.weights.bin",new Blob([t.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,e)];case 1:if((o=a.sent()).ok)return[2,{modelArtifactsInfo:ji(t),responses:[o]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+o.status+".")}})})},i.prototype.load=function(){return te(this,void 0,void 0,function(){var t,e,n,r,o,a,s,u,c,l,f,h;return ne(this,function(p){switch(p.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(t=p.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+t.status+". Please verify this URL points to the model JSON of the model to load.");p.label=2;case 2:return p.trys.push([2,4,,5]),[4,t.json()];case 3:return e=p.sent(),[3,5];case 4:throw p.sent(),n="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?n+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":n+=" Please make sure the server is serving valid JSON for this request.",new Error(n);case 5:if(r=e.modelTopology,o=e.weightsManifest,a=e.generatedBy,s=e.convertedBy,u=e.format,c=e.userDefinedMetadata,r==null&&o==null)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return o==null?[3,7]:[4,this.loadWeights(o)];case 6:h=p.sent(),l=h[0],f=h[1],p.label=7;case 7:return[2,{modelTopology:r,weightSpecs:l,weightData:f,userDefinedMetadata:c,generatedBy:a,convertedBy:s,format:u}]}})})},i.prototype.loadWeights=function(t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s,u,c,l,f,h;return ne(this,function(p){switch(p.label){case 0:for(e=Array.isArray(this.path)?this.path[1]:this.path,n=function(d){var m=d.lastIndexOf("/"),v=d.lastIndexOf("?"),g=d.substring(0,m),x=v>m?d.substring(v):"";return[g+"/",x]}(e),r=n[0],o=n[1],a=this.weightPathPrefix||r,s=[],u=0,c=t;u<c.length;u++)l=c[u],s.push.apply(s,l.weights);return f=[],t.forEach(function(d){d.paths.forEach(function(m){f.push(a+m+o)})}),[4,rv(f,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return h=p.sent(),[2,[s,Pc(h)]]}})})},i.URL_SCHEME_REGEX=/^https?:\/\//,i}();function $u(i){return i.match(iv.URL_SCHEME_REGEX)!=null}var Mp=function(i,t){return typeof fetch>"u"?null:(Array.isArray(i)?i.every(function(e){return $u(e)}):$u(i))?Yu(i,{onProgress:t}):null};function Yu(i,t){return new iv(i,t)}zt.registerSaveRouter(Mp),zt.registerLoadRouter(Mp);var Du=function(){function i(t){this.modelArtifacts=t}return i.prototype.load=function(){return te(this,void 0,void 0,function(){return ne(this,function(t){return[2,this.modelArtifacts]})})},i}(),p_=function(){function i(t){this.saveHandler=t}return i.prototype.save=function(t){return te(this,void 0,void 0,function(){return ne(this,function(e){return[2,this.saveHandler(t)]})})},i}(),la=Object.freeze({browserFiles:function(i){return new h_(i)},browserHTTPRequest:function(i,t){return Yu(i,t)},concatenateArrayBuffers:Pc,decodeWeights:Zm,encodeWeights:function(i,t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s=this;return ne(this,function(u){switch(u.label){case 0:for(e=[],n=[],r=Array.isArray(i)?i.map(function(c){return c.name}):Object.keys(i),o=function(c){var l=r[c],f=Array.isArray(i)?i[c].tensor:i[l];if(f.dtype!=="float32"&&f.dtype!=="int32"&&f.dtype!=="bool"&&f.dtype!=="string")throw new Error("Unsupported dtype in weight '"+l+"': "+f.dtype);var h={name:l,shape:f.shape,dtype:f.dtype};if(f.dtype==="string"){var p=new Promise(function(d){return te(s,void 0,void 0,function(){var m,v,g,x,w,y,b;return ne(this,function(C){switch(C.label){case 0:return[4,f.bytes()];case 1:for(m=C.sent(),v=m.reduce(function(S,A){return S+A.length},0)+Qo*m.length,g=new Uint8Array(v),x=0,w=0;w<m.length;w++)y=m[w],b=new Uint8Array(new Uint32Array([y.length]).buffer),g.set(b,x),x+=Qo,g.set(y,x),x+=y.length;return d(g),[2]}})})});n.push(p)}else n.push(f.data());t!=null&&(h.group=t),e.push(h)},a=0;a<r.length;++a)o(a);return[4,Promise.all(n)];case 1:return[2,{data:t_(u.sent()),specs:e}]}})})},fromMemory:function(i,t,e,n){return arguments.length===1?i.modelTopology!=null||i.weightSpecs!=null?new Du(i):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new Du({modelTopology:i})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new Du({modelTopology:i,weightSpecs:t,weightData:e,trainingConfig:n}))},getLoadHandlers:function(i,t){return zt.getLoadHandlers(i,t)},getModelArtifactsInfoForJSON:ji,getSaveHandlers:function(i){return zt.getSaveHandlers(i)},http:Yu,isHTTPScheme:$u,loadWeights:function(i,t,e,n){return t===void 0&&(t=""),te(this,void 0,void 0,function(){return ne(this,function(r){return[2,Pp(function(o){return rv(o,{requestInit:n})})(i,t,e)]})})},registerLoadRouter:function(i){return zt.registerLoadRouter(i)},registerSaveRouter:function(i){return zt.registerSaveRouter(i)},weightsLoaderFactory:Pp,withSaveHandler:function(i){return new p_(i)},copyModel:function(i,t){return te(this,void 0,void 0,function(){return ne(this,function(e){return[2,Fp(i,t,!1)]})})},listModels:function(){return te(this,void 0,void 0,function(){var i,t,e,n,r,o,a;return ne(this,function(s){switch(s.label){case 0:i=jn.getSchemes(),t={},e=0,n=i,s.label=1;case 1:return e<n.length?(r=n[e],[4,jn.getManager(r).listModels()]):[3,4];case 2:for(a in o=s.sent())t[r+Lr+a]=o[a];s.label=3;case 3:return e++,[3,1];case 4:return[2,t]}})})},moveModel:function(i,t){return te(this,void 0,void 0,function(){return ne(this,function(e){return[2,Fp(i,t,!0)]})})},removeModel:function(i){return te(this,void 0,void 0,function(){var t;return ne(this,function(e){return t=Oo(i),[2,jn.getManager(t.scheme).removeModel(t.path)]})})}}),Tr,d_=F({confusionMatrix_:function(i,t,e){var n=_(i,"labels","confusionMatrix"),r=_(t,"predictions","confusionMatrix");E(e==null||e>0&&Number.isInteger(e),function(){return"If provided, numClasses must be a positive integer, but got "+e}),E(n.rank===1,function(){return"Expected the rank of labels to be 1, but got "+n.rank}),E(r.rank===1,function(){return"Expected the rank of predictions to be 1, but got "+r.rank}),E(n.shape[0]===r.shape[0],function(){return"Mismatch in the number of examples: "+n.shape[0]+" vs. "+r.shape[0]+". Labels and predictions should have the same number of elements."}),E(e>0&&Number.isInteger(e),function(){return"numClasses is required to be a positive integer, but got "+e});var o=Vu(n.asType("int32"),e),a=Vu(r.asType("int32"),e);return o.transpose().matMul(a).asType("int32")}}),Zk=Object.freeze({confusionMatrix:d_}),m_=F({fromPixels_:function(i,t){if(t===void 0&&(t=3),t>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(i==null)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var e=!1,n=!1,r=!1,o=!1,a=!1;if(i.data instanceof Uint8Array)e=!0;else if(typeof ImageData<"u"&&i instanceof ImageData)n=!0;else if(typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement)r=!0;else if(typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement)o=!0;else{if(i.getContext==null)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+i.constructor.name);a=!0}if(r&&r&&i.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(Lp("FromPixels",R.backendName)!=null)return R.runKernel("FromPixels",{pixels:i},{numChannels:t});var s,u,c=r?[i.videoWidth,i.videoHeight]:[i.width,i.height],l=c[0],f=c[1];if(a?s=i.getContext("2d").getImageData(0,0,l,f).data:n||e?s=i.data:(o||r)&&(Tr==null&&(Tr=document.createElement("canvas").getContext("2d")),Tr.canvas.width=l,Tr.canvas.height=f,Tr.drawImage(i,0,0,l,f),s=Tr.getImageData(0,0,l,f).data),t===4)u=new Int32Array(s);else{var h=l*f;u=new Int32Array(h*t);for(var p=0;p<h;p++)for(var d=0;d<t;++d)u[p*t+d]=s[4*p+d]}return ta(u,[f,l,t],"int32")}}),Kr=Object.freeze({toPixels:function(i,t){return te(this,void 0,void 0,function(){var e,n,r,o,a,s,u,c,l,f,h,p,d,m,v,g,x,w,y,b,C,S,A;return ne(this,function(k){switch(k.label){case 0:if(e=_(i,"img","toPixels"),i instanceof Me||(e=e.toInt()),e.rank!==2&&e.rank!==3)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+e.rank+".");if(n=e.shape.slice(0,2),r=n[0],o=n[1],(a=e.rank===2?1:e.shape[2])>4||a===2)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+a);return[4,e.data()];case 1:return s=k.sent(),u=e.min(),c=e.max(),[4,Promise.all([u.data(),c.data()])];case 2:if(l=k.sent(),f=l[0],h=l[1],p=f[0],d=h[0],u.dispose(),c.dispose(),e.dtype==="float32"){if(p<0||d>1)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+p+" - "+d+"].")}else{if(e.dtype!=="int32")throw new Error("Unsupported type for toPixels: "+e.dtype+". Please use float32 or int32 tensors.");if(p<0||d>255)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+p+" - "+d+"].")}for(m=e.dtype==="float32"?255:1,v=new Uint8ClampedArray(o*r*4),g=0;g<r*o;++g)x=void 0,w=void 0,y=void 0,b=void 0,a===1?(x=s[g]*m,w=s[g]*m,y=s[g]*m,b=255):a===3?(x=s[3*g]*m,w=s[3*g+1]*m,y=s[3*g+2]*m,b=255):a===4&&(x=s[4*g]*m,w=s[4*g+1]*m,y=s[4*g+2]*m,b=s[4*g+3]*m),v[(C=4*g)+0]=Math.round(x),v[C+1]=Math.round(w),v[C+2]=Math.round(y),v[C+3]=Math.round(b);return t!=null&&(t.width=o,t.height=r,S=t.getContext("2d"),A=new ImageData(v,o,r),S.putImageData(A,0,0)),e!==i&&e.dispose(),[2,v]}})})},fromPixels:m_}),ov=function(){function i(){}return i.prototype.getClassName=function(){return this.constructor.className},i.fromConfig=function(t,e){return new t(e)},i}(),av=function(){function i(){this.classNameMap={}}return i.getMap=function(){return i.instance==null&&(i.instance=new i),i.instance},i.register=function(t){i.getMap().classNameMap[t.className]=[t,t.fromConfig]},i}();function Kn(i){E(i.className!=null,function(){return"Class being registered does not have the static className property defined."}),E(typeof i.className=="string",function(){return"className is required to be a string, but got type "+typeof i.className}),E(i.className.length>0,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),av.register(i)}var eD=Object.freeze({Serializable:ov,SerializationMap:av,registerClass:Kn}),v_=.001,sv=.1;function Su(){return R.backend.floatPrecision()===32?v_:sv}function Au(i,t,e){var n=!0;if((dt(i)||dt(t))&&(n=!1),dt(i)&&dt(t)&&(n=!0),n){var r=i.constructor.name,o=t.constructor.name;if(r!==o)throw new Error("Arrays are of different type. Actual: "+r+". Expected: "+o)}if(Array.isArray(i)&&Array.isArray(t)){var a=pn(i),s=pn(t);if(!Je(a,s))throw new Error("Arrays have different shapes. Actual: ["+a+"]. Expected: ["+s+"]")}var u=dt(i)?i:Dn(i),c=dt(t)?t:Dn(t);if(u.length!==c.length)throw new Error("Arrays have different lengths actual: "+u.length+" vs expected: "+c.length+`.
Actual:   `+u+`.
Expected: `+c+".");for(var l=0;l<c.length;++l){var f=u[l],h=c[l];if(!e(f,h))throw new Error("Arrays differ: actual["+l+"] = "+f+", expected["+l+"] = "+h+`.
Actual:   `+u+`.
Expected: `+c+".")}}function Fu(i,t,e){return!isFinite(i)&&!isFinite(t)||!(isNaN(i)||isNaN(t)||Math.abs(i-t)>e)}var tD=Object.freeze({TEST_EPSILON_FLOAT16:sv,expectArraysClose:function(i,t,e){return e==null&&(e=Su()),Au(i,t,function(n,r){return Fu(n,r,e)})},testEpsilon:Su,expectPromiseToFail:function(i,t){i().then(function(){return t.fail()},function(){return t()})},expectArraysEqual:function(i,t){var e=typeof t=="string"||typeof t=="number"||typeof t=="boolean"?[t]:t;return Vn(i)||Vn(i[0])||Vn(t)||Vn(t[0])?Au(i,e,function(n,r){return n==r}):Au(i,t,function(n,r){return Fu(n,r,0)})},expectNumbersClose:function(i,t,e){if(e==null&&(e=Su()),!Fu(i,t,e))throw new Error("Numbers differ: actual === "+i+", expected === "+t)},expectValuesInRange:function(i,t,e){for(var n=0;n<i.length;n++)if(i[n]<t||i[n]>e)throw new Error("Value out of range:"+i[n]+" low: "+t+", high: "+e)},expectArrayBuffersEqual:function(i,t){expect(new Float32Array(i)).toEqual(new Float32Array(t))}});var nD=Object.freeze({gpgpu_util:Wb,webgl_util:cx,forceHalfFloat:function(){O().set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:_m,setWebGLContext:nd,GPGPUContext:vm}),dr=function(i){function t(){return i!==null&&i.apply(this,arguments)||this}return Qt(t,i),t.prototype.minimize=function(e,n,r){n===void 0&&(n=!1);var o=this.computeGradients(e,r),a=o.value,s=o.grads;if(r!=null){var u=r.map(function(c){return{name:c.name,tensor:s[c.name]}});this.applyGradients(u)}else this.applyGradients(s);return Nt(s),n?a:(a.dispose(),null)},Object.defineProperty(t.prototype,"iterations",{get:function(){return this.iterations_==null&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),t.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},t.prototype.computeGradients=function(e,n){return Ux(e,n)},t.prototype.dispose=function(){this.iterations_!=null&&Nt(this.iterations_)},t.prototype.saveIterations=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){return this.iterations_==null&&(this.iterations_=0),[2,{name:"iter",tensor:Y(this.iterations_,"int32")}]})})},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},t.prototype.extractIterations=function(e){return te(this,void 0,void 0,function(){var n;return ne(this,function(r){switch(r.label){case 0:return n=this,[4,e[0].tensor.data()];case 1:return n.iterations_=r.sent()[0],[2,e.slice(1)]}})})},t}(ov);Object.defineProperty(dr,Symbol.hasInstance,{value:function(i){return i.minimize!=null&&i.computeGradients!=null&&i.applyGradients!=null}});var uv=function(i){function t(e,n,r){r===void 0&&(r=null);var o=i.call(this)||this;return o.learningRate=e,o.rho=n,o.epsilon=r,o.accumulatedGrads=[],o.accumulatedUpdates=[],r==null&&(o.epsilon=R.backend.epsilon()),o}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e)).forEach(function(r,o){var a=R.registeredVariables[r];n.accumulatedGrads[o]==null&&(n.accumulatedGrads[o]={originalName:r+"/accum_grad",variable:j(function(){return De(a).variable(!1)})}),n.accumulatedUpdates[o]==null&&(n.accumulatedUpdates[o]={originalName:r+"/accum_var",variable:j(function(){return De(a).variable(!1)})});var s=Array.isArray(e)?e[o].tensor:e[r];if(s!=null){var u=n.accumulatedGrads[o].variable,c=n.accumulatedUpdates[o].variable;j(function(){var l=u.mul(n.rho).add(s.square().mul(1-n.rho)),f=c.add(n.epsilon).sqrt().div(u.add(n.epsilon).sqrt()).mul(s),h=c.mul(n.rho).add(f.square().mul(1-n.rho));u.assign(l),c.assign(h);var p=f.mul(-n.learningRate).add(a);a.assign(p)})}}),this.incrementIterations()},t.prototype.dispose=function(){this.accumulatedUpdates!=null&&(Nt(this.accumulatedGrads.map(function(e){return e.variable})),Nt(this.accumulatedUpdates.map(function(e){return e.variable})))},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){var e;return ne(this,function(n){switch(n.label){case 0:return e=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(r){return{name:r.originalName,tensor:r.variable}}))]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){var n;return ne(this,function(r){switch(r.label){case 0:return[4,this.extractIterations(e)];case 1:return e=r.sent(),n=e.length/2,this.accumulatedGrads=e.slice(0,n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),this.accumulatedUpdates=e.slice(n,2*n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},t.fromConfig=function(e,n){return new e(n.learningRate,n.rho,n.epsilon)},t.className="Adadelta",t}(dr);Kn(uv);var cv=function(i){function t(e,n){n===void 0&&(n=.1);var r=i.call(this)||this;return r.learningRate=e,r.initialAccumulatorValue=n,r.accumulatedGrads=[],r}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e)).forEach(function(r,o){var a=R.registeredVariables[r];n.accumulatedGrads[o]==null&&(n.accumulatedGrads[o]={originalName:r+"/accumulator",variable:j(function(){return qt(a.shape,n.initialAccumulatorValue).variable(!1)})});var s=Array.isArray(e)?e[o].tensor:e[r];if(s!=null){var u=n.accumulatedGrads[o].variable;j(function(){var c=u.add(s.square());u.assign(c);var l=s.div(c.add(R.backend.epsilon()).sqrt()).mul(-n.learningRate).add(a);a.assign(l)})}}),this.incrementIterations()},t.prototype.dispose=function(){this.accumulatedGrads!=null&&Nt(this.accumulatedGrads.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulatedGrads.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulatedGrads=e.map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},t.fromConfig=function(e,n){return new e(n.learningRate,n.initialAccumulatorValue)},t.className="Adagrad",t}(dr);Kn(cv);var lv=function(i){function t(e,n,r,o){o===void 0&&(o=null);var a=i.call(this)||this;return a.learningRate=e,a.beta1=n,a.beta2=r,a.epsilon=o,a.accumulatedFirstMoment=[],a.accumulatedSecondMoment=[],j(function(){a.accBeta1=Y(n).variable(),a.accBeta2=Y(r).variable()}),o==null&&(a.epsilon=R.backend.epsilon()),a}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this,r=Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e);j(function(){var o=Oe(1,n.accBeta1),a=Oe(1,n.accBeta2);r.forEach(function(s,u){var c=R.registeredVariables[s];n.accumulatedFirstMoment[u]==null&&(n.accumulatedFirstMoment[u]={originalName:s+"/m",variable:j(function(){return De(c).variable(!1)})}),n.accumulatedSecondMoment[u]==null&&(n.accumulatedSecondMoment[u]={originalName:s+"/v",variable:j(function(){return De(c).variable(!1)})});var l=Array.isArray(e)?e[u].tensor:e[s];if(l!=null){var f=n.accumulatedFirstMoment[u].variable,h=n.accumulatedSecondMoment[u].variable,p=f.mul(n.beta1).add(l.mul(1-n.beta1)),d=h.mul(n.beta2).add(l.square().mul(1-n.beta2)),m=p.div(o),v=d.div(a);f.assign(p),h.assign(d);var g=m.div(v.sqrt().add(n.epsilon)).mul(-n.learningRate).add(c);c.assign(g)}}),n.accBeta1.assign(n.accBeta1.mul(n.beta1)),n.accBeta2.assign(n.accBeta2.mul(n.beta2))}),this.incrementIterations()},t.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),this.accumulatedFirstMoment!=null&&Nt(this.accumulatedFirstMoment.map(function(e){return e.variable})),this.accumulatedSecondMoment!=null&&Nt(this.accumulatedSecondMoment.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){var e;return ne(this,function(n){switch(n.label){case 0:return e=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(r){return{name:r.originalName,tensor:r.variable}}))]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){var n,r=this;return ne(this,function(o){switch(o.label){case 0:return[4,this.extractIterations(e)];case 1:return e=o.sent(),j(function(){r.accBeta1.assign(Yo(r.beta1,r.iterations_+1)),r.accBeta2.assign(Yo(r.beta2,r.iterations_+1))}),n=e.length/2,this.accumulatedFirstMoment=e.slice(0,n).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedSecondMoment=e.slice(n,2*n).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},t.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon)},t.className="Adam",t}(dr);Kn(lv);var fv=function(i){function t(e,n,r,o,a){o===void 0&&(o=null),a===void 0&&(a=0);var s=i.call(this)||this;return s.learningRate=e,s.beta1=n,s.beta2=r,s.epsilon=o,s.decay=a,s.accumulatedFirstMoment=[],s.accumulatedWeightedInfNorm=[],j(function(){s.iteration=Y(0).variable(),s.accBeta1=Y(n).variable()}),o==null&&(s.epsilon=R.backend.epsilon()),s}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this,r=Array.isArray(e)?e.map(function(o){return o.name}):Object.keys(e);j(function(){var o=Oe(1,n.accBeta1),a=Ut(-n.learningRate,n.iteration.mul(n.decay).add(1));r.forEach(function(s,u){var c=R.registeredVariables[s];n.accumulatedFirstMoment[u]==null&&(n.accumulatedFirstMoment[u]={originalName:s+"/m",variable:De(c).variable(!1)}),n.accumulatedWeightedInfNorm[u]==null&&(n.accumulatedWeightedInfNorm[u]={originalName:s+"/v",variable:De(c).variable(!1)});var l=Array.isArray(e)?e[u].tensor:e[s];if(l!=null){var f=n.accumulatedFirstMoment[u].variable,h=n.accumulatedWeightedInfNorm[u].variable,p=f.mul(n.beta1).add(l.mul(1-n.beta1)),d=h.mul(n.beta2),m=l.abs(),v=d.maximum(m);f.assign(p),h.assign(v);var g=a.div(o).mul(p.div(v.add(n.epsilon))).add(c);c.assign(g)}}),n.iteration.assign(n.iteration.add(1)),n.accBeta1.assign(n.accBeta1.mul(n.beta1))}),this.incrementIterations()},t.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),this.accumulatedFirstMoment!=null&&Nt(this.accumulatedFirstMoment.map(function(e){return e.variable})),this.accumulatedWeightedInfNorm!=null&&Nt(this.accumulatedWeightedInfNorm.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){throw new Error("getWeights() is not implemented for Adamax yet.")})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){throw new Error("setWeights() is not implemented for Adamax yet.")})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},t.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon,n.decay)},t.className="Adamax",t}(dr);Kn(fv);var Mc=function(i){function t(e){var n=i.call(this)||this;return n.learningRate=e,n.setLearningRate(e),n}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e)).forEach(function(r,o){var a=Array.isArray(e)?e[o].tensor:e[r];if(a!=null){var s=R.registeredVariables[r];j(function(){var u=n.c.mul(a).add(s);s.assign(u)})}}),this.incrementIterations()},t.prototype.setLearningRate=function(e){this.learningRate=e,this.c!=null&&this.c.dispose(),this.c=lx(Y(-e))},t.prototype.dispose=function(){this.c.dispose()},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()]]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:if((e=n.sent()).length!==0)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate}},t.fromConfig=function(e,n){return new e(n.learningRate)},t.className="SGD",t}(dr);Kn(Mc);var hv=function(i){function t(e,n,r){r===void 0&&(r=!1);var o=i.call(this,e)||this;return o.learningRate=e,o.momentum=n,o.useNesterov=r,o.accumulations=[],o.m=Y(o.momentum),o}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e)).forEach(function(r,o){var a=R.registeredVariables[r];n.accumulations[o]==null&&(n.accumulations[o]={originalName:r+"/momentum",variable:j(function(){return De(a).variable(!1)})});var s=n.accumulations[o].variable,u=Array.isArray(e)?e[o].tensor:e[r];u!=null&&j(function(){var c,l=n.m.mul(s).add(u);c=n.useNesterov?n.c.mul(u.add(l.mul(n.m))).add(a):n.c.mul(l).add(a),s.assign(l),a.assign(c)})}),this.incrementIterations()},t.prototype.dispose=function(){this.m.dispose(),this.accumulations!=null&&Nt(this.accumulations.map(function(e){return e.variable}))},t.prototype.setMomentum=function(e){this.momentum=e},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){return ne(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulations.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){return ne(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulations=e.map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},t.fromConfig=function(e,n){return new e(n.learningRate,n.momentum,n.useNesterov)},t.className="Momentum",t}(Mc);Kn(hv);var pv=function(i){function t(e,n,r,o,a){n===void 0&&(n=.9),r===void 0&&(r=0),o===void 0&&(o=null),a===void 0&&(a=!1);var s=i.call(this)||this;if(s.learningRate=e,s.decay=n,s.momentum=r,s.epsilon=o,s.accumulatedMeanSquares=[],s.accumulatedMoments=[],s.accumulatedMeanGrads=[],s.centered=a,o==null&&(s.epsilon=R.backend.epsilon()),e==null)throw new Error("learningRate for RMSPropOptimizer must be defined.");return s}return Qt(t,i),t.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e)).forEach(function(r,o){var a=R.registeredVariables[r];n.accumulatedMeanSquares[o]==null&&(n.accumulatedMeanSquares[o]={originalName:r+"/rms",variable:j(function(){return De(a).variable(!1)})}),n.accumulatedMoments[o]==null&&(n.accumulatedMoments[o]={originalName:r+"/momentum",variable:j(function(){return De(a).variable(!1)})}),n.accumulatedMeanGrads[o]==null&&n.centered&&(n.accumulatedMeanGrads[o]={originalName:r+"/mg",variable:j(function(){return De(a).variable(!1)})});var s=Array.isArray(e)?e[o].tensor:e[r];if(s!=null){var u=n.accumulatedMeanSquares[o].variable,c=n.accumulatedMoments[o].variable;j(function(){var l=u.mul(n.decay).add(s.square().mul(1-n.decay));if(n.centered){var f=n.accumulatedMeanGrads[o].variable,h=f.mul(n.decay).add(s.mul(1-n.decay)),p=c.mul(n.momentum).add(s.mul(n.learningRate).div(l.sub(h.square().add(n.epsilon)).sqrt()));u.assign(l),f.assign(h),c.assign(p);var d=a.sub(p);a.assign(d)}else{var m=u.mul(n.decay).add(s.square().mul(1-n.decay));p=c.mul(n.momentum).add(s.mul(n.learningRate).div(m.add(n.epsilon).sqrt())),u.assign(m),c.assign(p),d=a.sub(p),a.assign(d)}})}}),this.incrementIterations()},t.prototype.dispose=function(){this.accumulatedMeanSquares!=null&&Nt(this.accumulatedMeanSquares.map(function(e){return e.variable})),this.accumulatedMeanGrads!=null&&this.centered&&Nt(this.accumulatedMeanGrads.map(function(e){return e.variable})),this.accumulatedMoments!=null&&Nt(this.accumulatedMoments.map(function(e){return e.variable}))},t.prototype.getWeights=function(){return te(this,void 0,void 0,function(){var e;return ne(this,function(n){switch(n.label){case 0:return e=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&e.push.apply(e,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(r){return{name:r.originalName,tensor:r.variable}}))]}})})},t.prototype.setWeights=function(e){return te(this,void 0,void 0,function(){var n;return ne(this,function(r){switch(r.label){case 0:return[4,this.extractIterations(e)];case 1:return e=r.sent(),n=this.centered?e.length/3:e.length/2,this.accumulatedMeanSquares=e.slice(0,n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),this.accumulatedMoments=e.slice(n,2*n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=e.slice(2*n,3*n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}})),[2]}})})},t.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},t.fromConfig=function(e,n){return new e(n.learningRate,n.decay,n.momentum,n.epsilon,n.centered)},t.className="RMSProp",t}(dr);Kn(pv);var er=function(){function i(){}return i.sgd=function(t){return new Mc(t)},i.momentum=function(t,e,n){return n===void 0&&(n=!1),new hv(t,e,n)},i.rmsprop=function(t,e,n,r,o){return e===void 0&&(e=.9),n===void 0&&(n=0),r===void 0&&(r=null),o===void 0&&(o=!1),new pv(t,e,n,r,o)},i.adam=function(t,e,n,r){return t===void 0&&(t=.001),e===void 0&&(e=.9),n===void 0&&(n=.999),r===void 0&&(r=null),new lv(t,e,n,r)},i.adadelta=function(t,e,n){return t===void 0&&(t=.001),e===void 0&&(e=.95),n===void 0&&(n=null),new uv(t,e,n)},i.adamax=function(t,e,n,r,o){return t===void 0&&(t=.002),e===void 0&&(e=.9),n===void 0&&(n=.999),r===void 0&&(r=null),o===void 0&&(o=0),new fv(t,e,n,r,o)},i.adagrad=function(t,e){return e===void 0&&(e=.1),new cv(t,e)},i}(),rD={sgd:er.sgd,momentum:er.momentum,adadelta:er.adadelta,adagrad:er.adagrad,rmsprop:er.rmsprop,adamax:er.adamax,adam:er.adam};Me.prototype.squaredDifference=function(i){return Em(this,i)},M=XC;function Xn(i,t,e){if(e===void 0&&(e=!1),i.beginPath(),t.slice(1).forEach(function(o,a){var s=o.x,u=o.y,c=t[a];i.moveTo(c.x,c.y),i.lineTo(s,u)}),e){var n=t[t.length-1],r=t[0];if(!n||!r)return;i.moveTo(n.x,n.y),i.lineTo(r.x,r.y)}i.stroke()}var Oc=function(i,t){return Oc=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])},Oc(i,t)};function J(i,t){Oc(i,t);function e(){this.constructor=i}i.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var et=function(){return et=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},et.apply(this,arguments)};function X(i,t,e,n){function r(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function s(l){try{c(n.next(l))}catch(f){a(f)}}function u(l){try{c(n.throw(l))}catch(f){a(f)}}function c(l){l.done?o(l.value):r(l.value).then(s,u)}c((n=n.apply(i,t||[])).next())})}function $(i,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,r,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(c){return function(l){return u([c,l])}}function u(c){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,r&&(o=c[0]&2?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[c[0]&2,o.value]),c[0]){case 0:case 1:o=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,r=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!o||c[1]>o[0]&&c[1]<o[3])){e.label=c[1];break}if(c[0]===6&&e.label<o[1]){e.label=o[1],o=c;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(c);break}o[2]&&e.ops.pop(),e.trys.pop();continue}c=t.call(i,e)}catch(l){c=[6,l],r=0}finally{n=o=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function mr(){for(var i=0,t=0,e=arguments.length;t<e;t++)i+=arguments[t].length;for(var n=Array(i),r=0,t=0;t<e;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,r++)n[r]=o[a];return n}var nn=function(){function i(t,e){if(!mn(t)||!mn(e))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:t,height:e}));this._width=t,this._height=e}return Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),i.prototype.reverse=function(){return new i(1/this.width,1/this.height)},i}();function Gi(i,t){return i instanceof Me&&i.shape.length===t}function dv(i){return Gi(i,2)}function $n(i){return Gi(i,3)}function Gt(i){return Gi(i,4)}function mv(i){return i%1!==0}function Bc(i){return i%2===0}function fa(i,t){t===void 0&&(t=2);var e=Math.pow(10,t);return Math.floor(i*e)/e}function Lc(i){return i&&i.width&&i.height}function vv(i,t){var e=i.width,n=i.height,r=t/Math.max(n,e);return new nn(Math.round(e*r),Math.round(n*r))}function Xr(i){return i.reduce(function(t,e){return t.add(e)},new he(0,0)).div(new he(i.length,i.length))}function In(i,t,e){return Array(i).fill(0).map(function(n,r){return t+r*e})}function mn(i){return!!i&&i!==1/0&&i!==-1/0&&!isNaN(i)||i===0}function ha(i){return mn(i)&&0<=i&&i<=1}var he=function(){function i(t,e){this._x=t,this._y=e}return Object.defineProperty(i.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),i.prototype.add=function(t){return new i(this.x+t.x,this.y+t.y)},i.prototype.sub=function(t){return new i(this.x-t.x,this.y-t.y)},i.prototype.mul=function(t){return new i(this.x*t.x,this.y*t.y)},i.prototype.div=function(t){return new i(this.x/t.x,this.y/t.y)},i.prototype.abs=function(){return new i(Math.abs(this.x),Math.abs(this.y))},i.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},i.prototype.floor=function(){return new i(Math.floor(this.x),Math.floor(this.y))},i}();var vt=function(){function i(t,e){e===void 0&&(e=!0);var n=t||{},r=[n.left,n.top,n.right,n.bottom].every(mn),o=[n.x,n.y,n.width,n.height].every(mn);if(!o&&!r)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(n));var a=o?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top],s=a[0],u=a[1],c=a[2],l=a[3];i.assertIsValidBox({x:s,y:u,width:c,height:l},"Box.constructor",e),this._x=s,this._y=u,this._width=c,this._height=l}return i.isRect=function(t){return!!t&&[t.x,t.y,t.width,t.height].every(mn)},i.assertIsValidBox=function(t,e,n){if(n===void 0&&(n=!1),!i.isRect(t))throw new Error(e+" - invalid box: "+JSON.stringify(t)+", expected object with properties x, y, width, height");if(!n&&(t.width<0||t.height<0))throw new Error(e+" - width ("+t.width+") and height ("+t.height+") must be positive numbers")},Object.defineProperty(i.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"topLeft",{get:function(){return new he(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"topRight",{get:function(){return new he(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bottomLeft",{get:function(){return new he(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bottomRight",{get:function(){return new he(this.right,this.bottom)},enumerable:!0,configurable:!0}),i.prototype.round=function(){var t=[this.x,this.y,this.width,this.height].map(function(a){return Math.round(a)}),e=t[0],n=t[1],r=t[2],o=t[3];return new i({x:e,y:n,width:r,height:o})},i.prototype.floor=function(){var t=[this.x,this.y,this.width,this.height].map(function(a){return Math.floor(a)}),e=t[0],n=t[1],r=t[2],o=t[3];return new i({x:e,y:n,width:r,height:o})},i.prototype.toSquare=function(){var t=this,e=t.x,n=t.y,r=t.width,o=t.height,a=Math.abs(r-o);return r<o&&(e-=a/2,r+=a),o<r&&(n-=a/2,o+=a),new i({x:e,y:n,width:r,height:o})},i.prototype.rescale=function(t){var e=Lc(t)?t.width:t,n=Lc(t)?t.height:t;return new i({x:this.x*e,y:this.y*n,width:this.width*e,height:this.height*n})},i.prototype.pad=function(t,e){var n=[this.x-t/2,this.y-e/2,this.width+t,this.height+e],r=n[0],o=n[1],a=n[2],s=n[3];return new i({x:r,y:o,width:a,height:s})},i.prototype.clipAtImageBorders=function(t,e){var n=this,r=n.x,o=n.y,a=n.right,s=n.bottom,u=Math.max(r,0),c=Math.max(o,0),l=a-u,f=s-c,h=Math.min(l,t-u),p=Math.min(f,e-c);return new i({x:u,y:c,width:h,height:p}).floor()},i.prototype.shift=function(t,e){var n=this,r=n.width,o=n.height,a=this.x+t,s=this.y+e;return new i({x:a,y:s,width:r,height:o})},i.prototype.padAtBorders=function(t,e){var n=this.width+1,r=this.height+1,o=1,a=1,s=n,u=r,c=this.left,l=this.top,f=this.right,h=this.bottom;return f>e&&(s=-f+e+n,f=e),h>t&&(u=-h+t+r,h=t),c<1&&(u=2-c,c=1),l<1&&(u=2-l,l=1),{dy:a,edy:u,dx:o,edx:s,y:l,ey:h,x:c,ex:f,w:n,h:r}},i.prototype.calibrate=function(t){return new i({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()},i}();var vr=function(i){J(t,i);function t(e,n,r,o,a){return a===void 0&&(a=!1),i.call(this,{left:e,top:n,right:r,bottom:o},a)||this}return t}(vt);var pa=function(){function i(t,e,n,r,o){this._imageDims=new nn(o.width,o.height),this._score=t,this._classScore=e,this._className=n,this._box=new vt(r).rescale(this._imageDims)}return Object.defineProperty(i.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"relativeBox",{get:function(){return new vt(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),i.prototype.forSize=function(t,e){return new i(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:e})},i}();var Ye=function(i){J(t,i);function t(e,n,r){return i.call(this,e,e,"",n,r)||this}return t.prototype.forSize=function(e,n){var r=i.prototype.forSize.call(this,e,n),o=r.score,a=r.relativeBox,s=r.imageDims;return new t(o,a,s)},t}(pa);function gv(i,t,e){e===void 0&&(e=!0);var n=Math.max(0,Math.min(i.right,t.right)-Math.max(i.left,t.left)),r=Math.max(0,Math.min(i.bottom,t.bottom)-Math.max(i.top,t.top)),o=n*r;return e?o/(i.area+t.area-o):o/Math.min(i.area,t.area)}function yv(i){var t=i.map(function(s){return s.x}),e=i.map(function(s){return s.y}),n=t.reduce(function(s,u){return u<s?u:s},1/0),r=e.reduce(function(s,u){return u<s?u:s},1/0),o=t.reduce(function(s,u){return s<u?u:s},0),a=e.reduce(function(s,u){return s<u?u:s},0);return new vr(n,r,o,a)}function Tn(i,t,e,n){n===void 0&&(n=!0);for(var r=t.map(function(s,u){return{score:s,boxIndex:u}}).sort(function(s,u){return s.score-u.score}).map(function(s){return s.boxIndex}),o=[],a=function(){var s=r.pop();o.push(s);for(var u=r,c=[],l=0;l<u.length;l++){var f=u[l],h=i[s],p=i[f];c.push(gv(h,p,n))}r=r.filter(function(d,m){return c[m]<=e})};r.length>0;)a();return o}function vn(i,t){return j(function(){var e=t[0],n=t[1],r=t[2],o=qt(mr(i.shape.slice(0,3),[1]),e),a=qt(mr(i.shape.slice(0,3),[1]),n),s=qt(mr(i.shape.slice(0,3),[1]),r),u=ze([o,a,s],3);return Oe(i,u)})}function xv(i,t){return t===void 0&&(t=!1),j(function(){var e=i.shape.slice(1),n=e[0],r=e[1];if(n===r)return i;var o=Math.abs(n-r),a=Math.round(o*(t?.5:1)),s=n>r?2:1,u=function(p){var d=i.shape.slice();return d[s]=p,qt(d,0)},c=u(a),l=o-c.shape[s],f=t&&l?u(l):null,h=[f,i,c].filter(function(p){return!!p}).map(function(p){return p.toFloat()});return ze(h,s)})}function da(i){return 1/(1+Math.exp(-i))}var $r=function(i){J(t,i);function t(e,n,r,o,a){return a===void 0&&(a=!1),i.call(this,{x:e,y:n,width:r,height:o},a)||this}return t}(vt);var y_=.5,x_=.43,b_=.45,Nn=function(){function i(t,e,n){n===void 0&&(n=new he(0,0));var r=e.width,o=e.height;this._imgDims=new nn(r,o),this._shift=n,this._positions=t.map(function(a){return a.mul(new he(r,o)).add(n)})}return Object.defineProperty(i.prototype,"shift",{get:function(){return new he(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"relativePositions",{get:function(){var t=this;return this._positions.map(function(e){return e.sub(t._shift).div(new he(t.imageWidth,t.imageHeight))})},enumerable:!0,configurable:!0}),i.prototype.forSize=function(t,e){return new this.constructor(this.relativePositions,{width:t,height:e})},i.prototype.shiftBy=function(t,e){return new this.constructor(this.relativePositions,this._imgDims,new he(t,e))},i.prototype.shiftByPoint=function(t){return this.shiftBy(t.x,t.y)},i.prototype.align=function(t,e){if(e===void 0&&(e={}),t){var n=t instanceof Ye?t.box.floor():new vt(t);return this.shiftBy(n.x,n.y).align(null,e)}var r=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},e),o=r.useDlibAlignment,a=r.minBoxPadding;return o?this.alignDlib():this.alignMinBbox(a)},i.prototype.alignDlib=function(){var t=this.getRefPointsForAlignment(),e=t[0],n=t[1],r=t[2],o=function(f){return r.sub(f).magnitude()},a=(o(e)+o(n))/2,s=Math.floor(a/b_),u=Xr(t),c=Math.floor(Math.max(0,u.x-y_*s)),l=Math.floor(Math.max(0,u.y-x_*s));return new $r(c,l,Math.min(s,this.imageWidth+c),Math.min(s,this.imageHeight+l))},i.prototype.alignMinBbox=function(t){var e=yv(this.positions);return e.pad(e.width*t,e.height*t)},i.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},i}();var bv=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],Xr([e[3],e[4]])]},t}(Nn);var ma=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.getJawOutline=function(){return this.positions.slice(0,17)},t.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},t.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},t.prototype.getNose=function(){return this.positions.slice(27,36)},t.prototype.getLeftEye=function(){return this.positions.slice(36,42)},t.prototype.getRightEye=function(){return this.positions.slice(42,48)},t.prototype.getMouth=function(){return this.positions.slice(48,68)},t.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(Xr)},t}(Nn);var Wc=function(){function i(t,e){this._label=t,this._distance=e}return Object.defineProperty(i.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),i.prototype.toString=function(t){return t===void 0&&(t=!0),""+this.label+(t?" ("+fa(this.distance)+")":"")},i}();var zc=function(i){J(t,i);function t(e,n){var r=i.call(this,e)||this;return r._label=n,r}return t.assertIsValidLabeledBox=function(e,n){if(vt.assertIsValidBox(e,n),!mn(e.label))throw new Error(n+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),t}(vt);var Hi=function(){function i(t,e){if(typeof t!="string")throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(function(n){return!(n instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=t,this._descriptors=e}return Object.defineProperty(i.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),i.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(t){return Array.from(t)})}},i.fromJSON=function(t){var e=t.descriptors.map(function(n){return new Float32Array(n)});return new i(t.label,e)},i}();var dS=function(i){J(t,i);function t(e,n,r,o){var a=i.call(this,e,n)||this;return a._score=r,a._classScore=o,a}return t.assertIsValidPredictedBox=function(e,n){if(zc.assertIsValidLabeledBox(e,n),!ha(e.score)||!ha(e.classScore))throw new Error(n+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(t.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),t}(zc);function Ki(i){return i.detection instanceof Ye}function Yr(i,t){var e={detection:t};return Object.assign({},i,e)}function qc(){var i=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")},t=function(){throw new Error("readFile - filesystem not available for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:i,readFile:t}}function va(i){var t="";if(!i)try{i=Ua("fs")}catch(n){t=n.toString()}var e=i?function(n){return new Promise(function(r,o){i.readFile(n,function(a,s){return a?o(a):r(s)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+t)};return{readFile:e}}function Vc(){var i=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,e=function(){if(i)return new i;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},n=function(){if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},r=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},o=va();return et({Canvas:i||function(){function a(){}return a}(),CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){function a(){}return a}(),Image:t||function(){function a(){}return a}(),ImageData:global.ImageData||function(){function a(){}return a}(),Video:global.HTMLVideoElement||function(){function a(){}return a}(),createCanvasElement:e,createImageElement:n,fetch:r},o)}function Uc(){return typeof window=="object"&&typeof document<"u"&&typeof HTMLImageElement<"u"&&typeof HTMLCanvasElement<"u"&&typeof HTMLVideoElement<"u"&&typeof ImageData<"u"&&typeof CanvasRenderingContext2D<"u"}function jc(){return typeof global=="object"&&typeof Ua=="function"&&typeof module<"u"&&typeof process<"u"&&!!process.version}var ot;function w_(){if(!ot)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return ot}function Gc(i){ot=i}function Hc(){Uc()&&Gc(qc()),jc()&&Gc(Vc())}function C_(i){if(ot||Hc(),!ot)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var t=i.Canvas,e=t===void 0?ot.Canvas:t,n=i.Image,r=n===void 0?ot.Image:n;ot.Canvas=e,ot.Image=r,ot.createCanvasElement=i.createCanvasElement||function(){return new e},ot.createImageElement=i.createImageElement||function(){return new r},ot.ImageData=i.ImageData||ot.ImageData,ot.Video=i.Video||ot.Video,ot.fetch=i.fetch||ot.fetch,ot.readFile=i.readFile||ot.readFile}var Fe={getEnv:w_,setEnv:Gc,initialize:Hc,createBrowserEnv:qc,createFileSystem:va,createNodejsEnv:Vc,monkeyPatch:C_,isBrowser:Uc,isNodejs:jc};Hc();function Jr(i){return!Fe.isNodejs()&&typeof i=="string"?document.getElementById(i):i}function gt(i){var t=Fe.getEnv(),e=t.Canvas,n=t.CanvasRenderingContext2D;if(i instanceof n)return i;var r=Jr(i);if(!(r instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var o=r.getContext("2d");if(!o)throw new Error("resolveContext2d - canvas 2d context is null");return o}var Yn=function(i){return i.TOP_LEFT="TOP_LEFT",i.TOP_RIGHT="TOP_RIGHT",i.BOTTOM_LEFT="BOTTOM_LEFT",i.BOTTOM_RIGHT="BOTTOM_RIGHT",i}(Yn||{}),Kc=function(){function i(t){t===void 0&&(t={});var e=t.anchorPosition,n=t.backgroundColor,r=t.fontColor,o=t.fontSize,a=t.fontStyle,s=t.padding;this.anchorPosition=e||Yn.TOP_LEFT,this.backgroundColor=n||"rgba(0, 0, 0, 0.5)",this.fontColor=r||"rgba(255, 255, 255, 1)",this.fontSize=o||14,this.fontStyle=a||"Georgia",this.padding=s||4}return i}();var Xc=function(){function i(t,e,n){n===void 0&&(n={}),this.text=typeof t=="string"?[t]:t instanceof i?t.text:t,this.anchor=e,this.options=new Kc(n)}return i.prototype.measureWidth=function(t){var e=this.options.padding;return this.text.map(function(n){return t.measureText(n).width}).reduce(function(n,r){return n<r?r:n},0)+2*e},i.prototype.measureHeight=function(){var t=this.options,e=t.fontSize,n=t.padding;return this.text.length*e+2*n},i.prototype.getUpperLeft=function(t,e){var n=this.options.anchorPosition,r=n===Yn.BOTTOM_RIGHT||n===Yn.TOP_RIGHT,o=n===Yn.BOTTOM_LEFT||n===Yn.BOTTOM_RIGHT,a=this.measureWidth(t),s=this.measureHeight(),u=r?this.anchor.x-a:this.anchor.x,c=o?this.anchor.y-s:this.anchor.y;if(e){var l=e.width,f=e.height,h=Math.max(Math.min(u,l-a),0),p=Math.max(Math.min(c,f-s),0);return{x:h,y:p}}return{x:u,y:c}},i.prototype.draw=function(t){var e=Jr(t),n=gt(e),r=this.options,o=r.backgroundColor,a=r.fontColor,s=r.fontSize,u=r.fontStyle,c=r.padding;n.font=s+"px "+u;var l=this.measureWidth(n),f=this.measureHeight();n.fillStyle=o;var h=this.getUpperLeft(n,e);n.fillRect(h.x,h.y,l,f),n.fillStyle=a,this.text.forEach(function(p,d){var m=c+h.x,v=c+h.y+(d+1)*s;n.fillText(p,m,v)})},i}();var __=function(){function i(t){t===void 0&&(t={});var e=t.boxColor,n=t.lineWidth,r=t.label,o=t.drawLabelOptions;this.boxColor=e||"rgba(0, 0, 255, 1)",this.lineWidth=n||2,this.label=r;var a={anchorPosition:Yn.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new Kc(Object.assign({},a,o))}return i}();var E_=function(){function i(t,e){e===void 0&&(e={}),this.box=new vt(t),this.options=new __(e)}return i.prototype.draw=function(t){var e=gt(t),n=this.options,r=n.boxColor,o=n.lineWidth,a=this.box,s=a.x,u=a.y,c=a.width,l=a.height;e.strokeStyle=r,e.lineWidth=o,e.strokeRect(s,u,c,l);var f=this.options.label;f&&new Xc([f],{x:s-o/2,y:u},this.options.drawLabelOptions).draw(t)},i}();function ga(i){var t=Fe.getEnv(),e=t.Image,n=t.Video;return i instanceof e&&i.complete||i instanceof n&&i.readyState>=3}function wv(i){return new Promise(function(t,e){if(i instanceof Fe.getEnv().Canvas||ga(i))return t();function n(o){o.currentTarget&&(o.currentTarget.removeEventListener("load",n),o.currentTarget.removeEventListener("error",r),t(o))}function r(o){o.currentTarget&&(o.currentTarget.removeEventListener("load",n),o.currentTarget.removeEventListener("error",r),e(o))}i.addEventListener("load",n),i.addEventListener("error",r)})}function Xi(i){var t=Fe.getEnv(),e=t.Image,n=t.Video;return i instanceof e?new nn(i.naturalWidth,i.naturalHeight):i instanceof n?new nn(i.videoWidth,i.videoHeight):new nn(i.width,i.height)}function gr(i){var t=i.width,e=i.height,n=Fe.getEnv().createCanvasElement,r=n();return r.width=t,r.height=e,r}function Qr(i,t){var e=Fe.getEnv().ImageData;if(!(i instanceof e)&&!ga(i))throw new Error("createCanvasFromMedia - media has not finished loading yet");var n=t||Xi(i),r=n.width,o=n.height,a=gr({width:r,height:o});return i instanceof e?gt(a).putImageData(i,0,0):gt(a).drawImage(i,0,0,r,o),a}function Cv(i,t){return X(this,void 0,void 0,function(){var e,n,r,o,a,s;return $(this,function(u){switch(u.label){case 0:return e=t||Fe.getEnv().createCanvasElement(),n=i.shape.slice(Gt(i)?1:0),r=n[0],o=n[1],a=n[2],s=j(function(){return i.as3D(r,o,a).toInt()}),[4,Kr.toPixels(s,e)];case 1:return u.sent(),s.dispose(),[2,e]}})})}function $c(i){var t=Fe.getEnv(),e=t.Image,n=t.Canvas,r=t.Video;return i instanceof e||i instanceof n||i instanceof r}function _v(i,t,e){e===void 0&&(e=!1);var n=Fe.getEnv(),r=n.Image,o=n.Canvas;if(!(i instanceof r||i instanceof o))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var a=Xi(i),s=t/Math.max(a.height,a.width),u=s*a.width,c=s*a.height,l=gr({width:t,height:t}),f=i instanceof o?i:Qr(i),h=Math.abs(u-c)/2,p=e&&u<c?h:0,d=e&&c<u?h:0;return gt(l).drawImage(f,p,d,u,c),l}var yr=function(){function i(t,e){var n=this;if(e===void 0&&(e=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(t))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+t);this._treatAsBatchInput=e,this._batchSize=t.length,t.forEach(function(r,o){if($n(r)){n._imageTensors[o]=r,n._inputDimensions[o]=r.shape;return}if(Gt(r)){var a=r.shape[0];if(a!==1)throw new Error("NetInput - tf.Tensor4D with batchSize "+a+" passed, but not supported in input array");n._imageTensors[o]=r,n._inputDimensions[o]=r.shape.slice(1);return}var s=r instanceof Fe.getEnv().Canvas?r:Qr(r);n._canvases[o]=s,n._inputDimensions[o]=[s.height,s.width,3]})}return Object.defineProperty(i.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"reshapedInputDimensions",{get:function(){var t=this;return In(this.batchSize,0,1).map(function(e,n){return t.getReshapedInputDimensions(n)})},enumerable:!0,configurable:!0}),i.prototype.getInput=function(t){return this.canvases[t]||this.imageTensors[t]},i.prototype.getInputDimensions=function(t){return this._inputDimensions[t]},i.prototype.getInputHeight=function(t){return this._inputDimensions[t][0]},i.prototype.getInputWidth=function(t){return this._inputDimensions[t][1]},i.prototype.getReshapedInputDimensions=function(t){if(typeof this.inputSize!="number")throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");var e=this.getInputWidth(t),n=this.getInputHeight(t);return vv({width:e,height:n},this.inputSize)},i.prototype.toBatchTensor=function(t,e){var n=this;return e===void 0&&(e=!0),this._inputSize=t,j(function(){var r=In(n.batchSize,0,1).map(function(a){var s=n.getInput(a);if(s instanceof Me){var u=Gt(s)?s:s.expandDims();return u=xv(u,e),(u.shape[1]!==t||u.shape[2]!==t)&&(u=Ui.resizeBilinear(u,[t,t])),u.as3D(t,t,3)}if(s instanceof Fe.getEnv().Canvas)return Kr.fromPixels(_v(s,t,e));throw new Error("toBatchTensor - at batchIdx "+a+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+s)}),o=mt(r.map(function(a){return a.toFloat()})).as4D(n.batchSize,t,t,3);return o})},i}();function Ne(i){return X(this,void 0,void 0,function(){var t,e,n;return $(this,function(r){switch(r.label){case 0:if(i instanceof yr)return[2,i];if(t=Array.isArray(i)?i:[i],!t.length)throw new Error("toNetInput - empty array passed as input");return e=function(o){return Array.isArray(i)?" at input index "+o+":":""},n=t.map(Jr),n.forEach(function(o,a){if(!$c(o)&&!$n(o)&&!Gt(o))throw typeof t[a]=="string"?new Error("toNetInput -"+e(a)+" string passed, but could not resolve HTMLElement for element id "+t[a]):new Error("toNetInput -"+e(a)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id");if(Gt(o)){var s=o.shape[0];if(s!==1)throw new Error("toNetInput -"+e(a)+" tf.Tensor4D with batchSize "+s+" passed, but not supported in input array")}}),[4,Promise.all(n.map(function(o){return $c(o)&&wv(o)}))];case 1:return r.sent(),[2,new yr(n,Array.isArray(i))]}})})}function $i(i,t){return X(this,void 0,void 0,function(){var e,n,r,o,a,s,u;return $(this,function(c){switch(c.label){case 0:return e=Fe.getEnv().Canvas,n=i,i instanceof e?[3,5]:[4,Ne(i)];case 1:if(r=c.sent(),r.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");return o=r.getInput(0),o instanceof e?(a=o,[3,4]):[3,2];case 2:return[4,Cv(o)];case 3:a=c.sent(),c.label=4;case 4:n=a,c.label=5;case 5:return s=gt(n),u=t.map(function(l){return l instanceof Ye?l.forSize(n.width,n.height).box.floor():l}).map(function(l){return l.clipAtImageBorders(n.width,n.height)}),[2,u.map(function(l){var f=l.x,h=l.y,p=l.width,d=l.height,m=gr({width:p,height:d});return gt(m).putImageData(s.getImageData(f,h,p,d),0,0),m})]}})})}function Yi(i,t){return X(this,void 0,void 0,function(){return $(this,function(e){if(!$n(i)&&!Gt(i))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(Gt(i)&&i.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,j(function(){var n=i.shape.slice(Gt(i)?1:0),r=n[0],o=n[1],a=n[2],s=t.map(function(c){return c instanceof Ye?c.forSize(o,r).box:c}).map(function(c){return c.clipAtImageBorders(o,r)}),u=s.map(function(c){var l=c.x,f=c.y,h=c.width,p=c.height;return kc(i.as3D(r,o,a),[f,l,0],[p,h,a])});return u})]})})}function ya(i,t){return X(this,void 0,void 0,function(){var e,n;return $(this,function(r){switch(r.label){case 0:return e=Fe.getEnv().fetch,[4,e(i,t)];case 1:if(n=r.sent(),!(n.status<400))throw new Error("failed to fetch: ("+n.status+") "+n.statusText+", from url: "+n.url);return[2,n]}})})}function Ev(i){return X(this,void 0,void 0,function(){return $(this,function(t){switch(t.label){case 0:return[4,ya(i)];case 1:return[2,t.sent().json()]}})})}function xa(i,t){var e=t+"-weights_manifest.json";if(!i)return{modelBaseUri:"",manifestUri:e};if(i==="/")return{modelBaseUri:"/",manifestUri:"/"+e};var n=i.startsWith("http://")?"http://":i.startsWith("https://")?"https://":"";i=i.replace(n,"");var r=i.split("/").filter(function(s){return s}),o=i.endsWith(".json")?r[r.length-1]:e,a=n+(i.endsWith(".json")?r.slice(0,r.length-1):r).join("/");return a=i.startsWith("/")?"/"+a:a,{modelBaseUri:a,manifestUri:a==="/"?"/"+o:a+"/"+o}}function kv(i,t){return X(this,void 0,void 0,function(){var e,n,r,o;return $(this,function(a){switch(a.label){case 0:return e=xa(i,t),n=e.manifestUri,r=e.modelBaseUri,[4,Ev(n)];case 1:return o=a.sent(),[2,la.loadWeights(o,r)]}})})}var ct=function(){function i(t){this._name=t,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(i.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),i.prototype.getParamFromPath=function(t){var e=this.traversePropertyPath(t),n=e.obj,r=e.objProp;return n[r]},i.prototype.reassignParamFromPath=function(t,e){var n=this.traversePropertyPath(t),r=n.obj,o=n.objProp;r[o].dispose(),r[o]=e},i.prototype.getParamList=function(){var t=this;return this._paramMappings.map(function(e){var n=e.paramPath;return{path:n,tensor:t.getParamFromPath(n)}})},i.prototype.getTrainableParams=function(){return this.getParamList().filter(function(t){return t.tensor instanceof sr})},i.prototype.getFrozenParams=function(){return this.getParamList().filter(function(t){return!(t.tensor instanceof sr)})},i.prototype.variable=function(){var t=this;this.getFrozenParams().forEach(function(e){var n=e.path,r=e.tensor;t.reassignParamFromPath(n,r.variable())})},i.prototype.freeze=function(){var t=this;this.getTrainableParams().forEach(function(e){var n=e.path,r=e.tensor,o=st(r.dataSync());r.dispose(),t.reassignParamFromPath(n,o)})},i.prototype.dispose=function(t){t===void 0&&(t=!0),this.getParamList().forEach(function(e){if(t&&e.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+e.path);e.tensor.dispose()}),this._params=void 0},i.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(t){var e=t.tensor;return Array.from(e.dataSync())}).reduce(function(t,e){return t.concat(e)}))},i.prototype.load=function(t){return X(this,void 0,void 0,function(){return $(this,function(e){switch(e.label){case 0:return t instanceof Float32Array?(this.extractWeights(t),[2]):[4,this.loadFromUri(t)];case 1:return e.sent(),[2]}})})},i.prototype.loadFromUri=function(t){return X(this,void 0,void 0,function(){var e;return $(this,function(n){switch(n.label){case 0:if(t&&typeof t!="string")throw new Error(this._name+".loadFromUri - expected model uri");return[4,kv(t,this.getDefaultModelName())];case 1:return e=n.sent(),this.loadFromWeightMap(e),[2]}})})},i.prototype.loadFromDisk=function(t){return X(this,void 0,void 0,function(){var e,n,r,o,a,s,u,c,l,f;return $(this,function(h){switch(h.label){case 0:if(t&&typeof t!="string")throw new Error(this._name+".loadFromDisk - expected model file path");return e=Fe.getEnv().readFile,n=xa(t,this.getDefaultModelName()),r=n.manifestUri,o=n.modelBaseUri,a=function(p){return Promise.all(p.map(function(d){return e(d).then(function(m){return m.buffer})}))},s=la.weightsLoaderFactory(a),l=(c=JSON).parse,[4,e(r)];case 1:return u=l.apply(c,[h.sent().toString()]),[4,s(u,o)];case 2:return f=h.sent(),this.loadFromWeightMap(f),[2]}})})},i.prototype.loadFromWeightMap=function(t){var e=this.extractParamsFromWeigthMap(t),n=e.paramMappings,r=e.params;this._paramMappings=n,this._params=r},i.prototype.extractWeights=function(t){var e=this.extractParams(t),n=e.paramMappings,r=e.params;this._paramMappings=n,this._params=r},i.prototype.traversePropertyPath=function(t){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var e=t.split("/").reduce(function(o,a){if(!o.nextObj.hasOwnProperty(a))throw new Error("traversePropertyPath - object does not have property "+a+", for path "+t);return{obj:o.nextObj,objProp:a,nextObj:o.nextObj[a]}},{nextObj:this.params}),n=e.obj,r=e.objProp;if(!n||!r||!(n[r]instanceof Me))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+t);return{obj:n,objProp:r}},i}();function At(i,t,e){return j(function(){var n=qi(i,t.depthwise_filter,t.pointwise_filter,e,"same");return n=se(n,t.bias),n})}function ba(i,t,e){return e===void 0&&(e=!1),j(function(){var n=Re(e?se(ut(i,t.conv0.filters,[2,2],"same"),t.conv0.bias):At(i,t.conv0,[2,2])),r=At(n,t.conv1,[1,1]),o=Re(se(n,r)),a=At(o,t.conv2,[1,1]);return Re(se(n,se(r,a)))})}function Ji(i,t,e,n){return e===void 0&&(e=!1),n===void 0&&(n=!0),j(function(){var r=Re(e?se(ut(i,t.conv0.filters,n?[2,2]:[1,1],"same"),t.conv0.bias):At(i,t.conv0,n?[2,2]:[1,1])),o=At(r,t.conv1,[1,1]),a=Re(se(r,o)),s=At(a,t.conv2,[1,1]),u=Re(se(r,se(o,s))),c=At(u,t.conv3,[1,1]);return Re(se(r,se(o,se(s,c))))})}function Ct(i,t,e,n){return e===void 0&&(e="same"),n===void 0&&(n=!1),j(function(){var r=se(ut(i,t.filters,[1,1],e),t.bias);return n?Re(r):r})}function lt(i,t){Object.keys(i).forEach(function(e){t.some(function(n){return n.originalPath===e})||i[e].dispose()})}function Jn(i,t){return function(e,n,r,o){var a=it(i(e*n*r*r),[r,r,e,n]),s=Be(i(n));return t.push({paramPath:o+"/filters"},{paramPath:o+"/bias"}),{filters:a,bias:s}}}function Zr(i,t){return function(e,n,r){var o=hn(i(e*n),[e,n]),a=Be(i(n));return t.push({paramPath:r+"/weights"},{paramPath:r+"/bias"}),{weights:o,bias:a}}}var Yc=function(){function i(t,e,n){this.depthwise_filter=t,this.pointwise_filter=e,this.bias=n}return i}();function ei(i,t){return function(e,n,r){var o=it(i(9*e),[3,3,e,1]),a=it(i(e*n),[1,1,e,n]),s=Be(i(n));return t.push({paramPath:r+"/depthwise_filter"},{paramPath:r+"/pointwise_filter"},{paramPath:r+"/bias"}),new Yc(o,a,s)}}function ti(i){return function(t){var e=i(t+"/depthwise_filter",4),n=i(t+"/pointwise_filter",4),r=i(t+"/bias",1);return new Yc(e,n,r)}}function _t(i,t){return function(e,n,r){var o=i[e];if(!Gi(o,n))throw new Error("expected weightMap["+e+"] to be a Tensor"+n+"D, instead have "+o);return t.push({originalPath:e,paramPath:r||e}),o}}function ft(i){var t=i;function e(r){var o=t.slice(0,r);return t=t.slice(r),o}function n(){return t}return{extractWeights:e,getRemainingWeights:n}}function wa(i,t){var e=Jn(i,t),n=ei(i,t);function r(a,s,u,c){c===void 0&&(c=!1);var l=c?e(a,s,3,u+"/conv0"):n(a,s,u+"/conv0"),f=n(s,s,u+"/conv1"),h=n(s,s,u+"/conv2");return{conv0:l,conv1:f,conv2:h}}function o(a,s,u,c){c===void 0&&(c=!1);var l=r(a,s,u,c),f=l.conv0,h=l.conv1,p=l.conv2,d=n(s,s,u+"/conv3");return{conv0:f,conv1:h,conv2:p,conv3:d}}return{extractDenseBlock3Params:r,extractDenseBlock4Params:o}}function Dv(i){var t=[],e=ft(i),n=e.extractWeights,r=e.getRemainingWeights,o=wa(n,t).extractDenseBlock4Params,a=o(3,32,"dense0",!0),s=o(32,64,"dense1"),u=o(64,128,"dense2"),c=o(128,256,"dense3");if(r().length!==0)throw new Error("weights remaing after extract: "+r().length);return{paramMappings:t,params:{dense0:a,dense1:s,dense2:u,dense3:c}}}function Ca(i){return function(t){var e=i(t+"/filters",4),n=i(t+"/bias",1);return{filters:e,bias:n}}}function _a(i,t){var e=_t(i,t),n=Ca(e),r=ti(e);function o(s,u){u===void 0&&(u=!1);var c=u?n(s+"/conv0"):r(s+"/conv0"),l=r(s+"/conv1"),f=r(s+"/conv2");return{conv0:c,conv1:l,conv2:f}}function a(s,u){u===void 0&&(u=!1);var c=u?n(s+"/conv0"):r(s+"/conv0"),l=r(s+"/conv1"),f=r(s+"/conv2"),h=r(s+"/conv3");return{conv0:c,conv1:l,conv2:f,conv3:h}}return{extractDenseBlock3Params:o,extractDenseBlock4Params:a}}function Sv(i){var t=[],e=_a(i,t).extractDenseBlock4Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2"),dense3:e("dense3")};return lt(i,t),{params:n,paramMappings:t}}var Ea=function(i){J(t,i);function t(){return i.call(this,"FaceFeatureExtractor")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return j(function(){var r=e.toBatchTensor(112,!0),o=[122.782,117.001,104.298],a=vn(r,o).div(Y(255)),s=Ji(a,n.dense0,!0);return s=Ji(s,n.dense1),s=Ji(s,n.dense2),s=Ji(s,n.dense3),s=Fn(s,[7,7],[2,2],"valid"),s})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Sv(e)},t.prototype.extractParams=function(e){return Dv(e)},t}(ct);function Pt(i,t){return j(function(){return se(Hr(i,t.weights),t.bias)})}function Av(i,t,e){var n=[],r=ft(i),o=r.extractWeights,a=r.getRemainingWeights,s=Zr(o,n),u=s(t,e,"fc");if(a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:n,params:{fc:u}}}function Fv(i){var t=[],e=_t(i,t);function n(o){var a=e(o+"/weights",2),s=e(o+"/bias",1);return{weights:a,bias:s}}var r={fc:n("fc")};return lt(i,t),{params:r,paramMappings:t}}function ka(i){var t={},e={};return Object.keys(i).forEach(function(n){var r=n.startsWith("fc")?e:t;r[n]=i[n]}),{featureExtractorMap:t,classifierMap:e}}var Da=function(i){J(t,i);function t(e,n){var r=i.call(this,e)||this;return r._faceFeatureExtractor=n,r}return Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,r=this.params;if(!r)throw new Error(this._name+" - load model before inference");return j(function(){var o=e instanceof yr?n.faceFeatureExtractor.forwardInput(e):e;return Pt(o.as2D(o.shape[0],-1),r.fc)})},t.prototype.dispose=function(e){e===void 0&&(e=!0),this.faceFeatureExtractor.dispose(e),i.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),r=n.params,o=n.paramMappings;this._params=r,this._paramMappings=o},t.prototype.extractClassifierParams=function(e){return Av(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},t.prototype.extractParamsFromWeigthMap=function(e){var n=ka(e),r=n.featureExtractorMap,o=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(r),Fv(o)},t.prototype.extractParams=function(e){var n=this.getClassifierChannelsIn(),r=this.getClassifierChannelsOut(),o=r*n+r,a=e.slice(0,e.length-o),s=e.slice(e.length-o);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(s)},t}(ct);var Rv=["neutral","happy","sad","angry","fearful","disgusted","surprised"],Sa=function(){function i(t){var e=this;if(t.length!==7)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+t.length);Rv.forEach(function(n,r){e[n]=t[r]})}return i.prototype.asSortedArray=function(){var t=this;return Rv.map(function(e){return{expression:e,probability:t[e]}}).sort(function(e,n){return n.probability-e.probability})},i}();var Iv=function(i){J(t,i);function t(e){return e===void 0&&(e=new Ea),i.call(this,"FaceExpressionNet",e)||this}return t.prototype.forwardInput=function(e){var n=this;return j(function(){return St(n.runNet(e))})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.predictExpressions=function(e){return X(this,void 0,void 0,function(){var n,r,o,a,s=this;return $(this,function(u){switch(u.label){case 0:return[4,Ne(e)];case 1:return n=u.sent(),[4,this.forwardInput(n)];case 2:return r=u.sent(),[4,Promise.all(Te(r).map(function(c){return X(s,void 0,void 0,function(){var l;return $(this,function(f){switch(f.label){case 0:return[4,c.data()];case 1:return l=f.sent(),c.dispose(),[2,l]}})})}))];case 3:return o=u.sent(),r.dispose(),a=o.map(function(c){return new Sa(c)}),[2,n.isBatchInput?a:a[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_expression_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t.prototype.getClassifierChannelsOut=function(){return 7},t}(Da);function Jc(i,t){var e={expressions:t};return Object.assign({},i,e)}function Aa(i){return Ki(i)&&i.landmarks instanceof Nn&&i.unshiftedLandmarks instanceof Nn&&i.alignedRect instanceof Ye}function ni(i,t){var e=i.detection.box,n=t.shiftBy(e.x,e.y),r=n.align(),o=i.detection.imageDims,a=new Ye(i.detection.score,r.rescale(o.reverse()),o),s={landmarks:n,unshiftedLandmarks:t,alignedRect:a};return Object.assign({},i,s)}var k_=function(){function i(t){t===void 0&&(t={});var e=t.drawLines,n=e===void 0?!0:e,r=t.drawPoints,o=r===void 0?!0:r,a=t.lineWidth,s=t.lineColor,u=t.pointSize,c=t.pointColor;this.drawLines=n,this.drawPoints=o,this.lineWidth=a||1,this.pointSize=u||2,this.lineColor=s||"rgba(0, 255, 255, 1)",this.pointColor=c||"rgba(255, 0, 255, 1)"}return i}();var TI=function(){function i(t,e){e===void 0&&(e={}),this.faceLandmarks=t,this.options=new k_(e)}return i.prototype.draw=function(t){var e=gt(t),n=this.options,r=n.drawLines,o=n.drawPoints,a=n.lineWidth,s=n.lineColor,u=n.pointSize,c=n.pointColor;if(r&&this.faceLandmarks instanceof ma&&(e.strokeStyle=s,e.lineWidth=a,Xn(e,this.faceLandmarks.getJawOutline()),Xn(e,this.faceLandmarks.getLeftEyeBrow()),Xn(e,this.faceLandmarks.getRightEyeBrow()),Xn(e,this.faceLandmarks.getNose()),Xn(e,this.faceLandmarks.getLeftEye(),!0),Xn(e,this.faceLandmarks.getRightEye(),!0),Xn(e,this.faceLandmarks.getMouth(),!0)),o){e.strokeStyle=c,e.fillStyle=c;var l=function(f){e.beginPath(),e.arc(f.x,f.y,u,0,2*Math.PI),e.fill()};this.faceLandmarks.positions.forEach(l)}},i}();function S_(i,t){var e=Jn(i,t),n=ei(i,t);function r(a,s,u){var c=n(a,s,u+"/separable_conv0"),l=n(s,s,u+"/separable_conv1"),f=e(a,s,1,u+"/expansion_conv");return{separable_conv0:c,separable_conv1:l,expansion_conv:f}}function o(a,s){var u=n(a,a,s+"/separable_conv0"),c=n(a,a,s+"/separable_conv1"),l=n(a,a,s+"/separable_conv2");return{separable_conv0:u,separable_conv1:c,separable_conv2:l}}return{extractConvParams:e,extractSeparableConvParams:n,extractReductionBlockParams:r,extractMainBlockParams:o}}function Tv(i,t){var e=[],n=ft(i),r=n.extractWeights,o=n.getRemainingWeights,a=S_(r,e),s=a.extractConvParams,u=a.extractSeparableConvParams,c=a.extractReductionBlockParams,l=a.extractMainBlockParams,f=s(3,32,3,"entry_flow/conv_in"),h=c(32,64,"entry_flow/reduction_block_0"),p=c(64,128,"entry_flow/reduction_block_1"),d={conv_in:f,reduction_block_0:h,reduction_block_1:p},m={};In(t,0,1).forEach(function(w){m["main_block_"+w]=l(128,"middle_flow/main_block_"+w)});var v=c(128,256,"exit_flow/reduction_block"),g=u(256,512,"exit_flow/separable_conv"),x={reduction_block:v,separable_conv:g};if(o().length!==0)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:e,params:{entry_flow:d,middle_flow:m,exit_flow:x}}}function A_(i,t){var e=_t(i,t),n=Ca(e),r=ti(e);function o(s){var u=r(s+"/separable_conv0"),c=r(s+"/separable_conv1"),l=n(s+"/expansion_conv");return{separable_conv0:u,separable_conv1:c,expansion_conv:l}}function a(s){var u=r(s+"/separable_conv0"),c=r(s+"/separable_conv1"),l=r(s+"/separable_conv2");return{separable_conv0:u,separable_conv1:c,separable_conv2:l}}return{extractConvParams:n,extractSeparableConvParams:r,extractReductionBlockParams:o,extractMainBlockParams:a}}function Nv(i,t){var e=[],n=A_(i,e),r=n.extractConvParams,o=n.extractSeparableConvParams,a=n.extractReductionBlockParams,s=n.extractMainBlockParams,u=r("entry_flow/conv_in"),c=a("entry_flow/reduction_block_0"),l=a("entry_flow/reduction_block_1"),f={conv_in:u,reduction_block_0:c,reduction_block_1:l},h={};In(t,0,1).forEach(function(v){h["main_block_"+v]=s("middle_flow/main_block_"+v)});var p=a("exit_flow/reduction_block"),d=o("exit_flow/separable_conv"),m={reduction_block:p,separable_conv:d};return lt(i,e),{params:{entry_flow:f,middle_flow:h,exit_flow:m},paramMappings:e}}function Pv(i,t,e){return se(ut(i,t.filters,e,"same"),t.bias)}function Qc(i,t,e){e===void 0&&(e=!0);var n=e?Re(i):i;return n=At(n,t.separable_conv0,[1,1]),n=At(Re(n),t.separable_conv1,[1,1]),n=He(n,[3,3],[2,2],"same"),n=se(n,Pv(i,t.expansion_conv,[2,2])),n}function F_(i,t){var e=At(Re(i),t.separable_conv0,[1,1]);return e=At(Re(e),t.separable_conv1,[1,1]),e=At(Re(e),t.separable_conv2,[1,1]),e=se(e,i),e}var Mv=function(i){J(t,i);function t(e){var n=i.call(this,"TinyXception")||this;return n._numMainBlocks=e,n}return t.prototype.forwardInput=function(e){var n=this,r=this.params;if(!r)throw new Error("TinyXception - load model before inference");return j(function(){var o=e.toBatchTensor(112,!0),a=[122.782,117.001,104.298],s=vn(o,a).div(Y(256)),u=Re(Pv(s,r.entry_flow.conv_in,[2,2]));return u=Qc(u,r.entry_flow.reduction_block_0,!1),u=Qc(u,r.entry_flow.reduction_block_1),In(n._numMainBlocks,0,1).forEach(function(c){u=F_(u,r.middle_flow["main_block_"+c])}),u=Qc(u,r.exit_flow.reduction_block),u=Re(At(u,r.exit_flow.separable_conv,[1,1])),u})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"tiny_xception_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Nv(e,this._numMainBlocks)},t.prototype.extractParams=function(e){return Tv(e,this._numMainBlocks)},t}(ct);function Ov(i){var t=[],e=ft(i),n=e.extractWeights,r=e.getRemainingWeights,o=Zr(n,t),a=o(512,1,"fc/age"),s=o(512,2,"fc/gender");if(r().length!==0)throw new Error("weights remaing after extract: "+r().length);return{paramMappings:t,params:{fc:{age:a,gender:s}}}}function Bv(i){var t=[],e=_t(i,t);function n(o){var a=e(o+"/weights",2),s=e(o+"/bias",1);return{weights:a,bias:s}}var r={fc:{age:n("fc/age"),gender:n("fc/gender")}};return lt(i,t),{params:r,paramMappings:t}}var Qi=function(i){return i.FEMALE="female",i.MALE="male",i}(Qi||{});var Lv=function(i){J(t,i);function t(e){e===void 0&&(e=new Mv(2));var n=i.call(this,"AgeGenderNet")||this;return n._faceFeatureExtractor=e,n}return Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,r=this.params;if(!r)throw new Error(this._name+" - load model before inference");return j(function(){var o=e instanceof yr?n.faceFeatureExtractor.forwardInput(e):e,a=Fn(o,[7,7],[2,2],"valid").as2D(o.shape[0],-1),s=Pt(a,r.fc.age).as1D(),u=Pt(a,r.fc.gender);return{age:s,gender:u}})},t.prototype.forwardInput=function(e){var n=this;return j(function(){var r=n.runNet(e),o=r.age,a=r.gender;return{age:o,gender:St(a)}})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.predictAgeAndGender=function(e){return X(this,void 0,void 0,function(){var n,r,o,a,s,u,c=this;return $(this,function(l){switch(l.label){case 0:return[4,Ne(e)];case 1:return n=l.sent(),[4,this.forwardInput(n)];case 2:return r=l.sent(),o=Te(r.age),a=Te(r.gender),s=o.map(function(f,h){return{ageTensor:f,genderTensor:a[h]}}),[4,Promise.all(s.map(function(f){var h=f.ageTensor,p=f.genderTensor;return X(c,void 0,void 0,function(){var d,m,v,g,x;return $(this,function(w){switch(w.label){case 0:return[4,h.data()];case 1:return d=w.sent()[0],[4,p.data()];case 2:return m=w.sent()[0],v=m>.5,g=v?Qi.MALE:Qi.FEMALE,x=v?m:1-m,h.dispose(),p.dispose(),[2,{age:d,gender:g,genderProbability:x}]}})})}))];case 3:return u=l.sent(),r.age.dispose(),r.gender.dispose(),[2,n.isBatchInput?u:u[0]]}})})},t.prototype.getDefaultModelName=function(){return"age_gender_model"},t.prototype.dispose=function(e){e===void 0&&(e=!0),this.faceFeatureExtractor.dispose(e),i.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),r=n.params,o=n.paramMappings;this._params=r,this._paramMappings=o},t.prototype.extractClassifierParams=function(e){return Ov(e)},t.prototype.extractParamsFromWeigthMap=function(e){var n=ka(e),r=n.featureExtractorMap,o=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(r),Bv(o)},t.prototype.extractParams=function(e){var n=1539,r=e.slice(0,e.length-n),o=e.slice(e.length-n);return this.faceFeatureExtractor.extractWeights(r),this.extractClassifierParams(o)},t}(ct);var Fa=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.postProcess=function(e,n,r){var o=r.map(function(s){var u=s.width,c=s.height,l=n/Math.max(c,u);return{width:u*l,height:c*l}}),a=o.length;return j(function(){var s=function(h,p){return mt([qt([68],h),qt([68],p)],1).as2D(1,136).as1D()},u=function(h,p){var d=o[h],m=d.width,v=d.height;return p(m,v)?Math.abs(m-v)/2:0},c=function(h){return u(h,function(p,d){return p<d})},l=function(h){return u(h,function(p,d){return d<p})},f=e.mul(qt([a,136],n)).sub(mt(Array.from(Array(a),function(h,p){return s(c(p),l(p))}))).div(mt(Array.from(Array(a),function(h,p){return s(o[p].width,o[p].height)})));return f})},t.prototype.forwardInput=function(e){var n=this;return j(function(){var r=n.runNet(e);return n.postProcess(r,e.inputSize,e.inputDimensions.map(function(o){var a=o[0],s=o[1];return{height:a,width:s}}))})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.detectLandmarks=function(e){return X(this,void 0,void 0,function(){var n,r,o,a=this;return $(this,function(s){switch(s.label){case 0:return[4,Ne(e)];case 1:return n=s.sent(),r=j(function(){return Te(a.forwardInput(n))}),[4,Promise.all(r.map(function(u,c){return X(a,void 0,void 0,function(){var l,f,h,p,d;return $(this,function(m){switch(m.label){case 0:return h=(f=Array).from,[4,u.data()];case 1:return l=h.apply(f,[m.sent()]),p=l.filter(function(v,g){return Bc(g)}),d=l.filter(function(v,g){return!Bc(g)}),[2,new ma(Array(68).fill(0).map(function(v,g){return new he(p[g],d[g])}),{height:n.getInputHeight(c),width:n.getInputWidth(c)})]}})})}))];case 2:return o=s.sent(),r.forEach(function(u){return u.dispose()}),[2,n.isBatchInput?o:o[0]]}})})},t.prototype.getClassifierChannelsOut=function(){return 136},t}(Da);var Ra=function(i){J(t,i);function t(e){return e===void 0&&(e=new Ea),i.call(this,"FaceLandmark68Net",e)||this}return t.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t}(Fa);function Wv(i){var t=[],e=_a(i,t).extractDenseBlock3Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2")};return lt(i,t),{params:n,paramMappings:t}}function zv(i){var t=[],e=ft(i),n=e.extractWeights,r=e.getRemainingWeights,o=wa(n,t).extractDenseBlock3Params,a=o(3,32,"dense0",!0),s=o(32,64,"dense1"),u=o(64,128,"dense2");if(r().length!==0)throw new Error("weights remaing after extract: "+r().length);return{paramMappings:t,params:{dense0:a,dense1:s,dense2:u}}}var qv=function(i){J(t,i);function t(){return i.call(this,"TinyFaceFeatureExtractor")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return j(function(){var r=e.toBatchTensor(112,!0),o=[122.782,117.001,104.298],a=vn(r,o).div(Y(255)),s=ba(a,n.dense0,!0);return s=ba(s,n.dense1),s=ba(s,n.dense2),s=Fn(s,[14,14],[2,2],"valid"),s})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Wv(e)},t.prototype.extractParams=function(e){return zv(e)},t}(ct);var Vv=function(i){J(t,i);function t(e){return e===void 0&&(e=new qv),i.call(this,"FaceLandmark68TinyNet",e)||this}return t.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},t.prototype.getClassifierChannelsIn=function(){return 128},t}(Fa);var JT=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t}(Ra);function Uv(i,t){return se(je(i,t.weights),t.biases)}function Zc(i,t,e,n,r){r===void 0&&(r="same");var o=t.conv,a=o.filters,s=o.bias,u=ut(i,a,e,r);return u=se(u,s),u=Uv(u,t.scale),n?Re(u):u}function jv(i,t){return Zc(i,t,[1,1],!0)}function el(i,t){return Zc(i,t,[1,1],!1)}function Ia(i,t){return Zc(i,t,[2,2],!0,"valid")}function R_(i,t){function e(s,u,c){var l=i(s),f=l.length/(u*c*c);if(mv(f))throw new Error("depth has to be an integer: "+f+", weights.length: "+l.length+", numFilters: "+u+", filterSize: "+c);return j(function(){return jt(it(l,[u,f,c,c]),[2,3,1,0])})}function n(s,u,c,l){var f=e(s,u,c),h=Be(i(u));return t.push({paramPath:l+"/filters"},{paramPath:l+"/bias"}),{filters:f,bias:h}}function r(s,u){var c=Be(i(s)),l=Be(i(s));return t.push({paramPath:u+"/weights"},{paramPath:u+"/biases"}),{weights:c,biases:l}}function o(s,u,c,l){var f=n(s,u,c,l+"/conv"),h=r(u,l+"/scale");return{conv:f,scale:h}}function a(s,u,c,l,f){f===void 0&&(f=!1);var h=o((f?.5:1)*s,u,c,l+"/conv1"),p=o(s,u,c,l+"/conv2");return{conv1:h,conv2:p}}return{extractConvLayerParams:o,extractResidualLayerParams:a}}function Gv(i){var t=ft(i),e=t.extractWeights,n=t.getRemainingWeights,r=[],o=R_(e,r),a=o.extractConvLayerParams,s=o.extractResidualLayerParams,u=a(4704,32,7,"conv32_down"),c=s(9216,32,3,"conv32_1"),l=s(9216,32,3,"conv32_2"),f=s(9216,32,3,"conv32_3"),h=s(36864,64,3,"conv64_down",!0),p=s(36864,64,3,"conv64_1"),d=s(36864,64,3,"conv64_2"),m=s(36864,64,3,"conv64_3"),v=s(147456,128,3,"conv128_down",!0),g=s(147456,128,3,"conv128_1"),x=s(147456,128,3,"conv128_2"),w=s(589824,256,3,"conv256_down",!0),y=s(589824,256,3,"conv256_1"),b=s(589824,256,3,"conv256_2"),C=s(589824,256,3,"conv256_down_out"),S=j(function(){return jt(hn(e(256*128),[128,256]),[1,0])});if(r.push({paramPath:"fc"}),n().length!==0)throw new Error("weights remaing after extract: "+n().length);var A={conv32_down:u,conv32_1:c,conv32_2:l,conv32_3:f,conv64_down:h,conv64_1:p,conv64_2:d,conv64_3:m,conv128_down:v,conv128_1:g,conv128_2:x,conv256_down:w,conv256_1:y,conv256_2:b,conv256_down_out:C,fc:S};return{params:A,paramMappings:r}}function I_(i,t){var e=_t(i,t);function n(a){var s=e(a+"/scale/weights",1),u=e(a+"/scale/biases",1);return{weights:s,biases:u}}function r(a){var s=e(a+"/conv/filters",4),u=e(a+"/conv/bias",1),c=n(a);return{conv:{filters:s,bias:u},scale:c}}function o(a){return{conv1:r(a+"/conv1"),conv2:r(a+"/conv2")}}return{extractConvLayerParams:r,extractResidualLayerParams:o}}function Hv(i){var t=[],e=I_(i,t),n=e.extractConvLayerParams,r=e.extractResidualLayerParams,o=n("conv32_down"),a=r("conv32_1"),s=r("conv32_2"),u=r("conv32_3"),c=r("conv64_down"),l=r("conv64_1"),f=r("conv64_2"),h=r("conv64_3"),p=r("conv128_down"),d=r("conv128_1"),m=r("conv128_2"),v=r("conv256_down"),g=r("conv256_1"),x=r("conv256_2"),w=r("conv256_down_out"),y=i.fc;if(t.push({originalPath:"fc",paramPath:"fc"}),!dv(y))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+y);var b={conv32_down:o,conv32_1:a,conv32_2:s,conv32_3:u,conv64_down:c,conv64_1:l,conv64_2:f,conv64_3:h,conv128_down:p,conv128_1:d,conv128_2:m,conv256_down:v,conv256_1:g,conv256_2:x,conv256_down_out:w,fc:y};return lt(i,t),{params:b,paramMappings:t}}function rn(i,t){var e=jv(i,t.conv1);return e=el(e,t.conv2),e=se(e,i),e=Re(e),e}function Zi(i,t){var e=Ia(i,t.conv1);e=el(e,t.conv2);var n=Fn(i,2,2,"valid"),r=Le(n.shape),o=n.shape[3]!==e.shape[3],a=n.shape[1]!==e.shape[1]||n.shape[2]!==e.shape[2];if(a){var s=mr(e.shape);s[1]=1;var u=Le(s);e=ze([e,u],1);var c=mr(e.shape);c[2]=1;var l=Le(c);e=ze([e,l],2)}return n=o?ze([n,r],3):n,e=se(n,e),e=Re(e),e}var tl=function(i){J(t,i);function t(){return i.call(this,"FaceRecognitionNet")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceRecognitionNet - load model before inference");return j(function(){var r=e.toBatchTensor(150,!0).toFloat(),o=[122.782,117.001,104.298],a=vn(r,o).div(Y(256)),s=Ia(a,n.conv32_down);s=He(s,3,2,"valid"),s=rn(s,n.conv32_1),s=rn(s,n.conv32_2),s=rn(s,n.conv32_3),s=Zi(s,n.conv64_down),s=rn(s,n.conv64_1),s=rn(s,n.conv64_2),s=rn(s,n.conv64_3),s=Zi(s,n.conv128_down),s=rn(s,n.conv128_1),s=rn(s,n.conv128_2),s=Zi(s,n.conv256_down),s=rn(s,n.conv256_1),s=rn(s,n.conv256_2),s=Zi(s,n.conv256_down_out);var u=s.mean([1,2]),c=Hr(u,n.fc);return c})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.computeFaceDescriptor=function(e){return X(this,void 0,void 0,function(){var n,r,o,a=this;return $(this,function(s){switch(s.label){case 0:return[4,Ne(e)];case 1:return n=s.sent(),r=j(function(){return Te(a.forwardInput(n))}),[4,Promise.all(r.map(function(u){return u.data()}))];case 2:return o=s.sent(),r.forEach(function(u){return u.dispose()}),[2,n.isBatchInput?o:o[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_recognition_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Hv(e)},t.prototype.extractParams=function(e){return Gv(e)},t}(ct);function nl(i,t){var e={descriptor:t};return Object.assign({},i,e)}function rl(i,t){var e={age:t};return Object.assign({},i,e)}function il(i,t,e){var n={gender:t,genderProbability:e};return Object.assign({},i,n)}var eo=function(){function i(t){var e=t===void 0?{}:t,n=e.minFaceSize,r=e.scaleFactor,o=e.maxNumScales,a=e.scoreThresholds,s=e.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=n||20,this._scaleFactor=r||.709,this._maxNumScales=o||10,this._scoreThresholds=a||[.6,.7,.7],this._scaleSteps=s,typeof this._minFaceSize!="number"||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if(typeof this._scaleFactor!="number"||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if(typeof this._maxNumScales!="number"||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||this._scoreThresholds.length!==3||this._scoreThresholds.some(function(u){return typeof u!="number"}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(u){return typeof u!="number"})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(i.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),i}();function T_(i,t){function e(u,c){var l=it(i(9*u),[3,3,u,1]),f=Be(i(u)),h=Be(i(u)),p=Be(i(u)),d=Be(i(u));return t.push({paramPath:c+"/filters"},{paramPath:c+"/batch_norm_scale"},{paramPath:c+"/batch_norm_offset"},{paramPath:c+"/batch_norm_mean"},{paramPath:c+"/batch_norm_variance"}),{filters:l,batch_norm_scale:f,batch_norm_offset:h,batch_norm_mean:p,batch_norm_variance:d}}function n(u,c,l,f,h){var p=it(i(u*c*l*l),[l,l,u,c]),d=Be(i(c));return t.push({paramPath:f+"/filters"},{paramPath:f+"/"+(h?"batch_norm_offset":"bias")}),{filters:p,bias:d}}function r(u,c,l,f){var h=n(u,c,l,f,!0),p=h.filters,d=h.bias;return{filters:p,batch_norm_offset:d}}function o(u,c,l){var f=e(u,l+"/depthwise_conv"),h=r(u,c,1,l+"/pointwise_conv");return{depthwise_conv:f,pointwise_conv:h}}function a(){var u=r(3,32,3,"mobilenetv1/conv_0"),c=o(32,64,"mobilenetv1/conv_1"),l=o(64,128,"mobilenetv1/conv_2"),f=o(128,128,"mobilenetv1/conv_3"),h=o(128,256,"mobilenetv1/conv_4"),p=o(256,256,"mobilenetv1/conv_5"),d=o(256,512,"mobilenetv1/conv_6"),m=o(512,512,"mobilenetv1/conv_7"),v=o(512,512,"mobilenetv1/conv_8"),g=o(512,512,"mobilenetv1/conv_9"),x=o(512,512,"mobilenetv1/conv_10"),w=o(512,512,"mobilenetv1/conv_11"),y=o(512,1024,"mobilenetv1/conv_12"),b=o(1024,1024,"mobilenetv1/conv_13");return{conv_0:u,conv_1:c,conv_2:l,conv_3:f,conv_4:h,conv_5:p,conv_6:d,conv_7:m,conv_8:v,conv_9:g,conv_10:x,conv_11:w,conv_12:y,conv_13:b}}function s(){var u=r(1024,256,1,"prediction_layer/conv_0"),c=r(256,512,3,"prediction_layer/conv_1"),l=r(512,128,1,"prediction_layer/conv_2"),f=r(128,256,3,"prediction_layer/conv_3"),h=r(256,128,1,"prediction_layer/conv_4"),p=r(128,256,3,"prediction_layer/conv_5"),d=r(256,64,1,"prediction_layer/conv_6"),m=r(64,128,3,"prediction_layer/conv_7"),v=n(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),g=n(512,9,1,"prediction_layer/box_predictor_0/class_predictor"),x=n(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),w=n(1024,18,1,"prediction_layer/box_predictor_1/class_predictor"),y=n(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),b=n(512,18,1,"prediction_layer/box_predictor_2/class_predictor"),C=n(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),S=n(256,18,1,"prediction_layer/box_predictor_3/class_predictor"),A=n(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),k=n(256,18,1,"prediction_layer/box_predictor_4/class_predictor"),D=n(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),T=n(128,18,1,"prediction_layer/box_predictor_5/class_predictor"),I={box_encoding_predictor:v,class_predictor:g},W={box_encoding_predictor:x,class_predictor:w},B={box_encoding_predictor:y,class_predictor:b},L={box_encoding_predictor:C,class_predictor:S},V={box_encoding_predictor:A,class_predictor:k},q={box_encoding_predictor:D,class_predictor:T};return{conv_0:u,conv_1:c,conv_2:l,conv_3:f,conv_4:h,conv_5:p,conv_6:d,conv_7:m,box_predictor_0:I,box_predictor_1:W,box_predictor_2:B,box_predictor_3:L,box_predictor_4:V,box_predictor_5:q}}return{extractMobilenetV1Params:a,extractPredictionLayerParams:s}}function Kv(i){var t=[],e=ft(i),n=e.extractWeights,r=e.getRemainingWeights,o=T_(n,t),a=o.extractMobilenetV1Params,s=o.extractPredictionLayerParams,u=a(),c=s(),l=ta(n(5118*4),[1,5118,4]),f={extra_dim:l};if(t.push({paramPath:"output_layer/extra_dim"}),r().length!==0)throw new Error("weights remaing after extract: "+r().length);return{params:{mobilenetv1:u,prediction_layer:c,output_layer:f},paramMappings:t}}function N_(i,t){var e=_t(i,t);function n(c,l,f){var h=e(c+"/Conv2d_"+l+"_pointwise/weights",4,f+"/filters"),p=e(c+"/Conv2d_"+l+"_pointwise/convolution_bn_offset",1,f+"/batch_norm_offset");return{filters:h,batch_norm_offset:p}}function r(c){var l="mobilenetv1/conv_"+c,f="MobilenetV1/Conv2d_"+c+"_depthwise",h=l+"/depthwise_conv",p=l+"/pointwise_conv",d=e(f+"/depthwise_weights",4,h+"/filters"),m=e(f+"/BatchNorm/gamma",1,h+"/batch_norm_scale"),v=e(f+"/BatchNorm/beta",1,h+"/batch_norm_offset"),g=e(f+"/BatchNorm/moving_mean",1,h+"/batch_norm_mean"),x=e(f+"/BatchNorm/moving_variance",1,h+"/batch_norm_variance");return{depthwise_conv:{filters:d,batch_norm_scale:m,batch_norm_offset:v,batch_norm_mean:g,batch_norm_variance:x},pointwise_conv:n("MobilenetV1",c,p)}}function o(){return{conv_0:n("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:r(1),conv_2:r(2),conv_3:r(3),conv_4:r(4),conv_5:r(5),conv_6:r(6),conv_7:r(7),conv_8:r(8),conv_9:r(9),conv_10:r(10),conv_11:r(11),conv_12:r(12),conv_13:r(13)}}function a(c,l){var f=e(c+"/weights",4,l+"/filters"),h=e(c+"/biases",1,l+"/bias");return{filters:f,bias:h}}function s(c){var l=a("Prediction/BoxPredictor_"+c+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+c+"/box_encoding_predictor"),f=a("Prediction/BoxPredictor_"+c+"/ClassPredictor","prediction_layer/box_predictor_"+c+"/class_predictor");return{box_encoding_predictor:l,class_predictor:f}}function u(){return{conv_0:n("Prediction",0,"prediction_layer/conv_0"),conv_1:n("Prediction",1,"prediction_layer/conv_1"),conv_2:n("Prediction",2,"prediction_layer/conv_2"),conv_3:n("Prediction",3,"prediction_layer/conv_3"),conv_4:n("Prediction",4,"prediction_layer/conv_4"),conv_5:n("Prediction",5,"prediction_layer/conv_5"),conv_6:n("Prediction",6,"prediction_layer/conv_6"),conv_7:n("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:s(0),box_predictor_1:s(1),box_predictor_2:s(2),box_predictor_3:s(3),box_predictor_4:s(4),box_predictor_5:s(5)}}return{extractMobilenetV1Params:o,extractPredictionLayerParams:u}}function Xv(i){var t=[],e=N_(i,t),n=e.extractMobilenetV1Params,r=e.extractPredictionLayerParams,o=i["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!$n(o))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+o);var a={mobilenetv1:n(),prediction_layer:r(),output_layer:{extra_dim:o}};return lt(i,t),{params:a,paramMappings:t}}function Ht(i,t,e){return j(function(){var n=ut(i,t.filters,e,"same");return n=se(n,t.batch_norm_offset),Bi(n,0,6)})}var P_=.0010000000474974513;function M_(i,t,e){return j(function(){var n=zi(i,t.filters,e,"same");return n=wc(n,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,P_),Bi(n,0,6)})}function O_(i){return[2,4,6,12].some(function(t){return t===i})?[2,2]:[1,1]}function $v(i,t){return j(function(){var e=null,n=Ht(i,t.conv_0,[2,2]),r=[t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13];if(r.forEach(function(o,a){var s=a+1,u=O_(s);n=M_(n,o.depthwise_conv,u),n=Ht(n,o.pointwise_conv,[1,1]),s===11&&(e=n)}),e===null)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:n,conv11:e}})}function Yv(i,t,e,n,r){var o=i.shape[0],a=Math.min(e,o),s=t.map(function(l,f){return{score:l,boxIndex:f}}).filter(function(l){return l.score>r}).sort(function(l,f){return f.score-l.score}),u=function(l){return l<=n?1:0},c=[];return s.forEach(function(l){if(!(c.length>=a)){for(var f=l.score,h=c.length-1;h>=0;--h){var p=B_(i,l.boxIndex,c[h]);if(p!==0&&(l.score*=u(p),l.score<=r))break}f===l.score&&c.push(l.boxIndex)}}),c}function B_(i,t,e){var n=i.arraySync(),r=Math.min(n[t][0],n[t][2]),o=Math.min(n[t][1],n[t][3]),a=Math.max(n[t][0],n[t][2]),s=Math.max(n[t][1],n[t][3]),u=Math.min(n[e][0],n[e][2]),c=Math.min(n[e][1],n[e][3]),l=Math.max(n[e][0],n[e][2]),f=Math.max(n[e][1],n[e][3]),h=(a-r)*(s-o),p=(l-u)*(f-c);if(h<=0||p<=0)return 0;var d=Math.max(r,u),m=Math.max(o,c),v=Math.min(a,l),g=Math.min(s,f),x=Math.max(v-d,0)*Math.max(g-m,0);return x/(h+p-x)}function L_(i){var t=Te(jt(i,[1,0])),e=[Oe(t[2],t[0]),Oe(t[3],t[1])],n=[se(t[0],Ut(e[0],Y(2))),se(t[1],Ut(e[1],Y(2)))];return{sizes:e,centers:n}}function W_(i,t){var e=L_(i),n=e.sizes,r=e.centers,o=Te(jt(t,[1,0])),a=Ut(je(aa(Ut(o[2],Y(5))),n[0]),Y(2)),s=se(je(Ut(o[0],Y(10)),n[0]),r[0]),u=Ut(je(aa(Ut(o[3],Y(5))),n[1]),Y(2)),c=se(je(Ut(o[1],Y(10)),n[1]),r[1]);return jt(mt([Oe(s,a),Oe(c,u),se(s,a),se(c,u)]),[1,0])}function Jv(i,t,e){return j(function(){var n=i.shape[0],r=W_(Dt(ar(e.extra_dim,[n,1,1]),[-1,4]),Dt(i,[-1,4]));r=Dt(r,[n,r.shape[0]/n,4]);var o=bc(Jt(t,[0,0,1],[-1,-1,-1])),a=Jt(o,[0,0,0],[-1,-1,1]);a=Dt(a,[n,a.shape[1]]);var s=Te(r),u=Te(a);return{boxes:s,scores:u}})}function xr(i,t){return j(function(){var e=i.shape[0],n=Dt(Ct(i,t.box_encoding_predictor),[e,-1,1,4]),r=Dt(Ct(i,t.class_predictor),[e,-1,3]);return{boxPredictionEncoding:n,classPrediction:r}})}function Qv(i,t,e){return j(function(){var n=Ht(i,e.conv_0,[1,1]),r=Ht(n,e.conv_1,[2,2]),o=Ht(r,e.conv_2,[1,1]),a=Ht(o,e.conv_3,[2,2]),s=Ht(a,e.conv_4,[1,1]),u=Ht(s,e.conv_5,[2,2]),c=Ht(u,e.conv_6,[1,1]),l=Ht(c,e.conv_7,[2,2]),f=xr(t,e.box_predictor_0),h=xr(i,e.box_predictor_1),p=xr(r,e.box_predictor_2),d=xr(a,e.box_predictor_3),m=xr(u,e.box_predictor_4),v=xr(l,e.box_predictor_5),g=ze([f.boxPredictionEncoding,h.boxPredictionEncoding,p.boxPredictionEncoding,d.boxPredictionEncoding,m.boxPredictionEncoding,v.boxPredictionEncoding],1),x=ze([f.classPrediction,h.classPrediction,p.classPrediction,d.classPrediction,m.classPrediction,v.classPrediction],1);return{boxPredictions:g,classPredictions:x}})}var Pn=function(){function i(t){var e=t===void 0?{}:t,n=e.minConfidence,r=e.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=n||.5,this._maxResults=r||100,typeof this._minConfidence!="number"||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if(typeof this._maxResults!="number")throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(i.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),i}();var Ta=function(i){J(t,i);function t(){return i.call(this,"SsdMobilenetv1")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("SsdMobilenetv1 - load model before inference");return j(function(){var r=e.toBatchTensor(512,!1).toFloat(),o=Oe(je(r,Y(.007843137718737125)),Y(1)),a=$v(o,n.mobilenetv1),s=Qv(a.out,a.conv11,n.prediction_layer),u=s.boxPredictions,c=s.classPredictions;return Jv(u,c,n.output_layer)})},t.prototype.forward=function(e){return X(this,void 0,void 0,function(){var n;return $(this,function(r){switch(r.label){case 0:return n=this.forwardInput,[4,Ne(e)];case 1:return[2,n.apply(this,[r.sent()])]}})})},t.prototype.locateFaces=function(e,n){return n===void 0&&(n={}),X(this,void 0,void 0,function(){var r,o,a,s,u,c,l,f,h,p,d,m,v,g,x,w,y,b,C,S,A;return $(this,function(k){switch(k.label){case 0:return r=new Pn(n),o=r.maxResults,a=r.minConfidence,[4,Ne(e)];case 1:for(s=k.sent(),u=this.forwardInput(s),c=u.boxes,l=u.scores,f=c[0],h=l[0],p=1;p<c.length;p++)c[p].dispose(),l[p].dispose();return v=(m=Array).from,[4,h.data()];case 2:return d=v.apply(m,[k.sent()]),g=.5,x=Yv(f,d,o,g,a),w=s.getReshapedInputDimensions(0),y=s.inputSize,b=y/w.width,C=y/w.height,S=f.arraySync(),A=x.map(function(D){var T=[Math.max(0,S[D][0]),Math.min(1,S[D][2])].map(function(q){return q*C}),I=T[0],W=T[1],B=[Math.max(0,S[D][1]),Math.min(1,S[D][3])].map(function(q){return q*b}),L=B[0],V=B[1];return new Ye(d[D],new $r(L,I,V-L,W-I),{height:s.getInputHeight(0),width:s.getInputWidth(0)})}),f.dispose(),h.dispose(),[2,A]}})})},t.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Xv(e)},t.prototype.extractParams=function(e){return Kv(e)},t}(ct);var mN=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t}(Ta);var Zv=.4,e0=[new he(.738768,.874946),new he(2.42204,2.65704),new he(4.30971,7.04493),new he(10.246,4.59428),new he(12.6868,11.8741)],t0=[new he(1.603231,2.094468),new he(6.041143,7.080126),new he(2.882459,3.518061),new he(4.266906,5.178857),new he(9.041765,10.66308)],n0=[117.001,114.697,97.404],r0="tiny_yolov2_model",i0="tiny_yolov2_separable_conv_model";var Na=function(i){return typeof i=="number"};function o0(i){if(!i)throw new Error("invalid config: "+i);if(typeof i.withSeparableConvs!="boolean")throw new Error("config.withSeparableConvs has to be a boolean, have: "+i.withSeparableConvs);if(!Na(i.iouThreshold)||i.iouThreshold<0||i.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+i.iouThreshold);if(!Array.isArray(i.classes)||!i.classes.length||!i.classes.every(function(t){return typeof t=="string"}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(i.classes));if(!Array.isArray(i.anchors)||!i.anchors.length||!i.anchors.map(function(t){return t||{}}).every(function(t){return Na(t.x)&&Na(t.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(i.anchors));if(i.meanRgb&&(!Array.isArray(i.meanRgb)||i.meanRgb.length!==3||!i.meanRgb.every(Na)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(i.meanRgb))}function ri(i){return j(function(){var t=je(i,Y(.10000000149011612));return se(Re(Oe(i,t)),t)})}function Mn(i,t){return j(function(){var e=An(i,[[0,0],[1,1],[1,1],[0,0]]);return e=ut(e,t.conv.filters,[1,1],"valid"),e=Oe(e,t.bn.sub),e=je(e,t.bn.truediv),e=se(e,t.conv.bias),ri(e)})}function On(i,t){return j(function(){var e=An(i,[[0,0],[1,1],[1,1],[0,0]]);return e=qi(e,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),e=se(e,t.bias),ri(e)})}function z_(i,t){var e=Jn(i,t);function n(a,s){var u=Be(i(a)),c=Be(i(a));return t.push({paramPath:s+"/sub"},{paramPath:s+"/truediv"}),{sub:u,truediv:c}}function r(a,s,u){var c=e(a,s,3,u+"/conv"),l=n(s,u+"/bn");return{conv:c,bn:l}}var o=ei(i,t);return{extractConvParams:e,extractConvWithBatchNormParams:r,extractSeparableConvParams:o}}function a0(i,t,e,n){var r=ft(i),o=r.extractWeights,a=r.getRemainingWeights,s=[],u=z_(o,s),c=u.extractConvParams,l=u.extractConvWithBatchNormParams,f=u.extractSeparableConvParams,h;if(t.withSeparableConvs){var p=n[0],d=n[1],m=n[2],v=n[3],g=n[4],x=n[5],w=n[6],y=n[7],b=n[8],C=t.isFirstLayerConv2d?c(p,d,3,"conv0"):f(p,d,"conv0"),S=f(d,m,"conv1"),A=f(m,v,"conv2"),k=f(v,g,"conv3"),D=f(g,x,"conv4"),T=f(x,w,"conv5"),I=y?f(w,y,"conv6"):void 0,W=b?f(y,b,"conv7"):void 0,B=c(b||y||w,5*e,1,"conv8");h={conv0:C,conv1:S,conv2:A,conv3:k,conv4:D,conv5:T,conv6:I,conv7:W,conv8:B}}else{var p=n[0],d=n[1],m=n[2],v=n[3],g=n[4],x=n[5],w=n[6],y=n[7],b=n[8],C=l(p,d,"conv0"),S=l(d,m,"conv1"),A=l(m,v,"conv2"),k=l(v,g,"conv3"),D=l(g,x,"conv4"),T=l(x,w,"conv5"),I=l(w,y,"conv6"),W=l(y,b,"conv7"),B=c(b,5*e,1,"conv8");h={conv0:C,conv1:S,conv2:A,conv3:k,conv4:D,conv5:T,conv6:I,conv7:W,conv8:B}}if(a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{params:h,paramMappings:s}}function q_(i,t){var e=_t(i,t);function n(s){var u=e(s+"/sub",1),c=e(s+"/truediv",1);return{sub:u,truediv:c}}function r(s){var u=e(s+"/filters",4),c=e(s+"/bias",1);return{filters:u,bias:c}}function o(s){var u=r(s+"/conv"),c=n(s+"/bn");return{conv:u,bn:c}}var a=ti(e);return{extractConvParams:r,extractConvWithBatchNormParams:o,extractSeparableConvParams:a}}function s0(i,t){var e=[],n=q_(i,e),r=n.extractConvParams,o=n.extractConvWithBatchNormParams,a=n.extractSeparableConvParams,s;if(t.withSeparableConvs){var u=t.filterSizes&&t.filterSizes.length||9;s={conv0:t.isFirstLayerConv2d?r("conv0"):a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:u>7?a("conv6"):void 0,conv7:u>8?a("conv7"):void 0,conv8:r("conv8")}}else s={conv0:o("conv0"),conv1:o("conv1"),conv2:o("conv2"),conv3:o("conv3"),conv4:o("conv4"),conv5:o("conv5"),conv6:o("conv6"),conv7:o("conv7"),conv8:r("conv8")};return lt(i,e),{params:s,paramMappings:e}}var br=function(){function i(t){var e=t===void 0?{}:t,n=e.inputSize,r=e.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=n||416,this._scoreThreshold=r||.5,typeof this._inputSize!="number"||this._inputSize%32!==0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if(typeof this._scoreThreshold!="number"||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(i.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),i}();var Pa=function(i){J(t,i);function t(e){var n=i.call(this,"TinyYolov2")||this;return o0(e),n._config=e,n}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),t.prototype.runTinyYolov2=function(e,n){var r=Mn(e,n.conv0);return r=He(r,[2,2],[2,2],"same"),r=Mn(r,n.conv1),r=He(r,[2,2],[2,2],"same"),r=Mn(r,n.conv2),r=He(r,[2,2],[2,2],"same"),r=Mn(r,n.conv3),r=He(r,[2,2],[2,2],"same"),r=Mn(r,n.conv4),r=He(r,[2,2],[2,2],"same"),r=Mn(r,n.conv5),r=He(r,[2,2],[1,1],"same"),r=Mn(r,n.conv6),r=Mn(r,n.conv7),Ct(r,n.conv8,"valid",!1)},t.prototype.runMobilenet=function(e,n){var r=this.config.isFirstLayerConv2d?ri(Ct(e,n.conv0,"valid",!1)):On(e,n.conv0);return r=He(r,[2,2],[2,2],"same"),r=On(r,n.conv1),r=He(r,[2,2],[2,2],"same"),r=On(r,n.conv2),r=He(r,[2,2],[2,2],"same"),r=On(r,n.conv3),r=He(r,[2,2],[2,2],"same"),r=On(r,n.conv4),r=He(r,[2,2],[2,2],"same"),r=On(r,n.conv5),r=He(r,[2,2],[1,1],"same"),r=n.conv6?On(r,n.conv6):r,r=n.conv7?On(r,n.conv7):r,Ct(r,n.conv8,"valid",!1)},t.prototype.forwardInput=function(e,n){var r=this,o=this.params;if(!o)throw new Error("TinyYolov2 - load model before inference");return j(function(){var a=e.toBatchTensor(n,!1).toFloat();return a=r.config.meanRgb?vn(a,r.config.meanRgb):a,a=a.div(Y(256)),r.config.withSeparableConvs?r.runMobilenet(a,o):r.runTinyYolov2(a,o)})},t.prototype.forward=function(e,n){return X(this,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return r=this.forwardInput,[4,Ne(e)];case 1:return[4,r.apply(this,[o.sent(),n])];case 2:return[2,o.sent()]}})})},t.prototype.detect=function(e,n){return n===void 0&&(n={}),X(this,void 0,void 0,function(){var r,o,a,s,u,c,l,f,h,p,d,m,v,g,x=this;return $(this,function(w){switch(w.label){case 0:return r=new br(n),o=r.inputSize,a=r.scoreThreshold,[4,Ne(e)];case 1:return s=w.sent(),[4,this.forwardInput(s,o)];case 2:return u=w.sent(),c=j(function(){return Te(u)[0].expandDims()}),l={width:s.getInputWidth(0),height:s.getInputHeight(0)},[4,this.extractBoxes(c,s.getReshapedInputDimensions(0),a)];case 3:return f=w.sent(),u.dispose(),c.dispose(),h=f.map(function(y){return y.box}),p=f.map(function(y){return y.score}),d=f.map(function(y){return y.classScore}),m=f.map(function(y){return x.config.classes[y.label]}),v=Tn(h.map(function(y){return y.rescale(o)}),p,this.config.iouThreshold,!0),g=v.map(function(y){return new pa(p[y],d[y],m[y],h[y],l)}),[2,g]}})})},t.prototype.getDefaultModelName=function(){return""},t.prototype.extractParamsFromWeigthMap=function(e){return s0(e,this.config)},t.prototype.extractParams=function(e){var n=this.config.filterSizes||t.DEFAULT_FILTER_SIZES,r=n?n.length:void 0;if(r!==7&&r!==8&&r!==9)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+r+" filterSizes in config");return a0(e,this.config,this.boxEncodingSize,n)},t.prototype.extractBoxes=function(e,n,r){return X(this,void 0,void 0,function(){var o,a,s,u,c,l,f,h,p,d,m,v,g,x,w,y,b,C,S,A,k,D,T,I,W,B,L,V,q,z=this;return $(this,function(G){switch(G.label){case 0:return o=n.width,a=n.height,s=Math.max(o,a),u=s/o,c=s/a,l=e.shape[1],f=this.config.anchors.length,h=j(function(){var H=e.reshape([l,l,f,z.boxEncodingSize]),Z=H.slice([0,0,0,0],[l,l,f,4]),ie=H.slice([0,0,0,4],[l,l,f,1]),ae=z.withClassScores?St(H.slice([0,0,0,5],[l,l,f,z.config.classes.length]),3):Y(0);return[Z,ie,ae]}),p=h[0],d=h[1],m=h[2],v=[],[4,d.array()];case 1:return g=G.sent(),[4,p.array()];case 2:x=G.sent(),w=0,G.label=3;case 3:if(!(w<l))return[3,12];y=0,G.label=4;case 4:if(!(y<l))return[3,11];b=0,G.label=5;case 5:return b<f?(C=da(g[w][y][b][0]),!r||C>r?(S=(y+da(x[w][y][b][0]))/l*u,A=(w+da(x[w][y][b][1]))/l*c,k=Math.exp(x[w][y][b][2])*this.config.anchors[b].x/l*u,D=Math.exp(x[w][y][b][3])*this.config.anchors[b].y/l*c,T=S-k/2,I=A-D/2,W={row:w,col:y,anchor:b},this.withClassScores?[4,this.extractPredictedClass(m,W)]:[3,7]):[3,9]):[3,10];case 6:return q=G.sent(),[3,8];case 7:q={classScore:1,label:0},G.label=8;case 8:B=q,L=B.classScore,V=B.label,v.push(et({box:new vr(T,I,T+k,I+D),score:C,classScore:C*L,label:V},W)),G.label=9;case 9:return b++,[3,5];case 10:return y++,[3,4];case 11:return w++,[3,3];case 12:return p.dispose(),d.dispose(),m.dispose(),[2,v]}})})},t.prototype.extractPredictedClass=function(e,n){return X(this,void 0,void 0,function(){var r,o,a,s;return $(this,function(u){switch(u.label){case 0:return r=n.row,o=n.col,a=n.anchor,[4,e.array()];case 1:return s=u.sent(),[2,Array(this.config.classes.length).fill(0).map(function(c,l){return s[r][o][a][l]}).map(function(c,l){return{classScore:c,label:l}}).reduce(function(c,l){return c.classScore>l.classScore?c:l})]}})})},t.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],t}(ct);var ol=function(i){J(t,i);function t(e){e===void 0&&(e=!0);var n=this,r=Object.assign({},{withSeparableConvs:e,iouThreshold:Zv,classes:["face"]},e?{anchors:t0,meanRgb:n0}:{anchors:e0,withClassScores:!0});return n=i.call(this,r)||this,n}return Object.defineProperty(t.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return X(this,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return[4,this.detect(e,n)];case 1:return r=o.sent(),[2,r.map(function(a){return new Ye(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return this.withSeparableConvs?i0:r0},t.prototype.extractParamsFromWeigthMap=function(e){return i.prototype.extractParamsFromWeigthMap.call(this,e)},t}(Pa);var to=function(i){J(t,i);function t(){var e=i!==null&&i.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}return t}(br);var gn=function(){function i(){}return i.prototype.then=function(t){return X(this,void 0,void 0,function(){var e;return $(this,function(n){switch(n.label){case 0:return e=t,[4,this.run()];case 1:return[2,e.apply(void 0,[n.sent()])]}})})},i.prototype.run=function(){return X(this,void 0,void 0,function(){return $(this,function(t){throw new Error("ComposableTask - run is not implemented")})})},i}();function wr(i,t,e,n,r){return r===void 0&&(r=function(o){var a=o.alignedRect;return a}),X(this,void 0,void 0,function(){var o,a,s,u,c;return $(this,function(l){switch(l.label){case 0:return o=i.map(function(f){return Aa(f)?r(f):f.detection}),s=n,s?[3,5]:t instanceof Me?[4,Yi(t,o)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,$i(t,o)];case 3:u=l.sent(),l.label=4;case 4:s=u,l.label=5;case 5:return a=s,[4,e(a)];case 6:return c=l.sent(),a.forEach(function(f){return f instanceof Me&&f.dispose()}),[2,c]}})})}function ii(i,t,e,n,r){return X(this,void 0,void 0,function(){var o=this;return $(this,function(a){return[2,wr([i],t,function(s){return X(o,void 0,void 0,function(){return $(this,function(u){return[2,e(s[0])]})})},n,r)]})})}function u0(i){return j(function(){return mt(Te(i,3).reverse(),3)})}var no=2,Cr=12;function V_(i,t){var e=Jn(i,t),n=Zr(i,t);function r(c,l){var f=Be(i(c));return t.push({paramPath:l}),f}function o(c,l,f){f===void 0&&(f=!1);var h=e(c[0],c[1],3,l+"/conv1"),p=r(c[1],l+"/prelu1_alpha"),d=e(c[1],c[2],3,l+"/conv2"),m=r(c[2],l+"/prelu2_alpha"),v=e(c[2],c[3],f?2:3,l+"/conv3"),g=r(c[3],l+"/prelu3_alpha");return{conv1:h,prelu1_alpha:p,conv2:d,prelu2_alpha:m,conv3:v,prelu3_alpha:g}}function a(){var c=o([3,10,16,32],"pnet"),l=e(32,2,1,"pnet/conv4_1"),f=e(32,4,1,"pnet/conv4_2");return et(et({},c),{conv4_1:l,conv4_2:f})}function s(){var c=o([3,28,48,64],"rnet",!0),l=n(576,128,"rnet/fc1"),f=r(128,"rnet/prelu4_alpha"),h=n(128,2,"rnet/fc2_1"),p=n(128,4,"rnet/fc2_2");return et(et({},c),{fc1:l,prelu4_alpha:f,fc2_1:h,fc2_2:p})}function u(){var c=o([3,32,64,64],"onet"),l=e(64,128,2,"onet/conv4"),f=r(128,"onet/prelu4_alpha"),h=n(1152,256,"onet/fc1"),p=r(256,"onet/prelu5_alpha"),d=n(256,2,"onet/fc2_1"),m=n(256,4,"onet/fc2_2"),v=n(256,10,"onet/fc2_3");return et(et({},c),{conv4:l,prelu4_alpha:f,fc1:h,prelu5_alpha:p,fc2_1:d,fc2_2:m,fc2_3:v})}return{extractPNetParams:a,extractRNetParams:s,extractONetParams:u}}function c0(i){var t=ft(i),e=t.extractWeights,n=t.getRemainingWeights,r=[],o=V_(e,r),a=o.extractPNetParams,s=o.extractRNetParams,u=o.extractONetParams,c=a(),l=s(),f=u();if(n().length!==0)throw new Error("weights remaing after extract: "+n().length);return{params:{pnet:c,rnet:l,onet:f},paramMappings:r}}function U_(i,t){var e=_t(i,t);function n(l){var f=e(l+"/weights",4,l+"/filters"),h=e(l+"/bias",1);return{filters:f,bias:h}}function r(l){var f=e(l+"/weights",2),h=e(l+"/bias",1);return{weights:f,bias:h}}function o(l){return e(l,1)}function a(l){var f=n(l+"/conv1"),h=o(l+"/prelu1_alpha"),p=n(l+"/conv2"),d=o(l+"/prelu2_alpha"),m=n(l+"/conv3"),v=o(l+"/prelu3_alpha");return{conv1:f,prelu1_alpha:h,conv2:p,prelu2_alpha:d,conv3:m,prelu3_alpha:v}}function s(){var l=a("pnet"),f=n("pnet/conv4_1"),h=n("pnet/conv4_2");return et(et({},l),{conv4_1:f,conv4_2:h})}function u(){var l=a("rnet"),f=r("rnet/fc1"),h=o("rnet/prelu4_alpha"),p=r("rnet/fc2_1"),d=r("rnet/fc2_2");return et(et({},l),{fc1:f,prelu4_alpha:h,fc2_1:p,fc2_2:d})}function c(){var l=a("onet"),f=n("onet/conv4"),h=o("onet/prelu4_alpha"),p=r("onet/fc1"),d=o("onet/prelu5_alpha"),m=r("onet/fc2_1"),v=r("onet/fc2_2"),g=r("onet/fc2_3");return et(et({},l),{conv4:f,prelu4_alpha:h,fc1:p,prelu5_alpha:d,fc2_1:m,fc2_2:v,fc2_3:g})}return{extractPNetParams:s,extractRNetParams:u,extractONetParams:c}}function l0(i){var t=[],e=U_(i,t),n=e.extractPNetParams,r=e.extractRNetParams,o=e.extractONetParams,a=n(),s=r(),u=o();return lt(i,t),{params:{pnet:a,rnet:s,onet:u},paramMappings:t}}function ro(i,t){var e=t[0],n=t[1];return{height:Math.floor(e*i),width:Math.floor(n*i)}}function f0(i,t,e){for(var n=e[0],r=e[1],o=Cr/i,a=[],s=Math.min(n,r)*o,u=0;s>=12;)a.push(o*Math.pow(t,u)),s=s*t,u+=1;return a}var oi=function(i){J(t,i);function t(e,n,r,o){return i.call(this,{left:e,top:n,right:r,bottom:o},!0)||this}return t}(vt);function Ma(i){return j(function(){return je(Oe(i,Y(127.5)),Y(.0078125))})}function Bn(i,t){return j(function(){return se(Re(i),je(t,Li(Re(Li(i)))))})}function ai(i,t,e){return e===void 0&&(e=!1),j(function(){var n=Ct(i,t.conv1,"valid");return n=Bn(n,t.prelu1_alpha),n=He(n,e?[2,2]:[3,3],[2,2],"same"),n=Ct(n,t.conv2,"valid"),n=Bn(n,t.prelu2_alpha),n=e?n:He(n,[3,3],[2,2],"valid"),n=Ct(n,t.conv3,"valid"),n=Bn(n,t.prelu3_alpha),n})}function h0(i,t){return j(function(){var e=ai(i,t,!0),n=Ct(e,t.conv4_1,"valid"),r=xt(pr(n,3),3),o=St(Oe(n,r),3),a=Ct(e,t.conv4_2,"valid");return{prob:o,regions:a}})}function j_(i,t){return j(function(){var e=ro(t,i.shape.slice(1)),n=e.height,r=e.width,o=Ui.resizeBilinear(i,[n,r]),a=Ma(o);return jt(a,[0,2,1,3])})}function G_(i,t,e,n){for(var r=[],o=i.arraySync(),a=0;a<i.shape[0];a++)for(var s=0;s<i.shape[1];s++)o[a][s]>=n&&r.push(new he(s,a));var u=r.map(function(c){var l=new vr(Math.round((c.y*no+1)/e),Math.round((c.x*no+1)/e),Math.round((c.y*no+Cr)/e),Math.round((c.x*no+Cr)/e)),f=o[c.y][c.x],h=t.arraySync(),p=new oi(h[c.y][c.x][0],h[c.y][c.x][1],h[c.y][c.x][2],h[c.y][c.x][3]);return{cell:l,score:f,region:p}});return u}function p0(i,t,e,n,r){r.stage1=[];var o=t.map(function(h){return j(function(){var p={scale:h},d=j_(i,h),m=Date.now(),v=h0(d,n),g=v.prob,x=v.regions;p.pnet=Date.now()-m;var w=Te(Te(g,3)[1])[0],y=Te(x)[0];return{scoresTensor:w,regionsTensor:y,scale:h,statsForScale:p}})}),a=o.map(function(h){var p=h.scoresTensor,d=h.regionsTensor,m=h.scale,v=h.statsForScale,g=G_(p,d,m,e);if(p.dispose(),d.dispose(),!g.length)return r.stage1.push(v),[];var x=Date.now(),w=Tn(g.map(function(y){return y.cell}),g.map(function(y){return y.score}),.5);return v.nms=Date.now()-x,v.numBoxes=w.length,r.stage1.push(v),w.map(function(y){return g[y]})}),s=a.reduce(function(h,p){return h.concat(p)},[]),u=[],c=[];if(s.length>0){var l=Date.now(),f=Tn(s.map(function(h){return h.cell}),s.map(function(h){return h.score}),.7);r.stage1_nms=Date.now()-l,c=f.map(function(h){return s[h].score}),u=f.map(function(h){return s[h]}).map(function(h){var p=h.cell,d=h.region;return new vr(p.left+d.left*p.width,p.top+d.top*p.height,p.right+d.right*p.width,p.bottom+d.bottom*p.height).toSquare().round()})}return{boxes:u,scores:c}}function Oa(i,t,e){var n=e.width,r=e.height;return X(this,void 0,void 0,function(){var o,a,s,u=this;return $(this,function(c){switch(c.label){case 0:return o=gt(i),[4,Promise.all(t.map(function(l){return X(u,void 0,void 0,function(){var f,h,p,d,m,v,g,x;return $(this,function(w){return f=l.padAtBorders(i.height,i.width),h=f.y,p=f.ey,d=f.x,m=f.ex,v=d-1,g=h-1,x=o.getImageData(v,g,m-v,p-g),[2,Fe.isNodejs()?Qr(x):createImageBitmap(x)]})})}))];case 1:return a=c.sent(),s=[],a.forEach(function(l){var f=gr({width:n,height:r}),h=gt(f);h.drawImage(l,0,0,n,r);for(var p=h.getImageData(0,0,n,r).data,d=[],m=0;m<p.length;m+=4)d.push(p[m+2]),d.push(p[m+1]),d.push(p[m]);s.push(d)}),[2,s.map(function(l){var f=j(function(){var h=jt(it(l,[1,n,r,3]),[0,2,1,3]).toFloat();return Ma(h)});return f})]}})})}function d0(i,t){return j(function(){var e=ai(i,t),n=Dt(e,[e.shape[0],t.fc1.weights.shape[0]]),r=Pt(n,t.fc1),o=Bn(r,t.prelu4_alpha),a=Pt(o,t.fc2_1),s=xt(pr(a,1),1),u=St(Oe(a,s),1),c=Pt(o,t.fc2_2),l=Te(u,1)[1];return{scores:l,regions:c}})}function m0(i,t,e,n,r){return X(this,void 0,void 0,function(){var o,a,s,u,c,l,f,h,p,d,m,v,g,x;return $(this,function(w){switch(w.label){case 0:return o=Date.now(),[4,Oa(i,t,{width:24,height:24})];case 1:return a=w.sent(),r.stage2_extractImagePatches=Date.now()-o,o=Date.now(),s=a.map(function(y){var b=d0(y,n);return y.dispose(),b}),r.stage2_rnet=Date.now()-o,u=s.length>1?ze(s.map(function(y){return y.scores})):s[0].scores,f=(l=Array).from,[4,u.data()];case 2:return c=f.apply(l,[w.sent()]),u.dispose(),h=c.map(function(y,b){return{score:y,idx:b}}).filter(function(y){return y.score>e}).map(function(y){var b=y.idx;return b}),p=h.map(function(y){return t[y]}),d=h.map(function(y){return c[y]}),m=[],v=[],p.length>0&&(o=Date.now(),g=Tn(p,d,.7),r.stage2_nms=Date.now()-o,x=g.map(function(y){var b=s[h[y]].regions.arraySync();return new oi(b[0][0],b[0][1],b[0][2],b[0][3])}),v=g.map(function(y){return d[y]}),m=g.map(function(y,b){return p[y].calibrate(x[b])})),s.forEach(function(y){y.regions.dispose(),y.scores.dispose()}),[2,{boxes:m,scores:v}]}})})}function v0(i,t){return j(function(){var e=ai(i,t);e=He(e,[2,2],[2,2],"same"),e=Ct(e,t.conv4,"valid"),e=Bn(e,t.prelu4_alpha);var n=Dt(e,[e.shape[0],t.fc1.weights.shape[0]]),r=Pt(n,t.fc1),o=Bn(r,t.prelu5_alpha),a=Pt(o,t.fc2_1),s=xt(pr(a,1),1),u=St(Oe(a,s),1),c=Pt(o,t.fc2_2),l=Pt(o,t.fc2_3),f=Te(u,1)[1];return{scores:f,regions:c,points:l}})}function g0(i,t,e,n,r){return X(this,void 0,void 0,function(){var o,a,s,u,c,l,f,h,p,d,m,v,g,x,w;return $(this,function(y){switch(y.label){case 0:return o=Date.now(),[4,Oa(i,t,{width:48,height:48})];case 1:return a=y.sent(),r.stage3_extractImagePatches=Date.now()-o,o=Date.now(),s=a.map(function(b){var C=v0(b,n);return b.dispose(),C}),r.stage3_onet=Date.now()-o,u=s.length>1?ze(s.map(function(b){return b.scores})):s[0].scores,f=(l=Array).from,[4,u.data()];case 2:return c=f.apply(l,[y.sent()]),u.dispose(),h=c.map(function(b,C){return{score:b,idx:C}}).filter(function(b){return b.score>e}).map(function(b){var C=b.idx;return C}),p=h.map(function(b){var C=s[b].regions.arraySync();return new oi(C[0][0],C[0][1],C[0][2],C[0][3])}),d=h.map(function(b,C){return t[b].calibrate(p[C])}),m=h.map(function(b){return c[b]}),v=[],g=[],x=[],d.length>0&&(o=Date.now(),w=Tn(d,m,.7,!1),r.stage3_nms=Date.now()-o,v=w.map(function(b){return d[b]}),g=w.map(function(b){return m[b]}),x=w.map(function(b,C){return Array(5).fill(0).map(function(S,A){var k=s[b].points.arraySync();return new he(k[0][A]*(v[C].width+1)+v[C].left,k[0][A+5]*(v[C].height+1)+v[C].top)})})),s.forEach(function(b){b.regions.dispose(),b.scores.dispose(),b.points.dispose()}),[2,{boxes:v,scores:g,points:x}]}})})}var al=function(i){J(t,i);function t(){return i.call(this,"Mtcnn")||this}return t.prototype.load=function(e){return X(this,void 0,void 0,function(){return $(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,i.prototype.load.call(this,e)]})})},t.prototype.loadFromDisk=function(e){return X(this,void 0,void 0,function(){return $(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,i.prototype.loadFromDisk.call(this,e)]})})},t.prototype.forwardInput=function(e,n){return n===void 0&&(n={}),X(this,void 0,void 0,function(){var r,o,a,s,u,c,l,f,h,p,d,m,v,g,x,w,y,b,C,S,A;return $(this,function(k){switch(k.label){case 0:if(r=this.params,!r)throw new Error("Mtcnn - load model before inference");if(o=e.canvases[0],!o)throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return a={},s=Date.now(),u=j(function(){return u0(xt(Kr.fromPixels(o)).toFloat())}),c=function(D){return u.dispose(),a.total=Date.now()-s,D},l=u.shape.slice(1),f=l[0],h=l[1],p=new eo(n),d=p.minFaceSize,m=p.scaleFactor,v=p.maxNumScales,g=p.scoreThresholds,x=p.scaleSteps,w=(x||f0(d,m,[f,h])).filter(function(D){var T=ro(D,[f,h]);return Math.min(T.width,T.height)>Cr}).slice(0,v),a.scales=w,a.pyramid=w.map(function(D){return ro(D,[f,h])}),y=Date.now(),[4,p0(u,w,g[0],r.pnet,a)];case 1:return b=k.sent(),a.total_stage1=Date.now()-y,b.boxes.length?(a.stage2_numInputBoxes=b.boxes.length,y=Date.now(),[4,m0(o,b.boxes,g[1],r.rnet,a)]):[2,c({results:[],stats:a})];case 2:return C=k.sent(),a.total_stage2=Date.now()-y,C.boxes.length?(a.stage3_numInputBoxes=C.boxes.length,y=Date.now(),[4,g0(o,C.boxes,g[2],r.onet,a)]):[2,c({results:[],stats:a})];case 3:return S=k.sent(),a.total_stage3=Date.now()-y,A=S.boxes.map(function(D,T){return ni(Yr({},new Ye(S.scores[T],new $r(D.left/h,D.top/f,D.width/h,D.height/f),{height:f,width:h})),new bv(S.points[T].map(function(I){return I.sub(new he(D.left,D.top)).div(new he(D.width,D.height))}),{width:D.width,height:D.height}))}),[2,c({results:A,stats:a})]}})})},t.prototype.forward=function(e,n){return n===void 0&&(n={}),X(this,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return r=this.forwardInput,[4,Ne(e)];case 1:return[4,r.apply(this,[o.sent(),n])];case 2:return[2,o.sent().results]}})})},t.prototype.forwardWithStats=function(e,n){return n===void 0&&(n={}),X(this,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return r=this.forwardInput,[4,Ne(e)];case 1:return[2,r.apply(this,[o.sent(),n])]}})})},t.prototype.getDefaultModelName=function(){return"mtcnn_model"},t.prototype.extractParamsFromWeigthMap=function(e){return l0(e)},t.prototype.extractParams=function(e){return c0(e)},t}(ct);var y0=.4,x0=[new he(1.603231,2.094468),new he(6.041143,7.080126),new he(2.882459,3.518061),new he(4.266906,5.178857),new he(9.041765,10.66308)],b0=[117.001,114.697,97.404];var sl=function(i){J(t,i);function t(){var e=this,n={withSeparableConvs:!0,iouThreshold:y0,classes:["face"],anchors:x0,meanRgb:b0,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};return e=i.call(this,n)||this,e}return Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return X(this,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return[4,this.detect(e,n)];case 1:return r=o.sent(),[2,r.map(function(a){return new Ye(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},t.prototype.extractParamsFromWeigthMap=function(e){return i.prototype.extractParamsFromWeigthMap.call(this,e)},t}(Pa);var tt={ssdMobilenetv1:new Ta,tinyFaceDetector:new sl,tinyYolov2:new ol,mtcnn:new al,faceLandmark68Net:new Ra,faceLandmark68TinyNet:new Vv,faceRecognitionNet:new tl,faceExpressionNet:new Iv,ageGenderNet:new Lv};var w0=function(i){J(t,i);function t(e,n,r){var o=i.call(this)||this;return o.parentTask=e,o.input=n,o.extractedFaces=r,o}return t}(gn);var io=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r=this;return $(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return e=o.sent(),[4,wr(e,this.input,function(a){return X(r,void 0,void 0,function(){return $(this,function(s){switch(s.label){case 0:return[4,Promise.all(a.map(function(u){return tt.faceExpressionNet.predictExpressions(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return n=o.sent(),[2,e.map(function(a,s){return Jc(a,n[s])})]}})})},t.prototype.withAgeAndGender=function(){return new ao(this,this.input)},t}(w0);var oo=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n;return $(this,function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:return e=r.sent(),e?[4,ii(e,this.input,function(o){return tt.faceExpressionNet.predictExpressions(o)},this.extractedFaces)]:[2];case 2:return n=r.sent(),[2,Jc(e,n)]}})})},t.prototype.withAgeAndGender=function(){return new so(this,this.input)},t}(w0);var si=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.withAgeAndGender=function(){return new ci(this,this.input)},t.prototype.withFaceDescriptors=function(){return new fi(this,this.input)},t}(io);var ui=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.withAgeAndGender=function(){return new li(this,this.input)},t.prototype.withFaceDescriptor=function(){return new hi(this,this.input)},t}(oo);var C0=function(i){J(t,i);function t(e,n,r){var o=i.call(this)||this;return o.parentTask=e,o.input=n,o.extractedFaces=r,o}return t}(gn);var ao=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r=this;return $(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return e=o.sent(),[4,wr(e,this.input,function(a){return X(r,void 0,void 0,function(){return $(this,function(s){switch(s.label){case 0:return[4,Promise.all(a.map(function(u){return tt.ageGenderNet.predictAgeAndGender(u)}))];case 1:return[2,s.sent()]}})})},this.extractedFaces)];case 2:return n=o.sent(),[2,e.map(function(a,s){var u=n[s],c=u.age,l=u.gender,f=u.genderProbability;return rl(il(a,l,f),c)})]}})})},t.prototype.withFaceExpressions=function(){return new io(this,this.input)},t}(C0);var so=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r,o,a;return $(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return e=s.sent(),e?[4,ii(e,this.input,function(u){return tt.ageGenderNet.predictAgeAndGender(u)},this.extractedFaces)]:[2];case 2:return n=s.sent(),r=n.age,o=n.gender,a=n.genderProbability,[2,rl(il(e,o,a),r)]}})})},t.prototype.withFaceExpressions=function(){return new oo(this,this.input)},t}(C0);var ci=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.withFaceExpressions=function(){return new si(this,this.input)},t.prototype.withFaceDescriptors=function(){return new fi(this,this.input)},t}(ao);var li=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.withFaceExpressions=function(){return new ui(this,this.input)},t.prototype.withFaceDescriptor=function(){return new hi(this,this.input)},t}(so);var _0=function(i){J(t,i);function t(e,n){var r=i.call(this)||this;return r.parentTask=e,r.input=n,r}return t}(gn);var fi=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n;return $(this,function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:return e=r.sent(),[4,wr(e,this.input,function(o){return Promise.all(o.map(function(a){return tt.faceRecognitionNet.computeFaceDescriptor(a)}))},null,function(o){return o.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return n=r.sent(),[2,n.map(function(o,a){return nl(e[a],o)})]}})})},t.prototype.withFaceExpressions=function(){return new si(this,this.input)},t.prototype.withAgeAndGender=function(){return new ci(this,this.input)},t}(_0);var hi=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n;return $(this,function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:return e=r.sent(),e?[4,ii(e,this.input,function(o){return tt.faceRecognitionNet.computeFaceDescriptor(o)},null,function(o){return o.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return n=r.sent(),[2,nl(e,n)]}})})},t.prototype.withFaceExpressions=function(){return new ui(this,this.input)},t.prototype.withAgeAndGender=function(){return new li(this,this.input)},t}(_0);var E0=function(i){J(t,i);function t(e,n,r){var o=i.call(this)||this;return o.parentTask=e,o.input=n,o.useTinyLandmarkNet=r,o}return Object.defineProperty(t.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?tt.faceLandmark68TinyNet:tt.faceLandmark68Net},enumerable:!0,configurable:!0}),t}(gn);var k0=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r,o,a,s=this;return $(this,function(u){switch(u.label){case 0:return[4,this.parentTask];case 1:return e=u.sent(),n=e.map(function(c){return c.detection}),this.input instanceof Me?[4,Yi(this.input,n)]:[3,3];case 2:return o=u.sent(),[3,5];case 3:return[4,$i(this.input,n)];case 4:o=u.sent(),u.label=5;case 5:return r=o,[4,Promise.all(r.map(function(c){return s.landmarkNet.detectLandmarks(c)}))];case 6:return a=u.sent(),r.forEach(function(c){return c instanceof Me&&c.dispose()}),[2,e.map(function(c,l){return ni(c,a[l])})]}})})},t.prototype.withFaceExpressions=function(){return new si(this,this.input)},t.prototype.withAgeAndGender=function(){return new ci(this,this.input)},t.prototype.withFaceDescriptors=function(){return new fi(this,this.input)},t}(E0);var D0=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r,o,a;return $(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return e=s.sent(),e?(n=e.detection,this.input instanceof Me?[4,Yi(this.input,[n])]:[3,3]):[2];case 2:return o=s.sent(),[3,5];case 3:return[4,$i(this.input,[n])];case 4:o=s.sent(),s.label=5;case 5:return r=o,[4,this.landmarkNet.detectLandmarks(r[0])];case 6:return a=s.sent(),r.forEach(function(u){return u instanceof Me&&u.dispose()}),[2,ni(e,a)]}})})},t.prototype.withFaceExpressions=function(){return new ui(this,this.input)},t.prototype.withAgeAndGender=function(){return new li(this,this.input)},t.prototype.withFaceDescriptor=function(){return new hi(this,this.input)},t}(E0);var S0=function(i){J(t,i);function t(e,n){n===void 0&&(n=new Pn);var r=i.call(this)||this;return r.input=e,r.options=n,r}return t}(gn);var ul=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n,r,o;return $(this,function(a){switch(a.label){case 0:return e=this,n=e.input,r=e.options,r instanceof eo?[4,tt.mtcnn.forward(n,r)]:[3,2];case 1:return[2,a.sent().map(function(s){return s.detection})];case 2:if(o=r instanceof to?function(s){return tt.tinyFaceDetector.locateFaces(s,r)}:r instanceof Pn?function(s){return tt.ssdMobilenetv1.locateFaces(s,r)}:r instanceof br?function(s){return tt.tinyYolov2.locateFaces(s,r)}:null,!o)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,o(n)]}})})},t.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(n){return X(e,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return[4,this.run()];case 1:return r=o.sent(),[2,n(r.map(function(a){return Yr({},a)}))]}})})})},t.prototype.withFaceLandmarks=function(e){return e===void 0&&(e=!1),new k0(this.runAndExtendWithFaceDetections(),this.input,e)},t.prototype.withFaceExpressions=function(){return new io(this.runAndExtendWithFaceDetections(),this.input)},t.prototype.withAgeAndGender=function(){return new ao(this.runAndExtendWithFaceDetections(),this.input)},t}(S0);var A0=function(i){J(t,i);function t(){return i!==null&&i.apply(this,arguments)||this}return t.prototype.run=function(){return X(this,void 0,void 0,function(){var e,n;return $(this,function(r){switch(r.label){case 0:return[4,new ul(this.input,this.options)];case 1:return e=r.sent(),n=e[0],e.forEach(function(o){o.score>n.score&&(n=o)}),[2,n]}})})},t.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(n){return X(e,void 0,void 0,function(){var r;return $(this,function(o){switch(o.label){case 0:return[4,this.run()];case 1:return r=o.sent(),[2,n(r?Yr({},r):void 0)]}})})})},t.prototype.withFaceLandmarks=function(e){return e===void 0&&(e=!1),new D0(this.runAndExtendWithFaceDetection(),this.input,e)},t.prototype.withFaceExpressions=function(){return new oo(this.runAndExtendWithFaceDetection(),this.input)},t.prototype.withAgeAndGender=function(){return new so(this.runAndExtendWithFaceDetection(),this.input)},t}(S0);function F0(i,t){return t===void 0&&(t=new Pn),new A0(i,t)}function cl(i,t){return t===void 0&&(t=new Pn),new ul(i,t)}function R0(i,t){if(i.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var e=Array.from(i),n=Array.from(t);return Math.sqrt(e.map(function(r,o){return r-n[o]}).reduce(function(r,o){return r+Math.pow(o,2)},0))}var oO=function(){function i(t,e){e===void 0&&(e=.6),this._distanceThreshold=e;var n=Array.isArray(t)?t:[t];if(!n.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var r=1,o=function(){return"person "+r++};this._labeledDescriptors=n.map(function(a){if(a instanceof Hi)return a;if(a instanceof Float32Array)return new Hi(o(),[a]);if(a.descriptor&&a.descriptor instanceof Float32Array)return new Hi(o(),[a.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}return Object.defineProperty(i.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),i.prototype.computeMeanDistance=function(t,e){return e.map(function(n){return R0(n,t)}).reduce(function(n,r){return n+r},0)/(e.length||1)},i.prototype.matchDescriptor=function(t){var e=this;return this.labeledDescriptors.map(function(n){var r=n.descriptors,o=n.label;return new Wc(o,e.computeMeanDistance(t,r))}).reduce(function(n,r){return n.distance<r.distance?n:r})},i.prototype.findBestMatch=function(t){var e=this.matchDescriptor(t);return e.distance<this.distanceThreshold?e:new Wc("unknown",e.distance)},i.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(t){return t.toJSON()})}},i.fromJSON=function(t){var e=t.labeledDescriptors.map(function(n){return Hi.fromJSON(n)});return new i(e,t.distanceThreshold)},i}();var I0=(()=>{class i{constructor(){this.modelsLoaded=!1}loadModels(){return K(this,null,function*(){if(!this.modelsLoaded)try{yield Promise.all([tt.tinyFaceDetector.loadFromUri("/assets/models"),tt.faceExpressionNet.loadFromUri("/assets/models")]),this.modelsLoaded=!0,console.log("Face detection models loaded successfully")}catch(e){throw console.error("Error loading face detection models:",e),e}})}detectFaces(e){return K(this,null,function*(){this.modelsLoaded||(yield this.loadModels());try{return yield cl(e,new to).withFaceLandmarks().withFaceExpressions()}catch(n){throw console.error("Error detecting faces:",n),n}})}detectSingleFace(e){return K(this,null,function*(){this.modelsLoaded||(yield this.loadModels());try{return yield F0(e,new to).withFaceExpressions()}catch(n){throw console.error("Error detecting face:",n),n}})}static{this.\u0275fac=function(n){return new(n||i)}}static{this.\u0275prov=uo({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ba=i=>({"border-red-500 dark:border-red-400":i});function X_(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn("",we(2,2,"EVENTS.CREATE.FORM.TITLE")," ",we(3,4,"COMMON.REQUIRED"),""))}function $_(i,t){if(i&1&&(ge(0,"div",38),Kt(1,X_,4,6,"div",39),pe()),i&2){let e,n=Sr();ue(),nt("ngIf",(e=n.eventForm.get("title"))==null||e.errors==null?null:e.errors.required)}}function Y_(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn("",we(2,2,"EVENTS.CREATE.FORM.DESCRIPTION")," ",we(3,4,"COMMON.REQUIRED"),""))}function J_(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn(" ",we(2,2,"EVENTS.CREATE.FORM.DESCRIPTION")," ",we(3,4,"COMMON.MIN_LENGTH")," "))}function Q_(i,t){if(i&1&&(ge(0,"div",38),Kt(1,Y_,4,6,"div",39)(2,J_,4,6,"div",39),pe()),i&2){let e,n,r=Sr();ue(),nt("ngIf",(e=r.eventForm.get("description"))==null||e.errors==null?null:e.errors.required),ue(),nt("ngIf",(n=r.eventForm.get("description"))==null||n.errors==null?null:n.errors.minlength)}}function Z_(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn("",we(2,2,"EVENTS.CREATE.FORM.CONTENT")," ",we(3,4,"COMMON.REQUIRED"),""))}function eE(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn(" ",we(2,2,"EVENTS.CREATE.FORM.CONTENT")," ",we(3,4,"COMMON.MIN_LENGTH")," "))}function tE(i,t){if(i&1&&(ge(0,"div",38),Kt(1,Z_,4,6,"div",39)(2,eE,4,6,"div",39),pe()),i&2){let e,n,r=Sr();ue(),nt("ngIf",(e=r.eventForm.get("content"))==null||e.errors==null?null:e.errors.required),ue(),nt("ngIf",(n=r.eventForm.get("content"))==null||n.errors==null?null:n.errors.minlength)}}function nE(i,t){i&1&&(ge(0,"div"),Ie(1),be(2,"translate"),be(3,"translate"),pe()),i&2&&(ue(),zn("",we(2,2,"EVENTS.CREATE.FORM.EMOTION")," ",we(3,4,"COMMON.REQUIRED"),""))}function rE(i,t){if(i&1&&(ge(0,"div",38),Kt(1,nE,4,6,"div",39),pe()),i&2){let e,n=Sr();ue(),nt("ngIf",(e=n.eventForm.get("emotion"))==null||e.errors==null?null:e.errors.required)}}function iE(i,t){if(i&1&&(ge(0,"div",6)(1,"div",40)(2,"div",41)(3,"div",42)(4,"span",43),Ie(5),pe()(),ge(6,"div",44)(7,"h3",45),Ie(8),be(9,"translate"),pe(),ge(10,"div",46)(11,"p"),Ie(12),be(13,"translate"),pe()()()()()()),i&2){let e=Sr();ue(5),un(e.emotionIcon),ue(3),zn(" ",we(9,4,"EVENTS.CREATE.FORM.DETECTED_MOOD"),": ",e.emotionDisplayName," "),ue(4),Ot(" ",we(13,6,"EVENTS.CREATE.FORM.DETECTED_MOOD_DESC")," ")}}function oE(i,t){i&1&&(ge(0,"span",47),Ha(),ge(1,"svg",48),Dr(2,"circle",49)(3,"path",50),pe()())}var iB=(()=>{class i{constructor(e,n,r,o,a,s,u){this.formBuilder=e,this.eventService=n,this.emotionService=r,this.router=o,this.nlpService=a,this.translate=s,this.faceDetectionService=u,this.isSubmitting=!1,this.detectedEmotion="",this.emotionDisplayName="",this.emotionIcon="",this.isProcessing$=this.nlpService.isProcessing(),this.eventForm=this.formBuilder.group({title:["",Qn.required],description:["",[Qn.required,Qn.minLength(10)]],content:["",[Qn.required,Qn.minLength(10)]],emotion:["",Qn.required],theme:[""]}),this.eventForm.get("content")?.valueChanges.subscribe(c=>K(this,null,function*(){c&&c.length>20?(console.log(this.eventForm.value.content),yield this.nlpService.processText(c)):this.detectedEmotion=""})),this.eventForm.get("emotion")?.valueChanges.subscribe(c=>{c&&(this.detectedEmotion=c,this.emotionDisplayName=this.emotionService.getEmotionDisplayName(c),this.emotionIcon=this.emotionService.getEmotionIcon(c))})}ngOnInit(){this.nlpService.getResponse().subscribe(e=>{e&&(this.detectedEmotion=this.emotionService.detectEmotion(e),this.emotionDisplayName=this.emotionService.getEmotionDisplayName(this.detectedEmotion),this.emotionIcon=this.emotionService.getEmotionIcon(this.detectedEmotion))})}onSubmit(){this.eventForm.invalid||(this.isSubmitting=!0,this.eventForm.patchValue({theme:"theme-"+this.eventForm.value.emotion}),this.eventService.createEvent(this.eventForm.value).subscribe({next:e=>{this.router.navigate(["/events",e.id])},error:e=>{console.error("Error creating event:",e),this.isSubmitting=!1}}))}getDominantEmotion(e){return e?Object.entries(e).reduce((o,a)=>o[1]>a[1]?o:a)[0]:"neutral"}convertFaceApiEmotion(e){switch(e){case"angry":return"anger";case"disgusted":return"disgust";case"fearful":return"fear";case"happy":return"joy";case"neutral":return"neutral";case"sad":return"sadness";case"surprised":return"fear";default:return"neutral"}}onFileSelected(e){return K(this,null,function*(){let n=e.target;if(n.files&&n.files[0]){let r=n.files[0],o=new Image;yield new Promise((p,d)=>{o.onload=p,o.onerror=d,o.src=URL.createObjectURL(r)});let a=document.createElement("canvas"),s=a.getContext("2d");a.width=256,a.height=256;let u=256,c=256,l=0,f=0,h=o.width/o.height;h>1?(c=256/h,f=(256-c)/2):(u=256*h,l=(256-u)/2),s?.drawImage(o,l,f,u,c);try{let p=yield this.faceDetectionService.detectSingleFace(a);console.log("Face detection result:",p?.expressions);let d=this.getDominantEmotion(p?.expressions);console.log("Dominant emotion:",d);let m=this.convertFaceApiEmotion(d);this.eventForm.patchValue({emotion:m}),URL.revokeObjectURL(o.src)}catch(p){console.error("Error detecting face:",p)}}})}static{this.\u0275fac=function(n){return new(n||i)(Wn(Sl),Wn(Pl),Wn(Nl),Wn(ml),Wn(Xh),Wn(Rl),Wn(I0))}}static{this.\u0275cmp=fl({type:i,selectors:[["app-event-create"]],decls:86,vars:86,consts:[[1,"mx-auto","max-w-4xl"],[1,"mb-8","flex","items-center","justify-between"],[1,"text-3xl","font-bold","text-gray-900","dark:text-white"],["routerLink","/events",1,"rounded-md","bg-gray-100","px-3","py-2","text-sm","font-medium","text-gray-700","hover:bg-gray-200","dark:bg-gray-700","dark:text-gray-200","dark:hover:bg-gray-600"],[1,"rounded-lg","bg-white","p-6","shadow-elevation-1","dark:bg-gray-800"],[3,"ngSubmit","formGroup"],[1,"mb-6"],["for","title",1,"label"],["type","text","id","title","formControlName","title",1,"input",3,"placeholder","ngClass"],["class","mt-1 text-sm text-red-600 dark:text-red-400",4,"ngIf"],["for","description",1,"label"],["id","description","formControlName","description","rows","3",1,"textarea",3,"placeholder","ngClass"],["for","content",1,"label"],["id","content","formControlName","content","rows","6",1,"textarea",3,"placeholder","ngClass"],["for","emotion",1,"label"],["id","emotion","formControlName","emotion",1,"input",3,"ngClass"],["value",""],["value","joy"],["value","content"],["value","sadness"],["value","anger"],["value","fear"],[1,"label"],[1,"flex","items-center","justify-center","w-full"],["for","dropzone-file",1,"flex","flex-col","items-center","justify-center","w-full","h-32","border-2","border-gray-300","border-dashed","rounded-lg","cursor-pointer","bg-gray-50","hover:bg-gray-100","dark:border-gray-600","dark:bg-gray-700","dark:hover:bg-gray-600"],[1,"flex","flex-col","items-center","justify-center","pt-5","pb-6"],["aria-hidden","true","fill","none","stroke","currentColor","viewBox","0 0 24 24","xmlns","http://www.w3.org/2000/svg",1,"w-10","h-10","mb-3","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"],[1,"mb-2","text-sm","text-gray-500","dark:text-gray-400"],[1,"font-semibold"],[1,"text-xs","text-gray-500","dark:text-gray-400"],["id","dropzone-file","type","file","accept","image/*",1,"hidden",3,"change"],[1,"mt-2","text-sm","text-gray-500","dark:text-gray-400"],["class","mb-6",4,"ngIf"],[1,"flex","justify-end"],["type","button","routerLink","/events",1,"mr-3","rounded-md","bg-white","px-4","py-2","text-sm","font-medium","text-gray-700","shadow-sm","hover:bg-gray-50","focus:outline-none","focus:ring-2","focus:ring-primary-500","focus:ring-offset-2","dark:bg-gray-700","dark:text-gray-200","dark:hover:bg-gray-600"],["type","submit",1,"inline-flex","items-center","rounded-md","border","border-transparent","bg-primary-600","px-4","py-2","text-sm","font-medium","text-white","shadow-sm","hover:bg-primary-700","focus:outline-none","focus:ring-2","focus:ring-primary-500","focus:ring-offset-2","disabled:opacity-70","dark:bg-primary-700","dark:hover:bg-primary-600",3,"disabled"],["class","mr-2",4,"ngIf"],[1,"mt-1","text-sm","text-red-600","dark:text-red-400"],[4,"ngIf"],[1,"rounded-md","bg-gray-50","p-4","dark:bg-gray-700"],[1,"flex"],[1,"flex-shrink-0"],[1,"text-2xl"],[1,"ml-3"],[1,"text-sm","font-medium","text-gray-800","dark:text-gray-200"],[1,"mt-2","text-sm","text-gray-600","dark:text-gray-300"],[1,"mr-2"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24","fill","none",1,"h-4","w-4","animate-spin","text-white"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"]],template:function(n,r){if(n&1&&(ge(0,"div",0)(1,"div",1)(2,"h1",2),Ie(3),be(4,"translate"),pe(),ge(5,"a",3),Ie(6),be(7,"translate"),pe()(),ge(8,"div",4)(9,"form",5),Ka("ngSubmit",function(){return r.onSubmit()}),ge(10,"div",6)(11,"label",7),Ie(12),be(13,"translate"),pe(),Dr(14,"input",8),be(15,"translate"),Kt(16,$_,2,1,"div",9),pe(),ge(17,"div",6)(18,"label",10),Ie(19),be(20,"translate"),pe(),Dr(21,"textarea",11),be(22,"translate"),Kt(23,Q_,3,2,"div",9),pe(),ge(24,"div",6)(25,"label",12),Ie(26),be(27,"translate"),pe(),Dr(28,"textarea",13),be(29,"translate"),Kt(30,tE,3,2,"div",9),pe(),ge(31,"div",6)(32,"label",14),Ie(33),be(34,"translate"),pe(),ge(35,"select",15)(36,"option",16),Ie(37),be(38,"translate"),pe(),ge(39,"option",17),Ie(40),be(41,"translate"),pe(),ge(42,"option",18),Ie(43),be(44,"translate"),pe(),ge(45,"option",19),Ie(46),be(47,"translate"),pe(),ge(48,"option",20),Ie(49),be(50,"translate"),pe(),ge(51,"option",21),Ie(52),be(53,"translate"),pe()(),Kt(54,rE,2,1,"div",9),pe(),ge(55,"div",6)(56,"label",22),Ie(57),be(58,"translate"),pe(),ge(59,"div",23)(60,"label",24)(61,"div",25),Ha(),ge(62,"svg",26),Dr(63,"path",27),pe(),ll(),ge(64,"p",28)(65,"span",29),Ie(66),be(67,"translate"),pe(),Ie(68),be(69,"translate"),pe(),ge(70,"p",30),Ie(71),be(72,"translate"),pe()(),ge(73,"input",31),Ka("change",function(a){return r.onFileSelected(a)}),pe()()(),ge(74,"p",32),Ie(75),be(76,"translate"),pe()(),Kt(77,iE,14,8,"div",33),ge(78,"div",34)(79,"button",35),Ie(80),be(81,"translate"),pe(),ge(82,"button",36),Kt(83,oE,4,0,"span",37),Ie(84),be(85,"translate"),pe()()()()()),n&2){let o,a,s,u,c,l,f,h;ue(3),un(we(4,34,"EVENTS.CREATE.TITLE")),ue(3),Ot(" ",we(7,36,"EVENTS.LIST.TITLE")," "),ue(3),nt("formGroup",r.eventForm),ue(3),un(we(13,38,"EVENTS.CREATE.FORM.TITLE")),ue(2),nt("placeholder",we(15,40,"EVENTS.CREATE.FORM.TITLE_PLACEHOLDER"))("ngClass",pi(78,Ba,((o=r.eventForm.get("title"))==null?null:o.invalid)&&(((o=r.eventForm.get("title"))==null?null:o.dirty)||((o=r.eventForm.get("title"))==null?null:o.touched)))),ue(2),nt("ngIf",((a=r.eventForm.get("title"))==null?null:a.invalid)&&(((a=r.eventForm.get("title"))==null?null:a.dirty)||((a=r.eventForm.get("title"))==null?null:a.touched))),ue(3),un(we(20,42,"EVENTS.CREATE.FORM.DESCRIPTION")),ue(2),nt("placeholder",we(22,44,"EVENTS.CREATE.FORM.DESCRIPTION_PLACEHOLDER"))("ngClass",pi(80,Ba,((s=r.eventForm.get("description"))==null?null:s.invalid)&&(((s=r.eventForm.get("description"))==null?null:s.dirty)||((s=r.eventForm.get("description"))==null?null:s.touched)))),ue(2),nt("ngIf",((u=r.eventForm.get("description"))==null?null:u.invalid)&&(((u=r.eventForm.get("description"))==null?null:u.dirty)||((u=r.eventForm.get("description"))==null?null:u.touched))),ue(3),un(we(27,46,"EVENTS.CREATE.FORM.CONTENT")),ue(2),nt("placeholder",we(29,48,"EVENTS.CREATE.FORM.CONTENT_PLACEHOLDER"))("ngClass",pi(82,Ba,((c=r.eventForm.get("content"))==null?null:c.invalid)&&(((c=r.eventForm.get("content"))==null?null:c.dirty)||((c=r.eventForm.get("content"))==null?null:c.touched)))),ue(2),nt("ngIf",((l=r.eventForm.get("content"))==null?null:l.invalid)&&(((l=r.eventForm.get("content"))==null?null:l.dirty)||((l=r.eventForm.get("content"))==null?null:l.touched))),ue(3),un(we(34,50,"EVENTS.CREATE.FORM.EMOTION")),ue(2),nt("ngClass",pi(84,Ba,((f=r.eventForm.get("emotion"))==null?null:f.invalid)&&(((f=r.eventForm.get("emotion"))==null?null:f.dirty)||((f=r.eventForm.get("emotion"))==null?null:f.touched)))),ue(2),un(we(38,52,"EVENTS.CREATE.FORM.EMOTION_PLACEHOLDER")),ue(3),Ot("\u{1F60A} ",we(41,54,"EVENTS.EMOTIONS.JOY"),""),ue(3),Ot("\u{1F60C} ",we(44,56,"EVENTS.EMOTIONS.CONTENT"),""),ue(3),Ot("\u{1F622} ",we(47,58,"EVENTS.EMOTIONS.SADNESS"),""),ue(3),Ot("\u{1F621} ",we(50,60,"EVENTS.EMOTIONS.ANGER"),""),ue(3),Ot("\u{1F628} ",we(53,62,"EVENTS.EMOTIONS.FEAR"),""),ue(2),nt("ngIf",((h=r.eventForm.get("emotion"))==null?null:h.invalid)&&(((h=r.eventForm.get("emotion"))==null?null:h.dirty)||((h=r.eventForm.get("emotion"))==null?null:h.touched))),ue(3),un(we(58,64,"EVENTS.CREATE.FORM.MEDIA")),ue(9),un(we(67,66,"EVENTS.CREATE.FORM.UPLOAD_CLICK")),ue(2),Ot(" ",we(69,68,"EVENTS.CREATE.FORM.UPLOAD_DRAG")," "),ue(3),Ot(" ",we(72,70,"EVENTS.CREATE.FORM.UPLOAD_FORMATS")," "),ue(4),Ot(" ",we(76,72,"EVENTS.CREATE.FORM.UPLOAD_FUTURE")," "),ue(2),nt("ngIf",r.detectedEmotion),ue(3),Ot(" ",we(81,74,"EVENTS.CREATE.FORM.CANCEL")," "),ue(2),nt("disabled",r.eventForm.invalid||r.isSubmitting),ue(),nt("ngIf",r.isSubmitting),ue(),Ot(" ",we(85,76,"EVENTS.CREATE.FORM.SUBMIT")," ")}},dependencies:[dl,hl,pl,gl,vl,Al,wl,kl,Dl,yl,El,xl,bl,Fl,Cl,_l,Tl,Il],encapsulation:2})}}return i})();export{iB as EventCreateComponent};
